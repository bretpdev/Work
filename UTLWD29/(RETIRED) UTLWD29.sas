*-------------------------------------------------*
| UTLWD29 - MORE THAN ONE ACTIVE EMPLOYER ON LC20 |
*-------------------------------------------------*;
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWD29.LWD29R2";
FILENAME REPORTZ "&RPTLIB/ULWD29.LWD29RZ";
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE BREMP AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT B.BF_SSN
	,B.BF_EMP_ID_1 	
	,B.BN_WGE_YR_1 
	,B.BN_WGE_QTR_1 
	,B.BF_EMP_ID_2 
	,B.BN_WGE_YR_2 
	,B.BN_WGE_QTR_2
	,B.BF_EMP_ID_3 
	,B.BN_WGE_YR_3 
	,B.BN_WGE_QTR_3 
	,B.BF_EMP_ID_4 
	,B.BN_WGE_YR_4 
	,B.BN_WGE_QTR_4
	,B.BF_EMP_ID_5 
	,B.BN_WGE_YR_5 
	,B.BN_WGE_QTR_5 
	,B.BF_EMP_ID_6 
	,B.BN_WGE_YR_6 
	,B.BN_WGE_QTR_6
	,B.BF_EMP_ID_7 
	,B.BN_WGE_YR_7 
	,B.BN_WGE_QTR_7 
	,B.BF_EMP_ID_8 
	,B.BN_WGE_YR_8 
	,B.BN_WGE_QTR_8
	,B.BF_EMP_ID_9 
	,B.BN_WGE_YR_9 
	,B.BN_WGE_QTR_9 
	,B.BF_EMP_ID_10 
	,B.BN_WGE_YR_10 
	,B.BN_WGE_QTR_10
	,B.BF_EMP_ID_11 
	,B.BN_WGE_YR_11 
	,B.BN_WGE_QTR_11 
	,B.BF_EMP_ID_12 
	,B.BN_WGE_YR_12 
	,B.BN_WGE_QTR_12
FROM OLWHRM1.DC01_LON_CLM_INF A
INNER JOIN OLWHRM1.BR02_BR_EMP B
	ON A.BF_SSN = B.BF_SSN
INNER JOIN OLWHRM1.BR01_BR_CRF C
	ON B.BF_SSN = C.BF_SSN
WHERE A.LC_STA_DC10 = '03'
AND A.LC_AUX_STA = ''
AND A.LC_REA_CLM_ASN_DOE = ''
AND B.BI_EMP_INF_OVR = 'Y'
AND C.BC_HLD_REA IN ('13','15','16')
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWD29.LWD29RZ);*/
/*QUIT;*/
ENDRSUBMIT;

DATA BREMP;
SET WORKLOCL.BREMP;
RUN;

DATA EPROC;
RUN;

%MACRO NRMLZE;
%DO I=1 %TO 12;
	DATA EMP&I (KEEP=BF_SSN BF_EMP_ID BN_WGE_YR BN_WGE_QTR);
		SET BREMP;
		BF_EMP_ID = BF_EMP_ID_&I ;
		BN_WGE_YR = BN_WGE_YR_&I ;
		BN_WGE_QTR = BN_WGE_QTR_&I;
	RUN;
	DATA EPROC (WHERE=(	
		BF_SSN ^= '' AND BN_WGE_YR ^= '' AND BN_WGE_QTR ^= '' AND 
		BN_WGE_YR ^= '2000' AND BN_WGE_QTR ^= '01')
		);
	SET EPROC EMP&I;
	RUN;
	PROC DATASETS;
		DELETE EMP&I;
	QUIT;
%END;
%MEND NRMLZE;
%NRMLZE;

PROC SQL;
CREATE TABLE BREMP AS 
SELECT DISTINCT A.BF_SSN
	,'DACTEMPL' AS QUEUE
	,'' AS INDTID
	,'' AS INDTTYP
	,'' AS DUEDATE
	,'' AS DUETIME
	,'' AS TEXT
FROM EPROC A
INNER JOIN EPROC B
	ON A.BF_SSN = B.BF_SSN
WHERE A.BN_WGE_YR ^= B.BN_WGE_YR
AND A.BN_WGE_QTR ^= B.BN_WGE_QTR
;
QUIT;

DATA _NULL_;
SET  WORK.BREMP;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
   FORMAT BF_SSN $9. ;
   FORMAT QUEUE $8. ;
   FORMAT INDTID $1. ;
   FORMAT INDTTYP $1.;
   FORMAT DUEDATE $1. ;
   FORMAT DUETIME $1. ;
   FORMAT TEXT $1. ;
 DO;
   PUT BF_SSN $ @;
   PUT QUEUE $ @;
   PUT INDTID $ @;
   PUT INDTTYP $ @;
   PUT DUEDATE $ @;
   PUT DUETIME $ @;
   PUT TEXT $ ;
 END;
RUN;
