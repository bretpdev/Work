USE [Income_Driven_Repayment]
GO


DECLARE @APP_ID INT = 356 --CHANGE THIS TO THE APP ID YOU NEED TO GET THE OLDEST AWARD ID FOR
DECLARE @AWARD_YEAR INT 
DECLARE @SEQ INT 
DECLARE @AWARD_TYPE CHAR = NULL
DECLARE @CURRENT_AWARD_ID CHAR(21) = NULL
DECLARE @OLDEST_AWARD_ID CHAR(21) = NULL
DECLARE @OLDEST_AWARD_YEAR INT 
DECLARE @OLDEST_SEQ INT 
DECLARE @OLDEST_AWARD_TYPE CHAR = NULL

DECLARE CUR_LOANS CURSOR FOR
	SELECT 
		award_id
	FROM 
		Loans
	WHERE 
		application_id = @APP_ID
				
OPEN CUR_LOANS
FETCH NEXT FROM CUR_LOANS INTO @CURRENT_AWARD_ID
WHILE @@FETCH_STATUS = 0
BEGIN

	SET @AWARD_YEAR = SUBSTRING(@CURRENT_AWARD_ID,11,2)
	SET @SEQ  = SUBSTRING(@CURRENT_AWARD_ID,19,3)
	SET @AWARD_TYPE = SUBSTRING(@CURRENT_AWARD_ID, 10,1)

	IF (@OLDEST_AWARD_ID IS NULL)
	BEGIN
		SET @OLDEST_AWARD_ID = @CURRENT_AWARD_ID
		SET @OLDEST_AWARD_YEAR = @AWARD_YEAR
		SET @OLDEST_AWARD_TYPE = @AWARD_TYPE
		SET @OLDEST_SEQ = @SEQ
	END
	ELSE IF (@AWARD_YEAR < 40)
	BEGIN
		IF (@OLDEST_AWARD_YEAR < 40)
			IF(@OLDEST_AWARD_YEAR > @AWARD_YEAR)
			BEGIN
				SET @OLDEST_AWARD_ID = @CURRENT_AWARD_ID
				SET @OLDEST_AWARD_YEAR = @AWARD_YEAR
				SET @OLDEST_AWARD_TYPE = @AWARD_TYPE
				SET @OLDEST_SEQ = @SEQ
			END
			ELSE IF (@OLDEST_AWARD_YEAR = @AWARD_YEAR)
			BEGIN
				IF(@OLDEST_SEQ > @SEQ)
				BEGIN
					SET @OLDEST_AWARD_ID = @CURRENT_AWARD_ID
					SET @OLDEST_AWARD_YEAR = @AWARD_YEAR
					SET @OLDEST_AWARD_TYPE = @AWARD_TYPE
					SET @OLDEST_SEQ = @SEQ
				END
				ELSE IF (@OLDEST_AWARD_TYPE != 'S' AND @AWARD_TYPE = 'S')
					SET @OLDEST_AWARD_ID = @CURRENT_AWARD_ID
					SET @OLDEST_AWARD_YEAR = @AWARD_YEAR
					SET @OLDEST_AWARD_TYPE = @AWARD_TYPE
					SET @OLDEST_SEQ = @SEQ
			END
	END
	ELSE
	BEGIN
		IF(@OLDEST_AWARD_YEAR > @AWARD_YEAR)
		BEGIN
			SET @OLDEST_AWARD_ID = @CURRENT_AWARD_ID
			SET @OLDEST_AWARD_YEAR = @AWARD_YEAR
			SET @OLDEST_AWARD_TYPE = @AWARD_TYPE
			SET @OLDEST_SEQ = @SEQ
		END
		ELSE IF (@OLDEST_AWARD_YEAR = @AWARD_YEAR)
		BEGIN
			IF(@OLDEST_SEQ > @SEQ)
			BEGIN
					SET @OLDEST_AWARD_ID = @CURRENT_AWARD_ID
					SET @OLDEST_AWARD_YEAR = @AWARD_YEAR
					SET @OLDEST_AWARD_TYPE = @AWARD_TYPE
					SET @OLDEST_SEQ = @SEQ
			END
			ELSE IF (@OLDEST_AWARD_TYPE != 'S' AND @AWARD_TYPE = 'S')
					SET @OLDEST_AWARD_ID = @CURRENT_AWARD_ID
					SET @OLDEST_AWARD_YEAR = @AWARD_YEAR
					SET @OLDEST_AWARD_TYPE = @AWARD_TYPE
					SET @OLDEST_SEQ = @SEQ
		END
	END 
	
FETCH NEXT FROM CUR_LOANS INTO @CURRENT_AWARD_ID	
		
END
CLOSE CUR_LOANS
DEALLOCATE CUR_LOANS

BEGIN
	PRINT  (@OLDEST_AWARD_ID)
END	
		
		
