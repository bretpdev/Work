USE [Income_Driven_Repayment]
GO

DECLARE @APP_ID INT

DECLARE CUR_APP_ID CURSOR FOR
	SELECT 
		application_id
	FROM 
		Applications
	WHERE 
		created_at BETWEEN '08/16/2013' AND '09/06/2013'
				
OPEN CUR_APP_ID

FETCH NEXT FROM CUR_APP_ID INTO @APP_ID
WHILE @@FETCH_STATUS = 0
BEGIN

DECLARE @AWARD_YEAR INT 
DECLARE @SEQ INT 
DECLARE @AWARD_TYPE CHAR = NULL
DECLARE @CURRENT_AWARD_ID CHAR(21) = NULL
DECLARE @OLDEST_AWARD_ID CHAR(21) = NULL
DECLARE @OLDEST_AWARD_YEAR INT 
DECLARE @OLDEST_SEQ INT 
DECLARE @OLDEST_AWARD_TYPE CHAR = NULL

DECLARE CUR_LOANS CURSOR FOR
	SELECT 
		award_id 
	FROM 
		Loans
	WHERE 
		application_id = @APP_ID
				
OPEN CUR_LOANS
FETCH NEXT FROM CUR_LOANS INTO @CURRENT_AWARD_ID
WHILE @@FETCH_STATUS = 0
BEGIN

	BEGIN TRY
		SET @AWARD_YEAR = SUBSTRING(@CURRENT_AWARD_ID,11,2)
		SET @SEQ  = SUBSTRING(@CURRENT_AWARD_ID,19,3)
		SET @AWARD_TYPE = SUBSTRING(@CURRENT_AWARD_ID, 10,1)
	END TRY
	BEGIN CATCH
		PRINT 'THERE WAS AN ERROR PARSING THE AWARD ID FOR APPLICATION ID: ' + CAST(@APP_ID AS VARCHAR(1000))
		SET @OLDEST_AWARD_ID = NULL
	END CATCH

	IF (@OLDEST_AWARD_ID IS NULL)
	BEGIN
		SET @OLDEST_AWARD_ID = @CURRENT_AWARD_ID
		SET @OLDEST_AWARD_YEAR = @AWARD_YEAR
		SET @OLDEST_AWARD_TYPE = @AWARD_TYPE
		SET @OLDEST_SEQ = @SEQ
	END
	ELSE IF (@AWARD_YEAR < 40)
	BEGIN
		IF (@OLDEST_AWARD_YEAR < 40)
			IF(@OLDEST_AWARD_YEAR > @AWARD_YEAR)
			BEGIN
				SET @OLDEST_AWARD_ID = @CURRENT_AWARD_ID
				SET @OLDEST_AWARD_YEAR = @AWARD_YEAR
				SET @OLDEST_AWARD_TYPE = @AWARD_TYPE
				SET @OLDEST_SEQ = @SEQ
			END
			ELSE IF (@OLDEST_AWARD_YEAR = @AWARD_YEAR)
			BEGIN
				IF(@OLDEST_SEQ > @SEQ)
				BEGIN
					SET @OLDEST_AWARD_ID = @CURRENT_AWARD_ID
					SET @OLDEST_AWARD_YEAR = @AWARD_YEAR
					SET @OLDEST_AWARD_TYPE = @AWARD_TYPE
					SET @OLDEST_SEQ = @SEQ
				END
				ELSE IF (@OLDEST_AWARD_TYPE != 'S' AND @AWARD_TYPE = 'S')
					SET @OLDEST_AWARD_ID = @CURRENT_AWARD_ID
					SET @OLDEST_AWARD_YEAR = @AWARD_YEAR
					SET @OLDEST_AWARD_TYPE = @AWARD_TYPE
					SET @OLDEST_SEQ = @SEQ
			END
	END
	ELSE
	BEGIN
		IF(@OLDEST_AWARD_YEAR > @AWARD_YEAR)
		BEGIN
			SET @OLDEST_AWARD_ID = @CURRENT_AWARD_ID
			SET @OLDEST_AWARD_YEAR = @AWARD_YEAR
			SET @OLDEST_AWARD_TYPE = @AWARD_TYPE
			SET @OLDEST_SEQ = @SEQ
		END
		ELSE IF (@OLDEST_AWARD_YEAR = @AWARD_YEAR)
		BEGIN
			IF(@OLDEST_SEQ > @SEQ)
			BEGIN
					SET @OLDEST_AWARD_ID = @CURRENT_AWARD_ID
					SET @OLDEST_AWARD_YEAR = @AWARD_YEAR
					SET @OLDEST_AWARD_TYPE = @AWARD_TYPE
					SET @OLDEST_SEQ = @SEQ
			END
			ELSE IF (@OLDEST_AWARD_TYPE != 'S' AND @AWARD_TYPE = 'S')
					SET @OLDEST_AWARD_ID = @CURRENT_AWARD_ID
					SET @OLDEST_AWARD_YEAR = @AWARD_YEAR
					SET @OLDEST_AWARD_TYPE = @AWARD_TYPE
					SET @OLDEST_SEQ = @SEQ
		END
	END 
	
FETCH NEXT FROM CUR_LOANS INTO @CURRENT_AWARD_ID	
		
END
CLOSE CUR_LOANS
DEALLOCATE CUR_LOANS

BEGIN
	PRINT  ('APP ID: ' + CAST(@APP_ID AS VARCHAR(1000)) + ' AWARD ID: ' + @OLDEST_AWARD_ID)
	
	--UPDATE dbo.Applications
	--SET award_id = @OLDEST_AWARD_ID, updated_by = 'AWARD ID DCR'
	--WHERE application_id = @APP_ID
END	

FETCH NEXT FROM CUR_APP_ID INTO @APP_ID
		
END	
CLOSE CUR_APP_ID
DEALLOCATE CUR_APP_ID	
