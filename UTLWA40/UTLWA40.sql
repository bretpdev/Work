SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
DECLARE @StartDate DATETIME = '01/01/2017'
DECLARE @EndDate DATETIME = '12/31/2018'

--select * from (
--select count(*) over (partition by p.bf_ssn, p.LOAN_SEQ) as c,  * from 
--(

SELECT DISTINCT
	LN10.BF_SSN AS BF_SSN,
	COALESCE(RTRIM(PD10.DM_PRS_LST),'NLN') AS LAST_NAME,
	COALESCE(RTRIM(PD10.DM_PRS_1),'NFN') AS FIRST_NAME,
	COALESCE(RTRIM(PD10.DM_PRS_MID),' ') AS MIDDLE_INITIAL,
	COALESCE(CONVERT(VARCHAR,PD10.DD_BRT,112),'00000000') AS DATE_OF_BIRTH,
	LN10.LN_SEQ AS LOAN_SEQ,
	SUBSTRING(LN10.LF_LON_CUR_OWN,1,6) AS CURRENT_LENDER_CODE,
	COALESCE(CONVERT(VARCHAR,LN35.LD_OWN_EFF_SR,112),'00000000') AS CURRENT_HOLDER_EFFECTIVE_DATE,
	CASE WHEN LN10.IF_DOE_LDR = LN10.LF_LON_CUR_OWN THEN '      '
		 ELSE COALESCE(LN35P.IF_OWN, '000000')
	END AS PREVIOUS_LENDER_CODE,
	COALESCE(CONVERT(VARCHAR,LN35P.LD_OWN_EFF_SR,112),'00000000') AS PREVIOUS_HOLDER_EFFECTIVE_DATE,
	CASE WHEN LN10.IF_DOE_LDR = ' ' THEN '000000'
	     WHEN LN10.IF_DOE_LDR = LN10.LF_LON_CUR_OWN THEN '      '
		 ELSE LN10.IF_DOE_LDR
	END AS ORIGINAL_HOLDER,
	COALESCE(CONVERT(VARCHAR,LN10.LD_LON_1_DSB,112),'00000000') AS ORIGINAL_HOLDER_EFFECTIVE_DATE,
	SUBSTRING(LN10.IF_GTR,4,3) AS CURRENT_GUARANTOR_CODE,
	COALESCE(CONVERT(VARCHAR,LN10.LD_LON_1_DSB,112),'00000000') AS CURRENT_GUARANTOR_EFFECTIVE_DATE,
	'000' AS PREVIOUS_GUARANTOR_CODE,
	'00000000' AS PREVIOUS_GUARANTOR_EFFECTIVE_DATE,
	'000' AS ORIGINAL_GUARANTOR_CODE,
	'00000000' AS ORIGINAL_GUARANTOR_EFFECTIVE_DATE,
	'700126' AS CURRENT_SERVICER_CODE,
	COALESCE(CONVERT(VARCHAR,LN10.LD_LON_EFF_ADD,112),'00000000') AS CURRENT_SERVICER_EFFECTIVE_DATE,
	'000000' AS PREVIOUS_SERVICER_CODE,
	'00000000' AS PREVIOUS_SERVICER_EFFECTIVE_DATE,
	'000000' AS ORIGINAL_SERVICER_CODE,
	'00000000' AS ORIGINAL_SERVICER_CODE_EFFECTIVE_DATE,
	LN10.LI_ESG AS BORROWER_ELECTRONIC_SIGNATURE_INDICATOR_CODE,
	LN10.LF_ESG_SRC AS E_SIGNATURE_SOURCE_TYPE_CODE,
	LN10.LF_LON_ALT AS COMMONLINE_UNIQUE_ID,
	RIGHT('00' + COALESCE(CAST(LN10.LN_LON_ALT_SEQ AS VARCHAR),''),2) AS COMMONLINE_UNIQUE_ID_SEQUENCE,
	'                ' AS UNIQUE_LOAN_ID,
	COALESCE(CONVERT(VARCHAR,LN10.LD_LON_GTR,112),'00000000') AS GUARANTY_DATE,
	COALESCE(CONVERT(VARCHAR,LN10.LD_TRM_BEG,112),'00000000') AS LOAN_PERIOD_BEGIN_DATE,
	COALESCE(CONVERT(VARCHAR,LN10.LD_TRM_END,112),'00000000') AS LOAN_PERIOD_END_DATE,
	COALESCE(CONVERT(VARCHAR,LN10.LD_LON_1_DSB,112),'00000000') AS FIRST_DISBURSEMENT_DATE,
	RIGHT('00000000' + REPLACE(CAST(LN15.LA_DSB AS VARCHAR),'.',''),8) AS FIRST_DISBURSEMENT_AMOUNT,
	CASE WHEN DW01.WC_DW_LON_STA = '22' AND CANC.BF_SSN IS NOT NULL THEN 'CA'
	     WHEN DW01.WC_DW_LON_STA = '04' THEN 'DA'
		 WHEN DW01.WC_DW_LON_STA = '05' THEN 'FB'
		 WHEN DW01.WC_DW_LON_STA IN('02','23') THEN 'IA'
		 WHEN DW01.WC_DW_LON_STA = '01' THEN 'IG'
		 WHEN DW01.WC_DW_LON_STA = '22' AND PIF.BF_SSN IS NOT NULL AND PIF.LD_FAT_EFF <= '12/31/2001' THEN 'PC'
		 WHEN DW01.WC_DW_LON_STA = '22' AND PIF.BF_SSN IS NOT NULL AND PIF.LD_FAT_EFF > '12/31/2001' THEN 'PN'
		 WHEN DW01.WC_DW_LON_STA = '22' AND PIF.BF_SSN IS NULL AND CANC.BF_SSN IS NULL THEN 'PF'
		 WHEN DW01.WC_DW_LON_STA IN ('03','06','07','08','09','10','11','12','13','14','15') THEN 'RP'
		 WHEN DW01.WC_DW_LON_STA IN ('16','17') THEN 'DE'
		 WHEN DW01.WC_DW_LON_STA IN ('18','19') THEN 'DI'
		 WHEN DW01.WC_DW_LON_STA IN ('20','21') THEN 'BK'
		 ELSE '  '
	END AS LOAN_STATUS_CODE,
	COALESCE(CASE WHEN DW01.WC_DW_LON_STA = '01' THEN CONVERT(VARCHAR,SD10.LD_SCL_SPR,112)
	     WHEN DW01.WC_DW_LON_STA IN ('02','23') THEN CONVERT(VARCHAR,LN10.LD_LON_1_DSB,112)
		 WHEN DW01.WC_DW_LON_STA IN ('03','07','08','09','10','11','12','13','14','15') THEN CONVERT(VARCHAR,DW01.WD_LON_RPD_SR,112)
		 WHEN DW01.WC_DW_LON_STA = '06' THEN CONVERT(VARCHAR,LN38.LD_CU_STA_ENT,112)
		 WHEN DW01.WC_DW_LON_STA = '04' AND DFR.BF_SSN IS NOT NULL THEN CONVERT(VARCHAR,DFR.LD_DFR_BEG,112)
		 WHEN DW01.WC_DW_LON_STA = '05' AND FORB.BF_SSN IS NOT NULL THEN CONVERT(VARCHAR,FORB.LD_FOR_BEG,112)
		 WHEN DW01.WC_DW_LON_STA = '22' AND CANC.BF_SSN IS NOT NULL THEN CONVERT(VARCHAR,CANC.LD_FAT_EFF,112)
		 WHEN DW01.WC_DW_LON_STA = '22' AND PIF.BF_SSN IS NOT NULL THEN CONVERT(VARCHAR,PIF.LD_FAT_EFF,112)
		 WHEN DW01.WC_DW_LON_STA = '22' AND CANC.BF_SSN IS NULL AND PIF.BF_SSN IS NULL THEN CONVERT(VARCHAR,LN10.LD_PIF_RPT,112)
		 WHEN DW01.WC_DW_LON_STA = '16' THEN CONVERT(VARCHAR,PD21.DD_DTH_STA,112)
		 WHEN DW01.WC_DW_LON_STA = '17' THEN CONVERT(VARCHAR,PD20.DD_DTH_NTF,112)
		 WHEN DW01.WC_DW_LON_STA = '18' THEN CONVERT(VARCHAR,DIS_ALG.DD_PRS_DSA_SPS_SR,112)
		 WHEN DW01.WC_DW_LON_STA = '19' THEN CONVERT(VARCHAR,DIS_VRF.DD_DSA_RPT,112)
		 WHEN DW01.WC_DW_LON_STA = '20' AND PD24.DC_BKR_STA = '04' THEN CONVERT(VARCHAR,PD24.DD_BKR_FIL,112)
		 WHEN DW01.WC_DW_LON_STA = '21' AND PD24.DC_BKR_STA = '06' THEN CONVERT(VARCHAR,PD24.DD_BKR_VER,112)
		 ELSE '00000000'
	END, '00000000') AS LOAN_STATUS_DATE,
	COALESCE(CONVERT(VARCHAR,CANC.LD_FAT_EFF,112),'00000000') AS CANCELLATION_DATE,
	RIGHT('00000000'+ REPLACE(CAST(CANC.LA_FAT_CUR_PRI * -1 AS VARCHAR),'.',''),8) AS CANCELLATION_AMOUNT,
	COALESCE(CONVERT(VARCHAR,REFM.LD_FAT_EFF,112),'00000000') AS RETURN_TO_LENDER_DATE,
	RIGHT('00000000'+ REPLACE(CAST(REFM.LA_FAT_CUR_PRI * -1 AS VARCHAR),'.',''),8) AS RETURN_TO_LENDER_AMOUNT,
	COALESCE(CONVERT(VARCHAR,GR10.LD_SCL_SPR,112),'00000000') AS OUT_OF_SCHOOL_DATE,
	COALESCE(CONVERT(VARCHAR,DATEADD(DAY,1,LN10.LD_END_GRC_PRD),112),'00000000') AS DATE_ENTERED_REPAYMENT,
	RIGHT('00000' + REPLACE(LEFT(CAST(LN72.LR_ITR * 1000 AS VARCHAR),5),'.',''),5) AS CURRENT_INTEREST_RATE,
	CASE WHEN LN65.LC_TYP_SCH_DIS IN ('IB','IL') THEN 'Y'
		 ELSE 'N'
	END AS IBR_CODE,
	CASE WHEN LN65.LC_TYP_SCH_DIS = 'IB' THEN 'PF'
		 WHEN LN65.LC_TYP_SCH_DIS = 'IL' THEN 'PS'
		 WHEN LN65.LC_TYP_SCH_DIS = 'L' THEN 'SS'
		 WHEN LN65.LC_TYP_SCH_DIS = 'G' THEN 'OP'
		 ELSE LN65.LC_TYP_SCH_DIS
	END AS PFH_IBR_PAYMENT_PLAN_TYPE_CODE, 			
	COALESCE(CASE WHEN LN65.LC_TYP_SCH_DIS IN ('IB','I3') THEN CONVERT(VARCHAR,LN65.LD_CRT_LON65,112)
		 ELSE '00000000'
	END,'00000000') AS PFH_START_DATE,
	RIGHT('00000000'+ REPLACE(CAST(PaidIntFees.AmtPaid * -1 AS VARCHAR),'.',''),8) AS TOTAL_BORROWER_PAYMENTS, 	/*Total Amount of Borrower Payments*/
	RIGHT('00000000'+ REPLACE(CAST(LN10.LA_CUR_PRI AS VARCHAR),'.',''),8) AS CURRENT_PRINCIPAL_BALANCE,
	RIGHT('00000000'+ REPLACE(CAST(PaidIntFees.LateFee AS VARCHAR),'.',''),8) AS LATE_FEES_ASSESSED, 		/*Total Amount of Late Fees Assessed 48*/
	COALESCE(DELQ.LN_DLQ_MAX,0) AS DAYS_DELINQUENT,
	CASE WHEN LN10.IC_LON_PGM IN ('CONSOL','SUBCNS','UNCNS','SUBSPC','UNSPC') THEN 'CL'
	     WHEN LN10.IC_LON_PGM = 'SLS' THEN 'SL'
		 WHEN LN10.IC_LON_PGM = 'PLUSGB' THEN 'GB'
		 WHEN LN10.IC_LON_PGM = 'PLUS' THEN 'PL'
		 WHEN LN10.IC_LON_PGM = 'UNSTFD' THEN 'SU'
		 WHEN LN10.IC_LON_PGM = 'STFFRD' THEN 'SF'
		 ELSE '  '
	END AS LOAN_TYPE,
	COALESCE(CONVERT(VARCHAR,LOAN_SOLD.ClaimPaidDate,112),'00000000') AS CLAIM_PAID_DATE,
	RIGHT('00000000'+ REPLACE(CAST(PaidIntFees.IntCap * -1 AS VARCHAR),'.',''),8) AS CAPITALIZED_INTEREST,
	COALESCE(CONVERT(VARCHAR,LoanPurch.LD_FAT_EFF,112),'00000000') AS LOAN_PURCHASE_DATE,
	COALESCE(CONVERT(VARCHAR,LOAN_SOLD.LoanSaleDate,112),'00000000') AS DATE_LOAN_SOLD,
	'        ' AS LOAN_TRANSFER_DATE,
	COALESCE(CONVERT(VARCHAR,DFR.LD_DFR_BEG,112),'00000000') AS DEFERMENT_BEGIN_DATE,
	COALESCE(CONVERT(VARCHAR,DFR.LD_DFR_END,112),'00000000') AS DEFERMENT_END_DATE,
	COALESCE(CONVERT(VARCHAR,FORB.LD_FOR_BEG,112),'00000000') AS FORBEARANCE_BEGIN_DATE,
	COALESCE(CONVERT(VARCHAR,FORB.LD_FOR_END,112),'00000000') AS FORBEARANCE_END_DATE,
	CASE DFR.LC_DFR_TYP
		WHEN '01' THEN 'NO'
		WHEN '02' THEN 'TD'
		WHEN '03' THEN 'RT'
		WHEN '04' THEN 'AP'
		WHEN '05' THEN 'AC'
		WHEN '06' THEN 'GF'
		WHEN '07' THEN 'PC'
		WHEN '08' THEN 'IR'
		WHEN '09' THEN 'IR'
		WHEN '10' THEN 'TE'
		WHEN '11' THEN 'WM'
		WHEN '12' THEN 'PL'
		WHEN '13' THEN 'UE'
		WHEN '14' THEN 'TS'
		WHEN '15' THEN 'FT'
		WHEN '18' THEN 'HT'
		WHEN '19' THEN 'PP'
		WHEN '20' THEN 'PP'
		WHEN '21' THEN 'PP'
		WHEN '22' THEN 'PP'
		WHEN '29' THEN 'EH' 
		WHEN '38' THEN 'MO'
		WHEN '40' THEN 'MO'
		WHEN '45' THEN 'PD'
		WHEN '46' THEN 'PE'
		ELSE '' 
	END AS DEFERMENT_TYPE,
	CASE WHEN LN10.IC_LON_PGM IN ('UNSPC','SUBSPC') 
		THEN 'Y'
		ELSE 'N'
	END AS SPOUSAL_CONSOLIDATION_LOAN,
	' ' AS FILLER
FROM
	UDW..PD10_PRS_NME PD10
	INNER JOIN UDW..LN10_LON LN10
		ON LN10.BF_SSN = PD10.DF_PRS_ID
	INNER JOIN 
	(
		SELECT
			LN35.*
		FROM
			UDW..LN35_LON_OWN LN35
			INNER JOIN 
			(
				SELECT 
					BF_SSN,
					LN_SEQ,
					MAX(LN_LON_OWN_SEQ) AS LN_LON_OWN_SEQ
				FROM 
					UDW..LN35_LON_OWN LN35
				WHERE
					LN35.LC_STA_LON35 = 'A'
					AND 
					(
						@EndDate BETWEEN LN35.LD_OWN_EFF_SR AND COALESCE(LN35.LD_OWN_EFF_END,'9999-12-31')
						OR
						@StartDate BETWEEN LN35.LD_OWN_EFF_SR AND COALESCE(LN35.LD_OWN_EFF_END,'9999-12-31')
					)
				GROUP BY
					BF_SSN,
					LN_SEQ
			) ML
				ON ML.BF_SSN = LN35.BF_SSN
				AND ML.LN_SEQ = LN35.LN_SEQ
				AND ML.LN_LON_OWN_SEQ = LN35.LN_LON_OWN_SEQ
		) LN35
		ON LN35.BF_SSN = LN10.BF_SSN
		AND LN35.LN_SEQ = LN10.LN_SEQ
		AND LN35.LC_STA_LON35 = 'A'
		AND 
			(
				@EndDate BETWEEN LN35.LD_OWN_EFF_SR AND COALESCE(LN35.LD_OWN_EFF_END,'9999-12-31')
				OR
				@StartDate BETWEEN LN35.LD_OWN_EFF_SR AND COALESCE(LN35.LD_OWN_EFF_END,'9999-12-31')
			)
	LEFT JOIN 
	(
		SELECT
			BF_SSN,
			LN_SEQ,
			MAX(LD_CU_STA_ENT) AS LD_CU_STA_ENT
		FROM
			UDW..LN38_CU_STA_HST LN38
		GROUP BY
			BF_SSN,
			LN_SEQ
	)LN38
		ON LN38.BF_SSN = LN10.BF_SSN
		AND LN38.LN_SEQ = LN10.LN_SEQ
	LEFT JOIN UDW..DW01_DW_CLC_CLU DW01
		ON DW01.BF_SSN = LN10.BF_SSN
		AND DW01.LN_SEQ = LN10.LN_SEQ
	LEFT JOIN
	(
		SELECT
			LN35.BF_SSN,
			LN35.LN_SEQ,
			LN35.IF_OWN,
			LN35.LD_OWN_EFF_SR
		FROM 
			UDW..LN35_LON_OWN LN35
			INNER JOIN
			(
				SELECT
					LN35.BF_SSN,
					LN35.LN_SEQ,
					MAX(LN35.LD_OWN_EFF_END) AS LD_OWN_EFF_END
				FROM 
					UDW..LN35_LON_OWN LN35
				WHERE 
					LN35.LD_OWN_EFF_END IS NOT NULL
				GROUP BY 
					LN35.BF_SSN,
					LN35.LN_SEQ
			) LN35M
				ON LN35.BF_SSN = LN35M.BF_SSN
				AND LN35.LN_SEQ = LN35M.LN_SEQ
				AND LN35.LD_OWN_EFF_END = LN35M.LD_OWN_EFF_END
	) LN35P
		ON LN10.BF_SSN = LN35P.BF_SSN
		AND LN10.LN_SEQ = LN35P.LN_SEQ
	LEFT JOIN 
	(
		SELECT 
			BF_SSN,
			LN_SEQ,
			SUM(ISNULL(LA_DSB,0) - ISNULL(LA_DSB_CAN,0)) AS LA_DSB
		FROM
			UDW..LN15_DSB LN15
		WHERE
			LN15.LN_LON_DSB_SEQ = 1
		GROUP BY
			BF_SSN,
			LN_SEQ
	) LN15
		ON LN15.BF_SSN = LN10.BF_SSN
		AND LN15.LN_SEQ = LN10.LN_SEQ
	LEFT JOIN 
	(
		SELECT
			LN90.BF_SSN,
			LN90.LN_SEQ,
			LN90.LD_FAT_EFF,
			MaxLN90.LA_FAT_CUR_PRI
		FROM 
			UDW..LN90_FIN_ATY LN90
			INNER JOIN
			(
				SELECT
					LN90.BF_SSN,
					LN90.LN_SEQ,
					MAX(LN90.LD_FAT_EFF) AS LD_FAT_EFF,
					SUM(LN90.LA_FAT_CUR_PRI) AS LA_FAT_CUR_PRI
				FROM 
					UDW..LN90_FIN_ATY LN90
				WHERE
					LN90.PC_FAT_TYP = '10'
					AND LN90.PC_FAT_SUB_TYP = '45'
					AND COALESCE(LN90.LC_FAT_REV_REA,'') = ''
					AND LN90.LC_STA_LON90 = 'A'
				GROUP BY 
					LN90.BF_SSN,
					LN90.LN_SEQ
			) MaxLN90
				ON LN90.BF_SSN = MaxLN90.BF_SSN
				AND LN90.LN_SEQ = MaxLN90.LN_SEQ
				AND LN90.LD_FAT_EFF = MaxLN90.LD_FAT_EFF
	) CANC
		ON LN10.BF_SSN = CANC.BF_SSN
		AND LN10.LN_SEQ = CANC.LN_SEQ
	LEFT JOIN 
	(
		SELECT
			LN90.BF_SSN,
			LN90.LN_SEQ,
			LN90.LD_FAT_EFF,
			MaxLN90.LA_FAT_CUR_PRI
		FROM 
			UDW..LN90_FIN_ATY LN90
			INNER JOIN 
			(
				SELECT
					LN90.BF_SSN,
					LN90.LN_SEQ,
					MAX(LN90.LD_FAT_EFF) AS LD_FAT_EFF,
					SUM(LN90.LA_FAT_CUR_PRI) AS LA_FAT_CUR_PRI
				FROM
					UDW..LN90_FIN_ATY LN90
				WHERE 
					LN90.PC_FAT_TYP = '10'
					AND LN90.PC_FAT_SUB_TYP IN ('70','80')
					AND COALESCE(LN90.LC_FAT_REV_REA,'') = ''
					AND LN90.LC_STA_LON90 = 'A'
				GROUP BY
					LN90.BF_SSN,
					LN90.LN_SEQ
			) MaxLN90
				ON LN90.BF_SSN = MaxLN90.BF_SSN
				AND LN90.LN_SEQ = MaxLN90.LN_SEQ
				AND LN90.LD_FAT_EFF = MaxLN90.LD_FAT_EFF
	) PIF
		ON LN10.BF_SSN = PIF.BF_SSN
		AND LN10.LN_SEQ = PIF.LN_SEQ
	LEFT JOIN 
	(
		SELECT
			LN90.BF_SSN,
			LN90.LN_SEQ,
			LN90.LD_FAT_EFF
		FROM 
			UDW..LN90_FIN_ATY LN90
			INNER JOIN 
			(
				SELECT
					LN90.BF_SSN,
					LN90.LN_SEQ,
					MAX(LN90.LD_FAT_EFF) AS LD_FAT_EFF
				FROM
					UDW..LN90_FIN_ATY LN90
				WHERE 
					LN90.PC_FAT_TYP = '02'
					AND LN90.PC_FAT_SUB_TYP = '90'
					AND COALESCE(LN90.LC_FAT_REV_REA,'') = ''
					AND LN90.LC_STA_LON90 = 'A'
				GROUP BY
					LN90.BF_SSN,
					LN90.LN_SEQ
			) MaxLN90
				ON LN90.BF_SSN = MaxLN90.BF_SSN
				AND LN90.LN_SEQ = MaxLN90.LN_SEQ
				AND LN90.LD_FAT_EFF = MaxLN90.LD_FAT_EFF
	) LoanPurch
		ON LN10.BF_SSN = LoanPurch.BF_SSN
		AND LN10.LN_SEQ = LoanPurch.LN_SEQ
	LEFT JOIN
	( 
		SELECT
			SD10.LF_STU_SSN,
			MAX(SD10.LD_SCL_SPR) AS LD_SCL_SPR
		FROM 
			UDW..SD10_STU_SPR SD10
		GROUP BY 
			SD10.LF_STU_SSN
	) SD10
		ON LN10.BF_SSN = SD10.LF_STU_SSN
	LEFT JOIN 
	(
		SELECT
			MaxDFR.*,
			DF10.LC_DFR_TYP
		FROM
		(
			SELECT DISTINCT
				LN50.BF_SSN,
				LN50.LN_SEQ,
				MAX(LN50.LD_DFR_BEG) AS LD_DFR_BEG,
				MAX(LN50.LD_DFR_END) AS LD_DFR_END,
				MAX(LN_DFR_OCC_SEQ) AS LN_DFR_OCC_SEQ,
				MAX(CAST(LN50.LF_DFR_CTL_NUM AS INT)) AS LF_DFR_CTL_NUM
			FROM 
				UDW..LN50_BR_DFR_APV LN50
				INNER JOIN UDW..DF10_BR_DFR_REQ DF10
					ON LN50.BF_SSN = DF10.BF_SSN
					AND LN50.LF_DFR_CTL_NUM = DF10.LF_DFR_CTL_NUM
			WHERE 
				LN50.LC_STA_LON50 = 'A'
				AND DF10.LC_DFR_STA = 'A'
				AND DF10.LC_STA_DFR10 = 'A'
				AND LN50.LC_DFR_RSP != '003'
			GROUP BY 
				LN50.BF_SSN,
				LN50.LN_SEQ
		) MaxDFR
		INNER JOIN UDW..LN50_BR_DFR_APV LN50
			ON LN50.BF_SSN = MaxDFR.BF_SSN
			AND LN50.LN_SEQ = MaxDFR.LN_SEQ
			AND LN50.LD_DFR_BEG = MaxDFR.LD_DFR_BEG
			AND LN50.LD_DFR_END = MaxDFR.LD_DFR_END
			AND LN50.LN_DFR_OCC_SEQ = MAXDFR.LN_DFR_OCC_SEQ
			AND CAST(LN50.LF_DFR_CTL_NUM AS INT) = MaxDFR.LF_DFR_CTL_NUM
		INNER JOIN UDW..DF10_BR_DFR_REQ DF10
			ON DF10.BF_SSN = LN50.BF_SSN
			AND DF10.LF_DFR_CTL_NUM = LN50.LF_DFR_CTL_NUM
	) DFR
		ON LN10.BF_SSN = DFR.BF_SSN
		AND LN10.LN_SEQ = DFR.LN_SEQ
	LEFT JOIN
	(
		SELECT DISTINCT
			LN60.BF_SSN,
			LN60.LN_SEQ,
			MAX(LN60.LD_FOR_BEG) AS LD_FOR_BEG,
			MAX(LN60.LD_FOR_END) AS LD_FOR_END
		FROM 
			UDW..LN60_BR_FOR_APV LN60
			INNER JOIN UDW..FB10_BR_FOR_REQ FB10
				ON LN60.BF_SSN = FB10.BF_SSN
				AND LN60.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM
		WHERE 
			LN60.LC_STA_LON60 = 'A'
			AND FB10.LC_FOR_STA = 'A'
			AND FB10.LC_STA_FOR10 = 'A'
			AND LN60.LC_FOR_RSP != '003'
		GROUP BY 
			LN60.BF_SSN,
			LN60.LN_SEQ
	) FORB
		ON LN10.BF_SSN = FORB.BF_SSN
		AND LN10.LN_SEQ = FORB.LN_SEQ
	LEFT JOIN 
	(
		SELECT	
			DF_PRS_ID,
			MAX(DD_DTH_STA) AS DD_DTH_STA
		FROM
			UDW..PD21_GTR_DTH 
		GROUP BY
			DF_PRS_ID
	) PD21
		ON LN10.BF_SSN = PD21.DF_PRS_ID
	LEFT JOIN 
	(
		SELECT	
			DF_PRS_ID,
			MAX(DD_DTH_NTF) AS DD_DTH_NTF
		FROM
			UDW..PD20_PRS_DTH 
		GROUP BY
			DF_PRS_ID
	) PD20
		ON LN10.BF_SSN = PD20.DF_PRS_ID
	LEFT JOIN 
	(
		SELECT
			PD22.DF_PRS_ID,
			PD22.DD_PRS_DSA_SPS_SR 
		FROM 
			UDW..PD22_PRS_DSA PD22
			INNER JOIN UDW..PD23_GTR_DSA PD23
				ON PD22.DF_PRS_ID = PD23.DF_PRS_ID
				AND PD22.DD_DSA_RPT = PD23.DD_DSA_RPT
		WHERE 
			PD23.DC_DSA_STA = '07'
	) DIS_ALG
		ON LN10.BF_SSN = DIS_ALG.DF_PRS_ID
	LEFT JOIN 
	(
		SELECT
			PD22.DF_PRS_ID,
			PD22.DD_DSA_RPT 
		FROM 
			UDW..PD22_PRS_DSA PD22
			INNER JOIN UDW..PD23_GTR_DSA PD23
				ON PD22.DF_PRS_ID = PD23.DF_PRS_ID
				AND PD22.DD_DSA_RPT = PD23.DD_DSA_RPT
		WHERE 
			PD23.DC_DSA_STA = '09'
	) DIS_VRF
		ON LN10.BF_SSN = DIS_VRF.DF_PRS_ID
	LEFT JOIN 
	(
		SELECT 
			PD24.*
		FROM
			UDW..PD24_PRS_BKR PD24
			INNER JOIN
			(
				SELECT
					DF_PRS_ID,
					MAX(DD_BKR_STA) AS DD_BKR_STA,
					MAX(DD_BKR_NTF) AS DD_BKR_NTF
				FROM
					UDW..PD24_PRS_BKR PD24
				GROUP BY
					DF_PRS_ID
			) MP
				ON MP.DF_PRS_ID = PD24.DF_PRS_ID
				AND MP.DD_BKR_STA = PD24.DD_BKR_STA
				AND MP.DD_BKR_NTF = PD24.DD_BKR_NTF
	) PD24
		ON LN10.BF_SSN = PD24.DF_PRS_ID
	LEFT JOIN 
	(
		SELECT
			LN90.BF_SSN,
			LN90.LN_SEQ,
			LN90.LD_FAT_EFF,
			MaxLN90.LA_FAT_CUR_PRI
		FROM 
			UDW..LN90_FIN_ATY LN90
			INNER JOIN 
			(
				SELECT
					LN90.BF_SSN,
					LN90.LN_SEQ,
					MAX(LN90.LD_FAT_EFF) AS LD_FAT_EFF,
					SUM(LN90.LA_FAT_CUR_PRI) AS LA_FAT_CUR_PRI
				FROM 
					UDW..LN90_FIN_ATY LN90
				WHERE 
					LN90.PC_FAT_TYP = '10'
					AND LN90.PC_FAT_SUB_TYP = '40'
					AND COALESCE(LN90.LC_FAT_REV_REA,'') = ''
					AND LN90.LC_STA_LON90 = 'A'
				GROUP BY 
					LN90.BF_SSN,
					LN90.LN_SEQ
			) MaxLN90
				ON LN90.BF_SSN = MaxLN90.BF_SSN
				AND LN90.LN_SEQ = MaxLN90.LN_SEQ
				AND LN90.LD_FAT_EFF = MaxLN90.LD_FAT_EFF
	) REFM
		ON LN10.BF_SSN = REFM.BF_SSN
		AND LN10.LN_SEQ = REFM.LN_SEQ
	LEFT JOIN UDW..GR10_RPT_LON_APL GR10
		ON LN10.BF_SSN = GR10.BF_SSN
		AND LN10.LN_SEQ = GR10.LN_SEQ
	LEFT JOIN 
	(
		SELECT DISTINCT
			LN90.BF_SSN,
			LN90.LN_SEQ,
			SUM(CASE WHEN LN90.PC_FAT_TYP = '10' AND LN90.PC_FAT_SUB_TYP = '10' THEN COALESCE(LN90.LA_FAT_CUR_PRI,0.00) + COALESCE(LN90.LA_FAT_NSI,0.00) + COALESCE(LN90.LA_FAT_LTE_FEE,0.00) ELSE 0.00 END) OVER(PARTITION BY LN90.BF_SSN, LN90.LN_SEQ) AS AmtPaid,
			SUM(CASE WHEN LN90.PC_FAT_TYP = '26' THEN COALESCE(LN90.LA_FAT_LTE_FEE,0.00) ELSE 0.00 END) OVER(PARTITION BY LN90.BF_SSN, LN90.LN_SEQ) AS LateFee,
			SUM(CASE WHEN LN90.PC_FAT_TYP = '70' AND LN90.PC_FAT_SUB_TYP = '01' THEN COALESCE(LN90.LA_FAT_NSI,0.00) ELSE 0.00 END)  OVER(PARTITION BY LN90.BF_SSN, LN90.LN_SEQ) AS IntCap
		FROM 
			UDW..LN90_FIN_ATY LN90
		WHERE
			LN90.LC_STA_LON90 = 'A'
			AND COALESCE(LN90.LC_FAT_REV_REA,'') = ''
			AND
			(
				(
					LN90.PC_FAT_TYP = '10'
					AND LN90.PC_FAT_SUB_TYP = '10'
				)
				OR LN90.PC_FAT_TYP = '26'
				OR 
				(
					LN90.PC_FAT_TYP = '70'
					AND LN90.PC_FAT_SUB_TYP = '01'
				)
			)
	) PaidIntFees
		ON LN10.BF_SSN = PaidIntFees.BF_SSN
		AND LN10.LN_SEQ = PaidIntFees.LN_SEQ
	LEFT JOIN
	(
		SELECT
			LN16.BF_SSN,
			LN16.LN_SEQ,
			LN16.LN_DLQ_MAX
		FROM
			UDW..LN16_LON_DLQ_HST LN16
		WHERE
			LN16.LC_STA_LON16 = '1'
			AND CAST(LN16.LF_LST_DTS_LN16 AS DATE) = CAST(DATEADD(DAY,-1,GETDATE()) AS DATE)
	) DELQ
		ON LN10.BF_SSN = DELQ.BF_SSN
		AND LN10.LN_SEQ = DELQ.LN_SEQ
	LEFT JOIN
	(
		SELECT DISTINCT
			LN90.BF_SSN,
			LN90.LN_SEQ,
			MAX(CASE WHEN LN90.PC_FAT_TYP = '03' AND LN90.PC_FAT_SUB_TYP = '95' THEN LN90.LD_FAT_EFF ELSE NULL END) OVER(PARTITION BY LN90.BF_SSN, LN90.LN_SEQ) AS LoanSaleDate,
			MAX(CASE WHEN LN90.PC_FAT_TYP = '10' AND LN90.PC_FAT_SUB_TYP = '30' THEN LN90.LD_FAT_EFF ELSE NULL END) OVER(PARTITION BY LN90.BF_SSN, LN90.LN_SEQ) AS ClaimPaidDate
		FROM 
			UDW..LN90_FIN_ATY LN90
			INNER JOIN UDW..LN10_LON LN10
				ON LN10.BF_SSN = LN90.BF_SSN
				AND LN10.LN_SEQ = LN90.LN_SEQ
		WHERE
			LN90.LC_STA_LON90 = 'A'
			AND COALESCE(LN90.LC_FAT_REV_REA,'') = ''
			AND
			( 
				(
					LN90.PC_FAT_TYP = '03'
					AND LN90.PC_FAT_SUB_TYP = '95'
					AND LN10.LF_LON_CUR_OWN IN ('826717','830248')
				)
				OR
				(
					LN90.PC_FAT_TYP = '10'
					AND LN90.PC_FAT_SUB_TYP = '30'
				)
			)
	) LOAN_SOLD
		ON LN10.BF_SSN = LOAN_SOLD.BF_SSN
		AND LN10.LN_SEQ = LOAN_SOLD.LN_SEQ		
	LEFT JOIN
	(	--Adding Active Interest Rate
		SELECT
			LN72.BF_SSN, 
			LN72.LN_SEQ,
			LN72.LR_ITR,
			ROW_NUMBER() OVER (PARTITION BY LN72.BF_SSN, LN72.LN_SEQ ORDER BY LD_STA_LON72 DESC) AS SEQ
		FROM
			UDW..LN72_INT_RTE_HST LN72
		WHERE
			LN72.LC_STA_LON72 = 'A'
			AND	CAST(GETDATE() AS DATE) BETWEEN LN72.LD_ITR_EFF_BEG AND LN72.LD_ITR_EFF_END
	) LN72 
		ON LN10.BF_SSN = LN72.BF_SSN
		AND LN10.LN_SEQ = LN72.LN_SEQ
		AND LN72.SEQ = 1
	LEFT JOIN 
	(
		SELECT 
			LN65.BF_SSN,
			LN65.LN_SEQ,
			LN65.LD_CRT_LON65,
			LN65.LC_TYP_SCH_DIS 
		FROM 
			UDW..LN65_LON_RPS LN65
			INNER JOIN 
			(
				SELECT
					LN65.BF_SSN,
					LN65.LN_SEQ,
					MAX(LN65.LN_RPS_SEQ) AS LN_RPS_SEQ
				FROM 
					UDW..LN65_LON_RPS LN65
				WHERE
					LN65.LD_CRT_LON65 < @EndDate
				GROUP BY 
					LN65.BF_SSN,
					LN65.LN_SEQ
			) LN65M
				ON LN65.BF_SSN = LN65M.BF_SSN
				AND LN65.LN_SEQ = LN65M.LN_SEQ
				AND LN65.LN_RPS_SEQ = LN65M.LN_RPS_SEQ
	) LN65
		ON LN10.BF_SSN = LN65.BF_SSN
		AND LN10.LN_SEQ = LN65.LN_SEQ
WHERE
	(
		SUBSTRING(LN10.LF_LON_CUR_OWN,1,6) IN ('826717','828476','829769','830248')
		AND SUBSTRING(LN10.IF_GTR,4,3) IN ('706','709','741','744','745','747','751','927','951','725','729','731','733','736','740','748','749','753','755','800')
	)
	AND (LN10.LD_PIF_RPT IS NULL OR LN10.LD_PIF_RPT >= @StartDate )
	AND LN10.LF_LST_DTS_LN10 >= @StartDate
	AND (LoanPurch.LD_FAT_EFF IS NULL OR LoanPurch.LD_FAT_EFF <= @EndDate)

--) p
--) pp
--where pp.c > 1