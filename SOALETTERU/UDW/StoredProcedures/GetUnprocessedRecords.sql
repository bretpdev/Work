CREATE PROCEDURE [soaletteru].[GetUnprocessedRecords]
	
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT DISTINCT
	LT20.DF_SPE_ACC_ID,
	LT20.RM_APL_PGM_PRC,
	LT20.RT_RUN_SRT_DTS_PRC,
	LT20.RN_SEQ_LTR_CRT_PRC, 
	LT20.RM_DSC_LTR_PRC,
	LT20.RF_SBJ_PRC,
	CASE WHEN DW01.BF_SSN IS NULL 
		THEN 0
		ELSE 1
	END AS InvalidLoanStatus,
	CASE WHEN AY10.LF_ATY_RCP != LT20.RF_SBJ_PRC 
		THEN AY10.LF_ATY_RCP
		ELSE ''
	END AS EndorsersSsn,
	LT20.OnEcorr,
	ISNULL(PH05.DX_CNC_EML_ADR, 'ecorr@utahsbr.edu') AS EmailAddress,
	'Monday - Friday 8 AM - 5 PM MT' AS Hours1,
	'' AS Hours2,
	SR.Recipient,
	LT20.PrintedAt,
	LT20.EcorrDocumentCreatedAt,
	0 AS IsCoborrower,
	'' AS CoborrowerSSN,
	PD10.DF_PRS_ID AS BorrowerSSN,
	LT20.DF_SPE_ACC_ID AS LetterAccountNumber
FROM
	LT20_LTR_REQ_PRC LT20
	INNER JOIN PD10_PRS_NME PD10
		ON PD10.DF_SPE_ACC_ID = LT20.DF_SPE_ACC_ID
	INNER JOIN
	(
		SELECT
			LT20_I.DF_SPE_ACC_ID,
			LT20_I.RM_APL_PGM_PRC,
			LT20_I.RT_RUN_SRT_DTS_PRC,
			LT20_I.RN_SEQ_LTR_CRT_PRC,
			MIN(LT20_I.RN_SEQ_REC_PRC) OVER(PARTITION BY LT20_I.DF_SPE_ACC_ID, LT20_I.RM_APL_PGM_PRC, LT20_I.RT_RUN_SRT_DTS_PRC, LT20_I.RN_SEQ_LTR_CRT_PRC, LT20_I.RM_DSC_LTR_PRC) AS RN_SEQ_REC_PRC,
			LT20_I.RM_DSC_LTR_PRC
		FROM
			LT20_LTR_REQ_PRC LT20_I
	) MIN_REC
		ON MIN_REC.DF_SPE_ACC_ID = LT20.DF_SPE_ACC_ID
		AND MIN_REC.RM_APL_PGM_PRC = LT20.RM_APL_PGM_PRC
		AND MIN_REC.RT_RUN_SRT_DTS_PRC = LT20.RT_RUN_SRT_DTS_PRC
		AND MIN_REC.RN_SEQ_LTR_CRT_PRC = LT20.RN_SEQ_LTR_CRT_PRC
		AND MIN_REC.RN_SEQ_REC_PRC = LT20.RN_SEQ_REC_PRC
		AND MIN_REC.RM_DSC_LTR_PRC = LT20.RM_DSC_LTR_PRC
	LEFT JOIN PH05_CNC_EML PH05
		ON PH05.DF_SPE_ID = LT20.DF_SPE_ACC_ID
	LEFT JOIN 
	(
		SELECT DISTINCT
			BF_SSN
		FROM
			DW01_DW_CLC_CLU
		WHERE
			WC_DW_LON_STA IN ('17','19','21')
	) DW01
		ON DW01.BF_SSN = PD10.DF_PRS_ID
	INNER JOIN AY10_BR_LON_ATY AY10
		ON AY10.BF_SSN = LT20.RF_SBJ_PRC
		AND AY10.LN_ATY_SEQ = LT20.RN_ATY_SEQ_PRC
	LEFT JOIN ULS.dbo.SpecialLetterRecipients SR
		ON SR.LetterId = lt20.RM_DSC_LTR_PRC
WHERE
	(
		(
			LT20.PrintedAt IS NULL 
			AND LT20.OnEcorr = 0
		) 
		OR LT20.EcorrDocumentCreatedAt IS NULL
	)
	AND LT20.InactivatedAt IS NULL
	AND LT20.RI_LTR_REQ_DEL_PRC = 'N'
	AND LT20.RM_DSC_LTR_PRC = 'US06BTSA'

UNION ALL

SELECT DISTINCT
	LT20.DF_SPE_ACC_ID,
	LT20.RM_APL_PGM_PRC,
	LT20.RT_RUN_SRT_DTS_PRC,
	LT20.RN_SEQ_LTR_CRT_PRC, 
	LT20.RM_DSC_LTR_PRC,
	LT20.RF_SBJ_PRC,
	CASE WHEN DW01.BF_SSN IS NULL 
		THEN 0
		ELSE 1
	END AS InvalidLoanStatus,
	CASE WHEN AY10.LF_ATY_RCP != LT20.RF_SBJ_PRC 
		THEN AY10.LF_ATY_RCP
		ELSE ''
	END AS EndorsersSsn,
	LT20.OnEcorr,
	ISNULL(PH05.DX_CNC_EML_ADR, 'ecorr@utahsbr.edu') AS EmailAddress,
	'Monday - Friday 8 AM - 5 PM MT' AS Hours1,
	'' AS Hours2,
	SR.Recipient,
	LT20.PrintedAt,
	LT20.EcorrDocumentCreatedAt,
	1 AS IsCoborrower,
	LN20.LF_EDS AS CoborrowerSSN,
	BorrowerPD10.DF_PRS_ID AS BorrowerSSN,
	LT20.Borrower_DF_SPE_ACC_ID AS LetterAccountNumber
FROM
	LT20_LTR_REQ_PRC_Coborrower LT20
	INNER JOIN PD10_PRS_NME PD10
		ON PD10.DF_SPE_ACC_ID = LT20.DF_SPE_ACC_ID
	INNER JOIN
	(
		SELECT
			LT20_I.DF_SPE_ACC_ID,
			LT20_I.RM_APL_PGM_PRC,
			LT20_I.RT_RUN_SRT_DTS_PRC,
			LT20_I.RN_SEQ_LTR_CRT_PRC,
			MIN(LT20_I.RN_SEQ_REC_PRC) OVER(PARTITION BY LT20_I.DF_SPE_ACC_ID, LT20_I.RM_APL_PGM_PRC, LT20_I.RT_RUN_SRT_DTS_PRC, LT20_I.RN_SEQ_LTR_CRT_PRC, LT20_I.RM_DSC_LTR_PRC) AS RN_SEQ_REC_PRC,
			LT20_I.RM_DSC_LTR_PRC
		FROM
			LT20_LTR_REQ_PRC_Coborrower LT20_I
	) MIN_REC
		ON MIN_REC.DF_SPE_ACC_ID = LT20.DF_SPE_ACC_ID
		AND MIN_REC.RM_APL_PGM_PRC = LT20.RM_APL_PGM_PRC
		AND MIN_REC.RT_RUN_SRT_DTS_PRC = LT20.RT_RUN_SRT_DTS_PRC
		AND MIN_REC.RN_SEQ_LTR_CRT_PRC = LT20.RN_SEQ_LTR_CRT_PRC
		AND MIN_REC.RN_SEQ_REC_PRC = LT20.RN_SEQ_REC_PRC
		AND MIN_REC.RM_DSC_LTR_PRC = LT20.RM_DSC_LTR_PRC
	INNER JOIN LN20_EDS LN20
		ON LN20.LF_EDS = PD10.DF_PRS_ID
		AND LN20.LC_STA_LON20 = 'A'
		AND LN20.LC_EDS_TYP = 'M' --coborrower
	INNER JOIN PD10_PRS_NME BorrowerPD10
		ON BorrowerPD10.DF_SPE_ACC_ID = LT20.Borrower_DF_SPE_ACC_ID
	LEFT JOIN PH05_CNC_EML PH05
		ON PH05.DF_SPE_ID = LT20.DF_SPE_ACC_ID
	LEFT JOIN 
	( 
		SELECT DISTINCT
			BF_SSN
		FROM
			DW01_DW_CLC_CLU
		WHERE
			WC_DW_LON_STA IN ('17','19','21')
	) DW01
		ON DW01.BF_SSN = BorrowerPD10.DF_PRS_ID
	INNER JOIN AY10_BR_LON_ATY AY10
		ON AY10.BF_SSN = BorrowerPD10.DF_PRS_ID
		AND AY10.LN_ATY_SEQ = LT20.RN_ATY_SEQ_PRC
	LEFT JOIN ULS.dbo.SpecialLetterRecipients SR
		ON SR.LetterId = lt20.RM_DSC_LTR_PRC
WHERE
	(
		(
			LT20.PrintedAt IS NULL 
			AND LT20.OnEcorr = 0
		) 
		OR LT20.EcorrDocumentCreatedAt IS NULL
	)
	AND LT20.InactivatedAt IS NULL
	AND LT20.RI_LTR_REQ_DEL_PRC = 'N'
	AND LT20.RM_DSC_LTR_PRC = 'US06BTSA'
