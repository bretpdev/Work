SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @PREVIOUSWORKDAY DATE = 
(--if run on Monday then do Saturday, else do yesterday
	SELECT
		CASE
			WHEN DATENAME(WEEKDAY,GETDATE()) = 'Monday'
			THEN DATEADD(DAY,-3,GETDATE())
			ELSE DATEADD(DAY,-1,GETDATE())
		END
);

DECLARE @YESTERDAY DATE = DATEADD(DAY,-1,GETDATE());

--COMPASS:
SELECT DISTINCT
	AY10.LF_USR_REQ_ATY AS [User],
	AY10.LD_ATY_REQ_RCV AS [Date],
	PD10.DF_SPE_ACC_ID AS [Borrower Account #],
	AY10.PF_REQ_ACT AS ARC,
	AY20.LX_ATY AS Comment
FROM
	UDW..AY10_BR_LON_ATY AY10
	INNER JOIN UDW..AY20_ATY_TXT AY20
		ON AY10.BF_SSN = AY20.BF_SSN
		AND AY10.LN_ATY_SEQ = AY20.LN_ATY_SEQ
	INNER JOIN UDW..PD10_PRS_NME PD10
		ON AY10.BF_SSN = PD10.DF_PRS_ID
WHERE
	AY10.LC_STA_ACTY10 = 'A'
	AND AY20.LX_ATY LIKE '%"%'
	AND AY10.LD_ATY_REQ_RCV BETWEEN @PREVIOUSWORKDAY AND @YESTERDAY
	AND AY10.LF_USR_REQ_ATY LIKE 'UT%' --exclude system generated comments
ORDER BY
	PD10.DF_SPE_ACC_ID
;

--ONELINK:
SELECT DISTINCT
	AY01.BF_LST_USR_AY01 AS [User],
	AY01.BD_ATY_PRF AS [Date],
	PD01.DF_SPE_ACC_ID AS [Borrower Account #],
	AY01.PF_ACT AS ARC,
	AY01.BX_CMT AS Comment
FROM
	ODW..AY01_BR_ATY AY01
	INNER JOIN ODW..PD01_PDM_INF PD01
		ON AY01.DF_PRS_ID = PD01.DF_PRS_ID
WHERE
	AY01.BX_CMT LIKE '%"%'
	AND AY01.BD_ATY_PRF BETWEEN @PREVIOUSWORKDAY AND @YESTERDAY
	AND AY01.BF_LST_USR_AY01 LIKE 'UT%' --exclude system generated comments
ORDER BY
	PD01.DF_SPE_ACC_ID
;
