/*--------------------------------------*
* UTLWM21 - PAYMENTS RECEIVED SINCE NDNH 
*---------------------------------------*/
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWM21.LWM21R2";
FILENAME REPORT3 "&RPTLIB/ULWM21.LWM21R3";
FILENAME REPORTZ "&RPTLIB/ULWM21.LWM21RZ";
/**************************************************************************
* IDENTIFY CURRENT FISCAL YEAR AND QUARTER
***************************************************************************/
DATA _NULL_;
TODAY = TODAY();
IF MONTH(TODAY) IN (10,11,12) THEN DO;
	CUR_QTR = 1;
	CUR_FY = YEAR(TODAY)+1;
	END;
ELSE IF MONTH(TODAY) IN (1,2,3) THEN DO;
	CUR_QTR = 2;
	CUR_FY = YEAR(TODAY);
	END;
ELSE IF MONTH(TODAY) IN (4,5,6) THEN DO;
	CUR_QTR = 3;
	CUR_FY = YEAR(TODAY);
	END;
IF MONTH(TODAY) IN (7,8,9) THEN DO;
	CUR_QTR = 4;
	CUR_FY = YEAR(TODAY);
	END;
CALL SYMPUT('CQTR',CUR_QTR);
CALL SYMPUT('CFY',CUR_FY);
RUN;
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	FILENAME REPORTZ "&RPTLIB/&SQLRPT";
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;
/********************************************************
* IDENTIFY ALL NDNH PAYMENTS TO DATE
*********************************************************/
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE NDNH AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT DC01.BF_SSN
	,DC11.LA_TRX
	,DC11.LC_TRX_TYP
	,DC11.LD_TRX_EFF
	,BR01.BD_NDNH_EMP_INF AS NDNH_DT
FROM OLWHRM1.DC01_LON_CLM_INF DC01
INNER JOIN OLWHRM1.BR01_BR_CRF BR01
	ON DC01.BF_SSN = BR01.BF_SSN
INNER JOIN 
	(SELECT DISTINCT BF_SSN
		,LA_TRX
		,LC_TRX_TYP
		,LD_TRX_EFF
 	 FROM OLWHRM1.DC11_LON_FAT
	 WHERE LC_TRX_TYP IN ('BR','EP','GP')
	) DC11
	ON DC01.BF_SSN = DC11.BF_SSN
WHERE BR01.BD_NDNH_EMP_INF IS NOT NULL
AND DC11.LD_TRX_EFF > BR01.BD_NDNH_EMP_INF
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWM21.LWM21RZ);*/
/*QUIT;*/
ENDRSUBMIT;
DATA NDNH;
SET WORKLOCL.NDNH;
RUN;
/**************************************************************************
* ASSIGN UNIQUE BORROWER COUNT OVER ALL FISCAL YEARS
***************************************************************************/
PROC SORT DATA=NDNH NODUPRECS;BY BF_SSN LD_TRX_EFF LA_TRX LC_TRX_TYP NDNH_DT;RUN;
DATA NDNH;
SET NDNH;
BY BF_SSN;
IF FIRST.BF_SSN THEN UBI = 1;
ELSE UBI = 0;
RUN;
DATA NDNH;
SET NDNH;
IF MONTH(LD_TRX_EFF) IN (10,11,12) THEN DO;
	QTR = 1;
	FY = YEAR(LD_TRX_EFF)+1;
	END;
ELSE IF MONTH(LD_TRX_EFF) IN (1,2,3) THEN DO;
	QTR = 2;
	FY = YEAR(LD_TRX_EFF);
	END;
ELSE IF MONTH(LD_TRX_EFF) IN (4,5,6) THEN DO;
	QTR = 3;
	FY = YEAR(LD_TRX_EFF);
	END;
IF MONTH(LD_TRX_EFF) IN (7,8,9) THEN DO;
	QTR = 4;
	FY = YEAR(LD_TRX_EFF);
	END;
RUN;
/**************************************************************************
* ASSIGN UNIQUE BORROWER COUNT PER FISCAL YEAR
***************************************************************************/
PROC SORT DATA=NDNH;BY BF_SSN FY ;RUN;
DATA NDNH;
SET NDNH;
BY BF_SSN FY;
IF FIRST.FY THEN UBIFY = 1;
ELSE UBIFY = 0;
RUN;
/**************************************************************************
* CREATE DATA SET WITH RUNNING TOTALS FOR ALL FISCAL YEARS
***************************************************************************/
PROC SQL;
CREATE TABLE NDNHTOT AS 
SELECT A.FY 
	,A.QTR 
	,SUM(A.UBI) AS BR_COUNT
	,COALESCE(SUM(A.LA_TRX),0) AS TRX_SUM
FROM NDNH A
GROUP BY A.FY
	,A.QTR
;
QUIT;
DATA NDNHTOT (DROP=BR_COUNT TRX_SUM) ;
SET NDNHTOT END=LAST;
	BR_RTOT+BR_COUNT;
	TRX_RTOT+TRX_SUM;
IF LAST THEN OUTPUT;
RUN;
/*******************************************************************
* CALCULATE MACRO VARIABLES FOR REPORT TITLES
********************************************************************/
DATA _NULL_;
IF &CQTR = 1 THEN DO;
	REP_QTR = '4';
	REP_FY = TRIM(LEFT(PUT(&CFY-1,BEST12.)));
	END;
ELSE DO;
	REP_QTR = TRIM(LEFT(PUT(&CQTR-1,BEST12.)));
	REP_FY = PUT(&CFY,BEST12.);
	END;
CALL SYMPUT('REP_QTR',REP_QTR);
CALL SYMPUT('REP_FY',TRIM(LEFT(REP_FY)));
RUN;
/*******************************************************************
* CUMULATIVE QUARTERLY REPORTS FOR THE PREVIOUS QUARTER
********************************************************************/
PROC PRINTTO PRINT=REPORT2 NEW;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 CENTER NODATE NOBYLINE PAGENO=1;
TITLE	"NDNH: FISCAL YEAR &REP_FY - QUARTER &REP_QTR";
FOOTNOTE "JOB = UTLWM21			       REPORT=ULWM21.LWM21R2";
PROC PRINT NOOBS SPLIT='/' DATA=NDNHTOT WIDTH=UNIFORM WIDTH=MIN;
FORMAT BR_RTOT COMMA6. TRX_RTOT DOLLAR14.2;
VAR BR_RTOT TRX_RTOT;
LABEL TRX_RTOT = 'TOTAL AMOUNT PAID'
	BR_RTOT = 'TOTAL NUMBER OF BORROWERS'
	;
RUN;
PROC PRINTTO;
RUN;
/********************************************************************************
* YEAR END REPORT - ONLY CREATE ON THE FIRST QUATER FOR THE PREVIOUS FISCAL YEAR
*********************************************************************************/
%MACRO EOFY(FIVESQARED,FIS);
%IF &FIVESQARED EQ 1 %THEN %DO;
DATA _NULL_;
	/*CREATE DATA SET WITH PREVIOUS FISCAL YEAR DATA - FOR YEAR END REPORT*/
	PROC SQL;
	CREATE TABLE PRVFY AS 
	SELECT FY
		,SUM(UBIFY) AS UNIQUE_BORROWERS
		,SUM(LA_TRX) AS TOTAL
	FROM NDNH
	WHERE FY = &FIS
	GROUP BY FY;
	QUIT;
	PROC PRINTTO PRINT=REPORT3 NEW;
	RUN;
	OPTIONS ORIENTATION = LANDSCAPE;
	OPTIONS PS=39 LS=127 CENTER NODATE NOBYLINE PAGENO=1;
	TITLE "NDNH: YEAR END FOR FISCAL YEAR &FIS";
	FOOTNOTE "JOB = UTLWM21			       REPORT=ULWM21.LWM21R3";
	PROC PRINT NOOBS SPLIT='/' DATA=PRVFY WIDTH=UNIFORM WIDTH=MIN;
	FORMAT UNIQUE_BORROWERS COMMA6. TOTAL DOLLAR14.2;
	VAR UNIQUE_BORROWERS TOTAL;
	LABEL TOTAL = 'TOTAL AMOUNT PAID'
		UNIQUE_BORROWERS = 'TOTAL NUMBER OF BORROWERS'
		;
	RUN;
	PROC PRINTTO;
	RUN;
	%END;
%MEND EOFY;
%EOFY(&CQTR,&REP_FY);
/*DETAIL FILE*/
/*PROC EXPORT DATA= NDNH*/
/*            OUTFILE= "T:\SAS\UTLWM21_DETAIL.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/
          
