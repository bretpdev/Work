CREATE PROCEDURE [lnderlettr].[InsertLetterData]
AS
BEGIN
INSERT INTO [ULS].[lnderlettr].Letters
(
	BF_SSN, 
	II_LDR_VLD_ADR, 
	InLenderList,
	[Population], 
	WF_ORG_LDR, 
	LDR_STR_ADR_1,
	ADDEDAT,
	ADDEDBY
)
SELECT DISTINCT
	WQ20.BF_SSN,
	LR25.II_LDR_VLD_ADR,
	CASE
		WHEN GR10.WF_ORG_LDR IN ('814817', '818334', '824421', '826079', '831495', '832733', '801871', '802176', '805317', '806746', '807674', '811735') THEN 1
		ELSE 0
	END AS InLenderList,
	CASE
		WHEN GR10.WF_ORG_LDR IN ('814817', '818334', '824421', '826079', '831495', '832733', '801871', '802176', '805317', '806746', '807674', '811735') THEN 1
		WHEN GR10.WF_ORG_LDR IN ('834529', '829306', '826717', '830248', '828476', '834437', '834437', '834493', '829769', '829769', '834396', '999775', '83449301', '82847601') THEN 2
		WHEN LR25.II_LDR_VLD_ADR = 'Y' THEN 3
		WHEN LR25.II_LDR_VLD_ADR = 'N' AND LR25.IX_LDR_STR_ADR_1 LIKE 'X-CLOSED-%' THEN 4
		ELSE 0 --Record didnt fit any population and wont be processed
	END AS [Population],
	CASE 
		WHEN RTRIM(GR10.WF_ORG_LDR) IN ('814817', '818334', '824421', '826079', '831495', '832733', '801871', '802176', '805317', '806746', '807674','811735') THEN '814817'
		ELSE RTRIM(GR10.WF_ORG_LDR)
	END AS [WF_ORG_LDR],
	LR25.IX_LDR_STR_ADR_1,
	GETDATE(),
	SUSER_NAME()
FROM
	UDW..WQ20_TSK_QUE WQ20
	INNER JOIN UDW..GR10_RPT_LON_APL GR10 
		ON GR10.BF_SSN = WQ20.BF_SSN
	INNER JOIN UDW..LR25_LDR_DPT LR25 
		ON  RTRIM(LR25.IF_DOE_LDR) = RTRIM(GR10.WF_ORG_LDR ) 
		AND LR25.IC_LDR_DPT = '000'
	LEFT JOIN UDW..GX25_USR GX25
		ON WQ20.WF_USR_ASN_TSK = GX25.XF_USR
	LEFT JOIN
	(
		SELECT DISTINCT
			LJ10.BF_SSN
		FROM 
			UDW..GR10_RPT_LON_APL LJ10
			INNER JOIN UDW..LR25_LDR_DPT LJ25 
				ON LJ10.WF_ORG_LDR = LJ25.IF_DOE_LDR
		WHERE 
			LJ25.II_LDR_VLD_ADR = 'N' 
			AND LJ25.IX_LDR_STR_ADR_1 NOT LIKE 'X-CLOSED-%'
	) EXCL
		ON EXCL.BF_SSN = WQ20.BF_SSN
	LEFT JOIN [lnderlettr].Letters Existing
		ON GR10.BF_SSN = Existing.BF_SSN
		AND 
		CASE 
            WHEN RTRIM(GR10.WF_ORG_LDR) IN ('814817', '818334', '824421', '826079', '831495', '832733', '801871', '802176', '805317', '806746', '807674','811735') THEN '814817'
            ELSE RTRIM(GR10.WF_ORG_LDR)
        END = Existing.WF_ORG_LDR
		AND CAST(Existing.AddedAt AS DATE) <= CAST(DATEADD(MONTH,-1,GETDATE()) AS DATE) --Letter has not gone out for this record in the last month
WHERE
	WQ20.WF_QUE = 'JR'
	AND WQ20.WF_SUB_QUE = '01'
	AND WQ20.PF_REQ_ACT IN ('S7LA9', 'S1ORL', 'S1OLE')
	AND
	(
		WQ20.WC_STA_WQUE20 = 'U' -- Unassigned
		OR
		(
			WQ20.WC_STA_WQUE20 = 'W' 
			AND GX25.XF_USR IS NOT NULL
		)
	)
	AND 
	(
		(
			LR25.II_LDR_VLD_ADR = 'N' 
			AND LR25.IX_LDR_STR_ADR_1 LIKE 'X-CLOSED-%'
		)
		OR LR25.II_LDR_VLD_ADR = 'Y'
	)
	AND Existing.BF_SSN IS NULL
	AND EXCL.BF_SSN IS NULL	

END