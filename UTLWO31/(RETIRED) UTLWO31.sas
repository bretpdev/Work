/*=================================*/
/*UTLWO31 SYSTEM APPROVED DEFERMENT*/
/*=================================*/

/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
/*FILENAME REPORT2 "&RPTLIB/ULWO31.LWO31R2";*/
/*FILENAME REPORTZ "&RPTLIB/ULWO31.LWO31RZ";*/

FILENAME REPORT2 'T:\SAS\ULWO31.LWO31R2';

DATA _NULL_;
     CALL SYMPUT('BEGIN',"'"||PUT(INTNX('DAY',TODAY(),-5,'BEGINNING'), MMDDYYD10.)||"'");
	 CALL SYMPUT('END',"'"||PUT(INTNX('DAY',TODAY(),0,'BEGINNING'), MMDDYYD10.)||"'");
RUN;

%SYSLPUT BEGIN = &BEGIN;
%SYSLPUT END = &END;

LIBNAME  WORKLOCL  REMOTE  SERVER=DUSTER  SLIBREF=WORK;
RSUBMIT;

LIBNAME SAS_TAB V8 '/sas/whse/progrevw';
PROC SQL NOPRINT;
	SELECT "'"||TRIM(LENDER_ID)||"'"
		INTO :UHEAA_LIST SEPARATED BY ","
	FROM SAS_TAB.LDR_AFF
	WHERE AFFILIATION = 'UHEAA';
QUIT;


/*%MACRO SQLCHECK (SQLRPT= );*/
/*%IF &SQLXRC NE 0 %THEN %DO;*/
/*	DATA _NULL_;*/
/*    FILE REPORTZ NOTITLES;*/
/*    PUT @01 " ********************************************************************* "*/
/*      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "*/
/*      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       */
/*      / @01 " ********************************************************************* "*/
/*      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "*/
/*      / @01 " ****  &SQLXMSG   **** "*/
/*      / @01 " ********************************************************************* ";*/
/*	RUN;*/
/*%END;*/
/*%MEND;*/

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE SYSAPDFR AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.BF_SSN
	,A.LN_SEQ
	,A.LF_LON_CUR_OWN
	,AY10.LD_ATY_REQ_RCV
	,C.DF_SPE_ACC_ID
	,C.DM_PRS_MID
	,C.DM_PRS_1
	,C.DM_PRS_LST
	,D.DX_STR_ADR_1
	,D.DX_STR_ADR_2
	,D.DM_CT
	,D.DC_DOM_ST
	,D.DF_ZIP_CDE
	,D.DM_FGN_CNY
	,D.DM_FGN_ST
	,D.DC_ADR
	,AB.LD_DFR_BEG

FROM OLWHRM1.LN10_LON A
INNER JOIN OLWHRM1.LN50_BR_DFR_APV AB
	ON A.BF_SSN = AB.BF_SSN
	AND A.LN_SEQ = AB.LN_SEQ
INNER JOIN OLWHRM1.DF10_BR_DFR_REQ B
	ON AB.BF_SSN = B.BF_SSN
	AND AB.LF_DFR_CTL_NUM = B.LF_DFR_CTL_NUM
INNER JOIN OLWHRM1.PD10_PRS_NME C
	ON A.BF_SSN = C.DF_PRS_ID
INNER JOIN OLWHRM1.PD30_PRS_ADR D
	ON C.DF_PRS_ID = D.DF_PRS_ID
LEFT OUTER JOIN 
	(SELECT BF_SSN
		,MAX(LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
	 FROM OLWHRM1.AY10_BR_LON_ATY
	 WHERE PF_REQ_ACT = 'MSD0A'
	 GROUP BY BF_SSN
	 ) AY10
	ON A.BF_SSN = AY10.BF_SSN
WHERE A.LA_CUR_PRI > 0
AND A.IC_LON_PGM <> 'TILP'
AND AB.LD_DFR_BEG BETWEEN &BEGIN AND &END
AND B.LF_USR_CRT_REQ_DFR NOT LIKE 'UT%'
AND B.LC_STA_DFR10 = 'A'
AND AB.LC_STA_LON50 = 'A'
AND A.LC_STA_LON10 = 'R'

FOR READ ONLY WITH UR
);


DISCONNECT FROM DB2;

/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWO31.LWO31RZ);*/
/*QUIT;*/

DATA SYSAPDFR;
SET SYSAPDFR;
IF LD_ATY_REQ_RCV >= LD_DFR_BEG THEN DELETE;
ELSE OUTPUT;
RUN;

/*CALCULATE COST CENTER CODE*/
DATA CSTCD (KEEP=BF_SSN INHOUSE);
SET SYSAPDFR;
WHERE LF_LON_CUR_OWN IN (&UHEAA_LIST);
INHOUSE = 'Y';
RUN;

ENDRSUBMIT;

DATA SYSAPDFR;
	SET WORKLOCL.SYSAPDFR;
RUN;
DATA CSTCD;
	SET WORKLOCL.CSTCD;
RUN;



PROC SORT DATA=CSTCD NODUPKEY;BY BF_SSN; RUN;
PROC SORT DATA=SYSAPDFR (DROP=LN_SEQ) NODUPKEY;BY BF_SSN ; RUN;

DATA SYSAPDFR;
MERGE SYSAPDFR CSTCD;
BY BF_SSN;
RUN;

DATA SYSAPDFR;
SET SYSAPDFR;
IF INHOUSE = 'Y' THEN CSTCNTR = 'MA2324';
ELSE CSTCNTR = 'MA2327';
RUN;

DATA SYSAPDFR;
SET SYSAPDFR;
IF DC_DOM_ST IN ('FC',' ') THEN SRTVR = 1;
ELSE SRTVR = 2;
RUN;

*CALCULATE KEYLINE;
DATA SYSAPDFR (DROP = KEYSSN MODAY KEYLINE CHKDIG DIG I 
	CHKDIG CHK1 CHK2 CHK3 CHKDIGIT CHECK);
SET SYSAPDFR;
KEYSSN = TRANSLATE(BF_SSN,'MYLAUGHTER','0987654321');
MODAY = PUT(DATE(),MMDDYYN4.);
KEYLINE = "P"||KEYSSN||MODAY||DC_ADR;
CHKDIG = 0;
LENGTH DIG $2.;
DO I = 1 TO LENGTH(KEYLINE);
	IF I/2 NE ROUND(I/2,1) 
		THEN DIG = PUT(INPUT(SUBSTR(KEYLINE,I,1),BITS4.4) * 2, 2.);
	ELSE DIG = PUT(INPUT(SUBSTR(KEYLINE,I,1),BITS4.4), 2.);
	IF SUBSTR(DIG,1,1) = " " 
		THEN CHKDIG = CHKDIG + INPUT(SUBSTR(DIG,2,1),1.);
		ELSE DO;
			CHK1 = INPUT(SUBSTR(DIG,1,1),1.);
			CHK2 = INPUT(SUBSTR(DIG,2,1),1.);
			IF CHK1 + CHK2 >= 10
				THEN DO;
					CHK3 = PUT(CHK1 + CHK2,2.);
					CHK1 = INPUT(SUBSTR(CHK3,1,1),1.);
					CHK2 = INPUT(SUBSTR(CHK3,2,1),1.);
				END;
			CHKDIG = CHKDIG + CHK1 + CHK2;
		END;
END;
CHKDIGIT = 10 - INPUT(SUBSTR((RIGHT(PUT(CHKDIG,3.))),3,1),3.);
IF CHKDIGIT = 10 THEN CHKDIGIT = 0;
CHECK = PUT(CHKDIGIT,1.);
ACSKEY = "#"||KEYLINE||CHECK||"#";
RUN;

PROC SORT DATA=SYSAPDFR;BY CSTCNTR SRTVR DC_DOM_ST;RUN;

DATA _NULL_;
SET  WORK.SYSAPDFR ;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
   FORMAT LF_LON_CUR_OWN $8. ;
   FORMAT DF_SPE_ACC_ID $10. ;
   FORMAT DM_PRS_MID $13. ;
   FORMAT DM_PRS_1 $13. ;
   FORMAT DM_PRS_LST $23. ;
   FORMAT DX_STR_ADR_1 $30. ;
   FORMAT DX_STR_ADR_2 $30. ;
   FORMAT DM_CT $20. ;
   FORMAT DC_DOM_ST $2. ;
   FORMAT DF_ZIP_CDE $17. ;
   FORMAT DM_FGN_CNY $25. ;
   FORMAT DM_FGN_ST $15. ;
   FORMAT DC_ADR $1. ;
   FORMAT CSTCNTR $6. ;
   FORMAT ACSKEY $21. ;
   FORMAT BF_SSN $9.;
IF _N_ = 1 THEN    
 DO;
   PUT
   'BF_SSN'
   ','
	'ACSKEY'
   ',' 			
	'DF_SPE_ACC_ID'
   ','
	'DM_PRS_MID'
   ',' 		
	'DM_PRS_1'
   ',' 		
	'DM_PRS_LST'
   ',' 		
	'DX_STR_ADR_1'
   ',' 	
	'DX_STR_ADR_2'
   ',' 	
	'DM_CT'
   ',' 			
	'DC_DOM_ST'
   ',' 		
	'DF_ZIP_CDE'
   ',' 		
	'DM_FGN_CNY'
   ',' 		
	'DM_FGN_ST'
   ',' 		
	'DC_ADR'
   ',' 			
	'LF_LON_CUR_OWN'
   ',' 	
	'STATE_IND'
   ','		
	'COST_CENTER_CODE';
END;
DO;
PUT BF_SSN $ @ ;
PUT ACSKEY $ @ ;
PUT DF_SPE_ACC_ID $ @;
PUT DM_PRS_MID $ @;
PUT DM_PRS_1 $ @;
PUT DM_PRS_LST $ @;
PUT DX_STR_ADR_1 $ @;
PUT DX_STR_ADR_2 $ @;
PUT DM_CT $ @;
PUT DC_DOM_ST $ @;
PUT DF_ZIP_CDE $ @;
PUT DM_FGN_CNY $ @;
PUT DM_FGN_ST $ @;
PUT DC_ADR $ @;
PUT LF_LON_CUR_OWN $ @;
PUT DC_DOM_ST $ @;
PUT CSTCNTR $ ;
END;
RUN;
