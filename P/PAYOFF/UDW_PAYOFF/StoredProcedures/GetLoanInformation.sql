CREATE PROCEDURE [payoff].[GetLoanInformation]
	@AccountNumber VARCHAR(10),
	@IsCoborrower BIT = 0
AS
BEGIN
	SET NOCOUNT ON;
IF @IsCoBorrower = 0
	BEGIN
		SELECT
			ROW_NUMBER() OVER (PARTITION BY LN10.BF_SSN ORDER BY LN10.BF_SSN, LN10.LN_SEQ ASC) AS RowId, 
			LN10.LN_SEQ AS LoanSequence,
			CONVERT(VARCHAR(16), CAST(LN10.LA_CUR_PRI AS MONEY), 2) AS CurrentPrincipal,
			COALESCE(FT.[Label], LN10.IC_LON_PGM) AS LoanProgram
		FROM
			UDW..LN10_LON LN10
			INNER JOIN UDW..PD10_PRS_NME PD10
				ON LN10.BF_SSN = PD10.DF_PRS_ID
			LEFT JOIN UDW..FormatTranslation FT
				ON LN10.IC_LON_PGM = FT.[Start]
				AND FT.FmtName = '$LNPROG'
		WHERE
			PD10.DF_SPE_ACC_ID = @AccountNumber
			AND LN10.LA_CUR_PRI > 0
			AND LN10.LC_STA_LON10 IN ('I','J','P','R')
	END
ELSE
	BEGIN
		SELECT
			ROW_NUMBER() OVER (PARTITION BY LN10.BF_SSN ORDER BY LN10.BF_SSN, LN10.LN_SEQ ASC) AS RowId, 
			LN10.LN_SEQ AS LoanSequence,
			CONVERT(VARCHAR(16), CAST(LN10.LA_CUR_PRI AS MONEY), 2) AS CurrentPrincipal,
			COALESCE(FT.[Label], LN10.IC_LON_PGM) AS LoanProgram
		FROM
			UDW..PD10_PRS_NME PD10
			INNER JOIN LN20_EDS LN20
					ON LN20.BF_SSN = PD10.DF_PRS_ID
					AND LN20.LC_STA_LON20 = 'A'
					AND LN20.LC_EDS_TYP = 'M' --Coborrower
			INNER JOIN UDW..LN10_LON LN10
				ON LN10.BF_SSN = LN20.BF_SSN
				AND LN10.LN_SEQ = LN20.LN_SEQ
			LEFT JOIN UDW..FormatTranslation FT
				ON LN10.IC_LON_PGM = FT.[Start]
				AND FT.FmtName = '$LNPROG'
		WHERE
			PD10.DF_SPE_ACC_ID = @AccountNumber
			AND LN10.LA_CUR_PRI > 0
			AND LN10.LC_STA_LON10 IN ('I','J','P','R')
	END
END

RETURN 0
