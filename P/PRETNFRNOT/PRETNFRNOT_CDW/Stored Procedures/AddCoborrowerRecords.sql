CREATE PROCEDURE [pretnfrnot].[AddCoborrowerRecords]
	@LetterId VARCHAR(10)
AS
	
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

INSERT INTO LT20_LTR_REQ_PRC_Coborrower
(
	DF_SPE_ACC_ID, --endr account
	Borrower_DF_SPE_ACC_ID,
	RM_APL_PGM_PRC,
	RT_RUN_SRT_DTS_PRC,
	RN_SEQ_LTR_CRT_PRC,
	RN_SEQ_REC_PRC,
	RM_DSC_LTR_PRC,
	RC_TYP_SBJ_PRC,
	RF_SBJ_PRC,
	RN_ENT_REQ_PRC,
	RN_ATY_SEQ_PRC,
	RI_REC_PRC,
	RX_REQ_ARA_1_PRC,
	RX_REQ_ARA_2_PRC,
	RX_REQ_ARA_3_PRC,
	RX_REQ_ARA_4_PRC,
	RX_REQ_ARA_5_PRC,
	RX_REQ_ARA_6_PRC,
	RI_LTR_REQ_DEL_PRC,
	RC_LTR_REQ_SRC_PRC,
	RI_PRV_RUN_ERR_PRC,
	RF_LST_DTS_LT20,
	RF_COR_DOC_PRC,
	RX_REQ_ARA_16_PRC,
	RX_REQ_ARA_15_PRC,
	RX_REQ_ARA_14_PRC,
	RX_REQ_ARA_13_PRC,
	RX_REQ_ARA_12_PRC,
	RX_REQ_ARA_11_PRC,
	RX_REQ_ARA_10_PRC,
	RX_REQ_ARA_9_PRC,
	RX_REQ_ARA_8_PRC,
	RX_REQ_ARA_7_PRC,
	RI_LTR_OPT_ENC_PRC,
	RN_ARR_PAR_PRC,
	OnEcorr, --endr info
	CreatedAt
)

SELECT DISTINCT
	ENDR.DF_SPE_ACC_ID,
	BorrLT20.DF_SPE_ACC_ID,
	BorrLt20.RM_APL_PGM_PRC,
	BorrLt20.RT_RUN_SRT_DTS_PRC,
	BorrLt20.RN_SEQ_LTR_CRT_PRC,
	BorrLt20.RN_SEQ_REC_PRC,
	BorrLt20.RM_DSC_LTR_PRC,
	BorrLt20.RC_TYP_SBJ_PRC,
	BorrLt20.RF_SBJ_PRC,
	BorrLt20.RN_ENT_REQ_PRC,
	BorrLt20.RN_ATY_SEQ_PRC,
	BorrLt20.RI_REC_PRC,
	BorrLt20.RX_REQ_ARA_1_PRC,
	BorrLt20.RX_REQ_ARA_2_PRC,
	BorrLt20.RX_REQ_ARA_3_PRC,
	BorrLt20.RX_REQ_ARA_4_PRC,
	BorrLt20.RX_REQ_ARA_5_PRC,
	BorrLt20.RX_REQ_ARA_6_PRC,
	BorrLt20.RI_LTR_REQ_DEL_PRC,
	BorrLt20.RC_LTR_REQ_SRC_PRC,
	BorrLt20.RI_PRV_RUN_ERR_PRC,
	BorrLt20.RF_LST_DTS_LT20,
	BorrLt20.RF_COR_DOC_PRC,
	BorrLt20.RX_REQ_ARA_16_PRC,
	BorrLt20.RX_REQ_ARA_15_PRC,
	BorrLt20.RX_REQ_ARA_14_PRC,
	BorrLt20.RX_REQ_ARA_13_PRC,
	BorrLt20.RX_REQ_ARA_12_PRC,
	BorrLt20.RX_REQ_ARA_11_PRC,
	BorrLt20.RX_REQ_ARA_10_PRC,
	BorrLt20.RX_REQ_ARA_9_PRC,
	BorrLt20.RX_REQ_ARA_8_PRC,
	BorrLt20.RX_REQ_ARA_7_PRC,
	BorrLt20.RI_LTR_OPT_ENC_PRC,
	BorrLt20.RN_ARR_PAR_PRC,
	CASE WHEN PH05.DF_SPE_ID IS NOT NULL THEN 1 ELSE 0 END AS OnEcorr,
	GETDATE() AS CreatedAt
FROM
	LT20_LTR_REQ_PRC BorrLt20
	INNER JOIN AC11_ACT_REQ_LTR AC11
		ON AC11.PF_LTR = BorrLt20.RM_DSC_LTR_PRC
	INNER JOIN PD10_PRS_NME Borr
		ON Borr.DF_SPE_ACC_ID = BorrLt20.DF_SPE_ACC_ID
	INNER JOIN 
	(
		SELECT
			LN85.BF_SSN,
			LN85.LN_SEQ,
			AY10.PF_REQ_ACT
		FROM
			LN85_LON_ATY LN85
			INNER JOIN --GETS THE MOST RECENT ARC LEFT ON THE BORROWERS ACCOUNT TO GET THE LOAN SEQ'S THE LETTER APPLIES TO
			(
				SELECT
					AY10.BF_SSN,
					AY10.PF_REQ_ACT,
					MAX(AY10.LN_ATY_SEQ) AS LN_ATY_SEQ,
					MAX(AY10.LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
				FROM 
					AY10_BR_LON_ATY AY10
				GROUP BY
					AY10.BF_SSN,
					AY10.PF_REQ_ACT
			)AY10
				ON AY10.BF_SSN = LN85.BF_SSN
				AND AY10.LN_ATY_SEQ = LN85.LN_ATY_SEQ
	) LN85
		ON LN85.BF_SSN = Borr.DF_PRS_ID
		AND LN85.PF_REQ_ACT = AC11.PF_REQ_ACT
	INNER JOIN LN20_EDS LN20
		ON LN20.BF_SSN = LN85.BF_SSN
		AND LN20.LN_SEQ = LN85.LN_SEQ
		AND LN20.LC_EDS_TYP = 'M'
		AND LN20.LC_STA_LON20 = 'A'
	INNER JOIN PD10_PRS_NME ENDR
		ON ENDR.DF_PRS_ID = LN20.LF_EDS
	LEFT JOIN PH05_CNC_EML PH05
		ON ENDR.DF_SPE_ACC_ID = PH05.DF_SPE_ID
		AND PH05.DI_CNC_ELT_OPI = 'Y'
		AND DI_VLD_CNC_EML_ADR = 'Y'
	LEFT JOIN LT20_LTR_REQ_PRC_Coborrower EndrLt20
		ON EndrLt20.DF_SPE_ACC_ID = ENDR.DF_SPE_ACC_ID
		AND EndrLt20.RM_APL_PGM_PRC = BorrLt20.RM_APL_PGM_PRC
		AND EndrLt20.RT_RUN_SRT_DTS_PRC = BorrLt20.RT_RUN_SRT_DTS_PRC
		AND EndrLt20.RN_SEQ_LTR_CRT_PRC = BorrLt20.RN_SEQ_LTR_CRT_PRC
		AND EndrLt20.RN_SEQ_REC_PRC = BorrLt20.RN_SEQ_REC_PRC
		AND EndrLt20.RM_DSC_LTR_PRC = BorrLt20.RM_DSC_LTR_PRC
		AND EndrLt20.OnEcorr = CASE WHEN PH05.DF_SPE_ID IS NOT NULL THEN 1 ELSE 0 END
WHERE
	EndrLt20.DF_SPE_ACC_ID IS NULL
	AND
	(	
		(
			BorrLt20.InactivatedAt IS NULL
			AND
			(
				(
					BorrLt20.PrintedAt IS NULL
					AND BorrLt20.OnEcorr = 0
				)
				OR
				(
					BorrLt20.EcorrDocumentCreatedAt IS NULL
				)
			)
		)
	)
	AND BorrLt20.RM_DSC_LTR_PRC = @LetterId

SELECT @@ROWCOUNT