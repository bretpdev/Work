/*INPUT*/
FILENAME COD_FILE "x:\padd\ftp\test\lcaf.script7*";
FILENAME GLFIL "X:\PADD\FTP\Test\COD GL Summary from Script 6.txt";

/*OUTPUT*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/Daily COD Internal System Balancing - FED.R2.script7";
FILENAME REPORT3 "&RPTLIB/Daily COD Internal System Balancing - FED.R3";

DATA GL(DROP=HEAD) ;
	INFILE GLFIL DSD DLM = ',' MISSOVER end = eof;
	INPUT HEAD $ 1 @;
	IF HEAD= 'D' THEN DO;
		INPUT LOAN_PROGRAM $ 2-4 FILE_TC $ 11-16 AMOUNT_TYPE $ 25-54 AMOUNT 55-69 
			CREDIT_REFORM_CODE $ 106-111 TRANSACTIONAL_IDENTIFIER $ 118-133 ;
		if FILE_TC = 'COLCON' THEN OUTPUT;
/*			OUTPUT;*/
	END;
	INFORMAT AMOUNT 15.2;
	FORMAT AMOUNT COMMA15.2;
RUN;

PROC SORT DATA=GL; BY AMOUNT_TYPE; RUN;

DATA CODFISH(KEEP=SSN AWARDID PAYOFFAMOUNT UNEARNEDREBATEAMOUNT);
	INFILE COD_FILE DSD DLM = '<>' FIRSTOBS=1 MISSOVER END = EOF;
	FORMAT SSN $9. AWARDID $21. PAYOFFAMOUNT 10.2 UNEARNEDREBATEAMOUNT 10.2;
	INPUT  @'<' LABEL :$30. VALUE :$40.;
	RETAIN SSN AWARDID PAYOFFAMOUNT UNEARNEDREBATEAMOUNT include;
	IF LABEL = 'SSN' THEN do;
		SSN = VALUE;
		include = 1;
	end;
	ELSE IF LABEL = 'AwardID' THEN AwardID = VALUE;
	ELSE IF LABEL = 'PayoffAmount' THEN PayoffAmount = INPUT(VALUE,10.2);
	ELSE IF LABEL = 'UnearnedRebateAmount' THEN UnearnedRebateAmount = INPUT(VALUE,10.2);
	if label = 'PayoffType' and value = 'Close Out' then include = 0;
	IF LABEL = '/UnderlyingAward' and include = 1 THEN OUTPUT;
RUN;

PROC SORT DATA=CODFISH; BY SSN AwardID; RUN;

PROC SQL;
CREATE TABLE COD_SUM AS
SELECT COUNT(DISTINCT SSN) AS BOR_CT 
	,COUNT(DISTINCT AWARDID) AS LON_CT 
	,coalesce(SUM(PayoffAmount),0) AS PAY_AMT 
	,coalesce(SUM(UnearnedRebateAmount),0) AS RBT_AMT 
FROM CODFISH ;
QUIT;
PROC PRINTTO PRINT=REPORT2 NEW;
RUN;
/*FOR LANDSCAPE REPORTS:*/
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 NONUMBER NODATE;
/*FOR PORTRAIT REPORTS;*/
OPTIONS ORIENTATION = PORTRAIT;
OPTIONS PS=52 LS=96;
TITLE 'CornerStone - Daily COD Balancing - COD Received Activity';
TITLE2	"%SYSFUNC(TODAY(),WORDDATE.)";

PROC PRINT NOOBS SPLIT='/' DATA=CODFISH WIDTH=UNIFORM WIDTH=MIN LABEL SPLIT='/';
VAR SSN AWARDID PAYOFFAMOUNT UNEARNEDREBATEAMOUNT;
FORMAT PAYOFFAMOUNT UNEARNEDREBATEAMOUNT DOLLAR12.2;
LABEL AWARDID = 'LOAN ID'
	PAYOFFAMOUNT = 'PAYOFF AMOUNT/RECEIVED'
	UNEARNEDREBATEAMOUNT = 'REBATE AMOUNT/RECEIVED';
RUN;

TITLE ;
TITLE2 'CornerStone - Daily COD Balancing - COD Received Activity';
TITLE3	"%SYSFUNC(TODAY(),WORDDATE.)";

PROC PRINT NOOBS SPLIT='/' DATA=COD_SUM WIDTH=UNIFORM WIDTH=MIN LABEL SPLIT='/';
VAR BOR_CT LON_CT PAY_AMT RBT_AMT;
FORMAT BOR_CT LON_CT COMMA.;
FORMAT PAY_AMT RBT_AMT DOLLAR12.2;
LABEL BOR_CT = 'TOTAL NUMBER/OF BORROWERS'
	LON_CT = 'TOTAL NUMBER/OF LOANS'
	PAY_AMT = 'TOTAL PAYOFF/AMOUNT RECEIVED'
	RBT_AMT = 'TOTAL REBATE/AMOUNT RECEIVED';
RUN;

PROC PRINTTO;
RUN;
PROC PRINTTO PRINT=REPORT3 NEW;
RUN;
/*FOR LANDSCAPE REPORTS:*/
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127;
/*FOR PORTRAIT REPORTS;*/
OPTIONS ORIENTATION = PORTRAIT;
OPTIONS PS=52 LS=96;
TITLE 'CornerStone - Daily COD Balancing - GL Summary COLCON Activity';
TITLE2	"%SYSFUNC(TODAY(),WORDDATE.)";

PROC PRINT NOOBS SPLIT='/' DATA=GL n='NUMBER OF RECORDS FOR AMOUNT TYPE: ' 'TOTAL NUMBER OF RECORDS: ' WIDTH=UNIFORM WIDTH=MIN LABEL SUMLABEL SPLIT='/';
BY AMOUNT_TYPE;
FORMAT AMOUNT DOLLAR18.2;
VAR LOAN_PROGRAM FILE_TC AMOUNT_TYPE AMOUNT CREDIT_REFORM_CODE TRANSACTIONAL_IDENTIFIER;
SUM AMOUNT;
LABEL LOAN_PROGRAM = 'LOAN PROGRAM'
	FILE_TC = 'FMS TRANSACTION CODE'
	AMOUNT_TYPE = 'AMOUNT TYPE'
	AMOUNT = 'AMOUNT'
	CREDIT_REFORM_CODE = 'CRC CODE'
	TRANSACTIONAL_IDENTIFIER = 'TRANSACTION ID';
RUN;

PROC PRINTTO;
RUN;
