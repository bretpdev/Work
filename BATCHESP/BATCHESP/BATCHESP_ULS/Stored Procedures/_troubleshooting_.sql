--null DF10's weeded out by ln50
SELECT * FROM OPENQUERY (QADBD004,'
SELECT 
	 DF10.BF_SSN
	,DF10.LD_DFR_INF_CER
	,LN50.LD_DFR_BEG
	,LN50.LD_DFR_END
FROM 
	OLWHRM1.WQ20_TSK_QUE WQ20
	INNER JOIN OLWHRM1.LN10_LON LN10
		ON LN10.BF_SSN = WQ20.BF_SSN
	INNER JOIN OLWHRM1.LN50_BR_DFR_APV LN50
		ON LN10.BF_SSN = LN50.BF_SSN
		AND LN10.LN_SEQ = LN50.LN_SEQ
	INNER JOIN OLWHRM1.DF10_BR_DFR_REQ DF10
		ON LN50.BF_SSN = DF10.BF_SSN
		AND LN50.LF_DFR_CTL_NUM = DF10.LF_DFR_CTL_NUM
WHERE
	DF10.LD_DFR_INF_CER IS NULL

	AND WQ20.WF_QUE = ''RB''
	AND WQ20.WF_SUB_QUE IN (''01'', ''02'', ''05'', ''08'', ''10'', ''11'')
	AND WQ20.WC_STA_WQUE20 NOT IN (''X'', ''C'', ''P'', ''H'', ''A'')
	AND (
			WQ20.WX_MSG_1_TSK LIKE ''POSSIBLE UPDATE REQUIRED-PULL NSLDS FOR ADDITIONAL INFO%''
			OR WQ20.WX_MSG_1_TSK LIKE ''DIFFERENT SCHOOLS - POSSIBLE SEP DATE CHANGE%''
			OR WQ20.WX_MSG_1_TSK LIKE ''DEFER SCHOOL NOT EQUAL INCOMING SCHOOL/REVIEW DEFER%''
			OR WQ20.WX_MSG_1_TSK LIKE ''EQUAL OR NEWER CERT EXISTS FOR INCOMING SCHL - REVIEW DEFER DATES%''
			OR WQ20.WX_MSG_1_TSK LIKE ''REPURCHASED OR REHABILITATED LOAN-MANUAL REVIEW REQUIRED%'' --NONE IN FED
							)
	AND DF10.LC_DFR_STA = ''A''
	AND DF10.LC_STA_DFR10 = ''A''
	AND LN50.LC_STA_LON50 = ''A''
	AND DF10.LC_DFR_TYP IN (''15'',''16'',''18'')

	--AND DAYS(LN50.LD_DFR_BEG) < DAYS(CURRENT DATE)
	--AND DAYS(LN50.LD_DFR_END) > DAYS(CURRENT DATE)
')
ORDER BY
	LD_DFR_BEG DESC, LD_DFR_END DESC

SELECT * FROM OPENQUERY (LEGEND_TEST_VUK3,'
SELECT 
	 DF10.BF_SSN
	,DF10.LD_DFR_INF_CER
	,LN50.LD_DFR_BEG
	,LN50.LD_DFR_END
FROM 
	PKUB.WQ20_TSK_QUE WQ20
	INNER JOIN PKUB.LN10_LON LN10
		ON LN10.BF_SSN = WQ20.BF_SSN
	INNER JOIN PKUB.LN50_BR_DFR_APV LN50
		ON LN10.BF_SSN = LN50.BF_SSN
		AND LN10.LN_SEQ = LN50.LN_SEQ
	INNER JOIN PKUB.DF10_BR_DFR_REQ DF10
		ON LN50.BF_SSN = DF10.BF_SSN
		AND LN50.LF_DFR_CTL_NUM = DF10.LF_DFR_CTL_NUM
WHERE
	DF10.LD_DFR_INF_CER IS NULL

	AND WQ20.WF_QUE = ''RB''
	AND WQ20.WF_SUB_QUE IN (''01'', ''02'', ''05'', ''08'', ''10'', ''11'')
	AND WQ20.WC_STA_WQUE20 NOT IN (''X'', ''C'', ''P'', ''H'', ''A'')
	AND (
			WQ20.WX_MSG_1_TSK LIKE ''POSSIBLE UPDATE REQUIRED-PULL NSLDS FOR ADDITIONAL INFO%''
			OR WQ20.WX_MSG_1_TSK LIKE ''DIFFERENT SCHOOLS - POSSIBLE SEP DATE CHANGE%''
			OR WQ20.WX_MSG_1_TSK LIKE ''DEFER SCHOOL NOT EQUAL INCOMING SCHOOL/REVIEW DEFER%''
			OR WQ20.WX_MSG_1_TSK LIKE ''EQUAL OR NEWER CERT EXISTS FOR INCOMING SCHL - REVIEW DEFER DATES%''
			OR WQ20.WX_MSG_1_TSK LIKE ''REPURCHASED OR REHABILITATED LOAN-MANUAL REVIEW REQUIRED%'' --NONE IN FED
							)
	AND DF10.LC_DFR_STA = ''A''
	AND DF10.LC_STA_DFR10 = ''A''
	AND LN50.LC_STA_LON50 = ''A''
	AND DF10.LC_DFR_TYP IN (''15'',''16'',''18'')

	--AND DAYS(LN50.LD_DFR_BEG) < DAYS(CURRENT DATE)
	--AND DAYS(LN50.LD_DFR_END) > DAYS(CURRENT DATE)
')
ORDER BY
	LD_DFR_BEG DESC, LD_DFR_END DESC










----Conor: 521 
----Savanna: 683


--/*************FED DATA:  CLS.BatchESP.TSAYDefermentForbearances*********************/

--DECLARE @Server VARCHAR(20)
--IF @@SERVERNAME = 'OPSDEV' SET @Server = 'LEGEND_TEST_VUK3'
--ELSE SET @Server = 'LEGEND'

--DECLARE @LASTRUN_TSAYDF_CLS VARCHAR(30) = '2016-9-28'

--CREATE TABLE #CLS_TSAYDefermentForbearances
--(
--	 BorrowerSSN		CHAR(9)
--	,LoanSequence		SMALLINT
--	,[Type]				VARCHAR(9)
--	,BeginDate			DATE
--	,EndDate			DATE
--	,CertificationDate	DATE
--	,DeferSchool		VARCHAR(8) --NEW FIELD
--	--,UpdatedAt			DATETIME
--);

--DECLARE @SQLStatement VARCHAR(MAX) =
----SET @SQLStatement = 
--'
--	INSERT INTO
--		#CLS_TSAYDefermentForbearances
--	SELECT DISTINCT
--		TSAY.*
--	FROM 
--		OPENQUERY
--		(
--			' + @Server + ',
--			''
--				SELECT
--					 LN10.BF_SSN AS BorrowerSSN
--					,LN10.LN_SEQ AS LoanSequence
--					,CONCAT(''''D'''',DF10.LC_DFR_TYP) AS Type
--					,COALESCE(LN50.LD_DFR_BEG,''''9999-12-31'''') AS BeginDate
--					,COALESCE(LN50.LD_DFR_END,''''9999-12-31'''') AS EndDate
--					,COALESCE(DF10.LD_DFR_INF_CER, LN50.LD_DFR_APL) AS CertificationDate
--					,DF10.LF_DOE_SCL_DFR  AS DeferSchool
--					--,WQ20.WF_LST_DTS_WQ20 AS UpdatedAt
--				FROM
--					PKUB.WQ20_TSK_QUE WQ20
--					INNER JOIN PKUB.LN10_LON LN10
--						ON LN10.BF_SSN = WQ20.BF_SSN
--					INNER JOIN PKUB.LN50_BR_DFR_APV LN50
--						ON LN10.BF_SSN = LN50.BF_SSN
--						AND LN10.LN_SEQ = LN50.LN_SEQ
--					INNER JOIN PKUB.DF10_BR_DFR_REQ DF10
--						ON LN50.BF_SSN = DF10.BF_SSN
--						AND LN50.LF_DFR_CTL_NUM = DF10.LF_DFR_CTL_NUM	
--				WHERE
--					WQ20.WF_QUE = ''''RB''''
--					AND WQ20.WF_SUB_QUE IN (''''01'''', ''''02'''', ''''05'''', ''''08'''', ''''10'''', ''''11'''')
--					AND WQ20.WC_STA_WQUE20 NOT IN (''''X'''', ''''C'''', ''''P'''', ''''H'''', ''''A'''')
--					AND (
--							WQ20.WX_MSG_1_TSK LIKE ''''POSSIBLE UPDATE REQUIRED-PULL NSLDS FOR ADDITIONAL INFO%''''
--							OR WQ20.WX_MSG_1_TSK LIKE ''''DIFFERENT SCHOOLS - POSSIBLE SEP DATE CHANGE%''''
--							OR WQ20.WX_MSG_1_TSK LIKE ''''DEFER SCHOOL NOT EQUAL INCOMING SCHOOL/REVIEW DEFER%''''
--							OR WQ20.WX_MSG_1_TSK LIKE ''''EQUAL OR NEWER CERT EXISTS FOR INCOMING SCHL - REVIEW DEFER DATES%''''
--							OR WQ20.WX_MSG_1_TSK LIKE ''''REPURCHASED OR REHABILITATED LOAN-MANUAL REVIEW REQUIRED%'''' --NONE IN FED
--						)
--					AND DF10.LC_DFR_STA = ''''A''''
--					AND DF10.LC_STA_DFR10 = ''''A''''
--					AND LN50.LC_STA_LON50 = ''''A''''
--					AND DF10.LC_DFR_TYP IN (''''15'''', ''''16'''', ''''18'''')
--					AND DAYS(LN50.LD_DFR_BEG) < DAYS(CURRENT DATE)
--					AND DAYS(LN50.LD_DFR_END) > DAYS(CURRENT DATE)
--					AND WQ20.WF_LST_DTS_WQ20 > ''''' + @LASTRUN_TSAYDF_CLS + '''''
--			''
--		) TSAY
--'
--;

--SELECT ('Query length: ' + CAST(LEN(@SQLStatement) AS VARCHAR(5))) AS TSAYDF_CLS
--PRINT 'TSAYDF_CLS Query:'
--PRINT @SQLStatement
--EXEC (@SQLStatement)
--SELECT * FROM #CLS_TSAYDefermentForbearances
--ORDER BY BorrowerSSN, LoanSequence
----DROP TABLE #CLS_TSAYDefermentForbearances
--;







/*************COM DATA:  ULS.BatchESP.TSAY_DefermentForbearances*********************/

DECLARE @Server VARCHAR(20)
IF @@SERVERNAME = 'OPSDEV' SET @Server = 'QADBD004'
ELSE SET @Server = 'DUSTER'

DECLARE @LASTRUN_TSAYDF_ULS VARCHAR(30) = '2016-9-28'

CREATE TABLE #ULS_TSAYDefermentForbearances
(
	 BorrowerSSN		CHAR(9)
	,LoanSequence		SMALLINT
	,[Type]				VARCHAR(9)
	,BeginDate			DATE
	,EndDate			DATE
	,CertificationDate	DATE
	,DeferSchool		VARCHAR(8) --NEW FIELD
	--,UpdatedAt			DATETIME
);

DECLARE @SQLStatement VARCHAR(MAX) =
--SET @SQLStatement = 
'
	INSERT INTO
		#ULS_TSAYDefermentForbearances
	SELECT DISTINCT
		TSAY.*
	FROM 
		OPENQUERY
		(
			' + @Server + ',
			''
				SELECT
					 LN10.BF_SSN AS BorrowerSSN
					,LN10.LN_SEQ AS LoanSequence
					,CONCAT(''''D'''',DF10.LC_DFR_TYP) AS Type
					,COALESCE(LN50.LD_DFR_BEG,''''9999-12-31'''') AS BeginDate
					,COALESCE(LN50.LD_DFR_END,''''9999-12-31'''') AS EndDate
					,COALESCE(DF10.LD_DFR_INF_CER, LN50.LD_DFR_APL) AS CertificationDate
					,DF10.LF_DOE_SCL_DFR  AS DeferSchool
					--,WQ20.WF_LST_DTS_WQ20 AS UpdatedAt
				FROM
					OLWHRM1.WQ20_TSK_QUE WQ20
					INNER JOIN OLWHRM1.LN10_LON LN10
						ON LN10.BF_SSN = WQ20.BF_SSN
					INNER JOIN OLWHRM1.LN50_BR_DFR_APV LN50
						ON LN10.BF_SSN = LN50.BF_SSN
						AND LN10.LN_SEQ = LN50.LN_SEQ
					INNER JOIN OLWHRM1.DF10_BR_DFR_REQ DF10
						ON LN50.BF_SSN = DF10.BF_SSN
						AND LN50.LF_DFR_CTL_NUM = DF10.LF_DFR_CTL_NUM
					LEFT JOIN OLWHRM1.PD01_PDM_INF PD01
						ON WQ20.BF_SSN = PD01.DF_PRS_ID
				WHERE
					PD01.DF_PRS_ID IS NULL
					AND WQ20.WF_QUE = ''''RB''''
					AND WQ20.WF_SUB_QUE IN (''''01'''', ''''02'''', ''''05'''', ''''08'''', ''''10'''', ''''11'''')
					AND WQ20.WC_STA_WQUE20 NOT IN (''''X'''', ''''C'''', ''''P'''', ''''H'''', ''''A'''')
					AND (
							WQ20.WX_MSG_1_TSK LIKE ''''POSSIBLE UPDATE REQUIRED-PULL NSLDS FOR ADDITIONAL INFO%''''
							OR WQ20.WX_MSG_1_TSK LIKE ''''DIFFERENT SCHOOLS - POSSIBLE SEP DATE CHANGE%''''
							OR WQ20.WX_MSG_1_TSK LIKE ''''DEFER SCHOOL NOT EQUAL INCOMING SCHOOL/REVIEW DEFER%''''
							OR WQ20.WX_MSG_1_TSK LIKE ''''EQUAL OR NEWER CERT EXISTS FOR INCOMING SCHL - REVIEW DEFER DATES%''''
							OR WQ20.WX_MSG_1_TSK LIKE ''''REPURCHASED OR REHABILITATED LOAN-MANUAL REVIEW REQUIRED%'''' --NONE IN FED
						)
					AND DF10.LC_DFR_STA = ''''A''''
					AND DF10.LC_STA_DFR10 = ''''A''''
					AND LN50.LC_STA_LON50 = ''''A''''
					AND DF10.LC_DFR_TYP IN (''''15'''', ''''16'''', ''''18'''')
					AND DAYS(LN50.LD_DFR_BEG) < DAYS(CURRENT DATE)
					AND DAYS(LN50.LD_DFR_END) > DAYS(CURRENT DATE)
					AND WQ20.WF_LST_DTS_WQ20 > ''''' + @LASTRUN_TSAYDF_ULS + '''''
			''
		) TSAY

left join CSYS.dbo._PD01_PDM_INF pd01 --for test only
on tsay.BorrowerSSN = pd01.df_prs_id --for test only
where pd01.df_prs_id is null --for test only
'
;

SELECT ('Query length: ' + CAST(LEN(@SQLStatement) AS VARCHAR(5))) AS TSAYDF_ULS
PRINT 'TSAYDF_ULS Query:'
PRINT @SQLStatement
EXEC (@SQLStatement)
SELECT * FROM #ULS_TSAYDefermentForbearances
ORDER BY BorrowerSSN, LoanSequence
--DROP TABLE #ULS_TSAYDefermentForbearances
;