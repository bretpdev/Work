/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
/*%LET TBLLIB = /sas/whse/progrevw;*/
%LET RPTLIB = T:\SAS;
%LET TBLLIB = Q:\Process Automation\TabSAS;

FILENAME REPORTZ "&RPTLIB/ULWK37.LWK37RZ";
FILENAME REPORT2 "&RPTLIB/ULWK37.LWK37R2";
FILENAME REPORT3 "&RPTLIB/ULWK37.LWK37R3";
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
DATA _NULL_;
    EFFDT = TODAY();
    CALL SYMPUT('BEGIN',"'"||PUT(INTNX('MONTH',TODAY(),-1,'BEGINNING'), MMDDYYD10.)||"'");
    CALL SYMPUT('END',"'"||PUT(INTNX('MONTH',TODAY(),-1,'END'), MMDDYYD10.)||"'");
    CALL SYMPUT('EFFDATE',put(EFFDT,MMDDYY10.));
    CALL SYMPUT('RUNDATE',"'"||put(EFFDT,MMDDYY10.)||"'");
RUN;
DATA LOAN_TYPES;
    FORMAT LN_TYP LN_PGM $50.;
    INFILE "&TBLLIB/GENR_REF_LoanTypes.txt" DLM=',' MISSOVER DSD;
    INFORMAT LN_TYP LN_PGM $50.;
    INPUT LN_TYP LN_PGM ;
    LN_PGM = UPCASE(LN_PGM);
RUN;
PROC SQL NOPRINT;
    SELECT "'"||TRIM(LN_TYP)||"'"
        INTO :PRIVATE_LIST SEPARATED BY "," /*PRIVATE LOAN LIST*/
    FROM LOAN_TYPES
    WHERE LN_PGM ^= 'FFEL';
QUIT;
%SYSLPUT BEGIN = &BEGIN;
%SYSLPUT END = &END;
%SYSLPUT PRIVATE_LIST = &PRIVATE_LIST;
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
%MACRO SQLCHECK ;
  %IF  &SQLXRC NE 0  %THEN  %DO  ;
    DATA _NULL_  ;
            FILE REPORTZ NOTITLES  ;
            PUT @01 " ********************************************************************* "
              / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
              / @01 " ****  THE SAS SHOULD BE REVIEWED.                                **** "
              / @01 " ********************************************************************* "
              / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
              / @01 " ****  &SQLXMSG   **** "
              / @01 " ********************************************************************* "
            ;
         RUN  ;
  %END  ;
%MEND  ;
*ONE LINK PORTION;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE ONEKUBA AS
    SELECT *
    FROM CONNECTION TO DB2 (
        SELECT DISTINCT A.BF_LST_USR_AY01 AS USERID
            ,B.DF_SPE_ACC_ID
        FROM    OLWHRM1.AY01_BR_ATY A
            LEFT JOIN
                OLWHRM1.BR03_BR_REF C
            ON C.DF_PRS_ID_RFR = A.DF_PRS_ID
            LEFT JOIN
                OLWHRM1.PD01_PDM_INF B
            ON C.DF_PRS_ID_BR = B.DF_PRS_ID
        WHERE   A.PF_ACT = 'KUBA4'
            AND A.BD_ATY_PRF BETWEEN &BEGIN AND &END
FOR READ ONLY WITH UR
);
*COMPASS PORTION;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE COMKUBA AS
    SELECT *
    FROM CONNECTION TO DB2 (
        SELECT DISTINCT A.LF_USR_REQ_ATY AS USERID
            ,B.DF_SPE_ACC_ID
        FROM OLWHRM1.AY10_BR_LON_ATY A
		INNER JOIN OLWHRM1.PD10_PRS_NME B
			ON A.BF_SSN =B.DF_PRS_ID
		INNER JOIN OLWHRM1.MR01_MGT_RPT_LON C
			ON A.BF_SSN = C.BF_SSN
         WHERE (C.IC_LON_PGM = 'TILP' OR C.IC_LON_PGM IN (&PRIVATE_LIST)) 
            AND A.LD_ATY_REQ_RCV BETWEEN &BEGIN AND &END
            AND	A.PF_REQ_ACT = 'KUBA4'  
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;

/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>> ;  ** INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK;*/
/*QUIT;*/

ENDRSUBMIT;
DATA ONEKUBA;SET WORKLOCL.ONEKUBA;RUN;
DATA COMKUBA;SET WORKLOCL.COMKUBA;RUN;

OPTIONS ORIENTATION = LANDSCAPE NOBYLINE;
OPTIONS PS=39 LS=127 ;
TITLE;
FOOTNOTE;
%MACRO REPO(SET, NUM);
OPTIONS PAGENO=1;
PROC SORT DATA=&SET;
    BY USERID DF_SPE_ACC_ID;
RUN;
PROC PRINTTO PRINT=REPORT&NUM NEW;
RUN;

PROC CONTENTS DATA=&SET OUT=EMPTYSET NOPRINT;
DATA _NULL_;
SET EMPTYSET;
FILE PRINT;
IF  NOBS=0 AND _N_ =1 THEN DO;
    PUT // 132*'-';
    PUT      //////
        @51 '**** NO OBSERVATIONS FOUND ****';
    PUT //////
        @57 '-- END OF REPORT --';
    PUT //////////////
        @46 "JOB = UTLWK37       REPORT = ULWK37.LWK37R&NUM";
    END;
RETURN;
RUN;

PROC PRINT NOOBS SPLIT='/' DATA=&SET WIDTH=UNIFORM WIDTH=MIN LABEL SUMLABEL
    n='Total for Month: '
    'Grand Total for Month: ';
    VAR USERID DF_SPE_ACC_ID;
    BY USERID;
	SUMBY USERID;
    LABEL USERID = 'USER ID'
        DF_SPE_ACC_ID = 'Account #';
RUN;
%MEND;
%REPO(ONEKUBA, 2);
%REPO(COMKUBA, 3);
PROC PRINTTO;
RUN;
