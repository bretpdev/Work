/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;
%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWP02.LWP02R2";

LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
options symbolgen;
DATA _NULL_;		/*GETS THE PREVIOUS DAY*/
	EFFDT = TODAY() - 2;
/*	EFFDT = '16OCT2007'D;*/
    CALL SYMPUT('EFFDATE',put(EFFDT,MMDDYY10.));
	CALL SYMPUT('RUNDATE',"'"||put(EFFDT,MMDDYY10.)||"'");
RUN;
%SYSLPUT RUNDATE = &RUNDATE;	
RSUBMIT;

%macro sqlcheck ;
  %if  &sqlxrc ne 0  %then  %do  ;
    data _null_  ;
            file reportz notitles  ;
            put @01 " ********************************************************************* "
              / @01 " ****  The SQL code above has experienced an error.               **** "
              / @01 " ****  The SAS should be reviewed.                                **** "       
              / @01 " ********************************************************************* "
              / @01 " ****  The SQL error code is  &sqlxrc  and the SQL error message  **** "
              / @01 " ****  &sqlxmsg   **** "
              / @01 " ********************************************************************* "
            ;
         run  ;
  %end  ;
%mend  ;

PROC SQL STIMER;
/*ONELINK*/
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE DEMOO AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT B.DF_PRS_ID_BR AS SSN
	,D.DF_SPE_ACC_ID AS ACCT
	,D.DF_USR_UPD_ADR AS USERID
	,D.DM_PRS_LST AS LASTNAME
	,E.BD_ATY_PRF AS ACT_DT
FROM OLWHRM1.GA10_LON_APP A 
INNER JOIN OLWHRM1.GA01_APP B
	ON A.AF_APL_ID = B.AF_APL_ID
INNER JOIN OLWHRM1.PD01_PDM_INF D
	ON D.DF_PRS_ID = B.DF_PRS_ID_BR
INNER JOIN OLWHRM1.AY01_BR_ATY E
	ON B.DF_PRS_ID_BR = E.DF_PRS_ID
WHERE A.AC_PRC_STA = 'A'
AND (D.DD_LST_UPD_ADR >= &RUNDATE)
AND D.DF_USR_UPD_ADR LIKE 'UT%'
AND NOT EXISTS (SELECT 
				DF_PRS_ID
				FROM OLWHRM1.AY01_BR_ATY 
				WHERE BD_ATY_PRF >= &RUNDATE
				AND DF_PRS_ID = B.DF_PRS_ID_BR
				AND BF_LST_USR_AY01 = D.DF_USR_UPD_ADR)
AND NOT EXISTS (SELECT *
			FROM OLWHRM1.GA10_LON_APP ZZ
			INNER JOIN OLWHRM1.GA01_APP YY
				ON ZZ.AF_APL_ID = YY.AF_APL_ID
			WHERE YY.DF_PRS_ID_BR = B.DF_PRS_ID_BR
			AND ZZ.AC_PRC_STA <> 'A'
			AND YY.DF_PRS_ID_BR NOT IN (SELECT YYY.DF_PRS_ID_BR
							FROM OLWHRM1.GA10_LON_APP ZZZ
							INNER JOIN OLWHRM1.GA01_APP YYY
								ON ZZZ.AF_APL_ID = YYY.AF_APL_ID
							WHERE YYY.DF_PRS_ID_BR = YY.DF_PRS_ID_BR
							AND ZZZ.AC_PRC_STA = 'A'
							AND ZZZ.AA_CUR_PRI > 0
							)
			)
UNION
SELECT
	DISTINCT
	B.DF_PRS_ID_BR AS SSN	
	,D.DF_SPE_ACC_ID AS ACCT
	,D.DF_USR_UPD_PHN AS USERID
	,D.DM_PRS_LST AS LASTNAME
	,E.BD_ATY_PRF AS ACT_DT
FROM	OLWHRM1.GA10_LON_APP A 
INNER JOIN OLWHRM1.GA01_APP B
ON A.AF_APL_ID = B.AF_APL_ID
INNER JOIN OLWHRM1.PD01_PDM_INF D
ON D.DF_PRS_ID = B.DF_PRS_ID_BR
INNER JOIN OLWHRM1.AY01_BR_ATY E
	ON B.DF_PRS_ID_BR = E.DF_PRS_ID
WHERE A.AC_PRC_STA = 'A'
AND (D.DD_LST_UPD_PHN >= &RUNDATE)
AND D.DF_USR_UPD_PHN LIKE 'UT%'
AND NOT EXISTS (SELECT 
				DF_PRS_ID
				FROM OLWHRM1.AY01_BR_ATY 
				WHERE BD_ATY_PRF >= &RUNDATE
				AND DF_PRS_ID = B.DF_PRS_ID_BR
				AND BF_LST_USR_AY01 = D.DF_USR_UPD_PHN)
AND NOT EXISTS (SELECT *
			FROM OLWHRM1.GA10_LON_APP ZZ
			INNER JOIN OLWHRM1.GA01_APP YY
				ON ZZ.AF_APL_ID = YY.AF_APL_ID
			WHERE YY.DF_PRS_ID_BR = B.DF_PRS_ID_BR
			AND ZZ.AC_PRC_STA <> 'A'
			AND YY.DF_PRS_ID_BR NOT IN (SELECT YYY.DF_PRS_ID_BR
							FROM OLWHRM1.GA10_LON_APP ZZZ
							INNER JOIN OLWHRM1.GA01_APP YYY
								ON ZZZ.AF_APL_ID = YYY.AF_APL_ID
							WHERE YYY.DF_PRS_ID_BR = YY.DF_PRS_ID_BR
							AND ZZZ.AC_PRC_STA = 'A'
							AND ZZZ.AA_CUR_PRI > 0
							)
			)
FOR READ ONLY WITH UR
);

/*COMPASS*/

CREATE TABLE DEMOC AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT 
	DISTINCT
	D.DF_PRS_ID AS SSN
	,D.DF_SPE_ACC_ID AS ACCT
	,D.DM_PRS_LST AS LASTNAME
	,P.DF_LST_USR_PD42 AS USERID
	,Y.LD_ATY_RSP AS ACT_DT
FROM OLWHRM1.GA10_LON_APP W 
INNER JOIN OLWHRM1.GA01_APP X
ON W.AF_APL_ID = X.AF_APL_ID
INNER JOIN OLWHRM1.PD10_PRS_NME D
ON D.DF_PRS_ID = X.DF_PRS_ID_BR
INNER JOIN OLWHRM1.PD42_PRS_PHN P
ON P.DF_PRS_ID = X.DF_PRS_ID_BR
INNER JOIN OLWHRM1.AY10_BR_LON_ATY Y
	ON Y.BF_SSN = D.DF_PRS_ID
AND Y.LF_USR_REQ_ATY = P.DF_LST_USR_PD42 
WHERE W.AC_PRC_STA = 'A'
AND P.DD_PHN_VER >= &RUNDATE
AND P.DF_LST_USR_PD42 LIKE 'UT%'
AND NOT EXISTS (SELECT Y.BF_SSN
				FROM OLWHRM1.AY10_BR_LON_ATY Y
				WHERE (Y.LD_ATY_REQ_RCV >= &RUNDATE
				AND Y.BF_SSN = D.DF_PRS_ID
				AND Y.LF_USR_REQ_ATY = P.DF_LST_USR_PD42)
				OR (Y.LD_ATY_RSP >= &RUNDATE
				AND Y.LF_PRF_BY = P.DF_LST_USR_PD42
				AND Y.BF_SSN = D.DF_PRS_ID)
				)
AND EXISTS 
	(SELECT *
	 FROM OLWHRM1.LN10_LON Z
	 WHERE Z.BF_SSN = X.DF_PRS_ID_BR
	 AND COALESCE(Z.LA_CUR_PRI,0) > 0)

UNION
SELECT 
	DISTINCT
	D.DF_PRS_ID AS SSN
	,D.DF_SPE_ACC_ID AS ACCT
	,D.DM_PRS_LST AS LASTNAME
	,P.DF_LST_USR_PD30 AS USERID
	,Y.LD_ATY_RSP AS ACT_DT
FROM OLWHRM1.GA10_LON_APP W 
INNER JOIN OLWHRM1.GA01_APP X
ON W.AF_APL_ID = X.AF_APL_ID
INNER JOIN OLWHRM1.PD10_PRS_NME D
ON D.DF_PRS_ID = X.DF_PRS_ID_BR
INNER JOIN OLWHRM1.PD30_PRS_ADR P
ON P.DF_PRS_ID = X.DF_PRS_ID_BR
INNER JOIN OLWHRM1.AY10_BR_LON_ATY Y
ON D.DF_PRS_ID = Y.BF_SSN
AND Y.LF_USR_REQ_ATY = P.DF_LST_USR_PD30
WHERE W.AC_PRC_STA = 'A'
AND P.DD_VER_ADR >= &RUNDATE
AND P.DF_LST_USR_PD30 LIKE 'UT%'
AND NOT EXISTS (SELECT Y.BF_SSN
				FROM OLWHRM1.AY10_BR_LON_ATY Y
				WHERE (Y.LD_ATY_REQ_RCV >= &RUNDATE
				AND Y.BF_SSN = D.DF_PRS_ID
				AND Y.LF_USR_REQ_ATY = P.DF_LST_USR_PD30)
				OR (Y.LD_ATY_RSP >= &RUNDATE
				AND Y.LF_PRF_BY = P.DF_LST_USR_PD30
				AND Y.BF_SSN = D.DF_PRS_ID)
				)
AND EXISTS 
	(SELECT *
	 FROM OLWHRM1.LN10_LON Z
	 WHERE Z.BF_SSN = X.DF_PRS_ID_BR
	 AND COALESCE(Z.LA_CUR_PRI,0) > 0)
);

CREATE TABLE OL_EXCLD AS
SELECT *
FROM CONNECTION TO DB2 (
	SELECT DISTINCT DF_PRS_ID_BR AS SSN
	FROM OLWHRM1.GA01_APP 
	WHERE DAYS(AD_APL_RCV) >= DAYS(CURRENT DATE)-2
	or DAYS(AD_APL_CRT) >= DAYS(CURRENT DATE)-2 
UNION
	SELECT DISTINCT BF_SSN AS SSN
	FROM OLWHRM1.LN10_LON  
	WHERE DAYS(LD_LON_1_DSB) >= DAYS(CURRENT DATE)-2
UNION
	SELECT DISTINCT DSB_YST.BF_SSN AS SSN
	FROM (
		SELECT BF_SSN 
			,COUNT(*) AS LN_DSB_CT
		FROM OLWHRM1.LN10_LON
		WHERE DAYS(LD_LON_1_DSB) = DAYS(CURRENT DATE) - 1 
		AND LA_CUR_PRI > 0 
		AND LC_STA_LON10 = 'R'
		GROUP BY BF_SSN
		 ) DSB_YST
	INNER JOIN (
		SELECT BF_SSN
			,COUNT(*) AS LN_CT
		FROM OLWHRM1.LN10_LON
		WHERE LA_CUR_PRI > 0 
		AND LC_STA_LON10 = 'R'
		GROUP BY BF_SSN
		 ) LOANS
		ON DSB_YST.BF_SSN = LOANS.BF_SSN
		AND DSB_YST.LN_DSB_CT = LOANS.LN_CT
	

FOR READ ONLY WITH UR
);
/*This table lists users whose first disbursement was within the last 2 days.  To be excluded.*/
CREATE TABLE ATARASHII AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.BF_SSN AS SSN
FROM OLWHRM1.LN10_LON A
WHERE A.LN_SEQ = 1 
	AND A.LD_LON_1_DSB >= &RUNDATE
FOR READ ONLY WITH UR
);
/*EXCLUDE AAC  This table determines if there are history comments in compass.*/
CREATE TABLE ALL_EXCLD AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT SSN
FROM (SELECT U1.BF_SSN AS SSN
	,CASE 
		WHEN U2.LD_FAT_PST = DATE(PD30.DF_LST_DTS_PD30) OR U2.LD_FAT_PST = DATE(PD42.DF_LST_DTS_PD42)
		THEN U2.LD_FAT_PST 
		WHEN U2.LD_FAT_EFF = DATE(PD30.DF_LST_DTS_PD30) OR U2.LD_FAT_EFF = DATE(PD42.DF_LST_DTS_PD42)
		THEN U2.LD_FAT_EFF 
	END TAR_DT
	FROM OLWHRM1.LN10_LON U1
	INNER JOIN OLWHRM1.LN90_FIN_ATY U2
		ON U1.BF_SSN = U2.BF_SSN
		AND U1.LN_SEQ = U2.LN_SEQ
	INNER JOIN OLWHRM1.PD10_PRS_NME PD10
		ON U1.BF_SSN = PD10.DF_PRS_ID
	INNER JOIN OLWHRM1.PD30_PRS_ADR PD30
		ON PD10.DF_PRS_ID = PD30.DF_PRS_ID
	INNER JOIN OLWHRM1.PD42_PRS_PHN PD42
		ON PD10.DF_PRS_ID = PD42.DF_PRS_ID
	WHERE U2.PC_FAT_TYP = '02'
	AND U2.PC_FAT_SUB_TYP IN ('90','91')
	AND U1.LA_CUR_PRI > 0  
	AND (U2.LD_FAT_PST = DATE(PD30.DF_LST_DTS_PD30)
		OR U2.LD_FAT_PST = DATE(PD42.DF_LST_DTS_PD42)
		OR U2.LD_FAT_EFF = DATE(PD30.DF_LST_DTS_PD30)
		OR U2.LD_FAT_EFF = DATE(PD42.DF_LST_DTS_PD42))
	AND (U2.LD_FAT_PST = &RUNDATE OR U2.LD_FAT_EFF >= &RUNDATE)
	) A
WHERE TAR_DT >= &RUNDATE

FOR READ ONLY WITH UR
);

DISCONNECT FROM DB2;


/*%put  sqlxrc= >>> &sqlxrc <<< ||| sqlxmsg= >>> &sqlxmsg >>> ;  ** includes error messages to SAS log  ;*/
/*%sqlcheck;*/
/*quit;*/

ENDRSUBMIT;
DATA DEMOO;SET WORKLOCL.DEMOO;RUN;
DATA DEMOC;SET WORKLOCL.DEMOC;RUN;
DATA OL_EXCLD;SET WORKLOCL.OL_EXCLD;RUN;
DATA ALL_EXCLD;SET WORKLOCL.ALL_EXCLD;RUN;
DATA ATARASHII;SET WORKLOCL.ATARASHII;RUN;
PROC SORT DATA=OL_EXCLD;BY SSN;RUN;
PROC SORT DATA=DEMOO;BY SSN;RUN;

PROC SQL;
CREATE TABLE DEMO_REPORT AS
	SELECT DISTINCT * 
		FROM DEMOO 
		UNION CORR
	SELECT *
		FROM DEMOC 
		EXCEPT 
	SELECT SSN
		FROM ALL_EXCLD
		EXCEPT
	SELECT SSN
		FROM ATARASHII
		EXCEPT
	SELECT SSN
		FROM OL_EXCLD
ORDER BY USERID, SSN, ACT_DT;
QUIT;
DATA DEMO_REPORT;
SET DEMO_REPORT;
BY USERID SSN ACT_DT;
IF LAST.USERID AND LAST.SSN AND LAST.ACT_DT;
RUN;

DATA _NULL_;
SET DEMO_REPORT ;
LENGTH DESCRIPTION $600.;
USER = USERID ;
DESCRIPTION = CATX(',',
	ACCT
	,LASTNAME
);
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
FORMAT USER $10. ;
FORMAT ACT_DT MMDDYY10. ;
FORMAT DESCRIPTION $600. ;
IF _N_ = 1 THEN DO;
	PUT "USER,ACT_DT,DESCRIPTION";
END;
DO;
   PUT USER $ @;
   PUT ACT_DT @;
   PUT DESCRIPTION $ ;
END;
RUN;

