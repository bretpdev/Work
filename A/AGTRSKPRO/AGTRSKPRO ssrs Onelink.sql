USE [CentralData]
GO
/****** Object:  StoredProcedure [agtrskpro].[GetTasksOneLinkSSRS]    Script Date: 7/23/2020 12:48:00 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [agtrskpro].GetTasksOneLinkSSRS
	
AS
DECLARE @Today DATE = GETDATE();
SELECT
	BUTM.BusinessUnitName,
	CT30.IF_WRK_GRP AS [QUEUE],
	CASE WHEN CT30.IC_TSK_STA = 'X' THEN 'Cancelled'
		 WHEN CT30.IC_TSK_STA = 'C' THEN 'Closed'
		 ELSE ''
	END AS [CURRENT STATUS],
	COALESCE(NULLIF(ISNULL(NULLIF(RTRIM(ISNULL(GX25.XM_USR_1,'')) + ' ' + RTRIM(ISNULL(GX25.XM_USR_LST,'')),' '), RTRIM(CT30.IF_LST_USR_CT30)) + ' - ' + RTRIM(CT30.IF_LST_USR_CT30), ' - '),'System') AS [USER],
	PD10.DF_SPE_ACC_ID AS ACCOUNT,
	CAST(CT30.IF_CRT_DTS_CT30 AS DATE) AS [REQUESTED DATE],
	CAST(CT30.IF_CRT_DTS_CT30 AS DATE) AS [LAST ASSIGNED DATE],
	CAST(CT30.IF_CRT_DTS_CT30 AS TIME(0)) AS [LAST ASSIGNED TIME],
	CT30.LD_LST_WRK AS [CLOSED DATE],
	CT30.IT_TSK_END AS [CLOSED TIME]
FROM
	CentralData.agtrskpro.BusinessUnitTaskMapping BUTM
	INNER JOIN ODW..CT30_CALL_QUE CT30
		ON CT30.IF_WRK_GRP = BUTM.[Queue]
		AND
		(
			CT30.IC_REC_TYP = BUTM.Subqueue
			OR BUTM.Subqueue IS NULL
		)
	INNER JOIN UDW..PD10_PRS_NME PD10
		ON PD10.DF_PRS_ID = CT30.DF_PRS_ID_BR
	LEFT JOIN UDW..GX25_USR GX25
		ON GX25.XF_USR = CT30.IF_LST_USR_CT30
WHERE
	BUTM.DeletedAt IS NULL --Active task
	AND BUTM.BusinessUnitName NOT LIKE '%FED'
	AND CT30.IC_TSK_STA IN('X','C')
	AND CT30.LD_LST_WRK = @Today --Task completed today

GO

ALTER PROCEDURE [agtrskpro].GetTasksSummaryOneLinkSSRS
	
AS
DECLARE @Today DATE = GETDATE();

SELECT DISTINCT
	BUTM.BusinessUnitName,
	COALESCE(NULLIF(ISNULL(NULLIF(RTRIM(ISNULL(GX25.XM_USR_1,'')) + ' ' + RTRIM(ISNULL(GX25.XM_USR_LST,'')),' '), RTRIM(CT30.IF_LST_USR_CT30)) + ' - ' + RTRIM(CT30.IF_LST_USR_CT30), ' - '),'System') AS [USER],
	CT30.IF_WRK_GRP AS [QUEUE],
	COUNT(PD10.DF_SPE_ACC_ID) OVER(PARTITION BY BUTM.BusinessUnitName, CT30.IF_LST_USR_CT30, CT30.IF_WRK_GRP) AS [QUEUE TOTAL]
FROM
	CentralData.agtrskpro.BusinessUnitTaskMapping BUTM
	INNER JOIN ODW..CT30_CALL_QUE CT30
		ON CT30.IF_WRK_GRP = BUTM.[Queue]
		AND
		(
			CT30.IC_REC_TYP = BUTM.Subqueue
			OR BUTM.Subqueue IS NULL
		)
	INNER JOIN UDW..PD10_PRS_NME PD10
		ON PD10.DF_PRS_ID = CT30.DF_PRS_ID_BR
	LEFT JOIN UDW..GX25_USR GX25
		ON GX25.XF_USR = CT30.IF_LST_USR_CT30
WHERE
	BUTM.DeletedAt IS NULL --Active task
	AND BUTM.BusinessUnitName NOT LIKE '%FED'
	AND CT30.IC_TSK_STA IN('X','C')
	AND CT30.LD_LST_WRK = @Today --Completed today
