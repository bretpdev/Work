%LET RPTLIB = %SYSGET(reportdir);
/*%LET RPTLIB = T:\SAS;*/

FILENAME REPORTZ "&RPTLIB/UNWDW1.NWDW1RZ";
FILENAME REPORT2 "&RPTLIB/UNWDW1.NWDW1R2";*LN20;
FILENAME REPORT4 "&RPTLIB/UNWDW1.NWDW1R4";*LN80;
FILENAME REPORT6 "&RPTLIB/UNWDW1.NWDW1R6";*DF10;
FILENAME REPORT7 "&RPTLIB/UNWDW1.NWDW1R7";*FB10;
FILENAME REPORT8 "&RPTLIB/UNWDW1.NWDW1R8";*PD10;
FILENAME REPORT9 "&RPTLIB/UNWDW1.NWDW1R9";*DL200;
FILENAME REPORT11 "&RPTLIB/UNWDW1.NWDW1R11";*LN10;
FILENAME REPORT12 "&RPTLIB/UNWDW1.NWDW1R12";*LN83;
FILENAME REPORT13 "&RPTLIB/UNWDW1.NWDW1R13";*LN09;
FILENAME REPORT14 "&RPTLIB/UNWDW1.NWDW1R14";*LN15;
FILENAME REPORT16 "&RPTLIB/UNWDW1.NWDW1R16";*ARC_IND;
FILENAME REPORT17 "&RPTLIB/UNWDW1.NWDW1R17";*LN65;
FILENAME REPORT20 "&RPTLIB/UNWDW1.NWDW1R20";*LN16;
FILENAME REPORT23 "&RPTLIB/UNWDW1.NWDW1R23";*PD32;
FILENAME REPORT25 "&RPTLIB/UNWDW1.NWDW1R25";*PD30;
FILENAME REPORT26 "&RPTLIB/UNWDW1.NWDW1R26";*PD42;
FILENAME REPORT29 "&RPTLIB/UNWDW1.NWDW1R29";*DW01;
FILENAME REPORT32 "&RPTLIB/UNWDW1.NWDW1R32";*ARC_M1411;
FILENAME REPORT37 "&RPTLIB/UNWDW1.NWDW1R37";*AD20;
FILENAME REPORT44 "&RPTLIB/UNWDW1.NWDW1R44";*FS14;

/*LIBNAME  LEGEND  REMOTE  SERVER=LEGEND SLIBREF=WORK;*/
/*RSUBMIT;*/
/*%LET DB = DNFPRQUT;  *This is test;*/
%LET DB = DNFPUTDL;  *This is live;

LIBNAME PKUB DB2 DATABASE=&DB OWNER=PKUB; 
LIBNAME PKUS DB2 DATABASE=&DB OWNER=PKUS; 
LIBNAME SAS_TAB V8 '/sas/whse/progrevw';

/*get last run date*/
DATA _NULL_; 
	SET SAS_TAB.LASTRUN_JOBS;
/*If the job must be run manually set this macro to the last day it successfully ran(last business day).*/
/*LAST_RUN = TODAY() - 6;	*COMMENT FOR PROD, IT WILL READ THE DATE FROM A TABLE;*/
	IF JOB = 'UTNWDW1' THEN DO;
		CALL SYMPUT('LAST_RUN',"'"||TRIM(LEFT(PUT(LAST_RUN,DATE10.)))|| "'D");
		CALL SYMPUT('LAST_RUNPASS',"'"|| PUT(LAST_RUN,MMDDYY10.) || "'");
	END;
RUN;
%PUT &LAST_RUN; 

/*THE TABLES ARE GOING TO HAVE THE ACCOUNT NUMBER RATHER THAN SSN AS A PRIMARY KEY*/
/*THE ACCOUNT NUMBER IS BEING TAKEN FROM THE PD10 TABLE WHILE SSN IS DROPPED*/
%MACRO SSN2ACC(TBL,ADKEY);
	PROC SORT DATA=&TBL; BY BF_SSN &ADKEY; RUN;

	DATA &TBL(DROP=BF_SSN);
		MERGE SSN2ACC(IN=B) &TBL(IN=A);
		BY BF_SSN;
		IF A AND B;
	RUN;

	PROC SORT DATA=&TBL; BY DF_SPE_ACC_ID &ADKEY; RUN;
%MEND;

/*******************************************
* BORROWER DATA
********************************************/
PROC SQL;
CREATE TABLE SSN2ACC AS
	SELECT DISTINCT 
		PD10.DF_SPE_ACC_ID AS DF_SPE_ACC_ID,
		PD10.DF_PRS_ID AS BF_SSN
	FROM 
		PKUB.PD10_PRS_NME PD10
		LEFT JOIN PKUB.LN10_LON LN10
			ON PD10.DF_PRS_ID = LN10.BF_SSN
	WHERE 
		COALESCE(LN10.LC_STA_LON10,'') NOT IN ('P','J')
		AND PD10.DF_SPE_ACC_ID ^= ''
	;
QUIT;
PROC SORT DATA=SSN2ACC; BY BF_SSN; RUN;

/*******************************************
* ENDORSER DATA
********************************************/
PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE LN20 AS
	SELECT *
	FROM CONNECTION TO DB2 
	(
		SELECT 
			LN20.BF_SSN,
			LN20.LN_SEQ,
			LN20.LC_STA_LON20,
			LN20.LC_EDS_TYP
		FROM
			PKUB.LN20_EDS LN20
		WHERE
			LN20.LF_LST_DTS_LN20 >= &LAST_RUNPASS

	FOR READ ONLY WITH UR
	);
DISCONNECT FROM DB2;
QUIT;
%SSN2ACC(LN20,LN_SEQ);

/*******************************************
* BILLING DATA
********************************************/
PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE LN80 AS
	SELECT *
	FROM CONNECTION TO DB2 
	(
		SELECT 
			LN80.BF_SSN,
			LN80.LN_SEQ,
			LN80.LD_BIL_CRT,
			LN80.LN_SEQ_BIL_WI_DTE,
			LN80.LN_BIL_OCC_SEQ,
			LN80.LD_BIL_DU_LON,
			LN80.LC_STA_LON80,
			COALESCE(LN80.LA_BIL_CUR_DU,0) AS LA_BIL_CUR_DU,
			COALESCE(LN80.LA_BIL_PAS_DU,0) AS LA_BIL_PAS_DU,
			COALESCE(LN80.LA_TOT_BIL_STS,0) AS LA_TOT_BIL_STS,
			BL10.LC_BIL_MTD,
			BL10.LC_IND_BIL_SNT,
			BL10.LC_STA_BIL10,
			LN90.LN_FAT_SEQ,
			LN90.LD_FAT_EFF,
			LN80.LC_LON_STA_BIL,
			BL10.LA_INT_PD_LST_STM,
			BL10.LA_FEE_PD_LST_STM,
			BL10.LA_PRI_PD_LST_STM,
			BL10.LA_INT_PD_LST_STM + BL10.LA_FEE_PD_LST_STM + BL10.LA_PRI_PD_LST_STM AS LA_TTL_PD_LST_STM,
			LN80.LA_LTE_FEE_OTS_PRT
		FROM 
			PKUB.BL10_BR_BIL BL10
			INNER JOIN PKUB.LN80_LON_BIL_CRF LN80
				ON LN80.BF_SSN = BL10.BF_SSN
				AND LN80.LD_BIL_CRT = BL10.LD_BIL_CRT
				AND LN80.LN_SEQ_BIL_WI_DTE = BL10.LN_SEQ_BIL_WI_DTE
			LEFT JOIN PKUB.LN75_BIL_LON_FAT LN75
				ON LN75.BF_SSN = LN80.BF_SSN
				AND LN75.LN_SEQ = LN80.LN_SEQ
				AND LN75.LD_BIL_CRT = LN80.LD_BIL_CRT
				AND LN75.LN_SEQ_BIL_WI_DTE = LN80.LN_SEQ_BIL_WI_DTE
				AND LN75.LN_BIL_OCC_SEQ = LN80.LN_BIL_OCC_SEQ
				AND LN80.LA_BIL_CUR_DU = LN80.LA_TOT_BIL_STS
			LEFT JOIN PKUB.LN90_FIN_ATY LN90
				ON LN75.BF_SSN = LN90.BF_SSN
				AND LN75.LN_SEQ = LN90.LN_SEQ
				AND LN75.LN_FAT_SEQ = LN90.LN_FAT_SEQ
		WHERE 
			LN80.LC_BIL_TYP_LON = 'P' 
			AND LN80.LD_LST_DTS_LN80 >= &LAST_RUNPASS

	FOR READ ONLY WITH UR
	);
DISCONNECT FROM DB2;
QUIT; 
PROC SORT DATA=LN80; BY BF_SSN LN_SEQ LD_BIL_CRT LN_SEQ_BIL_WI_DTE LN_BIL_OCC_SEQ LN_FAT_SEQ; RUN;

DATA LN80(DROP=LN_BIL_OCC_SEQ LN_FAT_SEQ); 
	SET LN80;
	BY BF_SSN LN_SEQ LD_BIL_CRT LN_SEQ_BIL_WI_DTE ;
	IF LAST.LN_SEQ_BIL_WI_DTE;
RUN;
%SSN2ACC(LN80,LN_SEQ LD_BIL_CRT LN_SEQ_BIL_WI_DTE);

/*******************************************
* DEFERMENT DATA
********************************************/
PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE DF10 AS
	SELECT *
	FROM CONNECTION TO DB2 
	(
		SELECT 
			LN50.BF_SSN,
			LN50.LN_SEQ,
			LN50.LF_DFR_CTL_NUM,
			LN50.LN_DFR_OCC_SEQ,
			DF10.LC_DFR_TYP,
			DF10.LD_DFR_INF_CER,
			LN50.LD_DFR_BEG,
			LN50.LD_DFR_END,
			LN50.LC_LON_LEV_DFR_CAP,
			LN50.LC_STA_LON50,
			DF10.LC_DFR_STA,
			DF10.LC_STA_DFR10
		FROM 
			PKUB.LN50_BR_DFR_APV LN50
			INNER JOIN PKUB.DF10_BR_DFR_REQ DF10
				ON LN50.BF_SSN = DF10.BF_SSN
				AND LN50.LF_DFR_CTL_NUM = DF10.LF_DFR_CTL_NUM
		WHERE 
			LN50.LF_LST_DTS_LN50 >= &LAST_RUNPASS 
			OR DF10.LF_LST_DTS_DF10 >= &LAST_RUNPASS

	FOR READ ONLY WITH UR
	);
DISCONNECT FROM DB2;
QUIT;
%SSN2ACC(DF10,LN_SEQ LF_DFR_CTL_NUM LN_DFR_OCC_SEQ);

/*******************************************
* FORBEARANCE DATA
********************************************/
PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE FB10 AS
	SELECT *
	FROM CONNECTION TO DB2 
	(
		SELECT 
			LN60.BF_SSN,
			LN60.LN_SEQ,
			LN60.LF_FOR_CTL_NUM,
			LN60.LN_FOR_OCC_SEQ,
			FB10.LC_FOR_TYP,
			FB10.LD_FOR_INF_CER,
			LN60.LD_FOR_BEG,
			LN60.LD_FOR_END,
			LN60.LC_LON_LEV_FOR_CAP ,
			LN60.LC_STA_LON60,
			FB10.LC_FOR_STA,
			FB10.LC_STA_FOR10,
			COALESCE(FB10.LA_REQ_RDC_PAY,0) AS LA_REQ_RDC_PAY,
			LN60.LI_FOR_VRB_DFL_RUL
		FROM 
			PKUB.LN60_BR_FOR_APV LN60
			INNER JOIN PKUB.FB10_BR_FOR_REQ FB10
				ON LN60.BF_SSN = FB10.BF_SSN
				AND LN60.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM
		WHERE
			LN60.LF_LST_DTS_LN60 >= &LAST_RUNPASS
			OR FB10.LF_LST_DTS_FB10 >= &LAST_RUNPASS

	FOR READ ONLY WITH UR
	);
DISCONNECT FROM DB2;
QUIT;
%SSN2ACC(FB10,LN_SEQ LF_FOR_CTL_NUM LN_FOR_OCC_SEQ);

/*******************************************
* LOAN DATA
********************************************/
PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE LN10 AS
	SELECT *
	FROM CONNECTION TO DB2 
	(
		SELECT 
			LN10.BF_SSN,
			LN10.LN_SEQ, 
			LN10.LC_STA_LON10, 
			LN10.LA_CUR_PRI, 
			LN10.LA_LON_AMT_GTR, 
			LN10.LD_END_GRC_PRD,
			LN10.IC_LON_PGM, 
			LN10.LD_LON_1_DSB, 
			LN10.LD_PIF_RPT,
			LN10.LC_SST_LON10,
			LN10.LF_LON_CUR_OWN,
			LN10.LF_DOE_SCL_ORG
		FROM 
			PKUB.LN10_LON LN10
		WHERE
			LN10.LC_STA_LON10 NOT IN ('P','J')

	FOR READ ONLY WITH UR
	);
DISCONNECT FROM DB2;
QUIT;
%SSN2ACC(LN10,LN_SEQ);

/*******************************************
* ACH DATA
********************************************/
PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE LN83 AS
	SELECT *
	FROM CONNECTION TO DB2 
	(
		SELECT
			LN83.BF_SSN,
			LN83.LN_SEQ,
			LN83.BN_EFT_SEQ,
			LN83.LD_EFT_EFF_END,
			LN83.LC_STA_LN83
		FROM
			PKUB.LN83_EFT_TO_LON LN83
		WHERE
			LN83.LF_LST_DTS_LN83 >= &LAST_RUNPASS

	FOR READ ONLY WITH UR
	);
DISCONNECT FROM DB2;
QUIT;
PROC SORT DATA=LN83; BY BF_SSN LN_SEQ DESCENDING BN_EFT_SEQ; RUN;

DATA LN83;
	SET LN83;
	BY BF_SSN LN_SEQ;
	IF FIRST.LN_SEQ;
RUN;
%SSN2ACC(LN83,LN_SEQ);

/*******************************************
* REHAB DATA 
********************************************/
PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE LN09 AS
	SELECT *
	FROM CONNECTION TO DB2 
	(
		SELECT 
			LN09.BF_SSN,
			LN09.LN_SEQ,
			LN09.LD_LON_RHB_PCV
		FROM
			PKUB.LN09_RPD_PIO_CVN LN09
		WHERE
			LN09.LD_LON_RHB_PCV IS NOT NULL
			AND LN09.LF_LST_DTS_LN09 >= &LAST_RUNPASS

	FOR READ ONLY WITH UR
	);
DISCONNECT FROM DB2;
QUIT;
%SSN2ACC(LN09,LN_SEQ);

/*********************************************
* DISBURSEMENT
**********************************************/
PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE LN15 AS
	SELECT *
	FROM CONNECTION TO DB2 
	(
		SELECT 
			BF_SSN,
			LN_BR_DSB_SEQ,
			LA_DSB - COALESCE(LA_DSB_CAN,0) AS LA_DSB,
			LD_DSB,
			LC_DSB_TYP,
			LC_STA_LON15,
			LN_SEQ,
			COALESCE(LA_DL_DSB_REB,0) - COALESCE(LA_DSB_REB_CAN,0) AS LA_DL_REBATE
		FROM 
			PKUB.LN15_DSB 
		WHERE 
			LF_LST_DTS_LN15 >= &LAST_RUNPASS

	FOR READ ONLY WITH UR
	);
DISCONNECT FROM DB2;
QUIT;
%SSN2ACC(LN15,LN_BR_DSB_SEQ);

/*********************************************
* DELINQUENCY DATA
**********************************************/
PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE LN16 AS
	SELECT *
	FROM CONNECTION TO DB2
	(
		SELECT 
			LN16.BF_SSN,
			LN16.LN_SEQ,
			LN16.LN_DLQ_SEQ,
			LN16.LD_DLQ_OCC,
			CASE WHEN LN16.LC_STA_LON16 ^= '1' OR (LN16.LC_STA_LON16 = '1' AND LN16.LD_DLQ_MAX ^= Current Date - 1 Day) THEN 0 ELSE LN16.LN_DLQ_MAX END AS LN_DLQ_MAX,
			CASE WHEN LN16.LC_STA_LON16 ^= '1' OR (LN16.LC_STA_LON16 = '1' AND LN16.LD_DLQ_MAX ^= Current Date - 1 Day) THEN NULL ELSE LN16.LD_DLQ_MAX END AS LD_DLQ_MAX
		FROM
			PKUB.LN16_LON_DLQ_HST LN16
		WHERE
			LN16.LF_LST_DTS_LN16 >= &LAST_RUNPASS

	FOR READ ONLY WITH UR
	);
DISCONNECT FROM DB2;
QUIT;
PROC SORT DATA=LN16; BY BF_SSN LN_SEQ DESCENDING LN_DLQ_SEQ; RUN;

DATA LN16;
	SET LN16(DROP=LN_DLQ_SEQ);
	BY BF_SSN LN_SEQ;
	IF FIRST.LN_SEQ;
RUN;
%SSN2ACC(LN16,LN_SEQ);

/*********************************************
* DEMOGRAPHICS
**********************************************/
PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE PD10 AS
	SELECT *
	FROM CONNECTION TO DB2 
	(
		SELECT DISTINCT 
			PD10.DF_SPE_ACC_ID,
			PD10.DF_PRS_ID AS BF_SSN,
			PD10.DM_PRS_1,
			PD10.DM_PRS_LST,
			PD10.DM_PRS_MID,
			PD10.DD_BRT
		FROM 
			PKUB.PD10_PRS_NME PD10
		WHERE 
			SUBSTR(DF_PRS_ID,1,1) != 'P'
			AND PD10.DF_LST_DTS_PD10 >= &LAST_RUNPASS

	FOR READ ONLY WITH UR
	);
DISCONNECT FROM DB2;
QUIT;

PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE PD30 AS
	SELECT *
	FROM CONNECTION TO DB2 
	(
		SELECT DISTINCT 
			PD30.DF_PRS_ID AS BF_SSN,
			PD30.DX_STR_ADR_1,
			PD30.DX_STR_ADR_2,
			PD30.DM_CT,
			PD30.DC_DOM_ST,
			PD30.DF_ZIP_CDE,
			PD30.DM_FGN_ST,
			PD30.DM_FGN_CNY,
			PD30.DD_VER_ADR,
			PD30.DI_VLD_ADR
		FROM 
			PKUB.PD30_PRS_ADR PD30
		WHERE 
			PD30.DC_ADR = 'L'
			AND PD30.DF_LST_DTS_PD30 >= &LAST_RUNPASS

	FOR READ ONLY WITH UR
	);
DISCONNECT FROM DB2;
QUIT;
%SSN2ACC(PD30,);

PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE PD42 AS
	SELECT *
	FROM CONNECTION TO DB2
	(
		SELECT DISTINCT 
			PD40.DF_PRS_ID AS BF_SSN,
			PD40.DC_PHN,
			PD40.DC_ALW_ADL_PHN,
			PD40.DD_PHN_VER,
			PD40.DI_PHN_VLD,
			PD40.DN_DOM_PHN_ARA,
			PD40.DN_DOM_PHN_XCH,
			PD40.DN_DOM_PHN_LCL,
			PD40.DN_PHN_XTN,
			PD40.DN_FGN_PHN_CNY,
			PD40.DN_FGN_PHN_CT,
			PD40.DN_FGN_PHN_LCL
		FROM  
			PKUB.PD40_PRS_PHN PD40
		WHERE 
			PD40.DF_LST_DTS_PD40 >= &LAST_RUNPASS

	FOR READ ONLY WITH UR
	);
DISCONNECT FROM DB2;
QUIT;
%SSN2ACC(PD42,DC_PHN);

PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE PD32 AS
	SELECT *
	FROM CONNECTION TO DB2
	(
		SELECT DISTINCT
			PD32.DF_PRS_ID AS BF_SSN,
			PD32.DC_ADR_EML,
			PD32.DX_ADR_EML,
			PD32.DD_VER_ADR_EML,
			PD32.DI_VLD_ADR_EML,
			PD32.DC_STA_PD32
		FROM 
			PKUB.PD32_PRS_ADR_EML PD32
		WHERE 
			PD32.DF_LST_DTS_PD32 >= &LAST_RUNPASS
			AND PD32.DC_STA_PD32 = 'A'

	FOR READ ONLY WITH UR
	);
DISCONNECT FROM DB2;
QUIT;
PROC SORT DATA=PD32; BY BF_SSN DC_ADR_EML DC_STA_PD32 ; RUN;

DATA PD32(DROP=DC_STA_PD32);
	SET PD32;
	BY BF_SSN DC_ADR_EML;
	IF FIRST.DC_ADR_EML;
RUN;
%SSN2ACC(PD32,DC_ADR_EML);

/*********************************************
* ADDITIONAL LOAN DATA
**********************************************/
PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE DW01 AS
	SELECT *
	FROM CONNECTION TO DB2 
	(
		SELECT
			DW01.BF_SSN,
			DW01.LN_SEQ,
			DW01.WC_DW_LON_STA,
			DW01.WA_TOT_BRI_OTS,
			DW01.WD_LON_RPD_SR,
			DW01.WX_OVR_DW_LON_STA
		FROM
			PKUB.DW01_DW_CLC_CLU DW01

	FOR READ ONLY WITH UR
	);
DISCONNECT FROM DB2;
QUIT;
%SSN2ACC(DW01,LN_SEQ);

/*********************************************
* ACTIVITY HISTORY
**********************************************/
PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE ARCS AS
	SELECT *
	FROM CONNECTION TO DB2 
	(
		SELECT 
			AY10.BF_SSN,
			AY10.LN_ATY_SEQ,
			AY10.PF_REQ_ACT,
			AY10.LC_STA_ACTY10,
			LX_ATY
		FROM
			PKUB.AY10_BR_LON_ATY AY10
			LEFT JOIN PKUB.AY15_ATY_CMT AY15
				ON AY10.BF_SSN = AY15.BF_SSN 
				AND AY10.LN_ATY_SEQ = AY15.LN_ATY_SEQ
				AND AY15.LN_ATY_CMT_SEQ = 1
		 	LEFT JOIN PKUB.AY20_ATY_TXT AY20
				ON AY15.BF_SSN = AY20.BF_SSN 
				AND AY15.LN_ATY_SEQ = AY20.LN_ATY_SEQ
				AND AY15.LN_ATY_CMT_SEQ = AY20.LN_ATY_CMT_SEQ
		WHERE 
			AY10.PF_REQ_ACT IN ('DRLFA','K0ADD','K0PHN','M1411')
			AND AY10.LC_STA_ACTY10 = 'A'
			AND 
			(
				AY10.LF_LST_DTS_AY10 >= &LAST_RUNPASS 
				OR AY10.PF_REQ_ACT = 'DRLFA'
			)

	FOR READ ONLY WITH UR
	);

CREATE TABLE ARC_IND AS
	SELECT *
	FROM CONNECTION TO DB2
	(
		SELECT
			AY10.BF_SSN,
			AY10.LN_ATY_SEQ,
			AY10.PF_REQ_ACT,
			AY10.LC_STA_ACTY10
		FROM 
			PKUB.AY10_BR_LON_ATY AY10
		WHERE 
			AY10.PF_REQ_ACT IN ('SPHAN','VIPSS')
			AND AY10.LC_STA_ACTY10 = 'A'
			AND AY10.LF_LST_DTS_AY10 >= &LAST_RUNPASS

	FOR READ ONLY WITH UR
	);

CREATE TABLE DL200 AS
	SELECT *
	FROM CONNECTION TO DB2
	(
		SELECT
			AY10.BF_SSN,
			AY10.LN_ATY_SEQ,
			AY10.LD_ATY_REQ_RCV,
			AY10.LC_STA_ACTY10
		FROM
			PKUB.AY10_BR_LON_ATY AY10
		WHERE
			AY10.PF_REQ_ACT = 'DL200'
			AND AY10.LF_LST_DTS_AY10 >= &LAST_RUNPASS

	FOR READ ONLY WITH UR
	);
DISCONNECT FROM DB2;
QUIT;

DATA ARC_M1411(KEEP=BF_SSN LN_ATY_SEQ LC_STA_ACTY10 LX_ATY);
	SET ARCS;
	LENGTH DX_STR_ADR_1 $30. DX_STR_ADR_2 $30. DM_CT $20. DC_DOM_ST $2. DF_ZIP_CDE $17. DM_FGN_CNY $25. COMMENTS $300.;
	LENGTH  PHN1 PHN2 PHN3 $25.;
	ARRAY ADR{7} $ DX_STR_ADR_1 DX_STR_ADR_2 DM_CT DC_DOM_ST DF_ZIP_CDE DM_FGN_CNY COMMENTS;
	ARRAY PHN{4} $ PHN1 PHN2 PHN3 COMMENTS;
	IF PF_REQ_ACT = 'M1411' THEN OUTPUT ARC_M1411;
RUN;

%SSN2ACC(ARC_M1411,LN_ATY_SEQ);
%SSN2ACC(DL200,LN_ATY_SEQ);
%SSN2ACC(ARC_IND,LN_ATY_SEQ); 

/*******************************************
* REPAYMENT SCHEDULE DATA
********************************************/
PROC SQL;
CREATE TABLE LN65 AS
	SELECT 
		LN65.BF_SSN,
		LN65.LN_SEQ,
		LN66.LN_GRD_RPS_SEQ,
		CASE WHEN DW01.WX_OVR_DW_LON_STA = 'LITIGATION' THEN 0
			 ELSE LN66.LN_RPS_TRM
		END AS LN_RPS_TRM,
		CASE WHEN DW01.WX_OVR_DW_LON_STA = 'LITIGATION' THEN .
			 ELSE RS10.LD_RPS_1_PAY_DU
		END AS LD_RPS_1_PAY_DU,
		RS10.LD_SNT_RPD_DIS,
		LN65.LD_CRT_LON65,
		LN65.LC_TYP_SCH_DIS,
		CASE WHEN DW01.WX_OVR_DW_LON_STA = 'LITIGATION' THEN 0
			 ELSE LN66.LA_RPS_ISL
		END AS LA_RPS_ISL
	FROM
		PKUB.RS10_BR_RPD RS10
		INNER JOIN PKUB.LN65_LON_RPS LN65
			ON RS10.BF_SSN = LN65.BF_SSN
			AND RS10.LN_RPS_SEQ = LN65.LN_RPS_SEQ
		INNER JOIN PKUB.LN66_LON_RPS_SPF LN66
			ON LN65.BF_SSN = LN66.BF_SSN
			AND LN65.LN_SEQ = LN66.LN_SEQ
			AND LN65.LN_RPS_SEQ = LN66.LN_RPS_SEQ
		INNER JOIN PKUB.DW01_DW_CLC_CLU DW01
			ON LN65.BF_SSN = DW01.BF_SSN
			AND LN65.LN_SEQ = DW01.LN_SEQ
	WHERE 
		LN65.LC_STA_LON65 = 'A'
;
QUIT;
PROC SORT DATA=LN65; BY BF_SSN LN_SEQ LN_GRD_RPS_SEQ; RUN;

DATA LN65(DROP= A B C NEXT_SEQ LD_RPS_1_PAY_DU LN_GRD_RPS_SEQ);
	SET LN65;
	FORMAT NEXT_SEQ DATE9.;
	BY BF_SSN LN_SEQ LN_GRD_RPS_SEQ;
	RETAIN NEXT_SEQ A C B;
	IF FIRST.LN_SEQ THEN DO;
		A = .;
		NEXT_SEQ = INTNX('MONTH',LD_RPS_1_PAY_DU,LN_RPS_TRM,'S');
		IF NEXT_SEQ > TODAY() THEN DO;
			A = LN_GRD_RPS_SEQ ;
			C = LA_RPS_ISL ;
		END;
	END;
	ELSE IF A= . THEN DO;
		NEXT_SEQ = INTNX('MONTH',NEXT_SEQ,LN_RPS_TRM,'S');
		IF NEXT_SEQ > TODAY() THEN DO;
			A = LN_GRD_RPS_SEQ ;
			C = LA_RPS_ISL ;
		END;
	END;
	IF FIRST.LN_SEQ THEN B = LN_RPS_TRM;
	ELSE B = B + LN_RPS_TRM;
	IF LAST.LN_SEQ THEN DO;
		LN_RPS_TRM = B;
		LA_RPS_ISL = C;
		LN_GRD_RPS_SEQ = A;
		DAY_DUE = DAY(LD_RPS_1_PAY_DU);
		OUTPUT;
	END;
RUN;
%SSN2ACC(LN65,LN_SEQ);

/*********************************************
* FINANCIAL ACTIVITY ADJUSTMENT
**********************************************/
PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE AD20 AS
	SELECT *
	FROM CONNECTION TO DB2 
	(
		SELECT
			BF_SSN,
			LD_FAT_ADJ_REQ,
			LN_SEQ_FAT_ADJ_REQ,
			LC_TYP_FAT_ADJ_REQ,  
			LC_STA_FAT_ADJ_REQ
		FROM
			PKUB.AD20_PCV_ATY_ADJ AD20
		WHERE
			LF_LST_DTS_AD20 >= &LAST_RUNPASS

	FOR READ ONLY WITH UR
	);
DISCONNECT FROM DB2;
QUIT;
%SSN2ACC(AD20,LD_FAT_ADJ_REQ LN_SEQ_FAT_ADJ_REQ);

/*********************************************
* LOAN SUBSIDY
**********************************************/
PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE FS14 AS
	SELECT *
	FROM CONNECTION TO DB2 
	(
		SELECT DISTINCT
			FS14.BF_SSN,
			FS14.LN_SEQ,
			FS14.LN_INC_SUB_EVT_SEQ,
			FS14.LD_INC_SUB_EFF_BEG,
			FS14.LD_INC_SUB_EFF_END,
			FS14.LC_INC_SUB_STA,
			FS14.LR_SUB_RMN,
			FS14.LF_LST_USR_FS14,
			FS14.LF_LST_DTS_FS14,
			FS14.LF_CRT_USR_FS14,
			FS14.LD_CRT_FS14,
			FS14.LC_STA_FS14,
			FS14.LD_STA_FS14
		FROM
			PKUB.FS14_SUB_LOS_RNS FS14
		WHERE
			FS14.LF_LST_DTS_FS14 >= &LAST_RUNPASS	

	FOR READ ONLY WITH UR
	);
DISCONNECT FROM DB2;
QUIT;
%SSN2ACC(FS14, LN_SEQ);


DATA SAS_TAB.LASTRUN_JOBS;
	SET SAS_TAB.LASTRUN_JOBS;
	IF JOB = 'UTNWDW1' 
		THEN LAST_RUN = TODAY();
RUN;
/*ENDRSUBMIT;*/

/*DATA LN20; SET LEGEND.LN20; RUN; *2;*/
/*DATA LN80; SET LEGEND.LN80; RUN; *4;*/
/*DATA DF10; SET LEGEND.DF10; RUN; *6;*/
/*DATA FB10; SET LEGEND.FB10; RUN; *7;*/
/*DATA PD10; SET LEGEND.PD10; RUN; *8;*/
/*DATA DL200; SET LEGEND.DL200; RUN; *9;*/
/*DATA LN10; SET LEGEND.LN10; RUN; *11;*/
/*DATA LN83; SET LEGEND.LN83; RUN; *12;*/
/*DATA LN09; SET LEGEND.LN09; RUN; *13;*/
/*DATA LN15; SET LEGEND.LN15; RUN; *14;*/
/*DATA ARC_IND; SET LEGEND.ARC_IND; RUN; *16;*/
/*DATA LN65; SET LEGEND.LN65; RUN; *17;*/
/*DATA LN16; SET LEGEND.LN16; RUN; *20;*/
/*DATA PD32; SET LEGEND.PD32; RUN; *23;*/
/*DATA PD30; SET LEGEND.PD30; RUN; *25;*/
/*DATA PD42; SET LEGEND.PD42; RUN; *26;*/
/*DATA DW01; SET LEGEND.DW01; RUN; *29;*/
/*DATA ARC_M1411; SET LEGEND.ARC_M1411; RUN; *32;*/
/*DATA AD20; SET LEGEND.AD20; RUN; *37;*/
/*DATA FS14; SET LEGEND.FS14; RUN; *44;*/

DATA _NULL_;
	SET LN20 END = eof;
	FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
	IF _N_ = 1 THEN PUT "-Begin-";
	DO;
		PUT DF_SPE_ACC_ID @;
		PUT LN_SEQ @;
		PUT LC_STA_LON20 $;
	END;
	IF eof THEN PUT "-End-";
RUN;

DATA _NULL_;
	SET LN80 END = eof;
	FILE REPORT4 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT LD_BIL_CRT LD_FAT_EFF LD_BIL_DU_LON MMDDYY10. ;
	FORMAT 	LA_BIL_CUR_DU LA_BIL_PAS_DU	LA_TOT_BIL_STS LA_INT_PD_LST_STM LA_FEE_PD_LST_STM LA_PRI_PD_LST_STM LA_TTL_PD_LST_STM LA_LTE_FEE_OTS_PRT 9.2;
	IF _N_ = 1 THEN PUT "-Begin-";
	DO;
		PUT DF_SPE_ACC_ID @;
		PUT LN_SEQ @;
		PUT LD_BIL_CRT @;
		PUT LN_SEQ_BIL_WI_DTE @;
		PUT LD_FAT_EFF @;
		PUT LD_BIL_DU_LON @;
		PUT LC_STA_LON80 @;
		PUT LA_BIL_CUR_DU @;
		PUT LA_BIL_PAS_DU @;
		PUT LC_BIL_MTD @;
		PUT LC_IND_BIL_SNT @;
		PUT LC_STA_BIL10 @;
		PUT LA_TOT_BIL_STS @;
		PUT LA_INT_PD_LST_STM @;
		PUT LA_FEE_PD_LST_STM @;
		PUT LA_PRI_PD_LST_STM @;
		PUT LA_TTL_PD_LST_STM @;
		PUT LA_LTE_FEE_OTS_PRT $;
	END;
	IF eof THEN PUT "-End-";
RUN; 

DATA _NULL_;
	SET DF10 END = eof;
	FILE REPORT6 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT LD_DFR_INF_CER LD_DFR_BEG LD_DFR_END MMDDYY10. ;
	IF _N_ = 1 THEN PUT "-Begin-";
	DO;
		PUT DF_SPE_ACC_ID @;
		PUT LN_SEQ @;
		PUT LF_DFR_CTL_NUM @;
		PUT LN_DFR_OCC_SEQ @;
		PUT LC_DFR_TYP @;
		PUT LD_DFR_INF_CER @;
		PUT LD_DFR_BEG @;
		PUT LD_DFR_END @;
		PUT LC_LON_LEV_DFR_CAP @;
		PUT LC_STA_LON50 @;
		PUT LC_DFR_STA @;
		PUT LC_STA_DFR10 $;
	END;
	IF eof THEN PUT "-End-";
RUN;

DATA _NULL_;
	SET FB10 END = eof;
	FILE REPORT7 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT LD_FOR_INF_CER LD_FOR_BEG LD_FOR_END MMDDYY10. LA_REQ_RDC_PAY 9.2;
	IF _N_ = 1 THEN PUT "-Begin-";
	DO;
		PUT DF_SPE_ACC_ID @;
		PUT LN_SEQ @;
		PUT LF_FOR_CTL_NUM @;
		PUT LN_FOR_OCC_SEQ @;
		PUT LC_FOR_TYP @;
		PUT LD_FOR_INF_CER @;
		PUT LD_FOR_BEG @;
		PUT LD_FOR_END @;
		PUT LC_LON_LEV_FOR_CAP @;
		PUT LC_STA_LON60 @;
		PUT LC_FOR_STA @;
		PUT LC_STA_FOR10 @;
		PUT LA_REQ_RDC_PAY @;
		PUT LI_FOR_VRB_DFL_RUL $;
	END;
	IF eof THEN PUT "-End-";
RUN;

DATA _NULL_;
	SET PD10 END = eof;
	FILE REPORT8 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT DD_BRT MMDDYY10.;
	IF _N_ = 1 THEN PUT "-Begin-";
	DO;
		PUT DF_SPE_ACC_ID @;
		PUT BF_SSN @;
		PUT DM_PRS_1 @;
		PUT DM_PRS_LST @;
		PUT DM_PRS_MID @;
		PUT DD_BRT $;
	END;
	IF eof THEN PUT "-End-";
RUN;

DATA _NULL_;
	SET DL200 END = eof;
	FILE REPORT9 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT LD_ATY_REQ_RCV MMDDYY10.;
	IF _N_ = 1 THEN PUT "-Begin-";
	DO;	
		PUT DF_SPE_ACC_ID @;
		PUT LN_ATY_SEQ @;
		PUT LC_STA_ACTY10 @;
		PUT LD_ATY_REQ_RCV $;
	END;
	IF eof THEN PUT "-End-";
RUN;

DATA _NULL_;
	SET LN10 END = eof;
	FILE REPORT11 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT LD_END_GRC_PRD LD_LON_1_DSB  LD_PIF_RPT MMDDYY10. ;
	IF _N_ = 1 THEN PUT "-Begin-";
	DO;
		PUT DF_SPE_ACC_ID @;
		PUT LN_SEQ @;
		PUT LC_STA_LON10 @;
		PUT LA_CUR_PRI @;
		PUT LA_LON_AMT_GTR @;
		PUT LD_END_GRC_PRD @;
		PUT IC_LON_PGM @;
		PUT LD_LON_1_DSB @;
		PUT LD_PIF_RPT @;
		PUT LC_SST_LON10 @;
		PUT LF_LON_CUR_OWN @;
		PUT LF_DOE_SCL_ORG $;
	END;
	IF eof THEN PUT "-End-";
RUN;

DATA _NULL_;
	SET LN83 END = eof;
	FILE REPORT12 DELIMITER=',' DSD DROPOVER LRECL=32767;
	IF _N_ = 1 THEN PUT "-Begin-";
	DO;
		PUT DF_SPE_ACC_ID @;
		PUT LN_SEQ  @;
		PUT BN_EFT_SEQ @;
		PUT LC_STA_LN83 $;
	END;
	IF eof THEN PUT "-End-";
RUN;

DATA _NULL_;
	SET LN09 END = eof;
	FILE REPORT13 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT LD_LON_RHB_PCV MMDDYY10. ;
	IF _N_ = 1 THEN PUT "-Begin-";
	DO;
		PUT DF_SPE_ACC_ID @;
		PUT LN_SEQ @;
		PUT LD_LON_RHB_PCV $;
	END;
	IF eof THEN PUT "-End-";
RUN;

DATA _NULL_;
	SET LN15 END = eof;
	FILE REPORT14 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT LD_DSB MMDDYY10.;
	FORMAT LA_DSB LA_DL_REBATE 9.2;
	IF _N_ = 1 THEN PUT "-Begin-";
	DO;
		PUT DF_SPE_ACC_ID @;
		PUT LN_BR_DSB_SEQ @;
		PUT LA_DSB @;
		PUT LD_DSB @;
		PUT LC_DSB_TYP @;
		PUT LC_STA_LON15 @;
		PUT LN_SEQ @;
		PUT LA_DL_REBATE $;
	END;
	IF eof THEN PUT "-End-";
RUN;

DATA _NULL_;
	SET ARC_IND END = eof;
	FILE REPORT16 DELIMITER=',' DSD DROPOVER LRECL=32767;
	IF _N_ = 1 THEN PUT "-Begin-";
	DO;	
		PUT DF_SPE_ACC_ID @;
		PUT LN_ATY_SEQ @;
		PUT PF_REQ_ACT @;
		PUT LC_STA_ACTY10 $;
	END;
	IF eof THEN PUT "-End-";
RUN;

DATA _NULL_;
	SET LN65 END = eof;
	FILE REPORT17 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT LD_CRT_LON65 LD_SNT_RPD_DIS MMDDYY10. ;
	IF _N_ = 1 THEN PUT "-Begin-";
	DO;
		PUT DF_SPE_ACC_ID @;
		PUT LN_SEQ  @;
		PUT LD_CRT_LON65 @;	
		PUT LC_TYP_SCH_DIS @; 
		PUT LD_SNT_RPD_DIS @;
		PUT LA_RPS_ISL @;
		PUT DAY_DUE @;
		PUT LN_RPS_TRM $;
	END;
	IF eof THEN PUT "-End-";
RUN;

DATA _NULL_;
	SET LN16 END = eof;
	FILE REPORT20 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT LD_DLQ_OCC LD_DLQ_MAX MMDDYY10.;
	IF _N_ = 1 THEN PUT "-Begin-";
	DO;
		PUT DF_SPE_ACC_ID @;
		PUT LN_SEQ @;
		PUT LD_DLQ_OCC @;
		PUT LN_DLQ_MAX @;
		PUT LD_DLQ_MAX $;
	END;
	IF eof THEN PUT "-End-";
RUN;

DATA _NULL_;
	SET PD32 END = eof;
	FILE REPORT23 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT DD_VER_ADR_EML MMDDYY10.;
	IF _N_ = 1 THEN PUT "-Begin-";
	DO;
		PUT DF_SPE_ACC_ID @;
		PUT DC_ADR_EML @;
		PUT DX_ADR_EML @;
		PUT DD_VER_ADR_EML @;
		PUT DI_VLD_ADR_EML $;
	END;
	IF eof THEN PUT "-End-";
RUN;

DATA _NULL_;
	SET PD30 END = eof;
	FILE REPORT25 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT DD_VER_ADR MMDDYY10.;
	IF _N_ = 1 THEN PUT "-Begin-";
	DO;
		PUT DF_SPE_ACC_ID @;
		PUT DX_STR_ADR_1 @;
		PUT DX_STR_ADR_2 @;
		PUT DM_CT @;
		PUT DC_DOM_ST @;
		PUT DF_ZIP_CDE @;
		PUT DM_FGN_ST @;
		PUT DM_FGN_CNY @;
		PUT DD_VER_ADR @;
		PUT DI_VLD_ADR $;
	END;
	IF eof THEN PUT "-End-";
RUN;

DATA _NULL_;
	SET PD42 END = eof;
	FILE REPORT26 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT DD_PHN_VER MMDDYY10.;
	IF _N_ = 1 THEN PUT "-Begin-";
	DO;
		PUT DF_SPE_ACC_ID @;
		PUT DC_PHN @;
		PUT DC_ALW_ADL_PHN @;
		PUT DD_PHN_VER @;
		PUT DI_PHN_VLD @;
		PUT DN_DOM_PHN_ARA @;
		PUT DN_DOM_PHN_XCH @;
		PUT DN_DOM_PHN_LCL @;
		PUT DN_PHN_XTN @;
		PUT DN_FGN_PHN_CNY @;
		PUT DN_FGN_PHN_CT @;
		PUT DN_FGN_PHN_LCL $;
	END;
	IF eof THEN PUT "-End-";
RUN;

DATA _NULL_;
	SET DW01 END = eof;
	FILE REPORT29 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT WA_TOT_BRI_OTS 9.2 WD_LON_RPD_SR mmddyy10.;
	IF _N_ = 1 THEN PUT "-Begin-";
	DO;
		PUT DF_SPE_ACC_ID @;
		PUT LN_SEQ  @;
		PUT WC_DW_LON_STA  @;
		PUT WA_TOT_BRI_OTS @;
		PUT WD_LON_RPD_SR @;
		PUT WX_OVR_DW_LON_STA $;
	END;
	IF eof THEN PUT "-End-";
RUN;

DATA _NULL_;
	SET ARC_M1411 END = eof;
	FILE REPORT32 DELIMITER=',' DSD DROPOVER LRECL=32767;
	IF _N_ = 1 THEN PUT "-Begin-";
	DO;	
		PUT DF_SPE_ACC_ID @;
		PUT LN_ATY_SEQ @;
		PUT LC_STA_ACTY10 @;
		PUT LX_ATY $;
	END;
	IF eof THEN PUT "-End-";
RUN;

DATA _NULL_;
	SET AD20 END = eof;
	FILE REPORT37 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT LD_FAT_ADJ_REQ MMDDYY10.;

	IF _N_ = 1 THEN PUT "-Begin-";
	DO;
		PUT DF_SPE_ACC_ID @;
		PUT LD_FAT_ADJ_REQ @;
		PUT LN_SEQ_FAT_ADJ_REQ @;
		PUT LC_TYP_FAT_ADJ_REQ @;
		PUT LC_STA_FAT_ADJ_REQ;
	END;
	IF EOF THEN PUT "-End-";
RUN;

DATA _NULL_;
	SET FS14 END = EOF;
	FILE REPORT44 DELIMITER=',' DSD DROPOVER LRECL=32767;

	IF _N_ = 1 THEN PUT "-Begin-";
	DO;
		PUT DF_SPE_ACC_ID @;
		PUT LN_SEQ @;
		PUT LN_INC_SUB_EVT_SEQ @;
		PUT LD_INC_SUB_EFF_BEG @;
		PUT LD_INC_SUB_EFF_END @;
		PUT LC_INC_SUB_STA @;
		PUT LR_SUB_RMN @;
		PUT LF_LST_USR_FS14 @;
		PUT LF_LST_DTS_FS14 @;
		PUT LF_CRT_USR_FS14 @;
		PUT LD_CRT_FS14 @;
		PUT LC_STA_FS14 @;
		PUT LD_STA_FS14 ;
	END;
	IF EOF THEN PUT "-End-";
RUN;
