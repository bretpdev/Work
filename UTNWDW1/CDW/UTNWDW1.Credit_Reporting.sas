/*TEST*/
/*%LET TESTMSG = - THIS IS A TEST;
%LET RPTLIB = T:\SAS;
%LET LOGLIB = Y:\Batch\Logs;
%LET CODELIB = Y:\Codebase\SAS\CDW;
%LET ODBCFILE = BSYS_TEST;
%LET DB = CDW_test;
%LET ODBCFILE_CSYS = CSYSTest;*/

/*LIVE*/
%LET TESTMSG = - THIS IS LIVE;
%LET RPTLIB = Z:\Batch\FTP;
%LET LOGLIB = Z:\Batch\Logs;
%LET CODELIB = Z:\Codebase\SAS\CDW;
%LET ODBCFILE = BSYS;
%LET DB = CDW;
%LET ODBCFILE_CSYS = CSYS;

%INCLUDE "&CODELIB\UTNWDW1 CDW DAILY UPDATE.FOLDER AND DATABASE.SAS";
%FILECHECK(30);

DATA LN56 (drop=trunc);
	INFILE REPORT30 DSD DLM = ',' FIRSTOBS=1 MISSOVER end = eof;
	INPUT DF_SPE_ACC_ID :$10. LN_SEQ :6. LC_RPT_STA_CRB :$2. LD_RPT_CRB :$10. DT_ADJ :$10. ;
	RPT_STA_CRB = PUT(LC_RPT_STA_CRB,$STACRB.);
%TRUNCAT(30);
RUN;
%COPYERROR;
PROC SORT DATA=LN56 ; BY DF_SPE_ACC_ID LN_SEQ LD_RPT_CRB; RUN;
DATA LN56; SET LN56; BY DF_SPE_ACC_ID LN_SEQ LD_RPT_CRB; IF LAST.LD_RPT_CRB; RUN;

%ENCHILADA(LN56,LN56_CREDITREPORT,DF_SPE_ACC_ID LN_SEQ LD_RPT_CRB,LC_RPT_STA_CRB DT_ADJ RPT_STA_CRB,);

%GOODBYE_NULL(LN56_CREDITREPORT,LC_RPT_STA_CRB,'');
%GOODBYE_NULL(LN56_CREDITREPORT,DT_ADJ,'');
%GOODBYE_NULL(LN56_CREDITREPORT,RPT_STA_CRB,'');

PROC SQL NOPRINT;
CONNECT TO ODBC AS DB (REQUIRED="FILEDSN=X:\PADR\ODBC\&DB..dsn; update_lock_typ=nolock; bl_keepnulls=no");
SELECT COUNT(*) 
FROM CONNECTION TO DB (
      DELETE 
      FROM LN56_CREDITREPORT
	  WHERE CAST(LD_RPT_CRB AS DATETIME) <  DATEADD(YEAR, - 1, GETDATE())
      );
QUIT;

%FINISH(SOURCE=Credit_Reporting);
