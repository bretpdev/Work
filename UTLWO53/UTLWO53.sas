*---------------------------------------------*
| UTLWO53 FOREIGN SCHOOLS SINGLE DISBURSEMENT |
*---------------------------------------------*;
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWO53.LWO53R2";
FILENAME REPORTZ "&RPTLIB/ULWO53.LWO53RZ";
DATA _NULL_;
     CALL SYMPUT('DVAR',"'"||PUT(INTNX('YEAR',TODAY(),-1,'S'), MMDDYYD10.)||"'");
	 CALL SYMPUT('RUNDT',PUT(INTNX('DAY',TODAY(),0,'BEGINNING'), MMDDYYD10.));
RUN;
%SYSLPUT DVAR = &DVAR;
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE FSSD AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.IF_IST
	,A.IM_IST_FUL
FROM OLWHRM1.SC01_LGS_SCL_INF A
WHERE A.IC_SCL_PRI_LOC IN ('FC','')
AND A.IC_EXM_MLT_DSB = 'Y'
AND NOT EXISTS (	
	SELECT *
	FROM OLWHRM1.AY05_IST_ATY X
	WHERE X.IF_IST = A.IF_IST
	AND X.PF_ACT = 'GFSRV'
	AND X.ID_ATY_PRF >= &DVAR
	)
ORDER BY IF_IST
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWO53.LWO53RZ);*/
/*QUIT;*/
ENDRSUBMIT;
DATA FSSD;
SET WORKLOCL.FSSD;
RUN;

PROC PRINTTO PRINT=REPORT2 NEW;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 NODATE PAGNO=1 CENTER;
TITLE 'FOREIGN SCHOOLS WITH SINGLE DISBURSEMENT';
TITLE2	"&RUNDT";
FOOTNOTE 'JOB = UTLWO53  	 REPORT = ULWO53.LWO53R2';
PROC CONTENTS DATA=FSSD OUT=EMPTYSET NOPRINT;
DATA _NULL_;
SET EMPTYSET;
FILE PRINT;
IF  NOBS=0 AND _N_ =1 THEN DO;
	PUT // 126*'-';
	PUT      ////
		@51 '**** NO OBSERVATIONS FOUND ****';
	PUT ////
		@57 '-- END OF REPORT --';
	PUT ////////////
		@46 "JOB = UTLWO53  	 REPORT = ULWO53.LWO53R2";
	END;
RETURN;
RUN;
PROC PRINT NOOBS SPLIT='/' DATA=FSSD WIDTH=UNIFORM WIDTH=MIN;
VAR IF_IST IM_IST_FUL;
LABEL IF_IST = 'SCHOOL CODE' IM_IST_FUL = 'SCHOOL NAME';
RUN;
PROC PRINTTO;
RUN;
