/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORTZ "&RPTLIB/ULWK31.LWK31RZ";
FILENAME REPORT2 "&RPTLIB/ULWK31.LWK31R2";
FILENAME REPORT3 "&RPTLIB/ULWK31.LWK31R3";
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT; 
%MACRO SQLCHECK ;
  %IF  &SQLXRC NE 0  %THEN  %DO  ;
    DATA _NULL_  ;
            FILE REPORTZ NOTITLES  ;
            PUT @01 " ********************************************************************* "
              / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
              / @01 " ****  THE SAS SHOULD BE REVIEWED.                                **** "       
              / @01 " ********************************************************************* "
              / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
              / @01 " ****  &SQLXMSG   **** "
              / @01 " ********************************************************************* "
            ;
         RUN  ;
  %END  ;
%MEND  ;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE ONERFR AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.DF_PRS_ID_RFR
	,A.DF_PRS_ID_BR
	,CASE
		WHEN D.QUE_HAPPENED = '1' THEN '1'
		ELSE '0'
	END AS QUE_HAPPENED
	,D.QUE_CMT
		,E.DC_DOM_ST
FROM OLWHRM1.PD01_PDM_INF E
INNER JOIN OLWHRM1.BR03_BR_REF A
	ON E.DF_PRS_ID = A.DF_PRS_ID_BR
INNER JOIN OLWHRM1.LN10_LON F
	ON E.DF_PRS_ID = F.BF_SSN
INNER JOIN OLWHRM1.GA10_LON_APP B
	ON F.LF_LON_ALT = B.AF_APL_ID
	AND CHAR(F.LN_LON_ALT_SEQ) = SUBSTR(B.AF_APL_ID_SFX,2,1)
INNER JOIN OLWHRM1.GA14_LON_STA C
	ON B.AF_APL_ID = C.AF_APL_ID
	AND B.AF_APL_ID_SFX = C.AF_APL_ID_SFX 	
LEFT OUTER JOIN (SELECT D.DF_PRS_ID_BR
					,SUBSTR(D.DX_EVT_CMT_QUE,1,10) AS QUE_CMT
					,'1' AS QUE_HAPPENED
				FROM OLWHRM1.CT30_CALL_QUE D
				WHERE D.IF_WRK_GRP = 'KFRGNADD'
					AND SUBSTR(D.DX_EVT_CMT_QUE,1,3) = 'RF@'
) D
	ON F.BF_SSN = D.DF_PRS_ID_BR
	AND A.DF_PRS_ID_RFR = D.QUE_CMT	
WHERE B.AA_CUR_PRI > 0
	AND C.AC_LON_STA_TYP IN ('CP','CR','DA','FB','IA','ID','IG','IM','RF','RP','UA','UB')
	AND C.AC_STA_GA14 = 'A'
	AND A.BI_VLD_ADR = 'Y'
	AND E.DC_DOM_ST = 'FC'
	AND A.BM_RFR_FGN_CNY != ''
	AND A.BC_STA_BR03 = 'A'
	AND A.BC_HME_CNC_RSL <> '04'
	AND A.DF_PRS_ID_BR NOT IN  (SELECT Z.DF_PRS_ID
				FROM OLWHRM1.AY01_BR_ATY Z
				WHERE Z.PF_ACT = 'MFRGN'
					AND Z.BD_ATY_PRF >= E.DD_LST_UPD_ADR)
FOR READ ONLY WITH UR
);

CREATE TABLE COMRFR AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.BF_SSN
	,Z.KF01
	,C.BF_RFR
	,Z.WX_MSG_1_TSK
		,B.DM_FGN_ST
		,B.DM_FGN_CNY
		,Y.LD_ATY_REQ_RCV
		,B.DD_VER_ADR
FROM OLWHRM1.LN10_LON A
INNER JOIN OLWHRM1.RF10_RFR C
	ON A.BF_SSN = C.BF_SSN
INNER JOIN OLWHRM1.PD30_PRS_ADR B
	ON C.BF_RFR = B.DF_PRS_ID 
LEFT OUTER JOIN (SELECT Y.BF_SSN
				,Y.LN_ATY_SEQ
				,MAX(Y.LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
			FROM OLWHRM1.AY10_BR_LON_ATY Y
			WHERE Y.PF_REQ_ACT = 'MFRGN'
			GROUP BY Y.BF_SSN, Y.LN_ATY_SEQ
) Y
	ON A.BF_SSN = Y.BF_SSN
LEFT OUTER JOIN (SELECT Z.BF_SSN
				,Z.WX_MSG_1_TSK
				,'1' AS KF01
			FROM OLWHRM1.WQ20_TSK_QUE Z
			WHERE Z.WF_QUE = 'KF'
				AND Z.WF_SUB_QUE = '01'
) Z
	ON A.BF_SSN = Z.BF_SSN
WHERE A.LA_CUR_PRI > 0
	AND A.LC_STA_LON10 = 'R'
	AND C.BC_STA_REFR10 = 'A'
	AND B.DC_ADR = 'L'
	AND B.DI_VLD_ADR = 'Y'
	AND B.DC_DOM_ST = ''
	AND B.DM_FGN_CNY <> 'ZZZZ'
	AND (Y.LD_ATY_REQ_RCV IS NULL 
		OR Y.LD_ATY_REQ_RCV < B.DD_VER_ADR)
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;

/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>> ;  ** INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK;*/
/*QUIT;*/

ENDRSUBMIT;
DATA ONERFR;
	SET WORKLOCL.ONERFR;
RUN;
DATA COMRFR;
	SET WORKLOCL.COMRFR;
RUN;

PROC SORT DATA=COMRFR;
BY BF_SSN DESCENDING KF01;
RUN;
PROC SORT DATA=ONERFR;
BY DF_PRS_ID_BR DESCENDING QUE_HAPPENED;
RUN;

DATA ONERFR;
SET ONERFR;
BY DF_PRS_ID_BR DESCENDING QUE_HAPPENED;
IF FIRST.DF_PRS_ID_BR AND QUE_HAPPENED = '0' THEN OUTPUT;
RUN;
DATA COMRFR;
SET COMRFR;
BY BF_SSN DESCENDING KF01;
RETAIN A;
IF FIRST.BF_SSN AND KF01 = '1' THEN A=0;
IF INDEX(WX_MSG_1_TSK,TRIM(BF_RFR)) > 0 THEN A = 1;
IF LAST.BF_SSN AND A=0 THEN OUTPUT;
RUN;
DATA _NULL_;
SET ONERFR ;
LENGTH COMMENTS $600.;
QUEUE = 'KFRGNADD';
INST_ID = '';
INST_TYP = '';
DATE_DUE = '';
TIME_DUE = '';
COMMENTS = "<" || DF_PRS_ID_RFR || "> -'Review Foreign Address Demographics for Hygiene'";
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
DO;
   PUT DF_PRS_ID_BR $ @;
   PUT QUEUE @;
   PUT INST_ID @;
   PUT INST_TYP @;
   PUT DATE_DUE @;
   PUT TIME_DUE @;
   PUT COMMENTS $ ;
END;
RUN;
DATA _NULL_;
SET COMRFR ;
LENGTH COMMENTS $600.;
ARC='KFRGN';
FROM_DATE = '';
TO_DATE = '';
RECIPIENT_ID = '';
REG_TO_CODE = '';
REG_TO_ID = '';
LN_SEQ = 'ALL';
COMMENTS = "<" || BF_RFR || "> -'Review Foreign Address Demographics for Hygiene'";
FILE REPORT3 DELIMITER=',' DSD DROPOVER LRECL=32767;
DO;
   PUT BF_SSN $ @;
   PUT ARC @;
   PUT FROM_DATE @;
   PUT TO_DATE @;
   PUT RECIPIENT_ID @;
   PUT REG_TO_CODE @;
   PUT REG_TO_ID @;
   PUT LN_SEQ @;
   PUT COMMENTS $ ;
END;
RUN;
