/*	List loans where Aux Status = 10 and Aux Status Date is
	within previous month. */
/*  Report 4 contains information extending back to 8/14/2008.*/

/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWRH3.LWRH3R2";
FILENAME REPORT3 "&RPTLIB/ULWRH3.LWRH3R3";
FILENAME REPORT4 "&RPTLIB/ULWRH3.LWRH3R4";
/*Date variableS that displays the first and last of the previous month & month, year for title*/
DATA _NULL_;
RUNDT = INTNX('DAY',INTNX('MONTH',DATE(),0),-1);
	CALL SYMPUT('RUNDT',TRIM(LEFT(UPCASE(PUT(RUNDT,MONNAME.))))||' '||PUT(RUNDT,YEAR.));
     CALL SYMPUT('BEGIN',"'"||PUT(INTNX('MONTH',TODAY(),-1,'beginning'), MMDDYYD10.)||"'");
     CALL SYMPUT('END',"'"||PUT(INTNX('MONTH',TODAY(),-1,'end'), MMDDYYD10.)||"'");
RUN;
libname  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=work  ;
%SYSLPUT BEGIN = &BEGIN;
%SYSLPUT END = &END;
RSUBMIT;
OPTIONS NOCENTER NODATE NONUMBER LS=132;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE REHMO AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT	DISTINCT A.LC_PCL_REA			AS CLMTYP,
		INTEGER(A.BF_SSN)				AS SSN,
		RTRIM(D.DM_PRS_LST) 			AS NAME,
		A.AF_APL_ID||A.AF_APL_ID_SFX	AS CLUID,
		A.LF_CLM_ID 					AS CLMID,
		A.LA_CLM_INT + A.LA_PRI_AGY_CLC	AS CLMPDAMT,
		A.LD_LDR_POF 					AS CLMPDDT,
		A.LA_PAY_XPC 					AS PMTAMT,
		A.LA_MIN_PAY 					AS MINPAY,
		A.LD_AUX_STA_UPD 				AS PRV_MON,
		B.LA_TRX						AS RHAMT,
		B.BD_TRX_PST_HST				AS RHDT,
		D.DF_SPE_ACC_ID					AS ACCT_NUM,
		A.LF_CUR_LON_SER_AGY			AS SRVCODE,		
		E.IM_IST_FUL					AS SRVCR
FROM  OLWHRM1.DC01_LON_CLM_INF A 
LEFT OUTER JOIN OLWHRM1.DC11_LON_FAT B
	ON A.AF_APL_ID = B.AF_APL_ID
	AND A.AF_APL_ID_SFX = B.AF_APL_ID_SFX
	AND A.LF_CRT_DTS_DC10 = B.LF_CRT_DTS_DC10
INNER JOIN OLWHRM1.GA10_LON_APP F
	ON A.AF_APL_ID = F.AF_APL_ID
	AND A.AF_APL_ID_SFX = F.AF_APL_ID_SFX
INNER JOIN OLWHRM1.PD01_PDM_INF D
	ON A.BF_SSN = D.DF_PRS_ID
INNER JOIN OLWHRM1.IN01_LGS_IDM_MST E
	ON A.LF_CUR_LON_SER_AGY = E.IF_IST
WHERE A.LC_AUX_STA = '10'
AND B.BD_TRX_PST_HST >= '8/14/2008'
AND B.LC_TRX_TYP = 'RH'
);
DISCONNECT FROM DB2;
ENDRSUBMIT  ;
DATA REHMO; 
	SET WORKLOCL.REHMO; 
	ATUT = (month(RHDT) - month(CLMPDDT)) + (year(RHDT) - year(CLMPDDT))*12;
RUN;
PROC SORT DATA=REHMO;
	BY SSN SRVCODE;
RUN;
PROC SORT DATA=REHMO;
*IF ANY BORROWER HAS AN ACCOUNT WITH A DIFFERENT NUMBER DON'T INCLUDE IN R2 PUT IN R3;
* FOR R3 USE SRVCR FOR NOT 700126 ;

DATA R2 R3 (KEEP=SSN); 
SET REHMO;
BY SSN SRVCODE; 
IF INTNX('MONTH',DATE(),-1) <= PRV_MON <= (INTNX('MONTH',DATE(),0)-1) THEN DO;
	IF FIRST.SSN THEN DO;
		R3 = 0;
		IF SRVCODE ^= '700126' THEN DO;
			OUTPUT R3;
			R3 = 1;
			RETAIN R3;
		END;
	END;
	IF FIRST.SSN = 0 AND R3 = 0 THEN DO;
		IF SRVCODE ^= '700126' THEN DO;
			OUTPUT R3;
			R3 = 1;
			RETAIN R3;
		END;
	END;
	IF LAST.SSN AND R3 = 0 THEN DO;
			OUTPUT R2;
	END; 
END;
RUN;
%MACRO REPORT(REP);
PROC SQL;
CREATE TABLE REHMO&REP AS
SELECT *
FROM REHMO
WHERE SSN IN (SELECT SSN
				FROM R&REP)
	AND PRV_MON BETWEEN INTNX('MONTH',DATE(),-1) AND (INTNX('MONTH',DATE(),0)-1);
QUIT;
%MEND;
%REPORT(2);
%REPORT(3);


PROC SORT DATA=REHMO2;
	BY ACCT_NUM;
RUN;
PROC PRINTTO PRINT=REPORT2 NEW;
RUN;

OPTIONS NOCENTER NODATE NUMBER PAGENO=1 LS=132;

PROC REPORT DATA=REHMO2 NOWD SPACING=1 HEADSKIP;
TITLE "Monthly Rehab Report - UHEAA";
FOOTNOTE  "JOB = UTLWRH3     REPORT = ULWRH3.LWRH3R2";
COLUMN CLMTYP ACCT_NUM NAME CLUID CLMID CLMPDAMT CLMPDDT PMTAMT 
MINPAY ATUT RHAMT RHDT;
DEFINE CLMTYP / DISPLAY "Claim Type" WIDTH=5; 
DEFINE ACCT_NUM / ORDER ;
DEFINE NAME / ORDER WIDTH=12 "Name";
DEFINE CLUID / DISPLAY "Unique ID";
DEFINE CLMID / DISPLAY "Claim ID" WIDTH=5;
DEFINE CLMPDAMT / ANALYSIS SUM FORMAT=COMMA12.2 "Claim Paid Amount";
DEFINE CLMPDDT / DISPLAY FORMAT=MMDDYY8. "Claim Paid Date";
DEFINE PMTAMT / ANALYSIS SUM FORMAT=COMMA7.2 "Payment Amount";
DEFINE MINPAY / ANALYSIS MEAN FORMAT=COMMA8.2 "Reduced Payment Amount";
DEFINE ATUT / ANALYSIS MEAN FORMAT=3. "Months at UHEAA" WIDTH=6;
DEFINE RHAMT / ANALYSIS SUM FORMAT=COMMA12.2 "Rehab Amount";
DEFINE RHDT / DISPLAY FORMAT=MMDDYY8. "Rehab Date";
RUN;
PROC SORT DATA=REHMO3;
	BY SRVCR ACCT_NUM;
RUN;
PROC PRINTTO PRINT=REPORT3 NEW;
RUN;

OPTIONS NOCENTER NODATE NUMBER PAGENO=1 LS=174;
TITLE ;
PROC REPORT DATA=REHMO3 NOWD SPACING=1 HEADSKIP;
BY SRVCR;
FOOTNOTE  "JOB = UTLWRH3     REPORT = ULWRH3.LWRH3R3";
COLUMN CLMTYP ACCT_NUM NAME CLUID CLMID CLMPDAMT CLMPDDT PMTAMT 
MINPAY ATUT RHAMT RHDT SRVCR SRVCODE;
DEFINE CLMTYP / DISPLAY "Claim Type" WIDTH=5; 
DEFINE CLUID / DISPLAY "Unique ID";
DEFINE CLMID / DISPLAY "Claim ID" WIDTH=5;
DEFINE CLMPDAMT / ANALYSIS SUM FORMAT=COMMA12.2 "Claim Paid Amount";
DEFINE CLMPDDT / DISPLAY FORMAT=MMDDYY8. "Claim Paid Date";
DEFINE PMTAMT / ANALYSIS SUM FORMAT=COMMA7.2 "Payment Amount";
DEFINE MINPAY / ANALYSIS MEAN FORMAT=COMMA8.2 "Reduced Payment Amount";
DEFINE ATUT / ANALYSIS MEAN FORMAT=3. "Months at UHEAA" WIDTH=6;
DEFINE RHAMT / ANALYSIS SUM FORMAT=COMMA12.2 "Rehab Amount";
DEFINE RHDT / DISPLAY FORMAT=MMDDYY8. "Rehab Date";
DEFINE SRVCR / ORDER NOPRINT ;
DEFINE SRVCODE / NOPRINT ;
DEFINE ACCT_NUM / ORDER ;
DEFINE NAME / ORDER WIDTH=12 "Name";
COMPUTE BEFORE _PAGE_ / LEFT;
      LINE 'Monthly Rehab Report - ' SRVCR $ 'Servicer Code - ' SRVCODE $;
ENDCOMP;
RUN;
RUN;
PROC SORT DATA=REHMO;
	BY SRVCR ACCT_NUM;
RUN;
PROC PRINTTO PRINT=REPORT4 NEW;
RUN;

OPTIONS NOCENTER NODATE NUMBER PAGENO=1 LS=174;

PROC REPORT DATA=REHMO NOWD SPACING=1 HEADSKIP;
BY SRVCR;
TITLE "Rehabs Since 8/14/2008"
FOOTNOTE  "JOB = UTLWRH3     REPORT = ULWRH3.LWRH3R4";
COLUMN CLMTYP ACCT_NUM NAME CLUID CLMID CLMPDAMT CLMPDDT PMTAMT 
MINPAY ATUT RHAMT RHDT SRVCR SRVCODE;
DEFINE CLMTYP / DISPLAY "Claim Type" WIDTH=5; 
DEFINE ACCT_NUM / ORDER ;
DEFINE NAME / ORDER WIDTH=12 "Name";
DEFINE CLUID / DISPLAY "Unique ID";
DEFINE CLMID / DISPLAY "Claim ID" WIDTH=5;
DEFINE CLMPDAMT / ANALYSIS SUM FORMAT=COMMA12.2 "Claim Paid Amount";
DEFINE CLMPDDT / DISPLAY FORMAT=MMDDYY8. "Claim Paid Date";
DEFINE PMTAMT / ANALYSIS SUM FORMAT=COMMA7.2 "Payment Amount";
DEFINE MINPAY / ANALYSIS MEAN FORMAT=COMMA8.2 "Reduced Payment Amount";
DEFINE ATUT / ANALYSIS MEAN FORMAT=3. "Months at UHEAA" WIDTH=6;
DEFINE RHAMT / ANALYSIS SUM FORMAT=COMMA12.2 "Rehab Amount";
DEFINE RHDT / DISPLAY FORMAT=MMDDYY8. "Rehab Date";
DEFINE SRVCR / ORDER NOPRINT ;
DEFINE SRVCODE / NOPRINT ;
COMPUTE BEFORE _PAGE_ / LEFT;
      LINE 'Monthly Rehab Report - ' SRVCR $ 'Servicer Code - ' SRVCODE $;
ENDCOMP;

RUN;

PROC PRINTTO;
RUN;
