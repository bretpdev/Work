DECLARE @PREVIOUSDAY DATE = CAST(CentralData.dbo.AddBusinessDays(GETDATE(), -1) AS DATE)
DECLARE @TODAY DATETIME = GETDATE()
DECLARE @XDEMOG VARCHAR(8) = 'XDEMOG'
DECLARE @XDEMOE VARCHAR(8) = 'XDEMOE'
DECLARE @FRGNDEMO VARCHAR(8) = 'FRGNDEMO'
DECLARE @SOURCEFILE VARCHAR(25) = 'UTLWMD2'

MERGE
	OLS.olqtskbldr.Queues ExistingData
USING
(
	--Pulls Address Updates
	SELECT DISTINCT
		PD30.DF_PRS_ID AS TargetId,
		CASE WHEN ISNULL(PD30.DM_FGN_CNY, '') = '' THEN @XDEMOG
			 ELSE @FRGNDEMO
		END AS QueueName,
		RTRIM(PD30.DX_STR_ADR_1) + ',' + RTRIM(PD30.DX_STR_ADR_2) + ',' + RTRIM(PD30.DM_CT) + ',' + RTRIM(PD30.DC_DOM_ST) + ',' + RTRIM(PD30.DF_ZIP_CDE) + ',' + RTRIM(PD30.DM_FGN_CNY) + ',,,,' + PD30.DI_VLD_ADR AS Comment,
		PD30.DD_STA_PDEM30 AS CreatedAt
	FROM
		UDW..PD30_PRS_ADR PD30
		INNER JOIN
		(
			SELECT
				DF_PRS_ID,
				MAX(DN_ADR_SEQ) AS DN_ADR_SEQ
			FROM
				UDW..PD31_PRS_INA
			GROUP BY
				DF_PRS_ID
		) PD31_MAX
			ON PD31_MAX.DF_PRS_ID = PD30.DF_PRS_ID
		INNER JOIN UDW..PD31_PRS_INA PD31
			ON PD31.DF_PRS_ID = PD31_MAX.DF_PRS_ID
			AND PD31.DN_ADR_SEQ = PD31_MAX.DN_ADR_SEQ
		INNER JOIN ODW..PD04_ADR_PHN_HST PD04
			ON PD04.DF_PRS_ID = PD30.DF_PRS_ID
		INNER JOIN UDW..LN10_LON LN10
			ON LN10.BF_SSN = PD30.DF_PRS_ID
			AND LN10.LC_STA_LON10 = 'R'
			AND	LN10.LF_LON_CUR_OWN IN ('811698','813285','813760UT','813894','813915','817440','817455','817545','817546','817575','819628','820043','820200','822373','822717','826717','828476','82847601','829123','829158','829505','829769','82976901','82976902','82976903','82976904','82976905','82976906','82976907','82976908','830132','830146','830248','830791','831474','832241','833403','833577','833828','834122','834265','834396','834437','834493','83449301','834529','888885','900749','971357','999775')
		LEFT JOIN ODW..CT30_CALL_QUE CT30
			ON CT30.DF_PRS_ID_BR = PD30.DF_PRS_ID
			AND CT30.IF_WRK_GRP =
				CASE WHEN ISNULL(PD30.DM_FGN_CNY, '') = '' THEN @XDEMOG
					 ELSE @FRGNDEMO
				END
			AND CT30.IC_TSK_STA IN ('A','W')
		LEFT JOIN OLS.olqtskbldr.Queues Q
			ON Q.TargetId = PD30.DF_PRS_ID
			AND Q.QueueName =
				CASE WHEN ISNULL(PD30.DM_FGN_CNY, '') = '' THEN @XDEMOG
					 ELSE @FRGNDEMO
				END
			AND Q.ProcessedAt IS NULL
			AND Q.DeletedAt IS NULL
			AND Q.Comment = RTRIM(PD30.DX_STR_ADR_1) + ',' + RTRIM(PD30.DX_STR_ADR_2) + ',' + RTRIM(PD30.DM_CT) + ',' + RTRIM(PD30.DC_DOM_ST) + ',' + RTRIM(PD30.DF_ZIP_CDE) + ',' + RTRIM(PD30.DM_FGN_CNY) + ',,,,' + PD30.DI_VLD_ADR
	WHERE
		SUBSTRING(PD30.DF_PRS_ID, 1, 1) != 'P'
		AND	PD31.DD_CRT_PD31 = PD30.DD_STA_PDEM30
		AND CAST(PD30.DF_LST_DTS_PD30 AS DATE) >= @PREVIOUSDAY
		AND CAST(PD30.DD_STA_PDEM30 AS DATE) >= @PREVIOUSDAY
		AND CT30.DF_PRS_ID_BR IS NULL --Make sure there is not an open task in the table
		AND Q.TargetId IS NULL --Make sure there is not an open task in the table
		AND (RTRIM(PD30.DX_STR_ADR_1) + ',' + RTRIM(PD30.DX_STR_ADR_2) + ',' + RTRIM(PD30.DM_CT) + ',' + RTRIM(PD30.DC_DOM_ST) + ',' + RTRIM(PD30.DF_ZIP_CDE) + ',' + RTRIM(PD30.DM_FGN_CNY)) != ',,,,,'

	UNION

	--Pulls Home phone updates
	SELECT DISTINCT
		PD42.DF_PRS_ID AS TargetId,
		CASE WHEN ISNULL(RTRIM(PD42.DN_FGN_PHN_INL) + RTRIM(PD42.DN_FGN_PHN_CNY) + RTRIM(PD42.DN_FGN_PHN_CT) + RTRIM(PD42.DN_FGN_PHN_LCL), '') = '' THEN @XDEMOG
			 ELSE @FRGNDEMO
		END AS QueueName,
		CASE WHEN PD42.DC_PHN = 'H' THEN ',,,,,,' + RTRIM(PD42.DN_DOM_PHN_ARA) + RTRIM(PD42.DN_DOM_PHN_XCH) + RTRIM(PD42.DN_DOM_PHN_LCL) + RTRIM(PD42.DN_PHN_XTN) + ',,,' + PD42.DI_PHN_VLD + ',' + PD42.DC_ALW_ADL_PHN
			 WHEN PD42.DC_PHN = 'A' THEN ',,,,,,,' + RTRIM(PD42.DN_DOM_PHN_ARA) + RTRIM(PD42.DN_DOM_PHN_XCH) + RTRIM(PD42.DN_DOM_PHN_LCL) + RTRIM(PD42.DN_PHN_XTN) + ',,' + PD42.DI_PHN_VLD + ',' + PD42.DC_ALW_ADL_PHN
		END AS Comment,
		PD42.DD_CRT_PD42 AS CreatedAt
	FROM
		UDW..PD42_PRS_PHN PD42
		INNER JOIN
		(
			SELECT
				DF_PRS_ID,
				MAX(DN_PHN_SEQ) AS DN_PHN_SEQ
			FROM
				UDW..PD41_PHN_HST
			GROUP BY
				DF_PRS_ID
		) PD42_MAX
			ON PD42_MAX.DF_PRS_ID = PD42.DF_PRS_ID
		INNER JOIN UDW..PD41_PHN_HST PD41
			ON PD41.DF_PRS_ID = PD42_MAX.DF_PRS_ID
			AND PD41.DN_PHN_SEQ = PD42_MAX.DN_PHN_SEQ
		LEFT OUTER JOIN UDW..AY10_BR_LON_ATY AY10
			ON AY10.BF_SSN = PD42_MAX.DF_PRS_ID
			AND AY10.PF_REQ_ACT IN ('TCPAB','APRLB')
			AND CAST(AY10.LD_ATY_REQ_RCV AS DATE) > @PREVIOUSDAY
			AND AY10.LC_STA_ACTY10 = 'A'
		INNER JOIN ODW..PD04_ADR_PHN_HST PD04
			ON PD04.DF_PRS_ID = PD42.DF_PRS_ID
		INNER JOIN UDW..LN10_LON LN10
			ON LN10.BF_SSN = PD42.DF_PRS_ID
			AND LN10.LC_STA_LON10 = 'R'
			AND	LN10.LF_LON_CUR_OWN IN ('811698','813285','813760UT','813894','813915','817440','817455','817545','817546','817575','819628','820043','820200','822373','822717','826717','828476','82847601','829123','829158','829505','829769','82976901','82976902','82976903','82976904','82976905','82976906','82976907','82976908','830132','830146','830248','830791','831474','832241','833403','833577','833828','834122','834265','834396','834437','834493','83449301','834529','888885','900749','971357','999775')
		LEFT JOIN ODW..CT30_CALL_QUE CT30
			ON CT30.DF_PRS_ID_BR = PD42.DF_PRS_ID
			AND CT30.IF_WRK_GRP = 
				CASE WHEN ISNULL(RTRIM(PD42.DN_FGN_PHN_INL) + RTRIM(PD42.DN_FGN_PHN_CNY) + RTRIM(PD42.DN_FGN_PHN_CT) + RTRIM(PD42.DN_FGN_PHN_LCL), '') = '' THEN @XDEMOG
					 ELSE @FRGNDEMO
				END
			AND CT30.IC_TSK_STA IN ('A','W')
		LEFT JOIN OLS.olqtskbldr.Queues Q
				ON Q.TargetId = PD42.DF_PRS_ID
				AND Q.QueueName = 
					CASE WHEN ISNULL(RTRIM(PD42.DN_FGN_PHN_INL) + RTRIM(PD42.DN_FGN_PHN_CNY) + RTRIM(PD42.DN_FGN_PHN_CT) + RTRIM(PD42.DN_FGN_PHN_LCL), '') = '' THEN @XDEMOG
						 ELSE @FRGNDEMO
					END
				AND Q.ProcessedAt IS NULL
				AND Q.DeletedAt IS NULL
				AND Q.Comment = 
					CASE WHEN PD42.DC_PHN = 'H' THEN ',,,,,,' + RTRIM(PD42.DN_DOM_PHN_ARA) + RTRIM(PD42.DN_DOM_PHN_XCH) + RTRIM(PD42.DN_DOM_PHN_LCL) + RTRIM(PD42.DN_PHN_XTN) + ',,,' + PD42.DI_PHN_VLD + ',' + PD42.DC_ALW_ADL_PHN
						 WHEN PD42.DC_PHN = 'A' THEN ',,,,,,,' + RTRIM(PD42.DN_DOM_PHN_ARA) + RTRIM(PD42.DN_DOM_PHN_XCH) + RTRIM(PD42.DN_DOM_PHN_LCL) + RTRIM(PD42.DN_PHN_XTN) + ',,' + PD42.DI_PHN_VLD + ',' + PD42.DC_ALW_ADL_PHN
					END
	WHERE
		PD42.DC_PHN IN ('H','A')
		AND SUBSTRING(PD42.DF_PRS_ID,1,1) != 'P'
		AND PD41.DD_CRT_41 = PD42.DD_CRT_PD42
		AND AY10.BF_SSN IS NULL
		AND CAST(PD42.DF_LST_DTS_PD42 AS DATE) >= @PREVIOUSDAY
		AND CAST(PD42.DD_CRT_PD42 AS DATE) >= @PREVIOUSDAY
		AND CT30.DF_PRS_ID_BR IS NULL --Make sure there is not an open task in the table
		AND Q.TargetId IS NULL --Make sure there is not an open task in the table
		AND RTRIM(PD42.DN_DOM_PHN_ARA) + RTRIM(PD42.DN_DOM_PHN_XCH) + RTRIM(PD42.DN_DOM_PHN_LCL) + RTRIM(PD42.DN_PHN_XTN) != ''

	UNION

	--Pulls Email updates
	SELECT DISTINCT
		PD32.DF_PRS_ID AS TargetId,
		@XDEMOE AS QueueName,
		',,,,,,,,' + PD32.DX_ADR_EML + ',' + PD32.DI_VLD_ADR_EML AS Comment,
		PD32.DF_LST_DTS_PD32 AS CreatedAt
	FROM
		UDW..PD32_PRS_ADR_EML PD32
		INNER JOIN ODW..PD04_ADR_PHN_HST PD04
			ON PD04.DF_PRS_ID = PD32.DF_PRS_ID
		INNER JOIN UDW..LN10_LON LN10
			ON LN10.BF_SSN = PD32.DF_PRS_ID
			AND LN10.LC_STA_LON10 = 'R'
			AND	LN10.LF_LON_CUR_OWN IN ('811698','813285','813760UT','813894','813915','817440','817455','817545','817546','817575','819628','820043','820200','822373','822717','826717','828476','82847601','829123','829158','829505','829769','82976901','82976902','82976903','82976904','82976905','82976906','82976907','82976908','830132','830146','830248','830791','831474','832241','833403','833577','833828','834122','834265','834396','834437','834493','83449301','834529','888885','900749','971357','999775')
		LEFT JOIN ODW..CT30_CALL_QUE CT30
			ON CT30.DF_PRS_ID_BR = PD32.DF_PRS_ID
			AND CT30.IF_WRK_GRP = @XDEMOE
			AND CT30.IC_TSK_STA IN ('A','W')
	LEFT JOIN OLS.olqtskbldr.Queues Q
			ON Q.TargetId = PD32.DF_PRS_ID
			AND Q.QueueName = @XDEMOE
			AND Q.ProcessedAt IS NULL
			AND Q.DeletedAt IS NULL
			AND Q.Comment = ',,,,,,,,' + PD32.DX_ADR_EML + ',' + PD32.DI_VLD_ADR_EML
	WHERE
		SUBSTRING(PD32.DF_PRS_ID,1,1) != 'P'
		AND CAST(PD32.DF_LST_DTS_PD32 AS DATE) >= @PREVIOUSDAY
		AND CT30.DF_PRS_ID_BR IS NULL --Make sure there is not an open task in the table
		AND Q.TargetId IS NULL --Make sure there is not an open task in the table
		AND RTRIM(PD32.DX_ADR_EML) != ''
) NewData
	ON NewData.TargetId = ExistingData.TargetId
	AND NewData.QueueName = ExistingData.QueueName
	AND ExistingData.DeletedAt IS NULL
	AND ExistingData.ProcessedAt IS NULL
	AND NewData.Comment = ExistingData.Comment
WHEN NOT MATCHED THEN
	INSERT
	(
		TargetId,
		QueueName,
		InstitutionId,
		InstitutionType,
		DateDue,
		TimeDue,
		Comment,
		SourceFileName,
		AddedAt,
		AddedBy
	)
	VALUES
	(
		NewData.TargetId,
		NewData.QueueName,
		NULL, --InstitutionId
		NULL, --InstitutionType
		NULL, --DateDue
		NULL, --TimeDue
		NewData.Comment,
		@SOURCEFILE,
		@TODAY,
		USER_NAME()
	);