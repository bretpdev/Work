CREATE PROCEDURE [dbo].[LT_TS13SKPREF_FormFields]
	@AccountNumber CHAR(10),
	@IsCoborrower BIT = 0
AS
BEGIN

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE	@LetterId VARCHAR(10) = 'TS13SKPREF'
DECLARE @PF_REQ_ACT VARCHAR(5) = (SELECT AC11.PF_REQ_ACT FROM AC11_ACT_REQ_LTR AC11 WHERE PF_LTR = @LetterId)

	BEGIN
		SELECT DISTINCT
			RTRIM(PD10Ref.DM_PRS_1) + ' ' + RTRIM(PD10Ref.DM_PRS_LST) AS RefName,
			RTRIM(PD10Borr.DM_PRS_1) + ' ' + RTRIM(PD10Borr.DM_PRS_LST) AS BorrowerName
		FROM 
			PD10_PRS_NME PD10Borr
			INNER JOIN LN10_LON LN10
				ON LN10.BF_SSN = PD10Borr.DF_PRS_ID
				AND LN10.LC_STA_LON10 = 'R'
				AND LN10.LA_CUR_PRI > 0
			INNER JOIN
			(
				SELECT
					LN85.BF_SSN,
					LN85.LN_SEQ
				FROM
					LN85_LON_ATY LN85
					INNER JOIN --GETS THE MOST RECENT ARC LEFT ON THE BORROWERS ACCOUNT TO GET THE LOAN SEQ'S THE LETTER APPLIES TO
					(
						SELECT
							AY10.BF_SSN,
							MAX(AY10.LN_ATY_SEQ) AS LN_ATY_SEQ,
							MAX(AY10.LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
						FROM 
							AY10_BR_LON_ATY AY10
							INNER JOIN PD10_PRS_NME PD10
								ON PD10.DF_PRS_ID = AY10.BF_SSN
							INNER JOIN RF10_RFR RF10
								ON RF10.BF_SSN = AY10.BF_SSN
								AND RF10.BC_STA_REFR10 = 'A'
						WHERE
							AY10.PF_REQ_ACT = @PF_REQ_ACT
							AND RF10.BF_RFR = @AccountNumber
						GROUP BY
							AY10.BF_SSN
					)AY10
						ON AY10.BF_SSN = LN85.BF_SSN
						AND AY10.LN_ATY_SEQ = LN85.LN_ATY_SEQ
			)LN85
				ON LN85.BF_SSN = LN10.BF_SSN
				AND LN85.LN_SEQ = LN10.LN_SEQ
			INNER JOIN RF10_RFR RF10
				ON RF10.BF_SSN = LN85.BF_SSN
				AND RF10.BC_STA_REFR10 = 'A'
			INNER JOIN PD10_PRS_NME PD10Ref
				ON PD10Ref.DF_PRS_ID = RF10.BF_RFR
			INNER JOIN LT20_LTR_REQ_PRC LT20
				ON LT20.DF_SPE_ACC_ID = PD10Borr.DF_SPE_ACC_ID
				AND
				(
					(
						LT20.PrintedAt IS NULL 
						AND LT20.OnEcorr = 0
					) 
					OR LT20.EcorrDocumentCreatedAt IS NULL
				)
				AND LT20.InactivatedAt IS NULL
				AND LT20.RI_LTR_REQ_DEL_PRC = 'N'
			INNER JOIN AY10_BR_LON_ATY AY10
				ON AY10.BF_SSN = LT20.RF_SBJ_PRC
				AND AY10.LN_ATY_SEQ = LT20.RN_ATY_SEQ_PRC
				AND AY10.LF_ATY_RCP = RF10.BF_RFR			
		WHERE
			RF10.BF_RFR = @AccountNumber
	END
END
