/*UTLWO21 BORROWER DOES NOT MEET MONTLY MINIMUM PAYMENT REQUIREMENT*/

/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;
%LET RPTLIB = %SYSGET(reportdir);
FILENAME REPORT2 "&RPTLIB/ULWO21.LWO21R2";*/

LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
PROC SQL STIMER;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE DEMO AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT A.BF_SSN
	,A.LN_SEQ
	,B.LN_RPS_SEQ
	,C.LN_GRD_RPS_SEQ
	,CASE 
		WHEN D.DM_PRS_MID IS NULL 
		THEN RTRIM(D.DM_PRS_LST)||' '||RTRIM(D.DM_PRS_1)
		WHEN D.DM_PRS_MID IS NOT NULL 
		THEN RTRIM(D.DM_PRS_LST)||' '||RTRIM(D.DM_PRS_1)||' '||RTRIM(D.DM_PRS_MID)
	END AS NAME
	,C.LN_RPS_TRM
	,A.LA_CUR_PRI
	,C.LA_RPS_ISL
	,E.LD_RPS_1_PAY_DU
	,B.LN_RPS_SEQ
FROM OLWHRM1.LN10_LON A
INNER JOIN OLWHRM1.LN65_LON_RPS B
	ON A.LN_SEQ = B.LN_SEQ
	AND A.BF_SSN = B.BF_SSN
INNER JOIN OLWHRM1.LN66_LON_RPS_SPF C
	ON B.LN_SEQ = C.LN_SEQ
	AND B.LN_RPS_SEQ = C.LN_RPS_SEQ
	AND B.BF_SSN = C.BF_SSN
INNER JOIN OLWHRM1.RS10_BR_RPD E
	ON B.BF_SSN = E.BF_SSN
	AND B.LN_RPS_SEQ = E.LN_RPS_SEQ
INNER JOIN OLWHRM1.PD10_PRS_NME D
	ON A.BF_SSN = D.DF_PRS_ID
WHERE A.LC_STA_LON10 = 'R'
AND A.LA_CUR_PRI > 0
AND E.LC_STA_RPST10 = 'A'
AND C.LN_RPS_TRM > 1
/*AND B.LN_RPS_SEQ = 1*/
);
DISCONNECT FROM DB2;
ENDRSUBMIT;

DATA DEMO;SET WORKLOCL.DEMO;RUN;

PROC SORT DATA=DEMO NODUPKEY;
BY BF_SSN LN_SEQ LN_RPS_SEQ LN_GRD_RPS_SEQ;
RUN;

PROC SQL;
CREATE TABLE XEMO2 AS 
SELECT DISTINCT BF_SSN
	,SUM(LA_RPS_ISL) AS BPTOT
FROM DEMO
GROUP BY BF_SSN;
QUIT;
RUN;

DATA XEMO2;
SET XEMO2;
IF BPTOT =< 49 THEN OUTPUT XEMO2;
ELSE DELETE;
RUN;

PROC SORT DATA = XEMO2;
BY BF_SSN;
RUN;
PROC SORT DATA = DEMO;
BY BF_SSN;
RUN;

DATA DEMO (KEEP = BF_SSN NAME LN_SEQ LA_CUR_PRI LA_RPS_ISL);
MERGE XEMO2 (IN=A) DEMO (IN=B);
BY BF_SSN;
IF A AND B THEN OUTPUT DEMO;
ELSE DELETE;
RUN;

PROC SORT DATA = DEMO NODUPREC;
BY NAME;
RUN;

DATA _NULL_;
      CALL SYMPUT("RUNDT",LEFT(PUT("&SYSDATE"D,MMDDYY10.)));
RUN;
%MACRO FDATE(FMT);
   %GLOBAL FDATE;
   DATA _NULL_;
      CALL SYMPUT("FDATE",LEFT(PUT("&SYSDATE"D,&FMT)));
   RUN;
%MEND FDATE;
%FDATE(WORDDATE.);

/*PROC PRINTTO PRINT=REPORT2;
RUN;*/
OPTIONS CENTER NODATE NUMBER PAGENO=1 LS=132;
PROC REPORT DATA= DEMO HEADSKIP SPLIT='*' NOWD;
TITLE 'BORROWER DOES NOT MEET MINIMUM MONTHLY PAYMENT';
TITLE2 "RUN DATE: &FDATE";
FOOTNOTE 'JOB = UTLWO21     REPORT = ULWO21.LWO21R2';
COLUMN BF_SSN NAME LN_SEQ LA_CUR_PRI LA_RPS_ISL;
DEFINE BF_SSN / DISPLAY "SSN* " WIDTH=9;
DEFINE NAME /  "BORROWER*NAME" WIDTH=30;
DEFINE LN_SEQ /  "LOAN*SEQ" WIDTH=4;
DEFINE LA_CUR_PRI /  "CURRENT*PRINCIPAL" WIDTH=9;
DEFINE LA_RPS_ISL /  "MONTHLY*PAYMENT" WIDTH=8;
RUN;
