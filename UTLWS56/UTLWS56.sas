/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORTZ "&RPTLIB/ULWS56.LWS56RZ";
FILENAME REPORT2 "&RPTLIB/ULWS56.LWS56R2";
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
%MACRO SQLCHECK ;
  %IF  &SQLXRC NE 0  %THEN  %DO  ;
    DATA _NULL_  ;
            FILE REPORTZ NOTITLES  ;
            PUT @01 " ********************************************************************* "
              / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
              / @01 " ****  THE SAS SHOULD BE REVIEWED.                                **** "       
              / @01 " ********************************************************************* "
              / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
              / @01 " ****  &SQLXMSG   **** "
              / @01 " ********************************************************************* "
            ;
         RUN  ;
  %END  ;
%MEND  ;
LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;


%LET TBLLIB = /sas/whse/progrevw;

/*INPUT LOAN TYPES FOR PRIVATE AND FFEL LOANS*/
DATA LOAN_TYPES;
	FORMAT LN_TYP LN_PGM $50.;
	INFILE "&TBLLIB/GENR_REF_LoanTypes.txt" DLM=',' MISSOVER DSD;
	INFORMAT LN_TYP LN_PGM $50.;
	INPUT LN_TYP LN_PGM ;
	LN_PGM = UPCASE(LN_PGM);
RUN;
/*CREATE MACRO VARIALBE LISTS OF LOAN PROGRAMS(FFEL AND PRIVATE LOANS)*/
PROC SQL NOPRINT;
	SELECT "'"||TRIM(LN_TYP)||"'" 
		INTO :FFELP_LIST SEPARATED BY "," /*FFEL LOAN LIST*/
	FROM LOAN_TYPES
	WHERE LN_PGM = 'FFEL';
QUIT;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE DFFB AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT C.BF_SSN
	,C.LN_SEQ
FROM (SELECT LN60.BF_SSN
			,LN60.LN_SEQ 
	FROM OLWHRM1.LN60_BR_FOR_APV LN60
	INNER JOIN OLWHRM1.FB10_BR_FOR_REQ FB10
		ON LN60.BF_SSN = FB10.BF_SSN
		AND LN60.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM 
	WHERE LC_STA_LON60 = 'A'
		AND LC_FOR_STA = 'A'
		AND LC_STA_FOR10 = 'A'
		and lc_for_rsp != '003'

		AND CURRENT DATE BETWEEN LD_FOR_BEG AND LD_FOR_END
	UNION
		SELECT LN50.BF_SSN
			,LN50.LN_SEQ
	FROM OLWHRM1.LN50_BR_DFR_APV LN50
	INNER JOIN OLWHRM1.DF10_BR_DFR_REQ DF10
		ON LN50.BF_SSN = DF10.BF_SSN
		AND LN50.LF_DFR_CTL_NUM = DF10.LF_DFR_CTL_NUM
	WHERE LC_STA_LON50 = 'A'
		AND LC_DFR_STA = 'A'
		AND LC_STA_DFR10 = 'A'
		and lc_dfr_rsp != '003'
		AND CURRENT DATE BETWEEN LD_DFR_BEG AND LD_DFR_END) A
INNER JOIN OLWHRM1.LN10_LON C
	ON A.BF_SSN = C.BF_SSN
	AND A.LN_SEQ = C.LN_SEQ
INNER JOIN OLWHRM1.DW01_DW_CLC_CLU E
	ON C.BF_SSN = E.BF_SSN
	AND C.LN_SEQ = E.LN_SEQ
LEFT OUTER JOIN OLWHRM1.LN65_LON_RPS D
	ON C.BF_SSN = D.BF_SSN
	AND C.LN_SEQ = D.LN_SEQ
	AND D.LC_STA_LON65 = 'A'
left outer join OLWHRM1.AY10_BR_LON_ATY B
	ON A.BF_SSN = B.BF_SSN
	AND B.PF_REQ_ACT = 'ROSND'
WHERE B.BF_SSN IS NULL
	AND C.LA_CUR_PRI > 0 
	AND C.LC_STA_LON10 = 'R'
	and C.IC_LON_PGM IN (&FFELP_LIST)
	AND C.LD_LON_ACL_ADD <= C.LD_LON_1_DSB
	AND D.BF_SSN IS NULL
	and e.wc_dw_lon_sta not in ('02')

FOR READ ONLY WITH UR
);

DISCONNECT FROM DB2;


QUIT;



/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>> ;  ** INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK;*/
/*QUIT;*/

ENDRSUBMIT;
DATA DFFB;
	SET WORKLOCL.DFFB;
RUN;
proc sort data=dffb; by bf_ssn ln_seq; run;
DATA _NULL_;
SET DFFB ;
TARGET_ID = bf_ssn;
ARC = 'ROSND';
FROM_DATE = '';
TO_DATE = '';
NEEDED_BY_DATE = '';
RECIPIENT_ID = '';
REGARDS_TO_CODE = '';
REGARDS_TO_ID = '';
/*LOAN_SEQ = 'ALL';*/
COMMENTS = 'D/F was added before borrower has been initially disclosed to.  Please ensure disclosure statement is sent in timely manner.';
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
DO;
   PUT TARGET_ID @;
   PUT ARC @;
   PUT FROM_DATE @;
   PUT TO_DATE @;
   PUT NEEDED_BY_DATE @;
   PUT RECIPIENT_ID @;
   PUT REGARDS_TO_CODE @;
   PUT REGARDS_TO_ID @;
   PUT ln_seq @;
   PUT COMMENTS $;
END;
RUN;
