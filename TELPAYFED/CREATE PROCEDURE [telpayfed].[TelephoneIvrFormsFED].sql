USE [CentralData]
GO

/****** Object:  StoredProcedure [telpayfed].[TelephoneIvrFormsFED]    Script Date: 9/28/2020 10:15:28 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [telpayfed].[TelephoneIvrFormsFED]
	@BEGIN DATE,
	@END DATE
AS
SELECT
	SUM(ISNULL(AUTOPAY,0)) AS AUTOPAY,
	SUM(ISNULL(THRDPARTY,0)) AS THRDPARTY,
	SUM(ISNULL(IDR,0)) AS IDR,
	SUM(ISNULL(FORB,0)) AS FORB,
	SUM(ISNULL(DEFECON,0)) AS DEFECON,
	SUM(ISNULL(DEFUNEM,0)) AS DEFUNEM,
	SUM(ISNULL(DEFSCH,0)) AS DEFSCH,
	SUM(ISNULL(TTL_FRMS,0)) AS TTL_FRMS
FROM 
	(
		--legacy information from when IVR updated ULS..IvrRequestTracking, included for historical reporting
		SELECT
			SUM(CASE WHEN IVR.Request = 'DRNDP' THEN 1 ELSE 0 END) AS AUTOPAY,
			SUM(CASE WHEN IVR.Request IN ('PRTY3','RQ003') THEN 1 ELSE 0 END) AS THRDPARTY,
			SUM(CASE WHEN IVR.Request IN ('G7IBR','IBRCL') THEN 1 ELSE 0 END) AS IDR,
			SUM(CASE WHEN IVR.Request IN ('IVRM1','H742A','G709M') THEN 1 ELSE 0 END) AS FORB,
			SUM(CASE WHEN IVR.Request = 'G7077' THEN 1 ELSE 0 END) AS DEFECON,
			SUM(CASE WHEN IVR.Request = 'G708C' THEN 1 ELSE 0 END) AS DEFUNEM,
			SUM(CASE WHEN IVR.Request = 'ALSCH' THEN 1 ELSE 0 END) AS DEFSCH,
			SUM(CASE WHEN IVR.Request IN ('DRNDP','PRTY3','G7IBR','IBRCL','IVRM1','H742A','G709M','G7077','G708C','ALSCH') THEN 1 ELSE 0 END) AS TTL_FRMS
		FROM
			CLS..IvrRequestTracking IVR
		WHERE
			CONVERT(DATE, IVR.ProcessedDate) BETWEEN @BEGIN AND @END

		UNION ALL

		--current data (IVR now updates AAP directly rather than have a script copy data to AAP from ULS..IvrRequestTracking)
		SELECT
			SUM(CASE WHEN AAP.ARC = 'DRNDP' THEN 1 ELSE 0 END) AS AUTOPAY,
			SUM(CASE WHEN AAP.ARC IN ('PRTY3','RQ003') THEN 1 ELSE 0 END) AS THRDPARTY,
			SUM(CASE WHEN AAP.ARC IN ('G7IBR','IBRCL') THEN 1 ELSE 0 END) AS IDR,
			SUM(CASE WHEN AAP.ARC IN ('IVRM1','H742A','G709M') THEN 1 ELSE 0 END) AS FORB,
			SUM(CASE WHEN AAP.ARC = 'G7077' THEN 1 ELSE 0 END) AS DEFECON,
			SUM(CASE WHEN AAP.ARC = 'G708C' THEN 1 ELSE 0 END) AS DEFUNEM,
			SUM(CASE WHEN AAP.ARC = 'ALSCH' THEN 1 ELSE 0 END) AS DEFSCH,
			SUM(CASE WHEN AAP.ARC IN ('DRNDP','PRTY3','RQ003','G7IBR','IBRCL','IVRM1','H742A','G709M','G7077','G708C','ALSCH') THEN 1 ELSE 0 END) AS TTL_FRMS
		FROM
			CLS..ArcAddProcessing AAP
		WHERE
			AAP.CreatedBy LIKE 'IVR%'
			AND CONVERT(DATE, AAP.CreatedAt) BETWEEN @BEGIN AND @END
	) IVR_AAP



GO


