SELECT DISTINCT
	 PD10.DF_SPE_ACC_ID AS [Account Number]
	,WQ20.WF_QUE AS Queue
	,WQ20.WF_SUB_QUE AS [Sub-Queue]
	,WQ20.WF_CRT_DTS_WQ20 AS [Queue Created]
	,(LN16.LN_DLQ_MAX + 1) AS Delinquency
FROM
	CDW..LN10_LON LN10
	INNER JOIN CDW..PD10_PRS_NME PD10
		ON LN10.BF_SSN = PD10.DF_PRS_ID
	INNER JOIN CDW..WQ20_TSK_QUE WQ20
		ON LN10.BF_SSN = WQ20.BF_SSN
	INNER JOIN CDW..LN16_LON_DLQ_HST LN16
		ON LN10.BF_SSN = LN16.BF_SSN
		AND LN10.LN_SEQ = LN16.LN_SEQ
WHERE
	LN10.LA_CUR_PRI > 0.00
	AND LN10.LC_STA_LON10 = 'R'
	AND LN16.LC_STA_LON16 = '1'
	AND WQ20.WC_STA_WQUE20 NOT IN ('X','C') --cancelled/closed
	AND
	(
		WQ20.WF_QUE = 'DR' --open DR queue tasks
		OR
		(--open RB queue tasks
			WQ20.WF_QUE = 'RB'
			AND WQ20.WF_SUB_QUE NOT IN ('01','02','05','07','08')
		)
	)
ORDER BY
	 Delinquency DESC
	,PD10.DF_SPE_ACC_ID

