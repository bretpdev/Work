CREATE PROCEDURE [covidforb].[GetClaimsManualReviewPopulation]
AS
	DECLARE @NOW DATETIME = GETDATE();
	DECLARE @TODAY DATE = CONVERT(DATE,@NOW);

SELECT DISTINCT
	PD10.DF_SPE_ACC_ID AS AccountNumber,
	CASE 
		WHEN DW01.WC_DW_LON_STA = '12' AND LN90.BF_SSN IS NOT NULL THEN 1
		WHEN DW01.WC_DW_LON_STA = '08' THEN 2
	END AS [Priority],
	 CASE 
		WHEN DW01.WC_DW_LON_STA = '12' AND LN90.BF_SSN IS NOT NULL THEN 'Claim paid(12) within last 30 days'
		WHEN DW01.WC_DW_LON_STA = '08' THEN 'Pending claim(08)'
	END AS Comment
FROM
	UDW..PD10_PRS_NME PD10
	INNER JOIN UDW..LN10_LON LN10
		ON PD10.DF_PRS_ID = LN10.BF_SSN
	INNER JOIN UDW..LN16_LON_DLQ_HST LN16
		ON LN10.BF_SSN = LN16.BF_SSN
		AND LN10.LN_SEQ = LN16.LN_SEQ
	INNER JOIN UDW..DW01_DW_CLC_CLU DW01
		ON LN10.BF_SSN = DW01.BF_SSN
		AND LN10.LN_SEQ = DW01.LN_SEQ
	INNER JOIN UDW..AY10_BR_LON_ATY AY10
		ON AY10.BF_SSN = LN10.BF_SSN
		AND AY10.LC_STA_ACTY10 = 'A'
		AND AY10.PF_RSP_ACT = 'C1777'
	LEFT JOIN
	(
		SELECT
			FB10.BF_SSN
		FROM
			UDW..FB10_BR_FOR_REQ FB10
			INNER JOIN UDW..LN60_BR_FOR_APV LN60
				ON LN60.BF_SSN = FB10.BF_SSN
				AND LN60.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM
		WHERE
			FB10.LC_FOR_STA = 'A'
			AND FB10.LC_STA_FOR10 = 'A'
			AND LN60.LC_STA_LON60 = 'A'
			AND CAST(LN60.LD_FOR_APL AS DATE) = @TODAY
		GROUP BY
			FB10.BF_SSN
	) EXISTING_FORB
		ON EXISTING_FORB.BF_SSN = PD10.DF_PRS_ID
	LEFT JOIN UDW..LN90_FIN_ATY LN90
		ON LN90.BF_SSN = LN10.BF_SSN
		AND LN90.LN_SEQ = LN10.LN_SEQ
		AND DATEDIFF(DAY, LN90.LD_FAT_EFF, @TODAY) <= 30 
		AND LC_STA_LON90 = 'A'
		AND PC_FAT_TYP = '10'
		AND PC_FAT_SUB_TYP = '30'
		AND ISNULL(LC_FAT_REV_REA,'') = ''

WHERE
	LN10.LC_STA_LON10 = 'R'
	AND LN10.LA_CUR_PRI > 0.00
	AND LN10.LI_CON_PAY_STP_PUR != 'Y' --stop pursuit
	AND 
	(
		DW01.WC_DW_LON_STA = '08' --Claim pending
		OR (DW01.WC_DW_LON_STA = '12' AND LN90.BF_SSN IS NOT NULL) --Claim paid)		
	)
	AND LN16.LN_DLQ_MAX >= 29
	AND LN16.LC_STA_LON16 = '1'
	AND EXISTING_FORB.BF_SSN IS NULL
	AND LN10.IC_LON_PGM != 'TILP'
;
RETURN 0
