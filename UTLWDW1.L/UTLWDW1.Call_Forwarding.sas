/*THIS SPECIFICIES WHAT DIRECTORY TO READ REPORTS FROM AND WHICH DATABASE TO UPDATE.*/
/*LIVE*/
%INCLUDE "X:\Sessions\Local SAS Schedule\UDW\UTLWDW1 UHEAA Data Warehouse Load.Folder and Database.sas";
%LET REPORT = X:\PADD\FTP;

/*TEST*/
/*%INCLUDE "X:\PADU\SAS\UDW\UTLWDW1 UHEAA Data Warehouse Load.Folder and Database.sas" ;
%LET REPORT = T:\SAS;*/

%FILECHECK(14);

DATA GA10(DROP=TRUNC);
      INFILE REPORT14 DSD DLM = ',' FIRSTOBS=1 MISSOVER END = EOF;
      INPUT DF_SPE_ACC_ID :$10. BF_SSN :$9. CLUID :$19. 
		LN_SEQ :6. FORWARDING :$2.  ;
LN_SEQ = COALESCE(LN_SEQ,0);
%TRUNCAT(14,DF_SPE_ACC_ID);
RUN; 
%copyerror;
	
PROC SORT DATA=GA10; BY DF_SPE_ACC_ID CLUID LN_SEQ; RUN;
DATA GA10; SET GA10; BY DF_SPE_ACC_ID CLUID LN_SEQ; IF LAST.LN_SEQ; RUN;

PROC SQL;
CREATE TABLE NO_GA10_DELTA AS
SELECT DISTINCT A.DF_SPE_ACC_ID
	,A.CLUID
	,A.LN_SEQ
FROM GA10 A
INNER JOIN UDW.GA10_CALLFORWARDING B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.BF_SSN = B.BF_SSN
	  AND A.CLUID = B.CLUID
	  AND A.LN_SEQ = B.LN_SEQ
	  AND A.FORWARDING = B.FORWARDING ;

CREATE TABLE GA10_DELTAS AS
SELECT DISTINCT A.*
FROM GA10 A
LEFT JOIN NO_GA10_DELTA B
	  ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.CLUID = B.CLUID
	  AND A.LN_SEQ = B.LN_SEQ
WHERE B.DF_SPE_ACC_ID IS NULL
	AND B.CLUID IS NULL
	AND B.LN_SEQ IS NULL;
QUIT;

DATA GA10_CALLFORWARDING_DELTAS (KEEP=DF_SPE_ACC_ID CLUID LN_SEQ);
	SET GA10_DELTAS;
RUN;

PROC SORT DATA=GA10_CALLFORWARDING_DELTAS NODUPKEY;
	BY DF_SPE_ACC_ID CLUID LN_SEQ;
RUN;

PROC SQL;
CREATE TABLE LOCL_GA10_CALLFORWARDING_DELTAS AS
      SELECT A.* 
      FROM UDW.GA10_CALLFORWARDING A
      INNER JOIN GA10_CALLFORWARDING_DELTAS B
            ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
			AND A.CLUID = B.CLUID
			AND A.LN_SEQ = B.LN_SEQ;

INSERT INTO UDW.ZDEL_GA10_CALLFORWARDING
      SELECT DF_SPE_ACC_ID
	  		,CLUID
			,LN_SEQ
      FROM LOCL_GA10_CALLFORWARDING_DELTAS; 
QUIT;

PROC SORT DATA=	LOCL_GA10_CALLFORWARDING_DELTAS NODUPKEY; BY DF_SPE_ACC_ID CLUID LN_SEQ; RUN; 

%UPDATE_DATA(LOCL_GA10_CALLFORWARDING_DELTAS,GA10_DELTAS,%STR(DF_SPE_ACC_ID CLUID LN_SEQ));
PROC SORT DATA=	LOCL_GA10_CALLFORWARDING_DELTAS NODUPKEY; BY DF_SPE_ACC_ID CLUID LN_SEQ; RUN; 
%GOODBYE_NULL(ZDEL_GA10_CALLFORWARDING,CLUID,'');

PROC SQL NOPRINT;
CONNECT TO ODBC AS MD (&MD);
SELECT COUNT(*) 
FROM CONNECTION TO MD (
      DELETE GA10_CALLFORWARDING
      FROM GA10_CALLFORWARDING A
      INNER JOIN ZDEL_GA10_CALLFORWARDING B
            ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
			AND A.CLUID = B.CLUID
			AND A.LN_SEQ = B.LN_SEQ
      );
DISCONNECT FROM MD;
QUIT;

PROC SQL ;
INSERT INTO UDW.GA10_CALLFORWARDING
      SELECT *
      FROM LOCL_GA10_CALLFORWARDING_DELTAS;
QUIT;
%GOODBYE_NULL(GA10_CALLFORWARDING,CLUID,'');
%GOODBYE_NULL(GA10_CALLFORWARDING,FORWARDING,'');

PROC SQL NOPRINT;
CONNECT TO ODBC AS MD (&MD);
SELECT COUNT(*) 
FROM CONNECTION TO MD (
      TRUNCATE TABLE ZDEL_GA10_CALLFORWARDING
      );
DISCONNECT FROM MD;
QUIT;

%finish;
