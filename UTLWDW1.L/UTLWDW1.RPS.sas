/*THIS SPECIFICIES WHAT DIRECTORY TO READ REPORTS FROM AND WHICH DATABASE TO UPDATE.*/
/*LIVE*/
%INCLUDE "X:\Sessions\Local SAS Schedule\UDW\UTLWDW1 UHEAA Data Warehouse Load.Folder and Database.sas";
%LET REPORT = X:\PADD\FTP;

/*TEST*/
/*%INCLUDE "X:\PADU\SAS\UDW\UTLWDW1 UHEAA Data Warehouse Load.Folder and Database.sas" ;
%LET REPORT = T:\SAS;*/

%FILECHECK(17);

DATA LN65(drop=LC_TYP_SCH_DIS trunc);
	INFILE REPORT17 DSD DLM = ',' FIRSTOBS=1 MISSOVER end = eof;
	INPUT DF_SPE_ACC_ID :$10. LN_SEQ :6. LD_CRT_LON65 :$10. LC_TYP_SCH_DIS :$2. 
		LD_SNT_RPD_DIS :$10. LA_RPS_ISL :9.2 DUE_DAY :$2. LN_RPS_TRM :3.0;
	TYP_SCH_DIS = PUT(LC_TYP_SCH_DIS,$SCHTYP.);
	LA_RPS_ISL = coalesce(LA_RPS_ISL,0);
	LN_RPS_TRM = coalesce(LN_RPS_TRM,0);
%TRUNCAT(17,DF_SPE_ACC_ID);
RUN;
%copyerror;

proc sort data=LN65; by df_spe_acc_id ln_seq; run;
DATA LN65; set LN65; by df_spe_acc_id ln_seq; if last.ln_seq ;run;

%ENCHILADA(LN65,LN65_REPAYMENTSCHED,DF_SPE_ACC_ID LN_SEQ,LD_CRT_LON65 TYP_SCH_DIS LD_SNT_RPD_DIS LN_RPS_TRM DUE_DAY LA_RPS_ISL,);

%GOODBYE_NULL(LN65_REPAYMENTSCHED,LD_CRT_LON65,'');
%GOODBYE_NULL(LN65_REPAYMENTSCHED,TYP_SCH_DIS,'');
%GOODBYE_NULL(LN65_REPAYMENTSCHED,LD_SNT_RPD_DIS,'');
%GOODBYE_NULL(LN65_REPAYMENTSCHED,LN_RPS_TRM,0);
%GOODBYE_NULL(LN65_REPAYMENTSCHED,LA_RPS_ISL,0);
%GOODBYE_NULL(LN65_REPAYMENTSCHED,DUE_DAY,'');

PROC SQL;
CREATE TABLE RPF AS
	SELECT DISTINCT DF_SPE_ACC_ID
		,"RPF=" || PUT(SUM(LA_REQ_RDC_PAY),DOLLAR8.2) AS MONTH_AMT FORMAT=$20.
		,put(day(intnx('month',today(),0,'e')),2.) as DUE_DAY
		,'N' AS MULT_DUE_DT
	FROM UDW.FB10_FORBEARANCE
	WHERE input(LD_FOR_BEG,mmddyy10.) <= TODAY()
		AND input(LD_FOR_END,mmddyy10.) >= TODAY()
		AND LA_REQ_RDC_PAY >0
	GROUP BY DF_SPE_ACC_ID;
QUIT;

PROC SQL;
CREATE TABLE LN65_BOR AS
	SELECT A.DF_SPE_ACC_ID
		,put(max(INPUT(LD_CRT_LON65,MMDDYY10.)),mmddyy10.) as ld_crt_lon65
		,SUM(A.LA_RPS_ISL) AS C
		,A.DUE_DAY
	FROM UDW.LN65_REPAYMENTSCHED A
	GROUP BY A.DF_SPE_ACC_ID, A.DUE_DAY;
QUIT;
PROC SORT DATA=LN65_BOR; BY DF_SPE_ACC_ID DUE_DAY; RUN;
DATA LN65_BOR (KEEP=DF_SPE_ACC_ID LD_CRT_LON65 DUE_DAY MONTH_AMT MULT_DUE_DT);
	FORMAT DUE_DAY $8. MONTH_AMT $20.; 
	SET LN65_BOR;
	RETAIN MONTH_AMT A ;
	BY DF_SPE_ACC_ID DUE_DAY;
	IF FIRST.DF_SPE_ACC_ID AND LAST.DF_SPE_ACC_ID THEN DO;
		MONTH_AMT = LEFT(PUT(C,DOLLAR9.2));
		MULT_DUE_DT = 'N';
		OUTPUT;
	END;
	ELSE IF FIRST.DF_SPE_ACC_ID THEN DO;
		MONTH_AMT = LEFT(PUT(C,DOLLAR9.2));
		A = DUE_DAY;
	END;
	IF FIRST.DF_SPE_ACC_ID = 0 THEN DO;
		MONTH_AMT = TRIM(MONTH_AMT) || ', ' || LEFT(PUT(C,DOLLAR9.2));
		A = TRIM(A) || ',' || TRIM(DUE_DAY);
	END;
	IF LAST.DF_SPE_ACC_ID and first.df_spe_acc_id = 0 THEN DO;
		MULT_DUE_DT = 'Y';
		DUE_DAY = A;
		OUTPUT;
	END;
RUN;
PROC SORT DATA=RPF; BY DF_SPE_ACC_ID; RUN;
DATA LN65_BOR;
MERGE LN65_BOR RPF;
BY DF_SPE_ACC_ID; 
RUN;

%ENCHILADA(LN65_BOR,BORR_REPAYMENT,DF_SPE_ACC_ID,LD_CRT_LON65 DUE_DAY MONTH_AMT MULT_DUE_DT,);

%GOODBYE_NULL(BORR_REPAYMENT,LD_CRT_LON65,'');
%GOODBYE_NULL(BORR_REPAYMENT,DUE_DAY,'');
%GOODBYE_NULL(BORR_REPAYMENT,MONTH_AMT,0);
%GOODBYE_NULL(BORR_REPAYMENT,MULT_DUE_DT,'N');

%FINISH;
