/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORTZ "&RPTLIB/ARBOR DAY FOUNDATION FILE.RZ";
FILENAME REPORT2 "&RPTLIB/ARBOR DAY FOUNDATION FILE.R2";

%MACRO PULL (NAME);
DATA _&NAME;
	INFILE "Y:\Batch\FTP\Scott\EBILL 6-1-12 thru 6-30-12\BILL_CHANGE_KU.&NAME..txt";
	INPUT +2 BF_SSN $9. +20 EBILL $1. +258;
RUN;
%MEND PULL;
%PULL(7470831);
%PULL(7471173);
%PULL(7471306);
%PULL(7473004);
%PULL(7473346);
%PULL(7473466);
%PULL(7474334);
%PULL(7475570);
%PULL(7475852);
%PULL(7475971);
%PULL(7476812);
%PULL(7477041);
%PULL(7477171);
%PULL(7477999);
%PULL(7478265);
%PULL(7478398);
%PULL(7480253);
%PULL(7481143);
%PULL(7481384);
%PULL(7481548);
%PULL(7482356);
%PULL(7482615);
%PULL(7482735);
%PULL(7483585);
%PULL(7483818);
%PULL(7483937);
%PULL(7485066);
%PULL(7485214);
%PULL(7486701);
%PULL(7486969);
%PULL(7487094);
%PULL(7487971);
%PULL(7488243);
%PULL(7488356);
%PULL(7489215);
%PULL(7489467);
%PULL(7489617);
%PULL(7490495);
%PULL(7490727);
%PULL(7490863);
%PULL(7491692);
%PULL(7492340);
%PULL(7492729);
%PULL(7494260);
%PULL(7495575);
%PULL(7495806);
%PULL(7495940);
%PULL(7496824);
%PULL(7497091);
%PULL(7497228);
%PULL(7498043);
%PULL(7498330);
%PULL(7498449);
%PULL(7499286);
%PULL(7499508);
%PULL(7499631);

DATA TOGETHER;
	SET _7470831
		_7471173
		_7471306
		_7473004
		_7473346
		_7473466
		_7474334
		_7475570
		_7475852
		_7475971
		_7476812
		_7477041
		_7477171
		_7477999
		_7478265
		_7478398
		_7480253
		_7481143
		_7481384
		_7481548
		_7482356
		_7482615
		_7482735
		_7483585
		_7483818
		_7483937
		_7485066
		_7485214
		_7486701
		_7486969
		_7487094
		_7487971
		_7488243
		_7488356
		_7489215
		_7489467
		_7489617
		_7490495
		_7490727
		_7490863
		_7491692
		_7492340
		_7492729
		_7494260
		_7495575
		_7495806
		_7495940
		_7496824
		_7497091
		_7497228
		_7498043
		_7498330
		_7498449
		_7499286
		_7499508
		_7499631;
RUN;

PROC SQL;
CREATE TABLE SSNS AS
	SELECT DISTINCT
		T.BF_SSN
	FROM 
		TOGETHER T
	WHERE
		T.EBILL = 'E'
;
QUIT;

LIBNAME  LEGEND  REMOTE  SERVER=LEGEND SLIBREF=work  ;

DATA LEGEND.SSNS;
	SET SSNS;
RUN;

RSUBMIT LEGEND;
/*%let DB = DNFPRQUT;  *This is test;*/
/*%let DB = DNFPRUUT;  *This is VUK3 test;*/
%let DB = DNFPUTDL;  *This is live;

LIBNAME PKUB DB2 DATABASE=&DB OWNER=PKUB;

%MACRO SQLCHECK ;
  %IF  &SQLXRC NE 0  %THEN  %DO  ;
    DATA _NULL_  ;
            FILE REPORTZ NOTITLES  ;
            PUT @01 " ********************************************************************* "
              / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
              / @01 " ****  THE SAS SHOULD BE REVIEWED.                                **** "       
              / @01 " ********************************************************************* "
              / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
              / @01 " ****  &SQLXMSG   **** "
              / @01 " ********************************************************************* "
            ;
         RUN  ;
  %END  ;
%MEND  ;

PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE DEMO AS
	SELECT	
		PD10.DM_PRS_1
		,PD10.DM_PRS_LST
		,PD30.DX_STR_ADR_1
		,PD30.DX_STR_ADR_2
		,PD30.DM_CT
		,PD30.DC_DOM_ST
		,PD30.DF_ZIP_CDE
	FROM	
		SSNS S
		INNER JOIN PKUB.PD10_PRS_NME PD10
			ON S.BF_SSN = PD10.DF_PRS_ID
		LEFT JOIN PKUB.PD30_PRS_ADR PD30
			ON S.BF_SSN = PD30.DF_PRS_ID
	;

	DISCONNECT FROM DB2;

	/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>> ;  ** INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
	/*%SQLCHECK;*/
QUIT;

ENDRSUBMIT;

DATA DEMO; SET LEGEND.DEMO; RUN;

/*export to queue builder (fed) file*/
DATA _NULL_;
	SET DEMO ;
	FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
	PUT ',' DM_PRS_1 ',' DM_PRS_LST ',,' DX_STR_ADR_1 DX_STR_ADR_2 DM_CT DC_DOM_ST DF_ZIP_CDE ',,,,,,,,,' ;
RUN;
