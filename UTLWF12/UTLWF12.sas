/*THIS JOB IS AN AES JOB AND WAS NOT CREATED LOCALLY*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWF12.LWF12R2" ; 

DATA _NULL_;
	IF WEEKDAY(DATE()) = 1 THEN DO;
		CALL SYMPUT('END',"'"||put(INTNX('DAY',DATE(),-2),mmddyy10.)||"'");
	END;
	ELSE DO;
        CALL SYMPUT('END',"'"||put(INTNX('DAY',DATE(),-1),mmddyy10.)||"'");
	END;
	IF WEEKDAY(DATE()) = 2 THEN DO;
        CALL SYMPUT('END',"'"||put(INTNX('DAY',DATE(),-3),mmddyy10.)||"'");
	END;
	CALL SYMPUT('RUNDT',PUT(DATE()-1,MMDDYY10.));
RUN;

%SYSLPUT END = &END;
RSUBMIT;
PROC SQL;
CONNECT TO DB2(DATABASE=DLGSUTWH);
CREATE TABLE TEST AS
SELECT *
FROM CONNECTION TO DB2(
SELECT DISTINCT C.DF_SPE_ACC_ID
      ,A.LA_TRX AS REVERSED
      ,A.LC_TRX_TYP AS OLDTYPE
      ,A.LD_TRX_EFF
      ,A.LD_TRX_ADJ
      ,B.LA_TRX AS REAPPLIED
      ,B.LC_TRX_TYP AS NEWTYPE
	  		,A.LF_CRT_DTS_DC10
FROM OLWHRM1.PD01_PDM_INF C
INNER JOIN OLWHRM1.DC11_LON_FAT A 
	ON C.DF_PRS_ID = A.BF_SSN
LEFT OUTER JOIN (SELECT B.AF_APL_ID
			,B.AF_APL_ID_SFX
			,B.LF_CRT_DTS_DC10
			,B.LD_TRX_EFF
			,B.LA_TRX
			,B.LC_TRX_TYP
		FROM OLWHRM1.DC11_LON_FAT B 
		WHERE B.BD_TRX_PST_HST = &END 
			AND  B.LC_RCI_TYP = 'CR'
) B
	ON A.AF_APL_ID = B.AF_APL_ID 
	AND A.AF_APL_ID_SFX = B.AF_APL_ID_SFX 
	AND A.LF_CRT_DTS_DC10 = B.LF_CRT_DTS_DC10 
	AND A.LD_TRX_EFF = B.LD_TRX_EFF 
WHERE A.LD_TRX_ADJ = &END 
	AND A.LC_REV_IND_TYP IN ('PE','BC') 
	AND A.LC_TRX_TYP <> 'AD'
ORDER BY C.DF_SPE_ACC_ID, A.LD_TRX_EFF, A.LC_TRX_TYP);
    DISCONNECT FROM DB2;
    QUIT;

ENDRSUBMIT;
DATA TEST;
SET WORKLOCL.TEST;
RUN;
OPTIONS ERROR = 0
        MISSING = ' '
        LS=96
        PS=54 ;
PROC MEANS NOPRINT SUM DATA=TEST;
BY DF_SPE_ACC_ID LD_TRX_EFF OLDTYPE;
VAR REVERSED REAPPLIED;
ID NEWTYPE LD_TRX_ADJ;
OUTPUT OUT=TST SUM=REVERSED REAPPLIED;

PROC PRINTTO PRINT=REPORT2 NEW;

PROC PRINT NOOBS SPLIT='/' DATA=TST;
VAR DF_SPE_ACC_ID LD_TRX_EFF LD_TRX_ADJ OLDTYPE NEWTYPE REVERSED REAPPLIED;
LABEL DF_SPE_ACC_ID = 'ACCOUNT NUMBER'
      LD_TRX_EFF = 'EFFECTIVE DATE'
      LD_TRX_ADJ = 'DATE ADJUSTED/REAPPLIED'
      OLDTYPE = 'OLD/TRANSACTION/TYPE'
      NEWTYPE = 'NEW/TRANSACTION/TYPE'
      ;
FORMAT LD_TRX_EFF LD_TRX_ADJ MMDDYY10.
       REVERSED REAPPLIED DOLLAR14.2;
SUM REAPPLIED REVERSED;
TITLE1 'REVERSED AND REAPPLIED PAYMENTS';
TITLE2 "&RUNDT";
RUN;

PROC PRINTTO;
RUN;
