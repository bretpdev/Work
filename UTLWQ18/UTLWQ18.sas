/*UTLWQ18 SCHOOLS UPDATED PREVIOUS DAY*/

/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
/*FILENAME REPORT2 "&RPTLIB/ULWQ18.LWQ18R2";*/
/*FILENAME REPORT3 "&RPTLIB/ULWQ18.LWQ18R3";*/

FILENAME REPORT2 'T:\SAS\UTLWQ18.ONELINK.TXT';
FILENAME REPORT3 'T:\SAS\UTLWQ18.COMPASS.TXT';

LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
/*ONLINK UPDATES*/
CREATE TABLE OL AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT
	A.IF_IST			
	,A.IM_IST_FUL		
	,A.IC_IST_DPT	
	,A.IF_LST_USR_SC01	
	,A.IX_GEN_STR_ADR_1	
	,A.IX_GEN_STR_ADR_2	
	,A.IX_GEN_STR_ADR_3	
	,A.IM_GEN_CT		
	,A.IC_GEN_ST		
	,A.IM_GEN_FGN_ST	
	,A.IM_GEN_FGN_CNY	
	,A.IF_GEN_ZIP		
	,A.IN_GEN_PHN		
	,A.IN_GEN_PHN_XTN	
	,A.IX_GEN_EML_ADR	
	,A.IX_DPT_STR_ADR_1	
	,A.IX_DPT_STR_ADR_2	
	,A.IX_DPT_STR_ADR_3	
	,A.IM_DPT_CT		
	,A.IC_DPT_ST		
	,A.IF_DPT_ZIP		
	,A.IN_DPT_PHN		
	,A.IN_DPT_PHN_XTN	
FROM	OLWHRM1.SC01_LGS_SCL_INF A
WHERE	DAYS(A.IF_LST_DTS_IN01) = DAYS(CURRENT DATE) - 1
		OR DAYS(A.IF_LST_DTS_SC01) = DAYS(CURRENT DATE) - 1
		OR DAYS(A.IF_LST_DTS_IN02) = DAYS(CURRENT DATE) - 1
ORDER BY A.IF_IST, A.IC_IST_DPT
FOR READ ONLY WITH UR
);

/*IN11 UPDATES*/
CREATE TABLE IN11 AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT A.IF_IST
	,A.IF_IST			AS IN11_IF_IST
	,A.IM_IST_FUL 		AS IN11_IM_IST_FUL	 
	,A.IC_IST_DPT_HST	AS IN11_IC_IST_DPT_HST
	,A.IX_GEN_STR_ADR_1 AS IN11_IX_GEN_STR_ADR_1
	,A.IX_GEN_STR_ADR_2 AS IN11_IX_GEN_STR_ADR_2	 
	,A.IX_GEN_STR_ADR_3 AS IN11_IX_GEN_STR_ADR_3	 
	,A.IM_GEN_CT		AS IN11_IM_GEN_CT
	,A.IC_GEN_ST 	 	AS IN11_IC_GEN_ST
	,A.IF_GEN_ZIP 	 	AS IN11_IF_GEN_ZIP
	,A.IN_GEN_PHN		AS IN11_IN_GEN_PHN
FROM OLWHRM1.IN11_IDM_ADR_HST A
WHERE DAYS(A.IF_CRT_DTS_IN11) = DAYS(CURRENT DATE) - 1
AND IC_IST_TYP = '001'
ORDER BY A.IF_IST
FOR READ ONLY WITH UR
);

/*SC10 UPDATES*/
CREATE TABLE SC10 AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT
	A.IF_DOE_SCL		
	,A.IM_SCL_FUL		
	,A.IF_LST_USR_SC10	
FROM	OLWHRM1.SC10_SCH_DMO A
WHERE	DAYS(A.IF_LST_DTS_SC10) = DAYS(CURRENT DATE) - 1
ORDER BY A.IF_DOE_SCL
FOR READ ONLY WITH UR
);

/*SC25 UPDATES*/
CREATE TABLE SC25 AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT
	B.IF_DOE_SCL		
	,A.IM_SCL_FUL		
	,B.IC_SCL_DPT		
	,B.IX_SCL_STR_ADR_1	
	,B.IX_SCL_STR_ADR_2	
	,B.IX_SCL_STR_ADR_3	
	,B.IM_SCL_CT		
	,B.IC_SCL_DOM_ST	
	,B.IM_SCL_FGN_ST	
	,B.IM_SCL_FGN_CNY	
	,B.IF_SCL_ZIP_CDE
	,B.IN_SCL_DOM_PHN_ARA
	,B.IN_SCL_DOM_PHN_XCH
	,B.IN_SCL_DOM_PHN_LCL
	,B.IN_SCL_DOM_FAX_ARA
	,B.IN_SCL_DOM_FAX_XCH
	,B.IN_SCL_DOM_FAX_LCL
	,B.IN_SCL_FGN_PHN_INL
	,B.IN_SCL_FGN_PHN_CNY
	,B.IN_SCL_FGN_PHN_CT
	,B.IN_SCL_FGN_PHN_LCL
	,B.IN_SCL_FGN_PHN_XTN
	,B.IN_SCL_FGN_FAX_INL
	,B.IN_SCL_FGN_FAX_CNY
	,B.IN_SCL_FGN_FAX_CT
	,B.IN_SCL_FGN_FAX_LCL
FROM	OLWHRM1.SC10_SCH_DMO A
		INNER JOIN OLWHRM1.SC25_SCH_DPT B ON
			A.IF_DOE_SCL = B.IF_DOE_SCL
WHERE	DAYS(B.IF_LST_DTS_SC25) = DAYS(CURRENT DATE) - 1
ORDER BY B.IF_DOE_SCL, B.IC_SCL_DPT		
FOR READ ONLY WITH UR
);

DISCONNECT FROM DB2;

/*MERGE COMPASS UPDATES*/
DATA CO;
MERGE SC10 SC25;
BY IF_DOE_SCL;
RUN;

/*MERGE ONLINK INFO*/
DATA OL;
MERGE OL IN11;
BY IF_IST;
RUN;
ENDRSUBMIT;

DATA OL;
SET WORKLOCL.OL;
RUN;

DATA CO;
SET WORKLOCL.CO;
RUN;

/*ONELINK DATA FILE*/
DATA _NULL_;
SET  WORK.OL;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
FORMAT IF_IST $8. ;
FORMAT IM_IST_FUL $40. ;
FORMAT IC_IST_DPT $3. ;
FORMAT IF_LST_USR_SC01 $8. ;
FORMAT IX_GEN_STR_ADR_1 $40. ;
FORMAT IX_GEN_STR_ADR_2 $40. ;
FORMAT IX_GEN_STR_ADR_3 $40. ;
FORMAT IM_GEN_CT $30. ;
FORMAT IC_GEN_ST $2. ;
FORMAT IM_GEN_FGN_ST $15. ;
FORMAT IM_GEN_FGN_CNY $25. ;
FORMAT IF_GEN_ZIP $14. ;
FORMAT IN_GEN_PHN $17. ;
FORMAT IN_GEN_PHN_XTN $4. ;
FORMAT IX_GEN_EML_ADR $56. ;
FORMAT IX_DPT_STR_ADR_1 $40. ;
FORMAT IX_DPT_STR_ADR_2 $40. ;
FORMAT IX_DPT_STR_ADR_3 $40. ;
FORMAT IM_DPT_CT $30. ;
FORMAT IC_DPT_ST $2. ;
FORMAT IF_DPT_ZIP $14. ;
FORMAT IN_DPT_PHN $17. ;
FORMAT IN_DPT_PHN_XTN $4. ;
FORMAT IN11_IF_IST  $8.;
FORMAT IN11_IM_IST_FUL $40. ;
FORMAT IN11_IC_IST_DPT_HST $3. ;
FORMAT IN11_IX_GEN_STR_ADR_1 $40. ;
FORMAT IN11_IX_GEN_STR_ADR_2 $40. ;
FORMAT IN11_IX_GEN_STR_ADR_3 $40. ;
FORMAT IN11_IM_GEN_CT $30. ;
FORMAT IN11_IC_GEN_ST $2. ;
FORMAT IN11_IF_GEN_ZIP $14. ;
FORMAT IN11_IN_GEN_PHN $17. ;
IF _N_ = 1 THEN 
DO;
PUT
   'IF_IST'   				','
   'IM_IST_FUL'  			','
   'IC_IST_DPT'   			','
   'IF_LST_USR_SC01'   		','
   'IX_GEN_STR_ADR_1'   	','
   'IX_GEN_STR_ADR_2'   	','
   'IX_GEN_STR_ADR_3'   	','
   'IM_GEN_CT'   			','
   'IC_GEN_ST'   			','
   'IM_GEN_FGN_ST'   		','
   'IM_GEN_FGN_CNY'  		','
   'IF_GEN_ZIP'   			','
   'IN_GEN_PHN'   			','
   'IN_GEN_PHN_XTN'   		','
   'IX_GEN_EML_ADR'   		','
   'IX_DPT_STR_ADR_1'   	','
   'IX_DPT_STR_ADR_2'   	','
   'IX_DPT_STR_ADR_3'   	','
   'IM_DPT_CT'   			','
   'IC_DPT_ST'   			','
   'IF_DPT_ZIP'   			','
   'IN_DPT_PHN'   			','
   'IN_DPT_PHN_XTN'   		','
   'IN11_IF_IST '			','
   'IN11_IM_IST_FUL'   		','
   'IN11_IC_IST_DPT_HST'   	','
   'IN11_IX_GEN_STR_ADR_1'  ','
   'IN11_IX_GEN_STR_ADR_2'  ','
   'IN11_IX_GEN_STR_ADR_3'  ','
   'IN11_IM_GEN_CT'   		','
   'IN11_IC_GEN_ST'   		','
   'IN11_IF_GEN_ZIP'   		','
   'IN11_IN_GEN_PHN';
END;
  DO;
   PUT IF_IST $ @;
   PUT IM_IST_FUL $ @;
   PUT IC_IST_DPT $ @;
   PUT IF_LST_USR_SC01 $ @;
   PUT IX_GEN_STR_ADR_1 $ @;
   PUT IX_GEN_STR_ADR_2 $ @;
   PUT IX_GEN_STR_ADR_3 $ @;
   PUT IM_GEN_CT $ @;
   PUT IC_GEN_ST $ @;
   PUT IM_GEN_FGN_ST $ @;
   PUT IM_GEN_FGN_CNY $ @;
   PUT IF_GEN_ZIP $ @;
   PUT IN_GEN_PHN $ @;
   PUT IN_GEN_PHN_XTN $ @;
   PUT IX_GEN_EML_ADR $ @;
   PUT IX_DPT_STR_ADR_1 $ @;
   PUT IX_DPT_STR_ADR_2 $ @;
   PUT IX_DPT_STR_ADR_3 $ @;
   PUT IM_DPT_CT $ @;
   PUT IC_DPT_ST $ @;
   PUT IF_DPT_ZIP $ @;
   PUT IN_DPT_PHN $ @;
   PUT IN_DPT_PHN_XTN $ @;
   PUT IN11_IF_IST $ @;
   PUT IN11_IM_IST_FUL $ @;
   PUT IN11_IC_IST_DPT_HST $ @;
   PUT IN11_IX_GEN_STR_ADR_1 $ @;
   PUT IN11_IX_GEN_STR_ADR_2 $ @;
   PUT IN11_IX_GEN_STR_ADR_3 $ @;
   PUT IN11_IM_GEN_CT $ @;
   PUT IN11_IC_GEN_ST $ @;
   PUT IN11_IF_GEN_ZIP $ @;
   PUT IN11_IN_GEN_PHN $ ;
  END;
RUN;

/*COMPASS DATA FILE*/
DATA _NULL_;
SET CO;
FILE REPORT3 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT IF_DOE_SCL			$8. ;
	FORMAT IM_SCL_FUL			$40. ;
	FORMAT IC_SCL_DPT			$3. ;
	FORMAT IF_LST_USR_SC10		$8. ;
	FORMAT IX_SCL_STR_ADR_1		$30. ;
	FORMAT IX_SCL_STR_ADR_2		$30. ;
	FORMAT IX_SCL_STR_ADR_3		$30. ;
	FORMAT IM_SCL_CT			$20. ;
	FORMAT IC_SCL_DOM_ST		$2. ;
	FORMAT IM_SCL_FGN_ST		$15. ;
	FORMAT IM_SCL_FGN_CNY		$15. ;
	FORMAT IF_SCL_ZIP_CDE		$9. ;
	FORMAT IN_SCL_DOM_PHN_ARA	$3. ;
	FORMAT IN_SCL_DOM_PHN_XCH	$3. ;
	FORMAT IN_SCL_DOM_PHN_LCL	$4. ;
	FORMAT IN_SCL_DOM_FAX_ARA	$3. ;
	FORMAT IN_SCL_DOM_FAX_XCH	$3. ;
	FORMAT IN_SCL_DOM_FAX_LCL	$4. ;
	FORMAT IN_SCL_FGN_PHN_INL	$3. ;
	FORMAT IN_SCL_FGN_PHN_CNY	$3. ;
	FORMAT IN_SCL_FGN_PHN_CT	$4. ;
	FORMAT IN_SCL_FGN_PHN_LCL	$7. ;
	FORMAT IN_SCL_FGN_PHN_XTN	$4. ;
	FORMAT IN_SCL_FGN_FAX_INL	$3. ;
	FORMAT IN_SCL_FGN_FAX_CNY	$3. ;
	FORMAT IN_SCL_FGN_FAX_CT	$4. ;
	FORMAT IN_SCL_FGN_FAX_LCL	$7. ;

	IF _N_ = 1 THEN DO;       /* WRITE COLUMN NAMES */
		PUT
		'IF_DOE_SCL'			','
		'IM_SCL_FUL'			','
		'IC_SCL_DPT'			','
		'IF_LST_USR_SC10'		','
		'IX_SCL_STR_ADR_1'		','
		'IX_SCL_STR_ADR_2'		','
		'IX_SCL_STR_ADR_3'		','
		'IM_SCL_CT'				','
		'IC_SCL_DOM_ST'			','
		'IM_SCL_FGN_ST'			','
		'IM_SCL_FGN_CNY'		','
		'IF_SCL_ZIP_CDE'		','
		'IN_SCL_DOM_PHN_ARA'	','
		'IN_SCL_DOM_PHN_XCH'	','
		'IN_SCL_DOM_PHN_LCL'	','
		'IN_SCL_DOM_FAX_ARA'	','
		'IN_SCL_DOM_FAX_XCH'	','
		'IN_SCL_DOM_FAX_LCL'	','
		'IN_SCL_FGN_PHN_INL'	','
		'IN_SCL_FGN_PHN_CNY'	','
		'IN_SCL_FGN_PHN_CT'		','
		'IN_SCL_FGN_PHN_LCL'	','
		'IN_SCL_FGN_PHN_XTN'	','
		'IN_SCL_FGN_FAX_INL'	','
		'IN_SCL_FGN_FAX_CNY'	','
		'IN_SCL_FGN_FAX_CT'		','
		'IN_SCL_FGN_FAX_LCL'	;
	END;
	DO;
		PUT IF_DOE_SCL			$ @;
		PUT IM_SCL_FUL			$ @;
		PUT IC_SCL_DPT			$ @;
		PUT IF_LST_USR_SC10		$ @;
		PUT IX_SCL_STR_ADR_1	$ @;
		PUT IX_SCL_STR_ADR_2	$ @;
		PUT IX_SCL_STR_ADR_3	$ @;
		PUT IM_SCL_CT			$ @;
		PUT IC_SCL_DOM_ST		$ @;
		PUT IM_SCL_FGN_ST		$ @;
		PUT IM_SCL_FGN_CNY		$ @;
		PUT IF_SCL_ZIP_CDE		$ @;
		PUT IN_SCL_DOM_PHN_ARA	$ @;
		PUT IN_SCL_DOM_PHN_XCH	$ @;
		PUT IN_SCL_DOM_PHN_LCL	$ @;
		PUT IN_SCL_DOM_FAX_ARA	$ @;
		PUT IN_SCL_DOM_FAX_XCH	$ @;
		PUT IN_SCL_DOM_FAX_LCL	$ @;
		PUT IN_SCL_FGN_PHN_INL	$ @;
		PUT IN_SCL_FGN_PHN_CNY	$ @;
		PUT IN_SCL_FGN_PHN_CT	$ @;
		PUT IN_SCL_FGN_PHN_LCL	$ @;
		PUT IN_SCL_FGN_PHN_XTN	$ @;
		PUT IN_SCL_FGN_FAX_INL	$ @;
		PUT IN_SCL_FGN_FAX_CNY	$ @;
		PUT IN_SCL_FGN_FAX_CT	$ @;
		PUT IN_SCL_FGN_FAX_LCL	$ ;
	END;
RUN;
