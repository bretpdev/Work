--does a full refresh because table doesn't have a BF_SSN field and the table size is under 12K records

USE ODW
GO

DECLARE 
	@LoopCount TINYINT = 0

RefreshStart:

DECLARE @SQLStatement VARCHAR(MAX) = 
'
		MERGE 
			dbo.SC01_LGS_SCL_INF LOCAL
		USING
			(
				SELECT
					*
				FROM
					OPENQUERY
					(
						DUSTER,
						''
							SELECT
								REMOTE.*
							FROM
								OLWHRM1.SC01_LGS_SCL_INF REMOTE
						''

					)
			) R 
				ON R.IF_IST = LOCAL.IF_IST 
				AND R.IC_IST_DPT = LOCAL.IC_IST_DPT 
		WHEN MATCHED THEN 
		UPDATE SET 
			LOCAL.IF_IST = R.IF_IST,
			LOCAL.IC_IST_DPT = R.IC_IST_DPT,
			LOCAL.IM_IST_FUL = R.IM_IST_FUL,
			LOCAL.IX_GEN_STR_ADR_1 = R.IX_GEN_STR_ADR_1,
			LOCAL.IX_GEN_STR_ADR_2 = R.IX_GEN_STR_ADR_2,
			LOCAL.IX_GEN_STR_ADR_3 = R.IX_GEN_STR_ADR_3,
			LOCAL.IM_GEN_CT = R.IM_GEN_CT,
			LOCAL.IC_GEN_ST = R.IC_GEN_ST,
			LOCAL.IF_GEN_ZIP = R.IF_GEN_ZIP,
			LOCAL.IM_GEN_FGN_CNY = R.IM_GEN_FGN_CNY,
			LOCAL.IN_GEN_PHN = R.IN_GEN_PHN,
			LOCAL.IN_GEN_PHN_XTN = R.IN_GEN_PHN_XTN,
			LOCAL.IX_GEN_EML_ADR = R.IX_GEN_EML_ADR,
			LOCAL.IF_LST_DTS_IN01 = R.IF_LST_DTS_IN01,
			LOCAL.ID_LST_UPD_IN01 = R.ID_LST_UPD_IN01,
			LOCAL.II_GEN_VAL_ADR = R.II_GEN_VAL_ADR,
			LOCAL.II_GEN_VAL_PHN = R.II_GEN_VAL_PHN,
			LOCAL.IF_TAX_ID_NUM = R.IF_TAX_ID_NUM,
			LOCAL.IC_DOE_SCL_STA = R.IC_DOE_SCL_STA,
			LOCAL.IC_SCL_SUB_STA = R.IC_SCL_SUB_STA,
			LOCAL.ID_SCL_SUB_UPD = R.ID_SCL_SUB_UPD,
			LOCAL.IC_SCL_USB_STA = R.IC_SCL_USB_STA,
			LOCAL.IC_SCL_PLS_STA = R.IC_SCL_PLS_STA,
			LOCAL.IC_SCL_SUB_EPN = R.IC_SCL_SUB_EPN,
			LOCAL.ID_SCL_SUB_EPN_BEG = R.ID_SCL_SUB_EPN_BEG,
			LOCAL.IC_SCL_USB_EPN = R.IC_SCL_USB_EPN,
			LOCAL.ID_SCL_USB_EPN_BEG = R.ID_SCL_USB_EPN_BEG,
			LOCAL.IC_SCL_PLS_EPN = R.IC_SCL_PLS_EPN,
			LOCAL.ID_SCL_PLS_EPN_BEG = R.ID_SCL_PLS_EPN_BEG,
			LOCAL.IC_CTR_TML = R.IC_CTR_TML,
			LOCAL.II_PRC_CER_LON = R.II_PRC_CER_LON,
			LOCAL.IC_SCL_AGR = R.IC_SCL_AGR,
			LOCAL.ID_SCL_AGR_RTN = R.ID_SCL_AGR_RTN,
			LOCAL.ID_SCL_AGR_SNT = R.ID_SCL_AGR_SNT,
			LOCAL.ID_SCL_AGR_UPD = R.ID_SCL_AGR_UPD,
			LOCAL.IC_NGT_PTC = R.IC_NGT_PTC,
			LOCAL.IN_SDL_PTC_YR = R.IN_SDL_PTC_YR,
			LOCAL.ID_SDL_PTC_UPD = R.ID_SDL_PTC_UPD,
			LOCAL.IN_SDL_NON_PTC_YR = R.IN_SDL_NON_PTC_YR,
			LOCAL.ID_SDL_NON_PTC_UPD = R.ID_SDL_NON_PTC_UPD,
			LOCAL.IC_HEA_SCL = R.IC_HEA_SCL,
			LOCAL.IC_SCL_TYP = R.IC_SCL_TYP,
			LOCAL.IF_LST_DTS_SC01 = R.IF_LST_DTS_SC01,
			LOCAL.ID_LST_UPD_SC01 = R.ID_LST_UPD_SC01,
			LOCAL.IC_FRM_OPT = R.IC_FRM_OPT,
			LOCAL.IX_DPT_STR_ADR_1 = R.IX_DPT_STR_ADR_1,
			LOCAL.IX_DPT_STR_ADR_2 = R.IX_DPT_STR_ADR_2,
			LOCAL.IX_DPT_STR_ADR_3 = R.IX_DPT_STR_ADR_3,
			LOCAL.IM_DPT_CT = R.IM_DPT_CT,
			LOCAL.IC_DPT_ST = R.IC_DPT_ST,
			LOCAL.IF_DPT_ZIP = R.IF_DPT_ZIP,
			LOCAL.IN_DPT_PHN = R.IN_DPT_PHN,
			LOCAL.IN_DPT_PHN_XTN = R.IN_DPT_PHN_XTN,
			LOCAL.IF_LST_DTS_IN02 = R.IF_LST_DTS_IN02,
			LOCAL.ID_LST_UPD_IN02 = R.ID_LST_UPD_IN02,
			LOCAL.IC_APL_OPT = R.IC_APL_OPT,
			LOCAL.IC_SCL_PRI_LOC = R.IC_SCL_PRI_LOC,
			LOCAL.IC_SSR_PTC = R.IC_SSR_PTC,
			LOCAL.ID_SSR_PTC_CDE_UPD = R.ID_SSR_PTC_CDE_UPD,
			LOCAL.IC_DOE_PGM_LEN = R.IC_DOE_PGM_LEN,
			LOCAL.IC_SND_OPT = R.IC_SND_OPT,
			LOCAL.IN_CNL_APL_FIL_VRS = R.IN_CNL_APL_FIL_VRS,
			LOCAL.IN_CNL_CHG_FIL_VRS = R.IN_CNL_CHG_FIL_VRS,
			LOCAL.IC_SCL_SLS_STA = R.IC_SCL_SLS_STA,
			LOCAL.IM_IST_SHO = R.IM_IST_SHO,
			LOCAL.IC_KSL_PTC = R.IC_KSL_PTC,
			LOCAL.ID_CRT_IN01 = R.ID_CRT_IN01,
			LOCAL.IC_WEB_APL_PRT_OPT = R.IC_WEB_APL_PRT_OPT,
			LOCAL.II_PLS_PRC_CER_LON = R.II_PLS_PRC_CER_LON,
			LOCAL.IC_PLS_FRM_OPT = R.IC_PLS_FRM_OPT,
			LOCAL.IM_GEN_FGN_ST = R.IM_GEN_FGN_ST,
			LOCAL.IR_COT_DFL_RTE_1 = R.IR_COT_DFL_RTE_1,
			LOCAL.IN_COT_DFL_YR_1 = R.IN_COT_DFL_YR_1,
			LOCAL.IR_COT_DFL_RTE_2 = R.IR_COT_DFL_RTE_2,
			LOCAL.IN_COT_DFL_YR_2 = R.IN_COT_DFL_YR_2,
			LOCAL.IR_COT_DFL_RTE_3 = R.IR_COT_DFL_RTE_3,
			LOCAL.IN_COT_DFL_YR_3 = R.IN_COT_DFL_YR_3,
			LOCAL.IF_LST_USR_SC01 = R.IF_LST_USR_SC01,
			LOCAL.IC_EXM_MLT_DSB = R.IC_EXM_MLT_DSB,
			LOCAL.II_SCL_ELN_PTC = R.II_SCL_ELN_PTC,
			LOCAL.ID_SCL_ELN_PTC_UPD = R.ID_SCL_ELN_PTC_UPD
		WHEN NOT MATCHED THEN
			INSERT 
		(
			IF_IST,
			IC_IST_DPT,
			IM_IST_FUL,
			IX_GEN_STR_ADR_1,
			IX_GEN_STR_ADR_2,
			IX_GEN_STR_ADR_3,
			IM_GEN_CT,
			IC_GEN_ST,
			IF_GEN_ZIP,
			IM_GEN_FGN_CNY,
			IN_GEN_PHN,
			IN_GEN_PHN_XTN,
			IX_GEN_EML_ADR,
			IF_LST_DTS_IN01,
			ID_LST_UPD_IN01,
			II_GEN_VAL_ADR,
			II_GEN_VAL_PHN,
			IF_TAX_ID_NUM,
			IC_DOE_SCL_STA,
			IC_SCL_SUB_STA,
			ID_SCL_SUB_UPD,
			IC_SCL_USB_STA,
			IC_SCL_PLS_STA,
			IC_SCL_SUB_EPN,
			ID_SCL_SUB_EPN_BEG,
			IC_SCL_USB_EPN,
			ID_SCL_USB_EPN_BEG,
			IC_SCL_PLS_EPN,
			ID_SCL_PLS_EPN_BEG,
			IC_CTR_TML,
			II_PRC_CER_LON,
			IC_SCL_AGR,
			ID_SCL_AGR_RTN,
			ID_SCL_AGR_SNT,
			ID_SCL_AGR_UPD,
			IC_NGT_PTC,
			IN_SDL_PTC_YR,
			ID_SDL_PTC_UPD,
			IN_SDL_NON_PTC_YR,
			ID_SDL_NON_PTC_UPD,
			IC_HEA_SCL,
			IC_SCL_TYP,
			IF_LST_DTS_SC01,
			ID_LST_UPD_SC01,
			IC_FRM_OPT,
			IX_DPT_STR_ADR_1,
			IX_DPT_STR_ADR_2,
			IX_DPT_STR_ADR_3,
			IM_DPT_CT,
			IC_DPT_ST,
			IF_DPT_ZIP,
			IN_DPT_PHN,
			IN_DPT_PHN_XTN,
			IF_LST_DTS_IN02,
			ID_LST_UPD_IN02,
			IC_APL_OPT,
			IC_SCL_PRI_LOC,
			IC_SSR_PTC,
			ID_SSR_PTC_CDE_UPD,
			IC_DOE_PGM_LEN,
			IC_SND_OPT,
			IN_CNL_APL_FIL_VRS,
			IN_CNL_CHG_FIL_VRS,
			IC_SCL_SLS_STA,
			IM_IST_SHO,
			IC_KSL_PTC,
			ID_CRT_IN01,
			IC_WEB_APL_PRT_OPT,
			II_PLS_PRC_CER_LON,
			IC_PLS_FRM_OPT,
			IM_GEN_FGN_ST,
			IR_COT_DFL_RTE_1,
			IN_COT_DFL_YR_1,
			IR_COT_DFL_RTE_2,
			IN_COT_DFL_YR_2,
			IR_COT_DFL_RTE_3,
			IN_COT_DFL_YR_3,
			IF_LST_USR_SC01,
			IC_EXM_MLT_DSB,
			II_SCL_ELN_PTC,
			ID_SCL_ELN_PTC_UPD
		)
		VALUES 
		(
			R.IF_IST,
			R.IC_IST_DPT,
			R.IM_IST_FUL,
			R.IX_GEN_STR_ADR_1,
			R.IX_GEN_STR_ADR_2,
			R.IX_GEN_STR_ADR_3,
			R.IM_GEN_CT,
			R.IC_GEN_ST,
			R.IF_GEN_ZIP,
			R.IM_GEN_FGN_CNY,
			R.IN_GEN_PHN,
			R.IN_GEN_PHN_XTN,
			R.IX_GEN_EML_ADR,
			R.IF_LST_DTS_IN01,
			R.ID_LST_UPD_IN01,
			R.II_GEN_VAL_ADR,
			R.II_GEN_VAL_PHN,
			R.IF_TAX_ID_NUM,
			R.IC_DOE_SCL_STA,
			R.IC_SCL_SUB_STA,
			R.ID_SCL_SUB_UPD,
			R.IC_SCL_USB_STA,
			R.IC_SCL_PLS_STA,
			R.IC_SCL_SUB_EPN,
			R.ID_SCL_SUB_EPN_BEG,
			R.IC_SCL_USB_EPN,
			R.ID_SCL_USB_EPN_BEG,
			R.IC_SCL_PLS_EPN,
			R.ID_SCL_PLS_EPN_BEG,
			R.IC_CTR_TML,
			R.II_PRC_CER_LON,
			R.IC_SCL_AGR,
			R.ID_SCL_AGR_RTN,
			R.ID_SCL_AGR_SNT,
			R.ID_SCL_AGR_UPD,
			R.IC_NGT_PTC,
			R.IN_SDL_PTC_YR,
			R.ID_SDL_PTC_UPD,
			R.IN_SDL_NON_PTC_YR,
			R.ID_SDL_NON_PTC_UPD,
			R.IC_HEA_SCL,
			R.IC_SCL_TYP,
			R.IF_LST_DTS_SC01,
			R.ID_LST_UPD_SC01,
			R.IC_FRM_OPT,
			R.IX_DPT_STR_ADR_1,
			R.IX_DPT_STR_ADR_2,
			R.IX_DPT_STR_ADR_3,
			R.IM_DPT_CT,
			R.IC_DPT_ST,
			R.IF_DPT_ZIP,
			R.IN_DPT_PHN,
			R.IN_DPT_PHN_XTN,
			R.IF_LST_DTS_IN02,
			R.ID_LST_UPD_IN02,
			R.IC_APL_OPT,
			R.IC_SCL_PRI_LOC,
			R.IC_SSR_PTC,
			R.ID_SSR_PTC_CDE_UPD,
			R.IC_DOE_PGM_LEN,
			R.IC_SND_OPT,
			R.IN_CNL_APL_FIL_VRS,
			R.IN_CNL_CHG_FIL_VRS,
			R.IC_SCL_SLS_STA,
			R.IM_IST_SHO,
			R.IC_KSL_PTC,
			R.ID_CRT_IN01,
			R.IC_WEB_APL_PRT_OPT,
			R.II_PLS_PRC_CER_LON,
			R.IC_PLS_FRM_OPT,
			R.IM_GEN_FGN_ST,
			R.IR_COT_DFL_RTE_1,
			R.IN_COT_DFL_YR_1,
			R.IR_COT_DFL_RTE_2,
			R.IN_COT_DFL_YR_2,
			R.IR_COT_DFL_RTE_3,
			R.IN_COT_DFL_YR_3,
			R.IF_LST_USR_SC01,
			R.IC_EXM_MLT_DSB,
			R.II_SCL_ELN_PTC,
			R.ID_SCL_ELN_PTC_UPD
		)
		-- !!! uncomment lines below ONLY when doing a full table refresh 
		WHEN NOT MATCHED BY SOURCE THEN
		    DELETE
			
;
'


PRINT @SQLStatement
EXEC (@SQLStatement)


-- ###### VALIDATION
DECLARE 
	@CountDifference INT

SELECT
	@CountDifference = L.LocalCount - R.RemoteCount
FROM
	OPENQUERY
	(
		DUSTER,
		'
			SELECT
				COUNT(*) AS "RemoteCount"
			FROM
				OLWHRM1.SC01_LGS_SCL_INF SC01
		'	
	) R
	FULL OUTER JOIN
	(
		SELECT
			COUNT(*) [LocalCount]
		FROM
			ODW.dbo.SC01_LGS_SCL_INF SC01
	) L 
		ON 1 = 1
	
IF @CountDifference != 0 AND @LoopCount > 0
	BEGIN
		RAISERROR(' SC01_LGS_SCL_INF - The remote and local record counts do not match.  The local count is off by %i records.  A full refresh of the table is required.', 16, 11, @CountDifference)
	END
ELSE IF @CountDifference != 0 AND @LoopCount = 0
	BEGIN

		PRINT 'Loop Count:  ' + CAST(@LoopCount AS VARCHAR(2))

		SET @LoopCount = @LoopCount

		GOTO RefreshStart;

	END
