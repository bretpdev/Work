/*LIBNAME DNFPRQUT DB2 DATABASE=DNFPRQUT OWNER=PKUB;
/*%LET RPTLIB = %SYSGET(REPORTDIR);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORTZ "&RPTLIB/UNWS70.NWS70RZ";
FILENAME REPORT2 "&RPTLIB/UNWS70.NWS70R2";
FILENAME REPORT3 "&RPTLIB/UNWS70.NWS70R3";
FILENAME REPORT4 "&RPTLIB/UNWS70.NWS70R4";
FILENAME REPORT5 "&RPTLIB/UNWS70.NWS70R5";
FILENAME REPORT6 "&RPTLIB/UNWS70.NWS70R6";
FILENAME REPORT7 "&RPTLIB/UNWS70.NWS70R7";


LIBNAME  WORKLOCL  REMOTE  SERVER=LEGEND SLIBREF=WORK  ;
RSUBMIT;
LIBNAME PKUB DB2 DATABASE=DNFPUTDL OWNER=PKUB;

PROC SQL;
	CREATE TABLE INIT_POP AS
		SELECT DISTINCT 
			D.DF_SPE_ACC_ID
			,A.BF_SSN
			,LN16.DAYS_DELQ + 1 AS DAYS_DELQ
			,LN20.LF_EDS
		FROM
			PKUB.PD10_PRS_NME D
			INNER JOIN PKUB.LN10_LON A
				ON A.BF_SSN = D.DF_PRS_ID
			LEFT JOIN PKUB.LN83_EFT_TO_LON LN83
				ON LN83.BF_SSN = A.BF_SSN
				AND LN83.LN_SEQ = A.LN_SEQ
				AND LN83.LC_STA_LN83 ^= 'A' /*NOT ON AUTO PAY*/
			INNER JOIN
				(
					SELECT 
						A.BF_SSN
						,A.LN_SEQ
						,MAX(A.LN_DLQ_MAX) AS DAYS_DELQ
					FROM 
						PKUB.LN16_LON_DLQ_HST A
					WHERE 
						A.LC_STA_LON16 = '1'
						AND	A.LN_DLQ_MAX BETWEEN 30 AND 90
					GROUP BY 
						A.BF_SSN
				) LN16
				ON A.BF_SSN = LN16.BF_SSN
				AND A.LN_SEQ = LN16.LN_SEQ
			INNER JOIN PKUB.DW01_DW_CLC_CLU B
				ON A.BF_SSN = B.BF_SSN
				AND A.LN_SEQ = B.LN_SEQ
			LEFT JOIN PKUB.LN20_EDS LN20
				ON A.BF_SSN = LN20.BF_SSN
				AND A.LN_SEQ = LN20.LN_SEQ
				AND LN20.LC_STA_LON20 = 'A'
		WHERE 
			A.LA_CUR_PRI > 0
			AND A.LC_STA_LON10 = 'R'
			AND B.WC_DW_LON_STA NOT IN ('12','16','17','18','19','20','21','22')
	;

	CREATE TABLE DEMOS AS
		SELECT DISTINCT
			PD10.DF_PRS_ID,
			PD10.DM_PRS_1,
			PD10.DM_PRS_LST,
			EML.DX_ADR_EML
		FROM
			PKUB.PD10_PRS_NME PD10
			JOIN 
				( 
					SELECT 
						XX.DF_PRS_ID,
						COALESCE(X.DX_ADR_EML,COALESCE(Y.DX_ADR_EML,Z.DX_ADR_EML))  AS DX_ADR_EML
					FROM 
						PKUB.PD32_PRS_ADR_EML XX
						LEFT OUTER JOIN PKUB.PD32_PRS_ADR_EML X
							ON XX.DF_PRS_ID = X.DF_PRS_ID
							AND X.DC_ADR_EML = 'H'
							AND X.DC_STA_PD32 = 'A'
							AND X.DI_VLD_ADR_EML = 'Y'
						LEFT OUTER JOIN PKUB.PD32_PRS_ADR_EML Y
							ON XX.DF_PRS_ID = Y.DF_PRS_ID
							AND Y.DC_ADR_EML = 'A'
							AND Y.DC_STA_PD32 = 'A'
							AND Y.DI_VLD_ADR_EML = 'Y'
						LEFT OUTER JOIN PKUB.PD32_PRS_ADR_EML Z
							ON XX.DF_PRS_ID = Z.DF_PRS_ID
							AND Z.DC_ADR_EML = 'W'
							AND Z.DC_STA_PD32 = 'A'
							AND Z.DI_VLD_ADR_EML = 'Y'
					) EML
				ON PD10.DF_PRS_ID = EML.DF_PRS_ID
		WHERE
			EML.DX_ADR_EML IS NOT NULL
	;

	CREATE TABLE BRWS AS
		SELECT DISTINCT
			I.DF_SPE_ACC_ID,
			D.DM_PRS_1,
			D.DM_PRS_LST,
			D.DX_ADR_EML,
			I.BF_SSN,
			I.DAYS_DELQ
		FROM
			INIT_POP I
			JOIN DEMOS D
				ON I.BF_SSN = D.DF_PRS_ID
	;

	CREATE TABLE ENDS AS
		SELECT DISTINCT
			I.DF_SPE_ACC_ID,
			D.DM_PRS_1,
			D.DM_PRS_LST,
			D.DX_ADR_EML,
			I.BF_SSN,
			I.DAYS_DELQ
		FROM
			INIT_POP I
			JOIN DEMOS D
				ON I.LF_EDS = D.DF_PRS_ID
	;
QUIT;

DATA R2;
SET BRWS;
WHERE (DAYS_DELQ BETWEEN 30 AND 40 OR DAYS_DELQ BETWEEN 61 AND 70);
RUN;

DATA R3;
SET ENDS;
WHERE (DAYS_DELQ BETWEEN 30 AND 40 OR DAYS_DELQ BETWEEN 61 AND 70);
RUN;

DATA R4;
SET BRWS;
WHERE (DAYS_DELQ BETWEEN 41 AND 50 OR DAYS_DELQ BETWEEN 71 AND 80);
RUN;

DATA R5;
SET ENDS;
WHERE (DAYS_DELQ BETWEEN 41 AND 50 OR DAYS_DELQ BETWEEN 71 AND 80);
RUN;

DATA R6;
SET BRWS;
WHERE (DAYS_DELQ BETWEEN 51 AND 60 OR DAYS_DELQ BETWEEN 81 AND 90);
RUN;

DATA R7;
SET ENDS;
WHERE (DAYS_DELQ BETWEEN 51 AND 60 OR DAYS_DELQ BETWEEN 81 AND 90);
RUN;

ENDRSUBMIT;

DATA R2;
SET LEGEND.R2;
RUN;

DATA R3;
SET LEGEND.R3;
RUN;

DATA R4;
SET LEGEND.R4;
RUN;

DATA R5;
SET LEGEND.R5;
RUN;

DATA R6;
SET LEGEND.R6;
RUN;

DATA R7;
SET LEGEND.R7;
RUN;

%MACRO BOUNDS(RNUM, NUM);
	DATA _NULL_;
		SET &RNUM ;

		FILE REPORT&NUM DELIMITER=',' DSD DROPOVER LRECL=32767;
		IF _N_ = 1 THEN DO;
			PUT "DF_SPE_ACC_ID,DM_PRS_1,DM_PRS_LST,DX_ADR_EML";
		END;
		DO;
		   PUT DF_SPE_ACC_ID @;
		   PUT DM_PRS_1 @;
		   PUT DM_PRS_LST @;
		   PUT DX_ADR_EML $ ;
		END;
	RUN;
%MEND BOUNDS;

%BOUNDS(R2,2);
%BOUNDS(R3,3);
%BOUNDS(R4,4);
%BOUNDS(R5,5);
%BOUNDS(R6,6);
%BOUNDS(R7,7);
