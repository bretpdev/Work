/*

REFUND REPORT

This report is used by accounting to verify that all refunds due are paid.

*/


/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;
%LET RPTLIB = %SYSGET(reportdir);
FILENAME REPORT2 "&RPTLIB/ULWA01.LWA01R2";*/

LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
DATA _NULL_;
     BEGDATE = PUT(INTNX('MONTH',TODAY(),-1), YYMMDD10.);	/*RESOLVES TO 1ST OF PRIOR MONTH*/
     ENDDATE = PUT(INTNX('MONTH',TODAY(),0)-1 , YYMMDD10.);	/*RESOLVES TO END OF PRIOR MONTH*/
     CALL SYMPUT('BEGIN',"'"||BEGDATE||"'");	            /*CREATES MACRO VARIABLE WITH IN FORMAT  'YYYY/MM/DD'*/
     CALL SYMPUT('END',"'"||ENDDATE||"'");              	/* WILL BE USED AS REPLACEMENTS IN CODE*/
RUN;

%MACRO  MYSQL1 (DATECOL);			                        /* CREATE MACRO MYSQL1 WITH A MACRO VARIABLE DATECOL*/

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE OVS AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT
	A.bf_ssn			AS SSN,
	SUM(A.la_trx)		AS AMOUNT,
	A.lc_trx_typ		AS TYPE,
	A.bd_trx_pst_hst	AS DATE
FROM	OLWHRM1.DC11_LON_FAT A
WHERE	A.bd_trx_pst_hst BETWEEN &BEGIN AND &END AND
		A.lc_trx_typ IN ('OV', 'OR')
GROUP BY A.bf_ssn, A.lc_trx_typ, A.bd_trx_pst_hst
);
DISCONNECT FROM DB2;
%MEND;                                      	/* END MACRO CREATION FOR MYSQL1*/
%MYSQL1 (A.bd_trx_pst_hst);        			   	/* EXECUTE STATEMENTS IN MACRO MYSQL1 WITH*/
ENDRSUBMIT;
PROC SQL;
CREATE TABLE WORKLOCL.OVSPD AS
SELECT
	SSN,
	AMOUNT,
	TYPE,
	DATE
FROM WORKLOCL.OVS
WHERE AMOUNT > 4.99;
PROC SORT DATA=WORKLOCL.OVSPD;
BY TYPE SSN;
RUN;
DATA _NULL_;
     EFFMO = PUT(INTNX('MONTH',TODAY(),-1), MONNAME9.);
	 EFFYR = PUT(INTNX('MONTH',TODAY(),-1), YEAR4.);
     CALL SYMPUT('EFFDATE',EFFMO||' '||EFFYR);
RUN;
/*PROC PRINTTO PRINT=REPORT2;
RUN;*/
OPTIONS CENTER PAGENO=1 LS=80;
PROC PRINT NOOBS SPLIT='/' DATA=WORKLOCL.OVSPD N='NUMBER OF REFUNDS DUE FOR REFUND TYPE = ' 'TOTAL NUMBER OF REFUNDS DUE = ';
BY TYPE;
SUM AMOUNT;
VAR SSN
	AMOUNT
	DATE;
LABEL DATE = 'POSTING DATE';
FORMAT DATE MMDDYY10.;
TITLE1 'OVERPAYMENTS TO BE REFUNDED';
TITLE2 "FOR THE MONTH OF &EFFDATE";
RUN;
