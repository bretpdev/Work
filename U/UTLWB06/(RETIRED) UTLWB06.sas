/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORTZ "&RPTLIB/ULWB06.LWB06RZ";
FILENAME REPORT2 "&RPTLIB/ULWB06.LWB06R2";
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
DATA _NULL_;
DTPARM = today(); 	
	CALL SYMPUT('DAYS_300',"'"||PUT(INTNX('DAY',DTPARM,-300),MMDDYYS10.)||"'");
IF MONTH(DTPARM) < 10 THEN DO;
	CALL SYMPUT('CurChrtYrBeg',YEAR(INTNX('YEAR',DTPARM,-2,'BEGINNING')));
	CALL SYMPUT('CurChrtYrEnd',YEAR(INTNX('YEAR',DTPARM,-1,'BEGINNING')));
	CALL SYMPUT('CurChrtDecYr',YEAR(INTNX('YEAR',DTPARM,0,'BEGINNING')));
END;
ELSE DO;
	CALL SYMPUT('CurChrtYrBeg',YEAR(INTNX('YEAR',DTPARM,-1,'BEGINNING')));
	CALL SYMPUT('CurChrtYrEnd',YEAR(INTNX('YEAR',DTPARM,0,'BEGINNING')));
	CALL SYMPUT('CurChrtDecYr',YEAR(INTNX('YEAR',DTPARM,+1,'BEGINNING')));
END;
DATA _NULL_;
/*CHARACTER DATES FOR PASS THROUGH SQL*/
	CALL SYMPUT('CCURCHRTBEG',"'"||PUT("01OCT&CurChrtYrBeg"D,MMDDYYS10.)||"'");
	CALL SYMPUT('CCURCHRTEND',"'"||PUT("30SEP&CurChrtYrEnd"D,MMDDYYS10.)||"'");

RUN;
%SYSLPUT CCURCHRTBEG = &CCURCHRTBEG ;
%SYSLPUT CCURCHRTEND = &CCURCHRTEND ;
%SYSLPUT DAYS_300 = &DAYS_300 ;
RSUBMIT;

%MACRO SQLCHECK ;
  %IF  &SQLXRC NE 0  %THEN  %DO  ;
    DATA _NULL_  ;
            FILE REPORTZ NOTITLES  ;
            PUT @01 " ********************************************************************* "
              / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
              / @01 " ****  THE SAS SHOULD BE REVIEWED.                                **** "       
              / @01 " ********************************************************************* "
              / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
              / @01 " ****  &SQLXMSG   **** "
              / @01 " ********************************************************************* "
            ;
         RUN  ;
  %END  ;
%MEND  ;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE DEMO AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.BF_SSN
FROM 	OLWHRM1.LN10_LON A
		INNER JOIN
		OLWHRM1.LN16_LON_DLQ_HST B	
			ON A.BF_SSN = B.BF_SSN
			AND A.LN_SEQ = B.LN_SEQ
		INNER JOIN
		OLWHRM1.WQ20_TSK_QUE D
			ON A.BF_SSN = D.BF_SSN
		INNER JOIN (
	SELECT GA01.DF_PRS_ID_BR AS BF_SSN
	FROM OLWHRM1.GA01_APP GA01
	INNER JOIN OLWHRM1.GA10_LON_APP GA10
		ON GA01.AF_APL_ID = GA10.AF_APL_ID
	INNER JOIN OLWHRM1.GA15_NDS_ID GA15
		ON GA10.AF_APL_ID = GA15.AF_APL_ID
		AND GA10.AF_APL_ID_SFX = GA15.AF_APL_ID_SFX
	WHERE GA10.AC_LON_TYP IN ('SF','SU','SL')
		AND GA10.AC_GTE_TRF != 'O'
		AND GA15.AD_NDS_CLC_ENT_RPD BETWEEN &cCurChrtBeg AND &CCURCHRTEND
		AND GA15.AC_STA_GA15 = 'A'
UNION
	SELECT CNSL.BF_SSN
	FROM (
		SELECT A.DF_PRS_ID_BR AS BF_SSN
			,B.AF_APL_ID
			,B.AF_APL_ID_SFX
		FROM OLWHRM1.GA01_APP A
		INNER JOIN OLWHRM1.GA10_LON_APP B
			ON A.AF_APL_ID = B.AF_APL_ID
		WHERE B.AC_LON_TYP = 'CL'
		) CNSL
	INNER JOIN (
			SELECT C.DF_PRS_ID_BR
				,F.AD_NDS_CLC_ENT_RPD
			FROM OLWHRM1.GA01_APP C
			INNER JOIN OLWHRM1.GA10_LON_APP D
				ON C.AF_APL_ID = D.AF_APL_ID
			INNER JOIN (
					SELECT AF_APL_ID
						,AF_APL_ID_SFX
					FROM OLWHRM1.GA14_LON_STA 
					WHERE AC_STA_GA14 = 'A'
					AND AC_LON_STA_TYP = 'PN'
					AND AD_LON_STA BETWEEN &cCurChrtBeg AND &CCURCHRTEND
				) E
				ON D.AF_APL_ID = E.AF_APL_ID
				AND D.AF_APL_ID_SFX = E.AF_APL_ID_SFX
			INNER JOIN (
					SELECT AF_APL_ID
						,AF_APL_ID_SFX
						,AD_NDS_CLC_ENT_RPD
					FROM OLWHRM1.GA15_NDS_ID
					WHERE AC_STA_GA15 = 'A'
					AND AD_NDS_CLC_ENT_RPD BETWEEN &cCurChrtBeg AND &CCURCHRTEND
				) F
				ON D.AF_APL_ID = F.AF_APL_ID
				AND D.AF_APL_ID_SFX = F.AF_APL_ID_SFX
			WHERE D.AC_LON_TYP IN ('SF','SU')
		) USTAF
		ON CNSL.BF_SSN = USTAF.DF_PRS_ID_BR
) BLT
	ON A.BF_SSN = BLT.BF_SSN
WHERE	D.WF_QUE = 'GF'
	AND D.WF_SUB_QUE = 'CF'
	AND	A.LA_CUR_PRI > 0
	AND A.LC_STA_LON10 = 'R'
	AND	B.LD_DLQ_OCC <= &DAYS_300
	AND B.LC_STA_LON16 = '1'
);

DISCONNECT FROM DB2;

/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>> ;  ** INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK;*/
/*QUIT;*/

ENDRSUBMIT;
DATA DEMO;
	SET WORKLOCL.DEMO;
RUN;
DATA _NULL_;
SET DEMO ;
LENGTH COMMENTS $600.;
TARGETID = BF_SSN;
QUEUE_NAME = 'PCHRT300' ;
INSTITUTION_ID = ' ';
INSTITUTION_TYPE = ' ';
DATE_DUE = ' ';
TIME_DUE = ' ';
COMMENTS = 'DEFAULT COHORT LOAN FOR REVIEW' ;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
FORMAT TARGETID $10. ;
FORMAT QUEUE_NAME ;
FORMAT COMMENTS $600. ;
IF _N_ = 1 THEN DO;
	PUT "TARGETID,QUEUE_NAME,INSTITUTION_ID,INSTITUTION_TYPE,DATE_DUE,TIME_DUE,COMMENTS";
END;
DO;
   PUT TARGETID $ @;
   PUT QUEUE_NAME @;
   PUT INSTITUTION_ID @;
   PUT INSTITUTION_TYPE @;
   PUT DATE_DUE @;
   PUT TIME_DUE @;
   PUT COMMENTS $ ;
END;
RUN;
