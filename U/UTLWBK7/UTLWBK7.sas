/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;
%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWBK7.LWBK7R2";
FILENAME REPORT3 "&RPTLIB/ULWBK7.LWBK7R3";

options symbolgen;
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE BXPOC AS
SELECT *
FROM CONNECTION TO DB2 (

SELECT DISTINCT AY01.DF_PRS_ID AS SSN
	,PD01.DF_SPE_ACC_ID AS ANO
	,AY01.PF_ACT AS ACTION
	,AY01.BD_ATY_PRF AS PERFORMED
	,DAYS(AY01.BD_ATY_PRF) AS PERFORMED_DAYS
	,DAYS(CURRENT DATE) - DAYS(AY01.BD_ATY_PRF) AS NUM_DAYS
	,AY01.BF_LST_USR_AY01 AS USERID
	,DAYS(CURRENT DATE) - DAYS(DC18.LD_BKR_POC_DLN) AS POC
	,DC18.LD_BKR_POC_DLN
	,'ONELINK' AS SYSTEM
FROM	OLWHRM1.AY01_BR_ATY AY01
LEFT OUTER JOIN OLWHRM1.DC01_LON_CLM_INF DC01
ON DC01.BF_SSN = AY01.DF_PRS_ID
LEFT OUTER JOIN OLWHRM1.DC18_BKR DC18
ON DC18.AF_APL_ID = DC01.AF_APL_ID
AND DC18.AF_APL_ID_SFX = DC01.AF_APL_ID_SFX
LEFT OUTER JOIN OLWHRM1.PD01_PDM_INF PD01
ON AY01.DF_PRS_ID = PD01.DF_PRS_ID
WHERE AY01.PF_ACT = 'BXPOC'
AND DAYS(AY01.BD_ATY_PRF) BETWEEN DAYS(CURRENT DATE) - 211 AND DAYS(CURRENT DATE) - 60
AND DC18.LC_BKR_STA = '01'
);

CREATE TABLE BPOC1 AS
SELECT *
FROM CONNECTION TO DB2 (

SELECT AY01.DF_PRS_ID AS SSN
	,AY01.PF_ACT AS ACTION
	,AY01.BD_ATY_PRF AS PERFORMED
	,DAYS(AY01.BD_ATY_PRF) AS PERFORMED_DAYS
FROM	OLWHRM1.AY01_BR_ATY AY01
WHERE AY01.PF_ACT = 'BPOC1'
);

CREATE TABLE COMPBXPOC AS
SELECT *
FROM CONNECTION TO DB2 (

SELECT AY10.BF_SSN AS SSN
	,PD10.DF_SPE_ACC_ID AS ANO
	,AY10.PF_REQ_ACT AS ACTION
	,AY10.LD_ATY_RSP AS PERFORMED
	,DAYS(AY10.LD_ATY_RSP) AS PERFORMED_DAYS
	,DAYS(CURRENT DATE) - DAYS(AY10.LD_ATY_RSP) AS NUM_DAYS
	,AY10.LF_PRF_BY AS USERID
	,DAYS(CURRENT DATE) - DAYS(DC18.LD_BKR_POC_DLN) AS POC
	,DC18.LD_BKR_POC_DLN
	,'COMPASS' AS SYSTEM
FROM	OLWHRM1.AY10_BR_LON_ATY AY10
LEFT OUTER JOIN OLWHRM1.DC01_LON_CLM_INF DC01
ON DC01.BF_SSN = AY10.BF_SSN
LEFT OUTER JOIN OLWHRM1.DC18_BKR DC18
ON DC18.AF_APL_ID = DC01.AF_APL_ID
AND DC18.AF_APL_ID_SFX = DC01.AF_APL_ID_SFX
INNER JOIN OLWHRM1.PD24_PRS_BKR PD24
ON AY10.BF_SSN = PD24.DF_PRS_ID
LEFT OUTER JOIN OLWHRM1.PD10_PRS_NME PD10
ON AY10.BF_SSN = PD10.DF_PRS_ID
WHERE AY10.PF_REQ_ACT = 'BXPOC'
and AY10.LC_STA_ACTY10 = 'A'
AND DAYS(AY10.LD_ATY_RSP) BETWEEN DAYS(CURRENT DATE) - 211 AND DAYS(CURRENT DATE) - 59
AND PD24.DC_BKR_STA = '06'
);

DISCONNECT FROM DB2;
ENDRSUBMIT;
DATA BXPOC; SET WORKLOCL.BXPOC; RUN;
DATA  BPOC1; SET WORKLOCL.BPOC1; RUN;
DATA COMPBXPOC; SET WORKLOCL.COMPBXPOC; RUN;
PROC SQL;
CREATE TABLE SEC1A AS
SELECT DISTINCT *
FROM BXPOC
WHERE NOT EXISTS (SELECT SSN FROM BPOC1
					WHERE BPOC1.SSN = BXPOC.SSN
					AND BPOC1.PERFORMED_DAYS > BXPOC.PERFORMED_DAYS)
;
QUIT;

PROC SQL;
CREATE TABLE SEC1B AS
SELECT DISTINCT *
FROM COMPBXPOC
WHERE NOT EXISTS (SELECT SSN FROM BPOC1
					WHERE BPOC1.SSN = COMPBXPOC.SSN
					AND BPOC1.PERFORMED_DAYS > COMPBXPOC.PERFORMED_DAYS)
;
QUIT;

DATA SEC1;
SET SEC1A SEC1B;
RUN;


DATA RP1 RP2;
SET SEC1;
IF NUM_DAYS >= 150 OR POC > 150 THEN OUTPUT RP2;
ELSE OUTPUT RP1;
RUN;


PROC SORT DATA=RP1;
BY ANO;
RUN;

PROC SORT DATA=RP2;
BY ANO;
RUN;

/*For portrait reports;*/
OPTIONS ORIENTATION = PORTRAIT;
OPTIONS CENTER NODATE NUMBER PAGENO=1 PS=52 LS=96;

PROC PRINTTO PRINT=REPORT2 NEW;
RUN;
PROC CONTENTS DATA=RP1 OUT=EMPTYSET NOPRINT;
/*PORTRAIT*/
DATA _NULL_;
SET EMPTYSET;
FILE PRINT;
IF  NOBS=0 AND _N_ =1 THEN DO;
	PUT // 96*'-';
	PUT      ////////
		@35 '**** NO RECORDS FOUND ****';
	PUT ////////
		@38 '-- END OF REPORT --';
	PUT ////////////////
		@27 "JOB = UTLWBK7     REPORT = ULWBK7.LWBK7R2";
	END;
RETURN;
TITLE 'POC Filing QC Report';
TITLE2 'Late POC Filing Review';
RUN;
PROC PRINT NOOBS SPLIT='/' DATA=RP1;
FORMAT PERFORMED MMDDYY10.;
VAR ANO SYSTEM ACTION PERFORMED  ;
TITLE 'POC Filing QC Report';
TITLE2 'Late POC Filing Review';
LABEL ANO = 'ACCOUNT/NUMBER';
FOOTNOTE  'JOB = UTLWBK7     REPORT = ULWBK7.LWBK7R2';
RUN;

PROC PRINTTO PRINT=REPORT3 NEW;
RUN;
PROC CONTENTS DATA=RP2 OUT=EMPTYSET NOPRINT;
/*PORTRAIT*/
DATA _NULL_;
SET EMPTYSET;
FILE PRINT;
IF  NOBS=0 AND _N_ =1 THEN DO;
	PUT // 96*'-';
	PUT      ////////
		@35 '**** NO RECORDS FOUND ****';
	PUT ////////
		@38 '-- END OF REPORT --';
	PUT ////////////////
		@27 "JOB = UTLWBK7     REPORT = ULWBK7.LWBK7R3";
	END;
RETURN;
TITLE 'POC Filing QC Report';
TITLE2 'Urgent POC Filing Review';
RUN;
PROC PRINT NOOBS SPLIT='/' DATA=RP2;
FORMAT PERFORMED MMDDYY10.;
VAR ANO SYSTEM ACTION PERFORMED ;
TITLE 'POC Filing QC Report';
TITLE2 'Urgent POC Filing Review';
LABEL ANO = 'ACCOUNT/NUMBER';
FOOTNOTE  'JOB = UTLWBK7     REPORT = ULWBK7.LWBK7R3';
RUN;

PROC PRINTTO;
RUN;
/*PROC EXPORT DATA=WORKLOCL.DEMO*/
/*            OUTFILE= "T:\SAS\DEMO.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/
