/*LN MNGMNT SPCL CMPGN STATS.*/
/*LOAN MANAGEMENT SPECIAL CAMPAIGN STATISTICS*/
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
/*FILENAME REPORT2 "&RPTLIB/ULWM09.LWM09R2";*/

options symbolgen;
DATA _NULL_;		
	
	CALL SYMPUT('BEGIN',"'"||PUT(INTNX('MONTH',TODAY(),-1,'beginning'), MMDDYYD10.)||"'");
	CALL SYMPUT('END',"'"||PUT(INTNX('MONTH',TODAY(),-1,'end'), MMDDYYD10.)||"'");
RUN;
%SYSLPUT BEGIN = &BEGIN;
%SYSLPUT END = &END;
FILENAME REPORT2 "T:\SAS\ULWM09.LWM09R2";
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE DEMO AS
SELECT *
FROM CONNECTION TO DB2 (

SELECT DISTINCT AY01.DF_PRS_ID AS SSN
	,DAYS(AY01.BD_ATY_PRF) AS BD_ATY_PRF
	,AY01.BD_ATY_PRF AS D_BD_ATY_PRF
	,LC_STA_LON16
	,LN10.LF_DOE_SCL_ORG AS SCHOOLID
	,AY01.PF_ACT AS CODE
	,DC01.LC_STA_DC10
	,DC01.LC_PCL_REA
	,DAYS(DC01.LD_PCL_RCV) AS LD_PCL_RCV
	,LN10.LC_STA_LON10
	,LN10.LA_CUR_PRI
	,DW01.WC_DW_LON_STA
	,SC01.IM_IST_FUL AS SCHOOL
	,DAYS(LN16.LD_DLQ_OCC) AS LD_DLQ_OCC
	,DAYS(CURRENT DATE) AS CDATE
	
FROM OLWHRM1.AY01_BR_ATY AY01
LEFT OUTER JOIN OLWHRM1.DC01_LON_CLM_INF DC01
ON DC01.BF_SSN = AY01.DF_PRS_ID
LEFT OUTER JOIN OLWHRM1.LN10_LON LN10
ON LN10.BF_SSN = AY01.DF_PRS_ID
LEFT OUTER JOIN OLWHRM1.DW01_DW_CLC_CLU DW01
ON DW01.BF_SSN = LN10.BF_SSN
LEFT OUTER JOIN OLWHRM1.SC01_LGS_SCL_INF SC01
ON SC01.IF_IST = LN10.LF_DOE_SCL_ORG
LEFT OUTER JOIN OLWHRM1.LN16_LON_DLQ_HST LN16
ON LN16.BF_SSN = DW01.BF_SSN
AND LN16.LN_SEQ = DW01.LN_SEQ
WHERE AY01.BD_ATY_PRF BETWEEN &BEGIN AND &END 
AND AY01.PF_ACT IN ('ACRDL','APLUS','ADROP','ACONS','ASCON','ALBNC','AUCON')
AND LN10.LI_CON_PAY_STP_PUR <> 'Y'
);

/*GETS NUMBER OF AUCONs FROM LAST MONTH FOR BORROWERS WITH SPECIAL CAMPAIGN*/
CREATE TABLE AUCON AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT 
	AY01.DF_PRS_ID AS SSN
	,DAYS(AY01.BD_ATY_PRF) AS BD_ATY_PRF
	,AY01.BD_ATY_PRF AS D_BD_ATY_PRF
	,AY01.PF_ACT AS CODE2
	,T2.CODE
FROM OLWHRM1.AY01_BR_ATY AY01
INNER JOIN (SELECT DISTINCT AY01.DF_PRS_ID AS SSN
					,AY01.PF_ACT AS CODE
				FROM OLWHRM1.AY01_BR_ATY AY01
				WHERE AY01.BD_ATY_PRF BETWEEN &BEGIN AND &END 
				AND AY01.PF_ACT IN ('ACRDL','APLUS','ADROP','ACONS')
				) T2
	ON T2.SSN = AY01.DF_PRS_ID
INNER JOIN OLWHRM1.LN10_LON LN10
	ON AY01.DF_PRS_ID = LN10.BF_SSN
WHERE AY01.BD_ATY_PRF BETWEEN &BEGIN AND &END 
AND AY01.PF_ACT IN ('AUCON')
AND LN10.LI_CON_PAY_STP_PUR <> 'Y'
);

DISCONNECT FROM DB2;
ENDRSUBMIT;
DATA DEMO; SET WORKLOCL.DEMO; RUN;
DATA AUCON; SET WORKLOCL.AUCON; RUN;
PROC SORT DATA=DEMO;
BY SSN CODE;
RUN;

/*STEP 1*/
PROC SQL;
CREATE TABLE STEP1 AS
SELECT DISTINCT SSN, CODE
FROM DEMO
WHERE CODE IN ('ACRDL','APLUS','ADROP','ACONS') ;
QUIT;

PROC SQL;
CREATE TABLE STEP1B AS
SELECT CODE, COUNT(*) AS S1
FROM STEP1
GROUP BY CODE;
QUIT;

/*STEP 2*/
PROC SQL;
CREATE TABLE STEP2 AS
SELECT DISTINCT SSN, BD_ATY_PRF
FROM DEMO
WHERE CODE = 'ASCON';
QUIT;

PROC SQL;
CREATE TABLE STEP2B AS
SELECT DISTINCT D.SSN, D.CODE
FROM DEMO D 
WHERE CODE IN ('ACRDL','APLUS','ADROP','ACONS') 
AND EXISTS (SELECT * 
				FROM STEP2 S
				WHERE S.SSN = D.SSN
				AND S.BD_ATY_PRF > D.BD_ATY_PRF
				);
QUIT;

PROC SQL;
CREATE TABLE STEP2C AS
SELECT DISTINCT CODE, COUNT(*) AS S2
FROM STEP2B 
GROUP BY CODE;
QUIT;

/*STEP 3*/
PROC SQL;
CREATE TABLE STEP3 AS
SELECT DISTINCT D.SSN, D.CODE, D.BD_ATY_PRF
FROM DEMO D
WHERE CODE IN ('ACRDL','APLUS','ADROP','ACONS')
AND EXISTS (SELECT * 
				FROM DEMO V
				WHERE V.SSN = D.SSN 
				AND V.BD_ATY_PRF > D.BD_ATY_PRF
				AND V.CODE = 'ALBNC')
AND NOT EXISTS (SELECT * 	
				FROM STEP2 S
				WHERE S.SSN = D.SSN 
				AND S.BD_ATY_PRF > D.BD_ATY_PRF) /*ASCON*/
;
QUIT;

PROC SQL;
CREATE TABLE STEP3C AS
SELECT DISTINCT CODE, COUNT(*) AS S3
FROM STEP3
GROUP BY CODE;
QUIT;


PROC SQL;
CREATE TABLE STEP4B AS
SELECT SSN, CODE
FROM AUCON
;
QUIT;

PROC SQL;
CREATE TABLE STEP4C AS
SELECT CODE, COUNT(*) AS S4
FROM STEP4B
GROUP BY CODE;
QUIT;


/*STEP 5*/
PROC SQL;
CREATE TABLE STEP5 AS
SELECT DISTINCT SSN, CODE
FROM DEMO
WHERE LC_STA_DC10 = '01'
AND LC_PCL_REA NOT IN ('BC','BH','BO','DI','DE','CS','FC','IN');
QUIT;

PROC SQL;
CREATE TABLE STEP51 AS
SELECT DISTINCT CODE, COUNT(*) AS S51
FROM STEP5
WHERE CODE IN ('ACRDL','APLUS','ADROP','ACONS') 
GROUP BY CODE;
QUIT;

PROC SQL;
CREATE TABLE STEP52 AS
SELECT DISTINCT SSN, CODE
FROM DEMO D
WHERE CODE IN ('ACRDL','APLUS','ADROP','ACONS')
AND EXISTS (SELECT * 
				FROM STEP5 S
				WHERE S.SSN = D.SSN
			  )
AND D.LD_PCL_RCV > D.BD_ATY_PRF;
QUIT;
PROC SQL;
CREATE TABLE STEP52B AS
SELECT DISTINCT CODE, COUNT(*) AS S52
FROM STEP52
GROUP BY CODE;
QUIT;

PROC SQL;
CREATE TABLE STEP53 AS
SELECT DISTINCT CODE, COUNT(*) AS S53
FROM STEP1 D
WHERE NOT EXISTS (SELECT * 
				FROM STEP5 S
				WHERE S.SSN = D.SSN
			  	)
GROUP BY CODE;
QUIT;

/*STEP 6*/
PROC SQL;
CREATE TABLE STEP6 AS
SELECT DISTINCT SSN, CODE
FROM DEMO
WHERE CODE IN ('ACRDL','APLUS','ADROP','ACONS') 
AND LC_STA_LON10 = 'R'
AND LA_CUR_PRI > 0;
QUIT;

PROC SQL;
CREATE TABLE STEP6B AS
SELECT DISTINCT CODE, COUNT(*) AS S6
FROM STEP6
GROUP BY CODE;
QUIT;

/*STEP 7*/
PROC SQL;
CREATE TABLE STEP7 AS
SELECT DISTINCT SSN, CODE
FROM DEMO
WHERE CODE IN ('ACRDL','APLUS','ADROP','ACONS') 
AND LC_STA_LON10 = 'R'
AND LC_STA_LON16 = '1'
AND WC_DW_LON_STA IN ('01','02','04','05','12','17','19','22','23','88','98')
AND CDATE - LD_DLQ_OCC >= 30;
QUIT;

PROC SQL;
CREATE TABLE STEP7B AS
SELECT DISTINCT CODE, COUNT(*) AS S7
FROM STEP7
GROUP BY CODE;
QUIT;

DATA CONC;
MERGE STEP1B STEP2C STEP3C STEP4C STEP51 STEP52B STEP53 STEP6B STEP7B;
BY CODE;
RUN;
/*DETAIL*/
PROC SORT DATA=DEMO;
BY SCHOOLID SCHOOL;
RUN;

PROC SQL;
CREATE TABLE DETAIL1 AS
SELECT DISTINCT SCHOOLID, SCHOOL, CODE, SSN
FROM DEMO
WHERE CODE IN ('ACRDL','APLUS','ADROP','ACONS') ;
QUIT;

PROC SQL;
CREATE TABLE DETAIL2 AS
SELECT DISTINCT SCHOOLID, SCHOOL, CODE, COUNT(*) AS CNT
FROM DETAIL1
WHERE CODE IN ('ACRDL','APLUS','ADROP','ACONS') 
GROUP BY SCHOOLID, SCHOOL, CODE;
QUIT;

PROC SQL;
CREATE TABLE DACRDL AS
SELECT DISTINCT SCHOOLID, SCHOOL, CNT AS ACRDL
FROM DETAIL2
WHERE CODE IN ('ACRDL') ;
QUIT;

PROC SQL;
CREATE TABLE DAPLUS AS
SELECT DISTINCT SCHOOLID, SCHOOL, CNT AS APLUS
FROM DETAIL2
WHERE CODE IN ('APLUS') ;
QUIT;

PROC SQL;
CREATE TABLE DADROP AS
SELECT DISTINCT SCHOOLID, SCHOOL, CNT AS ADROP
FROM DETAIL2
WHERE CODE IN ('ADROP') ;
QUIT;

PROC SQL;
CREATE TABLE DACONS AS
SELECT DISTINCT SCHOOLID, SCHOOL, CNT AS ACONS
FROM DETAIL2
WHERE CODE IN ('ACONS') ;
QUIT;

DATA DETAILM;
MERGE DACRDL DAPLUS DADROP DACONS;
BY SCHOOLID SCHOOL;
RUN;

DATA DETAIL;
SET DETAILM;
FORMAT TOTAL 8.;
IF ACRDL = . THEN ACRDL = 0;
IF APLUS = . THEN APLUS = 0;
IF ADROP = . THEN ADROP = 0;
IF ACONS = . THEN ACONS = 0;
TOTAL = ACONS + ADROP + APLUS + ACRDL;

RUN;

DATA CONCLUSION;
SET CONC;
FORMAT CODE $19.;
IF S1 = . THEN S1 = 0; 
IF S2 = . THEN S2 = 0;
IF S3 = . THEN S3 = 0;
IF S4 = . THEN S4 = 0;
IF S51 = . THEN S51 = 0;
IF S52 = . THEN S52 = 0;
IF S53 = . THEN S53 = 0;
IF S6 = . THEN S6 = 0;
IF S7 = . THEN S7 = 0;
IF CODE = 'ACRDL' THEN CODE1 = 'CHRONIC DELINQUENTS';
IF CODE = 'APLUS' THEN CODE1 = 'PLUS BORROWERS';
IF CODE = 'ADROP' THEN CODE1 = 'DROP-OUTS';
IF CODE = 'ACONS' THEN CODE1 = 'HIGH BALANCE';

RUN;

PROC PRINTTO PRINT=REPORT2;
RUN;

/*For landscape reports:*/
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127;

/*For portrait reports;*/
/*OPTIONS ORIENTATION = PORTRAIT;*/
/*OPTIONS PS=52 LS=96;*/

PROC REPORT DATA = CONCLUSION NOWD HEADLINE HEADSKIP SPLIT = '/' SPACING=2;
TITLE 'LOAN MANAGEMENT SPECIAL CAMPAIGN STATISTICS';
FOOTNOTE  'JOB = UTLWM09     REPORT = UTLWM09.LWM09R2';
COLUMN CODE1 s1 s2 s3 S4 s51 s52 s53 s6 s7 ;
DEFINE CODE1 / 'SPECIAL/CAMPAIGN' WIDTH = 19; 
DEFINE S1 / 'BRWRS.' WIDTH = 6;
DEFINE S2 / 'SUCCESSFULL/CONTACTS' WIDTH = 11;
DEFINE S3 / 'BORROWER/UNSUCCESSFULL/CONTACTS' WIDTH = 13;
DEFINE S4 / 'TOTAL/UNSUCSFL/ATTEMPTS/MADE' WIDTH = 8;
DEFINE S51 / 'BRWRS./ACTIVE/PRECLAIM' WIDTH = 8;
DEFINE S52 / 'BRWRS./NEW/PRECLAIM' WIDTH = 8;
DEFINE S53 / 'BRWRS./NOT IN/PRECLAIM' WIDTH = 8;
DEFINE S6 / 'SPECIAL/CAMP./BORROWERS/WITH/IN-HOUSE LOANS' WIDTH = 13;
DEFINE S7 / 'CONTACTED/BORROWERS/30 + DAYS/DELINQUENT/STATUS' WIDTH = 13;
RBREAK AFTER / SUMMARIZE SKIP DOL SUPPRESS;
RUN;

PROC REPORT DATA = DETAIL NOWD HEADLINE HEADSKIP SPLIT = '/' SPACING=2;
TITLE 'LOAN MANAGEMENT SPECIAL CAMPAIGN STATISTICS';
TITLE2 'BY SCHOOL';
FOOTNOTE  'JOB = UTLWM09     REPORT = UTLWM09.LWM09R2';
COLUMN SCHOOLID SCHOOL ACONS ADROP APLUS ACRDL TOTAL ;
DEFINE SCHOOLID / 'SCHOOL ID' WIDTH = 9; 
DEFINE SCHOOL / 'SCHOOL NAME' WIDTH = 40;
DEFINE ACRDL / 'CHRONIC/DELENQUENTS' WIDTH = 13;
DEFINE APLUS / 'PLUS/BORROWERS' WIDTH = 9;
DEFINE ADROP / 'DROP/OUTS' WIDTH = 8;
DEFINE ACONS / 'HIGH/BALANCE' WIDTH = 8;
DEFINE TOTAL / 'TOTAL' WIDTH = 8;
RBREAK AFTER / SUMMARIZE SKIP DOL SUPPRESS;
RUN;

/*PROC EXPORT DATA=DEMO*/
/*            OUTFILE= "T:\SAS\DEMO.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/
/**/
/*PROC EXPORT DATA=STEP1*/
/*            OUTFILE= "T:\SAS\STEP1.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/
/*PROC EXPORT DATA=STEP2B*/
/*            OUTFILE= "T:\SAS\STEP2.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/
/*PROC EXPORT DATA=STEP3*/
/*            OUTFILE= "T:\SAS\STEP3.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/
/*PROC EXPORT DATA=STEP4B*/
/*            OUTFILE= "T:\SAS\STEP4.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/
/*PROC EXPORT DATA=STEP5*/
/*            OUTFILE= "T:\SAS\STEP5.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/
/*PROC EXPORT DATA=STEP52*/
/*            OUTFILE= "T:\SAS\STEP52.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/
/*PROC EXPORT DATA=STEP53*/
/*            OUTFILE= "T:\SAS\STEP53.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/
/*PROC EXPORT DATA=STEP6*/
/*            OUTFILE= "T:\SAS\STEP6.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/
/*PROC EXPORT DATA=STEP7*/
/*            OUTFILE= "T:\SAS\STEP7.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/
