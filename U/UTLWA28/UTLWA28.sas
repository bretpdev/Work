*--------------------------------*
| UTLWA28 DAF Billing Statistics |
*--------------------------------*;
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWA28.LWA28R2";
FILENAME REPORT3 "&RPTLIB/ULWA28.LWA28R3";
FILENAME REPORT4 "&RPTLIB/ULWA28.LWA28R4";
FILENAME REPORT5 "&RPTLIB/ULWA28.LWA28R5";
FILENAME REPORT6 "&RPTLIB/ULWA28.LWA28R6";
FILENAME REPORT7 "&RPTLIB/ULWA28.LWA28R7";
FILENAME REPORTZ "&RPTLIB/ULWA28.LWA28RZ";

DATA _NULL_;
	CALL SYMPUT('MONTHS_AGO_12',INTNX('MONTHS',TODAY(),-12,'B'));
	CALL SYMPUT('YEARS_AGO_7',INTNX('YEAR',TODAY(),-7,'S'));
RUN;
%SYSLPUT MONTHS_AGO_12 = &MONTHS_AGO_12;
%SYSLPUT YEARS_AGO_7 = &YEARS_AGO_7;

LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;

RSUBMIT;

%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE DC20 AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT A.*
	,B.AC_LON_STA_TYP
	,GA10.AC_GTE_TRF
FROM OLWHRM1.DC20_FEE_TRF A
INNER JOIN OLWHRM1.GA10_LON_APP GA10
	ON A.AF_APL_ID = GA10.AF_APL_ID
	AND A.AF_APL_ID_SFX = GA10.AF_APL_ID_SFX
LEFT OUTER JOIN OLWHRM1.GA14_LON_STA B
	ON A.AF_APL_ID = B.AF_APL_ID
	AND A.AF_APL_ID_SFX = B.AF_APL_ID_SFX
	AND B.AC_STA_GA14 = 'A'
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;

/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWA28.LWA28RZ);*/
/*QUIT;*/

ENDRSUBMIT;
DATA DC20;SET WORKLOCL.DC20;RUN;

%MACRO A28SQL(DS,WCRT,REP);
PROC SQL;
CREATE TABLE &DS AS
SELECT SUM(LA_PRI) AS PRIN
	,SUM(LA_INT) AS INTR
	,SUM(LA_PRI + LA_INT) AS TOT
	,&REP AS RNUM
FROM DC20
WHERE &WCRT
;
QUIT;
%MEND A28SQL;
%A28SQL(A28R2,LC_REC_STA EQ 'I' AND LD_TRF GE &YEARS_AGO_7,2);
%A28SQL(A28R3,LC_REC_STA EQ 'O' AND LD_TRF GE &YEARS_AGO_7,3);
%A28SQL(A28R4,LC_REC_STA EQ 'I' AND LD_TRF GE &MONTHS_AGO_12,4);
%A28SQL(A28R5,LC_REC_STA EQ 'O' AND LD_TRF GE &MONTHS_AGO_12,5);
PROC SQL;
CREATE TABLE OPEN_LOANS AS 
SELECT
	AF_APL_ID || AF_APL_ID_SFX AS CLUID
	,LC_REC_STA
	,AC_GTE_TRF
	,LA_PRI
	,LA_INT
FROM DC20
WHERE LC_REC_STA IN('I','O')
AND AC_LON_STA_TYP NOT IN ('PC','PF','PN','CA','RF','UI', 'DN', 'CP', 'UA', 'UB', 'UC', 'UD')
;
/*Exclude any loans that have both an 'I' status and an 'O' status.*/
CREATE TABLE EXCLUSIONS AS
SELECT I_RECORDS.CLUID
FROM OPEN_LOANS I_RECORDS
INNER JOIN (
	SELECT CLUID
	FROM OPEN_LOANS
	WHERE LC_REC_STA = 'O'
) O_RECORDS
	ON I_RECORDS.CLUID = O_RECORDS.CLUID
WHERE LC_REC_STA = 'I'
;
CREATE TABLE UNIQUE_LOANS AS
SELECT *
FROM OPEN_LOANS
WHERE CLUID NOT IN (SELECT CLUID FROM EXCLUSIONS)
;
/*Sum the amounts.*/
CREATE TABLE A28R67 AS
SELECT
	LC_REC_STA
	,AC_GTE_TRF
	,SUM(LA_PRI) AS PRINCIPAL
	,SUM(LA_INT) AS INTEREST
	,SUM(LA_PRI + LA_INT) AS TOTAL
FROM UNIQUE_LOANS
GROUP BY LC_REC_STA, AC_GTE_TRF
;
QUIT;
DATA A28R6 (KEEP=PRNTOT INTTOT PATBR RNUM) ;
	SET A28R67 END=LAST;
	WHERE AC_GTE_TRF <> 'O';
	RNUM = 6;
	IF LC_REC_STA = 'O' THEN DO;
		TOTAL = TOTAL * -1;
		PRINCIPAL = PRINCIPAL * -1;
		INTEREST = INTEREST * -1;
	END;
	PRNTOT+PRINCIPAL;
	INTTOT+INTEREST;
	PATBR+TOTAL;
	IF LAST;
RUN;
DATA A28R7 (DROP=LC_REC_STA PRINCIPAL INTEREST TOTAL);
	SET A28R67 END=LAST;
	RNUM = 7;
	PRIN+PRINCIPAL;
	INTR+INTEREST;
	TOT+TOTAL;
	IF LAST;
RUN;
DATA RALL;
SET A28R2 A28R3 A28R4 A28R5 A28R6 A28R7;
RUN;

%MACRO A28REPS(TITLE_TEXT,RNO);
PROC PRINTTO PRINT=REPORT&RNO NEW;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 PAGENO=1 CENTER DATE;
TITLE "&TITLE_TEXT";
FOOTNOTE   "JOB = UTLWA28  	 REPORT = ULWA28.LWA28R&RNO";
PROC PRINT NOOBS SPLIT='/' DATA=RALL WIDTH=UNIFORM WIDTH=MIN LABEL;
	WHERE RNUM = &RNO;
	FORMAT PRIN INTR TOT DOLLAR20.2;
	VAR PRIN INTR TOT;
	LABEL PRIN = 'PRINCIPAL'
		INTR = 'INTEREST'
		TOT = 'TOTAL';
RUN;
PROC PRINTTO;
RUN;
%MEND A28REPS;
%A28REPS(CUMULATIVE DAF BILLED,2);
%A28REPS(CUMULATIVE DAF REBATES,3);
%A28REPS(DAF BILLED LAST 12 MONTHS,4);
%A28REPS(DAF REBATES PAST 12 MONTHS,5);
%A28REPS(POTENTIAL AMOUNT TO BE BILLED,7);
PROC PRINTTO PRINT=REPORT6 NEW;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 PAGENO=1 CENTER DATE;
TITLE "POTENTIAL AMOUNT TO BE REBATED";
FOOTNOTE   "JOB = UTLWA28  	 REPORT = ULWA28.LWA28R6";
PROC PRINT NOOBS SPLIT='/' DATA=RALL WIDTH=UNIFORM WIDTH=MIN LABEL;
	WHERE RNUM = 6;
	FORMAT PRNTOT INTTOT PATBR DOLLAR20.2;
	VAR PRNTOT INTTOT PATBR;
	LABEL PRNTOT = 'PRINCIPAL' 
		INTTOT = 'INTEREST'
		PATBR = 'POTENTIAL AMOUNT TO BE REBATED';
RUN;
PROC PRINTTO;
RUN;
/*detail*/
/*data DC20;*/
/*	set worklocl.dc20;*/
/*run;*/
/*data _null_;*/
/*set  WORK.Dc20;*/
/*file 'T:\SAS\ULWA28.Detail.txt' delimiter=',' DSD DROPOVER lrecl=32767;*/
/*   format AF_APL_ID $17. ;*/
/*   format AF_APL_ID_SFX $2. ;*/
/*   format LF_CRT_DTS_DC20 datetime25.6 ;*/
/*   format LC_REC_TYP $1. ;*/
/*   format LC_REC_STA $1. ;*/
/*   format LA_PRI 11.2 ;*/
/*   format LA_INT 11.2 ;*/
/*   format LA_TRF 11.2 ;*/
/*   format LD_TRF date9. ;*/
/*   format LF_LST_DTS_DC20 datetime25.6 ;*/
/*   format LF_LST_USR_DC20 $8. ;*/
/*   format AC_LON_STA_TYP $2. ;*/
/*if _n_ = 1 then        */
/* do;*/
/*   put*/
/*   'AF_APL_ID'*/
/*   ','*/
/*   'AF_APL_ID_SFX'*/
/*   ','*/
/*   'LF_CRT_DTS_DC20'*/
/*   ','*/
/*   'LC_REC_TYP'*/
/*   ','*/
/*   'LC_REC_STA'*/
/*   ','*/
/*   'LA_PRI'*/
/*   ','*/
/*   'LA_INT'*/
/*   ','*/
/*   'LA_TRF'*/
/*   ','*/
/*   'LD_TRF'*/
/*   ','*/
/*   'LF_LST_DTS_DC20'*/
/*   ','*/
/*   'LF_LST_USR_DC20'*/
/*   ','*/
/*   'AC_LON_STA_TYP'*/
/*   ;*/
/*end;*/
/*do;*/
/*   put AF_APL_ID $ @;*/
/*   put AF_APL_ID_SFX $ @;*/
/*   put LF_CRT_DTS_DC20 @;*/
/*   put LC_REC_TYP $ @;*/
/*   put LC_REC_STA $ @;*/
/*   put LA_PRI @;*/
/*   put LA_INT @;*/
/*   put LA_TRF @;*/
/*   put LD_TRF @;*/
/*   put LF_LST_DTS_DC20 @;*/
/*   put LF_LST_USR_DC20 $ @;*/
/*   put AC_LON_STA_TYP $ ;*/
/*   ;*/
/*end;*/
/*run;*/
