*----------------------------------*
| UTLWM20 PRECLAIM 150 + DELINQUENT REPORT |
*----------------------------------*;

/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
/*FILENAME REPORT2 "&RPTLIB/ULWM20.LWM20R2";*/
/*FILENAME REPORTZ "&RPTLIB/ULWM20.LWM20RZ";*/

LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
/*%LET RPTLIB = T:\SAS;*/
FILENAME REPORT2 "T:\SAS\ULWM20.LWM20R2.txt";

RSUBMIT;
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE POHFPDR AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT B.DF_SPE_ACC_ID
	,SUM(COALESCE(A.LA_CLM_PRI,0)) AS LA_CLM_PRI
	,DAYS(CURRENT DATE) - DAYS(A.LD_DCO) AS CDMIND
	,CASE 
		WHEN D.DI_PHN_VLD = 'N' AND D.DI_VLD_ADR IN ('Y','') THEN 'X'
		ELSE ''
	 END AS P
	,CASE 
		WHEN D.DI_PHN_VLD IN ('Y','') AND D.DI_VLD_ADR = 'N' THEN 'X'
		ELSE ''
	 END AS A
	 ,CASE 
		WHEN D.DI_PHN_VLD = 'N' AND D.DI_VLD_ADR = 'N' THEN 'X'
		ELSE ''
	 END AS B
FROM OLWHRM1.DC01_LON_CLM_INF A
INNER JOIN OLWHRM1.PD01_PDM_INF B
	ON A.BF_SSN = B.DF_PRS_ID
INNER JOIN OLWHRM1.GA14_LON_STA C
	ON A.AF_APL_ID = C.AF_APL_ID
	AND A.AF_APL_ID_SFX = C.AF_APL_ID_SFX
	AND C.AC_STA_GA14 = 'A'
LEFT OUTER JOIN OLWHRM1.PD03_PRS_ADR_PHN D
	ON B.DF_PRS_ID = D.DF_PRS_ID
	AND D.DC_ADR = 'L'
WHERE A.LC_STA_DC10 = '01'
AND C.AC_LON_STA_REA = 'DF'
AND DAYS(CURRENT DATE) - DAYS(A.LD_DCO) >= 150 
GROUP BY B.DF_SPE_ACC_ID
	,DAYS(CURRENT DATE) - DAYS(A.LD_DCO) 
	,CASE 
		WHEN D.DI_PHN_VLD = 'N' AND D.DI_VLD_ADR IN ('Y','') THEN 'X'
		ELSE ''
	 END 
	,CASE 
		WHEN D.DI_PHN_VLD IN ('Y','') AND D.DI_VLD_ADR = 'N' THEN 'X'
		ELSE ''
	 END 
	 ,CASE 
		WHEN D.DI_PHN_VLD = 'N' AND D.DI_VLD_ADR = 'N' THEN 'X'
		ELSE ''
	 END 
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;

/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWS23.LWS23RZ);*/
/*QUIT;*/
ENDRSUBMIT;

DATA POHFPDR;
SET WORKLOCL.POHFPDR;
RUN;

PROC SORT DATA=POHFPDR;
BY CDMIND DF_SPE_ACC_ID ;
RUN;

PROC PRINTTO PRINT=REPORT2 NEW;
RUN;

OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 PAGENO=1 CENTER DATE;
TITLE 'PRECLAIM 150 + DELINQUENT REPORT';
FOOTNOTE 'JOB = UTLWM20  	 REPORT = ULWM20.LWM20R2';

PROC CONTENTS DATA=POHFPDR OUT=EMPTYSET NOPRINT;
DATA _NULL_;
SET EMPTYSET;
FILE PRINT;
IF  NOBS=0 AND _N_ =1 THEN DO;
	PUT // 127*'-';
	PUT      //////
		@51 '**** NO OBSERVATIONS FOUND ****';
	PUT //////
		@57 '-- END OF REPORT --';
	PUT //////////////
		@46 "JOB = UTLWM20  	 REPORT = ULWM20.LWM20R2";
	END;
RETURN;
RUN;

PROC PRINT NOOBS SPLIT='/' DATA=POHFPDR WIDTH=UNIFORM WIDTH=MIN;
FORMAT LA_CLM_PRI DOLLAR10.2;
VAR DF_SPE_ACC_ID
	CDMIND 
	LA_CLM_PRI
	P
	A
	B;
LABEL DF_SPE_ACC_ID = 'ACCOUNT NUMBER'
	LA_CLM_PRI = 'PRINCIPAL BALANCE'
	CDMIND = 'DAYS DELINQUENT';
RUN;

PROC PRINTTO;
RUN;
