/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/UNWS19.NWS19R2";
FILENAME REPORTZ "&RPTLIB/UNWS19.NWS19RZ";
FILENAME REPORT3 "&RPTLIB/UNWS19.NWS19R3";


LIBNAME  LEGEND REMOTE  SERVER=LEGEND  SLIBREF=WORK;
RSUBMIT LEGEND;
/*%let DB = DNFPRQUT;  *This is test;*/
%let DB = DNFPUTDL;  *This is live;

LIBNAME PKUB DB2 DATABASE=&DB OWNER=PKUB;
LIBNAME PKUR DB2 DATABASE=&DB OWNER=PKUR;
LIBNAME FRDWODS DB2 DATABASE=&DB OWNER=FRDWODS;

PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE TESTQUERY AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT D.DF_SPE_ACC_ID
	,CASE 
		WHEN E.DD_VER_ADR_HST < C.LD_STA_RPST10 THEN '2'
		ELSE '3'
	END AS REP

FROM pkub.PD10_PRS_NME D
inner join pkub.PD30_PRS_ADR b
	on d.df_prs_id = b.df_prs_id
inner join pkub.PD31_PRS_INA e
	on d.df_prs_id = e.df_prs_id
INNER JOIN pkub.LN10_LON a
	ON D.DF_PRS_ID = A.BF_SSN
INNER JOIN pkub.DW01_DW_CLC_CLU G
	ON A.BF_SSN = G.BF_SSN
	AND A.LN_SEQ = G.LN_SEQ
INNER JOIN pkub.RS10_BR_RPD C
	ON D.DF_PRS_ID = C.BF_SSN
LEFT OUTER JOIN PKUB.AY10_BR_LON_ATY F
	ON E.DF_PRS_ID = F.BF_SSN
	AND F.LD_ATY_REQ_RCV > E.DD_VER_ADR_HST
	AND (F.PF_REQ_ACT = 'RPY35' AND F.PF_RSP_ACT = 'COMPL'
				OR F.PF_REQ_ACT = 'B314Q' AND F.PF_RSP_ACT = 'PRNTD'
				OR F.PF_REQ_ACT = 'G101E' AND F.PF_RSP_ACT = 'PRNTD'
				OR F.PF_REQ_ACT = 'INVRO')
where a.lc_sta_lon10 = 'R'
	and a.la_cur_pri > 0
	AND A.LC_STP_PUR != 'Y'
	and b.di_vld_adr = 'Y'
	AND B.DC_ADR = 'L'
	AND G.WC_DW_LON_STA IN ('03','13','14','15')
	AND E.DC_ADR_HST = 'L'
	AND E.DI_VLD_ADR_HST = 'N'
	AND E.DD_CRT_PD31 > C.LD_STA_RPST10
	AND DAYS(E.DD_VER_ADR_HST) <= DAYS(C.LD_STA_RPST10) + 30
	and E.DD_VER_ADR_HST < E.DD_CRT_PD31
	AND DAYS(C.LD_STA_RPST10) >= DAYS(CURRENT DATE) - 241
	AND F.BF_SSN IS NULL

FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;

/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>> ;  ** INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK;*/
QUIT;

ENDRSUBMIT;
DATA TESTQUERY; SET LEGEND.TESTQUERY; RUN;
proc sort data=testquery; by df_spe_acc_id; run;
DATA _NULL_;
SET TESTQUERY ;
where rep = '2';
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
PUT DF_SPE_ACC_ID 'INVRO,,,,,,,ALL,Requesting system queue to regenerate RPS once skip borrower is found' ;
RUN;

DATA _NULL_;
SET TESTQUERY ;
where rep = '3';
FILE REPORT3 DELIMITER=',' DSD DROPOVER LRECL=32767;
PUT DF_SPE_ACC_ID 'INVRO,,,,,,,ALL,Requesting system queue to regenerate RPS once skip borrower is found' ;
RUN;
