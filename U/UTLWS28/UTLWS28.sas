*------------------------------------------------------*
| UTLWS28 Identify System Generated Due Diligence ARCs |
*------------------------------------------------------*;
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWS28.LWS28R2";
FILENAME REPORTZ "&RPTLIB/ULWS28.LWS28RZ";
DATA _NULL_;
	CALL SYMPUT('DAYS_AGO_28',"'"||PUT(INTNX('DAY',TODAY(),-28,'BEGINNING'), MMDDYYD10.)||"'");
RUN;
%SYSLPUT DAYS_AGO_28 = &DAYS_AGO_28;
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE DUPARC AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT A.BF_SSN
	,A.PF_REQ_ACT 		
	,A.LF_USR_REQ_ATY 	
	,A.LD_ATY_REQ_RCV 	
FROM OLWHRM1.AY10_BR_LON_ATY A
WHERE A.LD_ATY_REQ_RCV >= &DAYS_AGO_28
	AND A.PF_REQ_ACT IN 
	(
		'DL200','DL201','DL400','DL401',
		'DL800','DL801','DL910','DL911',
		'DL140','DL141','DL170','DL171',
		'DL202','DL203','DL230'
	)
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWS28.LWS28RZ);*/
/*QUIT;*/
ENDRSUBMIT;
DATA DUPARC;
	SET WORKLOCL.DUPARC ;
RUN;
DATA SYS USR;
	SET DUPARC;
	IF SUBSTR(LF_USR_REQ_ATY,1,4) = 'UT00' THEN 
		OUTPUT USR;
	ELSE 
		OUTPUT SYS;
RUN;
PROC SQL;
	CREATE TABLE DUPARC AS 
		SELECT A.BF_SSN
			,A.PF_REQ_ACT
			,A.LD_ATY_REQ_RCV
			,A.LF_USR_REQ_ATY
		FROM SYS A
		INNER JOIN USR B
			ON A.BF_SSN = B.BF_SSN
	;	
QUIT;
PROC SORT DATA=DUPARC;
	BY LD_ATY_REQ_RCV;
RUN;
DATA _NULL_;
SET  WORK.DUPARC;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
   FORMAT BF_SSN $9. ;
   FORMAT PF_REQ_ACT $5. ;
   FORMAT LD_ATY_REQ_RCV MMDDYY10. ;
   FORMAT LF_USR_REQ_ATY $8. ;
IF _N_ = 1 THEN DO;
   PUT 'BF_SSN,PF_REQ_ACT,LD_ATY_REQ_RCV,LF_USR_REQ_ATY';
END;
DO;
   PUT BF_SSN $ @;
   PUT PF_REQ_ACT $ @;
   PUT LD_ATY_REQ_RCV @;
   PUT LF_USR_REQ_ATY $ ;
END;
RUN;
