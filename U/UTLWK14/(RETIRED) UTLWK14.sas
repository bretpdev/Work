/*============================================*/
/*UTLWK14 COMPASS CHAPTER 13 BANKRUPTCY REVIEW*/
/*============================================*/
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWK14.LWK14R2";
FILENAME REPORTZ "&RPTLIB/ULWK14.LWK14RZ";

DATA _NULL_;
     CALL SYMPUT('DT1',"'"||PUT(INTNX('DAY',TODAY(),-30,'BEGINNING'), MMDDYYD10.)||"'");
	 CALL SYMPUT('DT2',"'"||PUT(INTNX('DAY',TODAY(),-180,'BEGINNING'), MMDDYYD10.)||"'");
 	 CALL SYMPUT('RUNDT',PUT(INTNX('DAY',TODAY(),0,'BEGINNING'), MMDDYYS10.));
RUN;

%SYSLPUT DT1 = &DT1;
%SYSLPUT DT2 = &DT2;
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE CC13BR AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.BF_SSN
	,B.DD_BKR_FIL
	,B.DD_BKR_NTF
	,B.DC_BKR_TYP
	,B.DD_BKR_STA
	,B.DF_COU_DKT
	,C.EXCLD
	,D.MAXREV
FROM OLWHRM1.LN10_LON A
INNER JOIN OLWHRM1.PD24_PRS_BKR B
	ON A.BF_SSN = B.DF_PRS_ID
	AND B.DC_BKR_STA = '06'
LEFT OUTER JOIN (
	 SELECT X.DF_PRS_ID
		,'Y' AS EXCLD
	 FROM OLWHRM1.AY01_BR_ATY X
	 INNER JOIN OLWHRM1.PD24_PRS_BKR Y
	 	ON X.DF_PRS_ID = Y.DF_PRS_ID
	 WHERE X.PF_ACT = 'DBKRW'
	 AND X.BD_ATY_PRF > &DT1
	 AND Y.DC_BKR_TYP = '13'
	 ) C
	ON A.BF_SSN = C.DF_PRS_ID
LEFT OUTER JOIN (
	 SELECT DF_PRS_ID
		,MAX(BD_ATY_PRF) AS MAXREV 
	 FROM OLWHRM1.AY01_BR_ATY 
	 WHERE PF_ACT = 'DBKRW'
	 GROUP BY DF_PRS_ID
	 ) D
	ON A.BF_SSN = C.DF_PRS_ID
WHERE A.LA_CUR_PRI > 0
AND A.LC_STA_LON10 = 'R'
AND A.IC_LON_PGM <> 'TILP'
AND B.DD_BKR_FIL <= &DT2 
AND B.DC_BKR_TYP = '13'
AND NOT EXISTS (
	SELECT *
	FROM OLWHRM1.CT30_CALL_QUE Y
	WHERE Y.DF_PRS_ID_BR = A.BF_SSN
	AND Y.IF_WRK_GRP = 'BKCP13RV'
	)
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWK14.LWK14RZ);*/
/*QUIT;*/
ENDRSUBMIT;
DATA CC13BR;
SET WORKLOCL.CC13BR;
RUN;

DATA CC13BR;
SET CC13BR;
IF EXCLD = 'Y' THEN DELETE;
ELSE OUTPUT;
RUN;

PROC SORT DATA=CC13BR;
BY BF_SSN;
RUN;

/*-----------------------------------------------------------------------------*
| THIS MACRO WILL CHANGE DATES INTO STIRNGS SO THEY CAN BE CONCATINATED IN THE |
| COMMENTS VARIABLE                                                            |
*-----------------------------------------------------------------------------*/
%MACRO DATE_2_CHAR(DS,CDATE,DAYPART);
DATA &DS;
SET &DS;
LENGTH &DAYPART $ 10. ;
IF &CDATE = . THEN DO;
	&DAYPART = '';
	END;
ELSE IF DAY(&CDATE) < 10 AND MONTH(&CDATE) < 10 THEN DO;
	&DAYPART = '0'||TRIM(LEFT(MONTH(&CDATE)))||'/'||'0'||TRIM(LEFT(DAY(&CDATE)))||'/'||TRIM(LEFT(YEAR(&CDATE)));
	END;
ELSE IF DAY(&CDATE) < 10 AND MONTH(&CDATE) >= 10 THEN DO;
	&DAYPART = TRIM(LEFT(MONTH(&CDATE)))||'/'||'0'||TRIM(LEFT(DAY(&CDATE)))||'/'||TRIM(LEFT(YEAR(&CDATE)));
	END;
ELSE IF DAY(&CDATE) >= 10 AND MONTH(&CDATE) < 10 THEN DO;
	&DAYPART ='0'||TRIM(LEFT(MONTH(&CDATE)))||'/'||TRIM(LEFT(DAY(&CDATE)))||'/'||TRIM(LEFT(YEAR(&CDATE)));
	END;
ELSE DO;
	&DAYPART = TRIM(LEFT(MONTH(&CDATE)))||'/'||TRIM(LEFT(DAY(&CDATE)))||'/'||TRIM(LEFT(YEAR(&CDATE)));
	END;
RUN;
%MEND DATE_2_CHAR;
%DATE_2_CHAR(CC13BR,DD_BKR_FIL,CHAR_DD_BKR_FIL);
%DATE_2_CHAR(CC13BR,DD_BKR_STA,CHAR_DD_BKR_STA);
%DATE_2_CHAR(CC13BR,DD_BKR_NTF,CHAR_DD_BKR_NTF);
%DATE_2_CHAR(CC13BR,MAXREV,CHAR_MAXREV);

/*------------------ VARIABLE INITIALIZATION ------------------*/
DATA CC13BR (KEEP=TARGET_ID QUEUE_NAME INSTITUTION_ID INSTITUTION_TYPE DATE_DUE TIME_DUE COMMENTS);
SET CC13BR ;
LENGTH COMMENTS $ 600.;
TARGET_ID = BF_SSN;
QUEUE_NAME = 'BKCP13RV';
INSTITUTION_ID = '';
INSTITUTION_TYPE = '';
DATE_DUE = '';
TIME_DUE = '';
COMMENTS = 'Compass BK Filed Date: '||TRIM(LEFT(CHAR_DD_BKR_FIL))||','||
	'BK Status: '||TRIM(LEFT(CHAR_DD_BKR_STA))||','||
	'BK Chapter: '||TRIM(LEFT(DC_BKR_TYP))||','||
	'BK Doc: '||TRIM(LEFT(DF_COU_DKT))||','||
	'Last RVW: '||TRIM(LEFT(CHAR_MAXREV))||','||
	'Date Not: '||TRIM(LEFT(CHAR_DD_BKR_NTF));
RUN;

DATA _NULL_;
SET  WORK.CC13BR; 
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
   FORMAT COMMENTS $600. ;
   FORMAT TARGET_ID $9. ;
   FORMAT QUEUE_NAME $8. ;
   FORMAT INSTITUTION_ID $1. ;
   FORMAT INSTITUTION_TYPE $1. ;
   FORMAT DATE_DUE $1. ;
   FORMAT TIME_DUE $1. ;
DO;
	PUT TARGET_ID $ @;
	PUT QUEUE_NAME $ @;
	PUT INSTITUTION_ID $ @;
	PUT INSTITUTION_TYPE $ @;
	PUT DATE_DUE $ @;
	PUT TIME_DUE $ @;
	PUT COMMENTS $ ;
END;
RUN;
