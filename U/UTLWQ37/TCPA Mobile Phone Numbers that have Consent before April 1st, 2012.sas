/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORTZ "&RPTLIB/ULWQ37.LWQ37RZ";
FILENAME REPORT2 "&RPTLIB/ULWQ37.LWQ37R2";
FILENAME REPORT3 "&RPTLIB/ULWQ37.LWQ37R3";
FILENAME REPORT4 "&RPTLIB/ULWQ37.LWQ37R4";
FILENAME REPORT5 "&RPTLIB/ULWQ37.LWQ37R5";

LIBNAME  DUSTER  REMOTE  SERVER=DUSTER  SLIBREF=WORK;
RSUBMIT;

%MACRO SQLCHECK ;
  %IF  &SQLXRC NE 0  %THEN  %DO  ;
    DATA _NULL_  ;
            FILE REPORTZ NOTITLES  ;
            PUT @01 " ********************************************************************* "
              / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
              / @01 " ****  THE SAS SHOULD BE REVIEWED.                                **** "       
              / @01 " ********************************************************************* "
              / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
              / @01 " ****  &SQLXMSG   **** "
              / @01 " ********************************************************************* "
            ;
         RUN  ;
  %END  ;
%MEND  ;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE NREF AS
	SELECT	*
	FROM	CONNECTION TO DB2 (
		SELECT DISTINCT 
			PD10.DF_SPE_ACC_ID
		FROM
			OLWHRM1.PD10_PRS_NME PD10
		INNER JOIN OLWHRM1.PD42_PRS_PHN PD42
			ON PD10.DF_PRS_ID = PD42.DF_PRS_ID
		INNER JOIN OLWHRM1.LN10_LON LN10
			ON PD10.DF_PRS_ID = LN10.BF_SSN
		WHERE PD42.DI_PHN_VLD = 'Y'
			AND PD42.DC_ALW_ADL_PHN IN ('P','X')
			AND PD42.DF_LST_DTS_PD42 < '04/01/2012'
			AND LN10.LA_CUR_PRI > 0
			AND LN10.LC_STA_LON10 = 'R'
			FOR READ ONLY WITH UR
		);
QUIT;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);	
CREATE TABLE REF AS
SELECT *
FROM	
	CONNECTION TO DB2(
	SELECT DISTINCT
		RF10.BF_RFR
	FROM	
		OLWHRM1.RF10_RFR RF10
	LEFT JOIN OLWHRM1.PD42_PRS_PHN PD42
		ON	RF10.BF_RFR = PD42.DF_PRS_ID
	INNER JOIN OLWHRM1.LN10_LON LN10
		ON RF10.BF_SSN = LN10.BF_SSN
	WHERE	
		LN10.LA_CUR_PRI > 0
		AND	LN10.LC_STA_LON10 = 'R'
		AND	PD42.DI_PHN_VLD = 'Y'
		AND PD42.DC_ALW_ADL_PHN IN ('P','X')
		AND	PD42.DF_LST_DTS_PD42 < '04/01/2012'
		AND RF10.BC_STA_REFR10 = 'A'
		AND SUBSTR(RF10.BF_RFR,1,1) = 'P'
			FOR READ ONLY WITH UR
		);
QUIT;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE ONELINK_REF AS
SELECT *
FROM CONNECTION TO DB2 (
	SELECT DISTINCT	
		BR03.DF_PRS_ID_RFR
	FROM
		OLWHRM1.BR03_BR_REF BR03
	INNER JOIN OLWHRM1.DC01_LON_CLM_INF DC01
		ON DC01.BF_SSN = BR03.DF_PRS_ID_BR
	INNER JOIN OLWHRM1.GA10_LON_APP GA10
		ON GA10.AF_APL_ID = DC01.AF_APL_ID
		AND GA10.AF_APL_ID_SFX = DC01.AF_APL_ID_SFX
	
	WHERE
	(
		(BR03.BI_DOM_PHN_VLD = 'Y' AND BR03.BC_PRI_PHN_ALW = 'Y')
		OR
		(BR03.BI_ALT_PHN_VLD = 'Y' AND BR03.BC_ALT_PHN_ALW = 'Y')
		AND GA10.AA_CUR_PRI > 0
		AND BR03.BD_PHN_DAT_EFF < '08/10/2012'

	)
);
/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>> ;  ** INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK;*/
DISCONNECT FROM DB2;
QUIT;
ENDRSUBMIT;

DATA ONELINK_REF;
SET DUSTER.ONELINK_REF;
RUN;
DATA NREF;
SET DUSTER.NREF; 
RUN;
DATA REF;
SET DUSTER.REF; 
RUN;

PROC SQL;
CREATE TABLE FILE_COUNTS AS 
	SELECT
		DESCRIPTION,
		COUNT
	FROM
		(
			SELECT
				'TOTAL NUMBER OF PHONE NUMBERS FOR COMPASS BORROWERS, STUDENTS, ENDORSERS, COMAKERS, COSIGNERS, AND COBORROWERS' AS DESCRIPTION,
				COUNT(DF_SPE_ACC_ID) AS COUNT
			FROM
				NREF
		UNION
			SELECT
				'TOTAL NUMBER OF PHONE NUMBERS FOR ONELINK REFERENCES' AS DESCRIPTION,
				COUNT(DF_PRS_ID_RFR) AS COUNT
			FROM
				ONELINK_REF
		UNION
			SELECT
				'TOTAL NUMBER OF PHONE NUMBERS FOR COMPASS REFERENCES' AS DESCRIPTION,
				COUNT(BF_RFR) AS COUNT
			FROM
				REF
		)

;

CREATE TABLE TOT_COUNT AS
		SELECT
			'SUM OF ALL PHONE NUMBERS THAT WERE IDENTIFIED BY ALL REPORTS' AS DESCRIPTION,
			SUM(COUNT) AS CNT
		FROM
			FILE_COUNTS
;
QUIT;

DATA COUNTS;
SET FILE_COUNTS TOT_COUNT;
RUN;

 data _null_;
 	set  WORK.NREF;
 	format DF_SPE_ACC_ID $10. ;
 	file Report2 delimiter=',' DSD DROPOVER lrecl=32767;
 	if _n_ = 1 then do;		
		put "DF_SPE_ACC_ID";
	end;
	do;
		put DF_SPE_ACC_ID $ ;
	end;
run;

 data _null_;
 	set  WORK.REF;
 	format BF_RFR $10. ;
 	file Report4 delimiter=',' DSD DROPOVER lrecl=32767;
 	if _n_ = 1 then do;		
		put "BF_RFR";
	end;
	do;
		put BF_RFR $ ;
	end;
run;


 data _null_;
 	set  WORK.ONELINK_REF;
 	format DF_PRS_ID_RFR $10. ;
 	file Report3 delimiter=',' DSD DROPOVER lrecl=32767;
 	if _n_ = 1 then do;		
		put "DF_PRS_ID_RFR";
	end;
	do;
		put DF_PRS_ID_RFR $ ;
	end;
run;

PROC EXPORT DATA= WORK.COUNTS 
            OUTFILE= REPORT5
            DBMS=CSV REPLACE;
     PUTNAMES=NO;
RUN;
