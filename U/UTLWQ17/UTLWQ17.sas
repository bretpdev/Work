/*UTLWQ17 - AUX STATUS UPDATES*/
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWQ17.LWQ17R2";
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;

/*************************************************************
This query was used to originally populate the table on duster.  
It can be used to update the table when necessary, but must be 
commented in production code.
**************************************************************/
/*PROC SQL; */
/*CONNECT TO ODBC AS BSYS (REQUIRED="FILEDSN=X:\PADR\ODBC\BSYS.dsn;");*/
/*CREATE TABLE RFDR AS*/
/*SELECT **/
/*FROM CONNECTION TO BSYS (*/
/*	SELECT DISTINCT A.USERID*/
/*	FROM DBO.SYSA_LST_USERIDINFO A*/
/*	INNER JOIN (SELECT BUSINESSUNIT*/
/*					,WINDOWSUSERID*/
/*			FROM DBO.GENR_REF_BU_AGENT_XREF */
/*			WHERE BUSINESSUNIT = 'Loan Management'*/
/*	) B*/
/*		ON A.WINDOWSUSERNAME = B.WINDOWSUSERID*/
/**/
/*	);*/
/*DISCONNECT FROM BSYS;*/
/*QUIT;*/
/*DATA WORKLOCL.RFDR;*/
/*SET RFDR;*/
/*RUN;*/
RSUBMIT;
LIBNAME HLDIR V8 '/sas/whse/progrevw';
/*comment for live*/
/*DATA HLDIR.RFDR;*/ 
/*	SET WORK.RFDR;*/
/*RUN;*/

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);				
CREATE TABLE DOAUX AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT C.DF_SPE_ACC_ID
	,B.LD_AUX_STA_UPD
	,SUBSTR(BX_CMT,LENGTH(BX_CMT)-9,11) AS USER_ID
	,B.LC_AUX_STA
FROM OLWHRM1.PD01_PDM_INF C
INNER JOIN OLWHRM1.DC01_LON_CLM_INF B 
	ON C.DF_PRS_ID = B.BF_SSN
INNER JOIN OLWHRM1.AY01_BR_ATY A
	ON C.DF_PRS_ID = A.DF_PRS_ID 
WHERE A.PF_ACT = 'DOAUX'
	AND DAYS(A.BD_ATY_PRF) >= DAYS(CURRENT DATE) - 1
	AND B.LD_AUX_STA_UPD = (SELECT MAX(D.LD_AUX_STA_UPD)		 
				 FROM OLWHRM1.DC01_LON_CLM_INF D
	 			 WHERE B.AF_APL_ID = D.AF_APL_ID
	 				 AND B.AF_APL_ID_SFX = D.AF_APL_ID_SFX)
)
WHERE USER_ID NOT IN (SELECT * FROM HLDIR.RFDR)
;
DISCONNECT FROM DB2;
ENDRSUBMIT;

DATA DOAUX;
SET WORKLOCL.DOAUX;
RUN;

DATA _NULL_;
SET DOAUX ;
LENGTH DESCRIPTION $600.;
USER = USER_ID;
ACT_DT = LD_AUX_STA_UPD;
DESCRIPTION = CATX(',',
	'ACCOUNT NUMBER = '||DF_SPE_ACC_ID,
	'AUX STATUS = '||LC_AUX_STA);
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
FORMAT ACT_DT MMDDYY10. ;
/*FORMAT DESCRIPTION $600. ;*/
IF _N_ = 1 THEN DO;
	PUT "USER,ACT_DT,DESCRIPTION";
END;
DO;
   PUT USER $ @;
   PUT ACT_DT @;
   PUT DESCRIPTION $ ;
END;
RUN;
