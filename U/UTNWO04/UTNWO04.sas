/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORTZ "&RPTLIB/UNWO04.NWO04RZ";
FILENAME REPORT2 "&RPTLIB/UNWO04.NWO04R2";
LIBNAME  LEGEND  REMOTE  SERVER=LEGEND  SLIBREF=WORK;
RSUBMIT;
LIBNAME pkub DB2 DATABASE=DNFPUTDL OWNER=pkub;

PROC SQL;
CONNECT TO DB2 (DATABASE=DNFPUTDL);
CREATE TABLE ALL AS
	SELECT	*
	FROM	CONNECTION TO DB2 (
		SELECT DISTINCT A.BF_SSN
			,CASE 
				WHEN C.DF_PRS_ID IS NULL AND D.DF_PRS_ID IS NULL THEN 1
				ELSE 0
			END AS BOTH_SKIP
			,CASE 
				WHEN C.DF_PRS_ID IS NULL AND D.DF_PRS_ID IS NOT NULL THEN 1
				ELSE 0
			END AS ADR_SKIP
			,CASE 
				WHEN D.DF_PRS_ID IS NULL AND C.DF_PRS_ID IS NOT NULL THEN 1
				ELSE 0
			END AS PHN_SKIP
	FROM PKUB.LN10_LON A
	LEFT OUTER JOIN	(
		SELECT ADR.DF_PRS_ID
		FROM PKUB.PD30_PRS_ADR ADR
		WHERE ADR.DI_VLD_ADR ='Y'
			AND DC_ADR = 'L') C
		ON A.BF_SSN = C.DF_PRS_ID
	LEFT OUTER JOIN	(
		SELECT PHN.DF_PRS_ID
		FROM PKUB.PD40_PRS_PHN PHN
		WHERE PHN.DI_PHN_VLD ='Y') D
		ON A.BF_SSN = D.DF_PRS_ID
	INNER JOIN PKUB.DW01_DW_CLC_CLU E
		ON A.BF_SSN = E.BF_SSN
	WHERE A.LA_CUR_PRI > 0
	AND A.LC_STA_LON10 = 'R'
	AND E.WC_DW_LON_STA NOT IN ('12','16','17','18','19','20','21','22')
				FOR READ ONLY WITH UR
			);
DISCONNECT FROM DB2;

/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>> ;  ** INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK;*/
QUIT;
ENDRSUBMIT;

DATA ALL;
	SET LEGEND.ALL;
RUN;

DATA ALL_CHECK;
SET ALL;
WHERE BOTH_SKIP = ADR_SKIP = PHN_SKIP = 1;
RUN;

PROC FREQ DATA=ALL;
	TABLE BOTH_SKIP * ADR_SKIP * PHN_SKIP;
RUN;

DATA ALL2;
	SET ALL;
	WHERE ADR_SKIP AND PHN_SKIP;
RUN;

PROC SQL;
	CREATE TABLE BOTH AS
	SELECT PUT(SUM(BOTH_SKIP),COMMA9.) AS NUM
		,'NUMBER BOTH SKIP' LENGTH=22 AS COL_DESC
	FROM ALL;
QUIT;

PROC SQL;
	CREATE TABLE PHN AS
	SELECT PUT(SUM(PHN_SKIP),COMMA9.) AS NUM
		,'NUMBER PHONE SKIP' LENGTH=22 AS COL_DESC
	FROM ALL;
QUIT;

PROC SQL;
	CREATE TABLE ADR AS 
	SELECT PUT(SUM(ADR_SKIP),COMMA9.) AS NUM      
		,'NUMBER ADDRESS SKIP' LENGTH=22 AS COL_DESC
	FROM ALL;
QUIT;

PROC SQL;
	CREATE TABLE TOTSKIP AS
	SELECT PUT(SUM(BOTH_SKIP)+SUM(PHN_SKIP)+SUM(ADR_SKIP),COMMA9.) AS NUM
		,'NUMBER TOTAL SKIP' LENGTH=22 AS COL_DESC
	FROM ALL;
QUIT;

PROC SQL;
	CREATE TABLE OBS AS
	SELECT PUT(COUNT(*),COMMA9.) AS NUM
		,'TOTAL BORROWERS' LENGTH=22 AS COL_DESC
	FROM ALL;
QUIT;


DATA PERC_SKIP (KEEP=NUM COL_DESC);
	MERGE OBS(RENAME=(NUM=TOTAL_BORROWERS)DROP=COL_DESC) TOTSKIP(RENAME=(NUM=TOTAL_SKIPS)DROP=COL_DESC);
	NUM = PUT(INPUT(TOTAL_SKIPS,COMMA9.)/INPUT(TOTAL_BORROWERS,COMMA9.),PERCENT10.2);
	COL_DESC = 'PERCENT SKIP';
RUN;

DATA FINAL;	
	SET OBS TOTSKIP PERC_SKIP ADR PHN BOTH;
RUN;
ODS _ALL_ CLOSE;
ods listing;

ODS HTML BODY="T:\SAS\Skip Volume Report Fed.HTML";
TITLE 'Skip Volume Report - FED';

PROC PRINT NOOBS SPLIT='/' DATA=FINAL WIDTH=full WIDTH=FULL;
VAR 	COL_DESC NUM;
LABEL	COL_DESC = 'Column Description'
		NUM = 'Number'
RUN;


/*PROC PRINTTO T:\SAS;*/
/**/
/*RUN;*/
PROC PRINTTO PRINT=REPORT2 NEW; RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127;
TITLE 'Skip Volume Report - FED';
TITLE2		"RUNDATE &SYSDATE9";
FOOTNOTE1  	"THIS DOCUMENT MAY CONTAIN BORROWERS' SENSITIVE INFORMATION THAT UHEAA HAS PLEDGED TO PROTECT.";
FOOTNOTE2	'PLEASE TAKE APPROPRIATE PRECAUTIONS TO SAFEGUARD THIS INFORMATION.';
FOOTNOTE3	;
FOOTNOTE4   'JOB = UTNWO04 	 REPORT = UNWO04.NWO04R2';

PROC PRINT NOOBS SPLIT='/' DATA=FINAL WIDTH=UNIFORM WIDTH=MIN LABEL;
VAR 	COL_DESC NUM;
LABEL	COL_DESC = 'Column Description'
		NUM = 'Number';
RUN;

PROC PRINTTO;
RUN;
