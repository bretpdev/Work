/*UTLWO13 BATCHES NOT RELEASED OR DELETED FROM PREVIOUS DAY*/
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWO13.LWO13R2";
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
DATA _NULL_; /*GETS THE PREVIOUS DAY*/
	EFFDT = TODAY();
    CALL SYMPUT('EFFDATE',put(EFFDT,MMDDYY10.));
	CALL SYMPUT('RUNDATE',"'"||put(EFFDT,MMDDYY10.)||"'");
RUN;
%SYSLPUT RUNDATE = &RUNDATE;	
RSUBMIT;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE BNRDPF AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT 	RTRIM(CHAR(MONTH(A.LD_RMT_BCH_INI)))||'/' 
		||RTRIM(CHAR(DAY(A.LD_RMT_BCH_INI)))||'/'
		||RTRIM(CHAR(YEAR(A.LD_RMT_BCH_INI)))||''
		||A.LC_RMT_BCH_SRC_IPT AS XPRT,
		A.LD_RMT_BCH_INI,
		CHAR(A.LN_RMT_BCH_SEQ) AS SEQ,
		A.LC_RMT_BCH,
		A.LC_RMT_BCH_STA,
		A.LC_BCH_TRX_TYP,
		A.LN_RMT_BCH_ITM_TOT,
		A.LA_RMT_BCH_TOT,
		A.LF_RMT_BCH_USR_ASN,
		A.LD_RMT_BCH_PAY_EFF
FROM OLWHRM1.RM10_RMT_BCH A
WHERE A.LC_RMT_BCH_STA <> 'A'
	AND 
	(
		A.LD_RMT_BCH_PAY_EFF < &RUNDATE 
	OR 
		A.LD_RMT_BCH_PAY_EFF IS NULL
	)
	AND 
	( 
		(
			A.LF_RMT_BCH_USR_ASN != 'CANQUE'
		)
	OR 
		(
			A.LF_RMT_BCH_USR_ASN = 'CANQUE' AND
			DAYS(A.LD_RMT_BCH_PAY_EFF) < DAYS(CURRENT DATE) - 3
		)
	)
);
DISCONNECT FROM DB2;
ENDRSUBMIT;
DATA BNRDPF;
	SET WORKLOCL.BNRDPF;
RUN;
DATA BNRDPF;
SET BNRDPF;
IF LC_RMT_BCH = '1' THEN BCODE = 'CASH/DPST';
 	ELSE IF LC_RMT_BCH = '2' THEN BCODE = 'CASH/WIRE';
 	ELSE IF LC_RMT_BCH = '3' THEN BCODE = 'ADVICE';

IF LC_RMT_BCH_STA = 'I' THEN SCODE = 'INITIATED';
 	ELSE IF LC_RMT_BCH_STA = 'P' THEN SCODE = 'POSTED';
 	ELSE IF LC_RMT_BCH_STA = 'R' THEN SCODE = 'RELEASED';
	ELSE IF LC_RMT_BCH_STA = 'A' THEN SCODE = 'APPLIED';

IF LENGTH(XPRT) = 11 THEN BDT = XPRT;
	 ELSE IF LENGTH(XPRT) < 11 THEN BDT = '0'||TRIM(XPRT);

IF LENGTH(SEQ) = 1 THEN RUBO = TRIM(BDT)||'00'||TRIM(SEQ);
	ELSE IF LENGTH(SEQ) = 2 THEN RUBO = TRIM(BDT)||'0'||TRIM(SEQ);
	ELSE IF LENGTH(SEQ) = 3 THEN RUBO = TRIM(BDT)||TRIM(SEQ);
RUN;
DATA _NULL_;
SET BNRDPF ;
LENGTH DESCRIPTION $600.;
USER = LF_RMT_BCH_USR_ASN;
ACT_DT = LD_RMT_BCH_INI ;
DAT2 = LD_RMT_BCH_PAY_EFF ;
DESCRIPTION =  
		TRIM(PUT(LD_RMT_BCH_INI, MMDDYY10.)) || 
		',' || TRIM(XPRT) ||
		',' || TRIM(SEQ) ||
		',' || TRIM(LC_RMT_BCH) ||
		',' || TRIM(LC_RMT_BCH_STA) ||
		',' || TRIM(LC_BCH_TRX_TYP) ||
		',' || TRIM(LEFT(LN_RMT_BCH_ITM_TOT)) ||
		',' || TRIM(LEFT(LA_RMT_BCH_TOT)) ||
		',' || TRIM(LF_RMT_BCH_USR_ASN) ||
		',' || TRIM(LEFT(PUT(LD_RMT_BCH_PAY_EFF, MMDDYY10.)))
;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
FORMAT USER $10. ;
FORMAT ACT_DT MMDDYY10. ;
FORMAT DAT2 MMDDYY10. ;
FORMAT DESCRIPTION $600. ;
IF _N_ = 1 THEN DO;
	PUT "USER,ACT_DT,DESCRIPTION";
END;
DO;
   PUT USER $ @;
   PUT ACT_DT @;
   PUT DESCRIPTION $ ;
END;
RUN; 
