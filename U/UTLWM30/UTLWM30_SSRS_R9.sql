USE OLS
GO

CREATE PROCEDURE utlwm30.GetR9
AS

DECLARE @ScriptId VARCHAR(10) = 'UTLWM30'
DECLARE @AddedAt DATETIME = GETDATE()
DECLARE @Today DATE = GETDATE()

SELECT DISTINCT
	BR01.BN_RHB_PAY_CTR,
	SUM
	(
		(DC01.LA_CLM_PRI + DC01.LA_CLM_INT -DC01.LA_PRI_COL +DC01.LA_INT_ACR + DC02.LA_CLM_INT_ACR - DC01.LA_INT_COL)	
		+ (DC01.LA_LEG_CST_ACR - DC01.LA_LEG_CST_COL + DC01.LA_OTH_CHR_ACR	- DC01.LA_OTH_CHR_COL + DC01.LA_COL_CST_ACR - DC01.LA_COL_CST_COL)
		+ (DC02.LA_CLM_PRJ_COL_CST)
	) AS TOT_PAYOFF,
	COUNT(DISTINCT PD01.DF_PRS_ID) AS BOR
FROM 
	ODW..GA01_APP GA01
	INNER JOIN ODW..GA10_LON_APP GA10
		ON GA01.AF_APL_ID = GA10.AF_APL_ID
	INNER JOIN ODW..DC01_LON_CLM_INF DC01
		ON GA10.AF_APL_ID = DC01.AF_APL_ID
		AND GA10.AF_APL_ID_SFX = DC01.AF_APL_ID_SFX
	INNER JOIN ODW..DC02_BAL_INT DC02
		ON DC01.AF_APL_ID = DC02.AF_APL_ID
		AND DC01.AF_APL_ID_SFX = DC02.AF_APL_ID_SFX
	INNER JOIN ODW..PD01_PDM_INF PD01
		ON DC01.BF_SSN = PD01.DF_PRS_ID
	INNER JOIN ODW..BR01_BR_CRF BR01
		ON DC01.BF_SSN = BR01.BF_SSN
	LEFT JOIN ODW..LA11_LEG_ACT_ATY LA11
		ON GA01.DF_PRS_ID_BR = LA11.DF_PRS_ID_BR
		AND BC_LEG_ACT_ATY_TYP = 'JD' 
	LEFT JOIN 
	(
		SELECT 
			DF_PRS_ID,
			MAX(BD_ATY_PRF) AS BD_ATY_PRF,
			PF_ACT
		FROM 
			ODW..AY01_BR_ATY
		WHERE 
			PF_ACT IN ('DLHB1','DLHB2','DLHB3','DLHB4','DLBH1','DRTRE','DRBWR')
		GROUP BY 
			DF_PRS_ID,
			PF_ACT
	) AY01 
		ON PD01.DF_PRS_ID = AY01.DF_PRS_ID
WHERE 
	DC01.LC_STA_DC10 = '03'
	AND DC01.LC_AUX_STA = ''
	AND DC01.LD_CLM_ASN_DOE IS NULL
	AND DC01.LC_PCL_REA IN ('DF','DQ','DB')
	AND DC01.LC_RHB_CON != '96'
	AND BR01.BC_RHB_NOT_ELG IN ('LB','')
	AND (DC01.LA_CLM_PRI + DC01.LA_CLM_INT -DC01.LA_PRI_COL +DC01.LA_INT_ACR + DC02.LA_CLM_INT_ACR - DC01.LA_INT_COL)	
		+ (DC01.LA_LEG_CST_ACR - DC01.LA_LEG_CST_COL + DC01.LA_OTH_CHR_ACR	- DC01.LA_OTH_CHR_COL + DC01.LA_COL_CST_ACR - DC01.LA_COL_CST_COL)
		+ (DC02.LA_CLM_PRJ_COL_CST) >= 500 --TOT_PAYOFF
	AND BN_RHB_PAY_CTR >= 3
	AND ISNULL(LA11.BC_LEG_ACT_ATY_TYP,'') != 'JD'
	AND ISNULL(AY01.PF_ACT,'') IN ('DRTRE', 'DRBWR') 
GROUP BY
	BR01.BN_RHB_PAY_CTR
;
