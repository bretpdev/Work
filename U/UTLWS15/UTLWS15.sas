LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;
%LET RPTLIB = %SYSGET(reportdir);
%LET RPTLIB = T:\SAS;
FILENAME REPORTZ "&RPTLIB/ULWS15.LWS15RZ";
FILENAME REPORT2 "&RPTLIB/ULWS15.LWS15R2";
FILENAME REPORT3 "&RPTLIB/ULWS15.LWS15R3";

OPTIONS SYMBOLGEN;
DATA _NULL_;
	EFFDT = TODAY();
    CALL SYMPUT('BEGIN',"'"||PUT(INTNX('MONTH',TODAY(),-1,'BEGINNING'), MMDDYYD10.)||"'");
	CALL SYMPUT('END',"'"||PUT(INTNX('MONTH',TODAY(),-1,'END'), MMDDYYD10.)||"'");
    CALL SYMPUT('EFFDATE',put(EFFDT,MMDDYY10.));
	CALL SYMPUT('RUNDATE',"'"||put(EFFDT,MMDDYY10.)||"'");
RUN;
%SYSLPUT BEGIN = &BEGIN;
%SYSLPUT END = &END;
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
%macro sqlcheck ;
  %if  &sqlxrc ne 0  %then  %do  ;
    data _null_  ;
            file reportz notitles  ;
            put @01 " ********************************************************************* "
              / @01 " ****  The SQL code above has experienced an error.               **** "
              / @01 " ****  The SAS should be reviewed.                                **** "       
              / @01 " ********************************************************************* "
              / @01 " ****  The SQL error code is  &sqlxrc  and the SQL error message  **** "
              / @01 " ****  &sqlxmsg   **** "
              / @01 " ********************************************************************* "
            ;
         run  ;
  %end  ;
%mend  ;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE DEMO AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT AY10.BF_SSN AS SSN
	,AY10.LN_ATY_SEQ
	,AY10.LF_PRF_BY AS USERID
	,AY10.LD_ATY_RSP AS ADATE
	,PD10.DM_PRS_LST AS LASTNAME
	,AY20.LX_ATY AS TEXT
	,AY10.PF_REQ_ACT
	,PD10.DF_SPE_ACC_ID

FROM OLWHRM1.AY10_BR_LON_ATY AY10
INNER JOIN OLWHRM1.LN85_LON_ATY LN85
ON AY10.BF_SSN = LN85.BF_SSN
AND AY10.LN_ATY_SEQ = LN85.LN_ATY_SEQ
INNER JOIN OLWHRM1.LN77_LTE_FEE_FAT LN77
ON LN77.BF_SSN = LN85.BF_SSN
AND LN77.LN_SEQ = LN85.LN_SEQ
INNER JOIN OLWHRM1.LN90_FIN_ATY LN90
ON LN90.BF_SSN = LN77.BF_SSN
AND LN90.LN_SEQ = LN77.LN_SEQ
AND LN90.LN_FAT_SEQ = LN77.LN_FAT_SEQ
INNER JOIN OLWHRM1.PD10_PRS_NME PD10
ON PD10.DF_PRS_ID = LN90.BF_SSN
INNER JOIN OLWHRM1.AY20_ATY_TXT AY20
ON AY20.BF_SSN = AY10.BF_SSN
AND AY20.LN_ATY_SEQ = AY10.LN_ATY_SEQ

WHERE AY10.PF_REQ_ACT = 'DRLFA'
AND AY10.LD_ATY_RSP BETWEEN &BEGIN AND &END
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;

/*%put  sqlxrc= >>> &sqlxrc <<< ||| sqlxmsg= >>> &sqlxmsg >>> ;  ** includes error messages to SAS log  ;*/
/*%sqlcheck;*/
/*quit;*/

ENDRSUBMIT;

DATA DEMO;SET WORKLOCL.DEMO;RUN;

DATA DEMOMONTH;
SET DEMO;
RUN;

PROC SQL;
CREATE TABLE MONHIST AS
SELECT *
FROM DEMO
WHERE SSN IN (SELECT DISTINCT SSN
				FROM DEMO
				)
;
QUIT;

PROC SORT DATA=MONHIST;
BY DF_SPE_ACC_ID USERID;
RUN;
PROC SORT DATA=DEMOMONTH;
BY USERID SSN;
RUN;

DATA DEMOMONTH;
SET DEMOMONTH;
FORMAT LATEFEE $10.;
FORMAT RSN $4.;
IF INDEX(TEXT,' BRRQ ') > 0 THEN RSN = 'BRRQ';
IF INDEX(TEXT,' BRCP ') > 0 THEN RSN = 'BRCP';
IF INDEX(TEXT,' RQWP ') > 0 THEN RSN = 'RQWP';
IF INDEX(TEXT,' RQDF ') > 0 THEN RSN = 'RQDF';
IF INDEX(TEXT,' RQ3P ') > 0 THEN RSN = 'RQ3P';
IF INDEX(TEXT,' ADWV ') > 0 THEN RSN = 'ADWV';
IF INDEX(TEXT,' RQOT ') > 0 THEN RSN = 'RQOT';

IF INDEX(TEXT,'$') > 0 THEN LATEFEE = SUBSTR(TEXT,INDEX(TEXT,'$')+1);
IF INDEX(LATEFEE,' ') > 0 THEN LATEFEE = SUBSTR(LATEFEE,1,INDEX(LATEFEE,' ')); 
IF SUBSTR(LATEFEE,LENGTH(LATEFEE),1) = '.' THEN LATEFEE = SUBSTR(LATEFEE,1,LENGTH(LATEFEE)-1);
ELSE LATEFEE = LATEFEE; 
LATEFEE = TRANSLATE(LATEFEE,' ','A',' ','B',' ','C',' ','D',' ','E',' ','F',' ','G',' ','H',' ','I',' ','J',' ','K',' ','L',' ','M',' ','N',' ','O',' ','P',' ','Q',' ','R',' ','S',' ','T',' ','U',' ','V',' ','W',' ','X',' ','Y',' ','Z',' ','}');
LATEFEE = TRANSLATE(LATEFEE,'','-');
LATEFEE = TRIM(LATEFEE);
IF INDEX(LATEFEE,',') > 0 THEN LATEFEE = SUBSTR(LATEFEE,1,INDEX(LATEFEE,',')-1) || SUBSTR(LATEFEE,INDEX(LATEFEE,',')+1);

RUN;
DATA MONHIST;
SET MONHIST;
FORMAT LATEFEE $10.;
FORMAT RSN $4.;
IF INDEX(TEXT,' BRRQ ') > 0 THEN RSN = 'BRRQ';
IF INDEX(TEXT,' BRCP ') > 0 THEN RSN = 'BRCP';
IF INDEX(TEXT,' RQWP ') > 0 THEN RSN = 'RQWP';
IF INDEX(TEXT,' RQDF ') > 0 THEN RSN = 'RQDF';
IF INDEX(TEXT,' RQ3P ') > 0 THEN RSN = 'RQ3P';
IF INDEX(TEXT,' ADWV ') > 0 THEN RSN = 'ADWV';
IF INDEX(TEXT,' RQOT ') > 0 THEN RSN = 'RQOT';

IF INDEX(TEXT,'$') > 0 THEN LATEFEE = SUBSTR(TEXT,INDEX(TEXT,'$')+1);
IF INDEX(LATEFEE,' ') > 0 THEN LATEFEE = SUBSTR(LATEFEE,1,INDEX(LATEFEE,' '));
IF SUBSTR(LATEFEE,LENGTH(LATEFEE),1) = '.' THEN LATEFEE = SUBSTR(LATEFEE,1,LENGTH(LATEFEE)-1);
ELSE LATEFEE = LATEFEE; 
LATEFEE = TRANSLATE(LATEFEE,' ','A',' ','B',' ','C',' ','D',' ','E',' ','F',' ','G',' ','H',' ','I',' ','J',' ','K',' ','L',' ','M',' ','N',' ','O',' ','P',' ','Q',' ','R',' ','S',' ','T',' ','U',' ','V',' ','W',' ','X',' ','Y',' ','Z',' ','}');
LATEFEE = TRANSLATE(LATEFEE,'','-',);
LATEFEE = TRIM(LATEFEE);
IF INDEX(LATEFEE,',') > 0 THEN LATEFEE = SUBSTR(LATEFEE,1,INDEX(LATEFEE,',')) || SUBSTR(LATEFEE,INDEX(LATEFEE,',')+1);
RUN;
DATA DEMOMONTH;
SET DEMOMONTH;
FORMAT LATEFEE2 DOLLAR12.2;
LATEFEE2 = LATEFEE;
IF LATEFEE2 = . THEN DELETE;
IF ADATE = . THEN DELETE;
RUN;
DATA MONHIST;
SET MONHIST;
FORMAT LATEFEE2 DOLLAR12.2;
LATEFEE2 = LATEFEE;
IF LATEFEE2 = . THEN DELETE;
IF ADATE = . THEN DELETE;
RUN;
OPTIONS PAGENO=1 ORIENTATION=PORTRAIT;
OPTIONS PS=52 LS=96;

*The Proc SQL code that originally read in the data used alias names: LF_PRF_BY = USERID, BD_ATY_PRF = ADATE, and 
DM_PRS_LST = LASTNAME ;

DATA _NULL_;
SET DEMOMONTH ;
LENGTH DESCRIPTION $600.;
USER = USERID;			
ACT_DT = ADATE;
DESCRIPTION = CATX(',',
	DF_SPE_ACC_ID,
	LASTNAME,
	RSN,
	LATEFEE2);
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
FORMAT USER $10. ;
FORMAT ACT_DT MMDDYY10. ;
FORMAT DESCRIPTION $600. ;
IF _N_ = 1 THEN DO;
	PUT "USER,ACT_DT,DESCRIPTION";
END;
DO;
   PUT USER $ @;
   PUT ACT_DT @;
   PUT DESCRIPTION $ ;
END;
RUN;
PROC PRINTTO PRINT=REPORT3 NEW;
RUN;
PROC PRINT DATA = MONHIST NOOBS SPLIT='/' N;
BY DF_SPE_ACC_ID;
SUM LATEFEE2;
FORMAT LATEFEE2 DOLLAR10.2
		ADATE MMDDYY10.;
VAR DF_SPE_ACC_ID LASTNAME ADATE USERID RSN LATEFEE2 ;
LABEL DF_SPE_ACC_ID = 'ACCT #';
TITLE 'QC- Waived Late Fees History';
FOOTNOTE  'JOB = UTLWS15     REPORT = UTLWS15.LWS15R3';
RUN;
PROC PRINTTO; RUN;
/**/
/*PROC EXPORT DATA=WORK.DEMO*/
/*            OUTFILE= "T:\SAS\DEMO.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/
