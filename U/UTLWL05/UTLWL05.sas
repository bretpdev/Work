/*TOTAL BORROWERS - LOANS - PRINCIPAL TOTALS AT MONTH-END*/
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWL05.LWL05R2";
FILENAME REPORT3 "&RPTLIB/ULWL05.LWL05R3";
FILENAME REPORTZ "&RPTLIB/ULWL05.LWL05RZ";

libname  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=work  ;
RSUBMIT;
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE PRNTOT1 AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT A.IF_OWN
	,A.IM_OWN_SHO
	,COUNT(*) AS LOANS
	,COUNT(DISTINCT A.BF_SSN) AS BWRS
	,SUM(COALESCE(A.WA_CUR_PRI,0)) AS WA_CUR_PRI
	,SUM(COALESCE(A.WA_CUR_BR_INT,0)) AS WA_CUR_INT
	,A.WD_MR50_CRT
FROM OLWHRM1.MR5A_MR_LON_MTH_01 A 
WHERE (A.WA_CUR_PRI <> 0
		/*OR WA_CUR_BR_INT <> 0*/)
	AND A.IC_LON_PGM <> 'TILP'
GROUP BY A.IF_OWN, A.IM_OWN_SHO, A.WD_MR50_CRT
ORDER BY A.IF_OWN
);

CREATE TABLE PRNTOT2 AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT A.IF_OWN
	,A.IM_OWN_SHO
	,COUNT(*) AS LOANS
	,COUNT(DISTINCT A.BF_SSN) AS BWRS
	,SUM(COALESCE(A.WA_CUR_PRI,0)) AS WA_CUR_PRI
	,SUM(COALESCE(A.WA_CUR_BR_INT,0)) AS WA_CUR_INT
	,A.WD_MR50_CRT
FROM OLWHRM1.MR5A_MR_LON_MTH_01 A 
WHERE (A.WA_CUR_PRI <> 0
		OR WA_CUR_BR_INT <> 0)
	AND A.IC_LON_PGM <> 'TILP'
GROUP BY A.IF_OWN, A.IM_OWN_SHO, A.WD_MR50_CRT
ORDER BY A.IF_OWN
);
DISCONNECT FROM DB2;
/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWL05.LWL05RZ);*/
/*QUIT;*/
ENDRSUBMIT  ;
DATA PRNTOT1;SET WORKLOCL.PRNTOT1;RUN;
DATA PRNTOT2;SET WORKLOCL.PRNTOT2;RUN;
*LAST DAY OF LAST MONTH FOR TITLE;
DATA _NULL_;
SET PRNTOT1;
	CALL SYMPUT('EFFDATE',PUT(WD_MR50_CRT,MMDDYY10.));
RUN;

PROC PRINTTO PRINT=REPORT2 NEW;
RUN;
OPTIONS CENTER NODATE NUMBER PAGENO=1 LS=132;
PROC PRINT NOOBS SPLIT='/' DATA=PRNTOT1 WIDTH=UNIFORM WIDTH=MIN;
WHERE WA_CUR_PRI ^= 0;
VAR IF_OWN IM_OWN_SHO BWRS LOANS WA_CUR_PRI;
SUM BWRS LOANS WA_CUR_PRI;
LABEL IF_OWN="LENDER" IM_OWN_SHO ="LENDER NAME" BWRS="TOTAL BORROWERS" LOANS="NUMBER OF LOANS"
WA_CUR_PRI="TOTAL PRINCIPAL BALANCE";
FORMAT BWRS COMMA7. LOANS COMMA7. WA_CUR_PRI DOLLAR18.2;
TITLE1 'BORROWER, LOAN, & PRINCIPAL TOTALS';
TITLE2 "AT MONTH-END &EFFDATE";
FOOTNOTE  'JOB = UTLWL05     REPORT = ULWL05.LWL05R2';
RUN;
PROC PRINTTO PRINT=REPORT3 NEW;
RUN;
OPTIONS CENTER NODATE NUMBER PAGENO=1 LS=132;
PROC PRINT NOOBS SPLIT='/' DATA=PRNTOT2 WIDTH=UNIFORM WIDTH=MIN;
VAR IF_OWN IM_OWN_SHO BWRS LOANS WA_CUR_PRI WA_CUR_INT;
SUM BWRS LOANS WA_CUR_PRI WA_CUR_INT;
LABEL IF_OWN="LENDER" IM_OWN_SHO ="LENDER NAME" BWRS="TOTAL BORROWERS" LOANS="NUMBER OF LOANS"
WA_CUR_PRI="TOTAL PRINCIPAL BALANCE" WA_CUR_INT = "TOTAL INTEREST BALANCE";
FORMAT BWRS COMMA7. LOANS COMMA7. WA_CUR_PRI WA_CUR_INT DOLLAR18.2;
TITLE1 'BORROWER, LOAN, PRINCIPAL & INTEREST TOTALS';
TITLE2 "AT MONTH-END &EFFDATE";
FOOTNOTE  'JOB = UTLWL05     REPORT = ULWL05.LWL05R3';
RUN;
PROC PRINTTO;
RUN;

/*DEATIL FILE*/
/*RSUBMIT;*/
/*PROC SQL;*/
/*CONNECT TO DB2 (DATABASE=DLGSUTWH);*/
/*CREATE TABLE UTLWL05_DETAIL AS*/
/*SELECT **/
/*FROM CONNECTION TO DB2 (*/
/*SELECT A.IF_OWN*/
/*	,A.IM_OWN_SHO*/
/*	,A.LN_SEQ*/
/*	,A.BF_SSN*/
/*	,COALESCE(A.WA_CUR_PRI,0) AS WA_CUR_PRI*/
/*	,COALESCE(A.WA_CUR_BR_INT,0) AS WA_CUR_INT*/
/*	,A.WD_MR50_CRT*/
/*FROM OLWHRM1.MR5A_MR_LON_MTH_01 A */
/*WHERE A.WA_CUR_PRI <> 0*/
/*OR WA_CUR_BR_INT <> 0*/
/*ORDER BY A.IF_OWN*/
/*);*/
/*DISCONNECT FROM DB2;*/
/*ENDRSUBMIT;*/
/*DATA UTLWL05_DETAIL;*/
/*SET WORKLOCL.UTLWL05_DETAIL;*/
/*RUN;*/
/*DATA _NULL_;*/
/*SET  WORK.UTLWL05_DETAIL;*/
/*FILE 'T:\SAS\UTLWL05_DETAIL.TXT' DELIMITER=',' DSD DROPOVER LRECL=32767;*/
/*   FORMAT IF_OWN $8. ;*/
/*   FORMAT IM_OWN_SHO $20. ;*/
/*   FORMAT LN_SEQ 6. ;*/
/*   FORMAT BF_SSN $9. ;*/
/*   FORMAT WA_CUR_PRI 15.2 ;*/
/*   FORMAT WA_CUR_INT 15.2 ;*/
/*   FORMAT WD_MR50_CRT MMDDYY10. ;*/
/*IF _N_ = 1 THEN */
/*DO;*/
/*   PUT*/
/*   'IF_OWN'*/
/*   ','*/
/*   'IM_OWN_SHO'*/
/*   ','*/
/*   'LN_SEQ'*/
/*   ','*/
/*   'BF_SSN'*/
/*   ','*/
/*   'WA_CUR_PRI'*/
/*   ','*/
/*   'WA_CUR_INT'*/
/*   ','*/
/*   'WD_MR50_CRT'*/
/*   ;*/
/*END;*/
/*DO;*/
/*   PUT IF_OWN $ @;*/
/*   PUT IM_OWN_SHO $ @;*/
/*   PUT LN_SEQ @;*/
/*   PUT BF_SSN $ @;*/
/*   PUT WA_CUR_PRI @;*/
/*   PUT WA_CUR_INT @;*/
/*   PUT WD_MR50_CRT ;*/
/*END;*/
/*RUN;*/
