/*UTLWE25 BORROWERS WITH OPEN LOANS*/

/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
/*FILENAME REPORT2 "&RPTLIB/ULWE25.LWE25R2";*/
/*FILENAME REPORT3 "&RPTLIB/ULWE25.LWE25R3";*/
/*FILENAME REPORTZ "&RPTLIB/ULWE25.LWE25RZ";*/

DATA _NULL_;
     CALL SYMPUT('RUNDT',PUT(INTNX('DAY',TODAY(),0,'BEGINNING'), MMDDYYS10.));
RUN;

LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE LNSRV AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT A.BF_SSN
	,CASE 
		WHEN B.DM_PRS_MID = ' ' 
		THEN RTRIM(B.DM_PRS_1)||' '||B.DM_PRS_LST
		ELSE RTRIM(B.DM_PRS_1)||' '||RTRIM(B.DM_PRS_MID)||' '||B.DM_PRS_LST
	 END AS NAME
	,B.DM_PRS_LST
	,B.DD_BRT
	,A.LF_LON_CUR_OWN
FROM OLWHRM1.LN10_LON A
INNER JOIN OLWHRM1.PD10_PRS_NME B
	ON A.BF_SSN = B.DF_PRS_ID
WHERE A.LA_CUR_PRI > 0
AND A.LC_STA_LON10 = 'R'
AND A.LF_LON_CUR_OWN IN ('830132','830146')/*THIS IS TO SHORTEN THE RUN TIME*/
);

CREATE TABLE LNORG AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT A.BF_SSN
	,CASE 
		WHEN C.DM_PRS_MID = ' ' 
		THEN RTRIM(C.DM_PRS_1)||' '||C.DM_PRS_LST
		ELSE RTRIM(C.DM_PRS_1)||' '||RTRIM(C.DM_PRS_MID)||' '||C.DM_PRS_LST
	 END AS NAME
	,C.DM_PRS_LST
	,C.DD_BRT	
	,A.AF_DOE_LDR
FROM OLWHRM1.AP03_MASTER_APL A
INNER JOIN OLWHRM1.LN15_DSB B
	ON A.AF_APL_ID = B.AF_APL_ID
INNER JOIN OLWHRM1.PD10_PRS_NME C
	ON A.BF_SSN = C.DF_PRS_ID
WHERE A.AF_DOE_LDR IN ('830132','830146') /*THIS IS TO SHORTEN THE RUN TIME*/
AND B.LC_STA_LON15 IN ('1','3')
AND (B.LA_DSB <> COALESCE(B.LA_DSB_CAN,0) 
	 OR 
	 B.LA_DSB_CAN IS NULL)
AND B.LC_DSB_TYP = '1'
);
DISCONNECT FROM DB2;
ENDRSUBMIT;

DATA LNSRV;SET WORKLOCL.LNSRV;RUN;
DATA LNORG;SET WORKLOCL.LNORG;RUN;



%MACRO PRINTEM(LENDER=, SCH=, RPNO=);

PROC SQL;
CREATE TABLE LNSRV2 AS
SELECT *
FROM LNSRV
WHERE LF_LON_CUR_OWN = "&LENDER";
QUIT;
PROC SQL;
CREATE TABLE LNORG2 AS
SELECT *
FROM LNORG
WHERE AF_DOE_LDR = "&LENDER";
QUIT;


DATA BWOUCU;
SET LNSRV2 LNORG2;
RUN;

PROC SORT DATA=BWOUCU NODUPKEY;
BY DM_PRS_LST;
RUN;

/*PROC PRINTTO PRINT=REPORT&RPNO NEW;
RUN;*/

OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 PAGENO=1 CENTER NODATE;

TITLE 'BORROWERS WITH OPEN LOANS';
TITLE2 &SCH;
TITLE3	"RUNDATE &RUNDT";
FOOTNOTE "JOB = UTLWE25  	 REPORT = ULWE25.LWE25R&RPNO";
PROC CONTENTS DATA=BWOUCU OUT=EMPTYSET NOPRINT;
DATA _NULL_;
SET EMPTYSET;
FILE PRINT;
IF  NOBS=0 AND _N_ =1 THEN DO;
	PUT // 127*'-';
	PUT      ////////
		@51 '**** NO OBSERVATIONS FOUND ****';
	PUT ////////
		@57 '-- END OF REPORT --';
	PUT /////////////
		@46 "JOB = UTLWE25  	 REPORT = ULWE25.LWE25R&RPNO";
	END;
RETURN;
RUN;
PROC PRINT NOOBS SPLIT='/' DATA=BWOUCU WIDTH=UNIFORM WIDTH=MIN;
FORMAT DD_BRT MMDDYY10.;
VAR BF_SSN NAME DD_BRT;
LABEL BF_SSN = 'SSN'
	DD_BRT = 'DOB';
RUN;

%MEND PRINTEM;


%PRINTEM(LENDER=830132,SCH='U of U Credit Union',RPNO=2); /*U of U Credit Union*/
%PRINTEM(LENDER=830146,SCH='USU Community Credit Union',RPNO=3); /*USU Community Credit Union*/




/*USED FOR TESTING*/
/*PROC SORT DATA=LNSRV;BY BF_SSN;RUN;*/
/*PROC SORT DATA=LNORG;BY BF_SSN;RUN; */
/**/
/*DATA SRV ORG BOTH;*/
/*MERGE LNSRV (IN=A) LNORG (IN=B);*/
/*BY BF_SSN;*/
/*IF A AND B THEN OUTPUT BOTH;*/
/*ELSE IF A AND NOT B THEN OUTPUT SRV;*/
/*ELSE IF B AND NOT A THEN OUTPUT ORG;*/
/*RUN;*/
/**/
/*PROC SORT DATA=ORG NODUPKEY;BY BF_SSN;RUN; */
/*PROC SORT DATA=SRV NODUPKEY;BY BF_SSN;RUN; */
/*PROC SORT DATA=BOTH NODUPKEY;BY BF_SSN;RUN; */
/**/
/*PROC EXPORT DATA= SRV*/
/*            OUTFILE= "T:\SAS\SRV.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/
/**/
/*PROC EXPORT DATA= ORG */
/*            OUTFILE= "T:\SAS\ORG.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/
/**/
/*PROC EXPORT DATA= BOTH */
/*            OUTFILE= "T:\SAS\BOTH.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/
