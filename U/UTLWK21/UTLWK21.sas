*---------------------------*
|UTLWK21 SKIP EMPLOYER CALL |
*---------------------------*;

/*%LET RPTLIB = %SYSGET(reportdir);*/
/*%LET PROGREVW = /sas/whse/progrevw;*/
%LET RPTLIB = T:\SAS;
%LET PROGREVW = Q:\Support Services\Test Files\SAS\PROGREVW;

FILENAME REPORT2 "&RPTLIB/ULWK21.LWK21R2";
FILENAME REPORTZ "&RPTLIB/ULWK21.LWK21RZ";
LIBNAME PROGREVW "&PROGREVW";
PROC SQL NOPRINT;
	SELECT 
		"'"||STRIP(LENDER_ID)||"'" INTO :EXCL_LIST SEPARATED BY ","
	FROM 
		PROGREVW.LENDER_GROUP_LENDERS
	WHERE 
		LENDER_GROUP_ID = 1
	;
QUIT;
%PUT &EXCL_LIST;
%LET I_COUNT = 0;
%PUT &I_COUNT;
%SYSLPUT EXCL_LIST = &EXCL_LIST;
%SYSLPUT I_COUNT = &I_COUNT;
LIBNAME  WORKLOCL  REMOTE  SERVER=DUSTER  SLIBREF=WORK;
RSUBMIT;
LIBNAME OLWHRM1 DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;
PROC SQL;
	CONNECT TO DB2 (DATABASE=DLGSUTWH);
	CREATE TABLE DC01 AS
	SELECT
		*
	FROM
		CONNECTION TO DB2
		(/*get LC_STA_DC10 for the most recently created DC01 record for the loan*/
			SELECT
				DC01A.AF_APL_ID,
				DC01A.AF_APL_ID_SFX,
				DC01A.LC_STA_DC10
			FROM
				OLWHRM1.DC01_LON_CLM_INF DC01A
				INNER JOIN 
				(/*get the most recently created DC01 record for loans*/
					SELECT
						AF_APL_ID,
						AF_APL_ID_SFX,
						MAX(LF_CRT_DTS_DC10) AS LF_CRT_DTS_DC10
					FROM
						OLWHRM1.DC01_LON_CLM_INF
					GROUP BY
						AF_APL_ID,
						AF_APL_ID_SFX
				) DC01M
					ON DC01A.AF_APL_ID = DC01M.AF_APL_ID
					AND DC01A.AF_APL_ID_SFX = DC01M.AF_APL_ID_SFX
					AND DC01A.LF_CRT_DTS_DC10 = DC01M.LF_CRT_DTS_DC10
		)
	;
	DISCONNECT FROM DB2;

	CREATE TABLE SKECL AS
		SELECT DISTINCT 
			AY01.DF_PRS_ID
			,AY01.BX_CMT
			,AY01.BD_ATY_PRF
			,COALESCE(LN10.LA_CUR_PRI,0) AS LA_CUR_PRI
			,COALESCE(PRIN.AA_CUR_PRI,0) AS AA_CUR_PRI
			,KEMP0.MX_KEMP0_DT
			,MEMPL.MX_MEMPL_DT
		FROM
			OLWHRM1.AY01_BR_ATY AY01
			INNER JOIN OLWHRM1.PD03_PRS_ADR_PHN PD03
				ON AY01.DF_PRS_ID = PD03.DF_PRS_ID
			INNER JOIN 
			(
				SELECT 
					BF_SSN
					,SUM(COALESCE(LA_CUR_PRI,0)) AS LA_CUR_PRI
				FROM
					OLWHRM1.LN10_LON 
				WHERE
					LC_STA_LON10 = 'R'
					AND LF_LON_CUR_OWN NOT IN (&EXCL_LIST)
				GROUP BY 
					BF_SSN
			 ) LN10
				ON AY01.DF_PRS_ID = LN10.BF_SSN
			INNER JOIN OLWHRM1.GA01_APP GA01
				ON AY01.DF_PRS_ID = GA01.DF_PRS_ID_BR
			INNER JOIN OLWHRM1.GA10_LON_APP GA10
				ON GA01.AF_APL_ID = GA10.AF_APL_ID
				AND GA10.AA_CUR_PRI > 0
			LEFT JOIN DC01
				ON GA10.AF_APL_ID = DC01.AF_APL_ID
				AND GA10.AF_APL_ID_SFX = DC01.AF_APL_ID_SFX
			INNER JOIN OLWHRM1.GA14_LON_STA GA14
				ON GA10.AF_APL_ID = GA14.AF_APL_ID
				AND GA10.AF_APL_ID_SFX = GA14.AF_APL_ID_SFX
			LEFT JOIN 
			(
				SELECT 
					GA01.DF_PRS_ID_BR
					,SUM(COALESCE(GA10.AA_CUR_PRI,0)) AS AA_CUR_PRI
				FROM
					OLWHRM1.GA01_APP GA01
					INNER JOIN OLWHRM1.GA10_LON_APP GA10
						ON GA01.AF_APL_ID = GA10.AF_APL_ID
				GROUP BY 
					GA01.DF_PRS_ID_BR
			 ) PRIN
				ON AY01.DF_PRS_ID = PRIN.DF_PRS_ID_BR	
			LEFT JOIN 
			(
				SELECT 
					DF_PRS_ID
					,MAX(BD_ATY_PRF) AS MX_KEMP0_DT
				FROM
					OLWHRM1.AY01_BR_ATY 
				WHERE
					PF_ACT = 'KEMP0'
				GROUP BY 
					DF_PRS_ID
			 ) KEMP0
				ON AY01.DF_PRS_ID = KEMP0.DF_PRS_ID
			LEFT JOIN 
			(
				SELECT 
					DF_PRS_ID
					,MAX(BD_ATY_PRF) AS MX_MEMPL_DT
				FROM
					OLWHRM1.AY01_BR_ATY 
				WHERE 
					PF_ACT = 'MEMPL'
				GROUP BY 
					DF_PRS_ID
			 ) MEMPL
				ON AY01.DF_PRS_ID = MEMPL.DF_PRS_ID
			LEFT JOIN
			(
				SELECT DISTINCT
					DF_PRS_ID,
					BD_ATY_PRF
				FROM 
					OLWHRM1.AY01_BR_ATY
				WHERE 
					PF_ACT = 'MEMP0'
			) MEMP0
				ON AY01.DF_PRS_ID = MEMP0.DF_PRS_ID
				AND MEMP0.BD_ATY_PRF > AY01.BD_ATY_PRF
			LEFT JOIN
			(
				SELECT DISTINCT
					DF_PRS_ID,
					BD_ATY_PRF
				FROM 
					OLWHRM1.AY01_BR_ATY
				WHERE 
					PF_ACT = 'KEMPL'
					AND BD_ATY_PRF >= TODAY()-30
			) KEMPL
				ON AY01.DF_PRS_ID = KEMPL.DF_PRS_ID
			LEFT JOIN
			(
				SELECT DISTINCT
					DF_PRS_ID_BR
				FROM
					OLWHRM1.CT30_CALL_QUE
				WHERE
					IF_WRK_GRP = 'KEMPCALL'
			) KEMPC
				ON AY01.DF_PRS_ID = KEMPC.DF_PRS_ID_BR
		WHERE 
			AY01.PF_ACT = 'MEMPL'
			AND PD03.DC_ADR = 'L'
			AND 
			(
				PD03.DI_VLD_ADR = 'N' 
				OR PD03.DI_PHN_VLD = 'N'
			)
			AND MEMP0.DF_PRS_ID IS NULL
			AND KEMPL.DF_PRS_ID IS NULL
			AND KEMPC.DF_PRS_ID_BR IS NULL
			AND DC01.LC_STA_DC10 ^= '03'
			AND GA14.AC_STA_GA14 = 'A'
			AND GA14.AC_LON_STA_TYP ^= 'DN'
	;
QUIT;
ENDRSUBMIT;

DATA SKECL;
	SET WORKLOCL.SKECL;
RUN;

DATA SKECL;
	SET SKECL;
	IF LA_CUR_PRI ^= 0 
	AND 
	(
		MX_KEMP0_DT < MX_MEMPL_DT 
		OR MX_KEMP0_DT = .
	) 
	THEN 
		DO;
			SYS = 'COMPASS';
			OUTPUT;
		END;
	ELSE IF AA_CUR_PRI ^= 0
	AND	
	(
		MX_KEMP0_DT < MX_MEMPL_DT 
		OR MX_KEMP0_DT = .
	) 
	THEN 
		DO;
			SYS = 'ONELINK';
			OUTPUT;
		END;
	ELSE DELETE;
RUN;

PROC SORT DATA=SKECL;
	BY DF_PRS_ID BD_ATY_PRF;
RUN;

DATA SKECL_TXT (KEEP=DF_PRS_ID BD_ATY_PRF BX_CMT);
	SET SKECL;
RUN;

DATA _NULL_;
	SET SKECL_TXT;
	CALL SYMPUT('I_COUNT',TRIM(_N_));
RUN;

/*creates empty data set as a placeholder for use in later macros and joins*/
DATA TXT_KEEP;
	STOP;
	LENGTH NEW_STRING $ 700;
	SET SKECL_TXT;
	NEW_STRING = '';
RUN;

%MACRO KILL_SPACES (DS,TXT_VAR,ITER);
	DATA TXT;
		SET &DS;
		IF _N_ = &ITER;
	RUN;
	%LET REMAINING_STRING = %LENGTH(&TXT_VAR);

	/*%PUT ***************************************************;*/
	/*%PUT REMAINING_STRING = &REMAINING_STRING;*/
	/*%PUT ***************************************************;*/

	%LET I = 1;
	%DO %UNTIL(&REMAINING_STRING = 0);
		
	/*	%PUT *-------------------------------------------------*;*/
	/*	%PUT REMAINING_STRING = &REMAINING_STRING ;*/
	/*	%PUT *-------------------------------------------------*;*/

		DATA TXT;
			SET TXT;
			SPC = INDEX(&TXT_VAR,' ');
			LNG = LENGTH(&TXT_VAR) ;
			WORD_&I = TRIM(SUBSTR(&TXT_VAR,1,SPC));
			&TXT_VAR = LEFT(TRIM(SUBSTR(&TXT_VAR,SPC+1,LNG-SPC)));
		RUN;

		DATA _NULL_;
			SET TXT;
			IF &TXT_VAR = '' 
			THEN 
				DO;
					CALL SYMPUT('REMAINING_STRING',0);
				END;
			ELSE 
				DO;
					CALL SYMPUT('REMAINING_STRING',LENGTH(&TXT_VAR));
				END;
		RUN;

		%LET I=%EVAL(&I+1);
	%END;

	/*NOW I = THE LAST ITERATION NUMBER PLUS ONE*/

	%LET X=1;
	%DO %WHILE (&X < &I);
		%IF &X = 1 
		%THEN 
			%DO;
				DATA TXT;
				SET TXT;
				LENGTH NEW_STRING $ 700;
				NEW_STRING = LEFT(TRIM(WORD_&X));
				RUN;
			%END;
		%ELSE 
			%DO;
				DATA TXT;
				SET TXT;
				NEW_STRING = LEFT(TRIM(NEW_STRING))||' '||LEFT(TRIM(WORD_&X));
				RUN;
			%END;
		%LET X=%EVAL(&X+1);
	%END;

	DATA TXT_KEEP (KEEP=DF_PRS_ID BD_ATY_PRF NEW_STRING);
		SET TXT TXT_KEEP;
	RUN;
%MEND KILL_SPACES;

%MACRO I_EXEC;
	%DO N=1 %TO &I_COUNT;
		%KILL_SPACES(SKECL_TXT,BX_CMT,&N);
    %END;
%MEND I_EXEC;
%I_EXEC;

%MACRO DATE_2_CHAR(DS,CDATE,DAYPART);
	DATA &DS;
		SET &DS;
		LENGTH &DAYPART $ 10. ;
		IF &CDATE = . 
		THEN 
			DO;
				&DAYPART = '';
			END;
		ELSE IF DAY(&CDATE) < 10 
			AND MONTH(&CDATE) < 10 
		THEN 
			DO;
				&DAYPART = '0'||TRIM(LEFT(MONTH(&CDATE)))||'/'||'0'||TRIM(LEFT(DAY(&CDATE)))||'/'||TRIM(LEFT(YEAR(&CDATE)));
			END;
		ELSE IF DAY(&CDATE) < 10 
			AND MONTH(&CDATE) >= 10 
			THEN 
				DO;
					&DAYPART = TRIM(LEFT(MONTH(&CDATE)))||'/'||'0'||TRIM(LEFT(DAY(&CDATE)))||'/'||TRIM(LEFT(YEAR(&CDATE)));
				END;
		ELSE IF DAY(&CDATE) >= 10 
			AND MONTH(&CDATE) < 10 
			THEN
				DO;
					&DAYPART ='0'||TRIM(LEFT(MONTH(&CDATE)))||'/'||TRIM(LEFT(DAY(&CDATE)))||'/'||TRIM(LEFT(YEAR(&CDATE)));
				END;
		ELSE 
			DO;
				&DAYPART = TRIM(LEFT(MONTH(&CDATE)))||'/'||TRIM(LEFT(DAY(&CDATE)))||'/'||TRIM(LEFT(YEAR(&CDATE)));
			END;
	RUN;
%MEND DATE_2_CHAR;
%DATE_2_CHAR(SKECL,BD_ATY_PRF,CHAR_BD_ATY_PRF);

PROC SQL;
	CREATE TABLE SKECL2 AS 
	SELECT DISTINCT 
		SK.DF_PRS_ID AS TARGET_ID
		,'KEMPCALL' AS QUEUE_NAME 
		,'' AS INSTITUTION_ID
		,'' AS INSTITUTION_TYPE 
		,'' AS DATE_DUE 
		,'' AS TIME_DUE 
		,TRIM(LEFT(SK.SYS))||','||LEFT(TRIM(TX.NEW_STRING))||','||TRIM(LEFT(CHAR_BD_ATY_PRF)) AS COMMENTS
	FROM 
		SKECL SK
		INNER JOIN TXT_KEEP TX
			ON SK.DF_PRS_ID = TX.DF_PRS_ID
			AND SK.BD_ATY_PRF = TX.BD_ATY_PRF
	;
QUIT;

DATA _NULL_;
	SET WORK.SKECL2; 
	FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
	   FORMAT COMMENTS $600. ;
	   FORMAT TARGET_ID $9. ;
	   FORMAT QUEUE_NAME $8. ;
	   FORMAT INSTITUTION_ID $1. ;
	   FORMAT INSTITUTION_TYPE $1. ;
	   FORMAT DATE_DUE $1. ;
	   FORMAT TIME_DUE $1. ;
	DO;
		PUT TARGET_ID $ @;
		PUT QUEUE_NAME $ @;
		PUT INSTITUTION_ID $ @;
		PUT INSTITUTION_TYPE $ @;
		PUT DATE_DUE $ @;
		PUT TIME_DUE $ @;
		PUT COMMENTS $ ;
	END;
RUN;
