--SELECT * INTO #BP FROM ULS.[SCRA].[SSRS_UTLWS76]

INSERT INTO #BP (DF_SPE_ACC_ID, LD_ACT_DUT_BEG, LD_ACT_DUT_END)
VALUES 
(5165898546,'2011-02-21','2011-12-13'),
(6971451830,'2012-03-30','2012-12-12'),
(6971451830,'2012-01-11','2012-11-11'),
(7646847723,'2013-01-01','2013-10-01'),
(7646847723,'2013-02-01','2013-11-01'),
(7646847723,'2013-03-01','2013-12-01'),
(8459750324,'2014-05-31','2014-12-10')

SELECT * FROM #BP ORDER BY DF_SPE_ACC_ID
--DROP TABLE #BP


--pivot up to four beg/end dates for comment:
SELECT
	MULTI_BEG.*
	,MULTI_END.LD_ACT_DUT_END1
	,MULTI_END.LD_ACT_DUT_END2
	,MULTI_END.LD_ACT_DUT_END3
	,MULTI_END.LD_ACT_DUT_END4
INTO
	#MULTI_BORR
FROM 
	(
		SELECT 
			DF_SPE_ACC_ID
			,[1] AS LD_ACT_DUT_BEG1
			,[2] AS LD_ACT_DUT_BEG2
			,[3] AS LD_ACT_DUT_BEG3
			,[4] AS LD_ACT_DUT_BEG4
		FROM 
			(	
				SELECT
					DF_SPE_ACC_ID
					,LD_ACT_DUT_BEG
					,ROW_NUMBER() OVER(PARTITION BY DF_SPE_ACC_ID ORDER BY DF_SPE_ACC_ID, LD_ACT_DUT_BEG) AS ROWNUM
				FROM 
					#BP
			) A1
		PIVOT
			(MAX(LD_ACT_DUT_BEG) FOR ROWNUM IN 
				(
					[1],[2],[3],[4]
				)
			) AS PVT1
	) MULTI_BEG
INNER JOIN
	(
		SELECT 
			DF_SPE_ACC_ID
			,[1] AS LD_ACT_DUT_END1
			,[2] AS LD_ACT_DUT_END2
			,[3] AS LD_ACT_DUT_END3
			,[4] AS LD_ACT_DUT_END4
		FROM 
			(	
				SELECT
					DF_SPE_ACC_ID
					,LD_ACT_DUT_END
					,ROW_NUMBER() OVER(PARTITION BY DF_SPE_ACC_ID ORDER BY DF_SPE_ACC_ID, LD_ACT_DUT_BEG) AS ROWNUM
				FROM 
					#BP
			) A2
		PIVOT
			(MAX(LD_ACT_DUT_END) FOR ROWNUM IN 
				(
					[1],[2],[3],[4]
				)
			) AS PVT2
	) MULTI_END
ON MULTI_BEG.DF_SPE_ACC_ID = MULTI_END.DF_SPE_ACC_ID

SELECT * FROM #MULTI_BORR
--DROP TABLE #MULTI_BORR








select df_spe_acc_id,
CASE
	WHEN MB.LD_ACT_DUT_BEG2 IS NULL AND MB.LD_ACT_DUT_BEG3 IS NULL AND MB.LD_ACT_DUT_BEG4 IS NULL
		THEN CONCAT('ADB: ', CONVERT(VARCHAR(10),MB.LD_ACT_DUT_BEG1,101),
					' ADE: ', COALESCE(CONVERT(VARCHAR(10),MB.LD_ACT_DUT_END1,101),'12/31/2099'))
	WHEN MB.LD_ACT_DUT_BEG3 IS NULL AND MB.LD_ACT_DUT_BEG4 IS NULL
		THEN CONCAT('ADB: ', CONVERT(VARCHAR(10),MB.LD_ACT_DUT_BEG1,101),
					' ADE: ', COALESCE(CONVERT(VARCHAR(10),MB.LD_ACT_DUT_END1,101),'12/31/2099'), ' |',
					' ADB: ', CONVERT(VARCHAR(10),MB.LD_ACT_DUT_BEG2,101),
					' ADE: ', COALESCE(CONVERT(VARCHAR(10),MB.LD_ACT_DUT_END2,101),'12/31/2099'))
	WHEN MB.LD_ACT_DUT_BEG4 IS NULL
		THEN CONCAT('ADB: ', CONVERT(VARCHAR(10),MB.LD_ACT_DUT_BEG1,101),
					' ADE: ', COALESCE(CONVERT(VARCHAR(10),MB.LD_ACT_DUT_END1,101),'12/31/2099'), ' |',
					' ADB: ', CONVERT(VARCHAR(10),MB.LD_ACT_DUT_BEG2,101),
					' ADE: ', COALESCE(CONVERT(VARCHAR(10),MB.LD_ACT_DUT_END2,101),'12/31/2099'), ' |',
					' ADB: ', CONVERT(VARCHAR(10),MB.LD_ACT_DUT_BEG3,101),
					' ADE: ', COALESCE(CONVERT(VARCHAR(10),MB.LD_ACT_DUT_END3,101),'12/31/20199'))
	ELSE CONCAT('ADB: ', CONVERT(VARCHAR(10),MB.LD_ACT_DUT_BEG1,101),
				' ADE: ', COALESCE(CONVERT(VARCHAR(10),MB.LD_ACT_DUT_END1,101),'12/31/2099'), ' |',
				' ADB: ', CONVERT(VARCHAR(10),MB.LD_ACT_DUT_BEG2,101),
				' ADE: ', COALESCE(CONVERT(VARCHAR(10),MB.LD_ACT_DUT_END2,101),'12/31/2099'), ' |',
				' ADB: ', CONVERT(VARCHAR(10),MB.LD_ACT_DUT_BEG3,101),
				' ADE: ', COALESCE(CONVERT(VARCHAR(10),MB.LD_ACT_DUT_END3,101),'12/31/2099'), ' |',
				' ADB: ', CONVERT(VARCHAR(10),MB.LD_ACT_DUT_BEG4,101),
				' ADE: ', COALESCE(CONVERT(VARCHAR(10),MB.LD_ACT_DUT_END4,101),'12/31/2099'))
	END AS Comment
from
#MULTI_BORR MB
order by df_spe_acc_id
