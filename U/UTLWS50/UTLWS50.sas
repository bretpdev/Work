/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORTZ "&RPTLIB/ULWS50.LWS50RZ";
FILENAME REPORT2 "&RPTLIB/ULWS50.LWS50R2";
FILENAME REPORT3 "&RPTLIB/ULWS50.LWS50R3";
LIBNAME  WORKLOCL  REMOTE  SERVER=DUSTER  SLIBREF=WORK;
RSUBMIT;
LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;
PROC SQL;
CREATE TABLE DEMO AS
SELECT DISTINCT A.DF_SPE_ACC_ID
	,TRIM(A.DM_PRS_LST) || ', ' || TRIM(A.DM_PRS_1) AS B_NAME
	,C.DX_ADR_EML AS COM_EML
	,D.DX_EML_ADR AS ONE_EML
FROM DLGSUTWH.LN10_LON B
INNER JOIN DLGSUTWH.PD10_PRS_NME A
	ON A.DF_PRS_ID = B.BF_SSN
INNER JOIN DLGSUTWH.PD32_PRS_ADR_EML C
	ON A.DF_PRS_ID = C.DF_PRS_ID
INNER JOIN DLGSUTWH.PD03_PRS_ADR_PHN D
	ON A.DF_PRS_ID = D.DF_PRS_ID
WHERE B.LA_CUR_PRI > 0
	AND C.DX_ADR_EML ^= D.DX_EML_ADR
	AND C.DC_STA_PD32 = 'A'
	AND C.DC_ADR_EML = 'H'	
	AND C.DI_VLD_ADR_EML = 'Y'
	AND D.DX_EML_ADR ^= ''
	AND D.DC_ADR = 'L'
	AND D.DI_EML_ADR_VAL = 'Y'
	AND B.LC_STA_LON10 = 'R'
;
QUIT;
DATA DEMO(DROP=A B C ONE COM);
SET DEMO;
FORMAT COM ONE B C $56.;
IF UPCASE(COM_EML) = UPCASE(ONE_EML) THEN DELETE;
A = 1;
DO UNTIL (B = '' AND C = '');
	B = UPCASE(SCAN(COM_EML,A,'_'));
	C = UPCASE(SCAN(ONE_EML,A,'_'));
	IF A = 1 THEN DO;
		COM = B;
		ONE = C;
	END;
	ELSE DO;
		COM = TRIM(COM) || TRIM(B);
		ONE = TRIM(ONE) || TRIM(C);
	END;
A = A + 1;
END;
	IF COM = ONE THEN REPORT = 'R3';
	ELSE REPORT = 'R2';
RUN;
ENDRSUBMIT;
DATA DEMO;
	SET WORKLOCL.DEMO;
RUN; 

PROC SORT DATA=DEMO ;
	BY DF_SPE_ACC_ID;
RUN;

DATA _NULL_;
SET DEMO ;
WHERE REPORT = 'R2';
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
IF _N_ = 1 THEN DO;
	PUT "ACCOUNT NUMBER,BORROWER NAME,COMPASS EMAIL,ONELINK EMAIL";
END;
DO;
   PUT DF_SPE_ACC_ID @;
   PUT B_NAME @;
   PUT COM_EML @;
   PUT ONE_EML $ ;
END;
RUN;
DATA _NULL_;
SET DEMO ;
WHERE REPORT = 'R3';
FILE REPORT3 DELIMITER=',' DSD DROPOVER LRECL=32767;
IF _N_ = 1 THEN DO;
	PUT "ACCOUNT NUMBER,BORROWER NAME,COMPASS EMAIL,ONELINK EMAIL";
END;
DO;
   PUT DF_SPE_ACC_ID @;
   PUT B_NAME @;
   PUT COM_EML @;
   PUT ONE_EML $ ;
END;
RUN;
