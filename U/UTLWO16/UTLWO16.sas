/*MONTHLY TOTAL BORROWERS, LOANS, PRINCIPAL TOTALS FOR LENDERS*/
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWO16.LWO16R2";
FILENAME REPORT3 "&RPTLIB/ULWO16.LWO16R3";
FILENAME REPORT4 "&RPTLIB/ULWO16.LWO16R4";
FILENAME REPORT5 "&RPTLIB/ULWO16.LWO16R5";
FILENAME REPORT6 "&RPTLIB/ULWO16.LWO16R6";
FILENAME REPORT7 "&RPTLIB/ULWO16.LWO16R7";
FILENAME REPORT8 "&RPTLIB/ULWO16.LWO16R8";
FILENAME REPORT9 "&RPTLIB/ULWO16.LWO16R9";
FILENAME REPORT10 "&RPTLIB/ULWO16.LWO16R10";
FILENAME REPORT11 "&RPTLIB/ULWO16.LWO16R11";
FILENAME REPORT12 "&RPTLIB/ULWO16.LWO16R12";
FILENAME REPORT13 "&RPTLIB/ULWO16.LWO16R13";
FILENAME REPORT14 "&RPTLIB/ULWO16.LWO16R14";
FILENAME REPORT15 "&RPTLIB/ULWO16.LWO16R15";
FILENAME REPORT16 "&RPTLIB/ULWO16.LWO16R16";
FILENAME REPORT17 "&RPTLIB/ULWO16.LWO16R17";
FILENAME REPORT18 "&RPTLIB/ULWO16.LWO16R18";
FILENAME REPORT19 "&RPTLIB/ULWO16.LWO16R19";
FILENAME REPORT20 "&RPTLIB/ULWO16.LWO16R20";
FILENAME REPORT21 "&RPTLIB/ULWO16.LWO16R21";
FILENAME REPORT22 "&RPTLIB/ULWO16.LWO16R22";
FILENAME REPORT23 "&RPTLIB/ULWO16.LWO16R23";
FILENAME REPORT24 "&RPTLIB/ULWO16.LWO16R24";
FILENAME REPORT25 "&RPTLIB/ULWO16.LWO16R25";
FILENAME REPORT26 "&RPTLIB/ULWO16.LWO16R26";
FILENAME REPORT27 "&RPTLIB/ULWO16.LWO16R27";
FILENAME REPORT28 "&RPTLIB/ULWO16.LWO16R28";
FILENAME REPORT29 "&RPTLIB/ULWO16.LWO16R29";
options symbolgen;

Libname  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=work  ;
RSUBMIT;
OPTIONS NOCENTER NODATE NONUMBER LS=132;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE TIERTB AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT 
	A.IF_OWN
	,LR10.IM_LDR_FUL
	,A.LN_SEQ
	,A.BF_SSN
	,COALESCE(A.WA_CUR_PRI,0) AS WA_CUR_PRI
	,A.WD_MR50_CRT
	,A.WF_TIR_PCE_LN35
	,B.LF_RGL_CAT_LP20
	,CASE
		WHEN A.WF_TIR_PCE_LN35 <> '' AND 
			INT(B.LF_RGL_CAT_LP20) < 2008020 
			THEN 'Loans with Zero Origination Fee'
		WHEN A.WF_TIR_PCE_LN35 <> '' AND 
			INT(B.LF_RGL_CAT_LP20) = 2008020 
			THEN 'UHEAA Paid Origination Fee'
		WHEN INT(B.LF_RGL_CAT_LP20) = 2009020 AND COALESCE(OF.OFEE,0) > 0 AND COALESCE(GF.GFEE,0) > 0
			THEN 'Loans with Orig / Guar Fee ED 0.5% / 1%'
		WHEN INT(B.LF_RGL_CAT_LP20) = 2009020 AND (COALESCE(OF.OFEE,0) = 0 OR COALESCE(GF.GFEE,0) = 0)
			THEN 'Loans with Orig / Guar Fee ED % / 1%'
		ELSE 'Loans with Origination Fee'
	END AS DESCRIPTION

	,CASE 
		WHEN INT(B.LF_RGL_CAT_LP20) <= 1999030 THEN '3%'
	 	WHEN INT(B.LF_RGL_CAT_LP20) = 2006020 AND 
			B.IC_LON_PGM NOT IN ('PLUS','PLUSGB') THEN '2%'
		WHEN INT(B.LF_RGL_CAT_LP20) = 2006020 AND 
			B.IC_LON_PGM IN ('PLUS','PLUSGB') AND 
			PL_DISB.DSB_IND = 'X' THEN '2%'
		WHEN INT(B.LF_RGL_CAT_LP20) = 2006020 AND 
			B.IC_LON_PGM IN ('PLUS','PLUSGB') AND 
			PL_DISB.DSB_IND IS NULL THEN '3%'
		WHEN INT(B.LF_RGL_CAT_LP20) = 2007020 AND 
			B.IC_LON_PGM IN ('STFFRD','UNSTFD') THEN '1.5%'
		WHEN INT(B.LF_RGL_CAT_LP20) = 2008020 AND 
			B.IC_LON_PGM IN ('STFFRD','UNSTFD') THEN '1%'
		WHEN INT(B.LF_RGL_CAT_LP20) = 2009020 AND 
			B.IC_LON_PGM IN ('STFFRD','UNSTFD') THEN '0.5%'
		WHEN INT(B.LF_RGL_CAT_LP20) = 2009020 AND 
			B.IC_LON_PGM IN ('PLUS','PLUSGB') THEN '3%'
	END AS LOANP

FROM OLWHRM1.MR5A_MR_LON_MTH_01 A 
INNER JOIN OLWHRM1.LR10_LDR_DMO LR10
	ON A.IF_OWN = LR10.IF_DOE_LDR
INNER JOIN OLWHRM1.LN10_LON B
	ON A.BF_SSN = B.BF_SSN
	AND A.LN_SEQ = B.LN_SEQ
LEFT OUTER JOIN (
	SELECT BF_SSN 
		,LN_SEQ
		,'X' AS DSB_IND
	FROM OLWHRM1.LN15_DSB
	WHERE DAYS(LD_DSB) <= DAYS('08/07/2006')
	AND IC_LON_PGM IN ('PLUS','PLUSGB')
	AND LC_STA_LON15 IN ('1','3')
	AND LC_DSB_TYP = '2'
	AND LA_DSB <> COALESCE(LA_DSB_CAN,0)
	) PL_DISB
	ON B.BF_SSN = PL_DISB.BF_SSN
	AND B.LN_SEQ = PL_DISB.LN_SEQ
LEFT OUTER JOIN (
	SELECT O1.BF_SSN 
		,O1.LN_SEQ
		,SUM(O2.LA_DSB_FEE) AS OFEE
	FROM OLWHRM1.LN15_DSB O1
	INNER JOIN OLWHRM1.LN18_DSB_FEE O2
		ON O1.BF_SSN = O2.BF_SSN
		AND O1.LN_BR_DSB_SEQ = O1.LN_BR_DSB_SEQ
	WHERE O2.LC_DSB_FEE = '02'
	GROUP BY O1.BF_SSN 
		,O1.LN_SEQ
	) OF
	ON A.BF_SSN = OF.BF_SSN
	AND A.LN_SEQ = OF.LN_SEQ
LEFT OUTER JOIN (
	SELECT G1.BF_SSN 
		,G1.LN_SEQ
		,SUM(G2.LA_DSB_FEE) AS GFEE
	FROM OLWHRM1.LN15_DSB G1
	INNER JOIN OLWHRM1.LN18_DSB_FEE G2
		ON G1.BF_SSN = G2.BF_SSN
		AND G1.LN_BR_DSB_SEQ = G1.LN_BR_DSB_SEQ
	WHERE G2.LC_DSB_FEE = '21'
	GROUP BY G1.BF_SSN 
		,G1.LN_SEQ
	) GF
	ON A.BF_SSN = GF.BF_SSN
	AND A.LN_SEQ = GF.LN_SEQ
WHERE A.WA_CUR_PRI <> 0
);

DISCONNECT FROM DB2;
ENDRSUBMIT;

DATA TIERTB;SET WORKLOCL.TIERTB;RUN;
proc sort data=tiertb; by LF_RGL_CAT_LP20; run;
*LAST DAY OF LAST MONTH FOR TITLE;
DATA _NULL_;
SET TIERTB;
CALL SYMPUT('EFFDATE',PUT(WD_MR50_CRT,MMDDYY10.));
RUN;

%MACRO TIER(LDR, RPNO);
DATA TEMPTB;
	SET TIERTB;
	IF IF_OWN = "&LDR" THEN OUTPUT TEMPTB;
	ELSE DELETE;
RUN;

PROC SQL NOPRINT;
	SELECT COUNT(*) 
	INTO : HASOBS
	FROM TEMPTB
	;
QUIT;

OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=132 PAGENO = 1 NODATE CENTER;

PROC PRINTTO PRINT=REPORT&RPNO NEW;
RUN;

%IF &HASOBS EQ 0 %THEN %DO;
	DATA _NULL_;
	FILE PRINT;
	   PUT // 126*'-';
	   PUT      //////
	       @51 '**** NO LOANS FOUND ****';
	   PUT //////
	       @53 '-- END OF REPORT --';
	   PUT ///////////////
	   		@46 "JOB = UTLWO16     REPORT = ULWO16.LWO16R&RPNO";
	TITLE1 'TOTAL BORROWERS, LOANS AND PRINCIPAL BALANCE';
	TITLE2 "LENDER ID # &LDR";
	TITLE3 "AT MONTH-END &EFFDATE";
	RUN;
%END;
%ELSE %DO;
	DATA _NULL_;
		SET TEMPTB;
		CALL SYMPUT('NAME',TRIM(IM_LDR_FUL));
	RUN;

	DATA _NULL_;
		IF "&LDR" = "813760UT" THEN CALL SYMPUT('LID',"813760");
		ELSE CALL SYMPUT('LID',"&LDR");
	RUN;

	PROC SORT DATA=TEMPTB;BY BF_SSN DESCRIPTION LOANP LN_SEQ; RUN;

	DATA TEMPTB;
		SET TEMPTB;
		BY BF_SSN DESCRIPTION LOANP LN_SEQ;
		IF LAST.BF_SSN OR LAST.DESCRIPTION OR LAST.LOANP THEN X=1;
		ELSE X=0;
		IF LAST.LN_SEQ THEN Y=1;
		ELSE Y=0;
		IF LAST.BF_SSN THEN Z=1;
		ELSE Z=0;
	RUN;

	PROC REPORT DATA=TEMPTB NOWD HEADSKIP SPLIT='/';
		TITLE1 'TOTAL BORROWERS, LOANS AND PRINCIPAL BALANCE';
		TITLE2 "&NAME";
		TITLE3 "LENDER ID # &LID";
		TITLE4 "AT MONTH-END &EFFDATE";
		FOOTNOTE  "JOB = UTLWO16     REPORT = ULWO16.LWO16R&RPNO.";
		COLUMN IF_OWN DESCRIPTION LOANP Y X WA_CUR_PRI Z;
		DEFINE IF_OWN / GROUP NOPRINT;
		DEFINE DESCRIPTION / GROUP "CATEGORY" WIDTH=15 FLOW;
		DEFINE LOANP / GROUP "ED ORIGINATION FEE %" WIDTH=11;
		DEFINE X / SUM "TOTAL BORROWERS" WIDTH=10;
		DEFINE Y / SUM "NUMBER OF LOANS" FORMAT=15. WIDTH=15;
		DEFINE WA_CUR_PRI / SUM "PRINCIPAL BALANCE" FORMAT=DOLLAR20.2;
		DEFINE Z / ANALYSIS NOPRINT;
		BREAK AFTER IF_OWN / OL SUPPRESS SKIP;
		COMPUTE AFTER;
			LINE @65 Y.SUM COMMA7. @88 WA_CUR_PRI.SUM DOLLAR18.2;
			LINE ' ';
			LINE ' ';
			LINE @27 'TOTAL NUMBER OF UNIQUE BORROWERS:' @60 Z.SUM COMMA7.;
		ENDCOMP;
	RUN;
%END;
PROC PRINTTO;
RUN;
%MEND TIER;
%TIER(811698,2);
%TIER(813760UT,3);
%TIER(813894,4);
%TIER(817440,5);
%TIER(817455,6);
%TIER(817545,7);
%TIER(817546,8);
%TIER(819628,9);
%TIER(829505,10);
%TIER(820200,11);
%TIER(822373,12);
%TIER(829123,13);
%TIER(829158,14);
%TIER(830132,15);
%TIER(830146,16);
%TIER(830791,17);
%TIER(832241,18);
%TIER(833828,19);
%TIER(817575,20);
%TIER(834122,21);
%TIER(833577,22);
%TIER(834265,23);
%TIER(834370,24);
%TIER(834437,25);
%TIER(834396,26);
%TIER(82847601,27);
%TIER(834493,28);
%TIER(834529,29);
/*****************************************************
* REQUESTED TESTING FILES - FOR TEST USE ONLY!!!
******************************************************/
/*%MACRO DETAIL(ID,FILE);*/
/*DATA _NULL_;*/
/*SET TIERTB;*/
/*WHERE IF_OWN = "&ID";*/
/*FILE "T:\SAS\&FILE..txt" DELIMITER=',' DSD DROPOVER LRECL=32767;*/
/*   FORMAT IF_OWN $8. ;*/
/*   FORMAT IM_LDR_FUL $40. ;*/
/*   FORMAT LN_SEQ 6. ;*/
/*   FORMAT BF_SSN $9. ;*/
/*   FORMAT WA_CUR_PRI 15.2 ;*/
/*   FORMAT WD_MR50_CRT MMDDYY10. ;*/
/*   FORMAT WF_TIR_PCE_LN35 $3. ;*/
/*   FORMAT LF_RGL_CAT_LP20 $7. ;*/
/*   FORMAT DESCRIPTION $31. ;*/
/*   FORMAT LOANP $2. ;*/
/*IF _N_ = 1 THEN */
/* DO;*/
/*   PUT*/
/*   'IF_OWN'*/
/*   ','*/
/*   'IM_LDR_FUL'*/
/*   ','*/
/*   'LN_SEQ'*/
/*   ','*/
/*   'BF_SSN'*/
/*   ','*/
/*   'WA_CUR_PRI'*/
/*   ','*/
/*   'WD_MR50_CRT'*/
/*   ','*/
/*   'WF_TIR_PCE_LN35'*/
/*   ','*/
/*   'LF_RGL_CAT_LP20'*/
/*   ','*/
/*   'DESCRIPTION'*/
/*   ','*/
/*   'LOANP'*/
/*   ;*/
/*END;*/
/*DO;*/
/*   PUT IF_OWN $ @;*/
/*   PUT IM_LDR_FUL $ @;*/
/*   PUT LN_SEQ @;*/
/*   PUT BF_SSN $ @;*/
/*   PUT WA_CUR_PRI @;*/
/*   PUT WD_MR50_CRT @;*/
/*   PUT WF_TIR_PCE_LN35 $ @;*/
/*   PUT LF_RGL_CAT_LP20 $ @;*/
/*   PUT DESCRIPTION $ @;*/
/*   PUT LOANP $ ;*/
/*END;*/
/*RUN;*/
/*%MEND DETAIL;*/
/*%DETAIL(811698,ULWO16.LWO16R2_DETAIL);*/
/*%DETAIL(817455,ULWO16.LWO16R6_DETAIL);*/
/*%DETAIL(817546,ULWO16.LWO16R8_DETAIL);*/
/*%DETAIL(820200,ULWO16.LWO16R11_DETAIL);*/
/*%DETAIL(822373,ULWO16.LWO16R12_DETAIL);*/
/*%DETAIL(830132,ULWO16.LWO16R15_DETAIL);*/
/*%DETAIL(830791,ULWO16.LWO16R17_DETAIL);*/
/*%DETAIL(833828,ULWO16.LWO16R19_DETAIL);*/
/*%DETAIL(817575,ULWO16.LWO16R20_DETAIL);*/
/*%DETAIL(834493,ULWO16.LWO16R28_DETAIL);*/
