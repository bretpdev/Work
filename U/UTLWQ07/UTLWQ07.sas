/*UTLWQ07 - MONTHLY LOAN SALES FOR P-NOTE IMAGE RETRIEVAL*/

/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;
%LET RPTLIB = %SYSGET(reportdir);
FILENAME REPORT2 "&RPTLIB/ULWQ07.LWQ07R2";*/

FILENAME REPORT2 "T:\SAS\ULWQ07.LWQ07R2";
/*THESE REPORTS WERE USED TO GENERATE MONTHLY FILES FOR TESTING*/
/*FILENAME REPORT3 "T:\SAS\MAR03";*/
/*FILENAME REPORT4 "T:\SAS\APR03";*/
/*FILENAME REPORT5 "T:\SAS\MAY03";*/
/*FILENAME REPORT6 "T:\SAS\JUN03";*/
/*FILENAME REPORT7 "T:\SAS\JUL03";*/
/*FILENAME REPORT8 "T:\SAS\AUG03";*/
/*FILENAME REPORT9 "T:\SAS\SEP03";*/
/*FILENAME REPORT10 "T:\SAS\OCT03";*/
/*FILENAME REPORT11 "T:\SAS\NOV03";*/
/*FILENAME REPORT12 "T:\SAS\DEC03";*/
/*FILENAME REPORT13 "T:\SAS\JAN04";*/

DATA _NULL_;
     CALL SYMPUT('BEGIN',"'"||PUT(INTNX('MONTH',TODAY()+3,-1,'beginning'), MMDDYYD10.)||"'");
     CALL SYMPUT('END',"'"||PUT(INTNX('MONTH',TODAY()+3,-1,'end'), MMDDYYD10.)||"'");
     CALL SYMPUT('EFFDATE',TRIM(LEFT(UPCASE(
		PUT(INTNX('MONTH',TODAY()+3,-1), MONNAME9.)||' '||
		PUT(INTNX('MONTH',TODAY()+3,-1), YEAR4.)))));
RUN;
%SYSLPUT BEGIN = &BEGIN;
%SYSLPUT END = &END;

libname  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=work  ;
RSUBMIT;
OPTIONS NOCENTER NODATE NONUMBER LS=132;
PROC SQL STIMER;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE SLDIMG AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT C.ID_LON_SLE,A.BF_SSN
,D.AF_APL_ID AS UID
,D.AD_PRC AS GTY_DT
,SUBSTR(E.AF_CUR_APL_OPS_LDR,1,6) AS LDR

,E.AF_BS_MPN_APL_ID AS UID_BS
,Y.AD_PRC AS GTY_DT_BS
,SUBSTR(X.AF_CUR_APL_OPS_LDR,1,6) AS LDR_BS
,C.ID_LON_SLE

FROM OLWHRM1.LN10_LON A 
INNER JOIN OLWHRM1.LN35_LON_OWN B
	ON A.BF_SSN = B.BF_SSN
	AND A.LN_SEQ = B.LN_SEQ
INNER JOIN OLWHRM1.OW30_LON_SLE_CTL C
	ON B.IF_LON_SLE = C.IF_LON_SLE
INNER JOIN OLWHRM1.GA10_LON_APP D
	ON A.LF_LON_ALT = D.AF_APL_ID
	AND A.LN_LON_ALT_SEQ = INTEGER(D.AF_APL_ID_SFX)
INNER JOIN OLWHRM1.GA01_APP E
	ON D.AF_APL_ID = E.AF_APL_ID
LEFT OUTER JOIN OLWHRM1.GA01_APP X
	ON E.AF_BS_MPN_APL_ID = X.AF_APL_ID
LEFT OUTER JOIN
	(SELECT AF_APL_ID
	,MIN(AD_PRC) AS AD_PRC
	FROM OLWHRM1.GA10_LON_APP
	WHERE AC_PRC_STA = 'A'
	GROUP BY AF_APL_ID
	)Y
	ON X.AF_APL_ID = Y.AF_APL_ID
WHERE B.LC_STA_LON35 = 'A' /*ACTIVE SALE LINK FOR THE LOAN*/
AND D.AC_PRC_STA = 'A' /*STATUS DATE FOR APPROVED LOAN*/
AND C.IC_LON_SLE_STA = 'C' /*COMPLETE SALE*/
AND C.IC_LON_SLE_TYP = 'S' /*DECONVERSION SALE*/
AND C.ID_LON_SLE BETWEEN &BEGIN AND &END /*C.ID_LON_SLE > '03/01/2003' FOR TEST FILES*/
AND C.IF_BUY_OWN IN ('830248','829769','826717')
);
DISCONNECT FROM DB2;
ENDRSUBMIT  ;

DATA SLDIMG; 
SET WORKLOCL.SLDIMG; 
RUN;
PROC SORT DATA=SLDIMG;
BY ID_LON_SLE BF_SSN LDR GTY_DT;
RUN;

DATA SLDPRN (KEEP=BF_SSN GTY_DT UID LDR ID_LON_SLE); 
SET SLDIMG; 
FORMAT ID_LON_SLE MMDDYY10.;
IF UID_BS NE ' ' THEN DO;
	UID = UID_BS;
	GTY_DT = GTY_DT_BS;
	LDR = LDR_BS;
	END;
RUN;

PROC SORT DATA=SLDPRN NODUPKEY;
BY BF_SSN LDR GTY_DT;
RUN;

/*USED IN TESTING*/
/*DATA MAR03 APR03 MAY03 JUN03 JUL03 AUG03 SEP03 OCT03 NOV03 DEC03 JAN04 OTH;*/
/*SET SLDPRN;*/
/*IF ID_LON_SLE > '01MAR2003'D AND ID_LON_SLE < '31MAR2003'D THEN OUTPUT MAR03;*/
/*ELSE IF ID_LON_SLE > '01APR2003'D AND ID_LON_SLE < '30APR2003'D THEN OUTPUT APR03;*/
/*ELSE IF ID_LON_SLE > '01MAY2003'D AND ID_LON_SLE < '31MAY2003'D THEN OUTPUT MAY03;*/
/*ELSE IF ID_LON_SLE > '01JUN2003'D AND ID_LON_SLE < '30JUN2003'D THEN OUTPUT JUN03;*/
/*ELSE IF ID_LON_SLE > '01JUL2003'D AND ID_LON_SLE < '31JUL2003'D THEN OUTPUT JUL03;*/
/*ELSE IF ID_LON_SLE > '01AUG2003'D AND ID_LON_SLE < '31AUG2003'D THEN OUTPUT AUG03;*/
/*ELSE IF ID_LON_SLE > '01SEP2003'D AND ID_LON_SLE < '30SEP2003'D THEN OUTPUT SEP03;*/
/*ELSE IF ID_LON_SLE > '01OCT2003'D AND ID_LON_SLE < '31OCT2003'D THEN OUTPUT OCT03;*/
/*ELSE IF ID_LON_SLE > '01NOV2003'D AND ID_LON_SLE < '30NOV2003'D THEN OUTPUT NOV03;*/
/*ELSE IF ID_LON_SLE > '01DEC2003'D AND ID_LON_SLE < '31DEC2003'D THEN OUTPUT DEC03;*/
/*ELSE IF ID_LON_SLE > '01JAN2004'D AND ID_LON_SLE < '31JAN2004'D THEN OUTPUT JAN04;*/
/*ELSE OUTPUT OTH;*/
/*RUN;*/

/*ORIGINAL FILE*/
DATA _NULL_;
SET  WORK.SLDPRN;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
FORMAT BF_SSN $9. ;
FORMAT LDR $8. ;
FORMAT GTY_DT MMDDYY6.;
DO;
PUT BF_SSN $ @;
PUT LDR $ @;
PUT GTY_DT ;
END;
RUN;

/*TESTING FILES - THESE PRODUCE MONTHLY FILES*/
/*DATA _NULL_;*/
/*SET  WORK.MAR03;*/
/*FILE REPORT3 DELIMITER=',' DSD DROPOVER LRECL=32767;*/
/*FORMAT BF_SSN $9. ;*/
/*FORMAT LDR $8. ;*/
/*FORMAT GTY_DT MMDDYY6.;*/
/*DO;*/
/*PUT BF_SSN $ @;*/
/*PUT LDR $ @;*/
/*PUT GTY_DT ;*/
/*;*/
/*END;*/
/*RUN;*/
/**/
/*DATA _NULL_;*/
/*SET  WORK.APR03;*/
/*FILE REPORT4 DELIMITER=',' DSD DROPOVER LRECL=32767;*/
/*FORMAT BF_SSN $9. ;*/
/*FORMAT LDR $8. ;*/
/*FORMAT GTY_DT MMDDYY6.;*/
/*DO;*/
/*PUT BF_SSN $ @;*/
/*PUT LDR $ @;*/
/*PUT GTY_DT ;*/
/*;*/
/*END;*/
/*RUN;*/
/**/
/*DATA _NULL_;*/
/*SET  WORK.MAY03;*/
/*FILE REPORT5 DELIMITER=',' DSD DROPOVER LRECL=32767;*/
/*FORMAT BF_SSN $9. ;*/
/*FORMAT LDR $8. ;*/
/*FORMAT GTY_DT MMDDYY6.;*/
/*DO;*/
/*PUT BF_SSN $ @;*/
/*PUT LDR $ @;*/
/*PUT GTY_DT ;*/
/*;*/
/*END;*/
/*RUN;*/
/**/
/*DATA _NULL_;*/
/*SET  WORK.JUN03;*/
/*FILE REPORT6 DELIMITER=',' DSD DROPOVER LRECL=32767;*/
/*FORMAT BF_SSN $9. ;*/
/*FORMAT LDR $8. ;*/
/*FORMAT GTY_DT MMDDYY6.;*/
/*DO;*/
/*PUT BF_SSN $ @;*/
/*PUT LDR $ @;*/
/*PUT GTY_DT ;*/
/*;*/
/*END;*/
/*RUN;*/
/**/
/*DATA _NULL_;*/
/*SET  WORK.JUL03;*/
/*FILE REPORT7 DELIMITER=',' DSD DROPOVER LRECL=32767;*/
/*FORMAT BF_SSN $9. ;*/
/*FORMAT LDR $8. ;*/
/*FORMAT GTY_DT MMDDYY6.;*/
/*DO;*/
/*PUT BF_SSN $ @;*/
/*PUT LDR $ @;*/
/*PUT GTY_DT ;*/
/*;*/
/*END;*/
/*RUN;*/
/**/
/*DATA _NULL_;*/
/*SET  WORK.AUG03;*/
/*FILE REPORT8 DELIMITER=',' DSD DROPOVER LRECL=32767;*/
/*FORMAT BF_SSN $9. ;*/
/*FORMAT LDR $8. ;*/
/*FORMAT GTY_DT MMDDYY6.;*/
/*DO;*/
/*PUT BF_SSN $ @;*/
/*PUT LDR $ @;*/
/*PUT GTY_DT ;*/
/*;*/
/*END;*/
/*RUN;*/
/**/
/*DATA _NULL_;*/
/*SET  WORK.SEP03;*/
/*FILE REPORT9 DELIMITER=',' DSD DROPOVER LRECL=32767;*/
/*FORMAT BF_SSN $9. ;*/
/*FORMAT LDR $8. ;*/
/*FORMAT GTY_DT MMDDYY6.;*/
/*DO;*/
/*PUT BF_SSN $ @;*/
/*PUT LDR $ @;*/
/*PUT GTY_DT ;*/
/*;*/
/*END;*/
/*RUN;*/
/**/
/*DATA _NULL_;*/
/*SET  WORK.OCT03;*/
/*FILE REPORT10 DELIMITER=',' DSD DROPOVER LRECL=32767;*/
/*FORMAT BF_SSN $9. ;*/
/*FORMAT LDR $8. ;*/
/*FORMAT GTY_DT MMDDYY6.;*/
/*DO;*/
/*PUT BF_SSN $ @;*/
/*PUT LDR $ @;*/
/*PUT GTY_DT ;*/
/*;*/
/*END;*/
/*RUN;*/
/**/
/*DATA _NULL_;*/
/*SET  WORK.NOV03;*/
/*FILE REPORT11 DELIMITER=',' DSD DROPOVER LRECL=32767;*/
/*FORMAT BF_SSN $9. ;*/
/*FORMAT LDR $8. ;*/
/*FORMAT GTY_DT MMDDYY6.;*/
/*DO;*/
/*PUT BF_SSN $ @;*/
/*PUT LDR $ @;*/
/*PUT GTY_DT ;*/
/*;*/
/*END;*/
/*RUN;*/
/**/
/*DATA _NULL_;*/
/*SET  WORK.DEC03;*/
/*FILE REPORT12 DELIMITER=',' DSD DROPOVER LRECL=32767;*/
/*FORMAT BF_SSN $9. ;*/
/*FORMAT LDR $8. ;*/
/*FORMAT GTY_DT MMDDYY6.;*/
/*DO;*/
/*PUT BF_SSN $ @;*/
/*PUT LDR $ @;*/
/*PUT GTY_DT ;*/
/*;*/
/*END;*/
/*RUN;*/
/**/
/*DATA _NULL_;*/
/*SET  WORK.JAN04;*/
/*FILE REPORT13 DELIMITER=',' DSD DROPOVER LRECL=32767;*/
/*FORMAT BF_SSN $9. ;*/
/*FORMAT LDR $8. ;*/
/*FORMAT GTY_DT MMDDYY6.;*/
/*DO;*/
/*PUT BF_SSN $ @;*/
/*PUT LDR $ @;*/
/*PUT GTY_DT ;*/
/*;*/
/*END;*/
/*RUN;*/
