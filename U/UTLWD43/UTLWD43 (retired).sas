/*read file from external source*/
/*TEST*/

%LET RPTLIB = X:\PADD\FTP\Test\;
LIBNAME CSYS ODBC REQUIRED="FILEDSN=X:\PADR\ODBC\CSYSTEST.dsn; bl_keepnulls=no; READ_ISOLATION_LEVEL=RU" SCHEMA= dbo;
%LET TestMode = 1;

/*LIVE*/
/*
%LET RPTLIB = X:\PADD\FTP;
LIBNAME CSYS ODBC REQUIRED="FILEDSN=X:\PADR\ODBC\CSYS.dsn; bl_keepnulls=no; READ_ISOLATION_LEVEL=RU" SCHEMA= dbo;
%LET TestMode = 0;
*/

%LET NUMDATE = %SYSFUNC(TODAY(), YYMMDDN8.);
FILENAME REPORT2 "&RPTLIB/UTLWD43.ULWD43R2.&NUMDATE";
FILENAME REPORT3 "&RPTLIB/UTLWD43.ULWD43R3.&NUMDATE";

PROC SQL NOPRINT;
CONNECT TO ODBC AS CSYS (REQUIRED="FILEDSN=X:\PADR\ODBC\CSYSTEST.dsn;");
CREATE TABLE SAS_Path AS
	SELECT
		*
	FROM CONNECTION TO CSYS
	(
		SELECT
			Path
		FROM
			GENR_DAT_EnterpriseFileSystem
		WHERE
			[KEY] = 'UTLWD43'
			AND TestMode = &TestMode
	);
	DISCONNECT FROM CSYS;

	SELECT
		Path INTO :INPUTFILE
	FROM
		Sas_path
	;
QUIT;

%PUT &INPUTFILE;

DATA WORK.DODMATCH;
	INFILE "&INPUTFILE";
	INPUT 
		SSN $ 1-9
		DOB 10-17
		LAST_NAME $ 18-43
		FIRST_NAME $ 44-63
		CUSTOMER_RECORD_ID $ 64-91
		ACTIVE_DUTY_STATUS_DATE 92-99  
		BLANK $ 100
		ACTIVE_DUTY_ON_ADS_DATE $ 101
		LEFT_ACTIVE_DUTY_LE367_DAYS $ 102
		NOTIFIED_OF_ACTIVE_DUTY_RECALL $ 103
		ACTIVE_DUTY_END_DT 104-111 /*unformatted*/
		MATCH_RESULT_CODE 112
		ERROR 113
		DATE_OF_MATCH 114-121
		ACTIVE_DUTY_BEGIN_DT 122-129 /*unformatted*/
		EID_BEGIN_DT 130-137 /*unformatted*/
		EID_END_DT 138-145 /*unformatted*/
		SERVICE_COMPONENT $ 146-147
		EID_SERVICE_COMPONENT $ 148-149
		MIDDLE_NAME $ 150-169
		CERTIFICATE_ID $ 170-184
	;
RUN;

DATA WORK.DOD_XYN;
	SET WORK.DODMATCH;
	/*select active duty*/
	WHERE ACTIVE_DUTY_ON_ADS_DATE = 'X'
		OR NOTIFIED_OF_ACTIVE_DUTY_RECALL = 'Y'
		OR (
				ACTIVE_DUTY_ON_ADS_DATE = 'N'
				AND LEFT_ACTIVE_DUTY_LE367_DAYS = 'Y'
			);
	/*convert invalid 0 dates to specified dummy date*/
	IF ACTIVE_DUTY_END_DT = 00000000 THEN ACTIVE_DUTY_END_DT = 20991231;
	IF ACTIVE_DUTY_BEGIN_DT = 00000000 THEN ACTIVE_DUTY_BEGIN_DT = 19201231;
	IF EID_BEGIN_DT = 00000000 THEN EID_BEGIN_DT = 19201231;
	IF EID_END_DT = 00000000 THEN EID_END_DT = 20991231;
RUN;

DATA WORK.DOD_XYN;
	SET WORK.DOD_XYN;
	/*transform dates from numeric to character then back to numeric with proper date formatting*/
		ACTIVE_DUTY_BEGIN_DATE = INPUT(PUT(ACTIVE_DUTY_BEGIN_DT,8.),YYMMDD8.);
		ACTIVE_DUTY_END_DATE = INPUT(PUT(ACTIVE_DUTY_END_DT,8.),YYMMDD8.);
		EID_BEGIN_DATE = INPUT(PUT(EID_BEGIN_DT,8.),YYMMDD8.);
		EID_END_DATE = INPUT(PUT(EID_END_DT,8.),YYMMDD8.);
	FORMAT 
		ACTIVE_DUTY_BEGIN_DATE
		ACTIVE_DUTY_END_DATE
		EID_BEGIN_DATE
		EID_END_DATE 
		MMDDYY10.;
RUN;

LIBNAME  DUSTER  REMOTE  SERVER=DUSTER  SLIBREF=WORK; /*live*/

DATA DUSTER.DOD_XYN; SET WORK.DOD_XYN; RUN;

RSUBMIT;
%LET DB = DLGSUTWH; /*live*/
LIBNAME OLWHRM1 DB2 DATABASE=&DB OWNER=OLWHRM1;

PROC SQL;
	CREATE TABLE BORROWERS AS
		SELECT DISTINCT
			GA01.DF_PRS_ID_BR,
			DOD.*
		FROM
			WORK.DOD_XYN DOD
			INNER JOIN OLWHRM1.GA01_APP GA01
				ON GA01.DF_PRS_ID_BR = DOD.SSN
			INNER JOIN OLWHRM1.GA11_LON_DSB_ATY GA11
				ON GA11.AF_APL_ID = GA01.AF_APL_ID
				AND GA11.AC_DSB_ADJ = 'A'
		WHERE 
			GA11.AD_DSB_ADJ <= DOD.ACTIVE_DUTY_BEGIN_DATE
	;
	CREATE TABLE ENDORSERS AS
		SELECT DISTINCT
			GA01.DF_PRS_ID_EDS
			,DOD.*
		FROM
			WORK.DOD_XYN DOD
			INNER JOIN OLWHRM1.GA01_APP GA01
				ON GA01.DF_PRS_ID_EDS = DOD.SSN
			INNER JOIN OLWHRM1.GA11_LON_DSB_ATY GA11
                ON GA11.AF_APL_ID = GA01.AF_APL_ID
				AND GA11.AC_DSB_ADJ = 'A'
		WHERE 
			GA11.AD_DSB_ADJ <= DOD.ACTIVE_DUTY_BEGIN_DATE
	;
QUIT;
ENDRSUBMIT;

/*distinguish borrower & endorser data*/
DATA BORROWERS; 
	SET DUSTER.BORROWERS; 
	LENGTH TYPE $ 10;
	TYPE = 'BORROWER';
RUN;
DATA ENDORSERS; 
	SET DUSTER.ENDORSERS; 
	LENGTH TYPE $ 10;
	TYPE = 'ENDORSER';
RUN;

/*concatenate both populations*/
DATA POPULATION; 
	SET BORROWERS ENDORSERS; 
RUN;

/*R2 output setup*/
DATA R2POPALL;
	SET POPULATION;
	LENGTH COMMENT1 $ 200 ;
	IF TYPE = "BORROWER" THEN
	DO;
		IF ACTIVE_DUTY_ON_ADS_DATE = "X" THEN
			DO;
				COMMENT1 = "Borrower SCRA Review. Active Duty Begin Date =";
				COMMENT2 = ACTIVE_DUTY_BEGIN_DATE;
				COMMENT3 = ACTIVE_DUTY_END_DATE;
			END;
		ELSE IF NOTIFIED_OF_ACTIVE_DUTY_RECALL = "Y" THEN
			DO;
				COMMENT1 = "Borrower SCRA Review. Active Duty Begin Date =";
				COMMENT2 = EID_BEGIN_DATE;
				COMMENT3 = ACTIVE_DUTY_END_DATE;
			END;
		ELSE IF (ACTIVE_DUTY_ON_ADS_DATE = "N" AND LEFT_ACTIVE_DUTY_LE367_DAYS = "Y") THEN
            DO; 
                COMMENT1 = "Borrower SCRA Review. Active Duty Begin Date =";
                COMMENT2 = ACTIVE_DUTY_BEGIN_DATE;
				COMMENT3 = ACTIVE_DUTY_END_DATE;
			END;
	END;
	IF TYPE = "ENDORSER" THEN
	DO;
		IF ACTIVE_DUTY_ON_ADS_DATE = "X" THEN
			DO;
				COMMENT1 = "Co-Borrower/Endorser SCRA Review. Active Duty Begin Date =";
				COMMENT2 = ACTIVE_DUTY_BEGIN_DATE;
				COMMENT3 = ACTIVE_DUTY_END_DATE;
			END;
		ELSE IF NOTIFIED_OF_ACTIVE_DUTY_RECALL = "Y" THEN
			DO;
				COMMENT1 = "Co-Borrower/Endorser SCRA Review. Active Duty Begin Date =";
				COMMENT2 = EID_BEGIN_DATE;
				COMMENT3 = ACTIVE_DUTY_END_DATE;
			END;
		ELSE IF (ACTIVE_DUTY_ON_ADS_DATE = "N" AND LEFT_ACTIVE_DUTY_LE367_DAYS = "Y") THEN
            DO; 
                COMMENT1 = "Co-Borrower/Endorser SCRA Review. Active Duty Begin Date =";
                COMMENT2 = ACTIVE_DUTY_BEGIN_DATE;
				COMMENT3 = ACTIVE_DUTY_END_DATE;
			END;
	END;
RUN;

DATA R2POP (KEEP=SSN COMMENT);
	SET R2POPALL ;
	FORMAT COMMENT2 COMMENT3 MMDDYY10.;
	COMMENT4 = PUT(COMMENT2,MMDDYY10.);/*transforms to text for output*/
	COMMENT5 = PUT(COMMENT3,MMDDYY10.);/*transforms to text for output*/
	LENGTH COMMENT $ 600;
	BRACKET1 = '[';
	BRACKET2 = ']';
	COMMENT3PREFIX = 'End Date';
	COMMENT = CATX(' ',COMMENT1,BRACKET1,COMMENT4,BRACKET2,COMMENT3PREFIX,BRACKET1,COMMENT5,BRACKET2);
RUN;

/*R3 output setup*/
DATA R3POPALL;
	SET POPULATION;
	LENGTH COMMENT1 $ 200 ;
	IF TYPE = "BORROWER" THEN
	DO;
		IF ACTIVE_DUTY_ON_ADS_DATE = "X" THEN
			DO;
				COMMENT1 = "DOD information: Begin Date";
				COMMENT2 = ACTIVE_DUTY_BEGIN_DATE;
				COMMENT3 = ACTIVE_DUTY_END_DATE;
			END;
		ELSE IF NOTIFIED_OF_ACTIVE_DUTY_RECALL = "Y" THEN
			DO;
				COMMENT1 = "DOD information: Begin Date";
				COMMENT2 = EID_BEGIN_DATE;
				COMMENT3 = ACTIVE_DUTY_END_DATE;
			END;
		ELSE IF (ACTIVE_DUTY_ON_ADS_DATE = "N" AND LEFT_ACTIVE_DUTY_LE367_DAYS = "Y") THEN
            DO; 
                COMMENT1 = "DOD information: Begin Date";
                COMMENT2 = ACTIVE_DUTY_BEGIN_DATE;
				COMMENT3 = ACTIVE_DUTY_END_DATE;
			END;
	END;
	IF TYPE = "ENDORSER" THEN
		DO;
			IF ACTIVE_DUTY_ON_ADS_DATE = "X" THEN
				DO;
					COMMENT1 = "Endorser/Co-Borrower DOD information: Begin Date";
					COMMENT2 = ACTIVE_DUTY_BEGIN_DATE;
					COMMENT3 = ACTIVE_DUTY_END_DATE;
				END;
			ELSE IF NOTIFIED_OF_ACTIVE_DUTY_RECALL = "Y" THEN
				DO;
					COMMENT1 = "Endorser/Co-Borrower DOD information: Begin Date";
					COMMENT2 = EID_BEGIN_DATE;
					COMMENT3 = ACTIVE_DUTY_END_DATE;
				END;
		ELSE IF (ACTIVE_DUTY_ON_ADS_DATE = "N" AND LEFT_ACTIVE_DUTY_LE367_DAYS = "Y") THEN
            DO; 
                COMMENT1 = "Endorser/Co-Borrower DOD information: Begin Date";
                COMMENT2 = ACTIVE_DUTY_BEGIN_DATE;
				COMMENT3 = ACTIVE_DUTY_END_DATE;
			END;
		END;
RUN;

DATA R3POP (KEEP=SSN COMMENT);
	SET R3POPALL ;
	FORMAT COMMENT2 COMMENT3 MMDDYY10.;
	COMMENT4 = PUT(COMMENT2,MMDDYY10.);/*transforms to text for output*/
	COMMENT5 = PUT(COMMENT3,MMDDYY10.);/*transforms to text for output*/
	LENGTH COMMENT $ 200;
	BRACKET1 = '[';
	BRACKET2 = ']';
	COMMENT3PREFIX = 'End Date';
	COMMENT = CATX(' ',COMMENT1,BRACKET1,COMMENT4,BRACKET2,COMMENT3PREFIX,BRACKET1,COMMENT5,BRACKET2);
RUN;

/*export to queue builder (fed) file*/
DATA _NULL_;
	SET WORK.R2POP ;
	FILE REPORT2 DELIMITER=',' DROPOVER LRECL=32767;
/*	IF _N_ = 1 THEN */
/*		DO;*/
/*			PUT 'TARGETID,'*/
/*				'QUEUENAME,' */
/*				'INSTID,'*/
/*				'INSTTYPE,'*/
/*				'DATEDUE,'*/
/*				'TIMEDUE,'*/
/*				'COMMENTTEXT'*/
/*			;*/
/*		END;*/
	DO;
		PUT SSN $ @;
		PUT 'DACTIVED,' @;
		PUT ',' @;
		PUT ',' @;
		PUT ',' @;
		PUT ',' @;
		PUT COMMENT $ ;
		;
	END;
RUN;

DATA _NULL_;
	SET WORK.R3POP ;
	FILE REPORT3 DELIMITER=',' DROPOVER LRECL=32767;
	IF _N_ = 1 THEN 
		DO;
			PUT 'BORROWER_SSN,'
				'COMMENT' 
			;
		END;
	DO;
		PUT SSN $ @;
		PUT COMMENT $ ;
		;
	END;
RUN;
