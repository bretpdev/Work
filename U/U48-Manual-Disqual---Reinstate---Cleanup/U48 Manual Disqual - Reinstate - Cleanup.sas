*-----------------------------------------*
| U48 MANUAL DISQUAL - REINSTATE CLEAN UP |
*-----------------------------------------*;
%LET RPTLIB = C:\WINDOWS\TEMP;
FILENAME REPORT2 "&RPTLIB/U48.CLAEANUP.R2";
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE U48CLNUP AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT A.BF_SSN
	,A.LN_SEQ
	,B.LN_DLQ_MAX
	,B.LD_DLQ_ITL
	,B.LD_DLQ_OCC
	,C.BEG_DT
	,C.END_DT
	,D.LD_BIL_CRT
	,D.LN_SEQ_BIL_WI_DTE
	,D.LD_BIL_DU
	,D.LC_STA_LON80
	,D.LC_STA_BIL10
	,D.LI_BIL_DLQ_OVR_RIR

FROM OLWHRM1.LN10_LON A
INNER JOIN OLWHRM1.LN16_LON_DLQ_HST B
	ON A.BF_SSN = B.BF_SSN
	AND A.LN_SEQ = B.LN_SEQ
INNER JOIN (
		SELECT DF10.BF_SSN AS BF_SSN
			,LN50.LD_DFR_BEG AS BEG_DT
			,LN50.LD_DFR_END AS END_DT
		FROM OLWHRM1.DF10_BR_DFR_REQ DF10
		INNER JOIN OLWHRM1.LN50_BR_DFR_APV LN50
			ON DF10.BF_SSN = LN50.BF_SSN
			AND DF10.LF_DFR_CTL_NUM = LN50.LF_DFR_CTL_NUM
		WHERE LN50.LC_STA_LON50 = 'A'
		AND DF10.LC_STA_DFR10 = 'A'
		AND DF10.LD_DFR_INF_CER < '01/20/2006'
	UNION
		SELECT FB10.BF_SSN AS BF_SSN
			,LN60.LD_FOR_BEG AS BEG_DT
			,LN60.LD_FOR_END AS END_DT
		FROM OLWHRM1.FB10_BR_FOR_REQ FB10
		INNER JOIN OLWHRM1.LN60_BR_FOR_APV LN60
			ON FB10.BF_SSN = LN60.BF_SSN
			AND FB10.LF_FOR_CTL_NUM = LN60.LF_FOR_CTL_NUM
		WHERE LN60.LC_STA_LON60 = 'A'
		AND FB10.LC_STA_FOR10 = 'A'
		AND FB10.LD_FOR_INF_CER < '01/20/2006'
	 ) C
	ON A.BF_SSN = C.BF_SSN
LEFT OUTER JOIN (
	SELECT BL10.BF_SSN
		,LN80.LN_SEQ
		,BL10.LD_BIL_CRT
		,BL10.LN_SEQ_BIL_WI_DTE
		,BL10.LD_BIL_DU
		,LN80.LC_STA_LON80
		,BL10.LC_STA_BIL10
		,LN80.LI_BIL_DLQ_OVR_RIR
	FROM OLWHRM1.BL10_BR_BIL BL10
	INNER JOIN OLWHRM1.LN80_LON_BIL_CRF LN80
		ON BL10.BF_SSN = LN80.BF_SSN
		AND BL10.LD_BIL_CRT = LN80.LD_BIL_CRT
		AND BL10.LN_SEQ_BIL_WI_DTE = LN80.LN_SEQ_BIL_WI_DTE
	WHERE BL10.LC_BIL_TYP = 'P'
	AND LN80.LI_BIL_DLQ_OVR_RIR = 'N'
	 ) D
	ON A.BF_SSN = D.BF_SSN
	AND A.LN_SEQ = D.LN_SEQ

WHERE A.IC_LON_PGM NOT IN (
	'SUBCNS','UNCNS','SUBSPC','UNSPC'
	)
AND A.LF_LON_CUR_OWN = '828476'
AND A.LA_CUR_PRI > 0
AND A.LC_STA_LON10 = 'R'
AND A.LI_RTE_RDC_ELG IN (
	'X','N'
	)
AND A.LC_CUR_RDC_PGM_NME = 'U48'
AND B.LN_DLQ_MAX >= 30
AND B.LD_DLQ_OCC BETWEEN C.BEG_DT AND C.END_DT
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
ENDRSUBMIT;

DATA U48CLNUP;
SET WORKLOCL.U48CLNUP;
RUN;

PROC SORT DATA=U48CLNUP;BY BF_SSN LN_SEQ;RUN;

PROC SQL;
CREATE TABLE U48CLNUP2 AS 
SELECT DISTINCT A.BF_SSN
	,A.LN_SEQ
	,A.LD_BIL_DU
FROM U48CLNUP A
WHERE MONTH(A.LD_DLQ_OCC) = MONTH(A.LD_BIL_DU)
AND YEAR(A.LD_DLQ_OCC) = YEAR(A.LD_BIL_DU)
AND A.LD_DLQ_OCC = (
	SELECT MIN(LD_DLQ_OCC)
	FROM U48CLNUP X
	WHERE X.BF_SSN = A.BF_SSN
	AND X.LN_SEQ = X.LN_SEQ
	)
;
QUIT;

DATA _NULL_;
SET  WORK.U48CLNUP2;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
   FORMAT BF_SSN $9. ;
   FORMAT LN_SEQ 6. ;
   FORMAT LD_BIL_DU MMDDYY10. ;
IF _N_ = 1 THEN     
DO;
   PUT
   'BF_SSN'
   ','
   'LN_SEQ'
   ','
   'LD_BIL_DU_LON'
   ;
 END;
 DO;
   PUT BF_SSN $ @;
   PUT LN_SEQ @;
   PUT LD_BIL_DU ;
 END;
RUN;
