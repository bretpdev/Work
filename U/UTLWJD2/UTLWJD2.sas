/*JUDICIAL GARNISHMENT WILL EXPIRE
This report lists legal borrowers with a current employer who are currently
being garnished judicially where the garnishment is going to expire.
Collections uses this report to renew judicial garnishments since the expire after 120 days.*/
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWJD2.LWJD2R2";
FILENAME REPORT3 "&RPTLIB/ULWJD2.LWJD2R3";
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE RNEWGARN AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT
	A.DF_SPE_ACC_ID,
	A.DF_PRS_ID											AS SSN,
	RTRIM(A.DM_PRS_1)									AS FIRST,
	RTRIM(A.DM_PRS_LST)									AS LAST,
	RTRIM(A.DX_STR_ADR_1)||' '||RTRIM(A.DX_STR_ADR_2)	AS ADDRESS,
	RTRIM(A.DM_CT)										AS CITY,
	RTRIM(A.DC_DOM_ST)									AS ST,
	RTRIM(A.DF_ZIP)										AS ZIP,
	A.BF_EMP_ID_1										AS EMP_ID,
	B.IM_IST_FUL										AS EMP_NAME,
	RTRIM(B.IX_GEN_STR_ADR_1)||' '||RTRIM(B.IX_GEN_STR_ADR_2)||' '||RTRIM(B.IX_GEN_STR_ADR_3)	AS EMP_ADD,
	RTRIM(B.IM_GEN_CT)									AS EMP_CITY,
	B.IC_GEN_ST											AS EMP_ST,
	RTRIM(B.IF_GEN_ZIP)									AS EMP_ZIP,
	SUBSTR(B.IF_GEN_ZIP,1,5)							AS ZIP5,
	B.IN_GEN_PHN										AS EMP_PHONE,
	C.BF_LEG_ACT_DKT									AS DOCKNO,
	F.BF_LEG_ACT_ATY_DKT								AS GARN_INFO,
	F.BD_LEG_ACT_ATY_FIL								AS FILED,
/*<5>DAYS(F.BD_LEG_ACT_ATY_FIL) + 120 - DAYS(CURRENT DATE)			AS DAYS,/*<5>*/
	SUM(E.LA_CLM_BAL)									AS BAL,
	G.BX_CMT											AS JUDG/*<5>*/,
	SUBSTR(I.BX_CMT,1,8) 								AS SERVD,
	RTRIM(SUBSTR(I.BX_CMT,9,8))							AS EMPSRVD,
	SUBSTR(I.BX_CMT,17,2) 								AS WOG/*</5>*/
FROM 	OLWHRM1.PD01_PDM_INF A INNER JOIN
		OLWHRM1.IN01_LGS_IDM_MST B ON
			A.BF_EMP_ID_1 = B.IF_IST AND
			A.BI_EMP_INF_OVR = 'Y' INNER JOIN
		OLWHRM1.LA10_LEG_ACT C ON
			A.DF_PRS_ID = C.DF_PRS_ID_BR AND
			C.BC_WDR_REA = '' AND
			C.BC_INA_REA = '' AND /*<5>*/
			(C.bd_hld < current date OR
			 C.bd_hld IS NULL) AND /*</5>*/
			C.BC_LEG_ACT_REC_TYP = '2' INNER JOIN
		OLWHRM1.DC01_LON_CLM_INF D ON
			A.DF_PRS_ID = D.BF_SSN AND 
			D.LC_GRN = '07' INNER JOIN
		OLWHRM1.DC02_BAL_INT E ON
			D.AF_APL_ID = E.AF_APL_ID AND
			D.AF_APL_ID_SFX = E.AF_APL_ID_SFX AND
			E.LA_CLM_BAL > 100 INNER JOIN
		OLWHRM1.LA11_LEG_ACT_ATY F ON
			A.DF_PRS_ID = F.DF_PRS_ID_BR AND
			C.BF_CRT_DTS_LA10 = F.BF_CRT_DTS_LA10 AND
			F.BC_EXE_TYP = '04' AND
			DAYS(F.BD_LEG_ACT_ATY_FIL) < DAYS(CURRENT DATE)-90 LEFT OUTER JOIN
		OLWHRM1.AY01_BR_ATY G ON
			A.DF_PRS_ID = G.DF_PRS_ID AND
			G.PF_ACT = 'DJGNM' /*<5>*/ INNER JOIN
		OLWHRM1.BR01_BR_CRF H ON
			A.DF_PRS_ID = H.BF_SSN AND
			(H.BD_HLD IS NULL OR DAYS(H.BD_HLD) < DAYS(CURRENT DATE)) LEFT OUTER JOIN
		OLWHRM1.AY01_BR_ATY I ON
			A.DF_PRS_ID = I.DF_PRS_ID AND
			I.PF_ACT = 'LRTRN'/*</5>*/

WHERE	C.BF_CRT_DTS_LA10 = (SELECT MIN(X.BF_CRT_DTS_LA10)
							 FROM OLWHRM1.LA10_LEG_ACT X
							 WHERE	A.DF_PRS_ID = X.DF_PRS_ID_BR AND
									X.BC_WDR_REA = '' AND
									X.BC_INA_REA = '' AND
									X.BC_LEG_ACT_REC_TYP = '2'
							 GROUP BY X.DF_PRS_ID_BR) /*<5>*/
AND (G.bd_aty_prf = 
		(SELECT MAX(Y.bd_aty_prf)
		FROM OLWHRM1.AY01_BR_ATY Y
		WHERE   A.DF_PRS_ID = Y.DF_PRS_ID AND
				Y.PF_ACT = 'DJGNM'
		GROUP BY Y.DF_PRS_ID
		) 
	OR NOT EXISTS 
		(SELECT *
		FROM OLWHRM1.AY01_BR_ATY Y
		WHERE A.DF_PRS_ID = Y.DF_PRS_ID
		AND Y.PF_ACT = 'DJGNM'
		)
	)	
AND (I.bd_aty_prf = 
		(SELECT MAX(Y.bd_aty_prf)
		FROM OLWHRM1.AY01_BR_ATY Y
		WHERE   A.DF_PRS_ID = Y.DF_PRS_ID AND
				Y.PF_ACT = 'LRTRN'
		GROUP BY Y.DF_PRS_ID
		) 
	OR NOT EXISTS 
		(SELECT *
		FROM OLWHRM1.AY01_BR_ATY Y
		WHERE A.DF_PRS_ID = Y.DF_PRS_ID
		AND Y.PF_ACT = 'DJGNM'
		) /*</5>*/
	)	
GROUP BY	A.DF_SPE_ACC_ID, A.DF_PRS_ID, RTRIM(A.DM_PRS_1),	RTRIM(A.DM_PRS_LST),
			RTRIM(A.DX_STR_ADR_1)||' '||RTRIM(A.DX_STR_ADR_2),
			RTRIM(A.DM_CT), RTRIM(A.DC_DOM_ST), RTRIM(A.DF_ZIP), A.BF_EMP_ID_1, B.IM_IST_FUL,
			RTRIM(B.IX_GEN_STR_ADR_1)||' '||RTRIM(B.IX_GEN_STR_ADR_2)||' '||RTRIM(B.IX_GEN_STR_ADR_3),
			RTRIM(B.IM_GEN_CT), B.IC_GEN_ST, RTRIM(B.IF_GEN_ZIP), SUBSTR(B.IF_GEN_ZIP,1,5),
			B.IN_GEN_PHN, C.BF_LEG_ACT_DKT,	F.BF_LEG_ACT_ATY_DKT, F.BD_LEG_ACT_ATY_FIL, G.BX_CMT,
			DAYS(F.BD_LEG_ACT_ATY_FIL) + 120 - DAYS(CURRENT DATE), SUBSTR(I.BX_CMT,1,8),
			RTRIM(SUBSTR(I.BX_CMT,9,8)), SUBSTR(I.BX_CMT,17,2) 	
ORDER BY A.DF_PRS_ID
);

DISCONNECT FROM DB2;
ENDRSUBMIT;
/*<5>*/
DATA RNEWGARN;
SET WORKLOCL.RNEWGARN;
RUN;
data RNEWGARN;
set RNEWGARN;
IF EMP_ID = EMPSRVD THEN DO;
	SERVED = input(SERVD, MMDDYY10.);
	WOG = WOG + 1;
	END;
ELSE DO;
	SERVED = FILED;
	WOG = 1;
	END;
run;

data RNEWGARN;
set RNEWGARN;
where SERVED < TODAY()-90 OR (SERVED = . AND FILED < TODAY()-90);
IF WOG = . THEN WOG = 1;
DAYS = SERVED + 120 - TODAY();
run;

PROC SORT DATA=RNEWGARN;
BY SERVED;
RUN;
/*<5>*/
PROC PRINTTO PRINT=REPORT2 NEW;
RUN;
OPTIONS CENTER PAGENO=1 LS=132;
PROC PRINT SPLIT='/' DATA=RNEWGARN WIDTH=MIN;
WHERE	ZIP5 IN (
	'84017', '84020', '84024', '84033', '84036', '84044', '84047', '84055',
	'84060', '84061', '84065', '84070', '84084', '84088', '84092', '84093',
	'84094', '84095', '84098', '84101', '84102', '84103', '84104', '84105',
	'84106', '84107', '84108', '84109', '84111', '84112', '84113', '84114', 
	'84115', '84116', '84117', '84118', '84119', '84120', '84121', '84123', 
	'84124', '84125', '84128', '84133', '84157', '84006', '84090', '84091',
	'84110', '84122', '84126', '84127', '84130', '84131', '84132', '84141',
	'84142', '84143', '84144', '84145', '84147', '84148', '84150', '84134',
	'84135', '84136', '84139', '84140', '84151', '84152', '84153', '84158',
	'84165', '84170', '84171', '84180', '84184', '84189', '84190', '84193',
	'84194', '84195', '84199'
); /*<2>*//*<3>*//*<4>*/
VAR /*GARN_INFO<5>*/
	WOG
	SERVED
	FILED
	DAYS
	DF_SPE_ACC_ID
	FIRST
	LAST
	ADDRESS
	CITY
	ST
	ZIP
	EMP_ID
	EMP_NAME
	EMP_ADD
	EMP_CITY
	EMP_ST
	EMP_ZIP
	EMP_PHONE
	DOCKNO
	JUDG
	BAL;
LABEL DF_SPE_ACC_ID = 'ACCT #';
FORMAT FILED MMDDYY10.;
FORMAT SERVED MMDDYY10.;
TITLE1 'JUDICIAL GARNISHMENT';
TITLE2 'CURRENT GARNISHMENT WILL EXPIRE';
TITLE3 'SERVE BY CONSTABLE';
FOOTNOTE 'JOB = UTLWJD2     REPORT = ULWJD2.LWJD2R2';
RUN;
PROC PRINTTO;
RUN;

PROC PRINTTO PRINT=REPORT3 NEW;
RUN;
OPTIONS CENTER PAGENO=1 LS=132;
PROC PRINT SPLIT='/' DATA=RNEWGARN WIDTH=MIN;
WHERE ZIP5 NOT IN (
	'84017', '84020', '84024', '84033', '84036', '84044', '84047', '84055',
	'84060', '84061', '84065', '84070', '84084', '84088', '84092', '84093',
	'84094', '84095', '84098', '84101', '84102', '84103', '84104', '84105',
	'84106', '84107', '84108', '84109', '84111', '84112', '84113', '84114', 
	'84115', '84116', '84117', '84118', '84119', '84120', '84121', '84123', 
	'84124', '84125', '84128', '84133', '84157', '84006', '84090', '84091',
	'84110', '84122', '84126', '84127', '84130', '84131', '84132', '84141',
	'84142', '84143', '84144', '84145', '84147', '84148', '84150', '84134',
	'84135', '84136', '84139', '84140', '84151', '84152', '84153', '84158', 
	'84165', '84170', '84171', '84180', '84184', '84189', '84190', '84193', 
	'84194', '84195','84199'
); /*<2>*//*<3>*//*<4>*/
VAR /*GARN_INFO<5>*/
	WOG
	SERVED
	FILED
	DAYS
	DF_SPE_ACC_ID
	FIRST
	LAST
	ADDRESS
	CITY
	ST
	ZIP
	EMP_ID
	EMP_NAME
	EMP_ADD
	EMP_CITY
	EMP_ST
	EMP_ZIP
	EMP_PHONE
	DOCKNO
	JUDG
	BAL;
LABEL DF_SPE_ACC_ID = 'ACCT #';
FORMAT FILED MMDDYY10.;
FORMAT SERVED MMDDYY10.;
TITLE1 'JUDICIAL GARNISHMENT';
TITLE2 'CURRENT GARNISHMENT WILL EXPIRE';
TITLE3 'SERVE BY SHERIFF';
FOOTNOTE 'JOB = UTLWJD2     REPORT = ULWJD2.LWJD2R3';
RUN;
PROC PRINTTO;
RUN;

/*<1> sr 91, jd, 5/29/02
  <2> sr107, jd, 6/25/02, added 84125 and 84157
  <3> sr139, jd, 8/1/02, added 84133
  <4> sr179, mc, 10/29/02, added several
  <5> sr213, jd, 01/15/03*/
