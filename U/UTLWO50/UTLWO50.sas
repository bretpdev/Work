*-----------------------------------------------------*
| UTLWO50 NOTIFICATION OF DISCHARGE/DISMISSAL OF BKCY |
*-----------------------------------------------------*;
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWO50.LWO50R2";
FILENAME REPORTZ "&RPTLIB/ULWO50.LWO50RZ";

LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;

%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE NODDOBK AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.BF_SSN
	,A.LN_SEQ
	,B.DC_BKR_STA
	,B.DD_BKR_STA
	,B.DD_BKR_FIL
	,D.WC_DW_LON_STA
	,LN40.LD_SBM_CLM_PCL
FROM OLWHRM1.LN10_LON A
INNER JOIN OLWHRM1.PD24_PRS_BKR B
	ON A.BF_SSN = B.DF_PRS_ID
INNER JOIN OLWHRM1.CL10_CLM_PCL C
	ON B.DF_PRS_ID = C.BF_SSN
INNER JOIN OLWHRM1.DW01_DW_CLC_CLU D
	ON C.BF_SSN = D.BF_SSN
INNER JOIN (
	SELECT BF_SSN
		,LN_SEQ
		,MAX(LD_SBM_CLM_PCL) AS LD_SBM_CLM_PCL
	FROM OLWHRM1.LN40_LON_CLM_PCL
	GROUP BY BF_SSN
		,LN_SEQ
	 ) LN40
	ON A.BF_SSN = LN40.BF_SSN
	AND A.LN_SEQ = LN40.LN_SEQ
WHERE A.LA_CUR_PRI > 0
AND A.LC_STA_LON10 = 'R'
AND D.WC_DW_LON_STA IN ('07','08')
AND C.LC_REA_CLM_PCL = '03'
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWO50.LWO50RZ);*/
/*QUIT;*/
ENDRSUBMIT;

DATA NODDOBK;
SET WORKLOCL.NODDOBK;
RUN;

PROC SORT DATA=NODDOBK;
BY BF_SSN LN_SEQ DD_BKR_STA;
RUN;

DATA NODDOBK;
SET NODDOBK;
BY BF_SSN LN_SEQ DD_BKR_STA;
IF DC_BKR_STA = '05' AND DD_BKR_STA > LD_SBM_CLM_PCL AND LAST.LN_SEQ THEN OUTPUT;
ELSE DELETE;
RUN;

%MACRO DATE_2_CHAR(DS,CDATE,DAYPART);
DATA &DS;
SET &DS;
LENGTH &DAYPART $ 10. ;
IF &CDATE = . THEN DO;
	&DAYPART = '';
	END;
ELSE IF DAY(&CDATE) < 10 AND MONTH(&CDATE) < 10 THEN DO;
	&DAYPART = '0'||TRIM(LEFT(MONTH(&CDATE)))||'/'||'0'||TRIM(LEFT(DAY(&CDATE)))||'/'||TRIM(LEFT(YEAR(&CDATE)));
	END;
ELSE IF DAY(&CDATE) < 10 AND MONTH(&CDATE) >= 10 THEN DO;
	&DAYPART = TRIM(LEFT(MONTH(&CDATE)))||'/'||'0'||TRIM(LEFT(DAY(&CDATE)))||'/'||TRIM(LEFT(YEAR(&CDATE)));
	END;
ELSE IF DAY(&CDATE) >= 10 AND MONTH(&CDATE) < 10 THEN DO;
	&DAYPART ='0'||TRIM(LEFT(MONTH(&CDATE)))||'/'||TRIM(LEFT(DAY(&CDATE)))||'/'||TRIM(LEFT(YEAR(&CDATE)));
	END;
ELSE DO;
	&DAYPART = TRIM(LEFT(MONTH(&CDATE)))||'/'||TRIM(LEFT(DAY(&CDATE)))||'/'||TRIM(LEFT(YEAR(&CDATE)));
	END;
RUN;
%MEND DATE_2_CHAR;
%DATE_2_CHAR(NODDOBK,DD_BKR_STA,CHAR_DD_BKR_STA);

/*VARIABLE INITALIZATION*/
DATA NODDOBK;
SET NODDOBK;
LENGTH COMMENT $ 600.;
TARGET_ID = BF_SSN;
ARC_NAME = 'RCBKY';
FROM_DATE = '';
TO_DATE = '';
NEEDED_BY_DATE = '';
RECIPIENT = '';
REGARDS_TO_CODE = '';
REGARDS_TO_ID = '';
COMMENTS = 'BANKRUPTCY DISCHARGE/DISMISSAL RECEIVED.  CLAIM SUBMITTED NOT PAID. BANKRUPTCY RECORD: '
	||LEFT(TRIM(DC_BKR_STA))||','||'LOAN STATUS:  '||LEFT(TRIM(WC_DW_LON_STA))||','
	||'BANKRUPTCY STATUS DATE '||LEFT(TRIM(CHAR_DD_BKR_STA))||' - RECALL CLAIM.';
RUN;

DATA _NULL_;
SET  WORK.NODDOBK;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
   FORMAT LN_SEQ 6. ;
   FORMAT TARGET_ID $9. ;
   FORMAT ARC_NAME $5. ;
   FORMAT FROM_DATE $1. ;
   FORMAT TO_DATE $1. ;
   FORMAT NEEDED_BY_DATE $1. ;
   FORMAT RECIPIENT $1. ;
   FORMAT REGARDS_TO_CODE $1. ;
   FORMAT REGARDS_TO_ID $1. ;
   FORMAT COMMENTS $600. ;
DO;
   PUT TARGET_ID $ @;
   PUT ARC_NAME $ @;
   PUT FROM_DATE $ @;
   PUT TO_DATE $ @;
   PUT NEEDED_BY_DATE $ @;
   PUT RECIPIENT $ @;
   PUT REGARDS_TO_CODE $ @;
   PUT REGARDS_TO_ID $ @;
   PUT LN_SEQ @;
   PUT COMMENTS $ ;
   ;
END;
RUN;
