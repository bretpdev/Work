*-----------------------------------------------------------*
| UTLWG90 - OPEN GRTCR WITH FUNDS RECEIVED THE PREVIOUS DAY |
*-----------------------------------------------------------*;
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWG90.LWG90R2";
FILENAME REPORTZ "&RPTLIB/ULWG90.LWG90RZ";

DATA _NULL_;
    CALL SYMPUT('PREVDY',"'"||PUT(INTNX('DAY',TODAY(),-1,'BEGINNING'), MMDDYYD10.)||"'");
	CALL SYMPUT('RUNDATE',PUT(INTNX('DAY',TODAY(),0,'beginning'), MMDDYY10.));
	CALL SYMPUT('RUNTIME',PUT(TIME(), TIME.));
RUN;

%SYSLPUT PREVDY = &PREVDY;
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE OGWFRTPD AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.DF_PRS_ID
/*	,B.LN_FAT_SEQ*/
	,B.PC_FAT_TYP||B.PC_FAT_SUB_TYP AS TRX  
	,ABS(COALESCE(B.LA_FAT_PCL_FEE,0))  +
	 ABS(COALESCE(LA_FAT_NSI,0))     + 	 
	 ABS(COALESCE(LA_FAT_LTE_FEE,0)) + 
	 ABS(COALESCE(LA_FAT_ILG_PRI,0)) +
	 ABS(COALESCE(LA_FAT_CUR_PRI,0)) AS AMT_RCVD
	,C.DM_PRS_LST
/*	,B.LC_FAT_REV_REA*/
/*	,B.LC_STA_LON90*/
FROM OLWHRM1.AY01_BR_ATY A
INNER JOIN OLWHRM1.LN90_FIN_ATY B
	ON A.DF_PRS_ID = B.BF_SSN
INNER JOIN OLWHRM1.PD01_PDM_INF C
	ON A.DF_PRS_ID = C.DF_PRS_ID
WHERE A.PF_ACT = 'GRTCR'
AND A.BD_ATY_CLO IS NULL
AND B.PC_FAT_TYP = '10'
AND B.PC_FAT_SUB_TYP IN ('40','45')
AND B.LD_FAT_PST = &PREVDY
ORDER BY DF_PRS_ID
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWG90.LWG90RZ);*/
/*QUIT;*/
ENDRSUBMIT;

DATA OGWFRTPD;
SET WORKLOCL.OGWFRTPD;
RUN;

PROC PRINTTO PRINT=REPORT2 NEW;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 PAGENO=1 CENTER;
TITLE 'OPEN GRTCR WITH FUNDS RECEIVED THE PREVIOUS DAY';
TITLE2	"&RUNDATE - &RUNTIME";
FOOTNOTE1 "This document may contain borrowers' sensitive information that UHEAA has pledged to protect.";
FOOTNOTE2 "Please take appropriate precautions to safeguard this information.";
FOOTNOTE3 ;
FOOTNOTE4  'JOB = UTLWG90  	 REPORT = ULWG90.LWG90R2';
PROC CONTENTS DATA=OGWFRTPD OUT=EMPTYSET NOPRINT;
DATA _NULL_;
SET EMPTYSET;
FILE PRINT;
IF  NOBS=0 AND _N_ =1 THEN DO;
	PUT // 127*'-';
	PUT      ////
		@51 '**** NO OBSERVATIONS FOUND ****';
	PUT //////
		@57 '-- END OF REPORT --';
	PUT ///////////
		@46 "JOB = UTLWG90  	 REPORT = ULWG90.LWG90R2";
	END;
RETURN;
RUN;
PROC PRINT NOOBS SPLIT='/' DATA=OGWFRTPD WIDTH=UNIFORM WIDTH=MIN;
FORMAT AMT_RCVD DOLLAR10.2;
VAR DF_PRS_ID DM_PRS_LST AMT_RCVD;
LABEL DF_PRS_ID = 'SSN' DM_PRS_LST = 'LAST NAME' AMT_RCVD = 'AMOUNT RECEIVED';
RUN;
PROC PRINTTO;
RUN;
