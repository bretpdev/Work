/*-----------------------------------------*
| UTLWU29 QC - Reduced Payment Forbearance |
*-----------------------------------------*/

/********************  R2 DATA SET *****************************
			Payment less than interest report
***************************************************************/

DECLARE @TODAY DATE = GETDATE()

;WITH QCRPF AS --Quality Control Reduced Payment Forbearance
(--base population
	SELECT DISTINCT 
		 LN10.BF_SSN
		,LN10.LN_SEQ
		,LN60.LF_FOR_CTL_NUM
		,LN60.LN_FOR_OCC_SEQ
		,LN10.LA_CUR_PRI
		,LN10.IC_LON_PGM
		,DW01.WC_DW_LON_STA
		,LN72.LR_ITR
		,PD10.DF_SPE_ACC_ID
		,CAST(LN60.LD_FOR_BEG AS DATE) AS LD_FOR_BEG
		,CAST(LN60.LD_FOR_END AS DATE) AS LD_FOR_END
		,CAST(LN60.LD_STA_LON60 AS DATE) AS LD_STA_LON60
		,COALESCE(LN60.LA_ACL_RDC_PAY,0) AS LA_ACL_RDC_PAY
		,LN16.LD_DLQ_OCC
		,(LN16.LN_DLQ_MAX + 1) AS DAYS_DELQ
		,LN83.BN_EFT_SEQ
	FROM 
		UDW..LN10_LON LN10
		INNER JOIN UDW..LN60_BR_FOR_APV LN60
			ON LN10.BF_SSN = LN60.BF_SSN
			AND LN10.LN_SEQ = LN60.LN_SEQ
		INNER JOIN UDW..DW01_DW_CLC_CLU DW01
			ON LN10.BF_SSN = DW01.BF_SSN
			AND LN10.LN_SEQ = DW01.LN_SEQ
		INNER JOIN UDW..FB10_BR_FOR_REQ FB10
			ON LN60.BF_SSN = FB10.BF_SSN
			AND LN60.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM
		INNER JOIN UDW..PD10_PRS_NME PD10
			ON LN10.BF_SSN = PD10.DF_PRS_ID
		LEFT JOIN UDW..LN72_INT_RTE_HST LN72
			ON LN10.BF_SSN = LN72.BF_SSN
			AND LN10.LN_SEQ = LN72.LN_SEQ
			AND LN72.LC_STA_LON72 = 'A'
			AND LN60.LD_STA_LON60 >= LN72.LD_ITR_EFF_BEG
			AND LN60.LD_STA_LON60 <= LN72.LD_ITR_EFF_END
		LEFT JOIN UDW..LN16_LON_DLQ_HST LN16
			ON LN10.BF_SSN = LN16.BF_SSN
			AND LN10.LN_SEQ = LN16.LN_SEQ
			AND LN16.LC_DLQ_TYP = 'I'
			AND LN16.LC_STA_LON16 = '1'
		LEFT JOIN UDW..LN83_EFT_TO_LON LN83
			ON LN10.BF_SSN = LN83.BF_SSN
			AND LN10.LN_SEQ = LN83.LN_SEQ
			AND LN83.LC_STA_LN83 = 'A'
			AND LN83.LC_EFT_SUS_REA = ''
			AND LN83.LD_EFT_EFF_END IS NULL
			AND @TODAY >= CAST(LN83.LD_EFT_EFF_BEG AS DATE)
	WHERE 
		FB10.LC_FOR_TYP = '31'
		AND FB10.LC_STA_FOR10 = 'A'
		AND FB10.LC_FOR_STA = 'A'
		AND LN60.LC_STA_LON60 = 'A'
		AND LN60.LC_FOR_RSP != '003'
		AND LN10.LA_CUR_PRI > 0.00
		AND LN10.LC_STA_LON10 = 'R'
		AND @TODAY BETWEEN LN60.LD_FOR_BEG AND LN60.LD_FOR_END
)
,R2_SUMS AS
(--totals for R2
	SELECT
		 BF_SSN
		,DF_SPE_ACC_ID
		,LN_SEQ
		,LD_FOR_BEG
		,LD_FOR_END
		,LD_STA_LON60
		,COALESCE (LA_ACL_RDC_PAY,0) AS  LA_ACL_RDC_PAY
		,SUM(LA_CUR_PRI) OVER(PARTITION BY BF_SSN, LF_FOR_CTL_NUM, LN_FOR_OCC_SEQ) AS RTOT
		,CAST
		(
			CASE
				WHEN SUM(LA_CUR_PRI) > 0 
				THEN SUM(CAST(CAST
				(
					(
						CASE
							WHEN WC_DW_LON_STA IN ('01', '02', '04') 
								AND IC_LON_PGM IN ('SUBSPC', 'DSCON', 'DSS', 'SUBCNS', 'STFFRD') 
							THEN 0
							ELSE LA_CUR_PRI 
						END
					) * COALESCE (LR_ITR, 0) / 365 AS INTEGER
				) AS NUMERIC(8, 2)) / 100) * 31  
				ELSE 0
			END AS NUMERIC(8, 2)
		) AS XTOT
	FROM
		QCRPF
	GROUP BY
		BF_SSN,
		DF_SPE_ACC_ID,
		LN_SEQ,
		LD_FOR_BEG,
		LD_FOR_END,
		LD_STA_LON60,
		LA_ACL_RDC_PAY,
		LF_FOR_CTL_NUM,
		LN_FOR_OCC_SEQ,
		LA_CUR_PRI		
)
SELECT
	 DF_SPE_ACC_ID AS 'ACCOUNT NUMBER'
	,LD_FOR_BEG AS 'FORB BEGIN DATE' 
	,LD_FOR_END AS 'FORB END DATE' 
	,LD_STA_LON60 AS 'FORB APPROVED DATE' 
	,SUM(LA_ACL_RDC_PAY) AS 'PAYMENT AMOUNT' 
	,SUM(XTOT) + 5 AS 'CALCULATED PAYMENT AMOUNT'
FROM
	R2_SUMS
GROUP BY
	DF_SPE_ACC_ID 
	,LD_FOR_BEG 
	,LD_FOR_END
	,LD_STA_LON60 
HAVING
	SUM(LA_ACL_RDC_PAY) < SUM(XTOT) + 5
ORDER BY
	DF_SPE_ACC_ID
;

/********************  R3 DATA SET *****************************
		Reduced Payment Fobearance and delinquency 25 days+
***************************************************************/

DECLARE @TODAY DATE = GETDATE()

;WITH QCRPF AS --Quality Control Reduced Payment Forbearance
(--base population
	SELECT DISTINCT 
		 LN10.BF_SSN
		,LN10.LN_SEQ
		,LN60.LF_FOR_CTL_NUM
		,LN60.LN_FOR_OCC_SEQ
		,LN10.LA_CUR_PRI
		,LN72.LR_ITR
		,PD10.DF_SPE_ACC_ID
		,CAST(LN60.LD_FOR_BEG AS DATE) AS LD_FOR_BEG
		,CAST(LN60.LD_FOR_END AS DATE) AS LD_FOR_END
		,CAST(LN60.LD_STA_LON60 AS DATE) AS LD_STA_LON60
		,COALESCE(LN60.LA_ACL_RDC_PAY,0) AS LA_ACL_RDC_PAY
		,LN16.LD_DLQ_OCC
		,LN16.LN_DLQ_MAX AS DAYS_DELQ
	FROM 
		UDW..LN10_LON LN10
		INNER JOIN UDW..LN60_BR_FOR_APV LN60
			ON LN10.BF_SSN = LN60.BF_SSN
			AND LN10.LN_SEQ = LN60.LN_SEQ
		INNER JOIN UDW..FB10_BR_FOR_REQ FB10
			ON LN60.BF_SSN = FB10.BF_SSN
			AND LN60.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM
		INNER JOIN UDW..PD10_PRS_NME PD10
			ON LN10.BF_SSN = PD10.DF_PRS_ID
		LEFT JOIN UDW..LN72_INT_RTE_HST LN72
			ON LN10.BF_SSN = LN72.BF_SSN
			AND LN10.LN_SEQ = LN72.LN_SEQ
			AND LN72.LC_STA_LON72 = 'A'
			AND LN60.LD_STA_LON60 >= LN72.LD_ITR_EFF_BEG
			AND LN60.LD_STA_LON60 <= LN72.LD_ITR_EFF_END
		LEFT JOIN UDW..LN16_LON_DLQ_HST LN16
			ON LN10.BF_SSN = LN16.BF_SSN
			AND LN10.LN_SEQ = LN16.LN_SEQ
			AND LN16.LC_STA_LON16 = '1'
	WHERE 
		FB10.LC_FOR_TYP = '31'
		AND FB10.LC_STA_FOR10 = 'A'
		AND FB10.LC_FOR_STA = 'A'
		AND LN60.LC_STA_LON60 = 'A'
		AND LN60.LC_FOR_RSP != '003'
		AND LN10.LA_CUR_PRI > 0.00
		AND LN10.LC_STA_LON10 = 'R'
		AND @TODAY BETWEEN LN60.LD_FOR_BEG AND LN60.LD_FOR_END
)
SELECT DISTINCT
	 DF_SPE_ACC_ID AS 'ACCOUNT NUMBER'
	,LD_FOR_BEG AS 'FORB BEGIN DATE' 
	,LD_FOR_END AS 'FORB END DATE' 
	,LD_STA_LON60 AS 'FORB APPROVED DATE'
	,LD_DLQ_OCC AS 'DELINQUENCY DATE'
	,DAYS_DELQ AS '# DAYS DELINQUENT'
FROM
	QCRPF
WHERE
	DAYS_DELQ IS NOT NULL
	AND DAYS_DELQ > 25
ORDER BY
	 DAYS_DELQ 
	,DF_SPE_ACC_ID 
	,LD_FOR_BEG 
	,LD_FOR_END 
	,LD_STA_LON60 
	,LD_DLQ_OCC
;
