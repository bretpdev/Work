DATA _NULL_;
/*for previous month use -1, for current use 0, etc*/
RUN_MON = -1;
	CALL SYMPUT('BEGIN',"'" || PUT(INTNX('MONTH',TODAY(),RUN_MON,'B'),MMDDYY10.)|| "'");
	CALL SYMPUT('FINISH',"'" || PUT(INTNX('MONTH',TODAY(),RUN_MON,'E'),MMDDYY10.)|| "'");
RUN;

/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORTZ "&RPTLIB/UNWC05.NWC05RZ";
FILENAME REPORT2 "&RPTLIB/UNWC05.NWC05R2";
FILENAME REPORT3 "&RPTLIB/UNWC05.NWC05R3";

%SYSLPUT BEGIN = &BEGIN;
%SYSLPUT FINISH = &FINISH;
LIBNAME  LEGEND  REMOTE  SERVER=LEGEND SLIBREF=WORK  ;
RSUBMIT;
/*%let DB = DNFPRQUT;  *This is test;*/
%let DB = DNFPUTDL;  *This is live;

PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE DEMO AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT CASE
		WHEN DW01.WC_DW_LON_STA = '03' and (LN16.ln_dlq_max < 31 or LN16.bf_ssn is null)  THEN 'Current Repay'
		WHEN DW01.WC_DW_LON_STA = '05' then 'Forbearance'
		WHEN DW01.WC_DW_LON_STA = '04' then 'Deferment'
		WHEN DW01.WC_DW_LON_STA in ('01','02','16','17','18','19','20','21') then 'Suspense'
		WHEN LN16.LN_DLQ_MAX >=31 THEN 'Delinquent'
		ELSE 'Other'
	END AS STATUS 
	,COUNT(*) AS LON_CT
	,COUNT(DISTINCT LN10.BF_SSN) AS BOR_CT
	,SUM(LN10.LA_CUR_PRI) AS PBO 
	,SUM(DW01.WA_TOT_BRI_OTS) AS IRB 
	,SUM(LN10.LA_CUR_PRI + DW01.WA_TOT_BRI_OTS) AS TOT 
	,CASE
		WHEN LN10.IC_LON_PGM IN ('DL%%%','TEACH','FISL') THEN '3'
		ELSE '2'
	END AS RNUM
FROM PKUB.LN10_LON LN10
LEFT OUTER JOIN PKUB.DW01_DW_CLC_CLU DW01
	ON LN10.BF_SSN = DW01.BF_SSN
	AND LN10.LN_SEQ = DW01.LN_SEQ
LEFT OUTER JOIN (select bf_ssn
					,ln_seq
					,max(ln_dlq_max) as ln_dlq_max
				from PKUB.LN16_LON_DLQ_HST 
				where lc_sta_lon16 = '1'
				group by bf_ssn, ln_seq) LN16
	ON LN10.BF_SSN = LN16.BF_SSN
	AND LN10.LN_SEQ = LN16.LN_SEQ
LEFT OUTER JOIN PKUB.LN09_RPD_PIO_CVN LN09
	ON LN10.BF_SSN = LN09.BF_SSN
	AND LN10.LN_SEQ = LN09.LN_SEQ
WHERE LN10.LA_CUR_PRI + DW01.WA_TOT_BRI_OTS > 0
	AND LN09.LD_LON_RHB_PCV is not null
GROUP BY CASE
		WHEN LN10.IC_LON_PGM IN ('DL%%%','TEACH','FISL') THEN '3'
		ELSE '2'
	END
	,CASE
		WHEN DW01.WC_DW_LON_STA = '03' and (LN16.ln_dlq_max < 31 or LN16.bf_ssn is null)  THEN 'Current Repay'
		WHEN DW01.WC_DW_LON_STA = '05' then 'Forbearance'
		WHEN DW01.WC_DW_LON_STA = '04' then 'Deferment'
		WHEN DW01.WC_DW_LON_STA in ('01','02','16','17','18','19','20','21') then 'Suspense'
		WHEN LN16.LN_DLQ_MAX >=31 THEN 'Delinquent'
		ELSE 'Other'
	END);
DISCONNECT FROM DB2;
QUIT;

ENDRSUBMIT;
DATA DEMO; SET LEGEND.DEMO; RUN;
proc sort data=demo; by RNUM status; run; 

DATA _NULL_;
SET demo ;
where rnum = '2';
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
if _n_ = 1 then do;
	put "CURRENT STATUS,COUNT OF LOANS,TOTAL PBO,TOTAL INTEREST,GRAND TOTAL";
end;
DO;
   PUT status @;
   PUT LON_CT @;
   PUT PBO @;
   PUT IRB @;
   PUT TOT $;
END;
RUN;
DATA _NULL_;
SET demo ;
where rnum = '3';
FILE REPORT3 DELIMITER=',' DSD DROPOVER LRECL=32767;
if _n_ = 1 then do;
	put "CURRENT STATUS,COUNT OF LOANS,TOTAL PBO,TOTAL INTEREST,GRAND TOTAL";
end;
DO;
   PUT status @;
   PUT LON_CT @;
   PUT PBO @;
   PUT IRB @;
   PUT TOT $;
END;
RUN;
