/*UTLWD26 - OFFSET PAYMENTS RECEIVED AFTER BANKRUPCTY FILING*/
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWD26.LWD26R2";
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE BNKOFFSET AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT	DISTINCT
		D.DF_PRS_ID
		,D.DM_PRS_1
		,D.DM_PRS_LST
		,A.LD_BKR_FIL
		,B.LD_TRX_EFF
		,B.LC_TRX_TYP
FROM	OLWHRM1.DC18_BKR A
		INNER JOIN OLWHRM1.DC11_LON_FAT B ON
			A.AF_APL_ID = B.AF_APL_ID
			AND A.AF_APL_ID_SFX = B.AF_APL_ID_SFX
			AND B.LC_TRX_TYP IN ('FO','SO')
			AND B.LC_REV_IND_TYP NOT IN ('PE','BC')
			AND DAYS(B.LD_TRX_EFF) > DAYS(A.LD_BKR_FIL)
			AND A.LC_BKR_STA = '01'
		INNER JOIN OLWHRM1.DC01_LON_CLM_INF C ON
			A.AF_APL_ID = C.AF_APL_ID
			AND A.AF_APL_ID_SFX = C.AF_APL_ID_SFX
			AND C.LC_STA_DC10 <> '04'
			AND C.LD_CLM_ASN_DOE IS NULL
		INNER JOIN OLWHRM1.PD01_PDM_INF D ON
			D.DF_PRS_ID = B.BF_SSN
WHERE NOT EXISTS (
	SELECT *
	FROM OLWHRM1.AY01_BR_ATY X
	WHERE X.DF_PRS_ID = D.DF_PRS_ID
	AND X.PF_ACT = 'DOOBY'
	)
ORDER BY D.DF_PRS_ID
);
DISCONNECT FROM DB2;
ENDRSUBMIT;
DATA BNKOFFSET;
	SET WORKLOCL.BNKOFFSET;
RUN;
DATA _NULL_;
	SET BNKOFFSET  ;
	LENGTH DESCRIPTION $600.;
	USER = '';
	ACT_DT = LD_TRX_EFF;
	DESCRIPTION = CATX(',',DF_PRS_ID,DM_PRS_1,DM_PRS_LST,PUT(LD_BKR_FIL,MMDDYY10.),PUT(LD_TRX_EFF,MMDDYY10.),LC_TRX_TYP);
	FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT USER $10. ;
	FORMAT ACT_DT MMDDYY10. ;
	FORMAT DESCRIPTION $600. ;
	IF _N_ = 1 THEN DO;
		PUT "USER,ACT_DT,DESCRIPTION";
	END;
	DO;
	   PUT USER $ @;
	   PUT ACT_DT @;
	   PUT DESCRIPTION $ ;
	END;
RUN;
