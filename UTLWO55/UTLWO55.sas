*------------------------*
| ALIGNMENT FORBEARANCES |
*------------------------*;
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWO55.LWO55R2";
FILENAME REPORTZ "&RPTLIB/ULWO55.LWO55RZ";

LIBNAME  WORKLOCL  REMOTE  SERVER=DUSTER  SLIBREF=WORK;
RSUBMIT;

%macro sqlcheck ;
  %if  &sqlxrc ne 0  %then  %do  ;
    data _null_  ;
            file reportz notitles  ;
            put @01 " ********************************************************************* "
              / @01 " ****  The SQL code above has experienced an error.               **** "
              / @01 " ****  The SAS should be reviewed.                                **** "       
              / @01 " ********************************************************************* "
              / @01 " ****  The SQL error code is  &sqlxrc  and the SQL error message  **** "
              / @01 " ****  &sqlxmsg   **** "
              / @01 " ********************************************************************* "
            ;
         run  ;
  %end  ;
%mend  ;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE XEMO AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.BF_SSN
	,PD10.DF_SPE_ACC_ID
	,A.IC_LON_PGM
	,A.LN_SEQ AS LN_ALI
	,H.LN_SEQ AS LN_CAN
	,M.LD_FOR_BEG
	,M.LD_FOR_END

FROM OLWHRM1.LN10_LON A
INNER JOIN OLWHRM1.PD10_PRS_NME PD10
	ON A.BF_SSN = PD10.DF_PRS_ID
INNER JOIN OLWHRM1.LN60_BR_FOR_APV B
	ON B.BF_SSN = A.BF_SSN
	AND B.LN_SEQ = A.LN_SEQ
	AND B.LC_STA_LON60 = 'A'
INNER JOIN OLWHRM1.FB10_BR_FOR_REQ C
	ON B.BF_SSN = C.BF_SSN
	AND B.LF_FOR_CTL_NUM = C.LF_FOR_CTL_NUM
	AND C.LC_FOR_TYP = '15'
	AND C.LC_FOR_STA = 'A'
INNER JOIN (SELECT GA01.DF_PRS_ID_BR
			,MAX(GA10.AD_PRC) MX_PRC
			FROM OLWHRM1.GA01_APP GA01
			INNER JOIN OLWHRM1.GA10_LON_APP GA10
				ON GA01.AF_APL_ID = GA10.AF_APL_ID
				AND GA10.AC_PRC_STA = 'A'
			GROUP BY GA01.DF_PRS_ID_BR
			) D
	ON A.BF_SSN = D.DF_PRS_ID_BR
INNER JOIN OLWHRM1.GA01_APP E
	ON D.DF_PRS_ID_BR = E.DF_PRS_ID_BR
INNER JOIN OLWHRM1.GA10_LON_APP F
	ON E.AF_APL_ID = F.AF_APL_ID
	AND F.AC_PRC_STA = 'A'
	AND D.MX_PRC = F.AD_PRC
INNER JOIN OLWHRM1.GA14_LON_STA G
	ON G.AF_APL_ID = F.AF_APL_ID
	AND G.AC_STA_GA14 = 'A'
	AND G.AC_LON_STA_TYP IN ('CA','PF','PM')
INNER JOIN OLWHRM1.LN10_LON H
	ON F.AF_APL_ID = H.LF_LON_ALT
INNER JOIN (SELECT CC.BF_SSN
			,MAX(ZZ.LD_FOR_BEG) AS LD_FOR_BEG
			,MAX(ZZ.LD_FOR_END) AS LD_FOR_END
		FROM OLWHRM1.LN10_LON CC
		INNER JOIN OLWHRM1.LN60_BR_FOR_APV ZZ
			ON ZZ.BF_SSN = CC.BF_SSN
			AND ZZ.LC_STA_LON60 = 'A'
			AND CC.LA_CUR_PRI > 0
		INNER JOIN OLWHRM1.FB10_BR_FOR_REQ WW
			ON ZZ.BF_SSN = WW.BF_SSN
			AND ZZ.LF_FOR_CTL_NUM = WW.LF_FOR_CTL_NUM
			AND WW.LC_FOR_TYP = '15'
			AND WW.LC_FOR_STA = 'A'
		GROUP BY CC.BF_SSN
		) M
	ON A.BF_SSN = M.BF_SSN

WHERE A.LA_CUR_PRI > 0
AND A.LC_STA_LON10 = 'R'
AND DAYS(M.LD_FOR_END) > DAYS(CURRENT DATE)
AND DAYS(M.LD_FOR_BEG) < DAYS(CURRENT DATE)

AND A.BF_SSN IN (SELECT DISTINCT Z.BF_SSN
					FROM OLWHRM1.LN10_LON Z
					INNER JOIN OLWHRM1.LN50_BR_DFR_APV Z1
						ON Z.BF_SSN = Z1.BF_SSN
						AND Z.LN_SEQ = Z1.LN_SEQ
					INNER JOIN OLWHRM1.LN60_BR_FOR_APV Z2
						ON Z.BF_SSN = Z2.BF_SSN
						AND Z.LN_SEQ = Z2.LN_SEQ
						AND Z1.LD_DFR_END = Z2.LD_FOR_END
					WHERE Z.LA_CUR_PRI > 0
					AND Z.LC_STA_LON10 = 'R'
					)

AND A.BF_SSN IN (SELECT DISTINCT ZZ.BF_SSN
				FROM OLWHRM1.LN10_LON ZZ
				INNER JOIN OLWHRM1.LN50_BR_DFR_APV ZZ1
					ON ZZ.BF_SSN = ZZ1.BF_SSN
					AND ZZ1.LC_STA_LON50 = 'A'
					AND DAYS(ZZ1.LD_DFR_END) >= DAYS(CURRENT DATE)
					AND ZZ.LC_STA_LON10 = 'R'
				)
AND A.BF_SSN NOT IN (SELECT DISTINCT Z.BF_SSN
				FROM OLWHRM1.LN10_LON Z
				INNER JOIN OLWHRM1.LN60_BR_FOR_APV Z2
					ON Z.BF_SSN = Z2.BF_SSN
					AND Z2.LC_STA_LON60 = 'A'
				WHERE Z.LA_CUR_PRI > 0
				AND Z.LC_STA_LON10 = 'R'
				AND Z2.LD_FOR_END = Z.LD_END_GRC_PRD
				AND Z.BF_SSN NOT IN (SELECT DISTINCT ZZ.BF_SSN
									FROM OLWHRM1.LN10_LON ZZ
									INNER JOIN OLWHRM1.LN50_BR_DFR_APV ZZ1
										ON ZZ.BF_SSN = ZZ1.BF_SSN
										AND ZZ1.LC_STA_LON50 = 'A'
										AND DAYS(ZZ1.LD_DFR_END) >= DAYS(CURRENT DATE)
										AND ZZ.LC_STA_LON10 = 'R'
									)
					)



FOR READ ONLY WITH UR
);

DISCONNECT FROM DB2;

/*%put  sqlxrc= >>> &sqlxrc <<< ||| sqlxmsg= >>> &sqlxmsg >>> ;  ** includes error messages to SAS log  ;*/
/*%sqlcheck;*/
/*quit;*/

ENDRSUBMIT;

DATA XEMO;
SET WORKLOCL.XEMO;
RUN;

PROC SORT DATA=XEMO;
BY BF_SSN;
RUN;

PROC PRINTTO PRINT=REPORT2 NEW;
RUN;

OPTIONS ORIENTATION = PORTRAIT;
OPTIONS CENTER NODATE NUMBER PAGENO=1 PS=52 LS=96;
PROC CONTENTS DATA=XEMO OUT=EMPTYSET NOPRINT;
DATA _NULL_;
SET EMPTYSET;
FILE PRINT;
IF  NOBS=0 AND _N_ =1 THEN DO;
	PUT // 96*'-';
	PUT      ////////
		@35 '**** NO RECORDS FOUND ****';
	PUT ////////
		@38 '-- END OF REPORT --';
	PUT ////////////////
		@27 "JOB = UTLWO55     REPORT = ULWO55.LWO55R2";
	END;
RETURN;
TITLE "ALIGNMENT FORBEARANCE WITH CANCELLED LOANS";
RUN;
PROC PRINT NOOBS SPLIT='/' DATA=XEMO;
FORMAT LD_FOR_BEG MMDDYY10. LD_FOR_END MMDDYY10.;
VAR DF_SPE_ACC_ID IC_LON_PGM LN_ALI LN_CAN LD_FOR_BEG LD_FOR_END;
LABEL	DF_SPE_ACC_ID = 'ACCOUNT'
		IC_LON_PGM = 'LOAN TYPE'
		LN_ALI = 'ALIGNMENT FORBEARANCE'
		LN_CAN = 'CANCELLED'
		LD_FOR_BEG = 'BEGIN DATE'
		LD_FOR_END = 'END DATE';

TITLE "ALIGNMENT FORBEARANCE WITH CANCELLED LOANS";
FOOTNOTE  'JOB = UTLWO55     REPORT = UTLWO55.LWO55R2';
RUN;

PROC PRINTTO;
RUN;
