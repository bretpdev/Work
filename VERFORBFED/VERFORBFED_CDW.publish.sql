/*
Deployment script for CDW

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "CDW"
:setvar DefaultFilePrefix "CDW"
:setvar DefaultDataPath "D:\Program Files\Microsoft SQL Server\MSSQL10.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "D:\Program Files\Microsoft SQL Server\MSSQL10.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ANSI_NULLS ON,
                ANSI_PADDING ON,
                ANSI_WARNINGS ON,
                ARITHABORT ON,
                CONCAT_NULL_YIELDS_NULL ON,
                QUOTED_IDENTIFIER ON,
                ANSI_NULL_DEFAULT ON,
                CURSOR_DEFAULT LOCAL 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET PAGE_VERIFY NONE,
                DISABLE_BROKER 
            WITH ROLLBACK IMMEDIATE;
    END


GO
USE [$(DatabaseName)];


GO
IF fulltextserviceproperty(N'IsFulltextInstalled') = 1
    EXECUTE sp_fulltext_database 'enable';


GO
PRINT N'Creating [verforbfed]...';


GO
CREATE SCHEMA [verforbfed]
    AUTHORIZATION [dbo];


GO
PRINT N'Creating [verforbfed].[GetAllValidLoansForForbearance]...';


GO
CREATE PROCEDURE [verforbfed].[GetAllValidLoansForForbearance]
	@Ssn AS CHAR(9)
AS

	SELECT DISTINCT
		DW1.[WC_DW_LON_STA]
	FROM 
		[dbo].DW01_DW_CLC_CLU DW1
	WHERE
		DW1.BF_SSN = @Ssn

RETURN 0
GO
PRINT N'Creating [verforbfed].[GetDateDelinquencyOccurred]...';


GO
CREATE PROCEDURE [verforbfed].[GetDateDelinquencyOccurred]
	@AccountNumber CHAR(10)
AS
	
    SELECT
		MIN(CAST(LN16.[LD_DLQ_OCC] AS DATETIME))
	FROM
		PD10_PRS_NME PD10 
		INNER JOIN LN16_LON_DLQ_HST LN16 ON LN16.BF_SSN = PD10.DF_PRS_ID 
		INNER JOIN LN10_Lon LN10 ON LN10.BF_SSN = PD10.DF_PRS_ID AND LN10.LN_SEQ = LN16.LN_SEQ
	WHERE
		PD10.DF_SPE_ACC_ID = @AccountNumber
		AND 
		LN16.LC_STA_LON16 = '1'
		AND
		LN10.LA_CUR_PRI > 0

RETURN 0
GO
PRINT N'Creating [verforbfed].[GetDaysPastDue]...';


GO
CREATE PROCEDURE [verforbfed].[GetDaysPastDue]
	@AccountNumber CHAR(10)
AS

	SELECT
		ISNULL(CAST(MAX(LN16.LN_DLQ_MAX) AS INT), 0)
	FROM
		PD10_PRS_NME PD10 
		INNER JOIN LN16_LON_DLQ_HST LN16 ON LN16.BF_SSN = PD10.DF_PRS_ID
		INNER JOIN LN10_Lon LN10 ON LN10.BF_SSN = PD10.DF_PRS_ID AND LN10.LN_SEQ = LN16.LN_SEQ
	WHERE
		PD10.DF_SPE_ACC_ID = @AccountNumber
		AND 
		LN16.LC_STA_LON16 = '1'
		AND
		LN10.LA_CUR_PRI > 0

RETURN 0
GO
PRINT N'Creating [verforbfed].[GetBorrowerIdentifiers]...';


GO
CREATE PROCEDURE [verforbfed].[GetBorrowerIdentifiers]
	@AccountIdentifier CHAR(10)
AS
	SET NOCOUNT ON;
	
	DECLARE @RowCount INT = 0
	
	SELECT
		PD10.DF_PRS_ID AS Ssn,
		PD10.DF_SPE_ACC_ID as AccountNumber
	FROM
		dbo.PD10_PRS_NME PD10
	WHERE
		PD10.DF_SPE_ACC_ID = @AccountIdentifier
		OR
		PD10.DF_PRS_ID = @AccountIdentifier

	SET @RowCount = @@ROWCOUNT
	
	IF @RowCount != 1
	BEGIN
		DECLARE @Server VARCHAR(20)
		IF @@ServerName = 'UHEAASQLDB'
			SET @Server = 'LEGEND'
		ELSE 
			SET @Server = 'LEGEND_TEST_VUK1'
		DECLARE @SQLStatement VARCHAR(MAX) = 
		'
			SELECT 
				PD10.DF_PRS_ID Ssn,
				PD10.DF_SPE_ACC_ID AccountNumber
			FROM 
				OPENQUERY
				(
					' + @Server + ',
					''
						SELECT 
							PD10.DF_PRS_ID,
							PD10.DF_SPE_ACC_ID
						FROM 
							PKUB.PD10_PRS_NME PD10
						WHERE 
							PD10.DF_SPE_ACC_ID = ''''' + @AccountIdentifier + '''''
							OR
							PD10.DF_PRS_ID = ''''' + @AccountIdentifier + '''''
						''
				)
		'
		  
		  EXEC(@SQLStatement)
		  SET @RowCount = @@ROWCOUNT
	END
	 
	IF @RowCount = 0
	BEGIN
		RAISERROR('[verforbfed].[GetBorrowerIdentifiers] returned %i record(s) for Account Identifier: %s', 16, 1, @RowCount, @AccountIdentifier) 
	END
RETURN 0
GO
PRINT N'Creating [verforbfed].[BorrowerHasSpousalLoans]...';


GO
CREATE PROCEDURE [verforbfed].[BorrowerHasSpousalLoans]
	@Ssn CHAR(9)
AS

	SELECT 
		CAST(CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END AS BIT)
	FROM
		LN10_LON LN10
	WHERE
		LN10.LC_STA_LON10 = 'R'
		AND 
		LN10.LA_CUR_PRI > 0
		AND 
		(
			DB_NAME() = 'CDW' AND LN10.IC_LON_PGM IN ('DLSSPL ','DLUSPL')
			OR
			DB_NAME() = 'UDW' AND LN10.IC_LON_PGM IN ('SUBSPC','UNSPC')
		)
		AND
		LN10.BF_SSN = @Ssn


RETURN 0
GO
PRINT N'Creating [verforbfed].[GetForbearanceEndDate]...';


GO
CREATE PROCEDURE [verforbfed].[GetForbearanceEndDate]
	@Ssn CHAR(9)
AS

	SELECT
		MAX(CAST(LN60.LD_FOR_END AS DATETIME))
	FROM
		[dbo].FB10_BR_FOR_REQ FB10
		INNER JOIN [dbo].LN60_BR_FOR_APV LN60 ON LN60.BF_SSN = FB10.BF_SSN AND LN60.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM
	WHERE 
		FB10.BF_SSN = @Ssn
		AND
		FB10.LC_FOR_TYP NOT IN ('25','28')
		AND
		FB10.LC_FOR_STA = 'A'
		AND
		LN60.LC_STA_LON60 = 'A'

RETURN 0
GO
PRINT N'Creating [verforbfed].[BorrowerHasFutureDatedDeferment]...';


GO
CREATE PROCEDURE [verforbfed].[BorrowerHasFutureDatedDeferment]
	@Ssn CHAR(9)
AS

	SELECT 
		CAST(CASE WHEN COUNT(*) > 1 THEN 1 ELSE 0 END AS BIT)
	FROM
		[dbo].FB10_BR_FOR_REQ FB10
		INNER JOIN [dbo].LN50_BR_DFR_APV LN50 ON LN50.BF_SSN = FB10.BF_SSN AND LN50.LF_DFR_CTL_NUM = FB10.LF_FOR_CTL_NUM
	WHERE 
		FB10.BF_SSN = @Ssn
		AND 
		LN50.LD_DFR_BEG > GETDATE()
		AND
		LN50.LC_STA_LON50 = 'A'

RETURN 0
GO
PRINT N'Creating [verforbfed].[BorrowerHasFutureDatedForbearance]...';


GO
CREATE PROCEDURE [verforbfed].[BorrowerHasFutureDatedForbearance]
	@Ssn CHAR(9)
AS

	SELECT 
		CAST(CASE WHEN COUNT(*) > 1 THEN 1 ELSE 0 END AS BIT)
	FROM
		[dbo].FB10_BR_FOR_REQ FB10
		INNER JOIN [dbo].LN50_BR_DFR_APV LN50 ON LN50.BF_SSN = FB10.BF_SSN AND LN50.LF_DFR_CTL_NUM = FB10.LF_FOR_CTL_NUM
	WHERE 
		FB10.BF_SSN = @Ssn
		AND 
		LN50.LD_DFR_BEG > GETDATE()
		AND
		LN50.LC_STA_LON50 = 'A'


RETURN 0
GO
PRINT N'Creating [verforbfed].[BorrowerHasInvalidRepaymentSchedule]...';


GO
CREATE PROCEDURE [verforbfed].[BorrowerHasInvalidRepaymentSchedule]
	@Ssn CHAR(9)
AS

    SELECT
		CAST(CASE WHEN COUNT(DISTINCT LN65.LC_TYP_SCH_DIS) > 0 THEN 1 ELSE 0 END AS BIT)
	FROM
		[dbo].LN65_LON_RPS LN65
		INNER JOIN IDRRepaymentSchedules IDR ON IDR.IDRRepaymentSchedule = LN65.LC_TYP_SCH_DIS
	WHERE 
		BF_SSN = @Ssn
		AND
		LN65.LC_STA_LON65 = 'A'

RETURN 0
GO
PRINT N'Creating [verforbfed].[BorrowerIsPaidAhead]...';


GO
CREATE PROCEDURE [verforbfed].[BorrowerIsPaidAhead]
	@AccountNumber CHAR(10)
AS

	SELECT
		CAST(CASE WHEN COUNT(*) > 1 THEN 1 ELSE 0 END AS BIT)
	FROM
		BL10_Bill BL10
		INNER JOIN PD10_PRS_NME PD10 ON PD10.DF_SPE_ACC_ID = BL10.DF_SPE_ACC_ID
		INNER JOIN LN10_Lon LN10 ON LN10.BF_SSN = PD10.DF_PRS_ID AND LN10.LN_SEQ = BL10.LN_SEQ	   
	WHERE	
		BL10.DF_SPE_ACC_ID = @AccountNumber
		AND 		
		BL10.PAID_AHEAD = 'Y'
		AND 
		BL10.LC_STA_LON80 = 'A'
		AND 
		BL10.LC_STA_BIL10 = 'A'
		AND
		LN10.LC_STA_LON10 = 'A'
		AND 
		DATEDIFF(DAY, GETDATE(), LD_BIL_DU_LON) > 30
		AND
		LN10.LA_CUR_PRI > 0

RETURN 0
GO
PRINT N'Creating [verforbfed].[BorrowerPaymentAmountEqualsZero]...';


GO
CREATE PROCEDURE [verforbfed].[BorrowerPaymentAmountEqualsZero]
	@Ssn CHAR(10)
AS

    SELECT
		CAST(CASE WHEN SUM(LN66.LA_RPS_ISL) > 0 THEN 0 ELSE 1 END AS BIT)
	FROM
		LN65_LON_RPS LN65
		INNER JOIN LN66_LON_RPS_SPF LN66 ON LN65.BF_SSN = LN66.BF_SSN AND LN65.LN_SEQ = LN66.LN_SEQ
	WHERE 
		LN65.BF_SSN = @Ssn
		AND
		LN65.LC_STA_LON65 = 'A'

RETURN 0
GO
PRINT N'Creating [verforbfed].[GetBorrowerSpecialStatuses]...';


GO
CREATE PROCEDURE [verforbfed].[GetBorrowerSpecialStatuses]
	@AccountNumber CHAR(10)
AS

	SELECT
		CASE
			WHEN ISNULL(LN60.LI_FOR_VRB_DFL_RUL, 'N') != 'Y' THEN 1 ELSE 0
		END AS LI_FOR_VRB_DFL_RUL 
	FROM
		PD10_PRS_NME PD10 
		INNER JOIN LN16_LON_DLQ_HST LN16 ON LN16.BF_SSN = PD10.DF_PRS_ID
		INNER JOIN LN10_Lon LN10 ON LN10.BF_SSN = PD10.DF_PRS_ID AND LN10.LN_SEQ = LN16.LN_SEQ
		LEFT JOIN LN60_BR_FOR_APV LN60 ON LN60.BF_SSN = LN16.BF_SSN
	WHERE
		PD10.DF_SPE_ACC_ID = @AccountNumber
		AND
		LN16.LN_DLQ_MAX >= 270
		AND 
		LN16.LC_STA_LON16 = '1'
		AND 
		LN10.LA_CUR_PRI > 0
		AND
		LN16.LC_STA_LON16 = 'A'
		AND
		LN10.LC_STA_LON10 = 'A'

RETURN 0
GO
PRINT N'Creating [verforbfed].[GetCollectionSuspenseInfo]...';


GO
CREATE PROCEDURE [verforbfed].[GetCollectionSuspenseInfo]
	@Ssn CHAR(10)
AS
	SELECT DISTINCT
		FB10.LC_FOR_TYP,
		CAST(LN60.LD_FOR_BEG AS DATETIME) AS CollectionSuspenseForbearanceBeginDate,
		CAST(LN60.LD_FOR_END AS DATETIME) AS CollectionSuspenseForbearanceEndDate
	FROM	
		[dbo].FB10_BR_FOR_REQ FB10
		INNER JOIN [dbo].LN60_BR_FOR_APV LN60 ON FB10.BF_SSN = LN60.BF_SSN AND FB10.LF_FOR_CTL_NUM = LN60.LF_FOR_CTL_NUM
	WHERE 
		FB10.BF_SSN = @Ssn
		AND 
		FB10.LC_FOR_TYP in(25, 28)
		AND
		FB10.LC_FOR_STA = 'A'

RETURN 0
GO
PRINT N'Creating [verforbfed].[GetDefermentEndDate]...';


GO
CREATE PROCEDURE [verforbfed].[GetDefermentEndDate]
	@Ssn CHAR(9)
AS

	SELECT
		MAX(CAST(LN50.LD_DFR_END AS DATETIME))
	FROM
		[dbo].DF10_BR_DFR_REQ DF10
		INNER JOIN [dbo].LN50_BR_DFR_APV LN50 ON LN50.BF_SSN = DF10.BF_SSN AND DF10.LF_DFR_CTL_NUM = LN50.LF_DFR_CTL_NUM 
	WHERE 
		DF10.BF_SSN = @Ssn
		AND
		DF10.LC_DFR_STA = 'A'
		AND
		LN50.LC_STA_LON50 = 'A'

RETURN 0
GO
PRINT N'Creating [verforbfed].[GetNextBillDueDate]...';


GO
CREATE PROCEDURE [verforbfed].[GetNextBillDueDate]
	@AccountNumber CHAR(10)
AS
BEGIN

	
	SELECT 
		MAX(CAST(BL10.LD_BIL_DU_LON AS DATETIME))
	FROM
		PD10_PRS_NME PD10
		INNER JOIN [dbo].[BL10_Bill] BL10 ON BL10.DF_SPE_ACC_ID = PD10.DF_SPE_ACC_ID
		INNER JOIN [dbo].DW01_DW_CLC_CLU DW01 ON DW01.BF_SSN = PD10.DF_PRS_ID AND DW01.LN_SEQ = BL10.LN_SEQ						 
	WHERE 
		BL10.DF_SPE_ACC_ID = @AccountNumber
		AND
		BL10.LC_STA_BIL10 = 'A'
		AND
		DW01.WC_DW_LON_STA = 'A'
		AND
		DW01.WC_DW_LON_STA in ('03', '14')

END
GO
PRINT N'Creating [verforbfed].[GetTotalForbDaysUsed]...';


GO
CREATE PROCEDURE [verforbfed].[GetTotalForbDaysUsed]
	@Ssn CHAR(9)
AS

	SELECT
		ISNULL(SUM(DATEDIFF(DAY, LD_FOR_REQ_BEG, LD_FOR_REQ_END)), 0)
	FROM
		FB10_BR_FOR_REQ FB10
		INNER JOIN LN60_BR_FOR_APV LN60 on LN60.BF_SSN = FB10.BF_SSN AND FB10.LF_FOR_CTL_NUM = LN60.LF_FOR_CTL_NUM
	WHERE
		FB10.LC_FOR_TYP = '05'
		AND
		FB10.LC_FOR_STA = 'A'
		AND
		FB10.BF_SSN = @Ssn

RETURN 0
GO
PRINT N'Creating [verforbfed].[BorrowerHasSplitSchedules]...';


GO
CREATE PROCEDURE [verforbfed].[BorrowerHasSplitSchedules]
	@Ssn CHAR(9)
AS

	SELECT
		CAST(CASE WHEN (COUNT(*) - IDR.IdrCount) > 0 THEN 1 ELSE 0 END AS BIT) 
	FROM 
		LN65_LON_RPS LN65
		LEFT JOIN 
		(
			SELECT
				LN65.BF_SSN,
				COUNT(*) as IdrCount
			FROM
				LN65_LON_RPS LN65
				INNER JOIN IDRRepaymentSchedules IDR ON IDR.IDRRepaymentSchedule = LN65.LC_TYP_SCH_DIS
			WHERE
				BF_SSN = @Ssn
			GROUP BY LN65.BF_SSN
		
		) IDR
		ON IDR.BF_SSN = LN65.BF_SSN
	WHERE
		LN65.BF_SSN = @Ssn
	GROUP BY 
		IDR.IdrCount

RETURN 0
GO
PRINT N'Creating [dbo].[BorrowerUsedCollectionSuspensionInLast30Days]...';


GO
CREATE PROCEDURE [dbo].[BorrowerUsedCollectionSuspensionInLast30Days]
	@Ssn CHAR(9)
AS

	SELECT 
		CAST(CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END AS BIT)
	FROM 
		[dbo].[FB10_BR_FOR_REQ] FB10
		INNER JOIN [dbo].[LN60_BR_FOR_APV] LN60 ON FB10.BF_SSN = LN60.BF_SSN AND LN60.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM
	WHERE
		FB10.LC_FOR_TYP = '28' 
		AND
		FB10.LC_FOR_STA = 'A'
		AND
		LN60.LD_FOR_END BETWEEN DATEADD(DAY, -29, GETDATE()) AND GETDATE()
		AND
		FB10.BF_SSN = @Ssn


RETURN 0
GO
PRINT N'Update complete.';


GO
