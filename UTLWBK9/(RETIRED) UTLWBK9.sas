/*============================================*/
/*UTLWBK9 TILP CHAPTER 13 BANKRUPTCY REVIEW*/
/*============================================*/
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWBK9.LWBK9R2";
FILENAME REPORTZ "&RPTLIB/ULWBK9.LWBK9RZ";

DATA _NULL_;
     CALL SYMPUT('AGO30DAYS',"'"||PUT(INTNX('DAY',TODAY(),-30,'BEGINNING'), MMDDYYD10.)||"'");
RUN;

%SYSLPUT AGO30DAYS = &AGO30DAYS;
LIBNAME  DUSTER  REMOTE  SERVER=DUSTER  SLIBREF=WORK;
RSUBMIT;
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE CC13BR AS
SELECT *
FROM CONNECTION TO DB2 
(
SELECT DISTINCT 
	LN10.BF_SSN,
	AY10.LF_ATY_RCP,
	AY10.LC_ATY_RGD_TO,
	AY10.LF_ATY_RGD_TO,
	'ALL' as AN_SEQ
FROM 
	OLWHRM1.LN10_LON LN10
	INNER JOIN OLWHRM1.PD24_PRS_BKR PD24
		ON PD24.DF_PRS_ID = LN10.BF_SSN
		AND PD24.DC_BKR_STA = '06'
		AND PD24.DC_BKR_TYP = '13'
	INNER JOIN OLWHRM1.AY10_BR_LON_ATY AY10
		ON AY10.BF_SSN = LN10.BF_SSN
	LEFT OUTER JOIN 
	(
	 	SELECT 
			AY01.DF_PRS_ID,
			'Y' AS EXCLD
	 	FROM 
			OLWHRM1.AY01_BR_ATY AY01
			INNER JOIN OLWHRM1.PD24_PRS_BKR PD24
				ON AY01.DF_PRS_ID = PD24.DF_PRS_ID
				AND PD24.DC_BKR_TYP = '13'
	 	WHERE 
			AY01.PF_ACT = 'TLP13'
	 		AND AY01.BD_ATY_PRF < &AGO30DAYS	
	 ) Exclude30Day
		ON Exclude30Day.DF_PRS_ID = LN10.BF_SSN
	LEFT OUTER JOIN
	(
		SELECT DISTINCT
			DF_PRS_ID_BR
		FROM
			OLWHRM1.CT30_CALL_QUE
		WHERE
			IF_WRK_GRP = 'T101'
	) CT30Exclude
		ON CT30Exclude.DF_PRS_ID_BR = LN10.BF_SSN
	LEFT OUTER JOIN
	( /*Exclude accounts with pending arc.*/
		SELECT DISTINCT
			BF_SSN
		FROM
			OLWHRM1.AY10_BR_LON_ATY
		WHERE
			PF_REQ_ACT = 'TLP13'
			AND PF_RSP_ACT IS NULL
	) PendingArc
		ON PendingArc.BF_SSN = LN10.BF_SSN
WHERE 
	LN10.LA_CUR_PRI > 0
	AND LN10.LC_STA_LON10 = 'R'
	AND LN10.IC_LON_PGM = 'TILP'
	AND CT30Exclude.DF_PRS_ID_BR IS NULL
	AND PendingArc.BF_SSN IS NULL

FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;

%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;
%SQLCHECK (SQLRPT=ULWBK9.LWBK9RZ);
QUIT;
ENDRSUBMIT;

DATA CC13BR; SET DUSTER.CC13BR; RUN;

PROC SORT DATA=CC13BR;
BY BF_SSN;
RUN;

/*------------------ VARIABLE INITIALIZATION ------------------*/
DATA CC13BR (KEEP=TARGET_ID ARC_NAME FROM_DATE TO_DATE NEEDED_DATE RECIPIENT_ID REGARDS_CODE REGARDS_ID SEQ_NO COMMENTS);
SET CC13BR ;
LENGTH COMMENTS $ 600.;
TARGET_ID = BF_SSN;
ARC_NAME = 'TLP13';
FROM_DATE = '';
TO_DATE = '';
NEEDED_DATE = '';
RECIPIENT_ID = LF_ATY_RCP;
REGARDS_CODE = LC_ATY_RGD_TO;
REGARDS_ID = LF_ATY_RGD_TO;
SEQ_NO = AN_SEQ;
COMMENTS = 'Chapter 13 Bankruptcy Review for TILP loan(s)';
RUN;

DATA _NULL_;
SET  WORK.CC13BR; 
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
   FORMAT TARGET_ID $9. ;
   FORMAT ARC_NAME $5. ;
   FORMAT FROM_DATE $1. ;
   FORMAT TO_DATE $1. ;
   FORMAT NEEDED_DATE $1. ;
   FORMAT RECIPIENT_ID $9. ;
   FORMAT REGARDS_CODE $1. ;
   FORMAT REGARDS_ID $9. ;
   FORMAT SEQ_NO 3. ;
   FORMAT COMMENTS $600. ;
DO;
	PUT TARGET_ID $ @;
	PUT ARC_NAME $ @;
	PUT FROM_DATE $ @;
	PUT TO_DATE $ @;
	PUT NEEDED_DATE $ @;
	PUT RECIPIENT_ID $ @;
	PUT REGARDS_CODE $ @;
	PUT REGARDS_ID $ @;
	PUT SEQ_NO @;
	PUT COMMENTS $ ;
END;
RUN;
