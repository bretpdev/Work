/*-----------------------------------------------------------------*
| UTLWK02 -Successful Directory Assistance Look-Ups for References |
*-----------------------------------------------------------------*/
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;
%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWK02.LWK02R2";
FILENAME REPORTZ "&RPTLIB/ULWK02.LWK02RZ";

DATA _NULL_;
     CALL SYMPUT('CDATE',"'"||PUT(INTNX('DAY',TODAY(),-30,'beginning'), MMDDYYD10.)||"'");
RUN;

%SYSLPUT CDATE = &CDATE;
libname  WORKLOCL  REMOTE  SERVER=DUSTER  SLIBREF=work  ;
RSUBMIT;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE SDALUR AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.DF_PRS_ID	
	,A.BX_CMT
	,A.BD_ATY_PRF AS KSBUP_DT
	,B.KFEDA_DT
/**/
/*	,DC01.AF_APL_ID||DC01.AF_APL_ID_SFX AS LOAN*/
/*	,DC01.LC_STA_DC10*/
/*	,GA14.AC_LON_STA_TYP*/
FROM OLWHRM1.AY01_BR_ATY A 
LEFT OUTER JOIN (
	SELECT DF_PRS_ID
		,MAX(BD_ATY_PRF) AS KFEDA_DT
	FROM OLWHRM1.AY01_BR_ATY 
	WHERE PF_ACT = 'KFEDA'
	GROUP BY DF_PRS_ID
	 ) B
	ON A.DF_PRS_ID = B.DF_PRS_ID
INNER JOIN (
		SELECT Q.DF_PRS_ID
		FROM OLWHRM1.PD03_PRS_ADR_PHN Q
		WHERE EXISTS (
			SELECT *
			FROM OLWHRM1.PD04_ADR_PHN_HST Y
			WHERE Y.DF_PRS_ID = Q.DF_PRS_ID
			AND Y.DN_PHN_HST = Q.DN_PHN
			AND Y.DC_ADR_HST = Q.DC_ADR 
			AND Y.DC_ADR_HST = 'L'
			)
	UNION 
		SELECT DF_PRS_ID
		FROM OLWHRM1.AY01_BR_ATY
		WHERE SUBSTR(DF_PRS_ID,1,2) = 'RF'
	) C
	ON A.DF_PRS_ID = C.DF_PRS_ID

INNER JOIN OLWHRM1.BR03_BR_REF BR03
	ON A.DF_PRS_ID = BR03.DF_PRS_ID_RFR
LEFT JOIN OLWHRM1.DC01_LON_CLM_INF DC01
	ON BR03.DF_PRS_ID_BR = DC01.BF_SSN
	AND DC01.LC_STA_DC10 = '03'
LEFT JOIN OLWHRM1.GA14_LON_STA GA14
	ON DC01.AF_APL_ID = GA14.AF_APL_ID
	AND DC01.AF_APL_ID_SFX = GA14.AF_APL_ID_SFX
	AND GA14.AC_STA_GA14 = 'A'
	AND GA14.AC_LON_STA_TYP = 'DN'

WHERE A.PF_ACT = 'KSBUP'
AND A.BD_ATY_PRF > &CDATE
AND NOT EXISTS (
	SELECT *
	FROM OLWHRM1.CT30_CALL_QUE X
	WHERE X.DF_PRS_ID_TGT = A.DF_PRS_ID
	AND X.IF_WRK_GRP = 'KREDARTN'
	)
AND DC01.BF_SSN IS NULL
AND GA14.AF_APL_ID IS NULL

FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
ENDRSUBMIT  ;
DATA SDALUR;
SET WORKLOCL.SDALUR;
RUN;

DATA SDALUR;
SET SDALUR;
IF KFEDA_DT > KSBUP_DT THEN DELETE;
RUN;

DATA SDALUR(KEEP=TARGET_ID QUEUE_NAME INSTITUTION_ID INSTITUTION_TYPE DATE_DUE TIME_DUE COMMENTS);
SET SDALUR ;
LENGTH COMMENTS $ 600.;
TARGET_ID = DF_PRS_ID;
QUEUE_NAME = 'KREDARTN';
INSTITUTION_ID = '';
INSTITUTION_TYPE = '';
DATE_DUE = '';
TIME_DUE = '';
COMMENTS = 'RealEDA: '||LEFT(TRIM(DF_PRS_ID))||','||LEFT(TRIM(BX_CMT));
RUN;

DATA _NULL_;
SET  WORK.SDALUR; 
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
   FORMAT COMMENTS $600. ;
   FORMAT TARGET_ID $9. ;
   FORMAT QUEUE_NAME $8. ;
   FORMAT INSTITUTION_ID $1. ;
   FORMAT INSTITUTION_TYPE $1. ;
   FORMAT DATE_DUE $1. ;
   FORMAT TIME_DUE $1. ;
DO;
	PUT TARGET_ID $ @;
	PUT QUEUE_NAME $ @;
	PUT INSTITUTION_ID $ @;
	PUT INSTITUTION_TYPE $ @;
	PUT DATE_DUE $ @;
	PUT TIME_DUE $ @;
	PUT COMMENTS $ ;
END;
RUN;
