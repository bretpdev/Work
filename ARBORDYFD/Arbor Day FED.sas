%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/Arbor Day Fed.R2";

LIBNAME  LEGEND  REMOTE  SERVER=LEGEND SLIBREF=work  ;
RSUBMIT LEGEND;
/*%let DB = DNFPRQUT;  *This is test;*/
%let DB = DNFPUTDL;  *This is live;

LIBNAME PKUB DB2 DATABASE=&DB OWNER=PKUB;
LIBNAME PKUR DB2 DATABASE=&DB OWNER=PKUR;
LIBNAME FRDWODS DB2 DATABASE=&DB OWNER=FRDWODS;

PROC SQL;
CREATE TABLE DEMO AS
SELECT DISTINCT trim(d.dm_prs_1) || ' ' || d.dm_prs_lst as bor_name
    ,a.dx_str_adr_1
    ,a.dx_str_adr_2
    ,a.dm_ct
	,coalesce(A.DC_DOM_ST,A.DM_FGN_ST) AS DC_DOM_ST
    ,A.DF_ZIP_CDE
	,A.DM_FGN_CNY
FROM PKUB.PD10_PRS_NME D
INNER JOIN PKUB.PD30_PRS_ADR A
    ON D.DF_PRS_ID = A.DF_PRS_ID
inner join pkub.LN10_LON B
    on b.bf_ssn = d.DF_PRS_ID
inner join PKUB.DW01_DW_CLC_CLU C
    ON B.BF_SSN = C.BF_SSN
    AND B.LN_SEQ = C.LN_SEQ
WHERE b.LA_CUR_PRI > 0
    AND b.LC_STA_LON10 = 'R'
    AND C.WC_DW_LON_STA NOT IN ('04','05','07','08','09','10','11','12','16','17','18','19','20','21','22','88','98')
    AND A.DC_ADR = 'L'
    AND A.DI_VLD_ADR = 'Y'
	and b.lc_lon_snd_chc ^= 'Y'
GROUP BY B.BF_SSN
HAVING SUM(B.LA_CUR_PRI + C.WA_TOT_BRI_OTS) > 1000
;
QUIT;

ENDRSUBMIT;
DATA DEMO;	SET LEGEND.DEMO;RUN;

proc sort data=demo; by DC_DOM_ST dm_ct; run;

DATA _NULL_;
SET DEMO ;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
IF _N_ = 1 THEN PUT "BORROWER NAME,STREET 1,STREET 2,CITY,STATE,ZIP,COUNTRY";
PUT BOR_NAME DX_STR_ADR_1 DX_STR_ADR_2 DM_CT DC_DOM_ST DF_ZIP_CDE DM_FGN_CNY;
RUN;
