*---------------------------------------------*
|  UTLWM14 PORTFOLIO STRATIFICATION REPORT 1  |
*---------------------------------------------*;

/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
/*FILENAME REPORT2 "&RPTLIB/ULWM14.LWM14R2";*/
/*FILENAME REPORTZ "&RPTLIB/ULWM14.LWM14RZ";*/

FILENAME REPORT2 'T:\SAS\ULWM14.ULWM14R2.TXT';

LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;

%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE CAT1 AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.BF_SSN 
	,A.AF_APL_ID||A.AF_APL_ID_SFX AS CLUID
		,SUM(
		A.LA_CLM_PRI + 
		A.LA_CLM_INT - 
		A.LA_PRI_COL +
		A.LA_INT_ACR +
		C.LA_CLM_INT_ACR -
		A.LA_INT_COL
		) + SUM(A.LA_LEG_CST_ACR ) AS TOTBL
	,'1' AS CAT 
FROM OLWHRM1.DC01_LON_CLM_INF A
LEFT OUTER JOIN OLWHRM1.DC02_BAL_INT C
	ON A.AF_APL_ID = C.AF_APL_ID
	AND A.AF_APL_ID_SFX = C.AF_APL_ID_SFX
	AND A.LF_CRT_DTS_DC10 = C.LF_CRT_DTS_DC10
WHERE A.LC_STA_DC10 = '03'
AND A.LC_PCL_REA IN ('DB','DF','IN')
AND A.LD_CLM_ASN_DOE IS NULL
GROUP BY A.BF_SSN 
	,A.AF_APL_ID||A.AF_APL_ID_SFX 
	,'1' 
FOR READ ONLY WITH UR
);

CREATE TABLE CAT2 AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.BF_SSN 
	,A.AF_APL_ID||A.AF_APL_ID_SFX AS CLUID
	,SUM(
		A.LA_CLM_PRI + 
		A.LA_CLM_INT - 
		A.LA_PRI_COL +
		A.LA_INT_ACR +
		C.LA_CLM_INT_ACR -
		A.LA_INT_COL
		) + SUM(A.LA_LEG_CST_ACR ) AS TOTBL
	,'2' AS CAT
FROM OLWHRM1.DC01_LON_CLM_INF A
INNER JOIN OLWHRM1.LA10_LEG_ACT B
	ON A.BF_SSN = B.DF_PRS_ID_BR
LEFT OUTER JOIN OLWHRM1.DC02_BAL_INT C
	ON A.AF_APL_ID = C.AF_APL_ID
	AND A.AF_APL_ID_SFX = C.AF_APL_ID_SFX
	AND A.LF_CRT_DTS_DC10 = C.LF_CRT_DTS_DC10
WHERE A.LC_STA_DC10 = '03'
AND A.LD_CLM_ASN_DOE IS NULL
AND B.BC_LEG_ACT_REC_TYP = '2'
GROUP BY A.BF_SSN 
	,A.AF_APL_ID||A.AF_APL_ID_SFX 
	,'2' 
FOR READ ONLY WITH UR
);

CREATE TABLE CAT3 AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.BF_SSN 
	,A.AF_APL_ID||A.AF_APL_ID_SFX AS CLUID
	,SUM(
		A.LA_CLM_PRI + 
		A.LA_CLM_INT - 
		A.LA_PRI_COL +
		A.LA_INT_ACR +
		C.LA_CLM_INT_ACR -
		A.LA_INT_COL
		) + SUM(A.LA_LEG_CST_ACR ) AS TOTBL	
	,'3' AS CAT
FROM OLWHRM1.DC01_LON_CLM_INF A
LEFT OUTER JOIN OLWHRM1.DC02_BAL_INT C
	ON A.AF_APL_ID = C.AF_APL_ID
	AND A.AF_APL_ID_SFX = C.AF_APL_ID_SFX
	AND A.LF_CRT_DTS_DC10 = C.LF_CRT_DTS_DC10
WHERE A.LC_STA_DC10 = '03'
AND A.LD_CLM_ASN_DOE IS NULL
AND A.LC_PCL_REA IN ('BC','BH','BO')
GROUP BY A.BF_SSN 
	,A.AF_APL_ID||A.AF_APL_ID_SFX 
	,'3' 
FOR READ ONLY WITH UR
);

DISCONNECT FROM DB2;
/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWM14.LWM14RZ);*/
/*QUIT;*/
ENDRSUBMIT;

DATA CAT1;SET WORKLOCL.CAT1;RUN;
DATA CAT2;SET WORKLOCL.CAT2;RUN;
DATA CAT3;SET WORKLOCL.CAT3;RUN;

DATA CAT;
SET CAT1 CAT2 CAT3;
RUN;

PROC DATASETS;
DELETE CAT1 CAT2 CAT3;
RUN;

PROC SORT DATA=CAT;
BY CAT BF_SSN CLUID;
RUN;

DATA CAT;
SET CAT;
BY CAT BF_SSN;
IF FIRST.BF_SSN THEN BR_CT = 1;
ELSE BR_CT = 0;
RUN;

PROC FORMAT;
VALUE $CAT
'1'='OPEN DEFAULTED LOANS'
'2'='OPEN DEFAULTED LOANS WITH JUDGEMENTS'
'3'='NON DEFAULTED LOANS';
RUN;

PROC PRINTTO PRINT=REPORT2 NEW;RUN;
OPTIONS CENTER PAGENO=1 ORIENTATION = LANDSCAPE ;
OPTIONS PS=45 LS=127 CENTER PAGENO=1;
TITLE1	'PORTFOLIO STRATIFICATION REPORT';
TITLE2	'PART ONE';
FOOTNOTE 'JOB=UTLWM14 				REPORT=ULWM14.LWM14R2';
PROC REPORT DATA=CAT NOWD HEADSKIP SPLIT='/' SPACING=10 HEADLINE;
COLUMN CAT BR_CT TOTBL;
DEFINE CAT / GROUP 'CATEGORY' FORMAT=$CAT.;
DEFINE BR_CT / ANALYSIS 'TOTAL BORROWERS' FORMAT=COMMA9.;
DEFINE TOTBL / ANALYSIS 'TOTAL OUTSTANDING BALANCE' FORMAT=DOLLAR20.2 ;
BREAK AFTER CAT / SKIP;
RUN;
PROC PRINTTO;
RUN;

/*DETAIL*/
/*PROC EXPORT DATA=CAT*/
/*            OUTFILE= "T:\SAS\UTLWM14_DETAIL.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/
