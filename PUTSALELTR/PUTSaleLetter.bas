Attribute VB_Name = "PUTSaleLetter"
Private ftpFolder As String
Private DocFolder As String
Private LogFolder As String

Sub Main()
    Dim ToPrinter As Boolean
    Dim timeStamp As String
    Dim rowData As String
    Dim splitData() As String
    Dim UserID As String
    Dim rFile As String
    Dim rSSN As String
    Set fso = CreateObject("Scripting.FileSystemObject")
    
    If Not SP.Common.CalledByMBS Then
        If MsgBox("This script prints letters to borrowers whose loans are being sold (PUT) to ED and adds activity records.  Click 'OK' to continue or 'Cancel' to end the script.", vbOKCancel + vbInformation, "PUT Sale Letter") = vbCancel Then End
    End If
    
    'set values
    timeStamp = Time
    DocFolder = "X:\PADD\BorrowerServices\"
    If SP.Common.TestMode(ftpFolder, DocFolder, LogFolder) Then
        ToPrinter = False
    Else
        ToPrinter = True
    End If
    ftpFolder = "T:\"
    DocFolder = "T:\"
    LogFolder = "T:\"
    
    'warn user and end if any files are missing
    If Dir(ftpFolder & "PUTSALE.R2.txt") = "" Or Dir(ftpFolder & "PUTSALE.R3.txt") = "" Or Dir(ftpFolder & "PUTSALE.R4.txt") = "" Or Dir(ftpFolder & "PUTSALE.R5.txt") = "" Then
        MsgBox "One of more files is missing.", vbOKOnly + vbCritical, "Files Missing"
        End
    End If
    
    'get recovery values if recovery file exists
    If Dir(LogFolder & "putsalelog.txt") <> "" Then
        Open LogFolder & "putsalelog.txt" For Input As #1
        Input #1, rFile, rSSN
        Close #1
    Else
        rFile = ""
        rSSN = ""
    End If
    
    'copy files from X drive so the originals aren't overwritten when the 2D barcode stuff is added
'    fso.CopyFile FTPFolder & "PUTSALE.R2.txt", "C:\Windows\Temp\PUTSALE.R2.txt"
'    fso.CopyFile FTPFolder & "PUTSALE.R3.txt", "C:\Windows\Temp\PUTSALE.R3.txt"
'    fso.CopyFile FTPFolder & "PUTSALE.R4.txt", "C:\Windows\Temp\PUTSALE.R4.txt"
'    fso.CopyFile FTPFolder & "PUTSALE.R5.txt", "C:\Windows\Temp\PUTSALE.R5.txt"

    If Not SP.Common.CalledByMBS Then
        MsgBox "The letters generated by this script must be printed two-sided.  Set the default properties of your printer to duplex (contact Computer Services if you are unsure how this is done).  Click OK to resume processing ONLY AFTER you have set up your printer to print duplex.", vbOKOnly + vbExclamation, "Duplex Printing Setup"
    End If

    'print non-split borrower letters
    If FileLen("T:\PUTSALE.R2.txt") > 0 Then
        Barcode2D.AddBarcodeAndStaticCurrentDate "T:\PUTSALE.R2.txt", "DF_SPE_ACC_ID", "PUTSALE"
        SP.CostCenterPrinting.Main DocFolder, "PUTSALE", "PUT Loan Sale - Non-split borrower", Page1, "PUTSALE", "T:\PUTSALE.R2.txt", timeStamp, "PUTSALELTR", , ToPrinter
    End If
    
    'print split borrower letters
    If FileLen("T:\PUTSALE.R3.txt") > 0 Then
        Barcode2D.AddBarcodeAndStaticCurrentDate "T:\PUTSALE.R3.txt", "DF_SPE_ACC_ID", "PUTSALESP"
        SP.CostCenterPrinting.Main DocFolder, "PUTSALESP", "PUT Loan Sale - Split borrower", Page2, "PUTSALESP", "T:\PUTSALE.R3.txt", timeStamp, "PUTSALELTR", , ToPrinter
    End If
    
    'login and get user ID
    SP.Common.Login
    UserID = SP.Common.GetUserID
    
    'add activity record for valid address non-split borrowers
    If (FileLen("T:\PUTSALE.R2.txt") > 0) And (rFile = "R2" Or rFile = "") Then
        'open data file and read in header row
        Open "T:\PUTSALE.R2.txt" For Input As #1
        Line Input #1, rowData
        
        'advance to last record processed if in recovery
        If rFile = "R2" Then
            Do
                Line Input #1, rowData
                rowData = Replace(rowData, """", "")
                splitData = Split(rowData, ",")
                If splitData(12) = rSSN Then Exit Do
            Loop
        End If
        While Not EOF(1)
            Line Input #1, rowData
            rowData = Replace(rowData, """", "")
            splitData = Split(rowData, ",")
            SP.Common.ATD22AllLoans splitData(12), "PUTSL", "PUT loan sale letter mailed to non-split borrower.", "PUTSALELTR", UserID
            
            'update log
            Open LogFolder & "putsalelog.txt" For Output As #2
            Write #2, "R2", splitData(12)
            Close #2
        Wend
        Close #1
        rFile = ""
    End If
    
    'add activity record for valid address split borrowers
    If (FileLen("T:\PUTSALE.R3.txt") > 0) And (rFile = "R3" Or rFile = "") Then
        'open data file and read in header row
        Open "T:\PUTSALE.R3.txt" For Input As #1
        Line Input #1, rowData
        
        'advance to last record processed if in recovery
        If rFile = "R3" Then
            Do
                Line Input #1, rowData
                rowData = Replace(rowData, """", "")
                splitData = Split(rowData, ",")
                If splitData(16) = rSSN Then Exit Do
            Loop
        End If
        
        'process records
        While Not EOF(1)
            Line Input #1, rowData
            rowData = Replace(rowData, """", "")
            splitData = Split(rowData, ",")
            SP.Common.ATD22AllLoans splitData(16), "PUTSP", "PUT loan sale letter mailed to split borrower.", "PUTSALELTR", UserID

            'update log
            Open LogFolder & "putsalelog.txt" For Output As #2
            Write #2, "R3", splitData(16)
            Close #2
        Wend
        Close #1
        rFile = ""
    End If
    
    'add activity record for invalid address non-split borrowers
    If (FileLen("T:\PUTSALE.R4.txt") > 0) And (rFile = "R4" Or rFile = "") Then
        'open data file and read in header row
        Open "T:\PUTSALE.R4.txt" For Input As #1
        Input #1, rowData
        
        'advance to last record processed if in recovery
        If rFile = "R4" Then
            Do
                Input #1, rowData
                If rowData = rSSN Then Exit Do
            Loop
        End If
        
        'process records
        While Not EOF(1)
            Input #1, rowData
            SP.Common.ATD22AllLoans rowData, "PUTSL", "PUT loan sale letter not mailed to non-split borrower due to invalid address.", "PUTSALELTR", UserID

            'update log
            Open LogFolder & "putsalelog.txt" For Output As #2
            Write #2, "R4", rowData
            Close #2
        Wend
        Close #1
        rFile = ""
    End If
    
    'add activity record for invalid address split borrowers
    If (FileLen("T:\PUTSALE.R5.txt") > 0) And (rFile = "R5" Or rFile = "") Then
        'open data file and read in header row
        Open "T:\PUTSALE.R5.txt" For Input As #1
        Input #1, rowData
        
        'advance to last record processed if in recovery
        If rFile = "R5" Then
            Do
                Input #1, rowData
                If rowData = rSSN Then Exit Do
            Loop
        End If
        
        'process records
        While Not EOF(1)
            Input #1, rowData
            SP.Common.ATD22AllLoans rowData, "PUTSP", "PUT loan sale letter not mailed to split borrower due to invalid address.", "PUTSALELTR", UserID

            'update log
            Open LogFolder & "putsalelog.txt" For Output As #2
            Write #2, "R5", rowData
            Close #2
        Wend
        Close #1
        rFile = ""
    End If
    
    'image non-split borrower docs
    If (FileLen("T:\PUTSALE.R2.txt") > 0) And (rFile = "R6" Or rFile = "") Then
        SP.Common.ImageDocs 12, "PUTSL", DocFolder, "PUTSALE", "T:\PUTSALE.R2.txt"
        
        'update log
        Open LogFolder & "putsalelog.txt" For Output As #2
        Write #2, "R6", ""
        Close #2
        rFile = ""
    End If
    
    'image split borrower docs
    If (FileLen("T:\PUTSALE.R3.txt") > 0) And (rFile = "R7" Or rFile = "") Then
        SP.Common.ImageDocs 16, "PUTSP", DocFolder, "PUTSALESP", "T:\PUTSALE.R3.txt"
        
        'update log
        Open LogFolder & "putsalelog.txt" For Output As #2
        Write #2, "R7", ""
        Close #2
        rFile = ""
    End If
    
    'delete files from X and C drives
    Kill ftpFolder & "PUTSALE.R2.txt"
    'Kill "C:\Windows\Temp\PUTSALE.R2.txt"
    Kill ftpFolder & "PUTSALE.R3.txt"
    'Kill "C:\Windows\Temp\PUTSALE.R3.txt"
    Kill ftpFolder & "PUTSALE.R4.txt"
    'Kill "C:\Windows\Temp\PUTSALE.R4.txt"
    Kill ftpFolder & "PUTSALE.R5.txt"
    'Kill "C:\Windows\Temp\PUTSALE.R5.txt"
    Kill LogFolder & "putsalelog.txt"
    
    If Not SP.Common.CalledByMBS Then
        MsgBox "Reset the default properties of your printer if you do not want the setting left to duplex.", vbOKOnly + vbExclamation, "Duplex Printing Setup"
    End If
    
    ProcComp "MBSPUTSALELTR.TXT"
End Sub
