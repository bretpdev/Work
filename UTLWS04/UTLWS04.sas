/*UTLWS04 - REPAYMENT SCHEDULES NOT PRINTED DUE TO PAST INVALID ADDRESS*/
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/

%LET RPTLIB = T:\SAS;
FILENAME REPORTZ "&RPTLIB/ULWS04.LWS04RZ";
FILENAME REPORT2 "&RPTLIB/ULWS04.LWS04R2";

libname  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=work  ;
RSUBMIT;
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;
OPTIONS NOCENTER NODATE NONUMBER LS=132;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE RPINV AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT A.LF_LON_CUR_OWN
	,A.BF_SSN
	,E.DM_PRS_LST AS NAME
	,A.LN_SEQ
	,A.LA_CUR_PRI
	,A.IC_LON_PGM
	,LN66.LA_RPS_ISL
FROM  OLWHRM1.LN10_LON A 
INNER JOIN OLWHRM1.LN65_LON_RPS B
	ON A.BF_SSN = B.BF_SSN
	AND A.LN_SEQ = B.LN_SEQ
	AND B.LC_STA_LON65 = 'A'
INNER JOIN OLWHRM1.LN66_LON_RPS_SPF LN66
	ON B.BF_SSN = LN66.BF_SSN
	AND B.LN_SEQ = LN66.LN_SEQ
	AND B.LN_RPS_SEQ = LN66.LN_RPS_SEQ
	AND LN66.LN_GRD_RPS_SEQ = 1
INNER JOIN OLWHRM1.RS10_BR_RPD C
	ON A.BF_SSN = C.BF_SSN
	AND B.LN_RPS_SEQ = C.LN_RPS_SEQ
	AND C.LC_STA_RPST10 = 'A'
INNER JOIN OLWHRM1.DW01_DW_CLC_CLU D
	ON A.BF_SSN = D.BF_SSN
	AND A.LN_SEQ = D.LN_SEQ
INNER JOIN OLWHRM1.PD10_PRS_NME E
	ON A.BF_SSN = E.DF_PRS_ID
INNER JOIN OLWHRM1.PD30_PRS_ADR F
	ON A.BF_SSN = F.DF_PRS_ID
	AND F.DC_ADR = 'L'
	AND F.DI_VLD_ADR = 'Y'
WHERE A.LC_STA_LON10 = 'R'
AND A.LI_CON_PAY_STP_PUR <> 'Y'
AND D.WC_DW_LON_STA NOT IN 
	('06','07','08','11','12','16','17','18','19','20''21','22')
AND C.LD_STA_RPST10 IS NOT NULL
AND C.LC_RPS_OPT_PRT = 'I'

AND NOT(
	EXISTS (
			SELECT *
			FROM OLWHRM1.AY10_BR_LON_ATY X
			WHERE X.BF_SSN = A.BF_SSN
			AND X.LC_STA_ACTY10 = 'A'
			AND X.PF_REQ_ACT = 'RPY35'
			AND X.PF_RSP_ACT = 'COMPL'
		)
	AND EXISTS (
			SELECT *
			FROM OLWHRM1.AY10_BR_LON_ATY X
			WHERE X.BF_SSN = A.BF_SSN
			AND X.LC_STA_ACTY10 = 'A'
			AND X.PF_REQ_ACT = 'B314Q'
			AND X.PF_RSP_ACT = 'PRNTD'
			AND X.LD_ATY_RSP > C.LD_STA_RPST10
		)
	)
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;

LIBNAME SAS_TAB V8 '/sas/whse/progrevw';
DATA SAS_TAB.RPINV(KEEP=BF_SSN);
	SET RPINV;
RUN;

/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWS04.LWS04RZ);*/
/*QUIT;*/
ENDRSUBMIT  ;
DATA RPINV; 
SET WORKLOCL.RPINV; 
RUN;

PROC SORT DATA=RPINV;
BY BF_SSN LN_SEQ;
RUN;

DATA _NULL_;
CALL SYMPUT('RUNDATE',PUT(INTNX('DAY',TODAY(),0,'beginning'), MMDDYY10.));
RUN;

PROC PRINTTO PRINT=REPORT2 NEW;
RUN;
OPTIONS CENTER NODATE NUMBER PAGENO=1 LS=132;
TITLE 'REPAYMENT SCHEDULES NOT PRINTED';
TITLE2 "&RUNDATE";
PROC CONTENTS DATA=RPINV OUT=EMPTYSET NOPRINT;
DATA _NULL_;
SET EMPTYSET;
FILE PRINT ;
IF  NOBS=0 AND _N_ =1 THEN DO;
	PUT // 132*'-';
	PUT      ////////
		@51 '**** NO OBSERVATIONS FOUND ****';
	PUT ////////
		@57 '-- END OF REPORT --';
	PUT ////////////////
		@46 "JOB = UTLWS04     REPORT = ULWS04.LWS04R2";
	END;
RETURN;
RUN;
PROC PRINT DATA=RPINV NOOBS SPLIT='/' WIDTH=UNIFORM WIDTH=MIN;  
VAR LF_LON_CUR_OWN BF_SSN NAME LN_SEQ LA_CUR_PRI IC_LON_PGM LA_RPS_ISL;
LABEL LF_LON_CUR_OWN='OWNER' BF_SSN='SSN' NAME='NAME' LN_SEQ='LOAN SEQ #'
LA_CUR_PRI='PRINCIPAL BALANCE' IC_LON_PGM='LOAN TYPE' LA_RPS_ISL='INSTALLMENT AMOUNT';
FORMAT LA_CUR_PRI LA_RPS_ISL COMMA10.2;
FOOTNOTE  'JOB = UTLWS04     REPORT = ULWS04.LWS04R2';
RUN;

PROC PRINTTO;
RUN;
