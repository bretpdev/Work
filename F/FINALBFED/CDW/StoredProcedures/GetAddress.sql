CREATE PROCEDURE [finalbfed].[GetAddress]
	@AccountNumber VARCHAR(10),
	@IsCoborrower BIT = 0
AS
BEGIN

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @IsCoborrower = 0
	BEGIN
		SELECT
			LTRIM(RTRIM(PD10.DM_PRS_1)) AS DM_PRS_1,
			LTRIM(RTRIM(PD10.DM_PRS_LST)) AS DM_PRS_LST,
			LTRIM(RTRIM(PD10.DM_PRS_1)) + ' ' + LTRIM(RTRIM(PD10.DM_PRS_LST)) AS Name,
			LTRIM(RTRIM(PD30.DX_STR_ADR_1)) AS Address1,
			LTRIM(RTRIM(PD30.DX_STR_ADR_2)) AS Address2,
			CASE WHEN LEN(LTRIM(RTRIM(PD30.DF_ZIP_CDE))) = 9 
				THEN LTRIM(RTRIM(PD30.DM_CT)) + ' ' + LTRIM(RTRIM(PD30.DC_DOM_ST)) + '  ' + LEFT(LTRIM(RTRIM(PD30.DF_ZIP_CDE)), 5) + '-' + RIGHT(LTRIM(RTRIM(PD30.DF_ZIP_CDE)), 4)
				ELSE LTRIM(RTRIM(PD30.DM_CT)) + ' ' + LTRIM(RTRIM(PD30.DC_DOM_ST)) + '  ' + LTRIM(RTRIM(PD30.DF_ZIP_CDE))
			END AS CityStateZip,
			LTRIM(RTRIM(PD30.DM_FGN_ST)) AS ForeignState,
			LTRIM(RTRIM(PD30.DM_FGN_CNY)) AS Country,
			CASE WHEN PD30.DI_VLD_ADR = 'Y'
				THEN 1
				ELSE 0
			END AS HasValidAddress
		FROM
			dbo.PD10_PRS_NME PD10
			INNER JOIN dbo.PD30_PRS_ADR PD30 
				ON PD30.DF_PRS_ID = PD10.DF_PRS_ID
				AND PD30.DC_ADR = 'L'
		WHERE
			PD10.DF_SPE_ACC_ID = @AccountNumber
	END
ELSE
	BEGIN
		SELECT DISTINCT
			LTRIM(RTRIM(ENDR.DM_PRS_1)) AS DM_PRS_1,
			LTRIM(RTRIM(ENDR.DM_PRS_LST)) AS DM_PRS_LST,
			LTRIM(RTRIM(ENDR.DM_PRS_1)) + ' ' + LTRIM(RTRIM(ENDR.DM_PRS_LST)) AS Name,
			LTRIM(RTRIM(ADDR.DX_STR_ADR_1)) AS Address1,
			LTRIM(RTRIM(ADDR.DX_STR_ADR_2)) AS Address2,
			CASE WHEN LEN(LTRIM(RTRIM(ADDR.DF_ZIP_CDE))) = 9 
				THEN LTRIM(RTRIM(ADDR.DM_CT)) + ' ' + LTRIM(RTRIM(ADDR.DC_DOM_ST)) + '  ' + LEFT(LTRIM(RTRIM(ADDR.DF_ZIP_CDE)), 5) + '-' + RIGHT(LTRIM(RTRIM(ADDR.DF_ZIP_CDE)), 4)
				ELSE LTRIM(RTRIM(ADDR.DM_CT)) + ' ' + LTRIM(RTRIM(ADDR.DC_DOM_ST)) + '  ' + LTRIM(RTRIM(ADDR.DF_ZIP_CDE))
			END AS CityStateZip,
			LTRIM(RTRIM(ADDR.DM_FGN_ST)) AS ForeignState,
			LTRIM(RTRIM(ADDR.DM_FGN_CNY)) AS Country,
			CASE WHEN ADDR.DI_VLD_ADR = 'Y'
				THEN 1
				ELSE 0
			END AS HasValidAddress
		FROM
			dbo.PD10_PRS_NME ENDR
			INNER JOIN dbo.LN20_EDS LN20
				ON LN20.LF_EDS = ENDR.DF_PRS_ID
				AND LN20.LC_STA_LON20 = 'A'
				AND LN20.LC_EDS_TYP = 'M'
			INNER JOIN dbo.PD30_PRS_ADR ADDR 
				ON ADDR.DF_PRS_ID = ENDR.DF_PRS_ID
				AND ADDR.DC_ADR = 'L'
			INNER JOIN dbo.PD10_PRS_NME BORR
				ON BORR.DF_PRS_ID = LN20.BF_SSN
			INNER JOIN dbo.LT20_LTR_REQ_PRC_Coborrower LT20Pending --coborrowers that coborrower for multiple borrowers handling
				ON LT20Pending.Borrower_DF_SPE_ACC_ID = BORR.DF_SPE_ACC_ID
				AND LT20Pending.DF_SPE_ACC_ID = @AccountNumber
				AND 
				(
					(
						LT20Pending.PrintedAt IS NULL 
						AND LT20Pending.OnEcorr = 0
					) 
					OR LT20Pending.EcorrDocumentCreatedAt IS NULL
				)
				AND LT20Pending.InactivatedAt IS NULL
		WHERE
			ENDR.DF_SPE_ACC_ID = @AccountNumber
	END
END