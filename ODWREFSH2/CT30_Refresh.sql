USE ODW
GO

DECLARE 
	@LoopCount TINYINT = 0

RefreshStart:

--does a full refresh because refresh of CT30.IF_CRT_DTS_CT30 > @LastRefresh takes too long
--DECLARE @LastRefresh VARCHAR(30) = (SELECT CONVERT(VARCHAR(30), ISNULL(DATEADD(HOUR,-3,CAST(MAX(CT30.IF_CRT_DTS_CT30) AS DATETIME)), '1-1-1900 00:00:00'), 21) FROM CT30_CALL_QUE CT30)
--PRINT 'Last Refreshed at: ' + @LastRefresh

DECLARE @SQLStatement VARCHAR(MAX) = 
'
		MERGE 
			dbo.CT30_CALL_QUE LOCAL
		USING
			(
				SELECT
					*
				FROM
					OPENQUERY
					(
						DUSTER,
						''
							SELECT
								REMOTE.*
							FROM
								OLWHRM1.CT30_CALL_QUE REMOTE
						''

					)
			) R ON R.DF_PRS_ID_BR = LOCAL.DF_PRS_ID_BR AND R.DX_TGT_TZ = LOCAL.DX_TGT_TZ AND R.IC_REC_TYP = LOCAL.IC_REC_TYP AND R.IF_CRT_DTS_CT30 = LOCAL.IF_CRT_DTS_CT30 AND R.IF_WRK_GRP = LOCAL.IF_WRK_GRP
		WHEN MATCHED THEN 
		UPDATE SET 
			LOCAL.LN_DAY_DLQ_CNT = R.LN_DAY_DLQ_CNT,
			LOCAL.DF_PRS_ID_TGT = R.DF_PRS_ID_TGT,
			LOCAL.DM_TGT_PRS_LST = R.DM_TGT_PRS_LST,
			LOCAL.DM_TGT_PRS_1 = R.DM_TGT_PRS_1,
			LOCAL.DM_TGT_PRS_MID = R.DM_TGT_PRS_MID,
			LOCAL.DX_TGT_STR_ADR_1 = R.DX_TGT_STR_ADR_1,
			LOCAL.DX_TGT_STR_ADR_2 = R.DX_TGT_STR_ADR_2,
			LOCAL.DM_TGT_CT = R.DM_TGT_CT,
			LOCAL.DC_TGT_DOM_ST = R.DC_TGT_DOM_ST,
			LOCAL.DF_TGT_ZIP = R.DF_TGT_ZIP,
			LOCAL.DI_TGT_VLD_ADR = R.DI_TGT_VLD_ADR,
			LOCAL.LA_OTS_BAL = R.LA_OTS_BAL,
			LOCAL.LD_PAY_DU = R.LD_PAY_DU,
			LOCAL.LA_PAY_DU = R.LA_PAY_DU,
			LOCAL.LD_LST_WRK = R.LD_LST_WRK,
			LOCAL.DN_TGT_PHN = R.DN_TGT_PHN,
			LOCAL.LD_LST_PAY = R.LD_LST_PAY,
			LOCAL.IN_DAY_LFT_CMP = R.IN_DAY_LFT_CMP,
			LOCAL.LD_LST_ATT = R.LD_LST_ATT,
			LOCAL.LD_LST_CNC = R.LD_LST_CNC,
			LOCAL.LC_TGT_REL_BR = R.LC_TGT_REL_BR,
			LOCAL.BM_PRS_LST = R.BM_PRS_LST,
			LOCAL.BM_PRS_1 = R.BM_PRS_1,
			LOCAL.BM_PRS_MID = R.BM_PRS_MID,
			LOCAL.DN_TGT_ALT_PHN = R.DN_TGT_ALT_PHN,
			LOCAL.DD_SKP_SR = R.DD_SKP_SR,
			LOCAL.BM_PRS_1_RGRD = R.BM_PRS_1_RGRD,
			LOCAL.BM_PRS_MID_RGRD = R.BM_PRS_MID_RGRD,
			LOCAL.BM_PRS_LST_RGRD = R.BM_PRS_LST_RGRD,
			LOCAL.DF_PRS_ID_RGRD = R.DF_PRS_ID_RGRD,
			LOCAL.LC_RGRD_REL_BR = R.LC_RGRD_REL_BR,
			LOCAL.IN_COL_QUE_SRT_PRY = R.IN_COL_QUE_SRT_PRY,
			LOCAL.II_CTC_DAY = R.II_CTC_DAY,
			LOCAL.II_EMP_INF = R.II_EMP_INF,
			LOCAL.DA_QTR_WGE = R.DA_QTR_WGE,
			LOCAL.IF_LST_USR_CT30 = R.IF_LST_USR_CT30,
			LOCAL.IC_TSK_STA = R.IC_TSK_STA,
			LOCAL.IT_TSK_SR = R.IT_TSK_SR,
			LOCAL.IT_TSK_END = R.IT_TSK_END,
			LOCAL.BN_TOT_LON = R.BN_TOT_LON,
			LOCAL.DD_BRT_BR = R.DD_BRT_BR,
			LOCAL.DM_FGN_CNY_TGT = R.DM_FGN_CNY_TGT,
			LOCAL.DT_PHN_BCL_TGT = R.DT_PHN_BCL_TGT,
			LOCAL.DX_STR_ADR_1_BR = R.DX_STR_ADR_1_BR,
			LOCAL.DX_STR_ADR_2_BR = R.DX_STR_ADR_2_BR,
			LOCAL.DM_CT_BR = R.DM_CT_BR,
			LOCAL.DC_DOM_ST_BR = R.DC_DOM_ST_BR,
			LOCAL.DF_ZIP_BR = R.DF_ZIP_BR,
			LOCAL.DM_FGN_CNY_BR = R.DM_FGN_CNY_BR,
			LOCAL.DI_VLD_ADR_BR = R.DI_VLD_ADR_BR,
			LOCAL.IM_IST_SHO_SCL_STU = R.IM_IST_SHO_SCL_STU,
			LOCAL.DN_PHN_BR = R.DN_PHN_BR,
			LOCAL.DC_FGN_PHN_BR = R.DC_FGN_PHN_BR,
			LOCAL.DC_FGN_ALT_PHN_BR = R.DC_FGN_ALT_PHN_BR,
			LOCAL.DX_EVT_CMT_QUE = R.DX_EVT_CMT_QUE,
			LOCAL.IF_IST_TGT = R.IF_IST_TGT,
			LOCAL.IM_IST_SHO_TGT = R.IM_IST_SHO_TGT,
			LOCAL.II_SKP_RQU = R.II_SKP_RQU,
			LOCAL.LN_DAY_IN_SKP = R.LN_DAY_IN_SKP,
			LOCAL.DF_CRT_DTS_PD40 = R.DF_CRT_DTS_PD40,
			LOCAL.DF_SPE_ACC_ID = R.DF_SPE_ACC_ID,
			LOCAL.LC_CDF_DTE_RNG = R.LC_CDF_DTE_RNG,
			LOCAL.II_1ST_TME_PCL = R.II_1ST_TME_PCL,
			LOCAL.II_MNL_DL = R.II_MNL_DL,
			LOCAL.DC_PRI_PHN_ALW = R.DC_PRI_PHN_ALW,
			LOCAL.DC_ALT_PHN_ALW = R.DC_ALT_PHN_ALW,
			LOCAL.LC_ORG_GTR = R.LC_ORG_GTR,
			LOCAL.DN_TGT_OTH_PHN = R.DN_TGT_OTH_PHN,
			LOCAL.DC_FGN_OTH_PHN_BR = R.DC_FGN_OTH_PHN_BR,
			LOCAL.DC_OTH_PHN_ALW = R.DC_OTH_PHN_ALW	
		WHEN NOT MATCHED THEN
			INSERT 
		(
			IF_WRK_GRP,
			IC_REC_TYP,
			DX_TGT_TZ,
			DF_PRS_ID_BR,
			IF_CRT_DTS_CT30,
			LN_DAY_DLQ_CNT,
			DF_PRS_ID_TGT,
			DM_TGT_PRS_LST,
			DM_TGT_PRS_1,
			DM_TGT_PRS_MID,
			DX_TGT_STR_ADR_1,
			DX_TGT_STR_ADR_2,
			DM_TGT_CT,
			DC_TGT_DOM_ST,
			DF_TGT_ZIP,
			DI_TGT_VLD_ADR,
			LA_OTS_BAL,
			LD_PAY_DU,
			LA_PAY_DU,
			LD_LST_WRK,
			DN_TGT_PHN,
			LD_LST_PAY,
			IN_DAY_LFT_CMP,
			LD_LST_ATT,
			LD_LST_CNC,
			LC_TGT_REL_BR,
			BM_PRS_LST,
			BM_PRS_1,
			BM_PRS_MID,
			DN_TGT_ALT_PHN,
			DD_SKP_SR,
			BM_PRS_1_RGRD,
			BM_PRS_MID_RGRD,
			BM_PRS_LST_RGRD,
			DF_PRS_ID_RGRD,
			LC_RGRD_REL_BR,
			IN_COL_QUE_SRT_PRY,
			II_CTC_DAY,
			II_EMP_INF,
			DA_QTR_WGE,
			IF_LST_USR_CT30,
			IC_TSK_STA,
			IT_TSK_SR,
			IT_TSK_END,
			BN_TOT_LON,
			DD_BRT_BR,
			DM_FGN_CNY_TGT,
			DT_PHN_BCL_TGT,
			DX_STR_ADR_1_BR,
			DX_STR_ADR_2_BR,
			DM_CT_BR,
			DC_DOM_ST_BR,
			DF_ZIP_BR,
			DM_FGN_CNY_BR,
			DI_VLD_ADR_BR,
			IM_IST_SHO_SCL_STU,
			DN_PHN_BR,
			DC_FGN_PHN_BR,
			DC_FGN_ALT_PHN_BR,
			DX_EVT_CMT_QUE,
			IF_IST_TGT,
			IM_IST_SHO_TGT,
			II_SKP_RQU,
			LN_DAY_IN_SKP,
			DF_CRT_DTS_PD40,
			DF_SPE_ACC_ID,
			LC_CDF_DTE_RNG,
			II_1ST_TME_PCL,
			II_MNL_DL,
			DC_PRI_PHN_ALW,
			DC_ALT_PHN_ALW,
			LC_ORG_GTR,
			DN_TGT_OTH_PHN,
			DC_FGN_OTH_PHN_BR,
			DC_OTH_PHN_ALW
		)
		VALUES 
		(
			R.IF_WRK_GRP,
			R.IC_REC_TYP,
			R.DX_TGT_TZ,
			R.DF_PRS_ID_BR,
			R.IF_CRT_DTS_CT30,
			R.LN_DAY_DLQ_CNT,
			R.DF_PRS_ID_TGT,
			R.DM_TGT_PRS_LST,
			R.DM_TGT_PRS_1,
			R.DM_TGT_PRS_MID,
			R.DX_TGT_STR_ADR_1,
			R.DX_TGT_STR_ADR_2,
			R.DM_TGT_CT,
			R.DC_TGT_DOM_ST,
			R.DF_TGT_ZIP,
			R.DI_TGT_VLD_ADR,
			R.LA_OTS_BAL,
			R.LD_PAY_DU,
			R.LA_PAY_DU,
			R.LD_LST_WRK,
			R.DN_TGT_PHN,
			R.LD_LST_PAY,
			R.IN_DAY_LFT_CMP,
			R.LD_LST_ATT,
			R.LD_LST_CNC,
			R.LC_TGT_REL_BR,
			R.BM_PRS_LST,
			R.BM_PRS_1,
			R.BM_PRS_MID,
			R.DN_TGT_ALT_PHN,
			R.DD_SKP_SR,
			R.BM_PRS_1_RGRD,
			R.BM_PRS_MID_RGRD,
			R.BM_PRS_LST_RGRD,
			R.DF_PRS_ID_RGRD,
			R.LC_RGRD_REL_BR,
			R.IN_COL_QUE_SRT_PRY,
			R.II_CTC_DAY,
			R.II_EMP_INF,
			R.DA_QTR_WGE,
			R.IF_LST_USR_CT30,
			R.IC_TSK_STA,
			R.IT_TSK_SR,
			R.IT_TSK_END,
			R.BN_TOT_LON,
			R.DD_BRT_BR,
			R.DM_FGN_CNY_TGT,
			R.DT_PHN_BCL_TGT,
			R.DX_STR_ADR_1_BR,
			R.DX_STR_ADR_2_BR,
			R.DM_CT_BR,
			R.DC_DOM_ST_BR,
			R.DF_ZIP_BR,
			R.DM_FGN_CNY_BR,
			R.DI_VLD_ADR_BR,
			R.IM_IST_SHO_SCL_STU,
			R.DN_PHN_BR,
			R.DC_FGN_PHN_BR,
			R.DC_FGN_ALT_PHN_BR,
			R.DX_EVT_CMT_QUE,
			R.IF_IST_TGT,
			R.IM_IST_SHO_TGT,
			R.II_SKP_RQU,
			R.LN_DAY_IN_SKP,
			R.DF_CRT_DTS_PD40,
			R.DF_SPE_ACC_ID,
			R.LC_CDF_DTE_RNG,
			R.II_1ST_TME_PCL,
			R.II_MNL_DL,
			R.DC_PRI_PHN_ALW,
			R.DC_ALT_PHN_ALW,
			R.LC_ORG_GTR,
			R.DN_TGT_OTH_PHN,
			R.DC_FGN_OTH_PHN_BR,
			R.DC_OTH_PHN_ALW
		)
		-- !!! uncomment lines below ONLY when doing a full table refresh 
		WHEN NOT MATCHED BY SOURCE THEN
		    DELETE
			
;
'


PRINT @SQLStatement
EXEC (@SQLStatement)


-- ###### VALIDATION
DECLARE 
	@CountDifference INT

SELECT
	@CountDifference = L.LocalCount - R.RemoteCount
FROM
	OPENQUERY
	(
		duster,
		'
			SELECT
				COUNT(*) AS "RemoteCount"
			FROM
				OLWHRM1. CT30_CALL_QUE CT30
		'	
	) R
	FULL OUTER JOIN
	(
		SELECT
			COUNT(*) [LocalCount]
		FROM
			dbo. CT30_CALL_QUE CT30
	) L ON 1 = 1
	
IF @CountDifference != 0 AND @LoopCount > 0
	BEGIN
		RAISERROR(' CT30_CALL_QUE - The remote and local record counts do not match.  The local count is off by %i records.  A full refresh of the table is required.', 16, 11, @CountDifference)
	END
ELSE IF @CountDifference != 0 AND @LoopCount = 0
	BEGIN

		PRINT 'Loop Count:  ' + CAST(@LoopCount AS VARCHAR(2))

		SET @LoopCount = @LoopCount + 1

		GOTO RefreshStart;

	END
