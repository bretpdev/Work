*----------------------------*
| UTLWR02 WRITE UP QC REPORT |
*----------------------------*;
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWR02.LWR02R2";
FILENAME REPORTZ "&RPTLIB/ULWR02.LWR02RZ";
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE WUQCR AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT B.DF_SPE_ACC_ID
	,B.DM_PRS_LST
	,A.LN_SEQ
	,A.LD_FAT_EFF
	,COALESCE(LA_FAT_LTE_FEE,0) + 
		 COALESCE(LA_FAT_ILG_PRI,0) + 
		 COALESCE(LA_FAT_CUR_PRI,0) + 
		 COALESCE(LA_FAT_NSI,0) AS WUTX_LN
FROM OLWHRM1.LN90_FIN_ATY A
INNER JOIN (
	SELECT BF_SSN
		,PC_FAT_TYP
		,PC_FAT_SUB_TYP 
		,LC_CSH_ADV
		,LC_STA_LON90 
		,LC_FAT_REV_REA 
		,LD_FAT_EFF
		,SUM(
			COALESCE(LA_FAT_LTE_FEE,0) + 
			COALESCE(LA_FAT_ILG_PRI,0) + 
			COALESCE(LA_FAT_CUR_PRI,0) + 
			COALESCE(LA_FAT_NSI,0) 
			) AS WUTX
	FROM OLWHRM1.LN90_FIN_ATY 
	GROUP BY BF_SSN
		,PC_FAT_TYP
		,PC_FAT_SUB_TYP 
		,LC_CSH_ADV
		,LC_STA_LON90 
		,LC_FAT_REV_REA 
		,LD_FAT_EFF
	) C
	ON A.BF_SSN = C.BF_SSN
	AND A.LD_FAT_EFF = C.LD_FAT_EFF
	AND A.PC_FAT_TYP = C.PC_FAT_TYP
	AND A.PC_FAT_SUB_TYP = C.PC_FAT_SUB_TYP
	AND A.LC_CSH_ADV = C.LC_CSH_ADV 
	AND A.LC_STA_LON90 = C.LC_STA_LON90
	AND A.LC_FAT_REV_REA = C.LC_FAT_REV_REA
INNER JOIN OLWHRM1.PD10_PRS_NME B
	ON A.BF_SSN = B.DF_PRS_ID
WHERE A.PC_FAT_TYP = '60'
AND A.PC_FAT_SUB_TYP = '02'
AND A.LC_CSH_ADV = 'A'
AND A.LC_STA_LON90 = 'A'
AND A.LC_FAT_REV_REA = ''
AND C.WUTX >= 5
AND NOT EXISTS (
	SELECT *
	FROM OLWHRM1.AY10_BR_LON_ATY X
	WHERE X.BF_SSN = A.BF_SSN
	AND X.LC_STA_ACTY10 = 'A'
	AND X.PF_REQ_ACT = 'SMBWU'
	AND X.LD_ATY_REQ_RCV >= A.LD_FAT_EFF 
	)
ORDER BY B.DF_SPE_ACC_ID
	,A.LN_SEQ
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWR02.LWR02RZ);*/
/*QUIT;*/
ENDRSUBMIT;
DATA WUQCR;
	SET WORKLOCL.WUQCR;
RUN;
DATA _NULL_;
	SET WUQCR ;
	LENGTH DESCRIPTION $600.;
	USER = '';
	ACT_DT = LD_FAT_EFF;
	DESCRIPTION = CATX(',',DF_SPE_ACC_ID,DM_PRS_LST,LN_SEQ);
	FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT USER $10. ;
	FORMAT ACT_DT MMDDYY10. ;
	FORMAT DESCRIPTION $600. ;
	IF _N_ = 1 THEN DO;
		PUT "USER,ACT_DT,DESCRIPTION";
	END;
	DO;
	   PUT USER $ @;
	   PUT ACT_DT @;
	   PUT DESCRIPTION $ ;
	END;
RUN;
