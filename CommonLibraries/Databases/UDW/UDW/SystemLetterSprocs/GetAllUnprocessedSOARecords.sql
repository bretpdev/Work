CREATE PROCEDURE [dbo].[GetAllUnprocessedSOARecords]
	
AS
	
SELECT DISTINCT
		LT20.DF_SPE_ACC_ID,
		LT20.RM_APL_PGM_PRC,
		LT20.RT_RUN_SRT_DTS_PRC,
		LT20.RN_SEQ_LTR_CRT_PRC, 
		LT20.RM_DSC_LTR_PRC,
		LT20.RF_SBJ_PRC,
		CASE
			WHEN DW01.DF_SPE_ACC_ID IS NULL THEN 0
			ELSE 1
		END AS InvalidLoanStatus,
		'' AS EndorsersSsn,
		LT20.OnEcorr,
		ISNULL(PH05.DX_CNC_EML_ADR, 'ecorr@utahsbr.edu') AS EmailAddress,
		'Monday - Friday 8 AM - 5 PM MT' AS Hours1,
		'' AS Hours2,
		LT20.PrintedAt,
		LT20.EcorrDocumentCreatedAt
	FROM
		UDW..LT20_LTR_REQ_PRC LT20
		INNER JOIN
		(
			SELECT
				LT20.DF_SPE_ACC_ID,
				LT20.RM_APL_PGM_PRC,
				LT20.RT_RUN_SRT_DTS_PRC,
				LT20.RN_SEQ_LTR_CRT_PRC,
				LT20.RN_SEQ_REC_PRC,
				LT20.RX_REQ_ARA_1_PRC
			FROM
				UDW..LT20_LTR_REQ_PRC LT20
				INNER JOIN
				(
					SELECT
						LT20.DF_SPE_ACC_ID,
						LT20.RM_APL_PGM_PRC,
						LT20.RT_RUN_SRT_DTS_PRC,
						LT20.RN_SEQ_LTR_CRT_PRC,
						MIN(LT20.RN_SEQ_REC_PRC) AS RN_SEQ_REC_PRC
					FROM
						UDW..LT20_LTR_REQ_PRC LT20
					GROUP BY
						LT20.DF_SPE_ACC_ID,
						LT20.RM_APL_PGM_PRC,
						LT20.RT_RUN_SRT_DTS_PRC,
						LT20.RN_SEQ_LTR_CRT_PRC
				) MIN_REC
					ON MIN_REC.DF_SPE_ACC_ID = LT20.DF_SPE_ACC_ID
					AND MIN_REC.RM_APL_PGM_PRC = LT20.RM_APL_PGM_PRC
					AND MIN_REC.RT_RUN_SRT_DTS_PRC = LT20.RT_RUN_SRT_DTS_PRC
					AND MIN_REC.RN_SEQ_LTR_CRT_PRC = LT20.RN_SEQ_LTR_CRT_PRC
					AND MIN_REC.RN_SEQ_REC_PRC = LT20.RN_SEQ_REC_PRC
		) LETTER_TEXT
			ON LETTER_TEXT.DF_SPE_ACC_ID = LT20.DF_SPE_ACC_ID
			AND LETTER_TEXT.RM_APL_PGM_PRC = LT20.RM_APL_PGM_PRC
			AND LETTER_TEXT.RT_RUN_SRT_DTS_PRC = LT20.RT_RUN_SRT_DTS_PRC
			AND LETTER_TEXT.RN_SEQ_LTR_CRT_PRC = LT20.RN_SEQ_LTR_CRT_PRC
			AND LETTER_TEXT.RN_SEQ_REC_PRC = LT20.RN_SEQ_REC_PRC
		LEFT JOIN UDW..PH05_CNC_EML PH05
			ON PH05.DF_SPE_ID = LT20.DF_SPE_ACC_ID
		LEFT JOIN 
		(
			SELECT DISTINCT
				DF_SPE_ACC_ID
			FROM
				UDW..DW01_Loan
			WHERE
				WC_DW_LON_STA IN ('17','19','21')
		) DW01
		ON DW01.DF_SPE_ACC_ID = LT20.DF_SPE_ACC_ID
	WHERE
		((LT20.PrintedAt IS NULL AND LT20.OnEcorr = 0) OR (LT20.EcorrDocumentCreatedAt IS NULL))
		AND LT20.InactivatedAt IS NULL
		AND LT20.RI_LTR_REQ_DEL_PRC = 'N'
		and LT20.RM_DSC_LTR_PRC = 'US06BTSA'


RETURN 0
