
CREATE PROCEDURE [dbo].[LT_US13B9COSI_FormFields]
	@BF_SSN  CHAR(9)
AS
	SELECT DISTINCT
		RTRIM(PD10.DM_PRS_1) + ' ' + RTRIM(PD10.DM_PRS_LST) AS BorrName,
		RTRIM(PD30.DX_STR_ADR_1) AS BorrAddress1,
		RTRIM(PD30.DX_STR_ADR_2) AS BorrAddress2,
		RTRIM(PD30.DM_FGN_CNY) as BorrCountry,
		RTRIM(PD30.DM_CT) AS BorrCity,
		CASE
			WHEN LEN(RTRIM(PD30.DM_FGN_ST)) > 0 THEN  RTRIM(PD30.DM_FGN_ST)
			ELSE RTRIM(PD30.DC_DOM_ST)
		END AS BorrState,
		CASE	
			WHEN LEN(RTRIM(PD30.DF_ZIP_CDE)) = 9 THEN LEFT(PD30.DF_ZIP_CDE, 5) + '-' + RIGHT(RTRIM(PD30.DF_ZIP_CDE), 4)
			ELSE RTRIM(PD30.DF_ZIP_CDE)
		END AS BorrZip,
		COALESCE(H.PHONE,A.PHONE,W.PHONE,M.PHONE,'') AS BorrPhone
	FROM
		UDW..PD10_PRS_NME PD10
		INNER JOIN UDW..PD30_PRS_ADR PD30
			ON PD30.DF_PRS_ID = PD10.DF_PRS_ID	
			AND DC_ADR = 'L'		
		LEFT OUTER JOIN 
		(
			SELECT TOP 1
				DF_PRS_ID,
				DN_DOM_PHN_ARA + DN_DOM_PHN_XCH + DN_DOM_PHN_LCL AS PHONE
			FROM
				UDW..PD42_PRS_PHN 
			WHERE
				DC_PHN = 'H'
			ORDER BY
				DD_PHN_VER DESC
		) H
			ON H.DF_PRS_ID = PD10.DF_PRS_ID
		LEFT OUTER JOIN 
		(
			SELECT TOP 1
				DF_PRS_ID,
				DN_DOM_PHN_ARA + DN_DOM_PHN_XCH + DN_DOM_PHN_LCL AS PHONE
			FROM
				UDW..PD42_PRS_PHN 
			WHERE
				DC_PHN = 'A'
			ORDER BY
				DD_PHN_VER DESC
		) A
			ON A.DF_PRS_ID = PD10.DF_PRS_ID
		LEFT OUTER JOIN 
		(
			SELECT TOP 1 
				DF_PRS_ID,
				DN_DOM_PHN_ARA + DN_DOM_PHN_XCH + DN_DOM_PHN_LCL AS PHONE
			FROM
				UDW..PD42_PRS_PHN 
			WHERE
				DC_PHN = 'W'
			ORDER BY
				DD_PHN_VER DESC
		) W
			ON W.DF_PRS_ID = PD10.DF_PRS_ID
		LEFT OUTER JOIN 
		(
			SELECT TOP 1
				DF_PRS_ID,
				DN_DOM_PHN_ARA + DN_DOM_PHN_XCH + DN_DOM_PHN_LCL AS PHONE
			FROM
				UDW..PD42_PRS_PHN 
			WHERE
				DC_PHN = 'M'
			ORDER BY
				DD_PHN_VER DESC
		) M
			ON M.DF_PRS_ID = PD10.DF_PRS_ID
	WHERE
		PD10.DF_PRS_ID = @BF_SSN

RETURN 0