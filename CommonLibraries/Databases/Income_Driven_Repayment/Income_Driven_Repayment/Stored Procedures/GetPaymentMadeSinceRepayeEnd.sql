CREATE PROCEDURE [dbo].[GetPaymentMadeSinceRepayeEnd]
	@SSN CHAR(9),
	@TESTMODE BIT,
	@RepayeEndDate datetime,
	@LN_SEQ int
AS
	DECLARE @QUERY VARCHAR(MAX), @TSQL VARCHAR(MAX)
	IF @TESTMODE = 1
		SELECT @TSQL = 'SELECT * FROM OPENQUERY(LEGEND_TEST_VUK1,'
	ELSE
		SELECT @TSQL = 'SELECT * FROM OPENQUERY(LEGEND,'
	  SELECT  @QUERY = @TSQL + 
	  '''
		SELECT DISTINCT
			MONTH(LN90.LD_FAT_EFF) AS Month,
			YEAR(LN90.LD_FAT_EFF) AS Year,
			ABS((COALESCE(LA_FAT_NSI,0) + COALESCE(LA_FAT_LTE_FEE,0) + COALESCE(LA_FAT_CUR_PRI,0))) AS Installment
		FROM 
			PKUB.LN90_FIN_ATY LN90 	
		WHERE 
			LN90.BF_SSN = ''''' + @SSN + '''''
			AND LN90.LD_FAT_EFF > '''''+ CONVERT(VARCHAR(10), @RepayeEndDate, 101) +'''''
			AND LN90.LN_SEQ = '''''+ CAST(@LN_SEQ AS VARCHAR(4)) +'''''
			AND LN90.PC_FAT_TYP = ''''10''''
			AND LN90.PC_FAT_SUB_TYP = ''''10''''
	   '')'

      EXEC (@QUERY)
RETURN 0