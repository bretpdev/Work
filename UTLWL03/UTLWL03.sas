/*MONTHLY DISBURSEMENT TOTALS - Lender reports*/
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = C:/WINDOWS/TEMP;
FILENAME REPORTZ "&RPTLIB/ULWL03.LWL03RZ";
FILENAME REPORT2 "&RPTLIB/ULWL03.LWL03R2";
FILENAME REPORT3 "&RPTLIB/ULWL03.LWL03R3";
FILENAME REPORT4 "&RPTLIB/ULWL03.LWL03R4";
FILENAME REPORT5 "&RPTLIB/ULWL03.LWL03R5";
FILENAME REPORT6 "&RPTLIB/ULWL03.LWL03R6";
FILENAME REPORT7 "&RPTLIB/ULWL03.LWL03R7";
FILENAME REPORT8 "&RPTLIB/ULWL03.LWL03R8";
FILENAME REPORT10 "&RPTLIB/ULWL03.LWL03R10";
FILENAME REPORT11 "&RPTLIB/ULWL03.LWL03R11";
FILENAME REPORT12 "&RPTLIB/ULWL03.LWL03R12";
FILENAME REPORT13 "&RPTLIB/ULWL03.LWL03R13";
FILENAME REPORT14 "&RPTLIB/ULWL03.LWL03R14";
FILENAME REPORT15 "&RPTLIB/ULWL03.LWL03R15";
FILENAME REPORT16 "&RPTLIB/ULWL03.LWL03R16";
FILENAME REPORT17 "&RPTLIB/ULWL03.LWL03R17";
FILENAME REPORT18 "&RPTLIB/ULWL03.LWL03R18";
FILENAME REPORT19 "&RPTLIB/ULWL03.LWL03R19";
FILENAME REPORT20 "&RPTLIB/ULWL03.LWL03R20";
FILENAME REPORT21 "&RPTLIB/ULWL03.LWL03R21";
FILENAME REPORT22 "&RPTLIB/ULWL03.LWL03R22";
FILENAME REPORT23 "&RPTLIB/ULWL03.LWL03R23";
FILENAME REPORT24 "&RPTLIB/ULWL03.LWL03R24";
FILENAME REPORT25 "&RPTLIB/ULWL03.LWL03R25";

OPTIONS SYMBOLGEN;
*Date range for roster date:  LAST WORKING DAY OF PVS MONTH 
to NEXT-TO-LAST WORKING DAY OF CURRENT MONTH;
DATA _NULL_;
*TODAY()+3 IS USED IN CASE EOM HAPPENS PRIOR TO THE LAST CALENDAR DAY;
BEGIN = INTNX('MONTH',TODAY()+3,-2,'end');
IF WEEKDAY(BEGIN) = 1 THEN BEGIN = BEGIN - 2;
ELSE IF WEEKDAY(BEGIN) = 7 THEN BEGIN = BEGIN - 1;
CALL SYMPUT('BEGIN',"'"||PUT(BEGIN,MMDDYY10.)||"'");

END = INTNX('MONTH',TODAY()+3,-1,'end');
IF WEEKDAY(END) = 1 THEN END = END - 3;
ELSE IF WEEKDAY(END) = 2 THEN END = END - 3;
ELSE IF WEEKDAY(END) = 3 THEN END = END - 1;
ELSE IF WEEKDAY(END) = 4 THEN END = END - 1;
ELSE IF WEEKDAY(END) = 5 THEN END = END - 1;
ELSE IF WEEKDAY(END) = 6 THEN END = END - 1;
ELSE IF WEEKDAY(END) = 7 THEN END = END - 2;
CALL SYMPUT('END',"'"||PUT(END,MMDDYY10.)||"'");

CALL SYMPUT('EFFDATE',TRIM(LEFT(UPCASE(
	PUT(INTNX('MONTH',TODAY()+3,-1), MONNAME9.)||' '||
	PUT(INTNX('MONTH',TODAY()+3,-1), YEAR4.)))));
RUN;
%SYSLPUT BEGIN = &BEGIN;
%SYSLPUT END = &END;

LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=work  ;
RSUBMIT;

%macro sqlcheck ;
  %if  &sqlxrc ne 0  %then  %do  ;
    data _null_  ;
            file reportz notitles  ;
            put @01 " ********************************************************************* "
              / @01 " ****  The SQL code above has experienced an error.               **** "
              / @01 " ****  The SAS should be reviewed.                                **** "       
              / @01 " ********************************************************************* "
              / @01 " ****  The SQL error code is  &sqlxrc  and the SQL error message  **** "
              / @01 " ****  &sqlxmsg   **** "
              / @01 " ********************************************************************* "
            ;
         run  ;
  %end  ;
%mend  ;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE MODISB AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT C.AF_DOE_LDR
	,E.IM_LDR_FUL
    ,A.IC_LON_PGM
	,COUNT(*) AS COUNT
	,SUM(COALESCE(A.LA_DSB,0) - COALESCE(A.LA_DSB_CAN,0)) AS DISBAMT
	,C.AF_RGL_CAT_LP20
	,H.LC_DSB_FEE AS LC_DSB_FEE_02
	,H.LA_DSB_FEE AS LA_DSB_FEE_02
	,I.LC_DSB_FEE AS LC_DSB_FEE_21
	,I.LA_DSB_FEE AS LA_DSB_FEE_21
	,PL_DISB.DSB_IND
FROM OLWHRM1.LN15_DSB A
INNER JOIN OLWHRM1.AP03_MASTER_APL C 
	ON A.AF_APL_ID = C.AF_APL_ID
INNER JOIN OLWHRM1.LR10_LDR_DMO E
	ON E.IF_DOE_LDR = C.AF_DOE_LDR
INNER JOIN OLWHRM1.LN10_LON F
	ON A.LN_SEQ = F.LN_SEQ
	AND A.BF_SSN = F.BF_SSN
LEFT OUTER JOIN OLWHRM1.LN18_DSB_FEE H
	ON A.BF_SSN = H.BF_SSN
	AND A.LN_BR_DSB_SEQ = H.LN_BR_DSB_SEQ
	AND H.LC_DSB_FEE = '02'
LEFT OUTER JOIN OLWHRM1.LN18_DSB_FEE I
	ON A.BF_SSN = I.BF_SSN
	AND A.LN_BR_DSB_SEQ = I.LN_BR_DSB_SEQ
	AND I.LC_DSB_FEE = '21'
LEFT OUTER JOIN (
	SELECT BF_SSN 
		,LN_SEQ
		,'X' AS DSB_IND
	FROM OLWHRM1.LN15_DSB
	WHERE DAYS(LD_DSB) BETWEEN DAYS('07/01/2006') AND DAYS('08/07/2006')
	AND IC_LON_PGM IN ('PLUS','PLUSGB')
	AND LC_STA_LON15 IN ('1','3')
	AND LC_DSB_TYP = '2'
	AND LA_DSB <> COALESCE(LA_DSB_CAN,0)
	) PL_DISB
	ON A.BF_SSN = PL_DISB.BF_SSN
	AND A.LN_SEQ = PL_DISB.LN_SEQ
WHERE A.LD_DSB_ROS_PRT BETWEEN &BEGIN AND &END
AND (
	 A.LA_DSB_CAN IS NULL
     OR 
	 A.LA_DSB_CAN <> A.LA_DSB
	)
AND A.LC_DSB_TYP = '2'
AND A.LC_LDR_DSB_MDM NOT IN ('F','M','E')
AND A.LC_STA_LON15 IN ('1','3')

GROUP BY C.AF_DOE_LDR, 
	E.IM_LDR_FUL, 
	A.IC_LON_PGM, 
	F.IF_TIR_PCE, 
	C.AF_RGL_CAT_LP20, 
	H.LC_DSB_FEE, 
	H.LA_DSB_FEE, 
	I.LC_DSB_FEE, 
	I.LA_DSB_FEE, 
	PL_DISB.DSB_IND
ORDER BY C.AF_DOE_LDR, F.IF_TIR_PCE, A.IC_LON_PGM

FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
/*%put  sqlxrc= >>> &sqlxrc <<< ||| sqlxmsg= >>> &sqlxmsg >>> ;  ** includes error messages to SAS log  ;*/
/*%sqlcheck;*/
/*quit;*/
ENDRSUBMIT;

DATA MODISB; SET WORKLOCL.MODISB; RUN;

DATA MODISB;
SET MODISB;
IF AF_DOE_LDR = '813760UT' THEN AF_DOE_LDR = '813760';*Key Bank;
ELSE IF AF_DOE_LDR = '820043' THEN AF_DOE_LDR = '829505';*Washington Mutual lender merge;
ELSE AF_DOE_LDR = AF_DOE_LDR;
RUN;

DATA MODISB (DROP=DSB_IND);
SET MODISB;
LENGTH LOC1 $ 4. LOC2 $ 35.;
IF INPUT(AF_RGL_CAT_LP20,BEST12.) <= 1999030 THEN
	LOC1 = '3%';
ELSE IF INPUT(AF_RGL_CAT_LP20,BEST12.) = 2006020 AND (
	DSB_IND = 'X' OR IC_LON_PGM IN ('STFFRD','UNSTFD')) THEN 
	LOC1 = '2%';
ELSE IF INPUT(AF_RGL_CAT_LP20,BEST12.) = 2006020 AND DSB_IND = '' AND IC_LON_PGM IN ('PLUS','PLUSGB') THEN 
	LOC1 = '3%';
ELSE IF INPUT(AF_RGL_CAT_LP20,BEST12.) = 2007020 AND IC_LON_PGM IN ('STFFRD','UNSTFD') THEN 
	LOC1 = '1.5%';
ELSE IF INPUT(AF_RGL_CAT_LP20,BEST12.) = 2008020 AND IC_LON_PGM IN ('STFFRD','UNSTFD') THEN 
	LOC1 = '1%';
ELSE IF INPUT(AF_RGL_CAT_LP20,BEST12.) = 2009020 THEN DO;
	IF IC_LON_PGM IN ('STFFRD','UNSTFD') THEN
		LOC1 = '0.5%';
	ELSE IF  IC_LON_PGM IN ('PLUS','PLUSGB') THEN
		LOC1 = '3%';
END;

IF LA_DSB_FEE_02 = 0 THEN DO;
	IF INPUT(AF_RGL_CAT_LP20,BEST12.) => 2008020 THEN
		LOC2 = 'UHEAA PAID ORIGINATION FEE';
	ELSE 
		LOC2 = 'LOAN WITH ZERO ORIGINATION FEE';
END;

IF LA_DSB_FEE_02 > 0 THEN DO;
	IF INPUT(AF_RGL_CAT_LP20,BEST12.) = 2009020 AND IC_LON_PGM IN ('PLUS', 'PLUSGB') THEN DO;
		IF LA_DSB_FEE_21 = . THEN
			LOC2 = 'LOAN WITH ORIGINATION FEE 3%';
		ELSE IF LA_DSB_FEE_21 > 0 THEN
			LOC2 = 'LOAN WITH ORIG/GUAR FEE 3%/1%';
	END;
	ELSE DO;
		IF LA_DSB_FEE_21 = . THEN
			LOC2 = 'LOAN WITH ORIGINATION FEE 0.5%';
		ELSE IF LA_DSB_FEE_21 > 0 THEN
			LOC2 = 'LOAN WITH ORIG/GUAR FEE 0.5%/1%';
	END;
END;
RUN;

PROC SQL;
CREATE TABLE MODISB_2 AS
SELECT A.AF_DOE_LDR
	,B.IM_LDR_FUL
	,A.IC_LON_PGM
	,SUM(A.COUNT) AS COUNT
	,SUM(A.DISBAMT) AS DISBAMT
	,A.LOC1
	,A.LOC2
FROM MODISB A
LEFT OUTER JOIN (
	SELECT DISTINCT
		AF_DOE_LDR
		,IM_LDR_FUL
	FROM MODISB
	) B
	ON A.AF_DOE_LDR = B.AF_DOE_LDR
GROUP BY A.AF_DOE_LDR, B.IM_LDR_FUL, A.IC_LON_PGM, A.LOC1, A.LOC2
ORDER BY A.AF_DOE_LDR
;
QUIT;


%MACRO PRINT(LENDER=,REPNO=);
DATA MODISBPR;
SET MODISB_2;
WHERE AF_DOE_LDR = "&LENDER";
RUN;

PROC PRINTTO PRINT=REPORT&REPNO NEW;
RUN;

PROC CONTENTS DATA=MODISBPR OUT=EMPTYSET NOPRINT;RUN;

DATA _NULL_;
SET EMPTYSET;
	CALL SYMPUT('OBS',NOBS);
RUN;

%PUT OBS=&OBS;
%IF &OBS = 0 %THEN %DO;
	OPTIONS CENTER NODATE NONUMBER PAGENO=1 ORIENTATION=LANDSCAPE;
	OPTIONS LS=127 PS=39;
	DATA _NULL_;
	SET EMPTYSET;
	FILE PRINT;
	IF  NOBS=0 AND _N_ =1 THEN DO;
	   PUT // 126*'-';
	   PUT      ////////
	       @51 '**** NO OBSERVATIONS FOUND ****';
	   PUT ////////
	       @57 '-- END OF REPORT --';
	   PUT /////////////
	   		@46 "JOB = UTLWL03     REPORT = ULWL03.LWL03R&REPNO";
	   END;
	RETURN;
	TITLE "UTAH HIGHER EDUCATION ASSISTANCE AUTHORITY";
	TITLE2 "MONTHLY DISBURSEMENT TOTALS";
	TITLE3 "FOR &EFFDATE";
	TITLE4 "LENDER: &LENDER";
	RUN;
%END;
%ELSE %DO;
	PROC SORT DATA=MODISBPR;
	BY AF_DOE_LDR LOC2 LOC1 IC_LON_PGM;
	RUN;

	DATA _NULL_;
	SET MODISBPR;
		CALL SYMPUT('TTL',TRIM(AF_DOE_LDR)||' - '||TRIM(IM_LDR_FUL));
	RUN;

	OPTIONS CENTER NODATE NONUMBER PAGENO=1 ORIENTATION=LANDSCAPE;
	OPTIONS LS=127 PS=39;

	PROC REPORT DATA=MODISBPR NOWD HEADSKIP SPLIT='/' SPACING=3;
	COLUMN LOC2 LOC1 IC_LON_PGM COUNT DISBAMT;
	DEFINE LOC2 / GROUP "CATEGORY" WIDTH=32;
	DEFINE LOC1 / GROUP "%" WIDTH=4;
	DEFINE IC_LON_PGM / ORDER "LOAN PROGRAM" WIDTH = 7;
	DEFINE COUNT / ANALYSIS "NUMBER OF DISBURSEMENTS" WIDTH=13 FORMAT = COMMA6.;
	DEFINE DISBAMT / ANALYSIS "TOTAL DISBURSEMENT AMOUNT" WIDTH=13 FORMAT=DOLLAR14.2;
	BREAK AFTER LOC2 / SUMMARIZE SKIP SUPPRESS OL;
	COMPUTE AFTER;
	LINE ' ';
	LINE @1 'TOTAL NUMBER OF DISBURSEMENTS:' @36 COUNT.SUM COMMA6.;
	LINE @1 'TOTAL DISBURSEMENT AMOUNT:' @36 DISBAMT.SUM DOLLAR14.2;
	ENDCOMP;
	TITLE "UTAH HIGHER EDUCATION ASSISTANCE AUTHORITY";
	TITLE2 "MONTHLY DISBURSEMENT TOTALS";
	TITLE3 "FOR &EFFDATE";
	TITLE4 "LENDER: &TTL";
	FOOTNOTE "JOB = UTLWL03     REPORT = ULWL03.LWL03R&REPNO";
	RUN;
%END;
PROC PRINTTO;
RUN;
%MEND PRINT;

%PRINT(LENDER=811698,REPNO=2);
%PRINT(LENDER=813760,REPNO=3);
%PRINT(LENDER=813894,REPNO=4);
%PRINT(LENDER=817440,REPNO=5);
%PRINT(LENDER=817545,REPNO=6);
%PRINT(LENDER=817546,REPNO=7);
%PRINT(LENDER=819628,REPNO=8);
/*%PRINT(LENDER=829505,REPNO=9);*/
%PRINT(LENDER=820200,REPNO=10);
%PRINT(LENDER=822373,REPNO=11);
%PRINT(LENDER=829123,REPNO=12);
%PRINT(LENDER=829158,REPNO=13);
%PRINT(LENDER=830132,REPNO=14);
%PRINT(LENDER=830146,REPNO=15);
%PRINT(LENDER=830791,REPNO=16);
%PRINT(LENDER=832241,REPNO=17);
%PRINT(LENDER=833828,REPNO=18);
%PRINT(LENDER=817455,REPNO=19);
%PRINT(LENDER=817575,REPNO=20);
%PRINT(LENDER=834122,REPNO=21);
%PRINT(LENDER=833577,REPNO=22);
%PRINT(LENDER=834265,REPNO=23);
%PRINT(LENDER=828476,REPNO=24);
%PRINT(LENDER=834370,REPNO=25);

/*----------------------------------*
|          DETAIL FILE              |
*----------------------------------*/
/*RSUBMIT;*/
/*PROC SQL;*/
/*CONNECT TO DB2 (DATABASE=DLGSUTWH);*/
/*CREATE TABLE MOTEST AS*/
/*SELECT **/
/*FROM CONNECTION TO DB2 (*/
/*SELECT A.BF_SSN*/
/*	,LN_BR_DSB_SEQ*/
/*	,C.AF_DOE_LDR*/
/*	,E.IM_LDR_FUL*/
/*    ,A.IC_LON_PGM*/
/*	,(COALESCE (A.LA_DSB,0) - COALESCE (A.LA_DSB_CAN,0)) AS DISBAMT*/
/*	,A.LC_DSB_TYP*/
/*	,A.LC_STA_LON15*/
/*	,a.LD_DSB_ROS_PRT*/
/*	,a.LD_DSB*/
/*	,F.IF_TIR_PCE*/
/*	,C.AF_RGL_CAT_LP20*/
/*FROM OLWHRM1.LN15_DSB A*/
/*INNER JOIN OLWHRM1.AP03_MASTER_APL C */
/*	ON A.AF_APL_ID = C.AF_APL_ID*/
/*INNER JOIN OLWHRM1.LR10_LDR_DMO E*/
/*	ON E.IF_DOE_LDR = C.AF_DOE_LDR*/
/*INNER JOIN OLWHRM1.LN10_LON F*/
/*	ON A.LN_SEQ = F.LN_SEQ*/
/*	AND A.BF_SSN = F.BF_SSN*/
/**/
/*WHERE A.LD_DSB_ROS_PRT BETWEEN &BEGIN AND &END*/
/*AND (A.LA_DSB_CAN IS NULL*/
/*    OR A.LA_DSB_CAN <> A.LA_DSB)*/
/*AND A.LC_DSB_TYP = '2'*/
/*AND A.LC_LDR_DSB_MDM NOT IN ('F','M','E')*/
/*AND A.LC_STA_LON15 IN ('1','3')*/
/*ORDER BY C.AF_DOE_LDR, A.IC_LON_PGM*/
/*);*/
/*DISCONNECT FROM DB2;*/
/*ENDRSUBMIT;*/
/*DATA MOTEST; */
/*SET WORKLOCL.MOTEST; */
/*RUN;*/
/*----------------------------------------------------------------------*/
/*PROC SQL;*/
/*CREATE TABLE TEST2 AS*/
/*SELECT AF_DOE_LDR*/
/*	,IM_LDR_FUL*/
/*    ,IC_LON_PGM*/
/*	,COUNT(*) AS COUNT*/
/*	,SUM(DISBAMT) AS DISBAMT*/
/*	,IF_TIR_PCE*/
/*FROM MOTEST*/
/*GROUP BY AF_DOE_LDR, IM_LDR_FUL, IC_LON_PGM, IF_TIR_PCE*/
/*ORDER BY AF_DOE_LDR, IF_TIR_PCE, IC_LON_PGM*/
/*;*/
/*QUIT;*/
/*----------------------------------------------------------------------*/
/*PROC SORT DATA=MOTEST;*/
/*BY AF_DOE_LDR;*/
/*RUN;*/
/**/
/*PROC EXPORT DATA=MOTEST*/
/*            OUTFILE= "T:\SAS\UTLWL03_DETAIL.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/
