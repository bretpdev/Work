CREATE PROCEDURE [dbo].[LT_TS09BFDCP_Loans]
	@AccountNumber CHAR(10),
	@IsCoborrower BIT = 0
AS
BEGIN
	
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE	@LetterId VARCHAR(10) = 'TS09BFDCP'
DECLARE @PF_REQ_ACT VARCHAR(5) = (SELECT AC11.PF_REQ_ACT FROM AC11_ACT_REQ_LTR AC11 WHERE PF_LTR = @LetterId)

IF @IsCoborrower = 0
	BEGIN
		SELECT
			COALESCE(FMT.Label, LN10.IC_LON_PGM) AS [Loan Program],
			CONVERT(VARCHAR(10), LN10.LD_LON_1_DSB, 101) AS [Date Disbursed],
			CONVERT(VARCHAR(10), LN16.LD_DLQ_OCC, 101) AS [Due Date],
			'$' + CAST(DUE.CUR_DUE AS VARCHAR) AS [Total Past Due Amount]
		FROM
			PD10_PRS_NME PD10
			INNER JOIN LN10_LON LN10
				ON LN10.BF_SSN = PD10.DF_PRS_ID
			INNER JOIN
			(
				SELECT
					LN85.BF_SSN,
					LN85.LN_SEQ
				FROM
					LN85_LON_ATY LN85
					INNER JOIN --GETS THE MOST RECENT ARC LEFT ON THE BORROWERS ACCOUNT TO GET THE LOAN SEQ'S THE LETTER APPLIES TO
					(
						SELECT
							AY10.BF_SSN,
							MAX(AY10.LN_ATY_SEQ) AS LN_ATY_SEQ,
							MAX(AY10.LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
						FROM 
							AY10_BR_LON_ATY AY10
							INNER JOIN PD10_PRS_NME PD10
								ON PD10.DF_PRS_ID = AY10.BF_SSN
						WHERE
							AY10.PF_REQ_ACT = @PF_REQ_ACT
							AND PD10.DF_SPE_ACC_ID = @AccountNumber
						GROUP BY
							AY10.BF_SSN
					)AY10
						ON AY10.BF_SSN = LN85.BF_SSN
						AND AY10.LN_ATY_SEQ = LN85.LN_ATY_SEQ
			)LN85
				ON LN85.BF_SSN = LN10.BF_SSN
				AND LN85.LN_SEQ = LN10.LN_SEQ
			INNER JOIN LN16_LON_DLQ_HST LN16
				ON LN10.BF_SSN = LN16.BF_SSN
				AND LN10.LN_SEQ = LN16.LN_SEQ
				AND LN16.LC_STA_LON16 = '1'
			INNER JOIN 
			(
				SELECT 
					LN80.BF_SSN,
					LN80.LN_SEQ,
					CAST(SUM(COALESCE(LN80.LA_BIL_CUR_DU,0.00) - COALESCE(LN80.LA_TOT_BIL_STS,0.00)) AS DECIMAL(14,2)) AS CUR_DUE
				FROM 
					PD10_PRS_NME PD10
					INNER JOIN LN80_LON_BIL_CRF LN80
						ON LN80.BF_SSN = PD10.DF_PRS_ID
						AND LN80.LC_STA_LON80 = 'A'
						AND CAST(LN80.LD_BIL_DU_LON AS DATE) < DATEADD(MONTH,1,GETDATE())
					INNER JOIN BL10_BR_BIL BL10
						ON BL10.BF_SSN = LN80.BF_SSN
						AND BL10.LN_SEQ_BIL_WI_DTE = LN80.LN_SEQ_BIL_WI_DTE
						AND BL10.LC_IND_BIL_SNT != '0'
						AND BL10.LC_STA_BIL10 = 'A'
				WHERE
					PD10.DF_SPE_ACC_ID = @AccountNumber
				GROUP BY
					LN80.BF_SSN,
					LN80.LN_SEQ
			) DUE
				ON LN10.BF_SSN = DUE.BF_SSN
				AND LN10.LN_SEQ = DUE.LN_SEQ
			LEFT OUTER JOIN FormatTranslation FMT
				ON FMT.Start = LN10.IC_LON_PGM
				AND FMT.FmtName = '$LNPROG'
		WHERE 
			PD10.DF_SPE_ACC_ID = @AccountNumber
			AND LN10.LA_CUR_PRI > 0
			AND LN10.LC_STA_LON10 = 'R'
	END
ELSE
	BEGIN
		SELECT
			COALESCE(FMT.Label, LN10.IC_LON_PGM) AS [Loan Program],
			CONVERT(VARCHAR(10), LN10.LD_LON_1_DSB, 101) AS [Date Disbursed],
			CONVERT(VARCHAR(10), LN16.LD_DLQ_OCC, 101) AS [Due Date],
			'$' + CAST(DUE.CUR_DUE AS VARCHAR) AS [Total Past Due Amount]
		FROM
			PD10_PRS_NME PD10
			INNER JOIN LN20_EDS LN20
				ON LN20.LF_EDS = PD10.DF_PRS_ID
				AND LN20.LC_EDS_TYP = 'M'
				AND LN20.LC_STA_LON20 = 'A'
			INNER JOIN LN10_LON LN10
				ON LN10.BF_SSN = LN20.BF_SSN
				AND LN10.LN_SEQ = LN20.LN_SEQ
			INNER JOIN
			(
				SELECT
					LN85.BF_SSN,
					LN85.LN_SEQ
				FROM
					LN85_LON_ATY LN85
					INNER JOIN --GETS THE MOST RECENT ARC LEFT ON THE BORROWERS ACCOUNT TO GET THE LOAN SEQ'S THE LETTER APPLIES TO
					(
						SELECT
							AY10.BF_SSN,
							MAX(AY10.LN_ATY_SEQ) AS LN_ATY_SEQ,
							MAX(AY10.LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
						FROM 
							AY10_BR_LON_ATY AY10
							INNER JOIN LN20_EDS LN20
								ON LN20.BF_SSN = AY10.BF_SSN
								AND LN20.LC_EDS_TYP = 'M'
								AND LN20.LC_STA_LON20 = 'A'
							INNER JOIN PD10_PRS_NME PD10
								ON PD10.DF_PRS_ID = LN20.LF_EDS
						WHERE
							AY10.PF_REQ_ACT = @PF_REQ_ACT
							AND PD10.DF_SPE_ACC_ID = @AccountNumber
						GROUP BY
							AY10.BF_SSN
					)AY10
						ON AY10.BF_SSN = LN85.BF_SSN
						AND AY10.LN_ATY_SEQ = LN85.LN_ATY_SEQ
			)LN85
				ON LN85.BF_SSN = LN10.BF_SSN
				AND LN85.LN_SEQ = LN10.LN_SEQ
			INNER JOIN LN16_LON_DLQ_HST LN16
				ON LN10.BF_SSN = LN16.BF_SSN
				AND LN10.LN_SEQ = LN16.LN_SEQ
				AND LN16.LC_STA_LON16 = '1'
			INNER JOIN 
			(
				SELECT 
					LN80.BF_SSN,
					LN80.LN_SEQ,
					CAST(SUM(COALESCE(LN80.LA_BIL_CUR_DU,0.00) - COALESCE(LN80.LA_TOT_BIL_STS,0.00)) AS DECIMAL(14,2)) AS CUR_DUE
				FROM 
					LN20_EDS LN20
					INNER JOIN PD10_PRS_NME PD10
						ON PD10.DF_PRS_ID = LN20.LF_EDS
					INNER JOIN LN80_LON_BIL_CRF LN80
						ON LN80.BF_SSN = LN20.BF_SSN
						AND LN80.LN_SEQ = LN20.LN_SEQ
						AND LN80.LC_STA_LON80 = 'A'
						AND CAST(LN80.LD_BIL_DU_LON AS DATE) < DATEADD(MONTH,1,GETDATE())
					INNER JOIN BL10_BR_BIL BL10
						ON BL10.BF_SSN = LN80.BF_SSN
						AND BL10.LN_SEQ_BIL_WI_DTE = LN80.LN_SEQ_BIL_WI_DTE
						AND BL10.LC_IND_BIL_SNT != '0'
						AND BL10.LC_STA_BIL10 = 'A'
				WHERE
					PD10.DF_SPE_ACC_ID = @AccountNumber
					AND LN20.LC_EDS_TYP = 'M'
					AND LN20.LC_STA_LON20 = 'A'
				GROUP BY
					LN80.BF_SSN,
					LN80.LN_SEQ
			) DUE
				ON LN10.BF_SSN = DUE.BF_SSN
				AND LN10.LN_SEQ = DUE.LN_SEQ
			LEFT OUTER JOIN FormatTranslation FMT
				ON FMT.Start = LN10.IC_LON_PGM
				AND FMT.FmtName = '$LNPROG'
		WHERE 
			PD10.DF_SPE_ACC_ID = @AccountNumber
			AND LN10.LA_CUR_PRI > 0
			AND LN10.LC_STA_LON10 = 'R'
	END
END
GO

