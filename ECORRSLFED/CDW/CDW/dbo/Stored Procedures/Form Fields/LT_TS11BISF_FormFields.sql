CREATE PROCEDURE [dbo].[LT_TS11BISF_FormFields]
	@AccountNumber CHAR(10),
	@IsCoborrower BIT = 0
AS
BEGIN
	
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE	@LetterId VARCHAR(10) = 'TS11BISF'
DECLARE @PF_REQ_ACT VARCHAR(5) = (SELECT AC11.PF_REQ_ACT FROM AC11_ACT_REQ_LTR AC11 WHERE PF_LTR = @LetterId)

IF @IsCoborrower = 0
	BEGIN
		SELECT 
			'$' + CAST(LN90M.LA_TRAN AS VARCHAR) AS LA_TRAN,
			CONVERT(VARCHAR(10), LN90M.LD_MAX_TRAN, 101) [LD_MAX_TRAN]
		FROM
			PD10_PRS_NME PD10
			INNER JOIN 
			(
				SELECT DISTINCT
					LN90.BF_SSN,
					SUM(COALESCE(LN90.LA_FAT_CUR_PRI, 0) + COALESCE(LN90.LA_FAT_ILG_PRI, 0) + COALESCE(LN90.LA_FAT_LTE_FEE, 0) + COALESCE(LN90.LA_FAT_NSI, 0) + COALESCE(LN90.LA_FAT_PCL_FEE, 0)) OVER (PARTITION BY LN90.BF_SSN, LN90.LD_FAT_APL) [LA_TRAN],
					LN90.LD_FAT_APL [LD_MAX_TRAN]
				FROM 
					LN90_FIN_ATY LN90
					INNER JOIN
					(
						SELECT DISTINCT
							BF_SSN,
							MAX(LN90.LD_FAT_APL) [LD_MAX_TRAN]
						FROM 
							LN90_FIN_ATY LN90
						WHERE
							LN90.LC_FAT_REV_REA = '1'
							AND LN90.PC_FAT_TYP = '10'
							AND LN90.LC_STA_LON90 = 'A'
						GROUP BY
							LN90.BF_SSN
					) MaxLN90
						ON MaxLN90.BF_SSN = LN90.BF_SSN
						AND MaxLN90.LD_MAX_TRAN = LN90.LD_FAT_APL
					INNER JOIN
					(
						SELECT
							LN85.BF_SSN,
							LN85.LN_SEQ
						FROM
							LN85_LON_ATY LN85
							INNER JOIN --GETS THE MOST RECENT ARC LEFT ON THE BORROWERS ACCOUNT TO GET THE LOAN SEQ'S THE LETTER APPLIES TO
							(
								SELECT
									AY10.BF_SSN,
									MAX(AY10.LN_ATY_SEQ) AS LN_ATY_SEQ,
									MAX(AY10.LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
								FROM 
									AY10_BR_LON_ATY AY10
									INNER JOIN PD10_PRS_NME PD10
										ON PD10.DF_PRS_ID = AY10.BF_SSN
								WHERE
									AY10.PF_REQ_ACT = @PF_REQ_ACT
									AND PD10.DF_SPE_ACC_ID = @AccountNumber
								GROUP BY
									AY10.BF_SSN
							)AY10
								ON AY10.BF_SSN = LN85.BF_SSN
								AND AY10.LN_ATY_SEQ = LN85.LN_ATY_SEQ
					)LN85
						ON LN85.BF_SSN = LN90.BF_SSN
						AND LN85.LN_SEQ = LN90.LN_SEQ
				WHERE
					LN90.LC_FAT_REV_REA = '1'
					AND LN90.PC_FAT_TYP = '10'
					AND LN90.LC_STA_LON90 = 'A'
			) LN90M
				ON LN90M.BF_SSN = PD10.DF_PRS_ID
		WHERE
			PD10.DF_SPE_ACC_ID = @AccountNumber
	END
ELSE
	BEGIN
		SELECT DISTINCT
			'$' + CAST(LN90M.LA_TRAN AS VARCHAR) AS LA_TRAN,
			CONVERT(VARCHAR(10), LN90M.LD_MAX_TRAN, 101) [LD_MAX_TRAN]
		FROM
			PD10_PRS_NME PD10
			INNER JOIN LN20_EDS LN20
				ON LN20.LF_EDS = PD10.DF_PRS_ID
				AND LN20.LC_EDS_TYP = 'M'
				AND LN20.LC_STA_LON20 = 'A'
			INNER JOIN 
			(
				SELECT DISTINCT
					LN90.BF_SSN,
					SUM(COALESCE(LN90.LA_FAT_CUR_PRI, 0) + COALESCE(LN90.LA_FAT_ILG_PRI, 0) + COALESCE(LN90.LA_FAT_LTE_FEE, 0) + COALESCE(LN90.LA_FAT_NSI, 0) + COALESCE(LN90.LA_FAT_PCL_FEE, 0)) OVER (PARTITION BY LN90.BF_SSN, LN90.LD_FAT_EFF) [LA_TRAN],
					LN90.LD_FAT_APL [LD_MAX_TRAN]
				FROM 
					LN90_FIN_ATY LN90
					INNER JOIN
					(
						SELECT DISTINCT
							BF_SSN,
							MAX(LN90.LD_FAT_APL) [LD_MAX_TRAN]
						FROM 
							LN90_FIN_ATY LN90
						WHERE
							LN90.LC_FAT_REV_REA = '1'
							AND LN90.PC_FAT_TYP = '10'
							AND LN90.LC_STA_LON90 = 'A'
						GROUP BY
							LN90.BF_SSN
					) MaxLN90
						ON MaxLN90.BF_SSN = LN90.BF_SSN
						AND MaxLN90.LD_MAX_TRAN = LN90.LD_FAT_APL
					INNER JOIN
					(
						SELECT
							LN85.BF_SSN,
							LN85.LN_SEQ
						FROM
							LN85_LON_ATY LN85
							INNER JOIN --GETS THE MOST RECENT ARC LEFT ON THE BORROWERS ACCOUNT TO GET THE LOAN SEQ'S THE LETTER APPLIES TO
							(
								SELECT
									AY10.BF_SSN,
									MAX(AY10.LN_ATY_SEQ) AS LN_ATY_SEQ,
									MAX(AY10.LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
								FROM 
									AY10_BR_LON_ATY AY10
									INNER JOIN LN20_EDS LN20
										ON LN20.BF_SSN = AY10.BF_SSN
										AND LN20.LC_EDS_TYP = 'M'
										AND LN20.LC_STA_LON20 = 'A'
									INNER JOIN PD10_PRS_NME PD10
										ON PD10.DF_PRS_ID = LN20.LF_EDS
								WHERE
									AY10.PF_REQ_ACT = @PF_REQ_ACT
									AND PD10.DF_SPE_ACC_ID = @AccountNumber
								GROUP BY
									AY10.BF_SSN
							)AY10
								ON AY10.BF_SSN = LN85.BF_SSN
								AND AY10.LN_ATY_SEQ = LN85.LN_ATY_SEQ
					)LN85
						ON LN85.BF_SSN = LN90.BF_SSN
						AND LN85.LN_SEQ = LN90.LN_SEQ
				WHERE
					LN90.LC_FAT_REV_REA = '1'
					AND LN90.PC_FAT_TYP = '10'
					AND LN90.LC_STA_LON90 = 'A'
			) LN90M
				ON LN90M.BF_SSN = LN20.BF_SSN
		WHERE
			PD10.DF_SPE_ACC_ID = @AccountNumber
	END
END
GO

