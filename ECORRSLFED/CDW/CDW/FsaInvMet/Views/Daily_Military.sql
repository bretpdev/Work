CREATE VIEW [FsaInvMet].[Daily_Military]

AS

SELECT
	LN10.BF_SSN,
	LN10.LN_SEQ, 
	1 AS ActiveMilitaryIndicator
FROM
	LN10_LON LN10
	INNER JOIN DW01_DW_CLC_CLU DW01
		ON DW01.BF_SSN = LN10.BF_SSN
		AND DW01.LN_SEQ = LN10.LN_SEQ
	INNER JOIN 
	(
		SELECT
			LN72.BF_SSN,
			LN72.LN_SEQ,
			LN72.LR_ITR,
			LN72.LC_INT_RDC_PGM,
			ROW_NUMBER() OVER (PARTITION BY LN72.BF_SSN, LN72.LN_SEQ ORDER BY LN72.LD_STA_LON72 DESC) AS CurrentRow
		FROM
			LN72_INT_RTE_HST LN72
		WHERE
			LN72.LC_STA_LON72 = 'A'
			AND CAST(GETDATE() AS DATE) BETWEEN LN72.LD_ITR_EFF_BEG AND LN72.LD_ITR_EFF_END 
	) LN72
		ON LN72.BF_SSN = LN10.BF_SSN
		AND LN72.LN_SEQ = LN10.LN_SEQ
		AND LN72.CurrentRow = 1
	LEFT JOIN
	(
		SELECT DISTINCT
			DW01.BF_SSN,
			DW01.LN_SEQ
		FROM
			DW01_DW_CLC_CLU DW01
			INNER JOIN LN50_BR_DFR_APV LN50
				ON DW01.BF_SSN = LN50.BF_SSN
				AND DW01.LN_SEQ = LN50.LN_SEQ
				AND LN50.LC_STA_LON50 = 'A'
				AND CAST(GETDATE() AS DATE) BETWEEN LN50.LD_DFR_BEG AND LN50.LD_DFR_END 
			INNER JOIN DF10_BR_DFR_REQ DF10
				ON DW01.BF_SSN = DF10.BF_SSN
				AND LN50.LF_DFR_CTL_NUM = DF10.LF_DFR_CTL_NUM
				AND DF10.LC_DFR_STA = 'A'
				AND DF10.LC_STA_DFR10 = 'A'
				AND DF10.LC_DFR_TYP IN('38','40')
				AND LN50.LC_DFR_RSP != '003'
		WHERE 
			DW01.WC_DW_LON_STA = '04'
	) DefermentDate 
		ON DefermentDate.BF_SSN = LN10.BF_SSN
		AND DefermentDate.LN_SEQ = LN10.LN_SEQ
	LEFT JOIN
	(
		SELECT DISTINCT
			SP.BorrSSN,
			SP.Loan
		FROM
			CLS.scra.ScriptProcessing SP
			INNER JOIN CLS.scra.DataComparison DC
				ON SP.DataComparisonId = DC.DataComparisonId
				AND SP.BorrSSN = DC.BorrSSN
				AND SP.Loan = DC.Loan
				AND DC.ActiveRow = 1
		WHERE
			CAST(GETDATE() AS DATE) BETWEEN SP.TXCXBegin AND SP.TXCXEnd
			AND SP.LN10Disb <= SP.TXCXBegin
	) MilitaryDatabase
		ON MilitaryDatabase.BorrSSN = LN10.BF_SSN
		AND MilitaryDatabase.Loan = LN10.LN_SEQ
WHERE
	LN10.LC_STA_LON10 = 'R'
	AND
	(
		(LN72.LR_ITR = 0 AND LN72.LC_INT_RDC_PGM = 'S') --danger zone borrower
		OR (LN72.LR_ITR <= 6 AND LN72.LC_INT_RDC_PGM = 'M')
		OR DefermentDate.BF_SSN IS NOT NULL --has military deferment
		OR MilitaryDatabase.BorrSSN IS NOT NULL --Active in new database
	)