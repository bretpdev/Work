*----------------------*
| UTLWO76 TILP REFUNDS |
*----------------------*;
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWO76.LWO76R2";
FILENAME REPORTZ "&RPTLIB/ULWO76.LWO76RZ";
DATA _NULL_;
	CALL SYMPUT('RUNDATE',PUT(INTNX('DAY',TODAY(),0,'beginning'), MMDDYY10.));
RUN;
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE TILPREF AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT C.DF_SPE_ACC_ID
	,C.DM_PRS_LST
	,A.LN_SEQ
	,B.LD_FAT_PST
	,ABS(B.LA_FAT_CUR_PRI) AS LA_FAT_CUR_PRI
	,B.LD_FAT_EFF
FROM OLWHRM1.LN10_LON A
INNER JOIN (
		SELECT BF_SSN
			,LN_SEQ
			,LD_FAT_PST
			,LA_FAT_CUR_PRI
			,LD_FAT_EFF
		FROM OLWHRM1.LN90_FIN_ATY 
		WHERE PC_FAT_TYP = '10'
			AND PC_FAT_SUB_TYP IN ('40','45')
			AND LC_FAT_REV_REA = ''
			AND LC_STA_LON90 = 'A'
	UNION
		SELECT X1.BF_SSN
			,X1.LN_SEQ
			,X1.LD_FAT_PST
			,X1.LA_FAT_CUR_PRI
			,X1.LD_FAT_EFF
		FROM OLWHRM1.LN90_FIN_ATY X1
		INNER JOIN OLWHRM1.AD20_PCV_ATY_ADJ X2
			ON X1.BF_SSN = X2.BF_SSN
			AND X1.LN_SEQ = X2.LN_SEQ
			AND X1.LN_FAT_SEQ = X2.LN_FAT_SEQ
		WHERE X1.PC_FAT_TYP = '80'
			AND X1.PC_FAT_SUB_TYP = '01'
			AND X2.PC_FAT_TYP = '10'
			AND X2.PC_FAT_SUB_TYP IN ('40','45')
			AND 
			(
				(
					X1.LC_FAT_REV_REA = ''
					AND X1.LC_STA_LON90 = 'A'
				)
			OR
				(
					X2.LC_STA_FAT_ADJ_REQ = 'A'
				)
			)
	) B
	ON A.BF_SSN = B.BF_SSN
	AND A.LN_SEQ = B.LN_SEQ
INNER JOIN OLWHRM1.PD10_PRS_NME C
	ON A.BF_SSN = C.DF_PRS_ID
LEFT OUTER JOIN OLWHRM1.AY10_BR_LON_ATY D
	ON A.BF_SSN = D.BF_SSN
	AND D.PF_REQ_ACT = 'TLPRV'
	AND D.LC_STA_ACTY10 = 'A'
WHERE A.LC_STA_LON10 = 'R'
	AND A.IC_LON_PGM = 'TILP'
	AND 
	(
		D.PF_REQ_ACT IS NULL OR
		D.LD_ATY_REQ_RCV >= B.LD_FAT_PST
	)
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
ENDRSUBMIT;
DATA TILPREF ;
SET WORKLOCL.TILPREF;
RUN;
PROC SORT DATA = TILPREF; 
	BY DF_SPE_ACC_ID; 
RUN;
PROC PRINTTO PRINT=REPORT2 NEW;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 PAGENO=1 CENTER NODATE;
TITLE 'TILP REFUNDS';
TITLE2	"&RUNDATE";
FOOTNOTE   'JOB = UTLWO76  	 REPORT = ULWO76.LWO76R2';
PROC CONTENTS DATA=TILPREF OUT=EMPTYSET NOPRINT;
DATA _NULL_;
SET EMPTYSET;
FILE PRINT;
IF  NOBS=0 AND _N_ =1 THEN DO;
	PUT // 126*'-';
	PUT      //////
		@51 '**** NO OBSERVATIONS FOUND ****';
	PUT //////
		@57 '-- END OF REPORT --';
	PUT //////////////
		@46 "JOB = UTLWO76  	 REPORT = ULWO76.LWO76R2";
	END;
RETURN;
RUN;
PROC PRINT NOOBS SPLIT='/' DATA=TILPREF WIDTH=UNIFORM WIDTH=MIN LABEL;
FORMAT LA_FAT_CUR_PRI DOLLAR10.2 LD_FAT_EFF LD_FAT_PST MMDDYY10.;
VAR DF_SPE_ACC_ID DM_PRS_LST LN_SEQ LA_FAT_CUR_PRI LD_FAT_EFF LD_FAT_PST;
LABEL DF_SPE_ACC_ID = 'ACCOUNT NUMBER'
	DM_PRS_LST  = 'BORROWER NAME'
	LN_SEQ  = 'LOAN SEQUENCE'
	LA_FAT_CUR_PRI = 'REFUND AMOUNT'
	LD_FAT_EFF = 'EFFECTIVE DATE'
	LD_FAT_PST = 'POSTED DATE'
RUN;
PROC PRINTTO;
RUN;
