*-----------------------------------------------------------------*
| UTLWK27 NAME DISCREPANCIES BETWEEN ONELINK, COMPASS AND LCO.SAS |
*-----------------------------------------------------------------*;
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWK27.LWK27R2";
FILENAME REPORTZ "&RPTLIB/ULWK27.LWK27RZ";
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE NAMES AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT B.DF_PRS_ID 
	,RTRIM(A.DM_PRS_1)||' '||RTRIM(A.DM_PRS_MID) ||' '|| A.DM_PRS_LST AS ONE
	,RTRIM(B.DM_PRS_1)||' '||RTRIM(B.DM_PRS_MID) ||' '|| B.DM_PRS_LST AS COM
	,RTRIM(D.DM_LCO_PRS_1)||' '||RTRIM(D.DM_LCO_PRS_MI) ||' '|| D.DM_LCO_PRS_LST AS LCO
FROM OLWHRM1.PD10_PRS_NME B
INNER JOIN OLWHRM1.LN10_LON C
	ON B.DF_PRS_ID = C.BF_SSN
INNER JOIN OLWHRM1.GA10_LON_APP D
ON C.LF_LON_ALT = D.AF_APL_ID
INNER JOIN OLWHRM1.PD01_PDM_INF A
	ON B.DF_PRS_ID = A.DF_PRS_ID
LEFT OUTER JOIN OLWHRM1.PD6A_LCO_PRS_DMO D
	ON B.DF_PRS_ID = D.DF_LCO_PRS_SSN
WHERE B.DF_PRS_ID NOT IN (SELECT E.DF_PRS_ID_BR
					FROM OLWHRM1.CT30_CALL_QUE E
					WHERE E.IF_WRK_GRP = 'KNAMEDIS'
						AND B.DF_PRS_ID = E.DF_PRS_ID_BR)
	AND (C.LC_STA_LON10 = 'R' AND C.LA_CUR_PRI > 0)
	OR ((C.LC_STA_LON10 = 'D' OR C.LA_CUR_PRI = 0)
	AND D.AC_PRC_STA = 'A' 
	AND DAYS(D.AD_PRC) >= DAYS(CURRENT DATE) - 3)
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;

/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWK27.LWK27RZ);*/
/*QUIT;*/

DATA NAMES;
SET NAMES;
LENGTH TEXT $ 600.;
/*VALUES SET TO 1 WHERE NAMES MISMATCH*/
IF ONE ^= COM THEN OC = 1;
IF ONE ^= LCO THEN OL = 1;
IF COM ^= LCO THEN CL = 1;
IF LCO = '' THEN DO;
	OL = .;
	CL = .;
END;
IF OC = 1 OR OL = 1 OR CL = 1 THEN DO;
	IF OC + OL + CL > 1
		THEN TEXT = 'OL = '||TRIM(ONE)||', CO = '||TRIM(COM)||', LCO = '||TRIM(LCO);
	ELSE IF OC = 1
		THEN TEXT = 'OL = '||TRIM(ONE)||', CO = '||TRIM(COM);
	ELSE IF OL = 1 
		THEN TEXT = 'OL = '||TRIM(ONE)||', LCO = '||TRIM(LCO);
	ELSE IF CL = 1 
		THEN TEXT = 'CO = '||TRIM(COM)||', LCO = '||TRIM(LCO);
	OUTPUT;
END;
RUN;

ENDRSUBMIT;
DATA NAMES;
	SET WORKLOCL.NAMES;
RUN;
PROC SORT DATA=NAMES;
	BY DF_PRS_ID;
RUN;
DATA _NULL_;
SET  WORK.NAMES;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
QUEUE_NAME = 'KNAMEDIS';
INSTITUTION_ID = '';
INSTITUTION_TYPE = '';
DUE_DATE = '';
DUE_TIME = '';
	FORMAT DF_PRS_ID $9. ;
	FORMAT QUEUE_NAME $8. ;
	FORMAT INSTITUTION_ID $1. ;
	FORMAT INSTITUTION_TYPE $1. ;
	FORMAT DUE_DATE $1. ;
	FORMAT DUE_TIME $1. ;
	FORMAT TEXT $600. ;
DO;
	PUT DF_PRS_ID  @;
	PUT QUEUE_NAME  @;
	PUT INSTITUTION_ID  @;
	PUT INSTITUTION_TYPE  @;
	PUT DUE_DATE  @;
	PUT DUE_TIME  @;
	PUT TEXT;
END;
RUN;
