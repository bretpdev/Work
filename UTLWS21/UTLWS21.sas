/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
/*FILENAME REPORT2 "&RPTLIB/ULWS21.LWS21R2";*/
/*FILENAME REPORTZ "&RPTLIB/ULWS21.LWS21RZ";*/
FILENAME REPORT2 "T:\SAS\ULWS21.LWS21R2.txt";
options symbolgen;
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;

%macro sqlcheck ;
  %if  &sqlxrc ne 0  %then  %do  ;
    data _null_  ;
            file reportz notitles  ;
            put @01 " ********************************************************************* "
              / @01 " ****  The SQL code above has experienced an error.               **** "
              / @01 " ****  The SAS should be reviewed.                                **** "       
              / @01 " ********************************************************************* "
              / @01 " ****  The SQL error code is  &sqlxrc  and the SQL error message  **** "
              / @01 " ****  &sqlxmsg   **** "
              / @01 " ********************************************************************* "
            ;
         run  ;
  %end  ;
%mend  ;


PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE DEMOA AS
SELECT *
FROM CONNECTION TO DB2 (

SELECT DISTINCT  LN10.BF_SSN AS SSN

	,RTRIM(PD10.DM_PRS_1) || ' ' || RTRIM(PD10.DM_PRS_MID) || ' ' || RTRIM(PD10.DM_PRS_LST) AS NAME
	,FB10.LD_FOR_REQ_BEG AS BEGIN
	,FB10.LD_FOR_REQ_END AS END
	,CASE
	 WHEN DAYS(FB10.LD_FOR_REQ_BEG) > DAYS(CURRENT DATE)
	 THEN DAYS(CURRENT DATE)
	 WHEN DAYS(FB10.LD_FOR_REQ_BEG) <= DAYS(CURRENT DATE)
	 THEN DAYS(FB10.LD_FOR_REQ_BEG)
	 END DBEGIN
	,CASE
	 WHEN DAYS(FB10.LD_FOR_REQ_END) > DAYS(CURRENT DATE)
	 THEN DAYS(CURRENT DATE)
	 WHEN DAYS(FB10.LD_FOR_REQ_END) <= DAYS(CURRENT DATE)
	 THEN DAYS(FB10.LD_FOR_REQ_END)
	 END DEND
	,CASE 
	 WHEN DAYS(FB10.LD_FOR_REQ_END) < DAYS(CURRENT DATE)
	 THEN DAYS(FB10.LD_FOR_REQ_END) - DAYS(FB10.LD_FOR_REQ_BEG)
	 WHEN DAYS(FB10.LD_FOR_REQ_END) >= DAYS(CURRENT DATE)
	 THEN DAYS(CURRENT DATE) - DAYS(FB10.LD_FOR_REQ_BEG)
	 END USED
	,CASE 
	 WHEN FB10.LC_FOR_TYP IN ('05', '06', '08', '11', '12', '19', '22', '24', '26', '27', '28', '31')
	 THEN 'Discretionary Forbearance'
	 WHEN FB10.LC_FOR_TYP IN ('07', '18', '20', '21', '01', '04', '13', '23')
	 THEN 'Mandatory Forbearance'
	 WHEN FB10.LC_FOR_TYP IN ('02', '03', '09', '10', '14', '15', '16', '17', '25')
	 THEN 'Administrative Forbearance'
	 END AS FOR_TYP
	,PD10.DF_SPE_ACC_ID

FROM OLWHRM1.LN10_LON LN10
INNER JOIN OLWHRM1.LN60_BR_FOR_APV LN60
ON LN10.BF_SSN = LN60.BF_SSN
AND LN10.LN_SEQ = LN60.LN_SEQ
INNER JOIN OLWHRM1.FB10_BR_FOR_REQ FB10
ON LN60.BF_SSN = FB10.BF_SSN
AND LN60.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM
INNER JOIN OLWHRM1.PD10_PRS_NME PD10
ON LN10.BF_SSN = PD10.DF_PRS_ID



WHERE LN60.LC_STA_LON60 = 'A'
AND FB10.LC_FOR_STA = 'A'
AND FB10.LC_STA_FOR10 = 'A'
AND LN10.LA_CUR_PRI > 0

FOR READ ONLY WITH UR

);
DISCONNECT FROM DB2;

/*%put  sqlxrc= >>> &sqlxrc <<< ||| sqlxmsg= >>> &sqlxmsg >>> ;  ** includes error messages to SAS log  ;*/
/*%sqlcheck;*/
/*quit;*/

ENDRSUBMIT;

DATA DEMOA; SET WORKLOCL.DEMOA; RUN;

DATA ACCNUM (KEEP=SSN DF_SPE_ACC_ID);
SET DEMOA;
RUN;

PROC SQL;
CREATE TABLE DEMOSMALL AS
SELECT SSN, SUM(USED) AS TTIME
FROM DEMOA
GROUP BY SSN;
QUIT;
/*THIS TABLE HAS BORROWERS WHOS TOTAL TIME IS LESS THEN 18 MONTHS*/
/*THIS WAS DONE TO SPEED UP PROCESSING.*/
PROC SQL;
CREATE TABLE DEMOSMALL2 AS
SELECT SSN
FROM DEMOSMALL
WHERE TTIME < 18*30;
QUIT;
/*HERE WE REMOVE THE BORROWERS WITH SMALL TIME FRAMES FROM THE TABLE.*/
PROC SQL;
CREATE TABLE DEMO AS
SELECT *
FROM DEMOA
WHERE SSN NOT IN (SELECT SSN FROM DEMOSMALL2)
AND USED > 0;
QUIT;

PROC SORT DATA=DEMO NODUPKEY;
BY SSN BEGIN END;
RUN;

PROC SQL;
CREATE TABLE COUNTS AS
SELECT COUNT(DISTINCT SSN) AS X
FROM DEMO;
QUIT;
RUN;

DATA SSN_LIST (KEEP=SSN NAME);
SET DEMO;
RUN;

PROC SORT DATA=SSN_LIST NODUPKEY;
BY SSN;
RUN;


DATA _NULL_;
SET COUNTS;
CALL SYMPUT('BOR_NUM',X);
RUN;

DATA STEP0;
SET DEMO;
RUN;

DATA DiscretionarySUM;
SSN = "000000000";
FORMAT NAME $20.;
Discretionary = 0;
RUN;
DATA MandatorySUM;
SSN = "000000000";
FORMAT NAME $20.;
Mandatory = 0;
RUN;
DATA AdministrativeSUM;
SSN = "000000000";
FORMAT NAME $20.;
Administrative = 0;
RUN;

%macro subPROCESS;

PROC SQL;
CREATE TABLE BEGINTB AS
SELECT MIN(DBEGIN) AS DBEGIN
,DEND
FROM STEP1
GROUP BY DEND
;
QUIT;

DATA _NULL_;
SET BEGINTB;
IF _N_ = 1 THEN DO;
	CALL SYMPUT ('BEGINDAYS',TRIM(DBEGIN));
	CALL SYMPUT ('ENDDAYS',TRIM(DEND));
	END;
RUN;

PROC SQL;
CREATE TABLE ENDTB AS
SELECT MAX(DEND) AS DEND 
FROM STEP1
WHERE DBEGIN <= &ENDDAYS 
;
QUIT;

DATA _NULL_;
SET ENDTB;
IF _N_ = 1 THEN DO;
	CALL SYMPUT ('ENDDAYS',TRIM(DEND));
	END;
RUN;

DATA SUM;
SSN = "&SSN";
NAME = "&NAME";
SUM = &ENDDAYS - &BEGINDAYS;
RUN;

DATA TEMPSUM;
SET TEMPSUM SUM;
RUN;

DATA STEP1;
SET STEP1;
IF SSN = "&SSN" AND FOR_TYP = &TYP AND DBEGIN <= &ENDDAYS THEN DELETE; 
ELSE OUTPUT STEP1;
RUN;

PROC SQL;
CREATE TABLE COUNTS AS
SELECT COUNT(*) AS X
FROM STEP1;
QUIT;
RUN;

DATA _NULL_;
SET COUNTS;
CALL SYMPUT('PER_BOR',X);
RUN;

%MEND subPROCESS;

%MACRO PROCESS(X,TYP);

DATA _NULL_;
SET SSN_LIST;
IF _N_ = &X THEN DO;
	CALL SYMPUT ('SSN',TRIM(SSN));
	CALL SYMPUT ('NAME',TRIM(NAME));
	END;
RUN;

DATA TEMPSUM;
SSN = "&SSN";
NAME = "&NAME";
SUM = 0;
RUN;

PROC SQL;
CREATE TABLE STEP1 AS
SELECT *
FROM STEP0
WHERE SSN = "&SSN"
AND FOR_TYP = &TYP
;
QUIT;

/*GET NUMBER OF RECORDS LEFT FOR THIS BORROWER*/
PROC SQL;
CREATE TABLE COUNTS AS
SELECT COUNT(*) AS X
FROM STEP1;
QUIT;
RUN;

DATA _NULL_;
SET COUNTS;
CALL SYMPUT('PER_BOR',X);
RUN;

DATA _NULL_;
%DO %WHILE (&PER_BOR > 0);
	%subPROCESS;
%END;
RUN;

%MEND PROCESS;


%MACRO STPTWO;
%DO I=1 %TO &BOR_NUM;

%PROCESS(&I,'Discretionary Forbearance');
PROC SQL;
CREATE TABLE TSUM AS
SELECT SSN, NAME, SUM(SUM)/30 AS Discretionary
FROM TEMPSUM
GROUP BY SSN,NAME;
QUIT;
RUN;

DATA DiscretionarySUM;
SET DiscretionarySUM TSUM;
RUN;

%PROCESS(&I,'Mandatory Forbearance');
PROC SQL;
CREATE TABLE TSUM AS
SELECT SSN, NAME, SUM(SUM)/30 AS Mandatory
FROM TEMPSUM
GROUP BY SSN,NAME;
QUIT;
RUN;

DATA MandatorySUM;
SET MandatorySUM TSUM;
RUN;
%PROCESS(&I,'Administrative Forbearance');
PROC SQL;
CREATE TABLE TSUM AS
SELECT SSN, NAME, SUM(SUM)/30 AS Administrative
FROM TEMPSUM
GROUP BY SSN,NAME;
QUIT;
RUN;

DATA AdministrativeSUM;
SET AdministrativeSUM TSUM;
RUN;



%END;
%MEND STPTWO;
%STPTWO;


DATA COMBINE;
MERGE DiscretionarySUM MandatorySUM AdministrativeSUM;
BY SSN;
RUN;

PROC SORT DATA=COMBINE;
BY SSN;
RUN;

PROC SQL;
CREATE TABLE MON60 AS
SELECT DISTINCT *, '60 AND UP ' AS MONTH
FROM COMBINE
WHERE Discretionary >= 60;
QUIT;

PROC SQL;
CREATE TABLE MON18 AS
SELECT DISTINCT *, '18 TO 36 ' AS MONTH
FROM COMBINE
WHERE Discretionary >= 18 AND Discretionary <= 36;
QUIT;


PROC SQL;
CREATE TABLE MON37 AS
SELECT DISTINCT *, '37 TO 48 ' AS MONTH
FROM COMBINE
WHERE Discretionary >= 37 AND Discretionary <= 48;
QUIT;


PROC SQL;
CREATE TABLE MON49 AS
SELECT DISTINCT *, '49 TO 60 ' AS MONTH
FROM COMBINE
WHERE Discretionary >= 49 AND Discretionary <= 60;
QUIT;


PROC SQL;
CREATE TABLE MON60 AS
SELECT DISTINCT *, '61 AND UP' AS MONTH
FROM COMBINE
WHERE Discretionary >= 61;
QUIT;


DATA COMBINE2;
SET MON18 MON37 MON49 MON60;
RUN;

PROC SORT DATA=COMBINE2;BY SSN;RUN;
PROC SORT DATA=ACCNUM NODUPKEY;BY SSN;RUN;

DATA COMBINE2;
MERGE COMBINE2 (IN=A) ACCNUM (IN=B);
BY SSN;
IF A;
RUN;

PROC SORT DATA=COMBINE2;BY MONTH DF_SPE_ACC_ID;RUN;

/*For portrait reports;*/
OPTIONS ORIENTATION = PORTRAIT;
OPTIONS CENTER NODATE nobyline NUMBER PAGENO=1 PS=52 LS=96;

PROC PRINTTO PRINT=REPORT2 NEW;
RUN;
PROC CONTENTS DATA=COMBINE2 OUT=EMPTYSET NOPRINT;
DATA _NULL_;
SET EMPTYSET;
FILE PRINT;
IF  NOBS=0 AND _N_ =1 THEN DO;
	PUT // 96*'-';
	PUT      ////////
		@37 '**** NO OBSERVATIONS FOUND ****';
	PUT ////////
		@42 '-- END OF REPORT --';
	TITLE1	'Cumulative Forbearance Time - Compass Borrowers';
	FOOTNOTE "JOB = UTLWS21     REPORT = ULWS21.LWS21R2";
END;
RETURN;
run;

PROC PRINT NOOBS SPLIT='/' DATA=COMBINE2 N = "TOTAL NUMBER OF BORROWERS = ";
BY MONTH;
FORMAT NAME $30.;
FORMAT Mandatory 3.0;
FORMAT Administrative 3.0;
FORMAT Discretionary 3.0;
VAR DF_SPE_ACC_ID
	NAME
	Mandatory
	Administrative
	Discretionary
	;
LABEL DF_SPE_ACC_ID = 'ACCT #';
TITLE 'Cumulative Forbearance Time - Compass Borrowers';
TITLE2 'MONTHS #BYVAL1';
FOOTNOTE  'JOB = UTLWS21     REPORT = UTLWS21.LWS21R2';
RUN;

PROC PRINTTO;
RUN;
