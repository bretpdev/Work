/*=====================*/
/*UTLWN05 US BANK MR64 */
/*=====================*/
/*PLEASE NOTE: THIS DIRECTORY HAS BEEN CHANGED TO PROGREVW BECAUSE OF THE SIZE OF THE OUTPUT FILE*/
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = /sas/whse/progrevw ;*/
/*FILENAME REPORT2 "&RPTLIB/ULWN05.LWN05R2";*/
/*FILENAME REPORTZ "&RPTLIB/ULWN05.LWN05RZ";*/

FILENAME REPORT2 'T:\SAS\ULWN05.ULWN05R2';

LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;

%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE USBMRTBL2 AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.BF_SSN
,A.LN_SEQ
,A.LF_CRT_DTS_MR64 
,A.LF_TAX_YR
,A.LC_SRC_INT_PAY
,A.LC_STA_MR64
,A.LD_STA_MR64
,A.LA_BR_INT_PD_YR
,A.LD_INT_PD_RPT_BR
,A.LD_INT_PD_RPT_IRS
,A.LF_LST_DTS_MR64
FROM OLWHRM1.MR5A_MR_LON_MTH_01 C
INNER JOIN OLWHRM1.MR64_BR_TAX A
	ON A.BF_SSN = C.BF_SSN
	AND A.LN_SEQ = C.LN_SEQ
WHERE C.WA_CUR_PRI > 0
AND C.IF_OWN = '811698'
AND A.LC_STA_MR64 = 'A'
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;

/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWN05.LWN05RZ);*/
/*QUIT;*/

ENDRSUBMIT;

DATA USBMRTBL2;
SET WORKLOCL.USBMRTBL2;
RUN;

PROC SORT DATA=USBMRTBL2;
BY BF_SSN LN_SEQ DESCENDING LF_CRT_DTS_MR64;
RUN;

DATA USBMRTBL2;
SET USBMRTBL2;
BY BF_SSN LN_SEQ;
IF FIRST.LN_SEQ THEN OUTPUT;
RUN;

DATA _NULL_;
SET WORK.USBMRTBL2;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
   FORMAT BF_SSN $9. ;
   FORMAT LN_SEQ 6. ;
   FORMAT LF_CRT_DTS_MR64 DATETIME25.6 ;
   FORMAT LF_TAX_YR $4. ;
   FORMAT LC_SRC_INT_PAY $1. ;
   FORMAT LC_STA_MR64 $1. ;
   FORMAT LD_STA_MR64 MMDDYY10. ;
   FORMAT LA_BR_INT_PD_YR 10.2 ;
   FORMAT LD_INT_PD_RPT_BR MMDDYY10. ;
   FORMAT LD_INT_PD_RPT_IRS MMDDYY10. ;
   FORMAT LF_LST_DTS_MR64 DATETIME25.6 ;
DO;
   PUT BF_SSN $ @;
   PUT LN_SEQ @;
   PUT LF_CRT_DTS_MR64 @;
   PUT LF_TAX_YR $ @;
   PUT LC_SRC_INT_PAY $ @;
   PUT LC_STA_MR64 $ @;
   PUT LD_STA_MR64 @;
   PUT LA_BR_INT_PD_YR @;
   PUT LD_INT_PD_RPT_BR @;
   PUT LD_INT_PD_RPT_IRS @;
   PUT LF_LST_DTS_MR64 ;
   ;
 END;
RUN;
