CREATE PROCEDURE [cncrtrnsfr].[GetDefForbData]
	@Ssn VARCHAR(9)
AS
	SELECT DISTINCT
		DF10.BF_SSN [Ssn]
		,FS10.LN_SEQ
		,FS10.LF_FED_AWD + 
		CASE
			WHEN LEN(FS10.LN_FED_AWD_SEQ) = 1 THEN '00' + CAST(FS10.LN_FED_AWD_SEQ AS VARCHAR(1))
			WHEN LEN(FS10.LN_FED_AWD_SEQ) = 2 THEN '0' + CAST(FS10.LN_FED_AWD_SEQ AS VARCHAR(2))
			ELSE CAST(FS10.LN_FED_AWD_SEQ AS VARCHAR(3))
		END [AwardId]
		,LN50.LD_DFR_BEG [DefermentBeginDate]
		,LN50.LD_DFR_END [DefermentEndDate]
		,SUM((DATEDIFF(DAY, LN50.LD_DFR_BEG, LN50.LD_DFR_END)/365.00)*12) OVER (PARTITION BY DF10.BF_SSN, FS10.LN_SEQ, LN50.LD_DFR_BEG) [DefermentMonthCount]
		,'' [ForbearanceBeginDate]
		,'' [ForbearanceEndDate]
		,0 [ForbearanceMonthCount]
	FROM
		CDW..DF10_BR_DFR_REQ DF10
		INNER JOIN CDW..LN50_BR_DFR_APV LN50
			ON DF10.BF_SSN = LN50.BF_SSN
			AND DF10.LF_DFR_CTL_NUM = LN50.LF_DFR_CTL_NUM
		INNER JOIN CDW..FS10_DL_LON FS10
			ON LN50.BF_SSN = FS10.BF_SSN
			AND LN50.LN_SEQ = FS10.LN_SEQ
	WHERE
		DF10.BF_SSN = @Ssn
		AND DF10.LC_DFR_TYP = '37'
		AND DF10.LC_DFR_SUB_TYP IN ('CT','CP')
		AND DF10.LC_DFR_STA = 'A'
		AND DF10.LC_STA_DFR10 = 'A'
		AND LN50.LC_DFR_RSP = '000'
		AND LN50.LC_STA_LON50 = 'A'

	UNION

	SELECT DISTINCT
		FB10.BF_SSN [Ssn]
		,FS10.LN_SEQ
		,FS10.LF_FED_AWD + 
		CASE
			WHEN LEN(FS10.LN_FED_AWD_SEQ) = 1 THEN '00' + CAST(FS10.LN_FED_AWD_SEQ AS VARCHAR(1))
			WHEN LEN(FS10.LN_FED_AWD_SEQ) = 2 THEN '0' + CAST(FS10.LN_FED_AWD_SEQ AS VARCHAR(2))
			ELSE CAST(FS10.LN_FED_AWD_SEQ AS VARCHAR(3))
		END [AwardId]
		,'' [DefermentBeginDate]
		,'' [DefermentEndDate]
		,0 [DefermentMonthCount]
		,LN60.LD_FOR_BEG [ForbearanceBeginDate]
		,LN60.LD_FOR_END [ForbearanceEndDate]
		,SUM((DATEDIFF(DAY,LN60.LD_FOR_BEG, LN60.LD_FOR_END)/365.00)*12) OVER (PARTITION BY FB10.BF_SSN, FS10.LN_SEQ, LN60.LD_FOR_BEG) [ForbearanceMonthCount]
	FROM
		CDW..FB10_BR_FOR_REQ FB10
		INNER JOIN CDW..LN60_BR_FOR_APV LN60
			ON FB10.BF_SSN = LN60.BF_SSN
			AND FB10.LF_FOR_CTL_NUM = LN60.LF_FOR_CTL_NUM
		INNER JOIN CDW..FS10_DL_LON FS10
			ON LN60.BF_SSN = FS10.BF_SSN
			AND LN60.LN_SEQ = FS10.LN_SEQ
	WHERE
		FB10.BF_SSN = @Ssn
		AND FB10.LC_FOR_TYP = '34'
		AND FB10.LC_FOR_STA = 'A'
		AND FB10.LC_STA_FOR10 = 'A'
		AND LN60.LC_FOR_RSP = '000'
		AND LN60.LC_STA_LON60 = 'A'
RETURN 0