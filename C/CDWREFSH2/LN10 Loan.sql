USE CDW
GO

MERGE 
	CDW.dbo.LN10_Loan LN10
USING
	(
		SELECT
			PD10.DF_SPE_ACC_ID,
			LN10.LN_SEQ,
			ISNULL(LN10.LA_CUR_PRI,0.00) AS LA_CUR_PRI,
			ISNULL(LN10.LA_LON_AMT_GTR,0.00) AS LA_LON_AMT_GTR,
			ISNULL(CONVERT(VARCHAR(10),LN10.LD_END_GRC_PRD,101),'') AS LD_END_GRC_PRD,
			ISNULL(LN10.IC_LON_PGM,'') AS IC_LON_PGM,
			ISNULL(CONVERT(VARCHAR(10),LN10.LD_LON_1_DSB,101),'') AS LD_LON_1_DSB,
			ISNULL(CONVERT(VARCHAR(10),LN10.LD_PIF_RPT,101),'') AS LD_PIF_RPT,
			ISNULL(LN10.LC_SST_LON10,'') AS LC_SST_LON10,
			ISNULL
			(
				CASE WHEN LN10.LA_CUR_PRI > 0 THEN '09'
					 WHEN LN10.LC_SST_LON10 = '4' THEN '11'
					 WHEN LN10.LC_SST_LON10 = '3' THEN '12'
					 ELSE '10'
				END,''
			) AS FORWARDING,
			LN10.LC_STA_LON10,
			'' AS HEP,
			ISNULL(LN10.LF_LON_CUR_OWN,'') AS LF_LON_CUR_OWN,
			ISNULL(LN10.LF_DOE_SCL_ORG,'') AS LF_DOE_SCL_ORG
		FROM
			CDW..PD10_PRS_NME PD10
			INNER JOIN CDW..LN10_LON LN10
				ON LN10.BF_SSN = PD10.DF_PRS_ID
		WHERE
			LN10.LC_STA_LON10 NOT IN('P','J') --Non standard limiter, but this is the way the old sas did it.
			AND CentralData.dbo.TRIM(PD10.DF_SPE_ACC_ID) != ''
	) NewData 
		ON NewData.DF_SPE_ACC_ID = LN10.DF_SPE_ACC_ID
		AND NewData.LN_SEQ = LN10.LN_SEQ
WHEN MATCHED THEN 
	UPDATE SET 
		LN10.LA_CUR_PRI = NewData.LA_CUR_PRI,
		LN10.LA_LON_AMT_GTR = NewData.LA_LON_AMT_GTR,
		LN10.LD_END_GRC_PRD = NewData.LD_END_GRC_PRD,
		LN10.IC_LON_PGM = NewData.IC_LON_PGM,
		LN10.LD_LON_1_DSB = NewData.LD_LON_1_DSB,
		LN10.LD_PIF_RPT = NewData.LD_PIF_RPT,
		LN10.LC_SST_LON10 = NewData.LC_SST_LON10,
		LN10.FORWARDING = NewData.FORWARDING,
		LN10.LC_STA_LON10 = NewData.LC_STA_LON10,
		LN10.HEP = NewData.HEP,
		LN10.LF_LON_CUR_OWN = NewData.LF_LON_CUR_OWN,
		LN10.LF_DOE_SCL_ORG = NewData.LF_DOE_SCL_ORG
WHEN NOT MATCHED THEN
	INSERT 
	(
		DF_SPE_ACC_ID,
		LN_SEQ,
		LA_CUR_PRI,
		LA_LON_AMT_GTR,
		LD_END_GRC_PRD,
		IC_LON_PGM,
		LD_LON_1_DSB,
		LD_PIF_RPT,
		LC_SST_LON10,
		FORWARDING,
		LC_STA_LON10,
		HEP,
		LF_LON_CUR_OWN,
		LF_DOE_SCL_ORG
	)
	VALUES 
	(
		NewData.DF_SPE_ACC_ID,
		NewData.LN_SEQ,
		NewData.LA_CUR_PRI,
		NewData.LA_LON_AMT_GTR,
		NewData.LD_END_GRC_PRD,
		NewData.IC_LON_PGM,
		NewData.LD_LON_1_DSB,
		NewData.LD_PIF_RPT,
		NewData.LC_SST_LON10,
		NewData.FORWARDING,
		NewData.LC_STA_LON10,
		NewData.HEP,
		NewData.LF_LON_CUR_OWN,
		NewData.LF_DOE_SCL_ORG
	)
WHEN NOT MATCHED BY SOURCE THEN
	DELETE
;
