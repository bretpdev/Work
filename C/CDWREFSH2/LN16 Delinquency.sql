USE CDW
GO

MERGE 
	CDW.dbo.LN16_Delinquency LN16
USING
	(
		SELECT
			PD10.DF_SPE_ACC_ID,
			LN16.LN_SEQ,
			ISNULL(CONVERT(VARCHAR(10),LN16.LD_DLQ_OCC,101),'') AS LD_DLQ_OCC,
			CASE WHEN LN16.LC_STA_LON16 != '1' OR (LN16.LC_STA_LON16 = '1' AND CAST(LN16.LD_DLQ_MAX AS DATE) != CAST(DATEADD(DAY,-1,GETDATE()) AS DATE)) THEN 0 ELSE LN16.LN_DLQ_MAX END AS LN_DLQ_MAX,
			CASE WHEN LN16.LC_STA_LON16 != '1' OR (LN16.LC_STA_LON16 = '1' AND CAST(LN16.LD_DLQ_MAX AS DATE) != CAST(DATEADD(DAY,-1,GETDATE()) AS DATE)) THEN NULL ELSE CONVERT(VARCHAR(10),LN16.LD_DLQ_MAX,101) END AS LD_DLQ_MAX
		FROM
			CDW..PD10_PRS_NME PD10
			INNER JOIN CDW..LN16_LON_DLQ_HST LN16
				ON LN16.BF_SSN = PD10.DF_PRS_ID
			INNER JOIN
			(
				SELECT
					BF_SSN,
					LN_SEQ,
					MAX(LN_DLQ_SEQ) AS LN_DLQ_SEQ
				FROM
					CDW..LN16_LON_DLQ_HST
				GROUP BY
					BF_SSN,
					LN_SEQ
			) LN16Max
				ON LN16Max.BF_SSN = LN16.BF_SSN
				AND LN16Max.LN_SEQ = LN16.LN_SEQ
				AND LN16Max.LN_DLQ_SEQ = LN16.LN_DLQ_SEQ
		WHERE
			CASE WHEN LN16.LC_STA_LON16 != '1' OR (LN16.LC_STA_LON16 = '1' AND CAST(LN16.LD_DLQ_MAX AS DATE) != CAST(DATEADD(DAY,-1,GETDATE())AS DATE)) THEN 0 ELSE LN16.LN_DLQ_MAX END > 0
			AND CentralData.dbo.TRIM(PD10.DF_SPE_ACC_ID) != ''
	) NewData 
		ON NewData.DF_SPE_ACC_ID = LN16.DF_SPE_ACC_ID
		AND NewData.LN_SEQ = LN16.LN_SEQ
WHEN MATCHED THEN 
	UPDATE SET 
		LN16.LD_DLQ_OCC = NewData.LD_DLQ_OCC,
		LN16.LN_DLQ_MAX = NewData.LN_DLQ_MAX,
		LN16.LD_DLQ_MAX = NewData.LD_DLQ_MAX
WHEN NOT MATCHED THEN
	INSERT 
	(
		DF_SPE_ACC_ID,
		LN_SEQ,
		LD_DLQ_OCC,
		LN_DLQ_MAX,
		LD_DLQ_MAX
	)
	VALUES 
	(
		NewData.DF_SPE_ACC_ID,
		NewData.LN_SEQ,
		NewData.LD_DLQ_OCC,
		NewData.LN_DLQ_MAX,
		NewData.LD_DLQ_MAX
	)
WHEN NOT MATCHED BY SOURCE THEN
	DELETE
;
