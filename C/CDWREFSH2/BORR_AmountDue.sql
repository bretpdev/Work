USE CDW
GO

MERGE
	dbo.BORR_AmountDue ExistingData
USING
	(
		SELECT DISTINCT
			PD10.DF_SPE_ACC_ID,
			SUM(COALESCE(CUR.CUR_DUE,0)) AS CUR_DUE,
			SUM(COALESCE(PST.PAST_DUE,0)) AS PAST_DUE,
			SUM(COALESCE(CUR.CUR_DUE,0) + COALESCE(PST.PAST_DUE,0)) AS TOT_DUE,
			SUM(COALESCE(CUR.CUR_DUE,0) + COALESCE(PST.PAST_DUE,0) + COALESCE(LN10.LA_LTE_FEE_OTS,0)) AS TOT_DUE_FEE
		FROM 
			LN10_LON LN10
			INNER JOIN PD10_PRS_NME PD10
				ON PD10.DF_PRS_ID = LN10.BF_SSN
			LEFT JOIN 
			(
				SELECT
					LN80.BF_SSN,
					LN80.LN_SEQ,
					SUM(COALESCE(LN80.LA_BIL_CUR_DU,0) - COALESCE(LN80.LA_TOT_BIL_STS,0)) AS CUR_DUE
				FROM 
					LN80_LON_BIL_CRF LN80
					INNER JOIN 
					(
						SELECT
							LN80.BF_SSN,
							LN80.LN_SEQ,
							MIN(LN80.LD_BIL_DU_LON) AS LD_BIL_DU_LON
						FROM 
							LN80_LON_BIL_CRF LN80
						WHERE 
							LN80.LC_STA_LON80 = 'A'
							AND LN80.LC_LON_STA_BIL = '1'
							AND CAST(LN80.LD_BIL_DU_LON AS DATE) > CAST(GETDATE() AS DATE)	
						GROUP BY 
							LN80.BF_SSN,
							LN80.LN_SEQ
					) MIN_DTE
						ON LN80.BF_SSN = MIN_DTE.BF_SSN
						AND LN80.LN_SEQ = MIN_DTE.LN_SEQ
						AND LN80.LD_BIL_DU_LON = MIN_DTE.LD_BIL_DU_LON
				WHERE 
					LN80.LC_STA_LON80 = 'A'
					AND LN80.LC_LON_STA_BIL = '1'
				GROUP BY 
					LN80.BF_SSN,
					LN80.LN_SEQ
			) CUR
				ON LN10.BF_SSN = CUR.BF_SSN
				AND LN10.LN_SEQ = CUR.LN_SEQ
			LEFT JOIN 
			(
				SELECT
					LN80.BF_SSN,
					LN80.LN_SEQ,
					SUM(COALESCE(LN80.LA_BIL_CUR_DU,0) - COALESCE(LN80.LA_TOT_BIL_STS,0)) AS PAST_DUE,
					SUM(COALESCE(LN80.LA_BIL_CUR_DU,0)) AS LA_BIL_CUR_DU,
					SUM(COALESCE(LN80.LA_TOT_BIL_STS,0)) AS LA_TOT_BIL_STS
				FROM 
					LN80_LON_BIL_CRF LN80
				WHERE 
					LN80.LC_STA_LON80 = 'A'
					AND LN80.LC_LON_STA_BIL = '1'
					AND CAST(LN80.LD_BIL_DU_LON AS DATE) <= CAST(GETDATE() AS DATE)
				GROUP BY 
					LN80.BF_SSN,
					LN80.LN_SEQ
			) PST
				ON LN10.BF_SSN = PST.BF_SSN
				AND LN10.LN_SEQ = PST.LN_SEQ
		WHERE 
			LN10.LA_CUR_PRI > 0
			AND LN10.LC_STA_LON10 = 'R'
		GROUP BY 
			PD10.DF_SPE_ACC_ID
	) NewData
		ON NewData.DF_SPE_ACC_ID = ExistingData.DF_SPE_ACC_ID
WHEN MATCHED THEN UPDATE SET
	ExistingData.CUR_DUE = NewData.CUR_DUE,
	ExistingData.PAST_DUE = NewData.PAST_DUE,
	ExistingData.TOT_DUE = NewData.TOT_DUE,
	ExistingData.TOT_DUE_FEE = NewData.TOT_DUE_FEE
WHEN NOT MATCHED THEN
	INSERT
	(
		DF_SPE_ACC_ID,
		CUR_DUE,
		PAST_DUE,
		TOT_DUE,
		TOT_DUE_FEE
	)
	VALUES
	(
		NewData.DF_SPE_ACC_ID,
		NewData.CUR_DUE,
		NewData.PAST_DUE,
		NewData.TOT_DUE,
		NewData.TOT_DUE_FEE
	)
WHEN NOT MATCHED BY SOURCE THEN
	DELETE;