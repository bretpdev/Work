CREATE PROCEDURE [dbo].[GetCatchUpLoanData]
	@SSN CHAR(9),
	@TESTMODE BIT
AS
	DECLARE @QUERY VARCHAR(MAX), @TSQL VARCHAR(MAX)
	IF @TESTMODE = 0
		SELECT @TSQL = 'SELECT * FROM OPENQUERY(LEGEND_TEST_VUK1,'
	ELSE
		SELECT @TSQL = 'SELECT * FROM OPENQUERY(LEGEND,'
	  SELECT  @QUERY = @TSQL + 
	  '''
		SELECT 
			LN65.LF_LST_DTS_LN65 AS RepayeEndDate,
			LN10.LN_SEQ AS LnSeq,
			LN10.LD_LON_1_DSB AS DisbDate,
			LN10.IC_LON_PGM AS LoanProgram
		FROM 
			PKUB.LN10_LON LN10
			INNER JOIN
			(
				SELECT
					LN65.BF_SSN,
					LN65.LN_SEQ,
					MAX(LN65.LN_RPS_SEQ) AS LN_RPS_SEQ
				FROM
					PKUB.LN65_LON_RPS LN65
					INNER JOIN PKUB.LN10_LON LN10
						ON LN10.BF_SSN = LN65.BF_SSN
						AND LN10.LN_SEQ = LN65.LN_SEQ
						AND LN10.LC_STA_LON10 = ''''R''''
						AND LN10.LA_CUR_PRI > 0
				WHERE 
					LN65.BF_SSN = ''''' + @SSN + '''''
					AND LN65.LC_TYP_SCH_DIS = ''''I5''''
				GROUP BY
					LN65.BF_SSN,
					LN65.LN_SEQ
			)MAX_SCHEDULE
				ON MAX_SCHEDULE.BF_SSN = LN10.BF_SSN
				AND MAX_SCHEDULE.LN_SEQ = LN10.LN_SEQ
			INNER JOIN PKUB.LN65_LON_RPS LN65
				ON LN65.BF_SSN = MAX_SCHEDULE.BF_SSN
				AND LN65.LN_SEQ = MAX_SCHEDULE.LN_SEQ
				AND LN65.LN_RPS_SEQ = MAX_SCHEDULE.LN_RPS_SEQ
		WHERE 
			LN10.BF_SSN = ''''' + @SSN + '''''
			AND LC_STA_LON10 = ''''R''''
			AND LA_CUR_PRI > 0
	   '')'
      EXEC (@QUERY)

RETURN 0
