CREATE PROCEDURE [dbo].[spMD_GetACHLoanLevelData]
	@AccountNumber				VARCHAR(10) ,
	@OnACHIndicator				BIT
AS
BEGIN

	SET NOCOUNT ON;
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
    -- Insert statements for procedure here
	SELECT 
		CAST(LN10.LN_SEQ AS INT) AS LoanSequenceNumber,
		CONVERT(VARCHAR, LN10.LD_LON_1_DSB, 101) AS FirstDisbursementDate,
		LN10.IC_LON_PGM AS LoanType
	FROM 
		dbo.LN10_LON LN10
		INNER JOIN PD10_PRS_NME PD10
			ON PD10.DF_PRS_ID = LN10.BF_SSN
		LEFT OUTER JOIN dbo.LN83_EFT_TO_LON LN83
			ON LN10.BF_SSN = LN83.BF_SSN
			AND LN10.LN_SEQ = LN83.LN_SEQ
	WHERE 
		PD10.DF_SPE_ACC_ID = @AccountNumber
		AND (
				(@OnACHIndicator = 1 AND (LN83.LC_STA_LN83 = 'A' AND (LN83.LD_EFT_EFF_END IS NULL OR LN83.LD_EFT_EFF_END > GETDATE())))
				OR 
				(@OnACHIndicator = 0 AND LN83.BF_SSN IS NULL)
				OR
				(@OnACHIndicator = 0 AND LN83.LC_STA_LN83 != 'A' AND (LN83.LD_EFT_EFF_END IS NOT NULL OR LN83.LD_EFT_EFF_END < GETDATE()))
			)
		AND LN10.LA_CUR_PRI > 0
	ORDER BY 
		CAST(LN10.LN_SEQ AS INT)
END
GO
GRANT EXECUTE
    ON OBJECT::[dbo].[spMD_GetACHLoanLevelData] TO [UHEAA\Imaging Users]
    AS [dbo];

