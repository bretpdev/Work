
CREATE PROCEDURE [dbo].[spMD_GetCompassLoanData]
	@AccountNumber				VARCHAR(10)
AS
BEGIN
--declare @AccountNumber				VARCHAR(10)
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

    SELECT DISTINCT
		CAST(LN10.LN_SEQ AS INT) as LoanSeqNum,
		LN10.IC_LON_PGM as LoanType,
		CONVERT(VARCHAR, LN10.LD_LON_1_DSB ,101) as FirstDisbursementDate,
		LN10.LA_LON_AMT_GTR as OriginalBalance,
		LN10.LA_CUR_PRI as CurrentPrincipal,
		coalesce(LN72.LR_ITR,0.000) as InterestRate,
		COALESCE(FTRS.Label, RS.LC_TYP_SCH_DIS,'') as RepaymentType,
		ISNULL(FTLS.Label,'') as [Status],
		coalesce(DW01.WC_DW_LON_STA,'') as StatusCode,
		ISNULL(CONVERT(VARCHAR,SCH_INFO.LD_SCL_SPR,101),'') as SeparationDate,
		ISNULL(CONVERT(VARCHAR, LN10.LD_END_GRC_PRD,101),'') as GraceEndDate,
		ISNULL(CONVERT(VARCHAR, DW01.WD_LON_RPD_SR,101),'') as RepaymentStartDate,
		ISNULL(CONVERT(VARCHAR, RS.LD_SNT_RPD_DIS,101),'') as Disclosure,
		ISNULL(SCH_INFO.IM_SCL_FUL,'') as SchoolName,
		coalesce(BILL.BIL_MTD,'') as BillMethod, 
		coalesce(RS.LN_RPS_TRM,0) as RepaymentTerm,
		ISNULL(CAST(DAY(RS.LD_RPS_1_PAY_DU) AS VARCHAR(2)),'') as DueDate,
		coalesce(LN72.LR_INT_RDC_PGM_ORG,0.000) as StatutoryInterestRate, --
		cast(coalesce(LN55.LN_BBS_STS_PCV_PAY,0)as int) as OnTimeMontlyPayments,
		cast(coalesce(LN55.PN_BBT_DLQ_MOT,0) as int) as RequiredOnTimePayments,
		ISNULL(CONVERT(VARCHAR,RS.LD_CRT_LON65,101),'') as RPSDate,
		coalesce(BILL.PAID_AHEAD,'N') as PaidAhead,
		coalesce(LN72.LR_INT_RDC_PGM_ORG,0.000) as RegInt, --
		CASE WHEN ISNULL(LN83.LC_STA_LN83,'N') = 'A' THEN 'Y' ELSE 'N' END AS OnACH, --A = Y, anything else = N
		CASE
			WHEN coalesce(BR30.BN_EFT_NSF_CTR,0) >= 2 THEN 'N' 
			ELSE 'Y'
		END as ACHEligible,
		coalesce(RP30.PR_EFT_RIR,  0.000) AS ACHRate,
		cast(dbo.GetLoanRirCount(@AccountNumber, LN10.LN_SEQ) as nvarchar(max)) as RIRCount,
		cast(dbo.GetLoanRirInt(@AccountNumber, LN10.LN_SEQ, LN10.IC_LON_PGM) as nvarchar(max)) as RIRInt,
		dbo.GetLoanRirType(@AccountNumber, LN10.LN_SEQ) as RIRType,
		'NA' AS HEP,
		CASE WHEN LN54.LC_BBS_ELG = 'Y' THEN 'Y' ELSE 'N' END as RIREligibility,
		ISNULL(CONVERT(VARCHAR, LN55.LD_BBS_DSQ,101),'') as RIREligibilityDate
	FROM 
		LN10_LON LN10
		JOIN PD10_PRS_NME PD10
			ON PD10.DF_PRS_ID= LN10.BF_SSN
		LEFT JOIN
		(
			SELECT
				LN72.BF_SSN,
				LN72.LN_SEQ,
				LN72.LR_ITR,
				LN72.LR_INT_RDC_PGM_ORG,
				ROW_NUMBER() OVER (PARTITION BY LN72.BF_SSN, LN72.LN_SEQ ORDER BY LD_STA_LON72 DESC) AS SEQ
			FROM	
				LN72_INT_RTE_HST LN72
				INNER JOIN PD10_PRS_NME PD10
					ON PD10.DF_PRS_ID = LN72.BF_SSN
			WHERE
				LN72.LC_STA_LON72 = 'A'
				AND
				GETDATE() BETWEEN LN72.LD_ITR_EFF_BEG AND LN72.LD_ITR_EFF_END
				AND 
				PD10.DF_SPE_ACC_ID = @AccountNumber

			) LN72 ON LN10.BF_SSN = LN72.BF_SSN	AND LN10.LN_SEQ = LN72.LN_SEQ AND LN72.SEQ = 1
		LEFT JOIN
		(
			SELECT
				RS.BF_SSN,
				RS.LN_SEQ,
				RS.LC_TYP_SCH_DIS,
				RS10.LD_SNT_RPD_DIS,
				RS.LN_RPS_TRM,
				RS10.LD_RPS_1_PAY_DU,
				LN65.LD_CRT_LON65
			FROM
				RS10_BR_RPD RS10
				INNER JOIN LN65_LON_RPS LN65
					ON LN65.BF_SSN = RS10.BF_SSN
					AND LN65.LN_RPS_SEQ = RS10.LN_RPS_SEQ
				INNER JOIN calc.RepaymentSchedules RS
					ON RS.BF_SSN = LN65.BF_SSN
					AND RS.LN_SEQ = LN65.LN_SEQ
					AND RS.LN_RPS_SEQ = LN65.LN_RPS_SEQ
					AND RS.CurrentGradation = 1
				INNER JOIN PD10_PRS_NME PD10
					ON PD10.DF_PRS_ID = RS.BF_SSN
			WHERE
				RS10.LC_STA_RPST10 = 'A'
				AND LN65.LC_STA_LON65 = 'A'
				AND PD10.DF_SPE_ACC_ID = @AccountNumber
		)RS
			ON RS.BF_SSN = LN10.BF_SSN
			AND RS.LN_SEQ = LN10.LN_SEQ
		LEFT JOIN dbo.DW01_DW_CLC_CLU DW01
			ON LN10.BF_SSN = DW01.BF_SSN
			AND LN10.LN_SEQ = DW01.LN_SEQ
		LEFT JOIN 
		(
			SELECT	
				LN13.BF_SSN,
				LN13.LN_SEQ,
				SD10.LN_STU_SPR_SEQ,
				SD10.LD_SCL_SPR,
				SC10.IM_SCL_FUL
			FROM SD10_STU_SPR SD10
				INNER JOIN SC10_SCH_DMO SC10
					ON SD10.LF_DOE_SCL_ENR_CUR = SC10.IF_DOE_SCL
				INNER JOIN LN13_LON_STU_OSD LN13
					ON SD10.LF_STU_SSN = LN13.LF_STU_SSN
					AND SD10.LN_STU_SPR_SEQ = LN13.LN_STU_SPR_SEQ
				INNER JOIN PD10_PRS_NME PD10
					ON PD10.DF_PRS_ID = LN13.BF_SSN
			WHERE 
				SD10.LC_STA_STU10 = 'A'
				AND LN13.LC_STA_LON13 = 'A'
				AND PD10.DF_SPE_ACC_ID = @AccountNumber
		)SCH_INFO
			ON SCH_INFO.BF_SSN = LN10.BF_SSN
			AND SCH_INFO.LN_SEQ = LN10.LN_SEQ	
		LEFT JOIN dbo.LOAN_Bill BILL
			ON PD10.DF_SPE_ACC_ID = BILL.DF_SPE_ACC_ID
			AND LN10.LN_SEQ = BILL.LN_SEQ
		LEFT JOIN 
		(
			SELECT
				LN83.BF_SSN,
				LN83.LN_SEQ,
				LN83.LC_STA_LN83
			FROM			
				LN83_EFT_TO_LON LN83
				INNER JOIN 
				(
					SELECT	
						BF_SSN,
						LN_SEQ,
						MAX(BN_EFT_SEQ) AS BN_EFT_SEQ
					FROM
						LN83_EFT_TO_LON LN83
						INNER JOIN PD10_PRS_NME PD10
							ON PD10.DF_PRS_ID = LN83.BF_SSN
					WHERE
						PD10.DF_SPE_ACC_ID = @AccountNumber
					GROUP BY
						BF_SSN,
						LN_SEQ
				)MAX_VAL
					ON MAX_VAL.BF_SSN = LN83.BF_SSN
					AND MAX_VAL.LN_SEQ = LN83.LN_SEQ
					AND MAX_VAL.BN_EFT_SEQ = LN83.BN_EFT_SEQ
		)
		LN83
			ON ln10.BF_SSN = LN83.BF_SSN
			AND LN10.LN_SEQ = LN83.LN_SEQ
		LEFT JOIN
		(
			SELECT
				BR30.BF_SSN,
				BR30.BN_EFT_NSF_CTR
			FROM
				BR30_BR_EFT BR30
				INNER JOIN
				(
					SELECT
						BF_SSN,
						MAX(BN_EFT_SEQ) AS BN_EFT_SEQ
					FROM
						BR30_BR_EFT BR30
						INNER JOIN PD10_PRS_NME PD10
							ON PD10.DF_PRS_ID = BR30.BF_SSN
					WHERE
						PD10.DF_SPE_ACC_ID = @AccountNumber
					GROUP BY
						BF_SSN
				)MAX_EFT
					ON MAX_EFT.BF_SSN = BR30.BF_SSN
					AND MAX_EFT.BN_EFT_SEQ = BR30.BN_EFT_SEQ
			WHERE
				BR30.BC_EFT_STA = 'A'
		 )BR30
			ON LN10.BF_SSN = BR30.BF_SSN
		LEFT JOIN LN54_LON_BBS LN54
			ON LN10.LN_SEQ = LN54.LN_SEQ
			AND LN54.BF_SSN = ln10.BF_SSN
			AND LN54.LC_STA_LN54 = 'A'
		LEFT JOIN
		(
			SELECT DISTINCT
				LN10.BF_SSN,
				LN10.LN_SEQ,
				ln10.LF_LON_CUR_OWN,
				RP30.PR_EFT_RIR,
				LN54.PM_BBS_PGM,
				COALESCE(LN54.LN_BBS_STS_PCV_PAY,0) AS LN_BBS_STS_PCV_PAY,
				RP02.PN_BBT_DLQ_MOT,
				LN54.LC_STA_LN54,
				LN54.LD_BBS_DSQ,
				LN54.LC_BBS_ELG ,
				RP30.PC_EFT_RIR_STA,
				RP02.PC_STA_RP02,
				((CONVERT([varchar](4),ISNULL(LN54.LN_BBS_STS_PCV_PAY,0),0)+'/')+CONVERT([varchar](4),ISNULL(PN_BBT_DLQ_MOT,0),0)) as RIR_CT
			FROM  
				LN10_LON LN10
			INNER JOIN PD10_PRS_NME PD10
				ON PD10.DF_PRS_ID = LN10.BF_SSN
			LEFT JOIN RP30_EFT_RIR_PAR RP30
				ON LN10.LF_LON_CUR_OWN = RP30.IF_OWN
				AND RP30.PC_EFT_RIR_STA = 'A'
			LEFT JOIN LN54_LON_BBS LN54
				ON LN10.BF_SSN = LN54.BF_SSN
				AND LN10.LN_SEQ = LN54.LN_SEQ
			LEFT JOIN RP02_BBS_PGM_TIR RP02
				ON LN54.PM_BBS_PGM = RP02.PM_BBS_PGM 
				AND LN54.PN_BBS_PGM_SEQ = RP02.PN_BBS_PGM_SEQ
				AND RP02.PC_STA_RP02 = 'A'
			WHERE
				PD10.DF_SPE_ACC_ID = @AccountNumber
		) LN55
			ON LN55.BF_SSN = LN10.BF_SSN
			AND LN55.LN_SEQ = LN10.LN_SEQ
		LEFT OUTER JOIN RP30_EFT_RIR_PAR RP30
			ON LN10.LF_LON_CUR_OWN = RP30.IF_OWN
			AND RP30.PC_EFT_RIR_STA = 'A'
			AND (RP30.IF_OWN IN ('834396', '830132', '82976901', '82976902', '82976903', '82976904','82976905','82976906', '82976907', '82976908') 
			     OR (RP30.IF_OWN IN ('828476', '834529') AND LN10.LD_LON_1_DSB >= RP30.PD_EFT_RIR_EFF_BEG AND LN10.IC_LON_PGM = RP30.IC_LON_PGM AND RP30.PD_EFT_RIR_EFF_BEG = (select top 1 PD_EFT_RIR_EFF_BEG from RP30_EFT_RIR_PAR eft where LN10.IC_LON_PGM = eft.IC_LON_PGM and LN10.LD_LON_1_DSB >= eft.PD_EFT_RIR_EFF_BEG order by PD_EFT_RIR_EFF_BEG desc))
				 OR (RP30.IF_OWN IN ('828476', '834529') AND LN10.IC_LON_PGM = RP30.IC_LON_PGM AND RP30.PD_EFT_RIR_EFF_BEG = (select top 1 PD_EFT_RIR_EFF_BEG from RP30_EFT_RIR_PAR eft where LN10.IC_LON_PGM = eft.IC_LON_PGM and LN10.LD_LON_1_DSB < eft.PD_EFT_RIR_EFF_BEG order by PD_EFT_RIR_EFF_BEG asc) AND NOT EXISTS(select * from RP30_EFT_RIR_PAR eft where LN10.IC_LON_PGM = eft.IC_LON_PGM and LN10.LD_LON_1_DSB >= eft.PD_EFT_RIR_EFF_BEG))
				 OR (RP30.IF_OWN IN ('826717', '834437', '834493', '83449301', '82847601', '829769') AND LN10.IC_LON_PGM = RP30.IC_LON_PGM))
		LEFT JOIN FormatTranslation FTLS
			ON FTLS.FmtName = '$LONSTA'
			AND FTLS.Start = DW01.WC_DW_LON_STA
		LEFT JOIN FormatTranslation FTRS
			ON FTRS.FmtName = '$SCHTYP'
			AND FTRS.Start = RS.LC_TYP_SCH_DIS
	WHERE 
		PD10.DF_SPE_ACC_ID = @AccountNumber
END
GO
GRANT EXECUTE
    ON OBJECT::[dbo].[spMD_GetCompassLoanData] TO [UHEAA\Imaging Users]
    AS [dbo];

