CREATE PROCEDURE [dbo].[GetEcorrInformation]
	@AccountNumber CHAR(10),
	@TESTMODE BIT

AS BEGIN
DECLARE @QUERY VARCHAR(MAX), @TSQL VARCHAR(MAX)
	IF @TESTMODE = 1
		SELECT @TSQL = 'SELECT * FROM OPENQUERY(QADBD004,'
	ELSE
		SELECT @TSQL = 'SELECT * FROM OPENQUERY(DUSTER,'

	SELECT  @QUERY = @TSQL + 
	  '''
		SELECT DISTINCT
			'''''+@AccountNumber+''''' AS AccountNumber,
			PD10.DF_PRS_ID AS Ssn,
			COALESCE(DX_CNC_EML_ADR,''''Ecorr@MyCornerStoneLoan.org'''') AS EmailAddress,
			COALESCE(CASE WHEN DI_VLD_CNC_EML_ADR = ''''Y'''' THEN 1 ELSE 0 END,0) AS ValidEmail,
			COALESCE(CASE WHEN DI_CNC_ELT_OPI = ''''Y'''' THEN 1 ELSE 0 END,0) AS LetterIndicator,
			COALESCE(CASE WHEN DI_CNC_EBL_OPI = ''''Y'''' THEN 1 ELSE 0 END,0) AS EbillIndicator,
			COALESCE(CASE WHEN DI_CNC_TAX_OPI = ''''Y'''' THEN 1 ELSE 0 END,0) AS TaxIndicator
			
		FROM 
			OLWHRM1.PD10_PRS_NME PD10
			LEFT JOIN 	OLWHRM1.PH05_CNC_EML PH05
				ON PH05.DF_SPE_ID = PD10.DF_SPE_ACC_ID
		WHERE
			 PD10.DF_SPE_ACC_ID = ''''' + @AccountNumber + '''''
	   '')'

EXEC (@QUERY)
END
RETURN 0
