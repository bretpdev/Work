
CREATE PROCEDURE [dbo].[LT_US06BDDSMC_FormFields]
	@BF_SSN  CHAR(9)
AS

SELECT 
	CONVERT(VARCHAR(10), LN80.LD_BIL_DU_LON,101) as DueDate,
	'$' + CONVERT(VARCHAR(15),(LN80.LA_BIL_CUR_DU + BR30.BA_EFT_ADD_WDR),1) AS TotalAmount,
	'$' + CONVERT(VARCHAR(15),LN80.LA_BIL_CUR_DU,1) AS InstallAmount,
	'$' + CONVERT(VARCHAR(15),BR30.BA_EFT_ADD_WDR,1) AS AdditionalAmount
FROM
	UDW..BR30_BR_EFT BR30
	LEFT JOIN 
	(
		SELECT	
			LN80.BF_SSN,
			LN80.LD_BIL_DU_LON,
			SUM(LN80.LA_BIL_CUR_DU) AS LA_BIL_CUR_DU
		FROM
			UDW..LN80_LON_BIL_CRF LN80
			INNER JOIN
			(
				SELECT	
					LN80.BF_SSN,
					LN80.LN_SEQ,
					MAX(LN80.LD_BIL_CRT) AS MAX_LD_BIL_CRT,
					MAX(LN80.LN_BIL_OCC_SEQ) AS MAX_LN_BIL_OCC_SEQ
				FROM
					UDW..LN80_LON_BIL_CRF LN80
				WHERE
					LN80.LC_STA_LON80 = 'A'
				GROUP BY
					LN80.BF_SSN,
					LN80.LN_SEQ
			)LN80_MAX
				ON LN80_MAX.BF_SSN = LN80.BF_SSN
				AND LN80_MAX.LN_SEQ = LN80.LN_SEQ
				AND LN80_MAX.MAX_LD_BIL_CRT = LN80.LD_BIL_CRT
				AND LN80_MAX.MAX_LN_BIL_OCC_SEQ = LN80.LN_BIL_OCC_SEQ
		WHERE
			LN80.LC_STA_LON80 = 'A'
		GROUP BY
			LN80.BF_SSN,
			LN80.LD_BIL_DU_LON
	)LN80
		ON LN80.BF_SSN = BR30.BF_SSN
	INNER JOIN
	(
		SELECT
			BF_SSN,
			MAX(BD_EFT_STA) AS BD_EFT_STA
		FROM
			UDW..BR30_BR_EFT
		WHERE
			BC_EFT_STA = 'A'
		GROUP BY
			BF_SSN
	) MAX_BR30
		ON MAX_BR30.BF_SSN = BR30.BF_SSN
		AND MAX_BR30.BD_EFT_STA = BR30.BD_EFT_STA
WHERE
	BR30.BF_SSN = @BF_SSN

RETURN 0