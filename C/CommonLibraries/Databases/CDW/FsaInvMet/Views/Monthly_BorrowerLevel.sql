
CREATE VIEW [FsaInvMet].Monthly_BorrowerLevel

AS

SELECT * FROM
(
	SELECT DISTINCT
		BD.BF_SSN,
		MIN(BD.LD_LON_EFF_ADD) AS LD_LON_EFF_ADD,
		MAX(PerfLoan.WC_DW_LON_STA) AS WC_DW_LON_STA,
		MAX(PerfLoan.SPEC_FORB_IND) AS SPEC_FORB_IND,
		MAX(BD.LN_DLQ_MAX) AS LN_DLQ_MAX,
		MAX(PerfLoan.LC_CAM_LON_STA) AS LC_CAM_LON_STA,
		SUM(ISNULL(BD.LA_OTS_PRI_ELG,0)) AS LA_CUR_PRI,
		SUM(ISNULL(BD.WA_TOT_BRI_OTS,0)) AS WA_TOT_BRI_OTS,
		SUM(ISNULL(BD.LA_OTS_PRI_ELG,0) + ISNULL(BD.WA_TOT_BRI_OTS,0)) AS TOT_AMT,
		CASE WHEN COUNT(DISTINCT BD.IC_LON_PGM) = 1 THEN MAX(BD.IC_LON_PGM)
			 ELSE 'MX' /*mixed loan programs*/
		END AS LON_PGM,
		COUNT(DISTINCT BD.LN_SEQ) AS LOAN_COUNT,
		SUM(CASE WHEN DATEADD(D,-(DAY(DATEADD(M,-1,GETDATE()-2))),DATEADD(M,-1,GETDATE()-1)) > BD.LD_PIF_RPT AND BD.LD_PIF_RPT IS NOT NULL THEN 1 ELSE 0 END) AS PIF_CT_B4_REP_MO, /*first day prev month*/
		--MAX(ISNULL(PifPrevious.PIF_CT_B4_REP_MO,0)) AS PIF_CT_B4_REP_MO,
		SUM(CASE WHEN BD.LD_PIF_RPT BETWEEN DATEADD(D,-(DAY(DATEADD(M,-1,GETDATE()-2))),DATEADD(M,-1,GETDATE()-1)) AND DATEADD(D,-(DAY(GETDATE())),GETDATE()) THEN 1 ELSE 0 END) AS PIF_CT_REP_MO, /*first and last day prev month*/
		--MAX(ISNULL(PifCurrent.PIF_CT_REP_MO,0)) AS PIF_CT_REP_MO,
		SUM(CASE WHEN BD.LC_STA_LON10 = 'D' AND BD.LA_OTS_PRI_ELG  = 0 AND DATEADD(D,-(DAY(DATEADD(M,-1,GETDATE()-2))),DATEADD(M,-1,GETDATE()-1)) > BD.LD_STA_LON10  AND BD.LD_STA_LON10 IS NOT NULL THEN 1 ELSE 0 END) AS DSTAT_CT_B4_REP_MO, /*first day prev month*/
		--MAX(ISNULL(DcvPrevious.DSTAT_CT_B4_REP_MO,0)) AS DSTAT_CT_B4_REP_MO,
		SUM(CASE WHEN BD.LC_STA_LON10 = 'D' AND BD.LA_OTS_PRI_ELG  = 0 AND BD.LD_STA_LON10 BETWEEN DATEADD(D,-(DAY(DATEADD(M,-1,GETDATE()-2))),DATEADD(M,-1,GETDATE()-1)) AND DATEADD(D,-(DAY(GETDATE())),GETDATE()) THEN 1 ELSE 0 END) AS DSTAT_CT_REP_MO,/*first and last day prev month*/
		--MAX(ISNULL(DcvCurrent.DSTAT_CT_REP_MO,0)) AS DSTAT_CT_REP_MO,
		MAX(BD.LD_PIF_RPT) AS LD_PIF_RPT,
		MAX(PerfLoan.LD_STA_LON10) AS LD_STA_LON10,
		MAX(PerfLoan.ActiveMilitaryIndicator) AS IS_ACTIVE_MILT,
		MIN(PerfLoan.BILL_SATISFIED) AS BILL_SATISFIED,
		MAX(BD.Segment) AS SEGMENT,
		MAX(PerfLoan.PerformanceCategory) AS PerformanceCategory,
		MAX(BD.DX_ADR_EML) AS DX_ADR_EML
	FROM
		[FsaInvMet].[Monthly_LoanLevel] BD
		LEFT JOIN [FsaInvMet].[Monthly_LoanLevel] PerfLoan ON PerfLoan.BF_SSN = BD.BF_SSN
			AND PerfLoan.LN_SEQ = BD.LN_SEQ
			AND PerfLoan.PerformanceSequence = 1
			AND PerfLoan.LoanStatusPriority = 1
	GROUP BY
		BD.BF_SSN
) BorrowerLevel
WHERE 
	BorrowerLevel.PIF_CT_B4_REP_MO + BorrowerLevel.DSTAT_CT_B4_REP_MO != BorrowerLevel.LOAN_COUNT;