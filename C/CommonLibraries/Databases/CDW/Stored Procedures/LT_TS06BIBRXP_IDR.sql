CREATE PROCEDURE [dbo].[LT_TS06BIBRXP_IDR]
	@AccountNumber		char(10)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;


SELECT DISTINCT
	CONVERT(CHAR(10),DATEADD(DAY, -35, RS05.BD_ANV_QLF_IBR),101) AS SoftDeadline,
	RS05.BA_PMN_STD_TOT_PAY AS PermStandardAmount,
	CASE WHEN DAY(RS05.BD_ANV_QLF_IBR) <= LN65.DUE_DAY 
			THEN CONVERT(CHAR(10),DATEADD(DAY, LN65.DUE_DAY - DAY(RS05.BD_ANV_QLF_IBR), RS05.BD_ANV_QLF_IBR),101)--set the day to DUE_DAY
		 WHEN DAY(RS05.BD_ANV_QLF_IBR) > LN65.DUE_DAY 
			THEN CONVERT(CHAR(10),DATEADD(MONTH, 1, DATEADD(DAY, LN65.DUE_DAY - DAY(RS05.BD_ANV_QLF_IBR), RS05.BD_ANV_QLF_IBR)),101)--add a month and set the day to DUE_DAY
	END AS PermStandardBeginDate
FROM 
	RS05_IDR_Repayment RS05
	INNER JOIN LN65_RepaymentSched LN65 
		ON LN65.DF_SPE_ACC_ID = RS05.DF_SPE_ACC_ID
WHERE 
	RS05.BC_STA_RS05 = 'A' 
	AND (LN65.TYP_SCH_DIS LIKE '%IBR%' OR LN65.TYP_SCH_DIS LIKE '%ICR%' OR LN65.TYP_SCH_DIS LIKE '%PAYE%' OR LN65.TYP_SCH_DIS LIKE '%PFH%')
	AND RS05.DF_SPE_ACC_ID = @AccountNumber
END

IF @@ROWCOUNT = 0 
	BEGIN
		RAISERROR('No data returned.',11,2)
	END