%LET BANA = %STR(REQUIRED="FILEDSN=X:\PADR\ODBC\EA27_BANA.dsn; update_lock_typ=nolock; bl_keepnulls=no");
LIBNAME BANA ODBC &BANA ;

DATA EMAIL_FILE; 
 infile 'X:\Archive\BANA\Production Files\Supplemental Files\EMAILUHEAA_20160202.txt' delimiter = ',' FIRSTOBS=2 MISSOVER DSD lrecl=32767 ;
 input Client_Cd :$2. Account :$10. Pkt :2. Borrower_Email_Address :$254.;
run;

DATA BANA.EMAIL_FILE;
SET EMAIL_FILE;
RUN;

/*TEST*/
/*LIBNAME  DUSTER  REMOTE  SERVER=QADBD004 SLIBREF=WORK  ;*/

/*LIVE*/
LIBNAME  DUSTER  REMOTE  SERVER=DUSTER  SLIBREF=WORK;

DATA DUSTER.EMAIL_FILE;
SET EMAIL_FILE;
RUN;


RSUBMIT;  
/*%let DB = DLGSWQUT;  *This is test;*/
%let DB = DLGSUTWH;  *This is live;
LIBNAME OLWHRM1 DB2 DATABASE=&DB OWNER=OLWHRM1;
PROC SQL;
	CREATE TABLE PD32 AS
		SELECT DISTINCT
			E.ACCOUNT,
			E.Borrower_Email_Address
		FROM
			 EMAIL_FILE E
		LEFT JOIN OLWHRM1.PD32_PRS_ADR_EML PD32
			ON PD32.DF_PRS_ID = E.ACCOUNT
		WHERE
			E.Borrower_Email_Address ^= DX_ADR_EML 
;
QUIT;
ENDRSUBMIT;		

DATA PD32;
SET DUSTER.PD32;
RUN;

PROC EXPORT DATA = WORK.PD32 
            OUTFILE = "T:\BORROWERS WITH MISSING EMAIL ADDRESS.xlsx" 
            DBMS = EXCEL
			REPLACE;
     SHEET="Sheet1"; 
RUN;
