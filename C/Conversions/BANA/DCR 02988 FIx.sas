%LET BANA = %STR(REQUIRED="FILEDSN=X:\PADR\ODBC\EA27_BANA.dsn; update_lock_typ=nolock; bl_keepnulls=no");
LIBNAME BANA ODBC &BANA ;


PROC SQL;
	CREATE TABLE E_02988_02989_ AS 
		SELECT DISTINCT
			MAP.*
		FROM
			BANA.Borrower_Errors E
			INNER JOIN BANA.COMPASSLOANMAPPING MAP
				ON MAP.BORROWERSSN = E.BR_SSN
				AND MAP.LN_SEQ = INPUT(E.LN_SEQ,BEST12.)
			INNER JOIN BANA._05SupplementalBorrowerRecord P
				ON P.BORROWERSSN = MAP.BORROWERSSN
				AND P.LOAN_NUMBER = MAP.LOAN_NUMBER
			INNER JOIN BANA._03PaymentDataRecord T
				ON T.BORROWERSSN = MAP.BORROWERSSN
				AND T.LOAN_NUMBER = MAP.LOAN_NUMBER
		WHERE
			E.ERROR_CODE in ('02988')
;
QUIT;

DATA DUSTER.E_02988_02989_;
SET E_02988_02989_;
RUN;

/*TEST*/
/*LIBNAME  DUSTER  REMOTE  SERVER=QADBD004 SLIBREF=WORK  ;*/

/*LIVE*/
LIBNAME  DUSTER  REMOTE  SERVER=DUSTER  SLIBREF=WORK;

RSUBMIT;  

/*%let DB = DLGSWQUT;  *This is test;*/
%let DB = DLGSUTWH;  *This is live;

LIBNAME OLWHRM1 DB2 DATABASE=&DB OWNER=OLWHRM1;
PROC SQL;
	CREATE TABLE E_02988_02989_FINAL AS
		SELECT DISTINCT
			RS10.BF_SSN,
			RS10.LN_RPS_SEQ,
			RS10.LD_RPS_1_PAY_DU AS OLD_LD_RPS_1_PAY_DU,
			CASE
				WHEN DAY(LD_RPS_1_PAY_DU) = 31 THEN INTNX('day' ,LD_RPS_1_PAY_DU, -3, 'same')
				WHEN DAY(LD_RPS_1_PAY_DU) = 30 THEN INTNX('day' ,LD_RPS_1_PAY_DU, -2, 'same')
				WHEN DAY(LD_RPS_1_PAY_DU) = 29 THEN INTNX('day' ,LD_RPS_1_PAY_DU, -1, 'same')
			END AS NEW_LD_RPS_1_PAY_DU
			FROM
				E_02988_02989_ P
			INNER JOIN OLWHRM1.RS10_BR_RPD RS10	
				ON P.BORROWERSSN = RS10.BF_SSN

		WHERE
			RS10.LC_STA_RPST10 = 'A'
		
;
QUIT;
ENDRSUBMIT;	

DATA E_02988_02989_FINAL;
SET DUSTER.E_02988_02989_FINAL;;
FORMAT OLD_LD_RPS_1_PAY_DU MMDDYY10.;
FORMAT NEW_LD_RPS_1_PAY_DU MMDDYY10.;
RUN;

PROC EXPORT DATA = WORK.E_02988_02989_FINAL 
            OUTFILE = "T:\DCR 02989.xlsx" 
            DBMS = EXCEL
			REPLACE;
     SHEET="RS10"; 
RUN;

