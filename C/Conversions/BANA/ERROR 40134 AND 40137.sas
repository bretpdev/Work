PROC IMPORT OUT= WORK.POP
            DATAFILE= "T:\Combined RPS DCR 020816.xlsx" 
            DBMS=EXCEL REPLACE;
     RANGE="RS10_ADD$"; 
     GETNAMES=YES;
     MIXED=NO;
     SCANTEXT=YES;
     USEDATE=YES;
     SCANTIME=YES;
RUN;


%LET BANA = %STR(REQUIRED="FILEDSN=X:\PADR\ODBC\EA27_BANA.dsn; update_lock_typ=nolock; bl_keepnulls=no");
LIBNAME BANA ODBC &BANA ;


PROC SQL;
	CREATE TABLE FINAL AS 
		SELECT DISTINCT
			BORROWERSSN,
			MAP.LN_SEQ
		FROM
			BANA.Borrower_Errors E
			
			INNER JOIN BANA.COMPASSLOANMAPPING MAP
				ON MAP.BORROWERSSN = E.BR_SSN
				AND MAP.LN_SEQ = INPUT(E.LN_SEQ,BEST12.)
		WHERE
			E.ERROR_CODE IN ('40134','40137')
			AND BORROWERSSN NOT IN (SELECT DISTINCT BF_SSN FROM POP)
;
QUIT;

LIBNAME  DUSTER  REMOTE  SERVER=DUSTER  SLIBREF=WORK;

DATA DUSTER.FINAL;
SET FINAL;
RUN;


RSUBMIT;  

/*%let DB = DLGSWQUT;  *This is test;*/
%let DB = DLGSUTWH;  *This is live;

LIBNAME OLWHRM1 DB2 DATABASE=&DB OWNER=OLWHRM1;
PROC SQL;
	CREATE TABLE FINAL_OUTPUT AS
		SELECT DISTINCT
			LN10.BF_SSN,
			LN10.LN_SEQ,
			PF_MAJ_BCH,
			PF_MNR_BCH,
			LA_CUR_PRI,
			LR_ITR
		FROM
			OLWHRM1.LN10_LON LN10
			INNER JOIN OLWHRM1.LN72_INT_RTE_HST LN72
				ON LN72.BF_SSN = LN10.BF_SSN
				AND LN72.LN_SEQ = LN10.LN_SEQ
			INNER JOIN FINAL F
				ON F.BORROWERSSN = LN10.BF_SSN
				AND F.LN_SEQ = LN10.LN_SEQ
		WHERE
			LC_STA_LON72 = 'A'
			AND TODAY() BETWEEN LD_ITR_EFF_BEG AND LD_ITR_EFF_END
;
QUIT;
ENDRSUBMIT;	

DATA FINAL_OUTPUT;
SET DUSTER.FINAL_OUTPUT;
RUN;

PROC EXPORT DATA = WORK.FINAL_OUTPUT 
            OUTFILE = "T:\ERROR 40134 AND 40137.xlsx" 
            DBMS = EXCEL
			REPLACE;
     SHEET="SHEET1"; 
RUN;
