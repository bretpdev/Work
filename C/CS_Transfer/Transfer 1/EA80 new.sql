INSERT INTO CDW..CS_Transfer_EA80(BF_SSN, LastName, FirstName, LoanId, LoanProgramType, GuarantyDate, SaleDate, DealId, PostSale, TransferNumber)
SELECT DISTINCT
	T1.BF_SSN,
	CentralData.dbo.TRIM(PD10.DM_PRS_LST) AS LastName,
	CentralData.dbo.TRIM(PD10.DM_PRS_1) AS FirstName,
	FS10.LF_FED_AWD + RIGHT('000' + CAST(FS10.LN_FED_AWD_SEQ AS VARCHAR(3)),3) AS LoanId,
	LN10.IC_LON_PGM AS LoanProgramType,
	CONVERT(varchar,LN10.LD_LON_GTR,101) AS GuarantyDate,
	'11/09/2020' AS SaleDate,
	'PSAOH' AS DealId,
	'Y' AS PostSale,
	1 AS TransferNumber
FROM
	CDW..CS_Transfer1 T1
	INNER JOIN CDW..CS_Transfer1Loans TL
		ON TL.BF_SSN = T1.BF_SSN
	INNER JOIN CDW..PD10_PRS_NME PD10
		ON PD10.DF_PRS_ID = T1.BF_SSN
	INNER JOIN CDW..LN10_LON LN10
		ON LN10.BF_SSN = PD10.DF_PRS_ID
		AND LN10.LN_SEQ = TL.LN_SEQ
		AND LN10.LA_CUR_PRI >= 0.00
		--AND LN10.LC_STA_LON10 = 'R'
	INNER JOIN CDW..FS10_DL_LON FS10
		ON FS10.BF_SSN = LN10.BF_SSN
		AND FS10.LN_SEQ = LN10.LN_SEQ
	INNER JOIN 
	(
		SELECT DISTINCT
			LN90.BF_SSN,
			LN90.LN_SEQ,
			SUM(COALESCE(LA_FAT_CUR_PRI,0.00)) AS LA_FAT_CUR_PRI,
			SUM(COALESCE(LA_FAT_NSI,0.00)) AS LA_FAT_NSI,
			MAX(LD_FAT_EFF) AS LD_FAT_EFF
		FROM
			CDW..LN90_FIN_ATY LN90
			INNER JOIN CDW..LN10_LON LN10
				ON LN10.BF_SSN = LN90.BF_SSN
				AND LN10.LN_SEQ = LN90.LN_SEQ
				AND LN10.LA_CUR_PRI >= 0.00
				AND LN10.LC_FED_PGM_YR = 'LNC'
				AND LN10.LD_PIF_RPT IS NULL		
			INNER JOIN CDW..CS_Transfer1Loans TL
                ON TL.BF_SSN = LN90.BF_SSN
                AND TL.LN_SEQ = LN90.LN_SEQ
		WHERE
			LN90.LC_STA_LON90 = 'A'
			AND COALESCE(LN90.LC_FAT_REV_REA,'') = ''
			AND LN90.PC_FAT_TYP = '04'
			AND LN90.PC_FAT_SUB_TYP = '96'
		GROUP BY
			LN90.BF_SSN,
			LN90.LN_SEQ
	) Trans
		ON Trans.BF_SSN = LN10.BF_SSN
		AND Trans.LN_SEQ = LN10.LN_SEQ
	LEFT JOIN
	(
		SELECT DISTINCT
			T1.BF_SSN
		FROM
			CDW..CS_Transfer1 T1
			INNER JOIN CDW..CS_Transfer1Loans TL
				ON TL.BF_SSN = T1.BF_SSN
			INNER JOIN CDW..PD10_PRS_NME PD10
				ON PD10.DF_PRS_ID = T1.BF_SSN
			INNER JOIN CDW..LN10_LON LN10
				ON LN10.BF_SSN = PD10.DF_PRS_ID
				AND LN10.LN_SEQ = TL.LN_SEQ
				AND LN10.LA_CUR_PRI >= 0.00
				--AND LN10.LC_STA_LON10 = 'R'
			INNER JOIN CDW..FS10_DL_LON FS10
				ON FS10.BF_SSN = LN10.BF_SSN
				AND FS10.LN_SEQ = LN10.LN_SEQ
			INNER JOIN 
			(
				SELECT DISTINCT
					LN90.BF_SSN,
					LN90.LN_SEQ,
					SUM(COALESCE(LA_FAT_CUR_PRI,0.00)) AS LA_FAT_CUR_PRI,
					SUM(COALESCE(LA_FAT_NSI,0.00)) AS LA_FAT_NSI,
					MAX(LD_FAT_EFF) AS LD_FAT_EFF
				FROM
					CDW..LN90_FIN_ATY LN90
					INNER JOIN CDW..LN10_LON LN10
						ON LN10.BF_SSN = LN90.BF_SSN
						AND LN10.LN_SEQ = LN90.LN_SEQ
						AND LN10.LA_CUR_PRI >= 0.00
						AND LN10.LC_FED_PGM_YR = 'DLO'
						AND LN10.LD_PIF_RPT IS NULL			
					INNER JOIN CDW..CS_Transfer1Loans TL
						ON TL.BF_SSN = LN90.BF_SSN
						AND TL.LN_SEQ = LN90.LN_SEQ
				WHERE
					LN90.LC_STA_LON90 = 'A'
					AND COALESCE(LN90.LC_FAT_REV_REA,'') = ''
					AND LN90.PC_FAT_TYP = '04'
					AND LN90.PC_FAT_SUB_TYP = '96'
				GROUP BY
					LN90.BF_SSN,
					LN90.LN_SEQ
			) Trans
				ON Trans.BF_SSN = LN10.BF_SSN
				AND Trans.LN_SEQ = LN10.LN_SEQ
		WHERE
			LN10.LC_FED_PGM_YR = 'DLO'
			AND LN10.LD_PIF_RPT IS NULL
	) DLO
		ON DLO.BF_SSN = T1.BF_SSN
WHERE
	LN10.LC_FED_PGM_YR = 'LNC'
	AND LN10.LD_PIF_RPT IS NULL
	AND DLO.BF_SSN IS NULL --Exclude DLO people from showing up in both files

INSERT INTO CDW..CS_Transfer_EA80(BF_SSN, LastName, FirstName, LoanId, LoanProgramType, GuarantyDate, SaleDate, DealId, PostSale, TransferNumber)
SELECT DISTINCT
	T1.BF_SSN,
	CentralData.dbo.TRIM(PD10.DM_PRS_LST) AS LastName,
	CentralData.dbo.TRIM(PD10.DM_PRS_1) AS FirstName,
	FS10.LF_FED_AWD + RIGHT('000' + CAST(FS10.LN_FED_AWD_SEQ AS VARCHAR(3)),3) AS LoanId,
	LN10.IC_LON_PGM AS LoanProgramType,
	CONVERT(varchar,LN10.LD_LON_GTR,101) AS GuarantyDate,
	'11/09/2020' AS SaleDate,
	'PSAOG' AS DealId,
	'Y' AS PostSale,
	1 AS TransferNumber
FROM
	CDW..CS_Transfer1 T1
	INNER JOIN CDW..CS_Transfer1Loans TL
		ON TL.BF_SSN = T1.BF_SSN
	INNER JOIN CDW..PD10_PRS_NME PD10
		ON PD10.DF_PRS_ID = T1.BF_SSN
	INNER JOIN CDW..LN10_LON LN10
		ON LN10.BF_SSN = PD10.DF_PRS_ID
		AND LN10.LN_SEQ = TL.LN_SEQ
		AND LN10.LA_CUR_PRI >= 0.00
		--AND LN10.LC_STA_LON10 = 'R'
	INNER JOIN CDW..FS10_DL_LON FS10
		ON FS10.BF_SSN = LN10.BF_SSN
		AND FS10.LN_SEQ = LN10.LN_SEQ
	INNER JOIN 
	(
		SELECT DISTINCT
			LN90.BF_SSN,
			LN90.LN_SEQ,
			SUM(COALESCE(LA_FAT_CUR_PRI,0.00)) AS LA_FAT_CUR_PRI,
			SUM(COALESCE(LA_FAT_NSI,0.00)) AS LA_FAT_NSI,
			MAX(LD_FAT_EFF) AS LD_FAT_EFF
		FROM
			CDW..LN90_FIN_ATY LN90
			INNER JOIN CDW..LN10_LON LN10
				ON LN10.BF_SSN = LN90.BF_SSN
				AND LN10.LN_SEQ = LN90.LN_SEQ
				AND LN10.LA_CUR_PRI >= 0.00
				AND LN10.LC_FED_PGM_YR = 'DLO'
				AND LN10.LD_PIF_RPT IS NULL
			INNER JOIN CDW..CS_Transfer1Loans TL
                ON TL.BF_SSN = LN90.BF_SSN
                AND TL.LN_SEQ = LN90.LN_SEQ
		WHERE
			LN90.LC_STA_LON90 = 'A'
			AND COALESCE(LN90.LC_FAT_REV_REA,'') = ''
			AND LN90.PC_FAT_TYP = '04'
			AND LN90.PC_FAT_SUB_TYP = '96'
		GROUP BY
			LN90.BF_SSN,
			LN90.LN_SEQ
	) Trans
		ON Trans.BF_SSN = LN10.BF_SSN
		AND Trans.LN_SEQ = LN10.LN_SEQ
WHERE
	LN10.LC_FED_PGM_YR = 'DLO'
	AND LN10.LD_PIF_RPT IS NULL
