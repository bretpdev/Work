--WE ARE TRUNCATING THE TABLE BECAUSE THIS WILL BE THE FIRST QUERY TO INSERT DATA
--TRUNCATE TABLE CDW..CS_Transfer2
--TRUNCATE TABLE CDW..CS_Transfer2Loans
--INSERT INTO CDW..CS_Transfer2
SELECT
	POP.*,
	SUM(CASE WHEN LN10.LC_FED_PGM_YR = 'LNC' THEN 1 ELSE 0 END) AS LNC_Count,
	SUM(CASE WHEN LN10.LC_FED_PGM_YR = 'DLO' THEN 1 ELSE 0 END) AS DLO_Count,
	NULL AS LNC_SaleId,
	NULL AS DLO_SaleId
FROM
(
SELECT DISTINCT 
	LN65.BF_SSN,
	'IDR' AS [POPULATION]
FROM 
	CDW..LN65_LON_RPS LN65 
	INNER JOIN CDW..RS10_BR_RPD RS10
		ON RS10.BF_SSN = LN65.BF_SSN
		AND RS10.LN_RPS_SEQ = LN65.LN_RPS_SEQ
	INNER JOIN CDW..LN10_LON LN10
		ON LN10.BF_SSN = LN65.BF_SSN
		AND LN10.LN_SEQ = LN65.LN_SEQ 
	LEFT JOIN CDW..CS_Transfer2_Exclusions EX
		ON EX.BF_SSN = LN65.BF_SSN
	LEFT JOIN CDW..CS_Transfer1 T1
		ON T1.BF_SSN = LN65.BF_SSN
WHERE 
	LC_TYP_SCH_DIS  IN 
	(
		'IB',
		'IL',
		'I3',
		'IP',
		'C1',
		'C2',
		'C3',
		'CQ',
		'CA',
		'CP',
		'IA',
		'I5',
		'RE'
)
	AND LN65.LC_STA_LON65 = 'A'
	AND RS10.LC_STA_RPST10 = 'A'
	AND LN10.LA_CUR_PRI > 0
	AND LN10.LC_STA_LON10 = 'R'
	AND EX.BF_SSN IS NULL
	AND T1.BF_SSN IS NULL

) POP
INNER JOIN CDW..LN10_LON LN10
	ON LN10.BF_SSN = POP.BF_SSN
	AND LN10.LA_CUR_PRI > 0
	AND LN10.LC_STA_LON10 = 'R'
GROUP BY
	POP.BF_SSN,
	POP.[POPULATION]
--229044