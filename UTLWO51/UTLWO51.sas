*-----------------------------------------------------*
| UTLWO51 Potential Invalid Deferment Clean Up Report |
*-----------------------------------------------------*;
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWO51.LWO51R2";
FILENAME REPORT3 "&RPTLIB/ULWO51.LWO51R3";
FILENAME REPORTZ "&RPTLIB/ULWO51.LWO51RZ";
DATA _NULL_;
     CALL SYMPUT('RUNDT',PUT(INTNX('DAY',TODAY(),0,'BEGINNING'), MMDDYYS10.));
	 CALL SYMPUT('RUNTIME',PUT(TIME(), TIME.));
RUN;
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE PIDCUR AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT B.DF_SPE_ACC_ID
	,B.DM_PRS_1 AS B1_NAME
	,LN10.IC_LON_PGM
	,CASE
		WHEN LN10.IC_LON_PGM = 'PLUS' THEN STU.STU_NAME
		ELSE COBR.CB1_NAME
	 END AS NAME2
	 ,CASE 
		WHEN LN10.IC_LON_PGM = 'PLUS' THEN STU.STU_ACCT_ID
	 	ELSE COBR.CB_ACCT_ID
	 END AS ACCT2
	,DFR.LD_DFR_BEG
	,DFR.LD_DFR_END
	,DFR.LD_DFR_CER
	,DFR.LC_DFR_TYP
FROM OLWHRM1.LN10_LON LN10
INNER JOIN OLWHRM1.PD10_PRS_NME B
	ON LN10.BF_SSN = B.DF_PRS_ID
/*---DEFERMENT INFORMATION AT LOAN LEVEL---*/
INNER JOIN (
	SELECT D.BF_SSN
		,D.LN_SEQ
		,D.LD_DFR_BEG
		,D.LD_DFR_END
/*		,C.LD_DFR_CER*/
		,C.LD_DFR_INF_CER AS LD_DFR_CER
		,C.LC_DFR_TYP
	FROM OLWHRM1.DF10_BR_DFR_REQ C
	INNER JOIN OLWHRM1.LN50_BR_DFR_APV D
		ON C.BF_SSN = D.BF_SSN
		AND C.LF_DFR_CTL_NUM = D.LF_DFR_CTL_NUM
	WHERE C.LC_DFR_TYP NOT IN ('19','20','21','22','23','24','25','26','27','28','30','31','32','33','34','35','36','37','99') /*('15','18')*/
	AND C.LD_DFR_INF_CER IS NOT NULL
	AND D.LD_DFR_END > CURRENT DATE
	AND C.LC_STA_DFR10 = 'A'
	AND D.LC_STA_LON50 = 'A'	
	 ) DFR
	ON LN10.BF_SSN = DFR.BF_SSN
	AND LN10.LN_SEQ = DFR.LN_SEQ
/*---------CO BORROWER INFORMATION---------*/
LEFT OUTER JOIN (
	SELECT DISTINCT X.BF_SSN
		,X.LN_SEQ
		,Y.DM_PRS_1 AS CB1_NAME
		,Y.DF_SPE_ACC_ID AS CB_ACCT_ID
	FROM OLWHRM1.LN20_EDS X
	INNER JOIN OLWHRM1.PD10_PRS_NME Y
		ON X.LF_EDS = Y.DF_PRS_ID
	WHERE X.LC_EDS_TYP = 'M'
	AND X.LC_STA_LON20 = 'A'
	 ) COBR
	ON LN10.BF_SSN = COBR.BF_SSN
	AND LN10.LN_SEQ = COBR.LN_SEQ
/*-----------STUDENT INFORMATION-----------*/
LEFT OUTER JOIN (
	SELECT DISTINCT X.BF_SSN
		,X.LN_SEQ
		,Y.DM_PRS_1 AS STU_NAME
		,Y.DF_SPE_ACC_ID AS STU_ACCT_ID
	FROM OLWHRM1.LN10_LON X
	INNER JOIN OLWHRM1.PD10_PRS_NME Y
		ON X.LF_STU_SSN = Y.DF_PRS_ID
	 ) STU
	ON LN10.BF_SSN = STU.BF_SSN
	AND LN10.LN_SEQ = STU.LN_SEQ
WHERE LN10.LC_STA_LON10 = 'R'
AND LN10.IC_LON_PGM IN ('SUBSPC','UNSPC','PLUS')
AND LN10.LA_CUR_PRI > 0
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWO51.LWO51RZ);*/
/*QUIT;*/
ENDRSUBMIT;
DATA PIDCUR;
SET WORKLOCL.PIDCUR;
RUN;

PROC SORT DATA=PIDCUR NODUPKEY;
BY DF_SPE_ACC_ID B1_NAME ACCT2 NAME2 LD_DFR_BEG LD_DFR_END LD_DFR_CER;
RUN;

%MACRO PRINT_REP(OPR,REP,TYPE,ACCT_2,NAME_2,INSTATEMENT);

DATA RDS;
	SET PIDCUR;
	WHERE IC_LON_PGM &OPR 'PLUS' &INSTATEMENT;
RUN;

PROC SORT DATA=RDS;
	BY DF_SPE_ACC_ID;
RUN;
PROC PRINTTO PRINT=REPORT&REP NEW;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 PAGENO=1 NODATE;
TITLE "&TYPE DEFERMENT";
TITLE2	"&RUNDT:&RUNTIME";
FOOTNOTE "JOB = UTLWO51  	 REPORT = ULWO51.LWO51R&REP";
PROC CONTENTS DATA=RDS OUT=EMPTYSET NOPRINT;
DATA _NULL_;
SET EMPTYSET;
FILE PRINT;
IF  NOBS=0 AND _N_ =1 THEN DO;
	PUT // 132*'-';
	PUT      //////
		@51 '**** NO OBSERVATIONS FOUND ****';
	PUT //////
		@57 '-- END OF REPORT --';
	PUT //////////////
		@46 "JOB = UTLWO51  	 REPORT = ULWO51.LWO51R&REP";
	END;
RETURN;
RUN;
PROC REPORT DATA=RDS NOWINDOWS HEADSKIP SPLIT='/';
COLUMN DF_SPE_ACC_ID B1_NAME ACCT2 NAME2 LD_DFR_BEG LD_DFR_END LD_DFR_CER;
DEFINE DF_SPE_ACC_ID / DISPLAY WIDTH=10 'BORROWER/ACCT #';
DEFINE B1_NAME / DISPLAY WIDTH=20 'BORROWER/FIRST NAME';
DEFINE ACCT2 / DISPLAY WIDTH=11 "&ACCT_2";
DEFINE NAME2 / DISPLAY WIDTH=20 "&NAME_2";
DEFINE LD_DFR_BEG / DISPLAY WIDTH=10 'DEFERMENT/BEGIN DATE' FORMAT=MMDDYY10.;
DEFINE LD_DFR_END / DISPLAY WIDTH=10 'DEFERMENT/END DATE' FORMAT=MMDDYY10.;;
DEFINE LD_DFR_CER / DISPLAY WIDTH=10 'DEFERMENT/CERT DATE' FORMAT=MMDDYY10.;;
RUN;
PROC PRINTTO;
RUN;
%MEND PRINT_REP;
%PRINT_REP(NE,2,SPOUSAL CONSOLIDATION LOANS WITH,CO-BORROWER/ACCT #,CO-BORRWER/FIRST NAME,);
%PRINT_REP(EQ,3,PLUS LOANS WITH IN-SCHOOL,STUDENT/ACCT #,STUDENT/FIRST NAME,AND LC_DFR_TYP IN ('15','18'));
