*------------------------------------------*
|UTLWG22 LOANS THAT NEED ENROLLMENT LINKING|
*------------------------------------------*;
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWG22.LWG22R2";
FILENAME REPORTZ "&RPTLIB/ULWG22.LWG22RZ";

LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE LTNEL AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT 
	A.DF_PRS_ID_STU AS SSN
	,RTRIM(C.AF_APL_ID)||''||C.AF_APL_ID_SFX AS CLUID
	,B.AD_IST_TRM_BEG 
	,D.AC_STA_GA14
FROM OLWHRM1.SD02_STU_ENR A
INNER JOIN OLWHRM1.GA01_APP B
	 ON A.DF_PRS_ID_STU = B.DF_PRS_ID_BR
INNER JOIN OLWHRM1.GA10_LON_APP C
	ON B.AF_APL_ID = C.AF_APL_ID
	AND C.AC_GTE_TRF <> 'O'
INNER JOIN OLWHRM1.GA14_LON_STA D
	ON C.AF_APL_ID = D.AF_APL_ID
	AND C.AF_APL_ID_SFX = D.AF_APL_ID_SFX
WHERE DAYS(A.LF_LST_DTS_SD02) = DAYS(CURRENT DATE) - 1
AND C.AC_PRC_STA = 'A'
AND D.AC_LON_STA_TYP  NOT IN (
	'CA','CP','DN','PC','PF','PN'
	)
AND D.AC_STA_GA14 = 'A'
);
DISCONNECT FROM DB2;
/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWG22.LWG22RZ);*/
/*QUIT;*/
ENDRSUBMIT;

DATA LTNEL;
SET WORKLOCL.LTNEL;
RUN;

PROC SORT DATA=LTNEL NODUPKEY;
BY CLUID ;
RUN;

DATA _NULL_;
SET  WORK.LTNEL;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
FORMAT SSN $9. ;
FORMAT CLUID $19. ;
FORMAT AD_IST_TRM_BEG MMDDYY10. ;
DO;
PUT SSN $ @;
PUT CLUID $ @;
PUT AD_IST_TRM_BEG ;
END;
RUN;
