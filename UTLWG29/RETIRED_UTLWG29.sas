*************************************************************;
*UTLWG29 BORROWERS WITH DECEASED ENROLLMENT STATUS ON ONELINK;
*************************************************************;

/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
/*FILENAME REPORT2 "&RPTLIB/ULWG29.LWG29R2";*/
/*FILENAME REPORTZ "&RPTLIB/ULWG29.LWG29RZ";*/

FILENAME REPORT2 'T:\SAS\ULWG29.LWG29R2.TEST.TXT';

DATA _NULL_;
     CALL SYMPUT('RUNDT',PUT(INTNX('DAY',TODAY(),0,'BEGINNING'), MMDDYYS10.));
RUN;

LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;

%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE BWDESOLK AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT SD02.DF_PRS_ID_STU
/*	,RTRIM(PD01.DM_PRS_LST)||', '||RTRIM(PD01.DM_PRS_1) AS NAME*/
/*	,SC01.IM_IST_FUL*/
/*	,SD02.IF_OPS_SCL_RPT*/
/*	,LN10.LF_LON_CUR_OWN*/
/*	,LN10.LN_SEQ*/
	,LN10.COMP_IND

	
FROM OLWHRM1.SD02_STU_ENR SD02
INNER JOIN OLWHRM1.PD01_PDM_INF PD01
	ON SD02.DF_PRS_ID_STU = PD01.DF_PRS_ID
INNER JOIN OLWHRM1.SC01_LGS_SCL_INF SC01
	ON SC01.IF_IST = SD02.IF_OPS_SCL_RPT
LEFT OUTER JOIN 
	(SELECT ZZ.LF_STU_SSN
		,ZZ.LN_SEQ
		,LF_LON_CUR_OWN
		,'Y' AS COMP_IND
	 FROM OLWHRM1.LN10_LON  ZZ
	 INNER JOIN OLWHRM1.DW01_DW_CLC_CLU DW01
		ON DW01.BF_SSN = ZZ.LF_STU_SSN
		AND DW01.LN_SEQ = ZZ.LN_SEQ
		AND DW01.WC_DW_LON_STA NOT IN ('12','16','17')
	 WHERE LC_STA_LON10 = 'R' 
	 AND IF_GTR = '000749'
	 AND LA_CUR_PRI > 0
	 ) LN10
	ON SD02.DF_PRS_ID_STU = LN10.LF_STU_SSN	 


WHERE SD02.LC_STA_SD02 = 'A'
AND SD02.LC_STU_ENR_TYP = 'D'

FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;

/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWG29.LWG29RZ);*/
/*QUIT;*/

ENDRSUBMIT;
DATA BWDESOLK;
SET WORKLOCL.BWDESOLK;
RUN;

DATA BWDESOLK (DROP=COMP_IND);
SET BWDESOLK;
IF COMP_IND = 'Y' THEN OUTPUT;
ELSE DELETE;
RUN;


data _null_;
set  WORK.Bwdesolk;
file REPORT2 DSD DROPOVER LRECL=32767;
   format DF_PRS_ID_STU $9. ;
 do;
   put DF_PRS_ID_STU $ ;
 end;
run;
