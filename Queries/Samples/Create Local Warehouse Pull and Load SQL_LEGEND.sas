%LET TABLE = LN83_EFT_TO_LON;
%LET SCHEMA = 'PKUB';

LIBNAME  LEGEND  REMOTE  SERVER=LEGEND  SLIBREF=WORK;
%SYSLPUT TABLE = &TABLE;
%SYSLPUT SCHEMA = &SCHEMA;

RSUBMIT LEGEND;
/*%let DB = DNFPRQUT;  *This is test;*/
/*%let DB = DNFPRUUT;  *This is VUK3 test;*/
%let DB = DNFPUTDL;  *This is live;

LIBNAME PKUB DB2 DATABASE=&DB OWNER=PKUB;

PROC SQL;
	CONNECT TO DB2 (DATABASE=&DB);

	CREATE TABLE DEMO AS
		SELECT	
			*
		FROM	
			CONNECTION TO DB2 
				(
					select 
						C.*
/*						,CASE*/
/*							WHEN C.COLNAME IN ('DF_PRS_ID','BF_SSN') THEN 'DF_SPE_ACC_ID'*/
/*							ELSE C.COLNAME*/
/*						 END AS NEW_COLNAME*/
/*						,CASE*/
/*							WHEN C.COLNAME IN ('DF_PRS_ID','BF_SSN') THEN 10*/
/*							ELSE C.LENGTH*/
/*						 END AS NEW_LENGTH*/
						 ,C.COLNAME AS NEW_COLNAME
						 ,C.LENGTH AS NEW_LENGTH
					from 
					  syscat.columns C
					where 
						TABSCHEMA = &SCHEMA
						AND
						tabname in (%UNQUOTE(%STR(%')&TABLE%STR(%')))
				)
	;

	DISCONNECT FROM DB2;
QUIT;

ENDRSUBMIT;

DATA DEMO; SET LEGEND.DEMO; RUN;

PROC SQL;
	CREATE TABLE FMT AS
		SELECT
			COLNO
			,NEW_COLNAME
			,'['||STRIP(NEW_COLNAME)||']' AS SQL_COLNAME
			,TYPENAME
			,NEW_LENGTH
			,SCALE
			,NULLS
			,KEYSEQ
			,CASE
				WHEN TYPENAME IN ('CHARACTER','VARCHAR') THEN CATS(':$',NEW_LENGTH,'.') 
				WHEN TYPENAME = 'DATE' THEN ':DATE9.'
				WHEN TYPENAME = 'DECIMAL' THEN CATS(':',NEW_LENGTH,'.',SCALE)
				WHEN TYPENAME IN ('INTEGER','SMALLINT') THEN CATS(':',NEW_LENGTH,'.')
				WHEN TYPENAME = 'TIMESTAMP' THEN ':DATETIME25.'
				WHEN TYPENAME = 'TIME' THEN ':$8.'
				ELSE CATS('UNKNOWN_DATA_TYPE',TYPENAME)
			 END AS SAS_FORMAT
			,CASE
				WHEN F.COL IS NOT NULL THEN 'BIT'
			 	WHEN TYPENAME IN ('CHARACTER','VARCHAR') AND NEW_LENGTH = 1 THEN CATS('CHAR','(1)')
				WHEN TYPENAME IN ('CHARACTER','VARCHAR') AND NEW_LENGTH > 1 THEN CATS('VARCHAR(',NEW_LENGTH,')')
				WHEN TYPENAME IN ('DATE','TIMESTAMP') THEN 'DATETIME'
				WHEN TYPENAME = 'DECIMAL' THEN CATS('DECIMAL(',NEW_LENGTH,',',SCALE,')')
				WHEN TYPENAME = 'INTEGER' THEN 'INT'
				WHEN TYPENAME = 'SMALLINT' THEN 'SMALLINT'
				WHEN TYPENAME = 'TIME' THEN 'TIME'
				ELSE CATS('UNKNOWN_DATA_TYPE',TYPENAME)
			 END AS SQL_FORMAT
			,CASE
				WHEN DEMO.KEYSEQ > 0 THEN 'NOT NULL'
				ELSE 'NULL'
			 END AS SQL_NULLS
		FROM 
			DEMO 
			LEFT JOIN (
					SELECT DISTINCT
						F.COL
					FROM FINAL F
						) F
				ON DEMO.COLNAME = F.COL
		ORDER BY 
			COLNO
	;
QUIT;

PROC SQL;
	CREATE TABLE SQL AS
		SELECT
			CATX(' ',SQL_COLNAME, SQL_FORMAT, SQL_NULLS) AS SQL_LOAD
		FROM 
			FMT
		ORDER BY 
			COLNO
	;
QUIT;

PROC SQL;
	CREATE TABLE SQL_PRI_KEY AS
		SELECT
			SQL_COLNAME
		FROM 
			FMT
		WHERE 
			KEYSEQ IS NOT NULL
		ORDER BY 
			KEYSEQ
	;
QUIT;

PROC SQL;
	CREATE TABLE SQL_PULL AS
		SELECT
			CASE
			 WHEN SQL_FORMAT = 'BIT' THEN CATX(' ','CASE WHEN', NEW_COLNAME, "= 'Y' THEN 1 ELSE 0 END AS " ,NEW_COLNAME)
			 ELSE CATX(' ',NEW_COLNAME,',')
			 END AS LOAD_TXT
		FROM 
			FMT
	;
QUIT;

PROC SQL;
	CREATE TABLE LD AS
		SELECT
			CATX(' ','PUT',NEW_COLNAME, '@ ;') AS LOAD_JOB
		FROM 
			FMT
		ORDER BY 
			COLNO
	;
QUIT;

PROC SQL;
	CREATE TABLE SAS_1 AS
		SELECT
			CASE
			 WHEN SQL_FORMAT = 'BIT' THEN CATX(' ',NEW_COLNAME, ':1.')
			 ELSE CATX(' ',NEW_COLNAME, SAS_FORMAT) 
			 END AS SAS_LOAD
		FROM
			FMT
		ORDER BY
			COLNO
	;
QUIT;

PROC SQL;
	CREATE TABLE SAS_2 AS
		SELECT
			CATX(' ',NEW_COLNAME,'=',NEW_COLNAME,'* 86400;') AS SAS_DATE
		FROM 
			FMT
		WHERE 
			TYPENAME = 'DATE'
		ORDER BY 
			COLNO
	;
QUIT;

PROC SQL;
	CREATE TABLE SAS_3 AS
		SELECT
			NEW_COLNAME
		FROM 
			FMT
		ORDER BY
			COLNO
	;
QUIT;

/*write to comma delimited file*/
DATA _NULL_;
	SET  WORK.SQL;
	FILE 'T:\SAS\LOAD PREP &TABLE.txt' delimiter=',' /*DSD*/ DROPOVER lrecl=32767;
    
	FORMAT SQL_LOAD $200. ;

	DO;
		PUT SQL_LOAD $ @;
		PUT ' ' ;
		;
	END;
RUN;

DATA _NULL_;
	SET WORK.SQL_PRI_KEY;
	FILE 'T:\SAS\LOAD PREP PRIKEY &TABLE.txt' delimiter=',' DROPOVER lrecl=32767;

	DO;
		PUT SQL_COLNAME $ @;
		PUT ' ' ;
		;
	END;
RUN;

DATA _NULL_;
	SET WORK.SQL_PULL;
	FILE 'T:\SAS\LOAD PREP PULL &TABLE.txt' DROPOVER lrecl=32767;

	DO;
		PUT LOAD_TXT $;
		;
	END;
RUN;

DATA _NULL_;
	SET WORK.LD;
	FILE 'T:\SAS\LOAD PREP LOAD JOB &TABLE.txt' DROPOVER lrecl=32767;

	DO;
		PUT LOAD_JOB $;
		;
	END;
RUN;

DATA _NULL_;
	SET WORK.SAS_1;
	FILE 'T:\SAS\LOAD PREP SAS1 &TABLE.txt' DROPOVER lrecl=32767;

	DO;
		PUT SAS_LOAD $;
		;
	END;
RUN;

DATA _NULL_;
	SET WORK.SAS_2;
	FILE 'T:\SAS\LOAD PREP SAS2 &TABLE.txt' DROPOVER lrecl=32767;

	DO;
		PUT SAS_DATE $;
		;
	END;
RUN;

DATA _NULL_;
	SET  WORK.SAS_3;
	FILE 'T:\SAS\LOAD PREP SAS3 &TABLE.txt' DROPOVER lrecl=32767;

/*	IF _N_ = 1 THEN        /* write column names */*/
/*		DO;*/
/*			PUT*/
/*			CATX(' ',&TAB,',') $ @;*/
/*			CATX(' ',&TABLE,',') $;*/
/*		END;*/
;
	DO;
		PUT NEW_COLNAME $ @;
		PUT ' ' ;
		;
	END;
RUN;

DATA _NULL_;
	SET WORK.SQL_PULL;
	FILE 'T:\SAS\LOAD PREP SQL_PULL &TABLE.txt'  DROPOVER lrecl=32767;

	DO;
		PUT LOAD_TXT $ @;
		PUT ' ' ;
		;
	END;
RUN;
