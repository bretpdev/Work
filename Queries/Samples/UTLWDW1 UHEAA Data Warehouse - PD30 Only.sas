/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWDW1.LWDW1R2.&sysdate";
FILENAME REPORTZ "&RPTLIB/ULWDW1.LWDW1RZ";
FILENAME REPORT3 "&RPTLIB/ULWDW1.LWDW1R3.&sysdate";
FILENAME REPORT4 "&RPTLIB/ULWDW1.LWDW1R4.&sysdate";
FILENAME REPORT5 "&RPTLIB/ULWDW1.LWDW1R5.&sysdate";
FILENAME REPORT6 "&RPTLIB/ULWDW1.LWDW1R6.&sysdate";
FILENAME REPORT7 "&RPTLIB/ULWDW1.LWDW1R7.&sysdate";
FILENAME REPORT8 "&RPTLIB/ULWDW1.LWDW1R8.&sysdate";
FILENAME REPORT9 "&RPTLIB/ULWDW1.LWDW1R9.&sysdate";
FILENAME REPORT10 "&RPTLIB/ULWDW1.LWDW1R10.&sysdate";
FILENAME REPORT11 "&RPTLIB/ULWDW1.LWDW1R11.&sysdate";
FILENAME REPORT12 "&RPTLIB/ULWDW1.LWDW1R12.&sysdate";
FILENAME REPORT13 "&RPTLIB/ULWDW1.LWDW1R13.&sysdate";
FILENAME REPORT14 "&RPTLIB/ULWDW1.LWDW1R14.&sysdate";
FILENAME REPORT15 "&RPTLIB/ULWDW1.LWDW1R15.&sysdate";
FILENAME REPORT16 "&RPTLIB/ULWDW1.LWDW1R16.&sysdate";
FILENAME REPORT17 "&RPTLIB/ULWDW1.LWDW1R17.&sysdate";
FILENAME REPORT18 "&RPTLIB/ULWDW1.LWDW1R18.&sysdate";
FILENAME REPORT19 "&RPTLIB/ULWDW1.LWDW1R19.&sysdate";
FILENAME REPORT20 "&RPTLIB/ULWDW1.LWDW1R20.&sysdate";
FILENAME REPORT21 "&RPTLIB/ULWDW1.LWDW1R21.&sysdate";
FILENAME REPORT22 "&RPTLIB/ULWDW1.LWDW1R22.&sysdate";
FILENAME REPORT23 "&RPTLIB/ULWDW1.LWDW1R23.&sysdate";
FILENAME REPORT24 "&RPTLIB/ULWDW1.LWDW1R24.&sysdate";
FILENAME REPORT25 "&RPTLIB/ULWDW1.LWDW1R25.&sysdate";
FILENAME REPORT26 "&RPTLIB/ULWDW1.LWDW1R26.&sysdate";
FILENAME REPORT27 "&RPTLIB/ULWDW1.LWDW1R27.&sysdate";
FILENAME REPORT28 "&RPTLIB/ULWDW1.LWDW1R28.&sysdate";
FILENAME REPORT29 "&RPTLIB/ULWDW1.LWDW1R29.&sysdate";
FILENAME REPORT30 "&RPTLIB/ULWDW1.LWDW1R30.&sysdate";
FILENAME REPORT31 "&RPTLIB/ULWDW1.LWDW1R31.&sysdate";
FILENAME REPORT32 "&RPTLIB/ULWDW1.LWDW1R32.&sysdate";
FILENAME REPORT33 "&RPTLIB/ULWDW1.LWDW1R33.&sysdate";
FILENAME REPORT34 "&RPTLIB/ULWDW1.LWDW1R34.&sysdate";

LIBNAME  DUSTER  REMOTE  SERVER=DUSTER  SLIBREF=WORK;
data _null_;
call symput('rsub',put(time(),time9.));
run;
RSUBMIT;  
LIBNAME OLWHRM1 DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1; 
LIBNAME SAS_TAB V8 '/sas/whse/progrevw';
DATA _NULL_; 
SET SAS_TAB.LASTRUN_JOBS;
/*If the job must be run manually set this macro to the last day it successfully ran(last business day).*/
LAST_RUN = '09dec2014'd;	*COMMENT FOR PROD, IT WILL READ THE DATE FROM A TABLE;
IF JOB = 'UTLWDW1' THEN DO;
	CALL SYMPUT('LAST_RUN',"'"||TRIM(LEFT(PUT(LAST_RUN,DATE10.)))|| "'D");
	CALL SYMPUT('LAST_RUNPASS',"'"|| PUT(LAST_RUN,MMDDYY10.) || "'");
END;
RUN;

%PUT &LAST_RUN &LAST_RUNPASS;

/*THE TABLES ARE GOING TO HAVE THE ACCOUNT NUMBER RATHER THAN SSN AS A PRIMARY KEY*/
/*THE ACCOUNT NUMBER IS BEING TAKEN FROM THE PD10 TABLE WHILE SSN IS DROPPED*/
%MACRO SSN2ACC(TBL,ADKEY);
PROC SORT DATA=&TBL; BY BF_SSN &ADKEY; RUN;
DATA &TBL(DROP=BF_SSN);
MERGE SSN2ACC(IN=B) &TBL(IN=A);
BY BF_SSN;
IF A AND B;
RUN;
PROC SORT DATA=&TBL; BY DF_SPE_ACC_ID &ADKEY; RUN;
%MEND;

/*******************************************
* BORROWER DATA
********************************************/
PROC SQL;
	CREATE TABLE SSN2ACC AS
	SELECT DISTINCT A.DF_SPE_ACC_ID
		,B.BF_SSN
	FROM OLWHRM1.PD10_PRS_NME A
	INNER JOIN OLWHRM1.LN10_LON B
		ON A.DF_PRS_ID = B.BF_SSN
;
QUIT;
PROC SORT DATA=SSN2ACC; BY BF_SSN; RUN;

/*********************************************
* DEMOGRAPHICS
**********************************************/
PROC SQL;
CREATE TABLE PD30 AS
	SELECT distinct c.df_prs_id as bf_ssn
		,C.DX_STR_ADR_1
		,C.DX_STR_ADR_2
		,C.DM_CT
		,C.DC_DOM_ST
		,C.DF_ZIP_CDE
		,C.DM_FGN_ST
		,C.DM_FGN_CNY
		,C.DD_VER_ADR
		,C.DI_VLD_ADR
	FROM OLWHRM1.PD30_PRS_ADR C
	WHERE C.DC_ADR = 'L'
		AND DATEPART(C.DF_LST_DTS_PD30) >= &LAST_RUN;
QUIT;
%SSN2ACC(PD30,);

DATA PD30; SET DUSTER.PD30; RUN; *25;

DATA _NULL_;
SET PD30 end = eof;
FILE REPORT25 DELIMITER=',' DSD DROPOVER LRECL=32767;
FORMAT DD_VER_ADR MMDDYY10.;
IF _N_ = 1 THEN put "-Begin-";
DO;
	PUT DF_SPE_ACC_ID @;
	PUT DX_STR_ADR_1 @;
	PUT DX_STR_ADR_2 @;
	PUT DM_CT @;
	PUT DC_DOM_ST @;
	PUT DF_ZIP_CDE @;
	PUT DM_FGN_ST @;
	PUT DM_FGN_CNY @;
	PUT DD_VER_ADR @;
	PUT DI_VLD_ADR $;
end;
if eof then put "-End-";
RUN;
