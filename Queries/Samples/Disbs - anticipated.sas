/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;
%LET RPTLIB = %SYSGET(reportdir);
FILENAME REPORT2 "&RPTLIB/ULW___.LW___R2";*/

libname  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=work  ;
RSUBMIT;
OPTIONS NOCENTER NODATE NONUMBER LS=132;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE DEMO AS
SELECT *
FROM CONNECTION TO DB2 (

SELECT *
FROM OLWHRM1.GA11_LON_DSB_ATY X
/*DISB HAS ESTIMATED ROW*/
WHERE X.AC_DSB_ADJ_STA = 'A'
AND X.AC_DSB_ADJ = 'E'
/*AND X.AF_APL_ID = '0007490000A152810'*/
/*AND X.AF_APL_ID_SFX = '02'*/
/*DISB HAS NO ACTUAL ROW, AND NO FULL CANCELLATION ROW*/
AND NOT EXISTS
	(SELECT *
	FROM OLWHRM1.GA11_LON_DSB_ATY Y
	WHERE Y.AF_APL_ID = X.AF_APL_ID
	AND Y.AF_APL_ID_SFX = X.AF_APL_ID_SFX
	AND Y.AN_DSB_SEQ = X.AN_DSB_SEQ
	AND Y.AC_DSB_ADJ_STA = 'A'
	/*NO ACTUAL DISB ROW*/ 
	AND (Y.AC_DSB_ADJ = 'A'
	/*NO FULL CANCELLATION ROW*/
		OR (Y.AC_DSB_ADJ IN ('C','P','U')
			AND Y.AA_DSB_ADJ = X.AA_DSB_ADJ 
			+ (SELECT COALESCE(SUM(Z.AA_DSB_ADJ),0)
			   FROM OLWHRM1.GA11_LON_DSB_ATY Z
			   WHERE Z.AF_APL_ID = Y.AF_APL_ID
			   AND Z.AF_APL_ID_SFX = Y.AF_APL_ID_SFX
			   AND Z.AN_DSB_SEQ = Y.AN_DSB_SEQ
			   AND Z.AC_DSB_ADJ = 'B'
			   AND Z.AC_DSB_ADJ_STA = 'A'
			   )

			)
		)
	)
);
DISCONNECT FROM DB2;
endrsubmit  ;

DATA DEMO; 
SET WORKLOCL.DEMO; 
RUN;
