PROC SQL;
CREATE TABLE NO_DF10_DELTA AS
SELECT DISTINCT A.DF_SPE_ACC_ID
	,A.LN_SEQ
	,A.LF_DFR_CTL_NUM
	,A.LN_DFR_OCC_SEQ
FROM DF10 A
INNER JOIN DUDE.DEFERMENT B
	ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
	AND A.LN_SEQ = B.LN_SEQ
	AND A.LF_DFR_CTL_NUM = B.LF_DFR_CTL_NUM
	AND A.LN_DFR_OCC_SEQ = B.LN_DFR_OCC_SEQ
	AND A.LC_DFR_TYP = B.LC_DFR_TYP
	AND A.DFR_TYP = B.DFR_TYP
	AND A.LD_DFR_INF_CER = B.LD_DFR_INF_CER
	AND A.LD_DFR_BEG = B.LD_DFR_BEG
	AND A.LD_DFR_END = B.LD_DFR_END
	AND A.LI_CAP_DFR_INT_REQ = B.LI_CAP_DFR_INT_REQ
	AND A.LC_STA_LON50 = B.LC_STA_LON50
	AND A.LC_DFR_STA = B.LC_DFR_STA
	AND A.LC_STA_DFR10 = B.LC_STA_DFR10
	AND A.MONTHS_USED = B.MONTHS_USED;

CREATE TABLE DF10_DELTAS AS
SELECT DISTINCT A.*
FROM DF10 A
LEFT JOIN NO_DF10_DELTA B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ
	  AND A.LF_DFR_CTL_NUM = B.LF_DFR_CTL_NUM
	  AND A.LN_DFR_OCC_SEQ = B.LN_DFR_OCC_SEQ
WHERE B.DF_SPE_ACC_ID IS NULL
	AND B.LN_SEQ IS NULL
	AND B.LF_DFR_CTL_NUM IS NULL
	AND B.LN_DFR_OCC_SEQ IS NULL;
QUIT;

DATA DEFERMENT_DELTAS (KEEP=DF_SPE_ACC_ID LN_SEQ LF_DFR_CTL_NUM LN_DFR_OCC_SEQ);
	SET DF10_DELTAS;
RUN;
PROC SORT DATA=DEFERMENT_DELTAS NODUPKEY;
	BY DF_SPE_ACC_ID LN_SEQ LF_DFR_CTL_NUM LN_DFR_OCC_SEQ;
RUN;   

PROC SQL;
CREATE TABLE LOCL_DEFERMENT_DELTAS AS
      SELECT A.* 
      FROM DUDE.DEFERMENT A
      INNER JOIN DEFERMENT_DELTAS B
	      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
	      AND A.LN_SEQ = B.LN_SEQ
		  AND A.LF_DFR_CTL_NUM = B.LF_DFR_CTL_NUM
		  AND A.LN_DFR_OCC_SEQ = B.LN_DFR_OCC_SEQ;

INSERT INTO DUDE.DEFERMENT_DELETE
      SELECT DF_SPE_ACC_ID
	  		,LN_SEQ
			,LF_DFR_CTL_NUM
			,LN_DFR_OCC_SEQ 
      FROM LOCL_DEFERMENT_DELTAS; 
QUIT;

%UPDATE_DATA(LOCL_DEFERMENT_DELTAS,DF10_DELTAS,%STR(DF_SPE_ACC_ID LN_SEQ LF_DFR_CTL_NUM 
		LN_DFR_OCC_SEQ));
PROC SQL NOPRINT;
CONNECT TO ODBC AS MD (&MD);
SELECT COUNT(*) 
FROM CONNECTION TO MD (
      DELETE DEFERMENT
      FROM DEFERMENT A
      INNER JOIN DEFERMENT_DELETE B
            ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
			AND A.LN_SEQ = B.LN_SEQ
			AND A.LF_DFR_CTL_NUM = B.LF_DFR_CTL_NUM
			AND A.LN_DFR_OCC_SEQ = B.LN_DFR_OCC_SEQ
      );
DISCONNECT FROM MD;
QUIT;

PROC SQL ;
INSERT INTO DUDE.DEFERMENT
      SELECT * 
      FROM LOCL_DEFERMENT_DELTAS
	  WHERE LC_DFR_STA = 'A'
		AND LC_STA_LON50 = 'A'
		AND LC_STA_DFR10 = 'A'; 
QUIT;

OPTIONS NOSOURCE;
%GOODBYE_NULLCHAR(DEFERMENT,LC_DFR_TYP);
%GOODBYE_NULLCHAR(DEFERMENT,DFR_TYP);
%GOODBYE_NULLCHAR(DEFERMENT,LD_DFR_INF_CER);
%GOODBYE_NULLCHAR(DEFERMENT,LD_DFR_BEG);
%GOODBYE_NULLCHAR(DEFERMENT,LD_DFR_END);
%GOODBYE_NULLCHAR(DEFERMENT,LI_CAP_DFR_INT_REQ);
%GOODBYE_NULLCHAR(DEFERMENT,LC_STA_LON50);
%GOODBYE_NULLCHAR(DEFERMENT,LC_DFR_STA);
%GOODBYE_NULLCHAR(DEFERMENT,LC_STA_DFR10);
%GOODBYE_NULL(DEFERMENT,MONTHS_USED);

PROC SQL NOPRINT;
CONNECT TO ODBC AS MD (&MD);
SELECT COUNT(*) 
FROM CONNECTION TO MD (
      DELETE 
      FROM DEFERMENT_DELETE 
);
QUIT;
OPTIONS SOURCE;
