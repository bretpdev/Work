PROC SQL;
CREATE TABLE NO_LN90_DELTA AS
SELECT DISTINCT A.DF_SPE_ACC_ID
	,A.LN_SEQ
	,A.LN_FAT_SEQ
FROM LN90 A
INNER JOIN DUDE.FINANCIALTRAN B
	ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
	AND A.LN_SEQ = B.LN_SEQ
	AND A.LN_FAT_SEQ = B.LN_FAT_SEQ
	AND A.LD_FAT_PST = B.LD_FAT_PST 
	AND A.LD_FAT_EFF = B.LD_FAT_EFF
	AND A.LC_STA_LON90 = B.LC_STA_LON90
	AND A.LA_FAT_CUR_PRI = B.LA_FAT_CUR_PRI
	AND A.LA_FAT_LTE_FEE = B.LA_FAT_LTE_FEE
	AND A.TRAN_AMT = B.TRAN_AMT
	AND A.PC_FAT_TYP = B.PC_FAT_TYP
	AND A.PC_FAT_SUB_TYP = B.PC_FAT_SUB_TYP
	AND A.LC_FAT_REV_REA = B.LC_FAT_REV_REA
	AND A.FAT_REV_REA = B.FAT_REV_REA
	AND A.LA_FAT_NSI_ACR = B.LA_FAT_NSI_ACR;

CREATE TABLE LN90_DELTAS AS
SELECT DISTINCT A.*
FROM LN90 A
LEFT JOIN NO_LN90_DELTA B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ
	  AND A.LN_FAT_SEQ = B.LN_FAT_SEQ
WHERE B.DF_SPE_ACC_ID IS NULL
	AND B.LN_SEQ IS NULL
	AND B.LN_FAT_SEQ IS NULL;
QUIT;

DATA FINANCIALTRAN_DELTAS (KEEP=DF_SPE_ACC_ID LN_SEQ LN_FAT_SEQ);
	SET LN90_DELTAS;
RUN;
PROC SORT DATA=FINANCIALTRAN_DELTAS NODUPKEY;
	BY DF_SPE_ACC_ID LN_SEQ LN_FAT_SEQ;
RUN;   

PROC SQL;
CREATE TABLE LOCL_FINANCIALTRAN_DELTAS AS
      SELECT A.* 
      FROM DUDE.FINANCIALTRAN A
      INNER JOIN FINANCIALTRAN_DELTAS B
            ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
			AND A.LN_SEQ = B.LN_SEQ
		  AND A.LN_FAT_SEQ = B.LN_FAT_SEQ;

INSERT INTO DUDE.FINANCIALTRAN_DELETE
      SELECT DF_SPE_ACC_ID
	  		,LN_SEQ
			,LN_FAT_SEQ
      FROM LOCL_FINANCIALTRAN_DELTAS; 
QUIT;

%UPDATE_DATA(LOCL_FINANCIALTRAN_DELTAS,LN90_DELTAS,%STR(DF_SPE_ACC_ID LN_SEQ LN_FAT_SEQ));
PROC SQL NOPRINT;
CONNECT TO ODBC AS MD (&MD);
SELECT COUNT(*) 
FROM CONNECTION TO MD (
      DELETE FINANCIALTRAN
      FROM FINANCIALTRAN A
      INNER JOIN FINANCIALTRAN_DELETE B
            ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
			AND A.LN_SEQ = B.LN_SEQ
			AND A.LN_FAT_SEQ = B.LN_FAT_SEQ
      );
DISCONNECT FROM MD;
QUIT;

PROC SQL ;
INSERT INTO DUDE.FINANCIALTRAN
      SELECT * 
      FROM LOCL_FINANCIALTRAN_DELTAS
	  WHERE LC_STA_LON90 = 'A'; 
QUIT;
OPTIONS NOSOURCE;
%GOODBYE_NULLCHAR(FINANCIALTRAN,LD_FAT_PST);
%GOODBYE_NULLCHAR(FINANCIALTRAN,LD_FAT_EFF);
%GOODBYE_NULLCHAR(FINANCIALTRAN,LC_STA_LON90);
%GOODBYE_NULLCHAR(FINANCIALTRAN,LC_FAT_REV_REA);
%GOODBYE_NULLCHAR(FINANCIALTRAN,FAT_REV_REA);

PROC SQL NOPRINT;
CONNECT TO ODBC AS MD (&MD);
SELECT COUNT(*) 
FROM CONNECTION TO MD (
      DELETE 
      FROM FINANCIALTRAN_DELETE 
      );
QUIT;
OPTIONS SOURCE;
