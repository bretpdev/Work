*---------------------------------*
| UTLWQ28 UHEAA Cancellation Rate |
*---------------------------------*;
LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;
%LET RPTLIB = %SYSGET(reportdir);
/*%LET RPTLIB = C:\WINDOWS\TEMP;*/
FILENAME REPORT2 "&RPTLIB/ULWQ28.LWQ28R2";
FILENAME REPORTZ "&RPTLIB/ULWQ28.LWQ28RZ";
DATA _NULL_;
	CALL SYMPUT('IMIN',COMPRESS(5));
	CALL SYMPUT('IMAX',SUBSTR(COMPRESS(YEAR(INTNX('YEAR.7',TODAY(),0,'END'))),4,1));
RUN;
/*LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;*/
/*RSUBMIT;*/
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE UHECR AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT B.AF_APL_ID||B.AF_APL_ID_SFX AS CLUID
	,B.AC_PRC_STA
	,B.AD_PRC
	,B.AA_GTE_LON_AMT 
	,COALESCE(B.AA_TOT_CAN,0) AS AA_TOT_CAN
FROM OLWHRM1.GA10_LON_APP B
WHERE B.AC_PRC_STA = 'A'
	AND B.AD_PRC >= '07/01/2005'
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;
%SQLCHECK (SQLRPT=ULWQ28.LWQ28RZ);
QUIT;
/*ENDRSUBMIT;*/
/*DATA UHECR ;*/
/*	SET WORKLOCL.UHECR;*/
/*RUN;*/
/*ASSIGN A FISCAL YEAR TO EACH LOAN*/
DATA UHECR (DROP=I I2 FY_BEG FY_END);
	SET UHECR;
	LENGTH FY $ 4. ;
	FY='';
	DO I=&IMIN TO &IMAX;
		I2 = I+1;
		FY_BEG = INPUT(CATS("07/01/200",I),MMDDYY10.);
		FY_END = INPUT(CATS("06/30/200",I2),MMDDYY10.);
		IF FY='' THEN DO;
			IF  FY_BEG <= AD_PRC <= FY_END THEN
				FY = CATS("200",I2);
			ELSE 
				FY = FY;
		END;
	END;
RUN;
PROC SQL;
	CREATE TABLE UHECR_SUMRY AS 
		SELECT FY
			,SUM(AA_TOT_CAN) / 
			 SUM(AA_GTE_LON_AMT)	AS CR
			,SUM(AA_GTE_LON_AMT) 	AS GA
			,SUM(AA_TOT_CAN) 		AS CA
			
		FROM UHECR
		GROUP BY FY
	;
QUIT;
PROC PRINTTO PRINT=REPORT2 NEW;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 CENTER DATE PAGENO=1;
TITLE 'UHEAA CANCELLATION RATE';
FOOTNOTE   'JOB = UTLWQ28  	 REPORT = ULWQ28.LWQ28R2';
PROC PRINT NOOBS SPLIT='/' DATA=UHECR_SUMRY WIDTH=UNIFORM WIDTH=MIN LABEL;
FORMAT GA CA DOLLAR18.2 CR 4.2;
VAR FY GA CA CR;
LABEL FY = 'FISCAL/YEAR'
	GA = 'GROSS/GUARANTY/AMOUNT'
	CA = 'GROSS/CANCELLATION/AMOUNT' 
	CR = 'CANCELLATION/RATE'
	;
RUN;
PROC PRINTTO;
RUN;
/*DETAIL FILE*/
/*DATA _NULL_;*/
/*	FILE 'C:\WINDOWS\TEMP\UHEAACancellationRate.Detail.txt' DELIMITER=',' DSD DROPOVER LRECL=32767;*/
/*	IF _N_ = 1 THEN        */
/*		DO;*/
/*			PUT "CLUID,AA_GTE_LON_AMT,AA_TOT_CAN,AC_PRC_STA,AD_PRC,NET_GUAR_AMT";*/
/*		END;*/
/*	SET  WORK.UHECR;*/
/*	   FORMAT CLUID $19. ;*/
/*	   FORMAT AA_GTE_LON_AMT 10.2 ;*/
/*	   FORMAT AA_TOT_CAN 10.2 ;*/
/*	   FORMAT AC_PRC_STA $1. ;*/
/*	   FORMAT AD_PRC DATE9. ;*/
/*	DO;*/
/*	   PUT CLUID $ @;*/
/*	   PUT AC_PRC_STA $ @;*/
/*	   PUT AD_PRC @;*/
/*	   PUT AA_GTE_LON_AMT @;*/
/*	   PUT AA_TOT_CAN ;*/
/*	END;*/
/*RUN;*/
