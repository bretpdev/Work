*----------------------------*
| CONSOLIDATION APP ADDENDUM |
*----------------------------*;
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE CONSAPPAD AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT B.DF_LCO_PRS_SSN
	,B.DF_SPE_ACC_ID
	,B.DM_LCO_PRS_1
	,B.DM_LCO_PRS_LST
	,B.DX_LCO_PRS_STR_1
	,B.DX_LCO_PRS_STR_2
	,B.DM_LCO_PRS_CT
	,CASE 
		WHEN B.DC_LCO_PRS_ST NOT IN ('ZZ','') THEN B.DC_LCO_PRS_ST
		ELSE B.DM_LCO_PRS_FGN_ST
	 END AS STATE
	,CASE 
		WHEN B.DC_LCO_PRS_ST IN ('ZZ','') THEN 1
		ELSE 2
	 END AS SVAR
	,B.DM_LCO_PRS_FGN_CNY
	,B.DF_LCO_PRS_ZIP   
	,'MA2324' AS COST_CENTER_CODE 
	,'L' AS DC_ADR
FROM OLWHRM1.AP1A_LCO_APL A
INNER JOIN OLWHRM1.PD6A_LCO_PRS_DMO B
	ON A.DF_LCO_PRS_SSN_BR = B.DF_LCO_PRS_SSN
WHERE A.AD_LCO_APL_RCV >= '06/15/2006'
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
ENDRSUBMIT;
DATA CONSAPPAD;
SET WORKLOCL.CONSAPPAD;
RUN;
DATA CONSAPPAD (DROP = KEYSSN MODAY KEYLINE CHKDIG DIG I 
	CHKDIG CHK1 CHK2 CHK3 CHKDIGIT CHECK);
SET CONSAPPAD;
KEYSSN = TRANSLATE(DF_LCO_PRS_SSN,'MYLAUGHTER','0987654321');
MODAY = PUT(DATE(),MMDDYYN4.);
KEYLINE = "P"||KEYSSN||MODAY||DC_ADR;
CHKDIG = 0;
LENGTH DIG $2.;
DO I = 1 TO LENGTH(KEYLINE);
	IF I/2 NE ROUND(I/2,1) 
		THEN DIG = PUT(INPUT(SUBSTR(KEYLINE,I,1),BITS4.4) * 2, 2.);
	ELSE DIG = PUT(INPUT(SUBSTR(KEYLINE,I,1),BITS4.4), 2.);
	IF SUBSTR(DIG,1,1) = " " 
		THEN CHKDIG = CHKDIG + INPUT(SUBSTR(DIG,2,1),1.);
		ELSE DO;
			CHK1 = INPUT(SUBSTR(DIG,1,1),1.);
			CHK2 = INPUT(SUBSTR(DIG,2,1),1.);
			IF CHK1 + CHK2 >= 10
				THEN DO;
					CHK3 = PUT(CHK1 + CHK2,2.);
					CHK1 = INPUT(SUBSTR(CHK3,1,1),1.);
					CHK2 = INPUT(SUBSTR(CHK3,2,1),1.);
				END;
			CHKDIG = CHKDIG + CHK1 + CHK2;
		END;
END;
CHKDIGIT = 10 - INPUT(SUBSTR((RIGHT(PUT(CHKDIG,3.))),3,1),3.);
IF CHKDIGIT = 10 THEN CHKDIGIT = 0;
CHECK = PUT(CHKDIGIT,1.);
ACSKEY = "#"||KEYLINE||CHECK||"#";
RUN;
PROC SORT DATA=CONSAPPAD;
BY SVAR STATE;
RUN;
DATA _NULL_;
SET  WORK.CONSAPPAD;
FILE 'T:\SAS\ConsolAppAddendum.R2.txt' DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT DF_LCO_PRS_SSN $9. ;
	FORMAT DF_SPE_ACC_ID $10. ;
	FORMAT DM_LCO_PRS_1 $13. ;
	FORMAT DM_LCO_PRS_LST $23. ;
	FORMAT DX_LCO_PRS_STR_1 $40. ;
	FORMAT DX_LCO_PRS_STR_2 $40. ;
	FORMAT DM_LCO_PRS_CT $30. ;
	FORMAT STATE $30. ;
	FORMAT DM_LCO_PRS_FGN_CNY $25. ;
	FORMAT DF_LCO_PRS_ZIP $17. ;
	FORMAT COST_CENTER_CODE $6. ;
	FORMAT ACSKEY $18. ;
DO;
	PUT DF_LCO_PRS_SSN $ @;
	PUT DF_SPE_ACC_ID $ @;
	PUT DM_LCO_PRS_1 $ @;
	PUT DM_LCO_PRS_LST $ @;
	PUT DX_LCO_PRS_STR_1 $ @;
	PUT DX_LCO_PRS_STR_2 $ @;
	PUT DM_LCO_PRS_CT $ @;
	PUT STATE $ @;
	PUT DM_LCO_PRS_FGN_CNY $ @;
	PUT DF_LCO_PRS_ZIP $ @;
	PUT ACSKEY $ @;
	PUT STATE $ @;
	PUT COST_CENTER_CODE $ ;
END;
RUN;
