/****  Find borrowers from a particular school within a particular loan period.  ****/
%LET RPTLIB = T:\SAS;
FILENAME REPORTZ "&RPTLIB/MASS_LOAN_DATE_CHANGE.RZ";
FILENAME REPORT2 "&RPTLIB/MASS_LOAN_DATE_CHANGE.R2";
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;

/*ENTER THE DATE RANGE IN THE FOLLOWING DATA STEP.  ENTER THE SCHOOL CODE ON LINE 61*/
/*BOTH DATE VALUES MUST MATCH THE EXACT DATA FOR THE REPORTS*/
DATA _NULL_;
	CALL SYMPUT('FIRST_DATE',"'"||PUT("26AUG2009"D, MMDDYYD10.)||"'");
	CALL SYMPUT('LAST_DATE',"'"||PUT("07MAY2010"D, MMDDYYD10.)||"'");
RUN;
%SYSLPUT FIRST_DATE = &FIRST_DATE;
%SYSLPUT LAST_DATE = &LAST_DATE;
RSUBMIT;
%MACRO SQLCHECK ;
  %IF  &SQLXRC NE 0  %THEN  %DO  ;
    DATA _NULL_  ;
            FILE REPORTZ NOTITLES  ;
            PUT @01 " ********************************************************************* "
              / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
              / @01 " ****  THE SAS SHOULD BE REVIEWED.                                **** "       
              / @01 " ********************************************************************* "
              / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
              / @01 " ****  &SQLXMSG   **** "
              / @01 " ********************************************************************* "
            ;
         RUN  ;
  %END  ;
%MEND  ;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE DEMO AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT
	LN10.LN_SEQ
	,PD01.DF_SPE_ACC_ID
	,GA10.AF_APL_ID || GA10.AF_APL_ID_SFX AS CL_UNIQUE_ID
	,GA10.AC_LON_TYP
	,GA10.AD_PRC
	,GA01.AD_IST_TRM_BEG
	,GA01.AD_IST_TRM_END
	,GA01.AF_APL_OPS_SCL
	FROM OLWHRM1.GA01_APP GA01
		INNER JOIN
		OLWHRM1.GA10_LON_APP GA10
			ON GA01.AF_APL_ID = GA10.AF_APL_ID
/*			AND GA10.AF_APL_ID_SFX =*/
		INNER JOIN
		OLWHRM1.PD01_PDM_INF PD01
			ON GA01.DF_PRS_ID_BR = PD01.DF_PRS_ID
		INNER JOIN
		OLWHRM1.LN10_LON LN10
			ON GA10.AF_APL_ID = LN10.LF_LON_ALT
			AND GA10.AF_APL_ID_SFX = '0'||CHAR(LN10.LN_LON_ALT_SEQ)
WHERE DAYS(GA01.AD_IST_TRM_BEG) = DAYS(&FIRST_DATE) 
	AND DAYS(GA01.AD_IST_TRM_END) = DAYS(&LAST_DATE)
	AND GA10.AC_PRC_STA = 'A'
	AND GA01.AF_APL_OPS_SCL = '00522000'
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
ENDRSUBMIT;
DATA DEMO;
	SET WORKLOCL.DEMO;
RUN;
PROC SORT DATA=DEMO;
	BY DF_SPE_ACC_ID;
RUN;
DATA _NULL_;
SET DEMO ;
USER = DF_SPE_ACC_ID;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
FORMAT USER $10. ;
FORMAT AD_PRC AD_IST_TRM_BEG AD_IST_TRM_END MMDDYY10. ;
IF _N_ = 1 THEN DO;
	PUT "ACCT_NUM,CL UNIQUEID,LOAN TYPE,GUARANTY DATE,LOAN BEGIN DATE,LOAN END DATE,LN_SEQ";
END;
DO;
	PUT USER $ @;
	PUT CL_UNIQUE_ID $ @;
	PUT AC_LON_TYP $ @;
	PUT AD_PRC $ @;
	PUT AD_IST_TRM_BEG $ @;
	PUT AD_IST_TRM_END $ @;
	PUT LN_SEQ $ ;
END;
RUN; 
