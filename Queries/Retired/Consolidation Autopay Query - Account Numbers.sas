*********************************************************;
*JOB NAME: CONSOLIDATION AUTOPAY QUERY - ACCOUNT NUMBERS ;
*********************************************************;

LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE CAQAN AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.BF_SSN
	,B.DM_PRS_LST	
FROM OLWHRM1.BR30_BR_EFT  A
INNER JOIN OLWHRM1.PD10_PRS_NME B
	ON A.BF_SSN = B.DF_PRS_ID
INNER JOIN 
	(SELECT BF_SSN
		,COUNT(*) 
	 FROM OLWHRM1.BR30_BR_EFT 
	 GROUP BY BF_SSN 
	 HAVING COUNT(*) > 1
	 ) C
	ON A.BF_SSN = C.BF_SSN
WHERE LENGTH(RTRIM(A.BF_EFT_ACC)) > 12
AND EXISTS
	(SELECT *
	 FROM OLWHRM1.LN10_LON X
	 WHERE X.BF_SSN = A.BF_SSN
	 AND X.LC_STA_LON10 = 'R'
	 AND X.IC_LON_PGM IN 
			('SUBCNS','UNCNS','SUBSPC','UNSPC')
	 )
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
ENDRSUBMIT;

DATA CAQAN;
SET WORKLOCL.CAQAN;
RUN;

PROC SORT DATA=CAQAN NODUPKEY;
BY BF_SSN;
RUN;

OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 PAGENO=1;
TITLE 'CONSOLIDATION AUTOPAY QUERY ';
TITLE2 'ACCOUNT NUMBERS MORE THAN 12 DIGITS';
FOOTNOTE 'JOB = CONSOLIDATION AUTOPAY QUERY - ACCOUNT NUMBERS';

PROC CONTENTS DATA=CAQAN OUT=EMPTYSET NOPRINT;
DATA _NULL_;
SET EMPTYSET;
FILE PRINT;
IF  NOBS=0 AND _N_ =1 THEN DO;
	PUT // 127*'-';
	PUT      //////
		@51 '**** NO OBSERVATIONS FOUND ****';
	PUT ////////
		@57 '-- END OF REPORT --';
	PUT //////////////
		@46 "JOB = CONSOLIDATION AUTOPAY QUERY - ACCOUNT NUMBERS";
	END;
RETURN;
RUN;

PROC PRINT NOOBS SPLIT='/' DATA=CAQAN WIDTH=UNIFORM WIDTH=MIN;
VAR BF_SSN DM_PRS_LST;
LABEL BF_SSN = 'SSN' DM_PRS_LST = 'LAST NAME';
RUN;