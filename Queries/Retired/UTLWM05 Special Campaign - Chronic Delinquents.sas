/*UTLWM05 - CHRONIC DELINQUENTS*/

/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
/*FILENAME REPORTZ "&RPTLIB/ULWM05.LWM05RZ";*/
/*FILENAME REPORT2 "&RPTLIB/ULWM05.LWM05R2";*/
/*FILENAME REPORT3 "&RPTLIB/ULWM05.LWM05R3";*/
/*FILENAME REPORT4 "&RPTLIB/ULWM05.LWM05R4";*/
/*FILENAME REPORT5 "&RPTLIB/ULWM05.LWM05R5";*/

FILENAME REPORT2 "C:\WINDOWS\TEMP\ULWM05.LWM05R2.TEST.TXT";
FILENAME REPORT3 "C:\WINDOWS\TEMP\ULWM05.LWM05R3.TEST.TXT";
FILENAME REPORT4 "C:\WINDOWS\TEMP\ULWM05.LWM05R4.TEST.TXT";
libname  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=work  ;
RSUBMIT;

%macro sqlcheck ;
  %if  &sqlxrc ne 0  %then  %do  ;
    data _null_  ;
            file reportz notitles  ;
            put @01 " ********************************************************************* "
              / @01 " ****  The SQL code above has experienced an error.               **** "
              / @01 " ****  The SAS should be reviewed.                                **** "       
              / @01 " ********************************************************************* "
              / @01 " ****  The SQL error code is  &sqlxrc  and the SQL error message  **** "
              / @01 " ****  &sqlxmsg   **** "
              / @01 " ********************************************************************* "
            ;
         run  ;
  %end  ;
%mend  ;

PROC SQL STIMER;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE SCCD1A AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT
	A.DF_PRS_ID_BR
	,RTRIM(D.DM_PRS_1) AS DM_PRS_1
	,RTRIM(D.DM_PRS_LST) AS DM_PRS_LST
	,A.AF_APL_OPS_SCL
	,E.IM_IST_FUL
	,F.DI_PHN_VLD
	,F.DI_VLD_ADR
	,F.DM_FGN_CNY
	,F.DC_DOM_ST
	,'MA2328' AS COST_CENTER_CODE
FROM  OLWHRM1.GA01_APP A 
INNER JOIN OLWHRM1.GA10_LON_APP B
	ON A.AF_APL_ID = B.AF_APL_ID
INNER JOIN OLWHRM1.GA14_LON_STA C
	ON B.AF_APL_ID = C.AF_APL_ID
	AND B.AF_APL_ID_SFX = C.AF_APL_ID_SFX
INNER JOIN OLWHRM1.PD01_PDM_INF D
	ON A.DF_PRS_ID_BR = D.DF_PRS_ID
INNER JOIN OLWHRM1.PD03_PRS_ADR_PHN F
	ON F.DF_PRS_ID = D.DF_PRS_ID
	AND F.DC_ADR = 'L' 
INNER JOIN
	(SELECT DISTINCT 
	IF_IST
	,IM_IST_FUL
	FROM OLWHRM1.SC01_LGS_SCL_INF
	)E
	ON A.AF_APL_OPS_SCL = E.IF_IST

WHERE A.AF_APL_OPS_SCL IN 
	('02178500','02298500','02360800','00367300','00367400',
	 '00367401','00367403','00367404','00367405','03003000',
	 '03030601','03030602','03030606','03030603','03030605',
	 '03030604','03030600','00367400','00367405','00367404',
	 '00367403','00367401')
AND C.AC_STA_GA14 = 'A'
AND C.AC_LON_STA_TYP IN ('RP','CR')
AND NOT EXISTS
	(SELECT *
	FROM OLWHRM1.AY01_BR_ATY X
	WHERE X.DF_PRS_ID = A.DF_PRS_ID_BR
	AND X.PF_ACT = 'ACRDL'
	AND DAYS(X.BD_ATY_PRF) >= DAYS(CURRENT DATE) - 365)
FOR READ ONLY WITH UR
);

/*LIST OF BWRS TO EXCLUDE FROM CAMPAIGN BECAUSE MOST RECENT DC10 REC
IS 01 STATUS, HAS PCL REASON (BC,BH,BO,DI,DE), AND LOAN IS NOT IN RP STATUS*/
CREATE TABLE DC10LIST AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT X.BF_SSN
FROM OLWHRM1.DC01_LON_CLM_INF X
INNER JOIN OLWHRM1.GA14_LON_STA Y
	ON X.AF_APL_ID = Y.AF_APL_ID
	AND X.AF_APL_ID_SFX = Y.AF_APL_ID_SFX
WHERE X.LD_PCL_RCV =
	(SELECT MAX(Z.LD_PCL_RCV)
	FROM OLWHRM1.DC01_LON_CLM_INF Z
	WHERE Z.BF_SSN = X.BF_SSN
	GROUP BY Z.BF_SSN)
AND X.LC_STA_DC10 = '01'
AND X.LC_PCL_REA IN ('BC','BH','BO','DI','DE')
AND Y.AC_LON_STA_TYP <> 'RP'
FOR READ ONLY WITH UR
);

/*CREATE LIST OF BWRS WITH AT LEAST TWO DF RECORDS IN LAST 12 MONTHS*/
/*WITH AT LEAST 60 DAYS BETWEEN THEM*/
CREATE TABLE MULTI_DFA AS
SELECT *
FROM CONNECTION TO DB2 (
	SELECT BF_SSN,LD_PCL_RCV
	FROM OLWHRM1.DC01_LON_CLM_INF
	WHERE LC_PCL_REA = 'DF'
	AND DAYS(LD_PCL_RCV) >= DAYS(CURRENT DATE) - 365
);

CREATE TABLE MULTI_DF AS
SELECT DISTINCT A.BF_SSN
FROM MULTI_DFA A
INNER JOIN MULTI_DFA B
	ON A.BF_SSN = B.BF_SSN
	AND (A.LD_PCL_RCV < (B.LD_PCL_RCV - 60)
		OR A.LD_PCL_RCV > (B.LD_PCL_RCV + 60))
;

/*IDENTIFY BORROWERS WITH OPEN SLMA LOANS FOR EXCLUSION*/
CREATE TABLE SLMA AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT W.DF_PRS_ID_BR
FROM OLWHRM1.GA01_APP W
INNER JOIN OLWHRM1.GA10_LON_APP X
	ON W.AF_APL_ID = X.AF_APL_ID
INNER JOIN OLWHRM1.GA14_LON_STA Y
	ON X.AF_APL_ID = Y.AF_APL_ID
	AND X.AF_APL_ID_SFX = Y.AF_APL_ID_SFX
WHERE Y.AC_STA_GA14 = 'A'
AND Y.AC_LON_STA_TYP IN ('IA','ID','IG','IM','RP','CR','FB','DA')
AND (X.AF_CUR_LON_SER_AGY = '700191'
	OR X.AF_CUR_LON_OPS_LDR IN ('829587','830084','830151',
		'831053','831474','833253','888885','899993'))
FOR READ ONLY WITH UR
);

CREATE TABLE SCCD2 AS
SELECT * 
FROM CONNECTION TO DB2 (
SELECT DISTINCT
	A.DF_PRS_ID
	,RTRIM(C.DM_PRS_1) AS DM_PRS_1
	,RTRIM(C.DM_PRS_LST) AS DM_PRS_LST
	,F.DI_PHN_VLD
	,F.DI_VLD_ADR
	,F.DM_FGN_CNY
	,F.DC_DOM_ST
	,'MA2328' AS COST_CENTER_CODE
FROM OLWHRM1.AY01_BR_ATY A
INNER JOIN OLWHRM1.AY01_BR_ATY B
	ON A.DF_PRS_ID = B.DF_PRS_ID
INNER JOIN OLWHRM1.PD01_PDM_INF C
	ON A.DF_PRS_ID = C.DF_PRS_ID
INNER JOIN OLWHRM1.PD03_PRS_ADR_PHN F
	ON F.DF_PRS_ID = C.DF_PRS_ID
	AND F.DC_ADR = 'L' 
WHERE A.PF_ACT = 'ACRDL'
AND B.PF_ACT = 'ASCON'
AND A.BD_ATY_PRF < B.BD_ATY_PRF
AND NOT EXISTS 
	(SELECT *
	FROM OLWHRM1.AY01_BR_ATY X
	WHERE A.DF_PRS_ID = X.DF_PRS_ID
	AND X.PF_ACT = 'ALBTU'
	AND X.BD_ATY_PRF > B.BD_ATY_PRF
	)
/*ORDER BY DM_FGN_CNY DESC DF_PRS_ID ASC*/
FOR READ ONLY WITH UR
);

CREATE TABLE SCCD3 AS
SELECT * 
FROM CONNECTION TO DB2 (
SELECT DISTINCT
	A.DF_PRS_ID
	,RTRIM(C.DM_PRS_1) AS DM_PRS_1
	,RTRIM(C.DM_PRS_LST) AS DM_PRS_LST
	,F.DI_PHN_VLD
	,F.DI_VLD_ADR
	,F.DM_FGN_CNY
	,F.DC_DOM_ST
	,'MA2328' AS COST_CENTER_CODE
FROM OLWHRM1.AY01_BR_ATY A
INNER JOIN 
	(SELECT DF_PRS_ID
		,COUNT(*)
		,MAX(BD_ATY_PRF) AS BD_ATY_PRF
	FROM OLWHRM1.AY01_BR_ATY 
	WHERE PF_ACT = 'AUCON'
	GROUP BY DF_PRS_ID
	HAVING COUNT(*) >= 3
	)B
	ON A.DF_PRS_ID = B.DF_PRS_ID
INNER JOIN OLWHRM1.PD01_PDM_INF C
	ON A.DF_PRS_ID = C.DF_PRS_ID
INNER JOIN OLWHRM1.PD03_PRS_ADR_PHN F
	ON F.DF_PRS_ID = C.DF_PRS_ID
	AND F.DC_ADR = 'L' 
WHERE A.PF_ACT = 'ACRDL'
AND NOT EXISTS
	(SELECT *
	FROM OLWHRM1.AY01_BR_ATY X
	WHERE A.DF_PRS_ID = X.DF_PRS_ID
	AND X.PF_ACT = 'ALBNC'
	AND X.BD_ATY_PRF > B.BD_ATY_PRF
	)
AND A.DF_PRS_ID NOT IN 
	(SELECT DISTINCT DF_PRS_ID 
	 FROM OLWHRM1.AY01_BR_ATY Y
	 WHERE Y.PF_ACT = 'ASCON'
	 AND Y.BD_ATY_PRF >= 
	 		(SELECT MIN(Z.BD_ATY_PRF)
			 FROM OLWHRM1.AY01_BR_ATY Z
			 WHERE Z.DF_PRS_ID = Y.DF_PRS_ID 
			 AND Z.PF_ACT = 'ACRDL')
	 )
/*ORDER BY DM_FGN_CNY DESC DF_PRS_ID ASC*/
FOR READ ONLY WITH UR
/*AND NOT EXISTS*/
/*	(SELECT **/
/*	 FROM OLWHRM1.AY01_BR_ATY Y*/
/*	 WHERE Y.DF_PRS_ID = A.DF_PRS_ID*/
/*	 AND Y.PF_ACT = 'ASCON'*/
/*	 AND Y.BD_ATY_PRF >= */
/*	 		(SELECT MIN(Z.BD_ATY_PRF)*/
/*			 FROM OLWHRM1.AY01_BR_ATY Z*/
/*			 WHERE Z.DF_PRS_ID = Y.DF_PRS_ID */
/*			 AND Z.PF_ACT = 'ACRDL')*/
);
DISCONNECT FROM DB2;

/*REMOVE RECORDS FROM CAMPAIGN IF THEY WERE IDENTIFIED IN DC10LIST OR SLMA TABLES ABOVE*/
CREATE TABLE SCCD1B AS
SELECT A.*
FROM SCCD1A A
WHERE A.DF_PRS_ID_BR NOT IN
(SELECT BF_SSN
FROM DC10LIST)
OR A.DF_PRS_ID_BR NOT IN
(SELECT DF_PRS_ID_BR
FROM SLMA)
;

/*REMOVE RECORDS FROM CAMPAIGN IF THEY WERE NOT IDENTIFIED IN MULTI_DF TABLE ABOVE*/
CREATE TABLE SCCD1 AS
SELECT A.*
FROM SCCD1B A
INNER JOIN MULTI_DF B
	ON A.DF_PRS_ID_BR = B.BF_SSN
;
QUIT;

DATA SCCD1;
SET SCCD1;
IF DM_FGN_CNY = '' THEN SORT_VAR = 'Z';
ELSE SORT_VAR = 'A';
RUN;

DATA SCCD2;
SET SCCD2;
IF DM_FGN_CNY = '' THEN SORT_VAR = 'Z';
ELSE SORT_VAR = 'A';
RUN;

DATA SCCD3;
SET SCCD3;
IF DM_FGN_CNY = '' THEN SORT_VAR = 'Z';
ELSE SORT_VAR = 'A';
RUN;

PROC SORT DATA=SCCD1 NODUPKEY;BY SORT_VAR DF_PRS_ID_BR;RUN;
PROC SORT DATA=SCCD2;BY SORT_VAR DF_PRS_ID;RUN;
PROC SORT DATA=SCCD3;BY SORT_VAR DF_PRS_ID;RUN;

/*%put  sqlxrc= >>> &sqlxrc <<< ||| sqlxmsg= >>> &sqlxmsg >>> ;  ** includes error messages to SAS log  ;*/
/*%sqlcheck;*/
/*quit;*/

ENDRSUBMIT;
DATA SCCD1; SET WORKLOCL.SCCD1; RUN;
DATA SCCD2; SET WORKLOCL.SCCD2; RUN;
DATA SCCD3; SET WORKLOCL.SCCD3; RUN;

/*REMOVE BORROWERS WITH INVALID ADDRESS OR PHONE TO PRINT ON REPORT*/
DATA SCCD1 IVAD1;
SET SCCD1;
IF DI_PHN_VLD = 'N' THEN OUTPUT IVAD1;
ELSE IF DI_VLD_ADR = 'N' THEN OUTPUT IVAD1;
ELSE OUTPUT SCCD1;
RUN;

DATA SCCD2 IVAD2;
SET SCCD2;
IF DI_PHN_VLD = 'N' THEN OUTPUT IVAD2;
ELSE IF DI_VLD_ADR = 'N' THEN OUTPUT IVAD2;
ELSE OUTPUT SCCD2;
RUN;

DATA SCCD3 IVAD3;
SET SCCD3;
IF DI_PHN_VLD = 'N' THEN OUTPUT IVAD3;
ELSE IF DI_VLD_ADR = 'N' THEN OUTPUT IVAD3;
ELSE OUTPUT SCCD3;
RUN;

DATA IVAD (DROP=DF_PRS_ID_BR DF_PRS_ID);
SET IVAD1 IVAD2 IVAD3;
IF DF_PRS_ID_BR = ' ' THEN SSN = DF_PRS_ID;
ELSE SSN = DF_PRS_ID_BR;
RUN;

PROC SORT DATA=IVAD;
BY SSN;
RUN;

DATA _NULL_;
SET  WORK.SCCD1;
FILE REPORT2 DELIMITER=',' DSD DROPOVER ;
FORMAT DF_PRS_ID_BR $9. ;
FORMAT DM_PRS_1 $12. ;
FORMAT DM_PRS_LST $35. ;
FORMAT AF_APL_OPS_SCL $8. ;
FORMAT IM_IST_FUL $40. ;
FORMAT DM_FGN_CNY $25. ;
FORMAT DC_DOM_ST $2. ;
FORMAT COST_CENTER_CODE $6. ;
DO;
PUT DF_PRS_ID_BR $ @;
PUT DM_PRS_1 $ @;
PUT DM_PRS_LST $ @;
PUT AF_APL_OPS_SCL $ @;
PUT IM_IST_FUL $ @;
PUT DM_FGN_CNY $ @;
PUT DC_DOM_ST $ @;
PUT COST_CENTER_CODE $;
;
END;
RUN;

DATA _NULL_;
SET  WORK.SCCD2;
FILE REPORT3 DELIMITER=',' DSD DROPOVER ;
FORMAT DF_PRS_ID $9. ;
FORMAT DM_PRS_1 $12. ;
FORMAT DM_PRS_LST $35. ;
FORMAT DM_FGN_CNY $25. ;
FORMAT DC_DOM_ST $2. ;
FORMAT COST_CENTER_CODE $6. ;
DO;
PUT DF_PRS_ID $ @;
PUT DM_PRS_1 $ @;
PUT DM_PRS_LST $ @;
PUT DM_FGN_CNY $ @;
PUT DC_DOM_ST $ @;
PUT COST_CENTER_CODE $;
;
END;
RUN;

DATA _NULL_;
SET  WORK.SCCD3;
FILE REPORT4 DELIMITER=',' DSD DROPOVER ;
FORMAT DF_PRS_ID $9. ;
FORMAT DM_PRS_1 $12. ;
FORMAT DM_PRS_LST $35. ;
FORMAT DM_FGN_CNY $25. ;
FORMAT DC_DOM_ST $2. ;
FORMAT COST_CENTER_CODE $6. ;
DO;
PUT DF_PRS_ID $ @;
PUT DM_PRS_1 $ @;
PUT DM_PRS_LST $ @;
PUT DM_FGN_CNY $ @;
PUT DC_DOM_ST $ @;
PUT COST_CENTER_CODE $;
;
END;
RUN;

DATA _NULL_;                                      
CURRENT=TODAY();                                  
CALL SYMPUT('CURDATE',PUT(CURRENT,MMDDYY10.));       
RUN;  

PROC PRINTTO PRINT=REPORT5 NEW;
RUN;
OPTIONS PAGENO=1 LS=100 NODATE CENTER;
TITLE 'SC--CHRONIC DELINQUENTS INVALID ADDRESS OR PHONE';
TITLE2 "RUN DATE: &CURDATE";
PROC CONTENTS DATA=IVAD OUT=EMPTYSET NOPRINT;
DATA _NULL_;
SET EMPTYSET;
FILE PRINT;
IF  NOBS=0 AND _N_ =1 THEN DO;
	PUT // 100*'-';
	PUT      ////////
		@45 '**** NO OBSERVATIONS FOUND ****';
	PUT ////////
		@49 '-- END OF REPORT --';
	PUT /////////////////////////
		@38 "JOB = UTLWM05  	 REPORT = ULWM05.LWM05R5";
	END;
RETURN;
RUN;

PROC PRINT NOOBS SPLIT='/' DATA=IVAD N="TOTAL: ";
VAR SSN
	DI_VLD_ADR
	DI_PHN_VLD;
LABEL DI_PHN_VLD = 'VALID PHONE'
	DI_VLD_ADR = 'VALID ADDRESS';
FOOTNOTE  'JOB = UTLWM05 	 REPORT = ULWM05.LWM05R5';
RUN;

PROC PRINTTO;
RUN;
