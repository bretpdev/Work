*-----------------------------------------*
|UTLWG94 PO BOX ADDRESS WITH PENDING DISB |
*-----------------------------------------*;
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWG94.LWG94R2";
FILENAME REPORTZ "&RPTLIB/ULWG94.LWG94RZ";
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE POBAWPD AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT D.AF_DOE_SCL
	,B.DF_PRS_ID
	,A.LN_SEQ
	,RTRIM(C.DM_PRS_1)||','||C.DM_PRS_LST AS NAME 
	,B.DX_STR_ADR_1
	,B.DX_STR_ADR_2
	,B.DM_CT
	,B.DC_DOM_ST
	,B.DF_ZIP_CDE
	,LN15B.ACT_DISB
/*	,D.AF_CNL||D.AF_CNL_SFX AS CLUID*/
FROM OLWHRM1.LN15_DSB A
INNER JOIN OLWHRM1.PD30_PRS_ADR B
	ON A.BF_SSN = B.DF_PRS_ID
INNER JOIN OLWHRM1.PD10_PRS_NME C
	ON B.DF_PRS_ID = C.DF_PRS_ID
INNER JOIN OLWHRM1.AP03_MASTER_APL D
	ON A.AF_APL_ID = D.AF_APL_ID
LEFT OUTER JOIN (
		SELECT X.BF_SSN
			,Y.AF_CNL 
			,Y.AF_CNL_SFX
			,'X' AS ACT_DISB
		FROM OLWHRM1.LN15_DSB X
		INNER JOIN OLWHRM1.AP03_MASTER_APL Y
			ON X.AF_APL_ID = Y.AF_APL_ID
		WHERE X.LC_DSB_TYP = '2'
		AND X.LC_STA_LON15 IN ('1','3')
		AND X.LA_DSB <> COALESCE(X.LA_DSB_CAN,0) 
	) LN15B
	ON  D.AF_CNL = LN15B.AF_CNL
	AND D.AF_CNL_SFX = LN15B.AF_CNL_SFX 
WHERE A.LC_DSB_TYP = '1'
AND A.LC_STA_LON15 IN ('1','3')
AND A.LA_DSB <> COALESCE(A.LA_DSB_CAN,0) 
AND B.DI_VLD_ADR = 'Y'
AND B.DC_ADR = 'L'
AND 
	(
		(
			B.DX_STR_ADR_1 LIKE '%BOX%' AND 
			B.DX_STR_ADR_2 = ''
		)
	OR 
		(
			B.DX_STR_ADR_2 LIKE '%BOX%' AND
			B.DX_STR_ADR_1 = ''
		)	
	)
AND A.BF_SSN NOT IN 
	(
			SELECT BF_SSN 
			FROM OLWHRM1.AY10_BR_LON_ATY
			WHERE LC_STA_ACTY10 = 'A'
			AND PF_REQ_ACT = 'POBOX'
		UNION
			SELECT DF_PRS_ID_BR AS BF_SSN
			FROM OLWHRM1.CT30_CALL_QUE
			WHERE IF_WRK_GRP IN ('KPBOXRV','GAPHLDPO')
	)
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWG94.LWG94RZ);*/
/*QUIT;*/
ENDRSUBMIT;
DATA POBAWPD;
SET WORKLOCL.POBAWPD;
RUN;
DATA POBAWPD;
SET WORKLOCL.POBAWPD;
WHERE ACT_DISB = '';
RUN;
PROC SORT DATA=POBAWPD NODUPKEY;BY DF_PRS_ID ;RUN;
PROC SORT DATA=POBAWPD;BY AF_DOE_SCL DF_PRS_ID ;RUN;
DATA _NULL_;
SET  WORK.POBAWPD;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT AF_DOE_SCL $8. ;
	FORMAT DF_PRS_ID $9. ;
	FORMAT NAME $37. ;
	FORMAT DX_STR_ADR_1 $30. ;
	FORMAT DX_STR_ADR_2 $30. ;
	FORMAT DM_CT $20. ;
	FORMAT DC_DOM_ST $2. ;
	FORMAT DF_ZIP_CDE $17. ;
DO;
	PUT AF_DOE_SCL $ @;
	PUT DF_PRS_ID $ @;
	PUT NAME $ @;
	PUT DX_STR_ADR_1 $ @;
	PUT DX_STR_ADR_2 $ @;
	PUT DM_CT $ @;
	PUT DC_DOM_ST $ @;
	PUT DF_ZIP_CDE $ ;
END;
RUN;
