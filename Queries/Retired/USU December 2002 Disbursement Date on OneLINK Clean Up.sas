/*CLEAN UP USU DECEMBER 2002 DISBURSEMENT DATE ON ONELINK*/
FILENAME REPORT2 "T:\SAS\DSASG10R2.TXT";
FILENAME REPORT3 "T:\SAS\DSASG10R3.TXT";
/*GETS THE PREVIOUS DAY*/
options symbolgen;

LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);

CREATE TABLE DEMOO AS
SELECT *
FROM CONNECTION TO DB2 (

SELECT DISTINCT GA01.DF_PRS_ID_BR AS SSN 
	,GA01.AF_APL_ID
	,GA11.AF_APL_ID_SFX 
	,LN15.LD_DSB

	,COALESCE(LN15.LA_DSB,0) AS LA_DSB
	,COALESCE(LN15.LA_DSB_CAN,0) AS LA_DSB_CAN
	,AP03.AN_SEQ
	,GA11.AN_DSB_SEQ
	,GA11.AA_DSB_ADJ
	,GA01.AF_APL_OPS_SCL
	,GA11.AD_DSB_ADJ
	,GA11.AC_DSB_ADJ
	,AP11.AD_SGS_DSB 
	,GA11.AD_DSB_ADJ
	,LN15.LC_STA_LON15
	,GA11.AC_DSB_ADJ_STA
	,CAN.CANCEL
	,CAN.CAN_AMT

FROM	OLWHRM1.GA11_LON_DSB_ATY GA11
INNER JOIN OLWHRM1.GA01_APP GA01
	ON GA01.AF_APL_ID = GA11.AF_APL_ID
LEFT OUTER JOIN OLWHRM1.GA10_LON_APP GA10
	ON GA11.AF_APL_ID = GA10.AF_APL_ID
	AND GA11.AF_APL_ID_SFX = GA10.AF_APL_ID_SFX
LEFT OUTER JOIN OLWHRM1.AP03_MASTER_APL AP03 
	ON GA11.AF_APL_ID = AP03.AF_CNL
	AND GA11.AF_APL_ID_SFX = AP03.AF_CNL_SFX
LEFT OUTER JOIN OLWHRM1.AP11_APL_DSB AP11
	ON AP03.AF_APL_ID = AP11.AF_APL_ID
/*LEFT OUTER JOIN OLWHRM1.GR15_RPT_DSB GR15*/
/*	ON GR15.BF_SSN = */
/*	AND */
LEFT OUTER JOIN OLWHRM1.LN15_DSB LN15
	ON AP03.AF_APL_ID = LN15.AF_APL_ID
	AND AP03.AN_SEQ = LN15.AN_SEQ
	AND AP03.BF_SSN = LN15.BF_SSN
	AND GA11.AN_DSB_SEQ= LN15.LN_LON_DSB_SEQ/**/
LEFT OUTER JOIN (SELECT DISTINCT X.AF_APL_ID, X.AF_APL_ID_SFX, X.AN_DSB_SEQ
				, 'C' AS CANCEL, X.AA_DSB_ADJ AS CAN_AMT
			FROM OLWHRM1.GA11_LON_DSB_ATY X
			WHERE X.AC_DSB_ADJ IN ('C','P','U')
			AND X.AC_DSB_ADJ_STA = 'A'
			) CAN
	ON GA11.AF_APL_ID = CAN.AF_APL_ID
	AND GA11.AF_APL_ID_SFX = CAN.AF_APL_ID_SFX
	AND GA11.AN_DSB_SEQ = CAN.AN_DSB_SEQ 


WHERE GA11.AC_DSB_ADJ IN ('E')
AND GA11.AD_DSB_ADJ IN ('12/31/2002')
AND GA01.AF_APL_OPS_SCL = '00367700'
AND NOT EXISTS (SELECT *
				FROM OLWHRM1.GA11_LON_DSB_ATY X
				WHERE X.AC_DSB_ADJ = 'A'
				AND X.AC_DSB_ADJ_STA = 'A'
				AND GA11.AF_APL_ID = X.AF_APL_ID
				AND GA11.AF_APL_ID_SFX = X.AF_APL_ID_SFX
				AND GA11.AN_DSB_SEQ = X.AN_DSB_SEQ 
			)

AND AP11.AD_SGS_DSB = '12/23/2002'
AND GA10.AC_PRC_STA = 'A'
AND GA11.AC_DSB_ADJ_STA = 'A'
AND LN15.LC_STA_LON15 IN ('1','3')
/*AND GA01.DF_PRS_ID_BR = '646580972'*/
);



DISCONNECT FROM DB2;
ENDRSUBMIT;
DATA DEMOO; SET WORKLOCL.DEMOO; RUN;

PROC SORT DATA=WORK.DEMOO;
BY SSN;
RUN;



PROC SQL;
CREATE TABLE ERRORTBL AS
SELECT DISTINCT SSN 
	,AF_APL_ID
	,AF_APL_ID_SFX 
	,LD_DSB
	,SUM(CAN_AMT) AS CAN_AMT
FROM DEMOO
WHERE CANCEL = 'C'
AND LA_DSB = LA_DSB_CAN  
GROUP BY SSN 
	,AF_APL_ID
	,AF_APL_ID_SFX 
	,LD_DSB

;
QUIT;
PROC SQL;
CREATE TABLE DSBTBL AS
SELECT DISTINCT SSN 
	,AF_APL_ID
	,AF_APL_ID_SFX 
	,LD_DSB
	,SUM(CAN_AMT) AS CAN_AMT
FROM DEMOO
WHERE (CANCEL = 'C' AND LA_DSB <> LA_DSB_CAN)  
OR CANCEL <> 'C'
GROUP BY SSN 
	,AF_APL_ID
	,AF_APL_ID_SFX 
	,LD_DSB

;
QUIT;






/*PROC PRINTTO PRINT=REPORT2;
RUN;*/
/*For landscape reports:*/
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127;

/*For portrait reports;*/
/*OPTIONS ORIENTATION = PORTRAIT;*/
/*OPTIONS PS=52 LS=96;*/

/*PROC PRINT NOOBS SPLIT='/' DATA=WORK.ERRORTBL;*/
/**/
/*TITLE 'CLEAN UP USU DECEMBER 2002 DISBURSEMENT';*/
/*FOOTNOTE  'JOB = DSASG10     REPORT = DSASG10R2';*/
/*RUN;*/

DATA _NULL_;
SET  WORK.DSBTBL;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
FORMAT SSN 9. LD_DSB MMDDYY10. ;
PUT SSN $ @;
PUT AF_APL_ID $ @;
PUT AF_APL_ID_SFX $ @;
PUT LD_DSB $;

RUN;

DATA _NULL_;
SET  WORK.ERRORTBL;
FILE REPORT3 DELIMITER=',' DSD DROPOVER LRECL=32767;
FORMAT SSN 9. LD_DSB MMDDYY10. ;
PUT SSN $ @;
PUT AF_APL_ID $ @;
PUT AF_APL_ID_SFX $ @;
PUT LD_DSB $;

RUN;

/*PROC EXPORT DATA=WORK.DEMOO*/
/*            OUTFILE= "T:\SAS\DEMO.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/