/*===========================================*/
/*REMOVAL OF SUPPRESSED CONSOLIDATION LVC.SAS*/
/*===========================================*/
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE BORWR AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT AP1A.DF_LCO_PRS_SSN_BR AS SSN
	,AP1A.AN_LCO_APL_SEQ
	,BRWR.LN_SEQ
	,BRWR.LF_LON_CUR_OWN
	,BRWR.IF_DOE_LDR
	,LC10.LF_UND_LN_ACC_NUM
FROM OLWHRM1.AP1A_LCO_APL AP1A
INNER JOIN OLWHRM1.LC10_UND_LN_INF LC10
	ON AP1A.DF_LCO_PRS_SSN_BR = LC10.DF_LCO_PRS_SSN_BR
	AND AP1A.AN_LCO_APL_SEQ = LC10.AN_LCO_APL_SEQ
LEFT OUTER JOIN OLWHRM1.LN10_LON BRWR
	ON AP1A.DF_LCO_PRS_SSN_BR = BRWR.BF_SSN
WHERE AP1A.AD_LCO_APL_RCV IS NOT NULL
AND AP1A.AD_LCO_APL_DSB IS NULL
AND AP1A.IC_LCO_DSB_APV_STA <> 'A'
AND COALESCE(LC10.LA_UND_LN_ANT_PAY,0) = 0
AND LC10.LI_UND_LN_CON = 'Y'
AND LC10.LI_UND_LN_SER_ORG = 'Y'
AND (AP1A.AC_LCO_ACC_STA NOT IN ('D1','D3','D4','D6','D7','D8')
	 OR 
	 AP1A.IC_LCO_LN_GTR_STA <> 'S')
FOR READ ONLY WITH UR
);

CREATE TABLE COB AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT LC10.DF_LCO_PRS_SSN_CBR AS SSN
	,LC10.AN_LCO_APL_SEQ
	,COBR.LN_SEQ
	,COBR.LF_LON_CUR_OWN
	,COBR.IF_DOE_LDR
	,LC10.LF_UND_LN_ACC_NUM
FROM OLWHRM1.AP1A_LCO_APL AP1A
INNER JOIN OLWHRM1.LC10_UND_LN_INF LC10
	ON AP1A.DF_LCO_PRS_SSN_BR = LC10.DF_LCO_PRS_SSN_BR
	AND AP1A.AN_LCO_APL_SEQ = LC10.AN_LCO_APL_SEQ
LEFT OUTER JOIN OLWHRM1.LN10_LON COBR
	ON LC10.DF_LCO_PRS_SSN_CBR = COBR.BF_SSN
WHERE AP1A.AD_LCO_APL_RCV IS NOT NULL
AND AP1A.AD_LCO_APL_DSB IS NULL
AND AP1A.IC_LCO_DSB_APV_STA <> 'A'
AND COALESCE(LC10.LA_UND_LN_ANT_PAY,0) = 0
AND LC10.LI_UND_LN_CON = 'Y'
AND LC10.LI_UND_LN_SER_ORG = 'Y'
AND (AP1A.AC_LCO_ACC_STA NOT IN ('D1','D3','D4','D6','D7','D8')
	 OR 
	 AP1A.IC_LCO_LN_GTR_STA <> 'S')
AND LC10.DF_LCO_PRS_SSN_CBR IS NOT NULL
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
ENDRSUBMIT;

DATA BORWR;SET WORKLOCL.BORWR;RUN;
DATA COB;SET WORKLOCL.COB;RUN;

DATA LCO CMPS;
SET BORWR;
RUN;

%MACRO LCO2LS(DS);
DATA &DS;
SET &DS;
IF LN_SEQ = INPUT(SUBSTR(LF_UND_LN_ACC_NUM,8,2),2.) 
	AND LF_LON_CUR_OWN NE '828476' THEN OUTPUT;
ELSE DELETE;
RUN;
%MEND LCO2LS;
%LCO2LS(CMPS);
%LCO2LS(COB);

DATA CMPS;
SET CMPS COB;
RUN;

PROC SORT DATA=LCO NODUPKEY;BY SSN AN_LCO_APL_SEQ;RUN;
PROC SORT DATA=CMPS NODUPKEY;BY SSN LN_SEQ;RUN;

DATA _NULL_;
SET WORK.LCO;
FILE 'T:\SAS\REMOVAL.SUPPRESSED.LVC.R2' DELIMITER=',' DSD DROPOVER LRECL=32767;
FORMAT SSN $9. ;
FORMAT AN_LCO_APL_SEQ $2. ;
DO;
PUT SSN $ @;
PUT AN_LCO_APL_SEQ $ ;
END;
RUN;

DATA _NULL_;
SET  WORK.CMPS;
FILE 'T:\SAS\REMOVAL.SUPPRESSED.LVC.R3' DELIMITER=',' DSD DROPOVER LRECL=32767;
   FORMAT SSN $9. ;
   FORMAT LN_SEQ 6. ;
   FORMAT IF_DOE_LDR $8.;
DO;
   PUT SSN $ @;
   PUT LN_SEQ @;
   PUT IF_DOE_LDR $;
END;
RUN;