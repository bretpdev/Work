*--------------------------------------------*
| KEY BANK - ACTIVE MPNS					 |
*--------------------------------------------*;
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWAB1.LWAB1R2";
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE KEYFO AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.DF_PRS_ID_BR
	,B.AF_APL_ID||B.AF_APL_ID_SFX AS CLUID
	,CASE 
		WHEN SER.AD_EXP IS NULL THEN BAS.AD_EXP 
		ELSE SER.AD_EXP
	 END AS AD_EXP
FROM OLWHRM1.GA01_APP A
INNER JOIN OLWHRM1.GA10_LON_APP B
	ON A.AF_APL_ID = B.AF_APL_ID
LEFT JOIN OLWHRM1.GA40_BS_MPN_CTL SER
	ON A.AF_BS_MPN_APL_ID = SER.AF_BS_MPN_APL_ID
LEFT JOIN OLWHRM1.GA40_BS_MPN_CTL BAS
	ON A.AF_APL_ID = BAS.AF_BS_MPN_APL_ID
WHERE A.AF_CUR_APL_OPS_LDR = '813760'
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
ENDRSUBMIT;
DATA KEYFO ;
	SET WORKLOCL.KEYFO;
RUN;
DATA KEYFO;
	SET KEYFO;
	WHERE AD_EXP > TODAY();
RUN;
PROC SORT DATA=KEYFO;
	BY DF_PRS_ID_BR CLUID;
RUN;
DATA _NULL_;
	SET  WORK.KEYFO;
	FILE 'T:\SAS\KeyBankActiveMPNS.txt' DELIMITER=',' DSD DROPOVER LRECL=32767;
	   FORMAT DF_PRS_ID_BR $9. ;
	   FORMAT CLUID $19. ;
	IF _N_ = 1 THEN DO;
		PUT 'BF_SSN,CLUID';
	END;
	DO;
	   PUT DF_PRS_ID_BR $ @;
	   PUT CLUID $ ;
	END;
RUN;
