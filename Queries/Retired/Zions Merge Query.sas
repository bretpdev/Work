/*=========================*/
/*DSASQ21 Zions Merge Query*/
/*=========================*/

LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE ZIMRQRY AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.BF_SSN 
	,B.AF_APL_ID||B.AF_APL_ID_SFX AS CLUID
	,B.AD_PRC
	,B.AA_GTE_LON_AMT
	,B.AC_LON_TYP
	,C.LD_FAT_EFF
	,D.AD_LON_STA
FROM OLWHRM1.LN10_LON A
INNER JOIN OLWHRM1.GA10_LON_APP B
	ON A.LF_LON_ALT = B.AF_APL_ID
	AND A.LN_LON_ALT_SEQ = INTEGER(B.AF_APL_ID_SFX)
INNER JOIN OLWHRM1.LN90_FIN_ATY C 
	ON A.BF_SSN = C.BF_SSN 
	AND A.LN_SEQ = C.LN_SEQ
INNER JOIN OLWHRM1.GA14_LON_STA D
	ON B.AF_APL_ID = D.AF_APL_ID
	AND B.AF_APL_ID_SFX = D.AF_APL_ID_SFX
WHERE A.LC_STA_LON10 = 'D'
AND C.PC_FAT_TYP = '02'
AND C.PC_FAT_SUB_TYP = '91'
AND D.AC_LON_STA_TYP = 'PF'
AND D.AC_STA_GA14 = 'A'
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
ENDRSUBMIT;

DATA ZIMRQRY;
SET WORKLOCL.ZIMRQRY;
RUN;

DATA ZIMRQRY;
SET ZIMRQRY;
IF LD_FAT_EFF EQ AD_LON_STA THEN OUTPUT;
RUN;

PROC SORT DATA=ZIMRQRY;
BY BF_SSN CLUID;
RUN;

DATA _NULL_;
SET  WORK.ZIMRQRY;
FILE 'T:\SAS\DSASQ21.R2' DELIMITER=',' DSD DROPOVER LRECL=32767;
FORMAT BF_SSN $9. ;
FORMAT CLUID $19. ;
FORMAT AD_PRC MMDDYY10. ;
FORMAT AA_GTE_LON_AMT 10.2 ;
FORMAT AC_LON_TYP $2. ;
FORMAT AD_LON_STA MMDDYY10.;
FORMAT LD_FAT_EFF MMDDYY10.;
DO;
PUT BF_SSN $ @;
PUT CLUID $ @;
PUT AD_PRC @;
PUT AA_GTE_LON_AMT @;
PUT AC_LON_TYP $ @;
PUT AD_LON_STA @;
PUT LD_FAT_EFF ;
END;
RUN;