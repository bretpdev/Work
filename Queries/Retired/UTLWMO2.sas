/*UTLWM02 - SPECIAL CAMPAIGN - PROP SCHOOL PLUS*/

LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;
%LET RPTLIB = %SYSGET(reportdir);
FILENAME REPORT2 "&RPTLIB/ULWM02.LWM02R2";
FILENAME REPORT3 "&RPTLIB/ULWM02.LWM02R3";
FILENAME REPORT4 "&RPTLIB/ULWM02.LWM02R4";
FILENAME REPORT5 "&RPTLIB/ULWM02.LWM02R5";

/*FILENAME REPORT2 "T:\SAS\ULWM02.LWM02R2";*/
/*FILENAME REPORT3 "T:\SAS\ULWM02.LWM02R3";*/
/*FILENAME REPORT4 "T:\SAS\ULWM02.LWM02R4";*/
/*FILENAME REPORT5 "T:\SAS\ULWM02.LWM02R5";*/
/*libname  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=work  ;*/
/*RSUBMIT;*/

PROC SQL STIMER;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE SCPL1 AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT
	A.DF_PRS_ID_BR
	,A.AF_APL_OPS_SCL
	,E.IM_IST_SHO
	,C.AD_DSB_ADJ
	,RTRIM(D.DM_PRS_1) AS DM_PRS_1
	,RTRIM(D.DM_PRS_LST) AS DM_PRS_LST
	,D.DI_VLD_ADR AS ADD
	,D.DI_PHN_VLD AS PHO
FROM  OLWHRM1.GA01_APP A 
INNER JOIN OLWHRM1.GA10_LON_APP B
	ON A.AF_APL_ID = B.AF_APL_ID
INNER JOIN OLWHRM1.GA11_LON_DSB_ATY C
	ON B.AF_APL_ID = C.AF_APL_ID
	AND B.AF_APL_ID_SFX = C.AF_APL_ID_SFX
	AND C.AN_DSB_SEQ = 1
	AND C.AC_DSB_ADJ = 'A' /*ACTUAL DISB*/
	AND C.AC_DSB_ADJ_STA = 'A' /*ACTIVE ROW*/
INNER JOIN OLWHRM1.PD01_PDM_INF D
	ON A.DF_PRS_ID_STU = D.DF_PRS_ID
INNER JOIN
	(SELECT DISTINCT 
		IF_IST
		,IM_IST_SHO
	FROM OLWHRM1.SC01_LGS_SCL_INF
	)E
	ON A.AF_APL_OPS_SCL = E.IF_IST
WHERE B.AC_LON_TYP = 'PL'
AND B.AC_PRC_STA = 'A' /*APPROVED LOAN*/
AND A.AF_APL_OPS_SCL IN 
	('02298500','02178500','02360800','00367300','00367400',
	 '00367405','00367404','00367401','00367403','03003000',
	 '03030601','03030602','03030606','03030603','03030605',
	 '03030604','03030600','00367400','00367405','00367404',
	 '00367403','00367401')
AND DAYS(C.AD_DSB_ADJ) BETWEEN DAYS(CURRENT DATE) - 7 AND DAYS(CURRENT DATE)
AND NOT EXISTS
	(SELECT *
	FROM OLWHRM1.AY01_BR_ATY X
	WHERE X.DF_PRS_ID = A.DF_PRS_ID_BR
	AND X.PF_ACT = 'APLUS')

/*NO ADROP WITH SUBSEQUENT ALSCL, ALNCH, OR ALBNC*/
AND NOT EXISTS
	(SELECT *
	FROM OLWHRM1.AY01_BR_ATY X
	WHERE X.DF_PRS_ID = A.DF_PRS_ID_BR
	AND X.PF_ACT = 'ADROP'
	AND NOT EXISTS
		(SELECT *
		FROM OLWHRM1.AY01_BR_ATY Y
		WHERE Y.DF_PRS_ID = X.DF_PRS_ID
		AND Y.PF_ACT IN ('ALSCL','ALNCH','ALBNC')
		AND Y.BD_ATY_PRF > X.BD_ATY_PRF))
/*NO ACRDL WITH SUBSEQUENT ALBTU OR ALBNC*/
AND NOT EXISTS
	(SELECT *
	FROM OLWHRM1.AY01_BR_ATY X
	WHERE X.DF_PRS_ID = A.DF_PRS_ID_BR
	AND X.PF_ACT = 'ACRDL'
	AND NOT EXISTS
		(SELECT *
		FROM OLWHRM1.AY01_BR_ATY Y
		WHERE Y.DF_PRS_ID = X.DF_PRS_ID
		AND Y.PF_ACT IN ('ALBTU','ALBNC')
		AND Y.BD_ATY_PRF > X.BD_ATY_PRF))


ORDER BY A.DF_PRS_ID_BR
);

CREATE TABLE SCPL2 AS
SELECT * 
FROM CONNECTION TO DB2 (
SELECT DISTINCT
	A.DF_PRS_ID
	,RTRIM(C.DM_PRS_1) AS DM_PRS_1
	,RTRIM(C.DM_PRS_LST) AS DM_PRS_LST
	,D.DX_STR_ADR_1
	,D.DX_STR_ADR_2
	,D.DM_CT
	,D.DC_DOM_ST
	,D.DF_ZIP
	,D.DC_ADR
	,C.DI_VLD_ADR AS ADD
	,C.DI_PHN_VLD AS PHO
FROM OLWHRM1.AY01_BR_ATY A
INNER JOIN 
	(SELECT DF_PRS_ID
		,COUNT(*)
	FROM OLWHRM1.AY01_BR_ATY 
	WHERE PF_ACT = 'AUCON'
	GROUP BY DF_PRS_ID
	HAVING COUNT(*) >= 3
	)B
	ON A.DF_PRS_ID = B.DF_PRS_ID
INNER JOIN OLWHRM1.PD01_PDM_INF C
	ON A.DF_PRS_ID = C.DF_PRS_ID
INNER JOIN OLWHRM1.PD03_PRS_ADR_PHN D
	ON A.DF_PRS_ID = D.DF_PRS_ID
INNER JOIN OLWHRM1.GA01_APP E
	ON C.DF_PRS_ID = E.DF_PRS_ID_STU 
INNER JOIN OLWHRM1.GA10_LON_APP F
	ON E.AF_APL_ID = F.AF_APL_ID

WHERE A.PF_ACT = 'APLUS'
AND D.DC_ADR = 'L'
AND NOT EXISTS
	(SELECT *
	FROM OLWHRM1.AY01_BR_ATY X
	WHERE X.DF_PRS_ID = E.DF_PRS_ID_BR
	AND X.PF_ACT = 'ALBNC')
ORDER BY A.DF_PRS_ID
);

CREATE TABLE SCPL3 AS
SELECT * 
FROM CONNECTION TO DB2 (
SELECT DISTINCT
	A.DF_PRS_ID 
	,RTRIM(C.DM_PRS_1) AS DM_PRS_1
	,RTRIM(C.DM_PRS_LST) AS DM_PRS_LST
	,D.DX_STR_ADR_1
	,D.DX_STR_ADR_2
	,D.DM_CT
	,D.DC_DOM_ST
	,D.DF_ZIP
	,D.DC_ADR
	,C.DI_VLD_ADR AS ADD
	,C.DI_PHN_VLD AS PHO
FROM OLWHRM1.AY01_BR_ATY A
INNER JOIN OLWHRM1.AY01_BR_ATY B
	ON A.DF_PRS_ID = B.DF_PRS_ID
INNER JOIN OLWHRM1.PD01_PDM_INF C
	ON A.DF_PRS_ID = C.DF_PRS_ID
INNER JOIN OLWHRM1.PD03_PRS_ADR_PHN D
	ON A.DF_PRS_ID = D.DF_PRS_ID
INNER JOIN OLWHRM1.GA01_APP E
	ON C.DF_PRS_ID = E.DF_PRS_ID_BR 
INNER JOIN OLWHRM1.GA10_LON_APP F
	ON E.AF_APL_ID = F.AF_APL_ID

WHERE A.PF_ACT = 'APLUS'
AND B.PF_ACT = 'ASCON'
AND D.DC_ADR = 'L'
AND NOT EXISTS
	(SELECT *
	FROM OLWHRM1.AY01_BR_ATY X
	WHERE X.DF_PRS_ID = E.DF_PRS_ID_BR
	AND X.PF_ACT = 'ALBTU')
ORDER BY A.DF_PRS_ID
);

/*IDENTIFY BORROWERS WITH OPEN SLMA LOANS FOR EXCLUSION*/
CREATE TABLE SLMA AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT W.DF_PRS_ID_BR
FROM OLWHRM1.GA01_APP W
INNER JOIN OLWHRM1.GA10_LON_APP X
	ON W.AF_APL_ID = X.AF_APL_ID
INNER JOIN OLWHRM1.GA14_LON_STA Y
	ON X.AF_APL_ID = Y.AF_APL_ID
	AND X.AF_APL_ID_SFX = Y.AF_APL_ID_SFX
WHERE Y.AC_STA_GA14 = 'A'
AND Y.AC_LON_STA_TYP IN ('IA','ID','IG','IM','RP','CR','FB','DA')
AND (X.AF_CUR_LON_SER_AGY = '700191'
	OR X.AF_CUR_LON_OPS_LDR IN ('829587','830084','830151',
		'831053','831474','833253','888885','899993'))
);

DISCONNECT FROM DB2;

/*REMOVE RECORDS FROM CAMPAIGN IF THEY WERE IDENTIFIED IN SLMA TABLE ABOVE*/
CREATE TABLE SCPL1 AS
SELECT A.*
FROM SCPL1 A
WHERE A.DF_PRS_ID_BR NOT IN
(SELECT DF_PRS_ID_BR
FROM SLMA);

/*REMOVE RECORDS FROM CAMPAIGN IF THEY WERE IDENTIFIED IN SLMA TABLE ABOVE*/
CREATE TABLE SCPL2 AS
SELECT B.*
FROM SCPL2 B
WHERE B.DF_PRS_ID NOT IN
(SELECT DF_PRS_ID_BR
FROM SLMA);

/*REMOVE RECORDS FROM CAMPAIGN IF THEY WERE IDENTIFIED IN SLMA TABLE ABOVE*/
CREATE TABLE SCPL3 AS
SELECT C.*
FROM SCPL3 C
WHERE C.DF_PRS_ID NOT IN
(SELECT DF_PRS_ID_BR
FROM SLMA);

ENDRSUBMIT;
DATA SCPL1; SET SCPL1; RUN;
DATA SCPL2; SET SCPL2; RUN;
DATA SCPL3; SET SCPL3; RUN;

DATA INVALID1 /*(KEEP = SSN ADD PHO)*/;
IF (ADD = 'N' OR PHO = 'N') THEN OUTPUT;
SET SCPL1 SCPL2 SCPL3;

RUN;
DATA INVALID1 (KEEP = SSN ADD PHO);
SET INVALID1;
IF DF_PRS_ID_BR = '' THEN SSN = DF_PRS_ID;
ELSE SSN = DF_PRS_ID_BR;
RUN;

%MACRO KEY_CLC(TBL);
*CALCULATE KEYLINE;
DATA &TBL (DROP = KEYSSN MODAY KEYLINE CHKDIG DIG I 
	CHKDIG CHK1 CHK2 CHK3 CHKDIGIT CHECK);
SET &TBL;
KEYSSN = TRANSLATE(DF_PRS_ID,'MYLAUGHTER','0987654321');
MODAY = PUT(DATE(),MMDDYYN4.);
KEYLINE = "P"||KEYSSN||MODAY||DC_ADR;
CHKDIG = 0;
LENGTH DIG $2.;
DO I = 1 TO LENGTH(KEYLINE);
	IF I/2 NE ROUND(I/2,1) 
		THEN DIG = PUT(INPUT(SUBSTR(KEYLINE,I,1),BITS4.4) * 2, 2.);
	ELSE DIG = PUT(INPUT(SUBSTR(KEYLINE,I,1),BITS4.4), 2.);
	IF SUBSTR(DIG,1,1) = " " 
		THEN CHKDIG = CHKDIG + INPUT(SUBSTR(DIG,2,1),1.);
		ELSE DO;
			CHK1 = INPUT(SUBSTR(DIG,1,1),1.);
			CHK2 = INPUT(SUBSTR(DIG,2,1),1.);
			IF CHK1 + CHK2 >= 10
				THEN DO;
					CHK3 = PUT(CHK1 + CHK2,2.);
					CHK1 = INPUT(SUBSTR(CHK3,1,1),1.);
					CHK2 = INPUT(SUBSTR(CHK3,2,1),1.);
				END;
			CHKDIG = CHKDIG + CHK1 + CHK2;
		END;
END;
CHKDIGIT = 10 - INPUT(SUBSTR((RIGHT(PUT(CHKDIG,3.))),3,1),3.);
IF CHKDIGIT = 10 THEN CHKDIGIT = 0;
CHECK = PUT(CHKDIGIT,1.);
ACSKEY = "#"||KEYLINE||CHECK||"#";
RUN;
%MEND KEY_CLC;

%KEY_CLC(SCPL2);
%KEY_CLC(SCPL3);

DATA _NULL_;
SET  WORK.SCPL1;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
FORMAT DF_PRS_ID_BR $9. ;
FORMAT AF_APL_OPS_SCL $8. ;
FORMAT IM_IST_SHO $20. ;
FORMAT AD_DSB_ADJ MMDDYY10. ;
FORMAT DM_PRS_1 $12. ;
FORMAT DM_PRS_LST $35. ;
DO;
PUT DF_PRS_ID_BR $ @;
PUT AF_APL_OPS_SCL $ @;
PUT IM_IST_SHO $ @;
PUT AD_DSB_ADJ @;
PUT DM_PRS_1 $ @;
PUT DM_PRS_LST $ ;
;
END;
RUN;

DATA _NULL_;
SET  WORK.SCPL2;
FILE REPORT3 DELIMITER=',' DSD DROPOVER ;
FORMAT DF_PRS_ID $9. ;
FORMAT DM_PRS_1 $12. ;
FORMAT DM_PRS_LST $35. ;
FORMAT DX_STR_ADR_1 $35. ;
FORMAT DX_STR_ADR_2 $35. ;
FORMAT DM_CT $30. ;
FORMAT DC_DOM_ST $2. ;
FORMAT DF_ZIP $14. ;
FORMAT ACSKEY $18. ;
DO;
PUT DF_PRS_ID $ @;
PUT DM_PRS_1 $ @;
PUT DM_PRS_LST $ @;
PUT DX_STR_ADR_1 $ @;
PUT DX_STR_ADR_2 $ @;
PUT DM_CT $ @;
PUT DC_DOM_ST $ @;
PUT DF_ZIP $ @;
PUT ACSKEY $ ;
;
END;
RUN;

DATA _NULL_;
SET  WORK.SCPL3;
FILE REPORT4 DELIMITER=',' DSD DROPOVER ;
FORMAT DF_PRS_ID $9. ;
FORMAT DM_PRS_1 $12. ;
FORMAT DM_PRS_LST $35. ;
FORMAT DX_STR_ADR_1 $35. ;
FORMAT DX_STR_ADR_2 $35. ;
FORMAT DM_CT $30. ;
FORMAT DC_DOM_ST $2. ;
FORMAT DF_ZIP $14. ;
FORMAT ACSKEY $18. ;
DO;
PUT DF_PRS_ID $ @;
PUT DM_PRS_1 $ @;
PUT DM_PRS_LST $ @;
PUT DX_STR_ADR_1 $ @;
PUT DX_STR_ADR_2 $ @;
PUT DM_CT $ @;
PUT DC_DOM_ST $ @;
PUT DF_ZIP $ @;
PUT ACSKEY $ ;
;
END;
RUN;

DATA _NULL_;
SET  WORK.INVALID1 ;
FILE REPORT5 DELIMITER=',' DSD DROPOVER ;
FORMAT ADD $1. ;
FORMAT PHO $1. ;
FORMAT DF_PRS_ID_BR $9. ;

PUT SSN $ @;
PUT ADD $ @;
PUT PHO $ ;
    
RUN;
