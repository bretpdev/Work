/*UTLWG54 DAILY CONSOLIDATION LOANS APPROVED FOR DISBURSEMENTS*/
LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;
%LET RPTLIB = %SYSGET(reportdir);
FILENAME REPORT2 "&RPTLIB/ULWG54.LWG54R2";
DATA _NULL_;
     CALL SYMPUT('PREVDAY',"'"||PUT(INTNX('DAY',TODAY(),-1,'BEGINNING'), MMDDYYD10.)||"'");
     CALL SYMPUT('RUNDT',PUT(INTNX('DAY',TODAY(),0,'BEGINNING'), MMDDYYD10.));
RUN;
/*%SYSLPUT PREVDAY = &PREVDAY;*/
/*LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;*/
/*RSUBMIT;*/
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE DCLAFD AS
SELECT LOAN_TYP
	,IF_LCO_LN_BIS_APL
	,COUNT(DISTINCT LN_ID) AS LOAN_COUNT 
	,SUM(LA_UND_LN_ANT_PAY) AS SUM
FROM CONNECTION TO DB2 (
SELECT 	RTRIM(A.DF_LCO_PRS_SSN_BR)||B.LN_LCO_UND_LN_SEQ AS LN_ID
	,A.IF_LCO_LN_BIS_APL
	,B.LA_UND_LN_ANT_PAY
	,CASE 
		WHEN A.DF_LCO_PRS_SSN_CBR <> ' ' 
			AND B.LI_UND_LN_SIN  = 'Y' THEN 'SUBSIDIZED SPOUSAL CONSOLIDATION'
		WHEN A.DF_LCO_PRS_SSN_CBR <> ' ' 
			AND B.LI_UND_LN_SIN <> 'Y' THEN 'UNSUBSIDIZED SPOUSAL CONSOLIDATION'
		WHEN A.DF_LCO_PRS_SSN_CBR = ' ' 
			AND B.LI_UND_LN_SIN = 'Y' THEN 'SUBSIDIZED CONSOLIDATION'
		WHEN A.DF_LCO_PRS_SSN_CBR = ' ' 
			AND B.LI_UND_LN_SIN <> 'Y' THEN 'UNSUBSIDIZED CONSOLIDATION'
	 END AS LOAN_TYP
FROM OLWHRM1.LC10_UND_LN_INF B
INNER JOIN OLWHRM1.AP1A_LCO_APL A
	ON A.DF_LCO_PRS_SSN_BR = B.DF_LCO_PRS_SSN_BR
	AND A.AN_LCO_APL_SEQ = B.AN_LCO_APL_SEQ
WHERE A.AD_LCO_DSB_APV_STA = &PREVDAY
AND A.IC_LCO_DSB_APV_STA = 'A'
AND B.LI_UND_LN_CON = 'Y'
)
GROUP BY LOAN_TYP
	,IF_LCO_LN_BIS_APL
;
DISCONNECT FROM DB2;
/*ENDRSUBMIT;*/
/*DATA DCLAFD;*/
/*SET WORKLOCL.DCLAFD;*/
/*RUN;*/
PROC SORT DATA=DCLAFD;
BY LOAN_TYP;
RUN;
PROC PRINTTO PRINT=REPORT2;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 PAGENO=1 CENTER NODATE;
TITLE 'DAILY CONSOLIDATION LOANS APPROVED FOR DISBURSEMENTS';
TITLE2	"RUNDATE &RUNDT";
FOOTNOTE 'JOB = UTLWG54  	 REPORT = ULWG54.LWG54R2';

PROC PRINT NOOBS SPLIT='/' DATA=DCLAFD WIDTH=UNIFORM WIDTH=MIN;
FORMAT SUM DOLLAR30.2;
VAR LOAN_TYP LOAN_COUNT IF_LCO_LN_BIS_APL SUM;
LABEL LOAN_TYP = 'LOAN TYPE'
	IF_LCO_LN_BIS_APL = 'BOND ID'
	LOAN_COUNT = 'NUMBER OF LOANS' 
	SUM = 'TOTAL AMOUNT APPROVED FOR DISBURSEMENT';
SUM LOAN_COUNT SUM;
RUN;

/*TEST FILE*/
/*LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;*/
/*RSUBMIT;*/
/*PROC SQL;*/
/*CONNECT TO DB2 (DATABASE=DLGSUTWH);*/
/*CREATE TABLE TEST AS*/
/*SELECT **/
/*FROM CONNECTION TO DB2 (*/
/*SELECT A.DF_LCO_PRS_SSN_BR AS BRWRS*/
/*	,RTRIM(A.DF_LCO_PRS_SSN_BR)||B.LN_LCO_UND_LN_SEQ AS LN_ID*/
/*	,A.IF_LCO_LN_BIS_APL*/
/*	,B.LA_UND_LN_ANT_PAY*/
/*	,B.LI_UND_LN_CON*/
/*	,CASE */
/*		WHEN A.DF_LCO_PRS_SSN_CBR <> ' ' */
/*			AND B.LI_UND_LN_SIN  = 'Y' THEN 'SUBSIDIZED SPOUSAL CONSOLIDATION'*/
/*		WHEN A.DF_LCO_PRS_SSN_CBR <> ' ' */
/*			AND B.LI_UND_LN_SIN <> 'Y' THEN 'UNSUBSIDIZED SPOUSAL CONSOLIDATION'*/
/*		WHEN A.DF_LCO_PRS_SSN_CBR = ' ' */
/*			AND B.LI_UND_LN_SIN = 'Y' THEN 'SUBSIDIZED CONSOLIDATION'*/
/*		WHEN A.DF_LCO_PRS_SSN_CBR = ' ' */
/*			AND B.LI_UND_LN_SIN <> 'Y' THEN 'UNSUBSIDIZED CONSOLIDATION'*/
/*	 END AS LOAN_TYP*/
/*FROM OLWHRM1.LC10_UND_LN_INF B*/
/*INNER JOIN OLWHRM1.AP1A_LCO_APL A*/
/*	ON A.DF_LCO_PRS_SSN_BR = B.DF_LCO_PRS_SSN_BR*/
/*	AND A.AN_LCO_APL_SEQ = B.AN_LCO_APL_SEQ*/
/*WHERE A.AD_LCO_DSB_APV_STA = &PREVDAY*/
/*AND A.IC_LCO_DSB_APV_STA = 'A'*/
/*AND B.LI_UND_LN_CON = 'Y'*/
/*);*/
/*DISCONNECT FROM DB2;*/
/*ENDRSUBMIT;*/
/**/
/*DATA TEST;SET WORKLOCL.TEST;RUN;*/
/**/
/*PROC SORT DATA=TEST;BY BRWRS LOAN_TYP LA_UND_LN_ANT_PAY;RUN;*/
/*PROC EXPORT DATA=TEST*/
/*            OUTFILE= "T:\SAS\UTLWG54.TEST.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/