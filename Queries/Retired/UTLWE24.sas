/*UTLWE24 MONTHLY CONSOLIDATION DISB BY CREDITOR BY LOAN TYPE*/
LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;
%LET RPTLIB = %SYSGET(reportdir);
FILENAME REPORT2 "&RPTLIB/ULWE24.LWE24R2";
DATA _NULL_;
     CALL SYMPUT('BEGIN',"'"||PUT(INTNX('MONTH',TODAY(),-1,'BEGINNING'), MMDDYYD10.)||"'");
	 CALL SYMPUT('END',"'"||PUT(INTNX('MONTH',TODAY(),-1,'END'), MMDDYYD10.)||"'");
     CALL SYMPUT('RUNDT',PUT(INTNX('DAY',TODAY(),0,'BEGINNING'), MMDDYYS10.));
RUN;
/*%SYSLPUT BEGIN = &BEGIN;*/
/*%SYSLPUT END = &END;*/
/*LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;*/
/*RSUBMIT;*/
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE XEMO AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT A.DF_LCO_PRS_SSN_BR
	,A.AN_LCO_APL_SEQ
	,A.LN_LCO_UND_LN_SEQ
	,RTRIM(A.DF_LCO_PRS_SSN_BR)||A.LN_LCO_UND_LN_SEQ AS LN_ID
	,A.IF_UND_LN_CDR
	,C.IM_UND_LN_CDR
	,A.LC_UND_LN_PGM
	,B.AD_LCO_APL_DSB
	,A.LA_UND_LN_ACL_PAY
FROM OLWHRM1.LC10_UND_LN_INF A
INNER JOIN OLWHRM1.AP1A_LCO_APL B
	ON A.DF_LCO_PRS_SSN_BR = B.DF_LCO_PRS_SSN_BR
	AND A.AN_LCO_APL_SEQ = B.AN_LCO_APL_SEQ
INNER JOIN OLWHRM1.LR1A_UND_LN_LDR C
	ON A.IF_UND_LN_CDR = C.IF_UND_LN_CDR
WHERE B.AD_LCO_APL_DSB BETWEEN &BEGIN AND &END
AND A.LI_UND_LN_CON = 'Y'
);
DISCONNECT FROM DB2;
/*ENDRSUBMIT;*/
/*DATA XEMO;*/
/*SET WORKLOCL.XEMO;*/
/*RUN;*/
PROC SORT DATA=XEMO OUT=BRW_CT (KEEP=DF_LCO_PRS_SSN_BR) NODUPKEY;
BY DF_LCO_PRS_SSN_BR;
RUN;

DATA _NULL_;
SET BRW_CT;
CALL SYMPUT ('BRW_CT',PUT(_N_,BEST12.));
RUN;

PROC SQL;
CREATE TABLE XEMO2 AS 
SELECT IF_UND_LN_CDR
	,IM_UND_LN_CDR
	,LC_UND_LN_PGM
	,COUNT(LN_ID)			AS LOAN_COUNT
	,SUM(LA_UND_LN_ACL_PAY) AS LOAN_TOTAL
FROM XEMO
GROUP BY IF_UND_LN_CDR
,IM_UND_LN_CDR
,LC_UND_LN_PGM
;
QUIT;
RUN;

DATA XEMO2;
SET XEMO2;
BR_CT = &BRW_CT;
RUN;
PROC PRINTTO PRINT=REPORT2;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=40 LS=127 PAGENO=1 CENTER NODATE;
PROC REPORT DATA=XEMO2 NOWD /*SPACING=1*/ HEADSKIP SPLIT='/';
TITLE 'MONTHLY CONSOLIDATION DISBURSEMENT TOTALS BY CREDITOR BY LOAN TYPE';
TITLE2	"RUNDATE &RUNDT";
FOOTNOTE 'JOB = UTLWE24  	 REPORT = ULWE24.LWE24R2';
COLUMN IF_UND_LN_CDR IM_UND_LN_CDR LC_UND_LN_PGM LOAN_COUNT LOAN_TOTAL BR_CT;
DEFINE IF_UND_LN_CDR / DISPLAY "CREDITOR/CODE" ;
DEFINE IM_UND_LN_CDR / DISPLAY "CREDITOR/NAME" ;
DEFINE LC_UND_LN_PGM / DISPLAY "UNDERLYING/LOAN/TYPE" WIDTH=10;
DEFINE LOAN_COUNT / ANALYSIS "LOAN/COUNT" FORMAT=BEST12.;
DEFINE LOAN_TOTAL / ANALYSIS "LOAN/TOTAL" FORMAT=DOLLAR21.2;
COMPUTE AFTER;
	LINE ' ';
	LINE @40 'TOTAL AMOUNT DISBURSED:' @66 LOAN_TOTAL.SUM DOLLAR21.2;
	LINE @40 'TOTAL NUMBER OF LOANS:' @72 LOAN_COUNT.SUM;
	LINE @40 'TOTAL NUMBER OF BORROWERS:' @72 "&BRW_CT";
	LINE ' ';
ENDCOMP;
RUN;

/*TEST FILE*/
/*LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;*/
/*RSUBMIT;*/
/*PROC SQL;*/
/*CONNECT TO DB2 (DATABASE=DLGSUTWH);*/
/*CREATE TABLE TEST AS*/
/*SELECT **/
/*FROM CONNECTION TO DB2 (*/
/*SELECT A.DF_LCO_PRS_SSN_BR*/
/*	,A.AN_LCO_APL_SEQ*/
/*	,A.LN_LCO_UND_LN_SEQ*/
/*	,RTRIM(A.DF_LCO_PRS_SSN_BR)||A.LN_LCO_UND_LN_SEQ AS LN_ID*/
/*	,A.IF_UND_LN_CDR*/
/*	,C.IM_UND_LN_CDR*/
/*	,A.LC_UND_LN_PGM*/
/*	,B.AD_LCO_APL_DSB*/
/*	,A.LA_UND_LN_ACL_PAY*/
/*	,A.LI_UND_LN_CON*/
/*FROM OLWHRM1.LC10_UND_LN_INF A*/
/*INNER JOIN OLWHRM1.AP1A_LCO_APL B*/
/*	ON A.DF_LCO_PRS_SSN_BR = B.DF_LCO_PRS_SSN_BR*/
/*	AND A.AN_LCO_APL_SEQ = B.AN_LCO_APL_SEQ*/
/*INNER JOIN OLWHRM1.LR1A_UND_LN_LDR C*/
/*	ON A.IF_UND_LN_CDR = C.IF_UND_LN_CDR*/
/*WHERE B.AD_LCO_APL_DSB BETWEEN &BEGIN AND &END*/
/*AND A.LI_UND_LN_CON = 'Y'*/
/*);*/
/*DISCONNECT FROM DB2;*/
/*ENDRSUBMIT;*/
/**/
/*DATA TEST;*/
/*SET WORKLOCL.TEST;*/
/*RUN;*/
/**/
/*PROC SORT DATA=TEST;*/
/*BY IM_UND_LN_CDR LC_UND_LN_PGM;*/
/*RUN;*/
/**/
/*PROC EXPORT DATA=TEST*/
/*            OUTFILE= "T:\SAS\UTLWE24.TEST.xls" */
/*            DBMS=EXCEL2000 REPLACE;*/
/*RUN;*/