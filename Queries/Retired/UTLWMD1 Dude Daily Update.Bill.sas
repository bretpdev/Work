PROC SQL;
CREATE TABLE NO_LN80_DELTA AS
SELECT DISTINCT A.DF_SPE_ACC_ID
	,A.LN_SEQ
	,A.LD_BIL_CRT
	,A.LN_SEQ_BIL_WI_DTE
FROM LN80 A
INNER JOIN DUDE.BILL B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
	  AND A.LN_SEQ = B.LN_SEQ
      AND A.LD_BIL_CRT = B.LD_BIL_CRT
	  AND A.LN_SEQ_BIL_WI_DTE = B.LN_SEQ_BIL_WI_DTE
	  AND A.LD_BIL_STS_RIR_TOL = B.LD_BIL_STS_RIR_TOL
	  AND A.BIL_SAT = B.BIL_SAT
	  AND A.LD_BIL_DU_LON = B.LD_BIL_DU_LON
	  AND A.LC_BIL_MTD = B.LC_BIL_MTD
	  AND A.BIL_MTD = B.BIL_MTD
	  AND A.LC_IND_BIL_SNT = B.LC_IND_BIL_SNT
	  AND A.LC_STA_BIL10 = B.LC_STA_BIL10
	  AND A.LA_BIL_CUR_DU = B.LA_BIL_CUR_DU
	  AND A.LA_BIL_PAS_DU = B.LA_BIL_PAS_DU
	  AND A.LA_TOT_BIL_STS = B.LA_TOT_BIL_STS
	  AND A.LC_STA_LON80 = B.LC_STA_LON80
	  AND A.PAID_AHEAD = B.PAID_AHEAD
;

CREATE TABLE LN80_DELTAS AS
SELECT DISTINCT A.*
FROM LN80 A
LEFT JOIN NO_LN80_DELTA B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
	  AND A.LN_SEQ = B.LN_SEQ
      AND A.LD_BIL_CRT = B.LD_BIL_CRT
	  AND A.LN_SEQ_BIL_WI_DTE = B.LN_SEQ_BIL_WI_DTE
WHERE B.DF_SPE_ACC_ID IS NULL
	AND B.LN_SEQ IS NULL
	AND B.LD_BIL_CRT IS NULL
	AND B.LN_SEQ_BIL_WI_DTE IS NULL;
QUIT;

DATA BILL_DELTAS (KEEP=DF_SPE_ACC_ID LN_SEQ LD_BIL_CRT LN_SEQ_BIL_WI_DTE);
	SET LN80_DELTAS;
RUN;
PROC SORT DATA=BILL_DELTAS NODUPKEY;
	BY DF_SPE_ACC_ID LN_SEQ LD_BIL_CRT LN_SEQ_BIL_WI_DTE;
RUN;
PROC SQL;
CREATE TABLE LOCL_BILL_DELTAS AS
      SELECT A.* 
      FROM DUDE.BILL A
      INNER JOIN BILL_DELTAS B
            ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
			AND A.LN_SEQ = B.LN_SEQ
			AND A.LD_BIL_CRT = B.LD_BIL_CRT
			AND A.LN_SEQ_BIL_WI_DTE = B.LN_SEQ_BIL_WI_DTE
;

INSERT INTO DUDE.BILL_DELETE
      SELECT DF_SPE_ACC_ID
	  		,LN_SEQ
			,LD_BIL_CRT
			,LN_SEQ_BIL_WI_DTE
      FROM LOCL_BILL_DELTAS; 
QUIT;

%UPDATE_DATA(LOCL_BILL_DELTAS,LN80_DELTAS,%STR(DF_SPE_ACC_ID LN_SEQ LD_BIL_CRT LN_SEQ_BIL_WI_DTE));

PROC SQL NOPRINT;
CONNECT TO ODBC AS MD (&MD);
SELECT COUNT(*) 
FROM CONNECTION TO MD (
      DELETE BILL
      FROM BILL A
      INNER JOIN BILL_DELETE B
            ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
			AND A.LN_SEQ = B.LN_SEQ
			AND A.LD_BIL_CRT = B.LD_BIL_CRT
			AND A.LN_SEQ_BIL_WI_DTE = B.LN_SEQ_BIL_WI_DTE
      );
DISCONNECT FROM MD;
QUIT;
PROC SQL ;
INSERT INTO DUDE.BILL
      SELECT * 
      FROM LOCL_BILL_DELTAS
	  WHERE LC_STA_BIL10 = 'A' AND LC_STA_LON80 = 'A'; 
QUIT;

%GOODBYE_NULLCHAR(BILL,LC_IND_BIL_SNT);
%GOODBYE_NULLCHAR(BILL,LD_BIL_STS_RIR_TOL);

PROC SQL NOPRINT;
CONNECT TO ODBC AS MD (&MD);
SELECT COUNT(*) 
FROM CONNECTION TO MD (
      DELETE 
      FROM BILL_DELETE
      );
QUIT;
