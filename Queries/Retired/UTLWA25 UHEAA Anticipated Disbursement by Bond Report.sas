/*UTLWA25 UHEAA Anticipated Disbursement by Bond Report*/
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORTZ "&RPTLIB/ULWA25.LWA25RZ";
FILENAME REPORT2 "&RPTLIB/ULWA25.LWA25R2";
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK  ;
RSUBMIT;
LIBNAME SAS_TAB V8 '/sas/whse/progrevw';
PROC SQL NOPRINT;
	SELECT "'"||TRIM(LENDER_ID)||"'"
		INTO :UHEAA_LIST SEPARATED BY ","
	FROM SAS_TAB.LDR_AFF
	WHERE AFFILIATION = 'UHEAA';
QUIT;
PROC SQL STIMER;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE ADBBR AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT B.AF_LDR_BND_ISS
	,B.AF_DOE_LDR
	,CASE 
		WHEN A.LD_DSB <= CURRENT DATE THEN CURRENT DATE
		ELSE A.LD_DSB
	 END AS LD_DSB
	,B.IC_LON_PGM
	,A.BF_SSN
	,A.LN_LON_DSB_SEQ
	,A.LA_DSB - COALESCE(A.LA_DSB_CAN,0) AS NET_DSB
	,A.LD_DSB
FROM OLWHRM1.LN15_DSB A
INNER JOIN OLWHRM1.AP03_MASTER_APL B 
	ON A.AF_APL_ID = B.AF_APL_ID
INNER JOIN OLWHRM1.SC10_SCH_DMO D
	ON B.AF_DOE_SCL = D.IF_DOE_SCL 
INNER JOIN OLWHRM1.LR10_LDR_DMO E
	ON B.AF_DOE_LDR = E.IF_DOE_LDR 
WHERE A.LC_DSB_TYP = '1'
	AND A.LC_STA_LON15 IN ('1','3')
	AND A.LA_DSB <> COALESCE(A.LA_DSB_CAN,0)
	AND A.LD_DSB_ROS_PRT IS NULL
	AND A.LC_LDR_DSB_MDM = ' '
	AND B.AF_CNL NOT LIKE '%REALLO%'
	AND B.AF_DOE_LDR IN (&UHEAA_LIST)
);
DISCONNECT FROM DB2;
ENDRSUBMIT;
DATA ADBBR;
	SET WORKLOCL.ADBBR;
RUN;	
PROC SQL;
	CREATE TABLE ADBBREP AS
		SELECT DISTINCT A.AF_LDR_BND_ISS
			,A.AF_DOE_LDR
			,A.LD_DSB
			,COALESCE(B.TSTFFRD,0) AS TSTFFRD
			,COALESCE(D.TUNSTFD,0) AS TUNSTFD
			,COALESCE(E.TPLUS,0) AS TPLUS
			,COALESCE(F.TPLUSGB,0) AS TPLUSGB
			,G.TALL 
		FROM ADBBR A
		LEFT OUTER JOIN (
			SELECT AF_LDR_BND_ISS
				,AF_DOE_LDR
				,LD_DSB
				,SUM(NET_DSB) AS TSTFFRD
			FROM ADBBR
			WHERE IC_LON_PGM = 'STFFRD'
			GROUP BY AF_LDR_BND_ISS
				,AF_DOE_LDR
				,LD_DSB
			) B
			ON A.AF_LDR_BND_ISS = B.AF_LDR_BND_ISS
			AND A.AF_DOE_LDR = B.AF_DOE_LDR
			AND A.LD_DSB = B.LD_DSB
		LEFT OUTER JOIN (
			SELECT AF_LDR_BND_ISS
				,AF_DOE_LDR
				,LD_DSB
				,SUM(NET_DSB) AS TUNSTFD
			FROM ADBBR
			WHERE IC_LON_PGM = 'UNSTFD'
			GROUP BY AF_LDR_BND_ISS
				,AF_DOE_LDR
				,LD_DSB
			) D
			ON A.AF_LDR_BND_ISS = D.AF_LDR_BND_ISS
			AND A.AF_DOE_LDR = D.AF_DOE_LDR
			AND A.LD_DSB = D.LD_DSB
		LEFT OUTER JOIN (
			SELECT AF_LDR_BND_ISS
				,AF_DOE_LDR
				,LD_DSB
				,SUM(NET_DSB) AS TPLUS
			FROM ADBBR
			WHERE IC_LON_PGM = 'PLUS'
			GROUP BY AF_LDR_BND_ISS
				,AF_DOE_LDR
				,LD_DSB
			) E
			ON A.AF_LDR_BND_ISS = E.AF_LDR_BND_ISS
			AND A.AF_DOE_LDR = E.AF_DOE_LDR
			AND A.LD_DSB = E.LD_DSB
		LEFT OUTER JOIN (
			SELECT AF_LDR_BND_ISS
				,AF_DOE_LDR
				,LD_DSB
				,SUM(NET_DSB) AS TPLUSGB
			FROM ADBBR
			WHERE IC_LON_PGM = 'PLUSGB'
			GROUP BY AF_LDR_BND_ISS
				,AF_DOE_LDR
				,LD_DSB
			) F
			ON A.AF_LDR_BND_ISS = F.AF_LDR_BND_ISS
			AND A.AF_DOE_LDR = F.AF_DOE_LDR
			AND A.LD_DSB = F.LD_DSB
		LEFT OUTER JOIN (
			SELECT AF_LDR_BND_ISS
				,AF_DOE_LDR
				,LD_DSB
				,SUM(NET_DSB) AS TALL
			FROM ADBBR
			GROUP BY AF_LDR_BND_ISS
				,AF_DOE_LDR
				,LD_DSB
			) G
			ON A.AF_LDR_BND_ISS = G.AF_LDR_BND_ISS
			AND A.AF_DOE_LDR = G.AF_DOE_LDR
			AND A.LD_DSB = G.LD_DSB
		ORDER BY A.AF_LDR_BND_ISS
				,A.AF_DOE_LDR
				,A.LD_DSB
	;
QUIT;
DATA _NULL_;
SET  WORK.ADBBREP;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
   FORMAT AF_LDR_BND_ISS $8. ;
   FORMAT AF_DOE_LDR $8. ;
   FORMAT LD_DSB MMDDYY10. ;
   FORMAT TSTFFRD 12.2 ;
   FORMAT TUNSTFD 12.2 ;
   FORMAT TPLUS 12.2 ;
   FORMAT TPLUSGB 12.2 ;
   FORMAT TALL 12.2 ;
IF _N_ = 1 THEN DO;
	PUT
		'AF_LDR_BND_ISS'
		','
		'AF_DOE_LDR'
		','
		'LD_DSB'
		','
		'TSTFFRD'
		','
		'TUNSTFD'
		','
		'TPLUS'
		','
		'TPLUSGB'
		','
		'TALL';
	END;
DO;
   PUT AF_LDR_BND_ISS $ @;
   PUT AF_DOE_LDR $ @;
   PUT LD_DSB @;
   PUT TSTFFRD @;
   PUT TUNSTFD @;
   PUT TPLUS @;
   PUT TPLUSGB @;
   PUT TALL ;
END;
RUN;
