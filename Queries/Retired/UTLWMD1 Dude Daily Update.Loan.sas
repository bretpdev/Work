/**************************************************************
* IDENTIFY LOAN ROWS WITH NO CHANGES - ONE QUERY PER DATA FILE
***************************************************************/
PROC SQL;
CREATE TABLE NO_LN10_DELTA AS
SELECT DISTINCT A.DF_SPE_ACC_ID
      ,A.LN_SEQ
FROM LN10 A
INNER JOIN DUDE.LOAN B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
      AND A.LA_CUR_PRI = B.LA_CUR_PRI  
      AND A.LA_LON_AMT_GTR = B.LA_LON_AMT_GTR   
      AND A.LD_END_GRC_PRD = B.LD_END_GRC_PRD   
      AND A.IC_LON_PGM = B.IC_LON_PGM   
      AND A.WC_DW_LON_STA = B.WC_DW_LON_STA
	  AND A.DW_LON_STA = B.DW_LON_STA
      AND A.WD_LON_RPD_SR = B.WD_LON_RPD_SR
      AND A.LD_LON_1_DSB = B.LD_LON_1_DSB   
      AND A.HEP = B.HEP   
	  AND A.ACH_RATE = B.ACH_RATE
	  AND A.RIR_INT = B.RIR_INT
	  AND A.RIR_TYP = B.RIR_TYP
	  AND A.WA_TOT_BRI_OTS = B.WA_TOT_BRI_OTS
	  AND A.LD_PIF_RPT = B.LD_PIF_RPT
;

CREATE TABLE NO_LN83_DELTA AS
SELECT DISTINCT A.DF_SPE_ACC_ID
      ,A.LN_SEQ
FROM LN83 A
INNER JOIN DUDE.LOAN B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
      AND A.LC_STA_LN83 = B.LC_STA_LN83 
;

CREATE TABLE NO_LN80_LON_DELTA AS
SELECT DISTINCT A.DF_SPE_ACC_ID
      ,A.LN_SEQ
FROM LN80_LON A
INNER JOIN DUDE.LOAN B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
      AND A.BIL_MTD = B.BIL_MTD 
	  AND A.PAID_AHEAD = B.PAID_AHEAD
; 

CREATE TABLE NO_LN20_DELTA AS
SELECT DISTINCT A.DF_SPE_ACC_ID
	,A.LN_SEQ
FROM LN20 A
INNER JOIN DUDE.LOAN B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
	  AND A.LC_STA_LON20 = B.LC_STA_LON20
;

CREATE TABLE NO_LN54_DELTA AS
SELECT DISTINCT A.DF_SPE_ACC_ID
	,A.LN_SEQ
FROM LN54 A
INNER JOIN DUDE.LOAN B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
	  AND A.LD_BBS_DSQ = B.LD_BBS_DSQ
	  AND A.LC_BBS_ELG = B.LC_BBS_ELG; 

CREATE TABLE NO_LN55_DELTA AS
SELECT DISTINCT A.DF_SPE_ACC_ID
	,A.LN_SEQ
FROM LN55 A
INNER JOIN DUDE.LOAN B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
      AND A.LN_LON_BBT_PAY = B.LN_LON_BBT_PAY
	  AND A.PN_BBT_PAY_ICV = B.PN_BBT_PAY_ICV
	  AND A.RIR_CT = B.RIR_CT
; 

CREATE TABLE NO_LN65_DELTA AS
SELECT DISTINCT A.DF_SPE_ACC_ID
	,A.LN_SEQ
FROM LN65 A
INNER JOIN DUDE.LOAN B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ
      AND A.LD_CRT_LON65 = B.LD_CRT_LON65
	  AND A.TYP_SCH_DIS = B.TYP_SCH_DIS
	  AND A.LD_SNT_RPD_DIS = B.LD_SNT_RPD_DIS
	  AND A.LN_RPS_TRM = B.LN_RPS_TRM
	  AND A.DUE_DAY = B.DUE_DAY
	  AND A.LA_RPS_ISL = B.LA_RPS_ISL
; 

CREATE TABLE NO_LN72_DELTA AS
SELECT DISTINCT A.DF_SPE_ACC_ID
	,A.LN_SEQ
FROM LN72 A
INNER JOIN DUDE.LOAN B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
      AND A.LR_ITR = B.LR_ITR
	  AND A.LR_INT_RDC_PGM_ORG = B.LR_INT_RDC_PGM_ORG; 

CREATE TABLE NO_SD10_DELTA AS
SELECT DISTINCT A.DF_SPE_ACC_ID
	,A.LN_SEQ
FROM SD10 A
INNER JOIN DUDE.LOAN B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
	  AND A.LD_SCL_SPR = B.LD_SCL_SPR
	  AND A.DOE_SCL_ENR_CUR = B.DOE_SCL_ENR_CUR; 

CREATE TABLE NO_DC01_DELTA AS
SELECT DISTINCT A.DF_SPE_ACC_ID
	,A.LN_SEQ
FROM DC01 A
INNER JOIN DUDE.LOAN B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
      AND A.LD_RHB = B.LD_RHB;

CREATE TABLE NO_LN16_DELTA AS
SELECT DISTINCT A.DF_SPE_ACC_ID
	,A.LN_SEQ
FROM LN16 A
INNER JOIN DUDE.LOAN B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ
	  AND A.LD_DLQ_OCC = B.LD_DLQ_OCC
	  AND A.LD_DLQ_MAX = B.LD_DLQ_MAX
	  AND A.LN_DLQ_MAX = B.LN_DLQ_MAX;  
QUIT;
/**************************************************
* IDENTIFY NEW OR CHANGED ROWS FOR LOAN TABLE 
***************************************************/
PROC SQL;
CREATE TABLE LN10_DELTAS AS
SELECT A.*
FROM LN10 A
LEFT JOIN NO_LN10_DELTA B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
WHERE B.DF_SPE_ACC_ID IS NULL
      AND B.LN_SEQ IS NULL;

CREATE TABLE LN83_DELTAS AS
SELECT A.*
FROM LN83 A
LEFT JOIN NO_LN83_DELTA B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
WHERE B.DF_SPE_ACC_ID IS NULL
      AND B.LN_SEQ IS NULL;


CREATE TABLE LN20_DELTAS AS
SELECT A.*
FROM LN20 A
LEFT JOIN NO_LN20_DELTA B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
WHERE B.DF_SPE_ACC_ID IS NULL
      AND B.LN_SEQ IS NULL;

CREATE TABLE LN54_DELTAS AS
SELECT A.*
FROM LN54 A
LEFT JOIN NO_LN54_DELTA B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
WHERE B.DF_SPE_ACC_ID IS NULL
      AND B.LN_SEQ IS NULL;

CREATE TABLE LN55_DELTAS AS
SELECT A.*
FROM LN55 A
LEFT JOIN NO_LN55_DELTA B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
WHERE B.DF_SPE_ACC_ID IS NULL
      AND B.LN_SEQ IS NULL;

CREATE TABLE LN80_LON_DELTAS AS
SELECT A.*
FROM LN80_LON A
LEFT JOIN NO_LN80_LON_DELTA B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
WHERE B.DF_SPE_ACC_ID IS NULL
      AND B.LN_SEQ IS NULL;

CREATE TABLE LN65_DELTAS AS
SELECT A.*
FROM LN65 A
LEFT JOIN NO_LN65_DELTA B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
WHERE B.DF_SPE_ACC_ID IS NULL
      AND B.LN_SEQ IS NULL;

CREATE TABLE LN72_DELTAS AS
SELECT A.*
FROM LN72 A
LEFT JOIN NO_LN72_DELTA B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
WHERE B.DF_SPE_ACC_ID IS NULL
      AND B.LN_SEQ IS NULL;

CREATE TABLE SD10_DELTAS AS
SELECT A.*
FROM SD10 A
LEFT JOIN NO_SD10_DELTA B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
WHERE B.DF_SPE_ACC_ID IS NULL
      AND B.LN_SEQ IS NULL;

CREATE TABLE DC01_DELTAS AS
SELECT A.*
FROM DC01 A
LEFT JOIN NO_DC01_DELTA B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
WHERE B.DF_SPE_ACC_ID IS NULL
      AND B.LN_SEQ IS NULL
;

CREATE TABLE LN16_DELTAS AS
SELECT A.*
FROM LN16 A
LEFT JOIN NO_LN16_DELTA B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.LN_SEQ = B.LN_SEQ 
WHERE B.DF_SPE_ACC_ID IS NULL
      AND B.LN_SEQ IS NULL
;
QUIT;
/***************************************************
* GET DISTINCT LIST OF LOANS AND ROWS FROM LOCAL DB
****************************************************/
DATA LOAN_DELTAS (KEEP=DF_SPE_ACC_ID LN_SEQ);
      SET LN10_DELTAS LN83_DELTAS LN54_DELTAS 
		LN55_DELTAS LN65_DELTAS	LN72_DELTAS LN80_LON_DELTAS 
		SD10_DELTAS LN20_DELTAS DC01_DELTAS	LN16_DELTAS
;
RUN;
PROC SORT DATA=LOAN_DELTAS NODUPKEY;
      BY DF_SPE_ACC_ID LN_SEQ;
RUN;
/***************************************************
* GET LOCAL DATA FOR LOANS WITH CHANGES
****************************************************/
PROC SQL;
CREATE TABLE LOCL_LOAN_DELTAS AS
      SELECT A.* 
      FROM DUDE.LOAN A
      INNER JOIN LOAN_DELTAS B
            ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
            AND A.LN_SEQ = B.LN_SEQ
		ORDER BY A.DF_SPE_ACC_ID, A.LN_SEQ

;
QUIT;
/***************************************************
INSERT ROWS TO BE DELETED INTO SQL SERVER DATABASE
****************************************************/
PROC SQL ;
INSERT INTO DUDE.LOAN_DELETE
      SELECT DF_SPE_ACC_ID
            ,LN_SEQ 
      FROM LOCL_LOAN_DELTAS; 
QUIT;
/******************************************************************
UPDATE PROCESSING FOR LOAN TABLES - ONE MACRO CALL PER DELTA TABLE
*******************************************************************/

%UPDATE_DATA(LOCL_LOAN_DELTAS,LN10_DELTAS,%STR(DF_SPE_ACC_ID LN_SEQ));
%UPDATE_DATA(LOCL_LOAN_DELTAS,LN83_DELTAS,%STR(DF_SPE_ACC_ID LN_SEQ));
%UPDATE_DATA(LOCL_LOAN_DELTAS,LN20_DELTAS,%STR(DF_SPE_ACC_ID LN_SEQ));
%UPDATE_DATA(LOCL_LOAN_DELTAS,LN54_DELTAS,%STR(DF_SPE_ACC_ID LN_SEQ));
%UPDATE_DATA(LOCL_LOAN_DELTAS,LN55_DELTAS,%STR(DF_SPE_ACC_ID LN_SEQ));
%UPDATE_DATA(LOCL_LOAN_DELTAS,LN65_DELTAS,%STR(DF_SPE_ACC_ID LN_SEQ));
%UPDATE_DATA(LOCL_LOAN_DELTAS,LN72_DELTAS,%STR(DF_SPE_ACC_ID LN_SEQ));
%UPDATE_DATA(LOCL_LOAN_DELTAS,LN80_LON_DELTAS,%STR(DF_SPE_ACC_ID LN_SEQ));
%UPDATE_DATA(LOCL_LOAN_DELTAS,SD10_DELTAS,%STR(DF_SPE_ACC_ID LN_SEQ));
%UPDATE_DATA(LOCL_LOAN_DELTAS,DC01_DELTAS,%STR(DF_SPE_ACC_ID LN_SEQ));
%UPDATE_DATA(LOCL_LOAN_DELTAS,LN16_DELTAS,%STR(DF_SPE_ACC_ID LN_SEQ));

/***************************************************
DELETE ROWS FROM LOCAL SQL SERVER DATABASE TABLE
****************************************************/
PROC SQL NOPRINT;
CONNECT TO ODBC AS MD (&MD);
SELECT COUNT(*) 
FROM CONNECTION TO MD (
      DELETE LOAN
      FROM LOAN A
      INNER JOIN LOAN_DELETE B
            ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
            AND A.LN_SEQ = B.LN_SEQ 
      );
DISCONNECT FROM MD;
QUIT;
/***************************************************
INSERT UPDATED/NEW ROWS INTO SQL SERVER DATABASE
****************************************************/
PROC SQL ;
INSERT INTO DUDE.LOAN
      SELECT *
		 
      FROM LOCL_LOAN_DELTAS; 
QUIT;
OPTIONS NOSOURCE;
%GOODBYE_NULL(LOAN,LA_CUR_PRI);
%GOODBYE_NULL(LOAN,LA_LON_AMT_GTR);
%GOODBYE_NULLCHAR(LOAN,LD_END_GRC_PRD);
%GOODBYE_NULLCHAR(LOAN,IC_LON_PGM);
%GOODBYE_NULLCHAR(LOAN,LD_LON_1_DSB);
%GOODBYE_NULLCHAR(LOAN,WC_DW_LON_STA);
%GOODBYE_NULLCHAR(LOAN,DW_LON_STA);
%GOODBYE_NULLCHAR(LOAN,WD_LON_RPD_SR);
%GOODBYE_NULLCHAR(LOAN,HEP);
%GOODBYE_NULL(LOAN,ACH_RATE);
%GOODBYE_NULL(LOAN,WA_TOT_BRI_OTS);
%GOODBYE_NULLCHAR(LOAN,RIR_INT);
%GOODBYE_NULLCHAR(LOAN,LC_STA_LN83);
%GOODBYE_NULLCHAR(LOAN,LD_BBS_DSQ);
%GOODBYE_NULLCHAR(LOAN,LC_BBS_ELG);
%GOODBYE_NULL(LOAN,LN_LON_BBT_PAY);
%GOODBYE_NULLCHAR(LOAN,LD_CRT_LON65);
%GOODBYE_NULLCHAR(LOAN,TYP_SCH_DIS);
%GOODBYE_NULLCHAR(LOAN,LD_SNT_RPD_DIS);
%GOODBYE_NULL(LOAN,LN_RPS_TRM);
%GOODBYE_NULL(LOAN,LR_ITR);
%GOODBYE_NULL(LOAN,LR_INT_RDC_PGM_ORG);
%GOODBYE_NULLCHAR(LOAN,LD_SCL_SPR);
%GOODBYE_NULLCHAR(LOAN,DOE_SCL_ENR_CUR);
%GOODBYE_NULLCHAR(LOAN,LC_BIL_MTD);
%GOODBYE_NULLCHAR(LOAN,BIL_MTD);
%GOODBYE_NULL(LOAN,PN_BBT_PAY_ICV);
%GOODBYE_NULLCHAR(LOAN,RIR_CT);
%GOODBYE_NULLCHAR(LOAN,RIR_TYP);
%GOODBYE_NULLCHAR(LOAN,PAID_AHEAD);
%GOODBYE_NULLCHAR(LOAN,ACH_ELIG);
%GOODBYE_NULLCHAR(LOAN,LD_RHB);
%GOODBYE_NULLCHAR(LOAN,LC_STA_LON20);
%GOODBYE_NULLCHAR(LOAN,DUE_DAY);
%GOODBYE_NULL(LOAN,LA_RPS_ISL);
%GOODBYE_NULLCHAR(LOAN,LD_PIF_RPT);
%GOODBYE_NULL(LOAN,LN_DLQ_MAX);
%GOODBYE_NULLCHAR(LOAN,LD_DLQ_OCC);
%GOODBYE_NULLCHAR(LOAN,LD_DLQ_MAX);
/***************************************************
CLEAN UP DELETE DATABASE TABLE
****************************************************/
PROC SQL NOPRINT;
CONNECT TO ODBC AS MD (&MD);
SELECT COUNT(*) 
FROM CONNECTION TO MD (
      DELETE 
      FROM LOAN_DELETE 
      );
DISCONNECT FROM MD;
QUIT;
OPTIONS SOURCE;
PROC SQL NOPRINT;
CONNECT TO ODBC AS MD (&MD);
SELECT COUNT(*) 
FROM CONNECTION TO MD (
     UPDATE LOAN
	 	SET BIL_MTD = ''
			,LC_BIL_MTD = ''
			,PAID_AHEAD = ''
			,ln_dlq_max = 0
			,ld_dlq_occ = ''
			,LD_DLQ_MAX = ''
		WHERE LA_CUR_PRI = 0);
DISCONNECT FROM MD;
QUIT;
