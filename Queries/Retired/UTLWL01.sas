/*DAILY DISBURSEMENT REPORTS, LENDERS*/
LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;
%LET RPTLIB = %SYSGET(reportdir);
%LET TBLLIB = /sas/whse/progrevw;
/*%LET RPTLIB = T:/SAS;*/
/*%LET TBLLIB = Q:\Process Automation\TabSAS;*/
FILENAME REPORTZ "&RPTLIB/ULWL01.LWL01RZ";
FILENAME REPORT2 "&RPTLIB/ULWL01.LWL01R2";
FILENAME REPORT3 "&RPTLIB/ULWL01.LWL01R3";
FILENAME REPORT4 "&RPTLIB/ULWL01.LWL01R4";
FILENAME REPORT5 "&RPTLIB/ULWL01.LWL01R5";
FILENAME REPORT6 "&RPTLIB/ULWL01.LWL01R6";
FILENAME REPORT7 "&RPTLIB/ULWL01.LWL01R7";
FILENAME REPORT8 "&RPTLIB/ULWL01.LWL01R8";
FILENAME REPORT9 "&RPTLIB/ULWL01.LWL01R9";
FILENAME REPORT11 "&RPTLIB/ULWL01.LWL01R11";
FILENAME REPORT12 "&RPTLIB/ULWL01.LWL01R12";
FILENAME REPORT13 "&RPTLIB/ULWL01.LWL01R13";
FILENAME REPORT14 "&RPTLIB/ULWL01.LWL01R14";
FILENAME REPORT15 "&RPTLIB/ULWL01.LWL01R15";
FILENAME REPORT16 "&RPTLIB/ULWL01.LWL01R16";
FILENAME REPORT17 "&RPTLIB/ULWL01.LWL01R17";
FILENAME REPORT18 "&RPTLIB/ULWL01.LWL01R18";
FILENAME REPORT19 "&RPTLIB/ULWL01.LWL01R19";
FILENAME REPORT20 "&RPTLIB/ULWL01.LWL01R20";
FILENAME REPORT21 "&RPTLIB/ULWL01.LWL01R21";
FILENAME REPORT22 "&RPTLIB/ULWL01.LWL01R22";
FILENAME REPORT23 "&RPTLIB/ULWL01.LWL01R23";
FILENAME REPORT24 "&RPTLIB/ULWL01.LWL01R24";
FILENAME REPORT25 "&RPTLIB/ULWL01.LWL01R25";
FILENAME REPORT26 "&RPTLIB/ULWL01.LWL01R26";
FILENAME REPORT27 "&RPTLIB/ULWL01.LWL01R27";
FILENAME REPORT28 "&RPTLIB/ULWL01.LWL01R28";
FILENAME REPORT29 "&RPTLIB/ULWL01.LWL01R29";
FILENAME REPORT30 "&RPTLIB/ULWL01.LWL01R30";
FILENAME REPORT31 "&RPTLIB/ULWL01.LWL01R31";
FILENAME REPORT32 "&RPTLIB/ULWL01.LWL01R32";
FILENAME REPORT33 "&RPTLIB/ULWL01.LWL01R33";
FILENAME REPORT34 "&RPTLIB/ULWL01.LWL01R34";
/*INPUT LOAN TYPES FOR PRIVATE AND FFEL LOANS*/
DATA LOAN_TYPES;
	FORMAT LN_TYP LN_PGM $50.;
	INFILE "&TBLLIB/GENR_REF_LoanTypes.txt" DLM=',' MISSOVER DSD;
	INFORMAT LN_TYP LN_PGM $50.;
	INPUT LN_TYP LN_PGM ;
	LN_PGM = UPCASE(LN_PGM);
RUN;
/*CREATE MACRO VARIALBE LISTS OF LOAN PROGRAMS(FFEL AND PRIVATE LOANS)*/
PROC SQL NOPRINT;
	SELECT "'"||TRIM(LN_TYP)||"'" 
		INTO :FFELP_LIST SEPARATED BY "," /*FFEL LOAN LIST*/
	FROM LOAN_TYPES
	WHERE LN_PGM = 'FFEL';

	SELECT "'"||TRIM(LN_TYP)||"'" 
		INTO :PRIVATE_LIST SEPARATED BY "," /*PRIVATE LOAN LIST*/
	FROM LOAN_TYPES
	WHERE LN_PGM ^= 'FFEL';
QUIT;
%PUT &FFELP_LIST;
%PUT &PRIVATE_LIST;
DATA _NULL_;
	CALL SYMPUT('ROSTDT',"'"||PUT(INTNX('DAY',TODAY(),-1,'beginning'), MMDDYY10.)||"'");
	CALL SYMPUT('DSBDAT', PUT(INTNX('DAY',TODAY(),0,'beginning'), MMDDYY10.));
	CALL SYMPUT('LNDRFEECHGDT', "'"||'10/01/2007'||"'");
RUN;
/*%SYSLPUT ROSTDT = &ROSTDT;*/
/*%SYSLPUT LNDRFEECHGDT = &LNDRFEECHGDT;*/
/*LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=work;*/
/*RSUBMIT;*/
%macro sqlcheck ;
  %if  &sqlxrc ne 0  %then  %do  ;
    data _null_  ;
            file reportz notitles  ;
            put @01 " ********************************************************************* "
              / @01 " ****  The SQL code above has experienced an error.               **** "
              / @01 " ****  The SAS should be reviewed.                                **** "       
              / @01 " ********************************************************************* "
              / @01 " ****  The SQL error code is  &sqlxrc  and the SQL error message  **** "
              / @01 " ****  &sqlxmsg   **** "
              / @01 " ********************************************************************* "
            ;
         run  ;
  %end  ;
%mend  ;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE DADISB AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT INTEGER(A.BF_SSN) AS BF_SSN,
	A.BF_SSN AS BF_SSNCHAR,
    COALESCE(A.LA_DSB,0) - COALESCE(A.LA_DSB_CAN,0) AS DISBAMT,
    D.LA_DSB_FEE 		AS OFEE,
	COALESCE(GTY.LA_DSB_FEE,0) AS GFEE,
    A.LN_LON_DSB_SEQ,
    CASE WHEN A.LC_LDR_DSB_MDM = '1' THEN 'CHK'
		 WHEN A.LC_LDR_DSB_MDM = '3' THEN 'EFT'
		 WHEN A.LC_LDR_DSB_MDM = '7' THEN 'ELM'
		 WHEN A.LC_LDR_DSB_MDM = '8' THEN 'M CHK'
		 ELSE ''
	END AS LC_LDR_DSB_MDM,
    A.IC_LON_PGM,
    B.AF_DOE_SCL,
    B.AF_DOE_LDR, 
	CASE 
		WHEN B.AF_LDR_BND_ISS = '' THEN 'NOBND'
		ELSE B.AF_LDR_BND_ISS
	END AS AF_LDR_BND_ISS
	,E.IM_LDR_SHO
	,E.IM_LDR_FUL
	,A.LC_DSB_TYP
	,A.LC_STA_LON15
	,A.LA_DSB_ORG_CHK_EFT
	,CASE 
		WHEN D.LA_DSB_FEE = 0 THEN 'L'
		ELSE 'B'
	 END					AS PAYEE	
	,B.AF_APL_ID
	,B.AF_RGL_CAT_LP20
	,F.IM_SCL_FUL	
	,DEM.CBF_SSN
	,DEM.BNAME
	,DEM.LF_STU_SSN
	,DEM.SNAME
	,DEM.SVAR3
	,DEM.DISB_DX_STR_ADR_1
	,DEM.DISB_DX_STR_ADR_2
	,DEM.DISB_DX_STR_ADR_3
	,DEM.DISB_DM_CT
	,DEM.DISB_DC_DOM_ST
	,DEM.DISB_DF_ZIP_CDE
	,DEM.DISB_DM_FGN_ST
	,DEM.DISB_DM_FGN_CNY
	,DEM.DISB_DI_VLD_ADR
	,DEM.LEGL_DX_STR_ADR_1
	,DEM.LEGL_DX_STR_ADR_2
	,DEM.LEGL_DX_STR_ADR_3
	,DEM.LEGL_DM_CT
	,DEM.LEGL_DC_DOM_ST
	,DEM.LEGL_DF_ZIP_CDE
	,DEM.LEGL_DM_FGN_ST
	,DEM.LEGL_DM_FGN_CNY
	,B.AF_LDR_BND_ISS AS BOND_ID
	,G.AF_ORG_APL_OPS_LDR AS OL_LDR_ID
	,H.IM_IST_SHO AS OL_LDR_NM
	,A2.LD_DSB AS FRSTDISBDT
	,A.LD_DSB
	,A.LN_SEQ
	,I.LF_LON_CUR_OWN
	,I.IF_BND_ISS
	,A.LD_DSB_ROS_PRT

	,B.AN_SEQ
	,B.AF_CNL||AF_CNL_SFX AS CLUID

FROM OLWHRM1.LN15_DSB A
INNER JOIN OLWHRM1.AP03_MASTER_APL B
	ON A.AF_APL_ID = B.AF_APL_ID
INNER JOIN OLWHRM1.LN18_DSB_FEE D
    ON D.BF_SSN = A.BF_SSN
    AND D.LN_BR_DSB_SEQ = A.LN_BR_DSB_SEQ
    AND D.LC_DSB_FEE = '02'	/*ORG FEE*/
LEFT OUTER JOIN OLWHRM1.LN18_DSB_FEE GTY
    ON GTY.BF_SSN = A.BF_SSN
    AND GTY.LN_BR_DSB_SEQ = A.LN_BR_DSB_SEQ
    AND GTY.LC_DSB_FEE = '21' /*GTY FEE*/
INNER JOIN OLWHRM1.LR10_LDR_DMO E
	ON E.IF_DOE_LDR = B.AF_DOE_LDR 
LEFT JOIN (
			SELECT BF_SSN, LN_SEQ, MAX(LD_DSB) AS LD_DSB	
			FROM OLWHRM1.LN15_DSB
			WHERE LD_DSB < &LNDRFEECHGDT 
			AND LD_DSB_ROS_PRT IS NOT NULL
			GROUP BY BF_SSN
				,LN_SEQ
			) A2
	ON A.BF_SSN = A2.BF_SSN 
	AND A.LN_SEQ = A2.LN_SEQ
LEFT OUTER JOIN OLWHRM1.SC10_SCH_DMO F
	ON B.AF_DOE_SCL = F.IF_DOE_SCL
LEFT OUTER JOIN OLWHRM1.GA01_APP G
	ON B.AF_CNL = G.AF_APL_ID 
LEFT OUTER JOIN OLWHRM1.IN01_LGS_IDM_MST H
	ON G.AF_ORG_APL_OPS_LDR = H.IF_IST
LEFT OUTER JOIN (
	SELECT JL1.BF_SSN
		,JL1.LN_SEQ
		,JL1.LF_LON_CUR_OWN
		,JL2.IF_BND_ISS
	FROM OLWHRM1.LN10_LON JL1
	INNER JOIN OLWHRM1.LN35_LON_OWN JL2
		ON JL1.BF_SSN = JL2.BF_SSN
		AND JL1.LN_SEQ = JL2.LN_SEQ
	WHERE JL2.LD_OWN_EFF_END IS NULL
		AND JL2.LC_STA_LON35 = 'A'
	) I
	ON A.BF_SSN = I.BF_SSN
	AND A.LN_SEQ = I.LN_SEQ
LEFT OUTER JOIN (
	SELECT DISTINCT  B.BF_SSN AS CBF_SSN
		,RTRIM(BWR_DEM.DM_PRS_1)||' '||BWR_DEM.DM_PRS_LST AS BNAME
		,A.LF_STU_SSN AS LF_STU_SSN
		,RTRIM(STU_DEM.DM_PRS_1)||' '||STU_DEM.DM_PRS_LST AS SNAME
		,BWR_DEM.DM_PRS_LST AS SVAR3
		,DISB_ADD.DX_STR_ADR_1 	AS DISB_DX_STR_ADR_1
		,DISB_ADD.DX_STR_ADR_2 	AS DISB_DX_STR_ADR_2
		,DISB_ADD.DX_STR_ADR_3 	AS DISB_DX_STR_ADR_3
		,DISB_ADD.DM_CT 		AS DISB_DM_CT
		,DISB_ADD.DC_DOM_ST 	AS DISB_DC_DOM_ST
		,DISB_ADD.DF_ZIP_CDE 	AS DISB_DF_ZIP_CDE
		,DISB_ADD.DM_FGN_ST 	AS DISB_DM_FGN_ST
		,DISB_ADD.DM_FGN_CNY 	AS DISB_DM_FGN_CNY
		,DISB_ADD.DI_VLD_ADR 	AS DISB_DI_VLD_ADR
		,LEGL_ADD.DX_STR_ADR_1 	AS LEGL_DX_STR_ADR_1
		,LEGL_ADD.DX_STR_ADR_2 	AS LEGL_DX_STR_ADR_2
		,LEGL_ADD.DX_STR_ADR_3 	AS LEGL_DX_STR_ADR_3
		,LEGL_ADD.DM_CT 		AS LEGL_DM_CT
		,LEGL_ADD.DC_DOM_ST 	AS LEGL_DC_DOM_ST
		,LEGL_ADD.DF_ZIP_CDE 	AS LEGL_DF_ZIP_CDE
		,LEGL_ADD.DM_FGN_ST 	AS LEGL_DM_FGN_ST
		,LEGL_ADD.DM_FGN_CNY 	AS LEGL_DM_FGN_CNY
		,B.LN_BR_DSB_SEQ
	FROM OLWHRM1.LN15_DSB B
	INNER JOIN OLWHRM1.AP03_MASTER_APL A
		ON B.AF_APL_ID = A.AF_APL_ID
	INNER JOIN OLWHRM1.PD10_PRS_NME BWR_DEM
		ON A.BF_SSN = BWR_DEM.DF_PRS_ID
	INNER JOIN OLWHRM1.PD10_PRS_NME STU_DEM	
		ON A.LF_STU_SSN = STU_DEM.DF_PRS_ID
	LEFT OUTER JOIN OLWHRM1.PD30_PRS_ADR DISB_ADD
		ON A.BF_SSN = DISB_ADD.DF_PRS_ID
		AND DISB_ADD.DC_ADR = 'D'
	LEFT OUTER JOIN OLWHRM1.PD30_PRS_ADR LEGL_ADD
		ON A.BF_SSN = LEGL_ADD.DF_PRS_ID
		AND LEGL_ADD.DC_ADR = 'L'
	WHERE B.IC_LON_PGM IN ('PLUS','PLUSGB')
	) DEM 
	ON A.BF_SSN = DEM.CBF_SSN
	AND A.LN_BR_DSB_SEQ = DEM.LN_BR_DSB_SEQ
WHERE A.LC_STA_LON15 IN ('1','3')
AND A.LC_DSB_TYP IN ('2','1')
AND A.LD_DSB_ROS_PRT = &ROSTDT
AND (A.LA_DSB_CAN IS NULL
    OR A.LA_DSB_CAN <> A.LA_DSB)
AND A.LC_LDR_DSB_MDM NOT IN ('M','E','F')

ORDER BY B.AF_DOE_LDR, A.IC_LON_PGM, A.BF_SSN 
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
DATA DADISB (DROP=DISB_DX_STR_ADR_1 DISB_DX_STR_ADR_2 DISB_DX_STR_ADR_3 DISB_DM_CT DISB_DC_DOM_ST
	DISB_DF_ZIP_CDE DISB_DM_FGN_ST DISB_DM_FGN_CNY DISB_DI_VLD_ADR LEGL_DX_STR_ADR_1
	LEGL_DX_STR_ADR_2 LEGL_DX_STR_ADR_3 LEGL_DM_CT LEGL_DC_DOM_ST LEGL_DF_ZIP_CDE
	LEGL_DM_FGN_ST LEGL_DM_FGN_CNY);
SET DADISB;
DO;
	NETDISB = LA_DSB_ORG_CHK_EFT;
	IF AF_DOE_LDR = '813760UT' THEN AF_DOE_LDR = '813760';
END;
IF DISB_DI_VLD_ADR = 'Y' THEN DO;
	DX_STR_ADR_1 = DISB_DX_STR_ADR_1;
	DX_STR_ADR_2 = DISB_DX_STR_ADR_2;
	DX_STR_ADR_3 = DISB_DX_STR_ADR_3;
	DM_CT = DISB_DM_CT;
	DC_DOM_ST = DISB_DC_DOM_ST;
	DF_ZIP_CDE = DISB_DF_ZIP_CDE;
	DM_FGN_ST = DISB_DM_FGN_ST;
	DM_FGN_CNY = DISB_DM_FGN_CNY;
END;
ELSE DO;
	DX_STR_ADR_1 = LEGL_DX_STR_ADR_1;
	DX_STR_ADR_2 = LEGL_DX_STR_ADR_2;
	DX_STR_ADR_3 = LEGL_DX_STR_ADR_3;
	DM_CT = LEGL_DM_CT;
	DC_DOM_ST = LEGL_DC_DOM_ST;
	DF_ZIP_CDE = LEGL_DF_ZIP_CDE;
	DM_FGN_ST = LEGL_DM_FGN_ST;
	DM_FGN_CNY = LEGL_DM_FGN_CNY;
END;
RUN;
%put  sqlxrc= >>> &sqlxrc <<< ||| sqlxmsg= >>> &sqlxmsg >>> ;  ** includes error messages to SAS log  ;
%sqlcheck;
quit;
/*ENDRSUBMIT;*/
/*DATA DADISB; */
/*	SET WORKLOCL.DADISB; */
/*RUN;*/
/*CALCULATE LENDER FEES, FUNDING AMOUNT, & UHEAA ORIGINATION FEE*/
DATA DADISB;
	SET DADISB;
	LENGTH LN_PGM $5. IM_LDR_SHO_R233 $20.;

	/*LENDER FEES*/
	IF FRSTDISBDT = . THEN DO; 
		LNDRFEE = DISBAMT * .01;
		LNDRPERCENT = '1%';
	END;
	ELSE DO;
		LNDRFEE = DISBAMT * .005;
		LNDRPERCENT = '.5%';
	END;
 
	/*FUNDING AMOUNT & UHEAA ORIGINATION FEE*/
	IF AF_RGL_CAT_LP20 = '2008020' AND AF_DOE_LDR ^= '828476' THEN DO;
		FUND_AMT = ROUND(NETDISB * .99,.01);
		UOFE_AMT = ROUND(NETDISB - FUND_AMT,.01);
	END;
	ELSE DO; 
		FUND_AMT = NETDISB;
		UOFE_AMT = 0;
	END;

	/*Change the SSNs in this report to obscure all but the last four characters.*/
	BF_SSN_OBSCURED = 'XXX-XX-' || SUBSTR(BF_SSNCHAR, 6,4);
	LF_STU_SSN_OBSCURED = 'XXX-XX-' || SUBSTR(LF_STU_SSN, 6,4);

	/*MAKE LOAN PROGRAM ASSIGNMENT*/
	IF IC_LON_PGM IN (&FFELP_LIST) THEN
		LN_PGM = 'FFELP';
	ELSE 
		LN_PGM = 'ALT';
	
/*	ACCOUNT FOR UBS LOANS*/
	IF INDEX(AF_LDR_BND_ISS,'UBS') > 0 THEN DO;
		IM_LDR_SHO_R233 = 'UBS';
		FUND_AMT = DISBAMT;
	END;
	ELSE 
		IM_LDR_SHO_R233 = IM_LDR_SHO;
RUN;

PROC SQL;
CREATE TABLE PLDEM AS 
SELECT DISTINCT A.AF_DOE_SCL 
	,A.IM_SCL_FUL
	,A.SVAR3
	,A.CBF_SSN AS BF_SSN
	,A.BF_SSN_OBSCURED
	,A.LF_STU_SSN_OBSCURED
	,A.BNAME 
	,A.LF_STU_SSN 
	,A.SNAME 
	,A.DX_STR_ADR_1 
	,A.DX_STR_ADR_2 
	,A.DX_STR_ADR_3 
	,A.DM_CT 
	,A.DC_DOM_ST 
	,A.DF_ZIP_CDE 
	,A.DM_FGN_ST 
	,A.DM_FGN_CNY
	,A.LD_DSB
FROM DADISB A
WHERE IC_LON_PGM IN ('PLUS','PLUSGB')
	AND LC_LDR_DSB_MDM = 'CHK'
;
QUIT;	
DATA DADISB;
SET DADISB;
LENGTH LOC $ 60.;
LENGTH LOCPERCENT $ 4.;
LENGTH FEECODE $ 3.;
IF OFEE = 0 AND 
	AF_RGL_CAT_LP20 <= '1999030' AND 
	IC_LON_PGM NOT IN ('PLUS','PLUSGB') THEN DO;
		LA_DSB_FEE_LDR = ROUND(DISBAMT * .03,.01);
		LOC = 'LOANS WITH ZERO PERCENT ORIGINATION FEE - 3% ED';
		LOCPERCENT = '3%';
		FEECODE = 'ZF';
END;
ELSE IF OFEE = 0 AND 
	AF_RGL_CAT_LP20 = '2006020' AND 
	IC_LON_PGM NOT IN ('PLUS','PLUSGB') THEN DO;
		LA_DSB_FEE_LDR = ROUND(DISBAMT * .02,.01);
		LOC = 'LOANS WITH ZERO PERCENT ORIGINATION FEE - 2% ED';
		LOCPERCENT = '2%';
		FEECODE = 'ZF';
END;
ELSE IF OFEE = 0 AND 
	AF_RGL_CAT_LP20 = '2007020' AND 
	IC_LON_PGM NOT IN ('PLUS','PLUSGB') THEN DO;
		LA_DSB_FEE_LDR = ROUND(DISBAMT * .015,.01);
		LOC = 'LOANS WITH ZERO PERCENT ORIGINATION FEE - 1.5% ED';
		LOCPERCENT = '1.5%';
		FEECODE = 'ZF';
END;
ELSE IF (OFEE ^= 0 AND AF_RGL_CAT_LP20 <= '1999030' AND IC_LON_PGM NOT IN ('PLUS','PLUSGB')) 
	OR (IC_LON_PGM IN ('PLUS','PLUSGB') AND AF_RGL_CAT_LP20 ^= '2009020') THEN DO;
		LA_DSB_FEE_LDR = 0;
		LOC = 'LOANS WITH ORIGINATION FEE - 3% ED';
		LOCPERCENT = '3%';
		FEECODE = 'OF';
END;
ELSE IF OFEE ^= 0 AND 
	AF_RGL_CAT_LP20 = '2006020' AND	IC_LON_PGM NOT IN ('PLUS','PLUSGB') THEN DO;
		LA_DSB_FEE_LDR = 0;
		LOC = 'LOANS WITH ORIGINATION FEE - 2% ED';
		LOCPERCENT = '2%';
		FEECODE = 'OF';
END;
ELSE IF OFEE ^= 0 AND 
	AF_RGL_CAT_LP20 = '2007020' AND	IC_LON_PGM NOT IN ('PLUS','PLUSGB') THEN DO;
		LA_DSB_FEE_LDR = 0;
		LOC = 'LOANS WITH ORIGINATION FEE - 1.5% ED';
		LOCPERCENT = '1.5%';
		FEECODE = 'OF';
END;
ELSE IF OFEE = 0 AND 
	AF_RGL_CAT_LP20 = '2008020' AND	IC_LON_PGM NOT IN ('PLUS','PLUSGB') THEN DO;
		LA_DSB_FEE_LDR = 0;
		LOC = 'LOANS WITH UHEAA ORIGINATION FEE - 1% ED';
		LOCPERCENT = '1%';
		FEECODE = 'UF';
END;
ELSE IF OFEE > 0 AND AF_RGL_CAT_LP20 = '2009020' THEN DO;
		IF IC_LON_PGM NOT IN ('PLUS','PLUSGB') THEN DO;
			LA_DSB_FEE_LDR = 0;
			LOCPERCENT = '0.5%';
			IF GFEE > 0 THEN DO;
				LOC = 'LOANS WITH ORIG/GUAR FEE - 0.5% ED / 1%';
				FEECODE = 'OGF';
			END;
			ELSE DO;
				LOC = 'LOANS WITH ORIGINATION FEE - 0.5% ED';
				FEECODE = 'OF';
			END;
		END;
		ELSE DO;
			LA_DSB_FEE_LDR = 0;
			LOCPERCENT = '3%';
			IF GFEE > 0 THEN DO;
				LOC = 'LOANS WITH ORIG/GUAR FEE - 3% ED / 1%';
				FEECODE = 'OGF';
			END;
			ELSE DO;
				LOC = 'LOANS WITH ORIGINATION FEE - 3% ED';
				FEECODE = 'OF';
			END;
		END;
END;
RUN;
PROC SQL;
	CREATE TABLE DASUM AS
		SELECT AF_DOE_LDR
			,IM_LDR_FUL
			,IM_LDR_SHO_R233
			,LN_PGM
			,SUM(DISBAMT) AS DISBAMT
			,SUM(NETDISB) AS NETDISB
			,SUM(COALESCE(FUND_AMT,0)) AS FUND_AMT
			,SUM(COALESCE(UOFE_AMT,0)) AS UOFE_AMT
			,SUM(COALESCE(GFEE,0)) AS GFEE_AMT
			,SUM(LNDRFEE) AS LNDRFEE
			,SUM(OFEE) AS OFEE
/*			,MAX(LD_DSB) AS LD_DSB*/
		FROM DADISB
		GROUP BY AF_DOE_LDR, IM_LDR_FUL, IM_LDR_SHO_R233, LN_PGM
		ORDER BY LN_PGM, IM_LDR_SHO_R233;
QUIT;
/*DATA FOR R29*/
PROC SQL;
	CREATE TABLE SDDS AS 
	SELECT LC_LDR_DSB_MDM
		,AF_DOE_SCL
		,IM_SCL_FUL
		,AF_DOE_LDR
		,IC_LON_PGM
		,COUNT(*) AS DISBC
		,SUM(DISBAMT) AS DISBAMT
		,SUM(NETDISB) AS NETDSIB
	FROM DADISB
	GROUP BY LC_LDR_DSB_MDM
		,AF_DOE_SCL
		,IM_SCL_FUL
		,AF_DOE_LDR
		,IC_LON_PGM
	ORDER BY IM_SCL_FUL
		,AF_DOE_SCL
		,LC_LDR_DSB_MDM
		,IC_LON_PGM
	;
QUIT;
/*DATA FOR R30*/
PROC SQL;
	CREATE TABLE EDBS AS 
	SELECT AF_DOE_SCL
		,IM_SCL_FUL
		,BF_SSNCHAR
		,LN_SEQ
		,LN_LON_DSB_SEQ
		,AF_DOE_LDR
		,DISBAMT
		,NETDISB
		,LD_DSB_ROS_PRT
		,LD_DSB
		,1 AS DSB_CT
	FROM DADISB 
	WHERE LC_LDR_DSB_MDM = 'ELM'
	ORDER BY IM_SCL_FUL
		,AF_DOE_SCL
		,AF_DOE_LDR
		,BF_SSN_OBSCURED
		,LN_SEQ
	;
QUIT;

/*Give DSBDAT a bogus value, which we'll check for later.*/
DATA _NULL_;
	CALL SYMPUT('R2_DT', '0');
RUN;
/*Set the DSBDAT variable to the value of LD_DSB if LC_LDR_DSB_MDM is EFT.*/
DATA _NULL_;
	SET DADISB;
	IF LC_LDR_DSB_MDM = 'EFT' THEN CALL SYMPUT('R2_DT', PUT(LD_DSB, MMDDYY10.));
RUN;
/*Check the DSBDAT variable and assign it a value if it's still bogus.*/
DATA _NULL_; SET DADISB;
	IF &R2_DT = '0' THEN CALL SYMPUT('R2_DT', PUT(LD_DSB, MMDDYY10.));
RUN;
/*If the dataset is empty, then DSBDAT will still be bogus, so default it to today's date.*/
DATA _NULL_;
	IF &R2_DT = '0' THEN CALL SYMPUT('R2_DT', PUT(INTNX('DAY',TODAY(),0,'beginning'), MMDDYY10.));
RUN;

PROC PRINTTO PRINT=REPORT2 NEW;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=132 CENTER NODATE NUMBER PAGENO=1;
/*FFELP LOAN SECTION - R2*/
PROC PRINT NOOBS SPLIT='/' DATA=DASUM WIDTH=UNIFORM WIDTH=MIN;
	WHERE LN_PGM = "FFELP";
	TITLE 'DAILY DISBURSEMENT SUMMARY';
	TITLE2 "DISBURSEMENT DATE : &R2_DT";
	TITLE3 "FFELP LOANS";
	FOOTNOTE1  	"This document may contain borrowers' sensitive information that UHEAA has pledged to protect.";
	FOOTNOTE2	"Please take appropriate precautions to safeguard this information.";
	FOOTNOTE3	;
	FOOTNOTE4 "JOB = UTLWL01     REPORT = ULWL01.LWL01R2";
	FORMAT DISBAMT NETDISB FUND_AMT UOFE_AMT GFEE_AMT LNDRFEE OFEE DOLLAR15.2;
	VAR IM_LDR_SHO_R233 AF_DOE_LDR DISBAMT NETDISB FUND_AMT LNDRFEE UOFE_AMT OFEE GFEE_AMT;
	LABEL AF_DOE_LDR = "LENDER ID" 
		IM_LDR_SHO_R233 = "LENDER NAME"
		DISBAMT = "TOTAL GROSS DISBURSEMENT AMOUNT"
		NETDISB = "TOTAL NET DISBURSEMENT AMOUNT"
		FUND_AMT = "TOTAL FUNDING AMOUNT"
		LNDRFEE = "TOTAL LENDER FEE AMOUNT"
		UOFE_AMT = "TOTAL UHEAA ORIGINATION FEE AMOUNT"
		OFEE = "TOTAL BORROWER ORIGINATION FEE AMOUNT"
		GFEE_AMT = "TOTAL GUARANTEE FEE AMOUNT";
	SUM DISBAMT NETDISB FUND_AMT LNDRFEE UOFE_AMT OFEE GFEE_AMT;
RUN;
/*ALT LOAN SECTION - R2*/
PROC PRINT NOOBS SPLIT='/' DATA=DASUM WIDTH=UNIFORM WIDTH=MIN;
	WHERE LN_PGM = "ALT";
	TITLE 'DAILY DISBURSEMENT SUMMARY';
	TITLE2 "DISBURSEMENT DATE : &R2_DT";
	TITLE3 "ALT LOANS";
	FOOTNOTE1  	"This document may contain borrowers' sensitive information that UHEAA has pledged to protect.";
	FOOTNOTE2	"Please take appropriate precautions to safeguard this information.";
	FOOTNOTE3	;
	FOOTNOTE4 "JOB = UTLWL01     REPORT = ULWL01.LWL01R2";
	FORMAT DISBAMT FUND_AMT DOLLAR18.2;
	VAR IM_LDR_SHO_R233 AF_DOE_LDR DISBAMT FUND_AMT;
	LABEL AF_DOE_LDR = "LENDER ID" 
		IM_LDR_SHO_R233 = "LENDER NAME"
		DISBAMT = "TOTAL GROSS DISBURSEMENT AMOUNT"
		FUND_AMT = "TOTAL FUNDING AMOUNT";
	SUM DISBAMT FUND_AMT;
RUN;
/*FFELP AND ALT LOAN SECTION - R2*/
PROC SORT DATA=DASUM;
	BY IM_LDR_FUL AF_DOE_LDR;
RUN;
PROC REPORT DATA=DASUM NOWD HEADSKIP SPLIT='/';
	TITLE3 "ALL LOANS";
	COLUMN IM_LDR_SHO_R233 AF_DOE_LDR DISBAMT NETDISB FUND_AMT;
	DEFINE IM_LDR_SHO_R233 / GROUP 'LENDER NAME';
	DEFINE AF_DOE_LDR / GROUP 'LENDER ID';
	DEFINE DISBAMT /  ANALYSIS 'GROSS/DISB/AMOUNT' SUM FORMAT=DOLLAR18.2;
	DEFINE NETDISB /  ANALYSIS 'NET/DISB/AMOUNT' SUM FORMAT=DOLLAR18.2;
	DEFINE FUND_AMT / ANALYSIS 'FUNDING/AMOUNT' SUM FORMAT=DOLLAR18.2;
	COMPUTE AFTER;
		LINE @44 68*'=';
		LINE @54 DISBAMT.SUM DOLLAR18.2 @74 NETDISB.SUM DOLLAR18.2 @94 FUND_AMT.SUM DOLLAR18.2;
	ENDCOMP;
RUN;
PROC PRINTTO;
RUN;

PROC SORT DATA=PLDEM;
BY IM_SCL_FUL AF_DOE_SCL SVAR3;
RUN; 
/*Set the DSBDAT variable to the LD_DSB value. (No need to check for EFT, since this dataset is all CHK.)*/
DATA _NULL_; 
	SET PLDEM;
	CALL SYMPUT('DSBDAT', PUT(LD_DSB, MMDDYY10.));
RUN;

PROC PRINTTO PRINT=REPORT25 NEW;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=132 NOBYLINE NODATE CENTER PAGENO=1;
TITLE '#BYVAL1: #BYVAL2';
TITLE2 'DEMOGRAPHIC INFORMATION FOR PLUS / PLUSGB DISBURSEMENT';
TITLE3 "DISBURSEMENT DATE : &DSBDAT";
FOOTNOTE1  	"This document may contain borrowers' sensitive information that UHEAA has pledged to protect.";
FOOTNOTE2	"Please take appropriate precautions to safeguard this information.";
FOOTNOTE3	;
FOOTNOTE4 "JOB = UTLWL01     REPORT = ULWL01.LWL01R25";
PROC REPORT NOWD DATA=PLDEM SPLIT='\' SPACING=2 HEADSKIP;
BY IM_SCL_FUL AF_DOE_SCL;
COLUMN IM_SCL_FUL AF_DOE_SCL SVAR3 BF_SSN_OBSCURED BNAME LF_STU_SSN_OBSCURED SNAME DX_STR_ADR_1 DX_STR_ADR_2 DX_STR_ADR_3 
DM_CT DC_DOM_ST DF_ZIP_CDE DM_FGN_ST DM_FGN_CNY BLOCK;
DEFINE IM_SCL_FUL / GROUP NOPRINT;
DEFINE AF_DOE_SCL / GROUP NOPRINT;
DEFINE SVAR3 / GROUP NOPRINT;
DEFINE BF_SSN_OBSCURED  / GROUP 'BORROWER\SSN' WIDTH=11 FORMAT=$11.;
DEFINE BNAME / GROUP 'BORROWER\NAME' WIDTH=20 FORMAT=$20. ;
DEFINE LF_STU_SSN_OBSCURED / GROUP 'STUDENT\SSN' WIDTH=11 FORMAT=$11.;
DEFINE SNAME / GROUP 'STUDENT\NAME' WIDTH=20 FORMAT=$20.;
DEFINE DX_STR_ADR_1 / DISPLAY NOPRINT;
DEFINE DX_STR_ADR_2 / DISPLAY NOPRINT;
DEFINE DX_STR_ADR_3 / DISPLAY NOPRINT;
DEFINE DM_CT / DISPLAY NOPRINT;
DEFINE DC_DOM_ST / DISPLAY NOPRINT;
DEFINE DF_ZIP_CDE / DISPLAY NOPRINT;
DEFINE DM_FGN_ST / DISPLAY NOPRINT;
DEFINE DM_FGN_CNY/ DISPLAY NOPRINT;
DEFINE BLOCK / COMPUTED FLOW WIDTH=50 'BORROWER\ADDRESS';
COMPUTE BLOCK / CHAR LENGTH=200 ;
	BLOCK= 'ADD 1: '||INPUT(DX_STR_ADR_1,$20.)
	||'\ADD 2: '||INPUT(DX_STR_ADR_2,$15.)
	||'\ADD 3:'||INPUT(DX_STR_ADR_3,$15.)
	||'\CITY: '||INPUT(DM_CT,$20.)
	||'\STATE: '||INPUT(DC_DOM_ST,$2.)
	||'\ZIP: '||INPUT(DF_ZIP_CDE,$10.)
	||'\FOREIGN STATE: '||INPUT(DM_FGN_ST,$15.)
	||'\FOREIGN COUNTRY: '||INPUT(DM_FGN_CNY,$20.)
	||'\\';
ENDCOMP;
RUN;
PROC PRINTTO;
RUN;

%MACRO PRINTOFC(LENDER=,REPNO=);

%LET TTL = ;

DATA DADISBLDR;
SET DADISB;
WHERE AF_DOE_LDR = "&LENDER" AND LN_PGM = 'FFELP';
TYPESORT = PAYEE;
RUN;

PROC SORT DATA=DADISBLDR;
BY LOC TYPESORT BF_SSN;
RUN;

/*Give DSBDAT a bogus value, which we'll check for later.*/
DATA _NULL_;
CALL SYMPUT('DSBDAT', '0');
RUN;

DATA _NULL_;
SET DADISBLDR;
CALL SYMPUT('TTL',TRIM(IM_LDR_FUL));
/*Set the DSBDAT variable to the value of LD_DSB if LC_LDR_DSB_MDM is EFT.*/
IF LC_LDR_DSB_MDM = 'EFT' THEN CALL SYMPUT('DSBDAT', PUT(LD_DSB, MMDDYY10.));
RUN;

/*Check the DSBDAT variable and assign it a value if it's still bogus.*/
DATA _NULL_; SET DADISBLDR;
IF &DSBDAT = '0' THEN CALL SYMPUT('DSBDAT', PUT(LD_DSB, MMDDYY10.));
RUN;

/*If the dataset is empty, then DSBDAT will still be bogus, so default it to today's date.*/
DATA _NULL_;
IF &DSBDAT = '0' THEN CALL SYMPUT('DSBDAT', PUT(INTNX('DAY',TODAY(),0,'beginning'), MMDDYY10.));
RUN;

PROC PRINTTO PRINT=REPORT&REPNO NEW;
RUN;

OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS CENTER NODATE NUMBER PAGENO=1 PS=39 LS=127;

PROC CONTENTS DATA=DADISBLDR OUT=EMPTYSET NOPRINT;
DATA _NULL_;
SET EMPTYSET;
FILE PRINT;
IF  NOBS=0 AND _N_ =1 THEN DO;
   PUT // 126*'-';
   PUT      //////
       @51 '**** NO DISBURSEMENTS FOUND ****';
   PUT //////
       @57 '-- END OF REPORT --';
   PUT ///////////////
   		@46 "JOB = UTLWL01     REPORT = ULWL01.LWL01R&REPNO";
   END;
RETURN;
TITLE "UTAH HIGHER EDUCATION ASSISTANCE AUTHORITY";
TITLE2 'DAILY FFELP LOANS DISBURSEMENT REPORT';
TITLE3 "LENDER ID # &LENDER";
TITLE4 "DISBURSEMENT DATE : &DSBDAT";
run;

PROC REPORT DATA=DADISBLDR NOWD HEADSKIP SPLIT='/' SPACING=1;
TITLE "UTAH HIGHER EDUCATION ASSISTANCE AUTHORITY";
TITLE2 'DAILY FFELP LOANS DISBURSEMENT REPORT';
TITLE3 "LENDER ID # &LENDER - &TTL";
TITLE4 "DISBURSEMENT DATE : &DSBDAT";
FOOTNOTE1  	"This document may contain borrowers' sensitive information that UHEAA has pledged to protect.";
FOOTNOTE2	"Please take appropriate precautions to safeguard this information.";
FOOTNOTE3	;
FOOTNOTE4 "JOB = UTLWL01     REPORT = ULWL01.LWL01R&REPNO";
COMPUTE BEFORE LOC ;
	LINE @1 LOC $60.;
	LINE @1 'COUNT:' N COMMA5.;
	LINE @1 48*'ƒ';
	LINE ' ';
ENDCOMP;
COLUMN LOC TYPESORT BF_SSN LN_LON_DSB_SEQ DISBAMT OFEE LA_DSB_FEE_LDR UOFE_AMT NETDISB LNDRFEE
	FUND_AMT GFEE LC_LDR_DSB_MDM IC_LON_PGM N;
DEFINE LOC / GROUP ORDER NOPRINT;
DEFINE TYPESORT / GROUP ORDER NOPRINT;
DEFINE BF_SSN / DISPLAY "SSN" FORMAT=SSN11. WIDTH=11;
DEFINE LN_LON_DSB_SEQ / DISPLAY "#" WIDTH=1 ;
DEFINE DISBAMT / ANALYSIS FORMAT=COMMA13.2 "DISB/AMOUNT" WIDTH=13;
DEFINE OFEE / ANALYSIS FORMAT=COMMA10.2 "BORROWER/ORIG FEE" WIDTH=10;
DEFINE LA_DSB_FEE_LDR / ANALYSIS FORMAT=COMMA10.2 "LENDER/ORIG FEE" WIDTH=10;
DEFINE UOFE_AMT / ANALYSIS FORMAT=COMMA10.2 "UHEAA/ORIG FEE" WIDTH=10;
DEFINE NETDISB / ANALYSIS FORMAT=COMMA13.2 "NET DISB/AMOUNT" WIDTH=13;
DEFINE LNDRFEE / ANALYSIS FORMAT=COMMA10.2 "LENDER/FEES" WIDTH=10;
DEFINE FUND_AMT / ANALYSIS FORMAT=COMMA13.2 "FUNDING/AMOUNT" WIDTH=13;
DEFINE GFEE / ANALYSIS FORMAT=COMMA10.2 "GUARANTY/FEE" WIDTH=10;
DEFINE LC_LDR_DSB_MDM / DISPLAY "DISB/TYPE" WIDTH=4;
DEFINE IC_LON_PGM / DISPLAY "LOAN/TYPE" WIDTH=6;
DEFINE N / NOPRINT;
BREAK AFTER LOC / SUMMARIZE SUPPRESS SKIP OL;
COMPUTE AFTER;
	LINE ' ';
	LINE @1 'TOTAL NUMBER OF DISBURSEMENTS:' @40 N COMMA7.;
	LINE @1 'TOTAL DISBURSEMENT AMOUNT:' @33 DISBAMT.SUM DOLLAR14.2;
	LINE @1 'TOTAL BORROWER ORIGINATION FEE:' @36 OFEE.SUM DOLLAR11.2;
	LINE @1 'TOTAL LENDER ORIGINATION FEE:' @36 LA_DSB_FEE_LDR.SUM DOLLAR11.2;
	LINE @1 'TOTAL UHEAA ORIGINATION FEE:' @36 UOFE_AMT.SUM DOLLAR11.2;
	LINE @1 'TOTAL GUARANTEE FEE:' @36 GFEE.SUM DOLLAR11.2;
	LINE @1 'TOTAL NET DISBURSEMENT AMOUNT:' @33 NETDISB.SUM DOLLAR14.2;
	LINE @1 'TOTAL FUNDING AMOUNT:' @33 FUND_AMT.SUM  DOLLAR14.2;
	LINE @1 'TOTAL LENDER FEE:' @33 LNDRFEE.SUM DOLLAR14.2;
ENDCOMP;
RUN;
PROC PRINTTO;
RUN;
%MEND PRINTOFC;

%MACRO LOANTYPETOT(LENDER=,REPNO=);

%LET TTL = ;

DATA DADISBLDR;
SET DADISB;
WHERE AF_DOE_LDR = "&LENDER";
TYPESORT = PAYEE;
RUN;

/*Give DSBDAT a bogus value, which we'll check for later.*/
DATA _NULL_;
CALL SYMPUT('DSBDAT', '0');
RUN;

DATA _NULL_;
SET DADISBLDR;
CALL SYMPUT('TTL',TRIM(IM_LDR_FUL));
/*Set the DSBDAT variable to the value of LD_DSB if LC_LDR_DSB_MDM is EFT.*/
IF LC_LDR_DSB_MDM = 'EFT' THEN CALL SYMPUT('DSBDAT', PUT(LD_DSB, MMDDYY10.));
RUN;

/*Check the DSBDAT variable and assign it a value if it's still bogus.*/
DATA _NULL_; SET DADISBLDR;
IF &DSBDAT = '0' THEN CALL SYMPUT('DSBDAT', PUT(LD_DSB, MMDDYY10.));
RUN;

/*If the dataset is empty, then DSBDAT will still be bogus, so default it to today's date.*/
DATA _NULL_;
IF &DSBDAT = '0' THEN CALL SYMPUT('DSBDAT', PUT(INTNX('DAY',TODAY(),0,'beginning'), MMDDYY10.));
RUN;

PROC SORT DATA=DADISBLDR;
BY TYPESORT BF_SSN;
RUN;

PROC SQL;
CREATE TABLE DADISBLDR1 AS
SELECT IC_LON_PGM, COUNT(*) AS CNT 
FROM DADISBLDR
GROUP BY IC_LON_PGM;
QUIT;

PROC SQL;
CREATE TABLE DADISBLDR2 AS
SELECT IC_LON_PGM, SUM(DISBAMT) AS GROSS 
FROM DADISBLDR
GROUP BY IC_LON_PGM;
QUIT;

DATA DADISBLDRTOT;
MERGE DADISBLDR1 DADISBLDR2;
BY IC_LON_PGM;
RUN;

PROC PRINTTO PRINT=REPORT&REPNO;
RUN;
PROC PRINT NOOBS SPLIT='/' DATA=DADISBLDRTOT;
FORMAT GROSS DOLLAR10.2;
VAR IC_LON_PGM CNT GROSS;
LABEL	IC_LON_PGM = 'Loan Type'
		CNT = 'Total # of Disbursements'
		GROSS = 'Total Gross Disbursement Amount';
TITLE "UTAH HIGHER EDUCATION ASSISTANCE AUTHORITY";
TITLE2 'DAILY DISBURSEMENT REPORT TOTALS BY LOAN TYPE';
TITLE3 "LENDER ID # &LENDER - &TTL";
TITLE4 "DISBURSEMENT DATE : &DSBDAT";
FOOTNOTE1  	"This document may contain borrowers' sensitive information that UHEAA has pledged to protect.";
FOOTNOTE2	"Please take appropriate precautions to safeguard this information.";
FOOTNOTE3	;
FOOTNOTE4  "JOB = UTLWL01     REPORT = ULWL01.LWL01R&REPNO";
RUN;
PROC PRINTTO;
RUN;
%MEND LOANTYPETOT;


%MACRO SPCPRT(LENDER=,REPNO=);

%LET TTL = ;

DATA IHSE;
	SET DADISB;
	WHERE AF_DOE_LDR = "&LENDER";
	TYPESORT = PAYEE;
RUN;

/*Give DSBDAT a bogus value, which we'll check for later.*/
DATA _NULL_;
CALL SYMPUT('DSBDAT', '0');
RUN;

/*Set the DSBDAT variable to the value of LD_DSB if LC_LDR_DSB_MDM is EFT.*/
DATA _NULL_; SET IHSE;
IF LC_LDR_DSB_MDM = 'EFT' THEN CALL SYMPUT('DSBDAT', PUT(LD_DSB, MMDDYY10.));
RUN;

/*Check the DSBDAT variable and assign it a value if it's still bogus.*/
DATA _NULL_; SET IHSE;
IF &DSBDAT = '0' THEN CALL SYMPUT('DSBDAT', PUT(LD_DSB, MMDDYY10.));
RUN;

/*If the dataset is empty, then DSBDAT will still be bogus, so default it to today's date.*/
DATA _NULL_;
IF &DSBDAT = '0' THEN CALL SYMPUT('DSBDAT', PUT(INTNX('DAY',TODAY(),0,'beginning'), MMDDYY10.));
RUN;

PROC SORT DATA=IHSE;
	BY LOC TYPESORT BF_SSN;
RUN;

DATA SPSEC4;
	SET IHSE;
	IF LF_LON_CUR_OWN ^= '' THEN DO;
		LDR = LF_LON_CUR_OWN;
		BND = IF_BND_ISS;
	END;
	ELSE DO;
		LDR = AF_DOE_LDR;
		BND = BOND_ID;
	END;
RUN;

PROC SQL;
CREATE TABLE SUMS AS 
SELECT COUNT(*) AS DISB_COUNT
	,SUM(DISBAMT) AS DISB_TOT
	,SUM(OFEE) AS OFEE_TOT
	,SUM(GFEE) AS GFEE_TOT
	,SUM(LA_DSB_FEE_LDR) AS LOFE_TOT
	,SUM(NETDISB) AS NET_DSB_TOT
	,SUM(LNDRFEE) AS LNDR_FEE_TOT
	,SUM(UOFE_AMT) AS UOFE_AMT_TOT
	,SUM(FUND_AMT) AS FUND_AMT_TOT
FROM IHSE
;

CREATE TABLE BSUMS AS 
SELECT BOND_ID  
	,1 AS GRP_VAR
	,SUM(DISBAMT) AS DISB_TOT
	,SUM(FUND_AMT) AS FUND_AMT_TOT
FROM IHSE
GROUP BY BOND_ID
;

CREATE TABLE LSUMS AS 
SELECT IC_LON_PGM AS BOND_ID
	,2 AS GRP_VAR
	,SUM(DISBAMT) AS DISB_TOT
	,SUM(FUND_AMT) AS FUND_AMT_TOT
FROM IHSE
GROUP BY IC_LON_PGM
;
QUIT;

PROC SQL;
CREATE TABLE DISB_NUMS AS 
SELECT IC_LON_PGM 
	,LN_LON_DSB_SEQ
	,COUNT(*) AS DISB_CT
	,SUM(DISBAMT) AS DISB_SUM
FROM IHSE
GROUP BY IC_LON_PGM 
	,LN_LON_DSB_SEQ
;
QUIT;

DATA BSUMS;
SET BSUMS LSUMS;
RUN;

DATA _NULL_;
SET IHSE;
CALL SYMPUT('TTL',TRIM(IM_LDR_FUL));
RUN;
%PUT &TTL;

PROC CONTENTS DATA=IHSE OUT=EMPTYSET NOPRINT;RUN;
DATA _NULL_;
SET EMPTYSET;
CALL SYMPUT('POBS',NOBS);
RUN;
%PUT &POBS;

PROC PRINTTO PRINT=REPORT&REPNO NEW;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS CENTER NODATE NUMBER PAGENO=1 PS=39 LS=132;

%IF &POBS = 0 %THEN %DO;
	DATA _NULL_;
	FILE PRINT;
	   PUT // 126*'-';
	   PUT      //////
	       @51 '**** NO DISBURSEMENTS FOUND ****';
	   PUT //////
	       @57 '-- END OF REPORT --';
	   PUT ///////////////
	   		@46 "JOB = UTLWL01     REPORT = ULWL01.LWL01R&REPNO";
	TITLE "UTAH HIGHER EDUCATION ASSISTANCE AUTHORITY";
	TITLE2 'DAILY DISBURSEMENT REPORT';
	TITLE3 "LENDER ID # &LENDER";
	TITLE4 "DISBURSEMENT DATE : &DSBDAT";
	RUN;
%END;
%ELSE %DO;
	PROC SORT DATA=IHSE;BY AF_DOE_LDR OL_LDR_NM BOND_ID;RUN;
	PROC REPORT DATA=IHSE NOWD HEADSKIP SPLIT='/' SPACING=4;
		BY AF_DOE_LDR OL_LDR_NM BOND_ID;
		TITLE "UTAH HIGHER EDUCATION ASSISTANCE AUTHORITY";
		TITLE2 'DAILY DISBURSEMENT REPORT';
		TITLE3 "LENDER ID # &LENDER - &TTL";
		TITLE4 "ONELINK ORIGINAL LENDER: #BYVAL2 ";
		TITLE5 "BOND ID: #BYVAL3 ";
		TITLE6 "DISBURSEMENT DATE : &DSBDAT";
		FOOTNOTE1  	"THIS DOCUMENT MAY CONTAIN BORROWERS' SENSITIVE INFORMATION THAT UHEAA HAS PLEDGED TO PROTECT.";
		FOOTNOTE2	"PLEASE TAKE APPROPRIATE PRECAUTIONS TO SAFEGUARD THIS INFORMATION.";
		FOOTNOTE3	;
		FOOTNOTE4 "JOB = UTLWL01     REPORT = ULWL01.LWL01R&REPNO";
		COMPUTE BEFORE LOC ;
			LINE @1 LOC $49.;
			LINE @1'COUNT:' N COMMA5.;
			LINE @1 49*'ƒ';
			LINE ' ';
		ENDCOMP;
		COLUMN LOC TYPESORT BF_SSN LN_LON_DSB_SEQ DISBAMT OFEE GFEE NETDISB LNDRFEE FUND_AMT 
			LA_DSB_FEE_LDR LC_LDR_DSB_MDM IC_LON_PGM N;
		DEFINE LOC / GROUP ORDER NOPRINT;
		DEFINE TYPESORT / GROUP ORDER NOPRINT;
		DEFINE BF_SSN / DISPLAY "SSN" FORMAT=SSN11. WIDTH=11;
		DEFINE LN_LON_DSB_SEQ / DISPLAY "#" WIDTH=1;
		DEFINE DISBAMT / ANALYSIS FORMAT=COMMA13.2 "DISB/AMOUNT" WIDTH=13;
		DEFINE OFEE / ANALYSIS FORMAT=COMMA10.2 "BORROWER/ORIG FEE" WIDTH=10;
		DEFINE GFEE / ANALYSIS FORMAT=COMMA10.2 "GUARANTY/FEE" WIDTH=10;
		DEFINE NETDISB / ANALYSIS FORMAT=COMMA13.2 "NET DISB/AMOUNT" WIDTH=13;
		DEFINE LNDRFEE / ANALYSIS FORMAT=COMMA10.2 "LENDER/FEES" WIDTH=10;
		DEFINE FUND_AMT / ANALYSIS FORMAT=COMMA13.2 "FUNDING/AMOUNT" WIDTH=13;
		DEFINE LA_DSB_FEE_LDR / ANALYSIS NOPRINT;
		DEFINE LC_LDR_DSB_MDM / DISPLAY "DISB/TYPE" WIDTH=6;
		DEFINE IC_LON_PGM / DISPLAY "LOAN/TYPE" WIDTH=6;
		DEFINE N / NOPRINT;
		BREAK AFTER LOC / SUMMARIZE SUPPRESS SKIP OL;
		COMPUTE AFTER;
			LINE ' ';
			LINE @1 'TOTAL NUMBER OF DISBURSEMENTS:' @40 N COMMA7.;
			LINE @1 'TOTAL DISBURSEMENT AMOUNT:' @33 DISBAMT.SUM DOLLAR14.2;
			LINE @1 'TOTAL BORROWER ORIGINATION FEE:' @36 OFEE.SUM DOLLAR11.2;
			LINE @1 'TOTAL LENDER ORIGINATION FEE:' @36 LA_DSB_FEE_LDR.SUM DOLLAR11.2;
			LINE @1 'TOTAL GUARANTY FEE:' @36 GFEE.SUM DOLLAR11.2;
			LINE @1 'TOTAL NET DISBURSEMENT AMOUNT:' @33 NETDISB.SUM DOLLAR14.2;
			LINE @1 'TOTAL FUNDING AMOUNT:' @35 FUND_AMT.SUM DOLLAR12.2;
			LINE @1 'TOTAL LENDER FEE:' @33 LNDRFEE.SUM DOLLAR14.2;
		ENDCOMP;
	RUN;
	DATA _NULL_;
		SET SUMS;
		FILE PRINT;
		PUT //
		 @35 'TOTAL NUMBER OF DISBURSEMENTS:' @87 DISB_COUNT COMMA6. /
		 @35 'TOTAL DISBURSEMENT AMOUNT:' @75 DISB_TOT DOLLAR18.2/
		 @35 'TOTAL BORROWER ORIGINATION FEE:' @83 OFEE_TOT DOLLAR10.2/
		 @35 'TOTAL LENDER ORIGINATION FEE:' @83 LOFE_TOT DOLLAR10.2/
		 @35 'TOTAL LENDER GUARANTY FEE:' @83 GFEE_TOT DOLLAR10.2/
		 @35 'TOTAL NET DISBURSEMENT AMOUNT:' @75 NET_DSB_TOT DOLLAR18.2/
		 @35 'TOTAL LENDER FEE:' @75 LNDR_FEE_TOT DOLLAR18.2/
		 @35 'TOTAL FUNDING AMOUT:' @75 FUND_AMT_TOT DOLLAR18.2/
		 	//////////////
		   	@46 "JOB = UTLWL01     REPORT = ULWL01.LWL01R&REPNO";
		TITLE "UTAH HIGHER EDUCATION ASSISTANCE AUTHORITY";
		TITLE2 'DAILY DISBURSEMENT REPORT TOTALS';
		TITLE3 "LENDER ID # &LENDER - &TTL";
		TITLE4 "DISBURSEMENT DATE : &DSBDAT";
	RUN;
	DATA _NULL_;
		SET BSUMS;
		FILE PRINT;
		PUT /;
		IF GRP_VAR = 1 THEN DO;
			PUT @43 'BOND ID: ' @55 BOND_ID;
			PUT @43 'DISBURSEMENT AMOUNT: ' @66 DISB_TOT DOLLAR18.2 ;
			PUT @43 'FUNDING AMOUNT:' @66 FUND_AMT_TOT DOLLAR18.2 ;
			PUT @43 41*'-' ;
		END;
		IF GRP_VAR = 2 THEN DO;
			PUT @43 'LOAN TYPE: ' @57 BOND_ID;
			PUT @43 'DISBURSEMENT AMOUNT: ' @66 DISB_TOT DOLLAR18.2 ;
			PUT @43 41*'-' ;
		END;
	RUN;
	PROC SORT DATA=SPSEC4;
		BY LDR BND IC_LON_PGM ;
	RUN;
	PROC REPORT DATA=SPSEC4 NOWD HEADSKIP SPLIT='/' SPACING=4;
		COLUMN LDR BND IC_LON_PGM DISBAMT FUND_AMT;
		DEFINE LDR / GROUP  "OWNER" WIDTH=12;
		DEFINE BND / GROUP  "BOND ID" WIDTH=12;
		DEFINE IC_LON_PGM / GROUP  "LOAN/TYPE" WIDTH=12;
		DEFINE DISBAMT / ANALYSIS FORMAT=COMMA12.2 "DISB/AMOUNT" WIDTH=12;
		DEFINE FUND_AMT / ANALYSIS FORMAT=COMMA12.2 "FUNDING/AMOUNT" WIDTH=12;
		BREAK AFTER BND / SUMMARIZE SUPPRESS SKIP OL;
	RUN;
	PROC PRINT NOOBS SPLIT='/' DATA=DISB_NUMS WIDTH=UNIFORM WIDTH=MIN LABEL;
		FORMAT DISB_CT COMMA8. DISB_SUM DOLLAR18.2;
		VAR IC_LON_PGM LN_LON_DSB_SEQ DISB_CT DISB_SUM;
		LABEL IC_LON_PGM = 'LOAN TYPE'
		LN_LON_DSB_SEQ = 'DISBURSEMENT/NUMBER' 
		DISB_CT = 'DISBURSEMENT/COUNT' 
		DISB_SUM = 'DISBURSEMENT/AMOUNT';
		SUM DISB_CT DISB_SUM;
	RUN;
%END;
PROC PRINTTO;
RUN;
%MEND SPCPRT;

%MACRO PRINTOFCTEXTFILE();

	DATA DADISBLDR;
	SET DADISB;
	WHERE AF_DOE_LDR = '822373';
	TYPESORT = PAYEE;
	RUN;

	DATA _NULL_;
	SET  WORK.DADISBLDR;
	FILE REPORT28 DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT BF_SSNCHAR $9. ;
	FORMAT LN_SEQ 4. ;
	FORMAT IC_LON_PGM $6. ;
	FORMAT DISBAMT 16.2 ;
	FORMAT LD_DSB MMDDYY10. ;
	FORMAT OFEE 9.2 ;
	FORMAT LA_DSB_FEE_LDR 16.2 ;
	FORMAT LNDRFEE 16.2 ;
	FORMAT LOCPERCENT $4. ;
	FORMAT LNDRPERCENT $2. ;
	FORMAT FEECODE $3. ;
	FORMAT FUND_AMT BEST12.;
	FORMAT UOFE_AMT BEST12.;
	FORMAT GFEE BEST12.;
	
	
	IF _N_ = 1 THEN        /* WRITE COLUMN NAMES */
	DO;
	 PUT
	 'SSN'
	 ','
	 'SEQ#'
	 ','
	 'LOAN_TYPE'
	 ','
	 'DISBAMT'
	 ','
	 'DISB_DT'
	 ','
	 'FUND_AMOUNT'
	 ','
	 'BORR_ORIG_FEE'
	 ','
	 'LEND_ORIG_FEE'
	 ','
	 'LNDRFEE'
	 ','
	 'ORIG_FEE_%'
	 ','
	 'LEND_FEE_%'
	 ','
	 'UHEAA_ORG_FEE_%'
	 ','
	 'GUARANTEE FEE'
	 ','
	 'FEECODE'
	 ;
	END;
	DO;
	 PUT BF_SSNCHAR @;
	 PUT LN_SEQ @;
	 PUT IC_LON_PGM $ @;
	 PUT DISBAMT @;
	 PUT LD_DSB @;
	 PUT FUND_AMT @;
	 PUT OFEE @;
	 PUT LA_DSB_FEE_LDR @;
	 PUT LNDRFEE @;
	 PUT LOCPERCENT @;
	 PUT LNDRPERCENT @;
	 PUT UOFE_AMT @;
	 PUT GFEE @;
	 PUT FEECODE ;
	END;
	RUN;


%MEND PRINTOFCTEXTFILE;

%PRINTOFC(LENDER=811698,REPNO=3);
%LOANTYPETOT(LENDER=811698,REPNO=3);
%PRINTOFC(LENDER=813760,REPNO=4);
%PRINTOFC(LENDER=813894,REPNO=5);
%PRINTOFC(LENDER=817440,REPNO=6);
%PRINTOFC(LENDER=817545,REPNO=7);
%PRINTOFC(LENDER=817546,REPNO=8);
%PRINTOFC(LENDER=819628,REPNO=9);
%PRINTOFC(LENDER=820200,REPNO=11);
%PRINTOFC(LENDER=822373,REPNO=12);
%PRINTOFC(LENDER=829123,REPNO=13);
%PRINTOFC(LENDER=829158,REPNO=14);
%PRINTOFC(LENDER=830132,REPNO=15);
%PRINTOFC(LENDER=830146,REPNO=16);
%PRINTOFC(LENDER=830791,REPNO=17);
%PRINTOFC(LENDER=832241,REPNO=18);
%PRINTOFC(LENDER=833828,REPNO=19);
%PRINTOFC(LENDER=817455,REPNO=20);
%PRINTOFC(LENDER=817575,REPNO=21);
%PRINTOFC(LENDER=834122,REPNO=22);
%PRINTOFC(LENDER=833577,REPNO=23);
%PRINTOFC(LENDER=834265,REPNO=24);
%PRINTOFC(LENDER=834370,REPNO=27);
%PRINTOFCTEXTFILE();
%SPCPRT(LENDER=828476,REPNO=26);
/*GET TITLE DATE FOR R29*/
PROC SORT DATA=DADISB OUT=RTI 
	(KEEP=LC_LDR_DSB_MDM LD_DSB WHERE=(LC_LDR_DSB_MDM IN ('EFT','CHK'))) NODUPKEY;
	BY LC_LDR_DSB_MDM LD_DSB;
RUN;
DATA _NULL_;
	SET RTI END=LAST;
	IF LAST THEN DO;
		CALL SYMPUT('TITLE_DT',PUT(LD_DSB,MMDDYY10.));
	END;
RUN;
PROC PRINTTO PRINT=REPORT29 NEW;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 PAGENO=1 CENTER DATE;
TITLE 'SCHOOL DAILY DISBURSEMENT SUMMARY';
TITLE2	"DISBURSEMENT DATE &TITLE_DT";
FOOTNOTE4   'JOB = UTLWL01  	 REPORT = ULWL01.LWL01R29';
PROC CONTENTS DATA=SDDS OUT=EMPTYSET NOPRINT;
DATA _NULL_;
SET EMPTYSET;
FILE PRINT;
IF  NOBS=0 AND _N_ =1 THEN DO;
	PUT // 126*'-';
	PUT      ////
		@51 '**** NO OBSERVATIONS FOUND ****';
	PUT ////
		@57 '-- END OF REPORT --';
	PUT ////////////
		@46 "JOB = UTLWL01  	 REPORT = ULWL01.LWL01R29";
	END;
RETURN;
RUN;
PROC REPORT DATA=SDDS HEADSKIP NOWD SPLIT='/';
	COLUMN LC_LDR_DSB_MDM IM_SCL_FUL AF_DOE_SCL AF_DOE_LDR IC_LON_PGM DISBC DISBAMT NETDSIB;
	DEFINE LC_LDR_DSB_MDM / GROUP 'DISB TYPE';
	DEFINE IM_SCL_FUL / GROUP 'SCHOOL NAME'; 
	DEFINE AF_DOE_SCL / GROUP 'SCHOOL CODE'; 
	DEFINE AF_DOE_LDR / GROUP 'LENDER ID'; 
	DEFINE IC_LON_PGM / GROUP 'LOAN TYPE';
	DEFINE DISBC / ANALYSIS '# OF DISBS' FORMAT=COMMA8.;
	DEFINE DISBAMT / ANALYSIS 'GROSS DISB' FORMAT=DOLLAR13.2; 
	DEFINE NETDSIB / ANALYSIS 'NET DISB' FORMAT=DOLLAR13.2;
	BREAK AFTER AF_DOE_SCL / SUMMARIZE SKIP SUPPRESS OL;
	COMPUTE AFTER LC_LDR_DSB_MDM;
		LINE @ 86 36*'='  ;
		LINE @ 84 DISBC.SUM COMMA8. @93 DISBAMT.SUM DOLLAR14.2 @108 NETDSIB.SUM DOLLAR14.2;
		LINE @ 86 36*'='  ;
		LINE '';
	ENDCOMP;
RUN;
PROC PRINTTO;
RUN;
/*GET TITLE DATE FOR R30*/
PROC SORT DATA=DADISB OUT=RTI 
	(KEEP=LC_LDR_DSB_MDM LD_DSB WHERE=(LC_LDR_DSB_MDM='ELM')) NODUPKEY;
	BY LC_LDR_DSB_MDM LD_DSB;
RUN;
DATA _NULL_;
	SET RTI END=LAST;
	IF LAST THEN DO;
		CALL SYMPUT('TITLE_DT',PUT(LD_DSB,MMDDYY10.));
	END;
RUN;
PROC PRINTTO PRINT=REPORT30 NEW;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 PAGENO=1 CENTER DATE;
TITLE 'ELM DISBURSEMENT BY SCHOOL';
TITLE2	"DISBURSEMENT DATE &TITLE_DT";
FOOTNOTE4   'JOB = UTLWL01  	 REPORT = ULWL01.LWL01R30';
PROC CONTENTS DATA=EDBS OUT=EMPTYSET NOPRINT;
DATA _NULL_;
SET EMPTYSET;
FILE PRINT;
IF  NOBS=0 AND _N_ =1 THEN DO;
	PUT // 126*'-';
	PUT      ////
		@51 '**** NO OBSERVATIONS FOUND ****';
	PUT ////
		@57 '-- END OF REPORT --';
	PUT ////////////
		@46 "JOB = UTLWL01  	 REPORT = ULWL01.LWL01R30";
	END;
RETURN;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 PAGENO=1 CENTER DATE;
PROC REPORT DATA=EDBS HEADSKIP NOWD SPLIT='/';
	COLUMN IM_SCL_FUL AF_DOE_SCL BF_SSNCHAR LN_SEQ AF_DOE_LDR LD_DSB_ROS_PRT LD_DSB DSB_CT DISBAMT NETDISB;
	DEFINE IM_SCL_FUL / GROUP 'SCHOOL NAME' WIDTH=20 FLOW; 
	DEFINE AF_DOE_SCL / DISPLAY'SCHOOL CODE' WIDTH=8;
	DEFINE BF_SSNCHAR / DISPLAY 'SSN' WIDTH=11; 
	DEFINE LN_SEQ  / DISPLAY 'LOAN SEQ' WIDTH=4;
	DEFINE AF_DOE_LDR  / DISPLAY 'LENDER ID' WIDTH=6;
	DEFINE LD_DSB_ROS_PRT / DISPLAY 'EXTRACT DATE' WIDTH=10 FORMAT=MMDDYY10.;
	DEFINE LD_DSB / DISPLAY 'DISB DATE' WIDTH=10 FORMAT=MMDDYY10.;
	DEFINE DSB_CT / ANALYSIS '# OF DISB' FORMAT=COMMA8.;
	DEFINE DISBAMT  / ANALYSIS 'GROSS DISB' FORMAT=DOLLAR12.2; 
	DEFINE NETDISB  / ANALYSIS 'NET DISB' FORMAT=DOLLAR12.2;
	BREAK AFTER IM_SCL_FUL / SUMMARIZE SKIP SUPPRESS OL;
RUN;
PROC PRINTTO;
RUN;
%MACRO ALT_LOAN_DISB_REPORT(RNO,LENDER_ID);
DATA ALT;
	SET DADISB;
	WHERE LN_PGM ^= 'FFELP' AND AF_DOE_LDR = "&LENDER_ID";
RUN;
PROC SORT DATA=ALT;
	BY IM_SCL_FUL BF_SSN LN_LON_DSB_SEQ LC_LDR_DSB_MDM IC_LON_PGM ;
RUN;
/*DEFAULT DSBDAT TO TODAY'S DATE*/
DATA _NULL_;
	CALL SYMPUT('DSBDAT', PUT(INTNX('DAY',TODAY(),0,'BEGINNING'), MMDDYY10.));
RUN;
DATA _NULL_;
	SET ALT;
	IF _N_ > 0 THEN DO;
		CALL SYMPUT('TTL',TRIM(IM_LDR_FUL));
		IF LC_LDR_DSB_MDM = 'EFT' THEN DO; 
			CALL SYMPUT('DSBDAT', PUT(LD_DSB, MMDDYY10.)); /*ASSIGN DSBDAT TO EFT DISB DATE*/
		END;
	END;
RUN;
PROC PRINTTO PRINT=REPORT&RNO NEW;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 PAGENO=1 CENTER NODATE;
TITLE 'DAILY ALTERNATIVE LOANS DISBURSEMENT REPORT';
TITLE2 "DISBURSEMENT DATE : &DSBDAT";
FOOTNOTE1  	"This document may contain borrowers' sensitive information that UHEAA has pledged to protect.";
FOOTNOTE2	'Please take appropriate precautions to safeguard this information.';
FOOTNOTE3	;
FOOTNOTE4   "JOB = UTLWL01  	 REPORT = ULWL01.LWL01R3&RNO";
PROC CONTENTS DATA=ALT OUT=EMPTYSET NOPRINT;QUIT;
DATA _NULL_;
SET EMPTYSET;
FILE PRINT;
IF  NOBS=0 AND _N_ =1 THEN DO;
	PUT // 126*'-';
	PUT      ////
		@51 '**** NO OBSERVATIONS FOUND ****';
	PUT ////
		@57 '-- END OF REPORT --';
	PUT ////////////
		@46 "JOB = UTLWL01  	 REPORT = ULWL01.LWL01R&RNO";
	END;
RETURN;
RUN;
PROC REPORT DATA=ALT NOWD HEADSKIP SPLIT='/';
	COLUMN IM_SCL_FUL BF_SSNCHAR LN_LON_DSB_SEQ LC_LDR_DSB_MDM IC_LON_PGM DISBAMT LA_DSB_ORG_CHK_EFT N;
	COMPUTE BEFORE IM_SCL_FUL ;
		LINE @1 IM_SCL_FUL $40.;
		LINE @1 'DISBURSEMENTS:' N COMMA5.;
		LINE ' ';
	ENDCOMP;
	DEFINE IM_SCL_FUL / GROUP NOPRINT;
	DEFINE BF_SSNCHAR / GROUP 'SSN' ;
	DEFINE LN_LON_DSB_SEQ / GROUP '#' ;
	DEFINE  LC_LDR_DSB_MDM / GROUP 'DISB/TYPE' ;
	DEFINE IC_LON_PGM /	GROUP 'LOAN/TYPE' ;
	DEFINE DISBAMT / ANALYSIS 'DISB/AMT' FORMAT=DOLLAR18.2;
	DEFINE LA_DSB_ORG_CHK_EFT / ANALYSIS 'FUNDING/AMOUNT' FORMAT=DOLLAR18.2;
	DEFINE N / NOPRINT;
	BREAK AFTER IM_SCL_FUL / SUMMARIZE SUPPRESS SKIP OL;
RUN;
PROC PRINTTO;
RUN;
%MEND ALT_LOAN_DISB_REPORT;
%ALT_LOAN_DISB_REPORT(31,830132);

%MACRO ALT_FFEL_SUMMARY(RNO,LENDER_ID);
DATA LENDER_ALT_FFEL;
	SET DADISB;
	WHERE AF_DOE_LDR = /*"&LENDER_ID"*/ '830132';
RUN;
PROC SORT DATA=LENDER_ALT_FFEL;
	BY BF_SSN AF_APL_ID ;
RUN;
DATA LENDER_ALT_FFEL;
	SET LENDER_ALT_FFEL;
	BY BF_SSN AF_APL_ID;
	IF FIRST.BF_SSN THEN 
		UBI = 1;
	IF FIRST.AF_APL_ID THEN 
		ULI = 1;
RUN;
/*CREATE SUMMARY DATA SET*/
PROC SQL;
CREATE TABLE LNDR_SMRY AS 
	SELECT 'FFELP' 		AS SC
		,SUM(UBI) 		AS TOT_BORS
		,SUM(ULI) 		AS TOT_LOAN
		,SUM(DISBAMT) 	AS GRO_TOT
		,SUM(NETDISB) 	AS NET_TOT
		,SUM(FUND_AMT) 	AS FND_TOT
	FROM LENDER_ALT_FFEL
	WHERE LN_PGM = 'FFELP'
UNION
	SELECT 'ALTERNATIVE' AS SC 
		,SUM(UBI) 		AS TOT_BORS
		,SUM(ULI) 		AS TOT_LOAN
		,SUM(DISBAMT) 	AS GRO_TOT
		,SUM(NETDISB) 	AS NET_TOT
		,SUM(FUND_AMT) 	AS FND_TOT
	FROM LENDER_ALT_FFEL
	WHERE LN_PGM ^= 'FFELP'
UNION
	SELECT 'TOTAL' 		AS SC
		,SUM(UBI) 		AS TOT_BORS
		,SUM(ULI) 		AS TOT_LOAN
		,SUM(DISBAMT) 	AS GRO_TOT
		,SUM(NETDISB) 	AS NET_TOT
		,SUM(FUND_AMT) 	AS FND_TOT
	FROM LENDER_ALT_FFEL
;
QUIT;
/*DEFAULT DSBDAT TO TODAY'S DATE*/
DATA _NULL_;
	CALL SYMPUT('DSBDAT', PUT(INTNX('DAY',TODAY(),0,'BEGINNING'), MMDDYY10.));
RUN;
DATA _NULL_;
	SET LENDER_ALT_FFEL;
	IF _N_ > 0 THEN DO;
		CALL SYMPUT('TTL',TRIM(IM_LDR_FUL));
		IF LC_LDR_DSB_MDM = 'EFT' THEN DO; 
			CALL SYMPUT('DSBDAT', PUT(LD_DSB, MMDDYY10.)); /*ASSIGN DSBDAT TO EFT DISB DATE*/
		END;
	END;
RUN;
PROC SORT DATA=LENDER_ALT_FFEL;
	BY IM_SCL_FUL LOC IC_LON_PGM ;
RUN;
PROC PRINTTO PRINT=REPORT&RNO NEW;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 PAGENO=1 CENTER NODATE;
TITLE 'DAILY LOANS DISBURSEMENT REPORT';
TITLE2 "DISBURSEMENT DATE : &DSBDAT";
FOOTNOTE   "JOB = UTLWL01  	 REPORT = ULWL01.LWL01R&RNO";
PROC CONTENTS DATA=LENDER_ALT_FFEL OUT=EMPTYSET NOPRINT;
DATA _NULL_;
SET EMPTYSET;
FILE PRINT;
IF  NOBS=0 AND _N_ =1 THEN DO;
	PUT // 132*'-';
	PUT      //////
		@51 '**** NO OBSERVATIONS FOUND ****';
	PUT //////
		@57 '-- END OF REPORT --';
	PUT //////////////
		@46 "JOB = UTLWL01  	 REPORT = ULWL01.LWL01R&RNO";
	END;
RETURN;
RUN;
/*FFEL LOAN SECTION - R32*/
PROC REPORT DATA=LENDER_ALT_FFEL NOWD HEADSKIP SPLIT='/' SPACING=1;
	WHERE LN_PGM = 'FFELP';
	COLUMN IM_SCL_FUL LOC IC_LON_PGM UBI ULI DISBAMT NETDISB FUND_AMT LNDRFEE UOFE_AMT OFEE GFEE ;
	COMPUTE BEFORE IM_SCL_FUL ;
		LINE @3 IM_SCL_FUL $25.;
		LINE @3 'BORROWERS:' UBI.SUM COMMA5.;
		LINE @3 'LOANS:    ' ULI.SUM COMMA5.;
		LINE @3 30*'-';
	ENDCOMP;
	DEFINE IM_SCL_FUL / GROUP NOPRINT;
	DEFINE LOC / GROUP '/' FLOW WIDTH=30;
	DEFINE IC_LON_PGM / GROUP 'LOAN TYPE';
	DEFINE UBI / ANALYSIS NOPRINT;
	DEFINE ULI / ANALYSIS NOPRINT;
	DEFINE DISBAMT / "GROSS/DISB/AMOUNT" FORMAT=COMMA13.2 WIDTH=13;
	DEFINE NETDISB / "NET/DISB/AMOUNT" FORMAT=COMMA13.2 WIDTH=13; 
	DEFINE FUND_AMT / "FUNDING/AMOUNT" FORMAT=COMMA13.2 WIDTH=13;
	DEFINE LNDRFEE / "LENDER/ORIG FEE/AMOUNT" FORMAT=COMMA10.2 WIDTH=10;
	DEFINE UOFE_AMT / "UHEAA/ORIG FEE/AMOUNT" FORMAT=COMMA10.2 WIDTH=10;
	DEFINE OFEE / "BORROWER/ORIG FEE/AMOUNT" FORMAT=COMMA10.2 WIDTH=10;
	DEFINE GFEE / "GUARANTEE/FEE AMOUNT" FORMAT=COMMA10.2 WIDTH=10;
	BREAK AFTER LOC / SUMMARIZE SUPPRESS SKIP OL;
	COMPUTE AFTER;
		LINE '';
		LINE @3 'TOTAL BORROWERS: ' UBI.SUM COMMA7.;
	ENDCOMP;
RUN;
/*TOTALS SECTION - R32*/
PROC PRINT NOOBS SPLIT='/' DATA=LNDR_SMRY WIDTH=UNIFORM WIDTH=MIN;
	TITLE 'DAILY LOANS DISBURSEMENT REPORT';
	TITLE2 "DISBURSEMENT DATE : &DSBDAT";
	FORMAT TOT_BORS TOT_LOAN COMMA8. GRO_TOT NET_TOT FND_TOT DOLLAR18.2;
	VAR SC TOT_BORS TOT_LOAN GRO_TOT NET_TOT FND_TOT ;
	LABEL SC = '/'
		TOT_BORS = 'BORROWERS'
		TOT_LOAN = 'LOANS'
		GRO_TOT = 'GROSS/DISB/AMOUNT'
		NET_TOT = 'NET/DISB/AMOUNT'
		FND_TOT = 'FUNDING/AMOUNT'
		;
RUN;
PROC PRINTTO;
RUN;
%MEND ALT_FFEL_SUMMARY;
%ALT_FFEL_SUMMARY(32,830132);
/*UBS - R33 REPORT*/
DATA UBS;
	SET DADISB;
	WHERE IM_LDR_SHO_R233 = 'UBS';
	LF_LON_CUR_OWN = COALESCE(LF_LON_CUR_OWN,'828476');
RUN;
PROC SORT DATA=UBS;
	BY LF_LON_CUR_OWN;
RUN;
DATA _NULL_;
	CALL SYMPUT('UBS_DT', PUT(TODAY(), MMDDYY10.));
	SET UBS;
	IF LC_LDR_DSB_MDM IN ('EFT','CHK') THEN 
		CALL SYMPUT('UBS_DT', PUT(LD_DSB, MMDDYY10.));
RUN;
PROC PRINTTO PRINT=REPORT33 NEW;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS CENTER NODATE NUMBER PAGENO=1 PS=39 LS=127;
PROC CONTENTS DATA=UBS OUT=EMPTYSET NOPRINT;
DATA _NULL_;
	SET EMPTYSET;
	FILE PRINT;
	IF  NOBS=0 AND _N_ =1 THEN DO;
	   PUT // 126*'-';
	   PUT      //////
	       @51 '**** NO DISBURSEMENTS FOUND ****';
	   PUT //////
	       @57 '-- END OF REPORT --';
	   PUT ///////////////
	   		@46 "JOB = UTLWL01     REPORT = ULWL01.LWL01R33";
	   END;
	RETURN;
	TITLE "UTAH HIGHER EDUCATION ASSISTANCE AUTHORITY";
	TITLE2 'DAILY FFELP LOANS DISBURSEMENT REPORT';
	TITLE3 "828476 - UBS";
	TITLE4 "DISBURSEMENT DATE : &UBS_DT";
RUN;
PROC REPORT DATA=UBS NOWD HEADSKIP SPLIT='/' SPACING=1;
	TITLE "UTAH HIGHER EDUCATION ASSISTANCE AUTHORITY";
	TITLE2 'DAILY FFELP LOANS DISBURSEMENT REPORT';
	TITLE3 "828476 - UBS";
	TITLE4 "DISBURSEMENT DATE : &UBS_DT";
	FOOTNOTE1  	"This document may contain borrowers' sensitive information that UHEAA has pledged to protect.";
	FOOTNOTE2	"Please take appropriate precautions to safeguard this information.";
	FOOTNOTE3	;
	FOOTNOTE4 "JOB = UTLWL01     REPORT = ULWL01.LWL01R33";
	COMPUTE BEFORE LF_LON_CUR_OWN ;
		LINE @3 'CURRENT OWNER: ' LF_LON_CUR_OWN $20.;
		LINE @3 'COUNT:' N COMMA5.;
		LINE ' ';
	ENDCOMP;
	COLUMN LF_LON_CUR_OWN BF_SSN LN_LON_DSB_SEQ DISBAMT OFEE LA_DSB_FEE_LDR UOFE_AMT NETDISB LNDRFEE
		FUND_AMT GFEE LC_LDR_DSB_MDM IC_LON_PGM N;
	DEFINE LF_LON_CUR_OWN / GROUP ORDER NOPRINT;
	DEFINE BF_SSN / DISPLAY "SSN" FORMAT=SSN11. WIDTH=11;
	DEFINE LN_LON_DSB_SEQ / DISPLAY "#" WIDTH=1 ;
	DEFINE DISBAMT / ANALYSIS FORMAT=COMMA13.2 "DISB/AMOUNT" WIDTH=13;
	DEFINE OFEE / ANALYSIS FORMAT=COMMA10.2 "BORROWER/ORIG FEE" WIDTH=10;
	DEFINE LA_DSB_FEE_LDR / ANALYSIS FORMAT=COMMA10.2 "LENDER/ORIG FEE" WIDTH=10;
	DEFINE UOFE_AMT / ANALYSIS FORMAT=COMMA10.2 "UHEAA/ORIG FEE" WIDTH=10;
	DEFINE NETDISB / ANALYSIS FORMAT=COMMA13.2 "NET DISB/AMOUNT" WIDTH=13;
	DEFINE LNDRFEE / ANALYSIS FORMAT=COMMA10.2 "LENDER/FEES" WIDTH=10;
	DEFINE FUND_AMT / ANALYSIS FORMAT=COMMA13.2 "FUNDING/AMOUNT" WIDTH=13;
	DEFINE GFEE / ANALYSIS FORMAT=COMMA10.2 "GUARANTY/FEE" WIDTH=10;
	DEFINE LC_LDR_DSB_MDM / DISPLAY "DISB/TYPE" WIDTH=4;
	DEFINE IC_LON_PGM / DISPLAY "LOAN/TYPE" WIDTH=6;
	DEFINE N / NOPRINT;
	BREAK AFTER LF_LON_CUR_OWN / SUMMARIZE SUPPRESS SKIP OL;
	COMPUTE AFTER;
		LINE ' ';
		LINE @1 'TOTAL NUMBER OF DISBURSEMENTS:' @40 N COMMA7.;
		LINE @1 'TOTAL DISBURSEMENT AMOUNT:' @33 DISBAMT.SUM DOLLAR14.2;
		LINE @1 'TOTAL BORROWER ORIGINATION FEE:' @36 OFEE.SUM DOLLAR11.2;
		LINE @1 'TOTAL LENDER ORIGINATION FEE:' @36 LA_DSB_FEE_LDR.SUM DOLLAR11.2;
		LINE @1 'TOTAL UHEAA ORIGINATION FEE:' @36 UOFE_AMT.SUM DOLLAR11.2;
		LINE @1 'TOTAL GUARANTEE FEE:' @36 GFEE.SUM DOLLAR11.2;
		LINE @1 'TOTAL NET DISBURSEMENT AMOUNT:' @33 NETDISB.SUM DOLLAR14.2;
		LINE @1 'TOTAL FUNDING AMOUNT:' @33 FUND_AMT.SUM  DOLLAR14.2;
		LINE @1 'TOTAL LENDER FEE:' @33 LNDRFEE.SUM DOLLAR14.2;
	ENDCOMP;
RUN;
PROC PRINTTO;
RUN;

DATA _NULL_;
	SET UBS;
	FILE REPORT34 DELIMITER=',' DSD DROPOVER LRECL=32767;
		FORMAT BF_SSNCHAR $9. ;
		FORMAT AN_SEQ 6.;
		FORMAT CLUID $19. ;
		FORMAT DISBAMT 16.2 ;
		FORMAT LA_DSB_ORG_CHK_EFT 10.2 ;
		FORMAT FUND_AMT BEST12. ;
		FORMAT LD_DSB MMDDYY10. ;
		FORMAT LC_LDR_DSB_MDM $5. ;
	IF _N_ = 1 THEN DO;
		PUT 
			'BF_SSN'
			','
			'AN_SEQ'
			','
			'CLUID'
			','
			'GROSS_DISB'  
			','
			'NET_DISB'  
			','
			'FUNDING_AMOUNT' 
			','
			'DISB_DATE' 
			','
			'DISB_TYPE';
	END;
	DO;
		PUT BF_SSNCHAR $ @;
		PUT AN_SEQ @;
		PUT CLUID $ @ ;
		PUT DISBAMT @;
		PUT LA_DSB_ORG_CHK_EFT @;
		PUT FUND_AMT @;
		PUT LD_DSB @;
		PUT LC_LDR_DSB_MDM $ ;
	END;
RUN;
