PROC SQL;
CREATE TABLE NO_BR03_DELTA AS
SELECT DISTINCT A.DF_SPE_ACC_ID
	,A.DF_PRS_ID_RFR
FROM BR03 A
INNER JOIN DUDE.REFERENCE B
      ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.DF_PRS_ID_RFR = B.DF_PRS_ID_RFR
	  AND A.BC_STA_BR03 = B.BC_STA_BR03
	  AND A.BI_ATH_3_PTY = B.BI_ATH_3_PTY
	  AND A.BC_RFR_REL_BR = B.BC_RFR_REL_BR
	  AND A.RFR_REL_BR = B.RFR_REL_BR
	  AND A.BM_RFR_1 = B.BM_RFR_1
	  AND A.BM_RFR_LST  = B.BM_RFR_LST
	  AND A.LST_CNC = B.LST_CNC 
	  AND A.LST_ATT = B.LST_ATT;

CREATE TABLE BR03_DELTAS AS
SELECT DISTINCT A.*
FROM BR03 A
LEFT JOIN NO_BR03_DELTA B
	  ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
      AND A.DF_PRS_ID_RFR = B.DF_PRS_ID_RFR
WHERE B.DF_SPE_ACC_ID IS NULL
	AND B.DF_PRS_ID_RFR IS NULL;
QUIT;

DATA REFERENCE_DELTAS (KEEP=DF_SPE_ACC_ID DF_PRS_ID_RFR);
	SET BR03_DELTAS;
RUN;
PROC SORT DATA=REFERENCE_DELTAS NODUPKEY;
	BY DF_SPE_ACC_ID DF_PRS_ID_RFR;
RUN;

PROC SQL;
CREATE TABLE LOCL_REFERENCE_DELTAS AS
      SELECT A.* 
      FROM DUDE.REFERENCE A
      INNER JOIN REFERENCE_DELTAS B
            ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
			AND A.DF_PRS_ID_RFR = B.DF_PRS_ID_RFR;

INSERT INTO DUDE.REFERENCE_DELETE
      SELECT DF_SPE_ACC_ID
	  		,DF_PRS_ID_RFR
      FROM LOCL_REFERENCE_DELTAS; 
QUIT;

%UPDATE_DATA(LOCL_REFERENCE_DELTAS,BR03_DELTAS,%STR(DF_SPE_ACC_ID DF_PRS_ID_RFR));
PROC SQL NOPRINT;
CONNECT TO ODBC AS MD (&MD);
SELECT COUNT(*) 
FROM CONNECTION TO MD (
      DELETE REFERENCE
      FROM REFERENCE A
      INNER JOIN REFERENCE_DELETE B
            ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
			AND A.DF_PRS_ID_RFR = B.DF_PRS_ID_RFR
      );
DISCONNECT FROM MD;
QUIT;
PROC SQL ;
INSERT INTO DUDE.REFERENCE
      SELECT *
      FROM LOCL_REFERENCE_DELTAS
	  WHERE BC_STA_BR03 = 'A';
QUIT;
OPTIONS NOSOURCE;
%GOODBYE_NULLCHAR(REFERENCE,BC_STA_BR03);
%GOODBYE_NULLCHAR(REFERENCE,BI_ATH_3_PTY);
%GOODBYE_NULLCHAR(REFERENCE,BM_RFR_1);
%GOODBYE_NULLCHAR(REFERENCE,BM_RFR_LST);
%GOODBYE_NULLCHAR(REFERENCE,LST_CNC);
%GOODBYE_NULLCHAR(REFERENCE,LST_ATT);
%GOODBYE_NULLCHAR(REFERENCE,RFR_REL_BR); 

PROC SQL NOPRINT;
      DELETE 
      FROM DUDE.REFERENCE_DELETE 
      ;
QUIT;
OPTIONS SOURCE;
