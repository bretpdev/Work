/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;
%LET RPTLIB = %SYSGET(reportdir);
FILENAME REPORT2 "&RPTLIB/ULW___.LW___R2";*/

libname  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=work  ;
RSUBMIT;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE DEMO AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT A.DF_PRS_ID
,A.BX_CMT
,A.BD_ATY_PRF
,RTRIM(B.dm_prs_lst)||', '||RTRIM(B.dm_prs_1)||' '||RTRIM(B.DM_PRS_MID) AS NAME
FROM  OLWHRM1.AY01_BR_ATY A
INNER JOIN OLWHRM1.PD01_PDM_INF B
	ON A.DF_PRS_ID = B.DF_PRS_ID
WHERE A.PF_ACT = 'GDSST'
AND A.BX_CMT LIKE '%DISCSCRIPT%'
);
DISCONNECT FROM DB2;

DATA DEMO1 (KEEP=DF_PRS_ID NAME BD_ATY_PRF CLUID1)
DEMO2 (WHERE=(CLUID2 NE ' ') KEEP=DF_PRS_ID NAME BD_ATY_PRF CLUID2) ;
SET DEMO;
LENGTH CLUID1 CLUID2 $ 19;
IF SUBSTR(BX_CMT,24,7) = 'LOAN(S)' THEN
DO;
	IF SUBSTR(BX_CMT,50,1) = '1' THEN 
	DO;
		CLUID1 = SUBSTR(BX_CMT,32,19);
		IF SUBSTR(BX_CMT,70,1) = '2' THEN 
		CLUID2 = SUBSTR(BX_CMT,52,19);
	END;
	ELSE IF SUBSTR(BX_CMT,51,1) = '2' 
	THEN CLUID1 = SUBSTR(BX_CMT,33,19);
END;
ELSE IF SUBSTR(BX_CMT,49,4) = 'LOAN' 
THEN CLUID1 = SUBSTR(BX_CMT,54,19);
RUN;

DATA DEMO (RENAME=(CLUID1=CLUID));
SET DEMO1 DEMO2 (RENAME=(CLUID2=CLUID1));
RUN;

PROC SQL;
CREATE TABLE DEMO1 AS
SELECT A.* 
FROM DEMO A
INNER JOIN
	(SELECT CLUID
	FROM DEMO 
	GROUP BY CLUID
	HAVING COUNT(*) > 1
	)B
ON A.CLUID = B.CLUID
;
QUIT;

PROC SORT DATA=DEMO1;
BY DF_PRS_ID CLUID BD_ATY_PRF;
RUN;

PROC TRANSPOSE DATA=DEMO1 OUT=DEMO2 (DROP=_NAME_ _LABEL_) PREFIX=BD_ATY_PRF;
VAR BD_ATY_PRF;
BY DF_PRS_ID CLUID NAME;
RUN;

*RSUBMIT;
PROC SQL STIMER;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE DEMO AS
SELECT *
FROM DEMO2 A
INNER JOIN
    CONNECTION TO DB2 (
    SELECT AF_APL_ID||AF_APL_ID_SFX AS CLUID
    ,AD_PRC
    ,AC_LON_TYP
    ,AA_GTE_LON_AMT
    FROM  OLWHRM1.GA10_LON_APP A
    WHERE AC_PRC_STA = 'A'
    )B
    ON A.CLUID = B.CLUID
;
ENDRSUBMIT;

DATA DEMO;
SET WORKLOCL.DEMO;
SSN = INPUT(DF_PRS_ID,9.);
FORMAT BD_ATY_PRF3 DATE9.;
RUN;

PROC SORT DATA=DEMO;
BY BD_ATY_PRF2 BD_ATY_PRF1 DF_PRS_ID CLUID;
RUN;

DATA _NULL_;
CALL SYMPUT('RUNDATE',PUT(INTNX('DAY',TODAY(),0,'beginning'), MMDDYY10.));
RUN;

/*PROC PRINTTO PRINT=REPORT2;
RUN;*/
OPTIONS CENTER NODATE NUMBER PAGENO=1 LS=126;
PROC PRINT DATA=DEMO NOOBS SPLIT='/' WIDTH=UNIFORM WIDTH=MIN;  
VAR SSN NAME AC_LON_TYP AA_GTE_LON_AMT CLUID BD_ATY_PRF1 BD_ATY_PRF2 BD_ATY_PRF3;  
LABEL SSN="BORROWER SSN" AC_LON_TYP="LOAN TYPE" AA_GTE_LON_AMT="GROSS GTY AMOUNT" 
CLUID="UNIQUE ID" BD_ATY_PRF1="DISCLOSURE DATE #1" BD_ATY_PRF2="DISCLOSURE DATE #2" 
BD_ATY_PRF3="DISCLOSURE DATE #3";
FORMAT AA_GTE_LON_AMT DOLLAR14.2 BD_ATY_PRF1 BD_ATY_PRF2 BD_ATY_PRF3 MMDDYY10.
SSN SSN11.;
BY BD_ATY_PRF2;  
SUMBY BD_ATY_PRF2;  
SUM AA_GTE_LON_AMT;  

TITLE 'DUPLICATE DISCLOSURES CLEAN-UP REPORT';
TITLE2 "&RUNDATE";
FOOTNOTE  'JOB = ON DEMAND     REPORT = DISCLOSURE DUPES';
RUN;