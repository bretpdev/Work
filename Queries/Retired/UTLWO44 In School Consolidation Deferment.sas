*-----------------------------------------------*
| UTLWO44 IN SCHOOL CONSOLIDATION DEFERMENT     |
*-----------------------------------------------*;
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWO44.LWO44R2";
FILENAME REPORTZ "&RPTLIB/ULWO44.LWO44RZ";

DATA _NULL_;
     CALL SYMPUT('PRVDAY',"'"||PUT(INTNX('DAY',TODAY(),-1,'BEGINNING'), MMDDYYD10.)||"'");
	 CALL SYMPUT('TODAY',"'"||PUT(INTNX('DAY',TODAY(),0,'BEGINNING'), MMDDYYD10.)||"'");
RUN;

%SYSLPUT PRVDAY = &PRVDAY;
%SYSLPUT TODAY = &TODAY;
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;

%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE ISCDEF AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.BF_SSN
	,A.LF_STU_SSN
	,SD02.LD_STU_ENR_STA
	,SD02.LD_ENR_CER
	,SD02.LC_STU_ENR_STA 
	,SD02.LC_STU_ENR_TYP 
	,SD02.LD_XPC_GRD
FROM OLWHRM1.LN10_LON A
INNER JOIN OLWHRM1.SD02_STU_ENR SD02
	ON A.LF_STU_SSN = SD02.DF_PRS_ID_STU
WHERE A.IC_LON_PGM IN (
	'SUBSPC','UNSPC','SUBCNS','UNCNS' 
	)
AND A.LA_CUR_PRI > 0
AND A.LD_LON_1_DSB = &PRVDAY
AND SD02.LD_ENR_CER = (
	SELECT MAX(X.LD_ENR_CER)
	FROM OLWHRM1.SD02_STU_ENR X
	WHERE X.DF_PRS_ID_STU = SD02.DF_PRS_ID_STU
	)
AND SD02.LC_STU_ENR_STA = 'I' 
AND SD02.LC_STU_ENR_TYP IN (
	'F','H'
	)
AND SD02.LD_XPC_GRD > &TODAY
AND SD02.LC_STA_SD02 <> 'I'
ORDER BY A.BF_SSN
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWO44.LWO44RZ);*/
/*QUIT;*/
ENDRSUBMIT;

DATA ISCDEF;
SET WORKLOCL.ISCDEF;
RUN;

PROC SORT DATA=ISCDEF;
BY BF_SSN LD_STU_ENR_STA LD_ENR_CER;
RUN;

DATA ISCDEF;
SET ISCDEF;
BY BF_SSN LD_ENR_CER;
IF FIRST.LD_ENR_CER THEN OUTPUT;
RUN;

DATA _NULL_;
SET  WORK.ISCDEF;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
   FORMAT BF_SSN $9. ;
   FORMAT LD_ENR_CER MMDDYY10. ;
   FORMAT LC_STU_ENR_TYP $1. ;
   FORMAT LD_XPC_GRD MMDDYY10. ;
DO;
   PUT BF_SSN $ @;
   PUT LD_XPC_GRD @;
   PUT LC_STU_ENR_TYP $ @;
   PUT LD_ENR_CER ;
   ;
END;
RUN;
