/*=======================================*/
/*UTLWG77 IN SCHOOL ENROLLMENT CORRECTION*/
/*=======================================*/
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWG77.LWG77R2";
FILENAME REPORTZ "&RPTLIB/ULWG77.LWG77RZ";
DATA _NULL_;
     CALL SYMPUT('TODAY',"'"||PUT(INTNX('DAY',TODAY(),0,'BEGINNING'), MMDDYYD10.)||"'");
     CALL SYMPUT('RUNDT',PUT(INTNX('DAY',TODAY(),0,'BEGINNING'), MMDDYYD10.));
RUN;
%SYSLPUT TODAY = &TODAY;
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	FILENAME REPORTZ "&RPTLIB/&SQLRPT";
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE ISEC AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.BF_SSN
	,A.LN_SEQ
	,RTRIM(F.DM_PRS_LST)||', '||F.DM_PRS_1 AS NAME
	,C.PF_REQ_ACT
	,C.LD_ATY_REQ_RCV
	,WVEND.WVEND_DT
	,A.IC_LON_PGM
	,E.LD_SCL_SPR
FROM OLWHRM1.LN10_LON A
INNER JOIN (
	SELECT LN85.BF_SSN
		,LN85.LN_SEQ
		,AY10.PF_REQ_ACT
		,MAX(AY10.LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
	FROM OLWHRM1.LN85_LON_ATY LN85
	INNER JOIN OLWHRM1.AY10_BR_LON_ATY AY10
		ON LN85.BF_SSN = AY10.BF_SSN 
		AND LN85.LN_ATY_SEQ = AY10.LN_ATY_SEQ
	WHERE AY10.LC_STA_ACTY10 = 'A'
	AND AY10.PF_REQ_ACT = 'WVGRC'
	GROUP BY LN85.BF_SSN
		,LN85.LN_SEQ
		,AY10.PF_REQ_ACT
	 ) C
	ON A.BF_SSN = C.BF_SSN 
	AND A.LN_SEQ = C.LN_SEQ
INNER JOIN OLWHRM1.LN13_LON_STU_OSD D
	ON A.BF_SSN = D.BF_SSN
	AND A.LN_SEQ = D.LN_SEQ
INNER JOIN OLWHRM1.SD10_STU_SPR E
	ON D.LF_STU_SSN = E.LF_STU_SSN 
	AND D.LN_STU_SPR_SEQ = E.LN_STU_SPR_SEQ
INNER JOIN OLWHRM1.PD10_PRS_NME F
	ON A.BF_SSN = F.DF_PRS_ID
LEFT OUTER JOIN (
	SELECT LN85.BF_SSN
		,LN85.LN_SEQ
		,MAX(AY10.LD_ATY_REQ_RCV) AS WVEND_DT
	FROM OLWHRM1.LN85_LON_ATY LN85
	INNER JOIN OLWHRM1.AY10_BR_LON_ATY AY10
		ON LN85.BF_SSN = AY10.BF_SSN 
		AND LN85.LN_ATY_SEQ = AY10.LN_ATY_SEQ
	WHERE AY10.LC_STA_ACTY10 = 'A'
	AND AY10.PF_REQ_ACT = 'WVEND'
	GROUP BY LN85.BF_SSN
		,LN85.LN_SEQ
		,AY10.PF_REQ_ACT
	 ) WVEND
	ON A.BF_SSN = WVEND.BF_SSN 
	AND A.LN_SEQ = WVEND.LN_SEQ
WHERE A.LA_CUR_PRI > 0
AND A.IC_LON_PGM IN (
	'UNCNS','SUBCNS','SUBSPC','UNSPC',
	'STFFRD','PLUS','UNSTFD'
	)
AND E.LC_STA_STU10 = 'A'
AND D.LC_STA_LON13 = 'A'
AND E.LD_SCL_SPR > &TODAY
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWG77.LWG77RZ);*/
/*QUIT;*/
ENDRSUBMIT;

DATA ISEC;
SET WORKLOCL.ISEC;
RUN;

DATA ISEC;
SET ISEC;
IF WVEND_DT > LD_ATY_REQ_RCV THEN DELETE;
ELSE OUTPUT;
RUN;

PROC SORT DATA=ISEC;
BY BF_SSN LN_SEQ;
RUN;

PROC PRINTTO PRINT=REPORT2 NEW;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 PAGENO=1 CENTER NODATE;
TITLE 'IN SCHOOL CONSOLIDATION ENROLLMENT CORRECTION';
TITLE2	"RUNDATE &RUNDT";
FOOTNOTE 'JOB = UTLWG77  	 REPORT = ULWG77.LWG77R2';
PROC CONTENTS DATA=ISEC OUT=EMPTYSET NOPRINT;
DATA _NULL_;
SET EMPTYSET;
FILE PRINT;
IF  NOBS=0 AND _N_ =1 THEN DO;
	PUT // 126*'-';
	PUT      //////
		@51 '**** NO OBSERVATIONS FOUND ****';
	PUT ////////
		@57 '-- END OF REPORT --';
	PUT /////////////
		@46 "JOB = UTLWG77  	 REPORT = ULWG77.LWG77R2";
	END;
RETURN;
RUN;
PROC PRINT NOOBS SPLIT='/' DATA=ISEC WIDTH=UNIFORM WIDTH=MIN;
FORMAT LD_ATY_REQ_RCV LD_SCL_SPR MMDDYY10.;
VAR BF_SSN NAME LN_SEQ PF_REQ_ACT LD_ATY_REQ_RCV IC_LON_PGM	LD_SCL_SPR;
LABEL BF_SSN = 'SSN' LN_SEQ = 'LOAN SEQ' PF_REQ_ACT = 'ARC' LD_ATY_REQ_RCV = 'ARC DATE' 
	IC_LON_PGM = 'LOAN TYPE' LD_SCL_SPR = 'SEPARATION DATE';
RUN;
PROC PRINTTO;
RUN;
