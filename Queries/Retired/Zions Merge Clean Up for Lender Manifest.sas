/*DSASO04*/
/*ZIONS MERGE CLEANUP FOR LENDER MANIFEST*/

options symbolgen;

DATA SLMA;
	INFILE 'T:\SAS\lndrmanfst.nelnet.slma.feb05' firstobs = 2 ;

	INPUT SSN $ 10-18
		CLUID $ 54-69 
		LNSTA $ 92-93 
		LNSTADT $ 84-91 
		SCODE $ 163-168 
		SDATE $ 155-162
		CLENDER $ 4-9
		DTLNSOLD $ 176-183
		PRNBAL $ 121-126
		PRNDATE $ 113-120
		INTBAL $ 135-140
		INTDATE $ 127-134
		LNTYP $ 36-37
		GUARDATE $ 38-45
		;
RUN;

DATA SLMA;
SET SLMA;
FORMAT DT $10.;
FORMAT DT2 $10.;
FORMAT DT3 $10.;
FORMAT DT4 $10.;
FORMAT DT5 $10.;
FORMAT DT6 $10.;
FORMAT DT7 $10.;
FORMAT GUARDATEL $10.;
DT = SUBSTR(LNSTADT,5,2) || SUBSTR(LNSTADT,7,2)|| SUBSTR(LNSTADT,1,4);
LNSTADT = DT;
DT2 = SUBSTR(SDATE,5,2) || SUBSTR(SDATE,7,2)|| SUBSTR(SDATE,1,4);
SDATE = DT2;
DT3 = SUBSTR(DTLNSOLD,5,2) || SUBSTR(DTLNSOLD,7,2)|| SUBSTR(DTLNSOLD,1,4);
DTLNSOLD = DT3;
DT4 = SUBSTR(PRNDATE,5,2) || SUBSTR(PRNDATE,7,2)|| SUBSTR(PRNDATE,1,4);
PRNDATE = DT4;
DT5 = SUBSTR(INTDATE,5,2) || SUBSTR(INTDATE,7,2)|| SUBSTR(INTDATE,1,4);
INTDATE = DT5;
DT6 = SUBSTR(GUARDATE,5,2) || SUBSTR(GUARDATE,7,2)|| SUBSTR(GUARDATE,1,4);
DT7 = SUBSTR(GUARDATE,5,2) || "/" || SUBSTR(GUARDATE,7,2)|| "/" || SUBSTR(GUARDATE,1,4);
GUARDATE = DT6;
GUARDATEL = DT7;
RUN;


DATA Q21;
INFILE 'T:\SAS\DSASQ21.R2' DLM="," DSD MISSOVER;
FORMAT CLUID $19.;
FORMAT SSN $9.;
FORMAT LNTYP $2.;
FORMAT GUARDATE $10.;
INPUT SSN $ CLUID $ GUARDATE $ V4 $ LNTYP $ V6 $ V7 $;
RUN;



DATA Q21;
SET Q21;
UID = SUBSTR(CLUID,4);
RUN;

PROC SQL;
CREATE TABLE ZION AS
SELECT B.SSN
	,B.CLUID
	,B.UID
	,A.LNSTA
	,A.LNSTADT
	,A.SCODE
	,A.SDATE
	,A.DTLNSOLD
	,A.CLENDER
	,A.PRNBAL
	,A.PRNDATE
	,A.INTBAL
	,A.INTDATE
FROM SLMA A
INNER JOIN Q21 B
ON B.UID = A.CLUID
AND B.SSN = A.SSN
;
QUIT;

PROC SQL;
CREATE TABLE Q21 AS
SELECT A.*
FROM Q21 A
WHERE A.UID NOT IN (SELECT UID 
					FROM ZION Z
					WHERE Z.SSN = A.SSN
					)
;
QUIT;


PROC SQL;
CREATE TABLE SLMA AS
SELECT A.*
FROM SLMA A
WHERE A.CLUID NOT IN (SELECT Z.UID 
					FROM ZION Z
					WHERE Z.SSN = A.SSN
					)

;
QUIT;
/****************************************/
PROC SQL;
CREATE TABLE ZION2 AS
SELECT B.SSN
	,B.CLUID 
	,A.CLUID AS UID 
	,A.GUARDATEL
	,A.LNTYP
	,A.LNSTA
	,A.LNSTADT
	,A.SCODE
	,A.SDATE
	,A.DTLNSOLD
	,A.CLENDER
	,A.PRNBAL
	,A.PRNDATE
	,A.INTBAL
	,A.INTDATE
FROM SLMA A
INNER JOIN Q21 B
ON B.SSN = A.SSN
AND B.LNTYP = A.LNTYP
AND B.GUARDATE = A.GUARDATEL
;
QUIT;

PROC SQL;
CREATE TABLE Q21 AS
SELECT *
FROM Q21 A
WHERE A.SSN NOT IN (SELECT Z.SSN 
						FROM ZION2 Z
						WHERE Z.GUARDATEL = A.GUARDATE
						AND Z.LNTYP = A.LNTYP)
;
QUIT;


PROC SQL;
CREATE TABLE SLMA AS
SELECT *
FROM SLMA A
WHERE A.SSN NOT IN (SELECT Z.SSN 
						FROM ZION2 Z
						WHERE Z.LNTYP = A.LNTYP
						AND Z.GUARDATEL = A.GUARDATEL)
;
QUIT;


/****************************************/
DATA SLMA;
SET SLMA;
IF GUARDATEL = '00/00/0000' THEN GUARDATEL = '01/01/1960';
IF GUARDATE = . THEN GUARDATEL = '01/01/1960';
RUN;
DATA SLMA;
SET SLMA;

NEWX=INPUT(GUARDATEL,MMDDYY10.); /*CONVERT TO SAS DATE*/
GDATE=PUT(NEWX,MMDDYY10.); /*REFORMAT TO NUMERIC DATE*/


RUN;

DATA Q21;
SET Q21;

NEWX=INPUT(GUARDATE,MMDDYY10.); /*CONVERT TO SAS DATE*/
GDATE=PUT(NEWX,MMDDYY10.); /*REFORMAT TO NUMERIC DATE*/


RUN;
PROC SQL;
CREATE TABLE ZION3 AS
SELECT B.SSN
	,B.CLUID 
	,A.CLUID AS UID 
	,A.GUARDATEL
	,A.NEWX
	,A.LNTYP
	,A.LNSTA
	,A.LNSTADT
	,A.SCODE
	,A.SDATE
	,A.DTLNSOLD
	,A.CLENDER
	,A.PRNBAL
	,A.PRNDATE
	,A.INTBAL
	,A.INTDATE
FROM SLMA A
INNER JOIN Q21 B
ON B.SSN = A.SSN
AND B.LNTYP = A.LNTYP
AND (B.NEWX > A.NEWX - 30 OR B.NEWX < A.NEWX + 30);
QUIT;

PROC SQL;
CREATE TABLE Q21 AS
SELECT *
FROM Q21 A
WHERE A.SSN NOT IN (SELECT Z.SSN 
						FROM ZION3 Z
						WHERE Z.LNTYP = A.LNTYP
						AND (Z.NEWX > A.NEWX - 30 OR Z.NEWX < A.NEWX + 30))
;
QUIT;


PROC SQL;
CREATE TABLE SLMA AS
SELECT *
FROM SLMA A
WHERE A.SSN NOT IN (SELECT Z.SSN 
						FROM ZION3 Z
						WHERE Z.LNTYP = A.LNTYP
						AND (Z.NEWX > A.NEWX - 30 OR Z.NEWX < A.NEWX + 30))
;
QUIT;




DATA ZION;
SET ZION ZION2 ZION3;
RUN;

PROC SQL;
CREATE TABLE OUTCASTS AS
SELECT SSN,CLUID,GUARDATE
FROM Q21;
QUIT;



data _null_;
     set  WORK.Zion;                                   /* end=EFIEOD;*/
     file 'T:\SAS\DSASO04R2.txt' delimiter=',' DSD DROPOVER lrecl=32767;
        format SSN $9. ;
        format CLUID $19. ;
        format LNSTA $2. ;
        format LNSTADT $8. ;
        format SCODE $6. ;
        format SDATE $8. ;
        format DTLNSOLD $8. ;
        format CLENDER $6. ;
        format PRNBAL $6. ;
        format PRNDATE $8. ;
        format INTBAL $6. ;
        format INTDATE $8. ;
      do;
        put SSN $ @;
        put CLUID $ @;
        put LNSTA $ @;
        put LNSTADT $ @;
        put SCODE $ @;
        put SDATE $ @;
        put DTLNSOLD $ @;
        put CLENDER $ @;
        put PRNBAL $ @;
        put PRNDATE $ @;
        put INTBAL $ @;
        put INTDATE $ ;
        ;
      end;
     run;


PROC EXPORT DATA=OUTCASTS
            OUTFILE= "T:\SAS\DSASO04R3.xls" 
            DBMS=EXCEL2000 REPLACE;
RUN;