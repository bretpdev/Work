USE UDW
GO

SELECT
	[Data].BF_SSN,
	COUNT([Data].AF_APL_ID_SFX) AS LoanCount,
	SUM([Data].LA_CLM_BAL) AS LA_CLM_BAL
FROM
(
	SELECT 
		DC02.BF_SSN,
		DC02.AF_APL_ID,
		DC02.AF_APL_ID_SFX,
		SUM(DC02.LA_CLM_BAL) AS LA_CLM_BAL
	FROM 
		ODW..DC02_BAL_INT DC02
		INNER JOIN
		(
			SELECT
				BF_SSN,
				AF_APL_ID,
				AF_APL_ID_SFX,
				MAX(LF_CRT_DTS_DC10) AS LF_CRT_DTS_DC10
			FROM
				ODW..DC02_BAL_INT
			GROUP BY
				BF_SSN,
				AF_APL_ID,
				AF_APL_ID_SFX
		) MaxDC02
			ON DC02.BF_SSN = MaxDC02.BF_SSN
			AND DC02.AF_APL_ID = MaxDC02.AF_APL_ID
			AND DC02.AF_APL_ID_SFX = MaxDC02.AF_APL_ID_SFX
			AND DC02.LF_CRT_DTS_DC10 = MaxDC02.LF_CRT_DTS_DC10
	WHERE
		DC02.BF_SSN IN ('244236267','493925914','505210081','513684057','517907511','518139827','521373193','527218356','528438040','528455785','528457711','528499206','528510905','528538245','528631106','528753781','528785398','528812678','528848127','528851210','528852429','529193272','529230050','529310835','529518435','529572261','529772693','529774770','529838073','529861474','529897295','529963492','529973402','537080617','563977600','573372177','575172760','585840075','600607645','607145534','617246973','625106843','642073042')
	GROUP BY
		DC02.BF_SSN,
		DC02.AF_APL_ID,
		DC02.AF_APL_ID_SFX
) [Data]
GROUP BY
	[Data].BF_SSN
ORDER BY
	[Data].BF_SSN
