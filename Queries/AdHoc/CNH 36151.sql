DECLARE @BEGIN AS DATE = 'XXXX-XX-XX'
DECLARE @END AS DATE = GETDATE()
DECLARE @SCHOOL AS VARCHAR(XX) = 'XXXXXXXX'

--closed school
SELECT  DISTINCT
	LNXX.BF_SSN
	,LNXX.LN_SEQ
	,LNXX.LA_CUR_PRI
	,(CASE WHEN CSFSA.BF_SSN IS NOT NULL AND ADCSH.BF_SSN IS NULL AND CSDNY.BF_SSN IS NULL THEN X ELSE X END) AS PENDING
	,(CASE WHEN ADCSH.BF_SSN IS NOT NULL THEN X ELSE X END) AS APPROVED
	,(CASE WHEN CSDNY.BF_SSN IS NOT NULL THEN X ELSE X END) AS DENIED
FROM
	CDW..LNXX_LON LNXX
	INNER JOIN
	(
		SELECT DISTINCT
			AYXX.BF_SSN
		FROM
			CDW..AYXX_BR_LON_ATY AYXX
		WHERE
			AYXX.LD_ATY_REQ_RCV BETWEEN  @BEGIN AND @END
			AND AYXX.PF_REQ_ACT = 'DICSK'
	) DICSK
		ON DICSK.BF_SSN = LNXX.BF_SSN
	LEFT JOIN
	(
		SELECT DISTINCT
			AYXX.BF_SSN
		FROM
			CDW..AYXX_BR_LON_ATY AYXX
		WHERE
			AYXX.LD_ATY_REQ_RCV BETWEEN  @BEGIN AND @END
			AND AYXX.PF_REQ_ACT = 'CSFSA'
	) CSFSA
		ON DICSK.BF_SSN = CSFSA.BF_SSN
	LEFT JOIN
	(
		SELECT DISTINCT
			AYXX.BF_SSN
		FROM
			CDW..AYXX_BR_LON_ATY AYXX
		WHERE
			AYXX.LD_ATY_REQ_RCV BETWEEN  @BEGIN AND @END
			AND AYXX.PF_REQ_ACT = 'ADCSH'
	) ADCSH
		ON DICSK.BF_SSN = ADCSH.BF_SSN
	LEFT JOIN
	(
		SELECT DISTINCT
			AYXX.BF_SSN
		FROM
			CDW..AYXX_BR_LON_ATY AYXX
		WHERE
			AYXX.LD_ATY_REQ_RCV BETWEEN  @BEGIN AND @END
			AND AYXX.PF_REQ_ACT = 'CSDNY'
	) CSDNY
		ON DICSK.BF_SSN = CSDNY.BF_SSN
WHERE
	LNXX.LF_DOE_SCL_ORG = @SCHOOL


SELECT DISTINCT
	SUM(CASE WHEN CSFSA.BF_SSN IS NOT NULL AND ADCSH.BF_SSN IS NULL AND CSDNY.BF_SSN IS NULL THEN X ELSE X END) AS PENDING
	,SUM(CASE WHEN ADCSH.BF_SSN IS NOT NULL THEN X ELSE X END) AS APPROVED
	,SUM(CASE WHEN CSDNY.BF_SSN IS NOT NULL THEN X ELSE X END) AS DENIED
FROM
	CDW..LNXX_LON LNXX
	INNER JOIN
	(
		SELECT DISTINCT
			AYXX.BF_SSN
		FROM
			CDW..AYXX_BR_LON_ATY AYXX
		WHERE
			AYXX.LD_ATY_REQ_RCV BETWEEN  @BEGIN AND @END
			AND AYXX.PF_REQ_ACT = 'DICSK'
	) DICSK
		ON DICSK.BF_SSN = LNXX.BF_SSN
	LEFT JOIN
	(
		SELECT DISTINCT
			AYXX.BF_SSN
		FROM
			CDW..AYXX_BR_LON_ATY AYXX
		WHERE
			AYXX.LD_ATY_REQ_RCV BETWEEN  @BEGIN AND @END
			AND AYXX.PF_REQ_ACT = 'CSFSA'
	) CSFSA
		ON DICSK.BF_SSN = CSFSA.BF_SSN
	LEFT JOIN
	(
		SELECT DISTINCT
			AYXX.BF_SSN
		FROM
			CDW..AYXX_BR_LON_ATY AYXX
		WHERE
			AYXX.LD_ATY_REQ_RCV BETWEEN  @BEGIN AND @END
			AND AYXX.PF_REQ_ACT = 'ADCSH'
	) ADCSH
		ON DICSK.BF_SSN = ADCSH.BF_SSN
	LEFT JOIN
	(
		SELECT DISTINCT
			AYXX.BF_SSN
		FROM
			CDW..AYXX_BR_LON_ATY AYXX
		WHERE
			AYXX.LD_ATY_REQ_RCV BETWEEN  @BEGIN AND @END
			AND AYXX.PF_REQ_ACT = 'CSDNY'
	) CSDNY
		ON DICSK.BF_SSN = CSDNY.BF_SSN
WHERE
	LNXX.LF_DOE_SCL_ORG = @SCHOOL

	