USE CDW
GO


SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
IF OBJECT_ID('tempdb..#BASE_POP') IS NOT NULL 
	DROP TABLE #BASE_POP

IF OBJECT_ID('tempdb..#FINAL_POP') IS NOT NULL 
	DROP TABLE #FINAL_POP

SELECT DISTINCT
	LN80.BF_SSN,
	LN80.LN_SEQ,
	LN80.LD_BIL_CRT,
	LN80.LN_SEQ_BIL_WI_DTE,
	LN80.LN_BIL_OCC_SEQ,
	LN80.LC_STA_LON80,
	LN80.LA_BIL_DU_PRT,
	SUM(CASE WHEN LC_STA_LON80 = 'A' THEN 0 ELSE 1 END) OVER (PARTITION BY LN80.BF_SSN, LN80.LN_SEQ) AS REC_POP
INTO #BASE_POP
FROM
	CLS..DueDateChange DDC
	INNER JOIN CDW..LN80_LON_BIL_CRF LN80
		ON LN80.BF_SSN = DDC.Ssn
WHERE
	CAST(ProcessedAt AS DATE) > '03/13/2018'
	AND Successful = 1
	AND LD_BIL_DU_LON BETWEEN '03/20/2018' AND '03/27/2018'
ORDER BY 
	LN80.BF_SSN

SELECT DISTINCT
	BF_SSN, 
	LC_STA_LON80,
	SUM(ISNULL(LA_BIL_DU_PRT,0)) OVER (PARTITION BY BF_SSN, LC_STA_LON80) AS BIL_AMT
INTO #FINAL_POP
FROM 
	#BASE_POP 
WHERE 
	REC_POP != 0 
ORDER BY 
	BF_SSN

SELECT 
	PD10.DF_SPE_ACC_ID,
	FP.BF_SSN,
	(FP.BIL_AMT - FPS.BIL_AMT) AS DIFF 
FROM 
	#FINAL_POP FP
	INNER JOIN #FINAL_POP FPS
		ON FP.BF_SSN = FPS.BF_SSN
		AND FPS.LC_STA_LON80 = 'I'
	LEFT JOIN CDW..PD10_PRS_NME PD10
		ON PD10.DF_PRS_ID = FP.BF_SSN
WHERE 
	FP.BIL_AMT > 0
	AND FP.LC_STA_LON80 = 'A'
	AND FPS.LC_STA_LON80 = 'I'
	AND (FP.BIL_AMT - FPS.BIL_AMT) != 0.00
	AND (FP.BIL_AMT - FPS.BIL_AMT) > 100
ORDER BY
	DIFF DESC
