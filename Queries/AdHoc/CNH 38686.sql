--QUERY X
--Find loans that have an active XX-Post Enrollment Deferment on a DLPLUS or DLPLGB loan disbursed prior to X/X/XXXX.

SELECT DISTINCT	
	PDXX.DF_SPE_ACC_ID,
	LNXX.LN_SEQ
FROM
	CDW..PDXX_PRS_NME PDXX
	INNER JOIN CDW..LNXX_LON LNXX
		ON PDXX.DF_PRS_ID = LNXX.BF_SSN
	INNER JOIN CDW..LNXX_BR_DFR_APV LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN CDW..DFXX_BR_DFR_REQ DFXX
		ON LNXX.BF_SSN = DFXX.BF_SSN
		AND LNXX.LF_DFR_CTL_NUM = DFXX.LF_DFR_CTL_NUM
WHERE
	LNXX.IC_LON_PGM IN ('DLPLUS','DLPLGB')
	AND LNXX.LD_LON_X_DSB < 'XXXX-XX-XX'
	AND LNXX.LA_CUR_PRI > X.XX
	AND LNXX.LC_STA_LONXX = 'R'
	AND LNXX.LC_STA_LONXX = 'A'
	AND DFXX.LC_DFR_TYP = 'XX'
	AND DFXX.LC_DFR_STA = 'A'
	AND LNXX.LC_DFR_RSP != 'XXX'

--QUERY X
--find loans that have multiple active XX-Post Enrollment Deferments back-to-back where the Total Months Used is >X months (any loan program). No deferment between them.

DROP TABLE IF EXISTS #DEFS

--select into temp table
SELECT 
	LNXX.BF_SSN, 
	LNXX.LN_SEQ, 
	LNXX.LF_DFR_CTL_NUM, 
	LNXX.LD_DFR_BEG,
	LNXX.LD_DFR_END,
	NextDefer.LD_DFR_BEG AS NXT_LD_DFR_BEG, 
	NextDefer.LD_DFR_END AS NXT_LD_DFR_END
INTO 
	#DEFS
FROM 
	CDW..LNXX_LON LNXX
	INNER JOIN CDW..LNXX_BR_DFR_APV LNXX 
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN CDW..DFXX_BR_DFR_REQ DFXX 
		ON DFXX.BF_SSN = LNXX.BF_SSN 
		AND DFXX.LF_DFR_CTL_NUM = LNXX.LF_DFR_CTL_NUM 
	INNER JOIN
	(
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			LNXX.LD_DFR_BEG,
			LNXX.LD_DFR_END
		FROM
			CDW..LNXX_BR_DFR_APV LNXX
			INNER JOIN CDW..DFXX_BR_DFR_REQ DFXX
				ON DFXX.BF_SSN = LNXX.BF_SSN 
				AND DFXX.LF_DFR_CTL_NUM = LNXX.LF_DFR_CTL_NUM
		WHERE
			LNXX.LC_DFR_RSP != 'XXX'
			AND LNXX.LC_STA_LONXX = 'A'
			AND DFXX.LC_STA_DFRXX = 'A'
			AND DFXX.LC_DFR_STA = 'A'
			AND DFXX.LC_DFR_TYP = 'XX'
	) NextDefer
		ON NextDefer.BF_SSN = LNXX.BF_SSN
		AND NextDefer.LN_SEQ = LNXX.LN_SEQ
		AND NextDefer.LD_DFR_BEG = DATEADD(DAY,X,LNXX.LD_DFR_END)
WHERE
	LNXX.LA_CUR_PRI > X.XX
	AND LNXX.LC_STA_LONXX = 'R'
	AND LNXX.LC_DFR_RSP != 'XXX'
	AND LNXX.LC_STA_LONXX = 'A'
	AND DFXX.LC_STA_DFRXX = 'A'
	AND DFXX.LC_DFR_STA = 'A'
	AND DFXX.LC_DFR_TYP = 'XX'

	--final results
SELECT DISTINCT
	MOCALC.DF_SPE_ACC_ID,
	MOCALC.LN_SEQ
FROM
	(
		--months calculation
		SELECT
		PDXX.DF_SPE_ACC_ID,
		[Data].*,
			SUM
			(
				FLOOR(CAST(DATEDIFF(DAY,LD_DFR_BEG, NXT_LD_DFR_END) AS DECIMAL(XX,X))/CAST(XX AS DECIMAL(XX,X))) + --number of full months difference
				CASE WHEN CAST(DATEDIFF(DAY,LD_DFR_BEG, NXT_LD_DFR_END) AS DECIMAL(XX,X))/CAST(XX AS DECIMAL(XX,X)) % X > .XX --requires X / X the month to have passed to count 
					THEN X --Counts X additional month if we are at least XX% through an additional month
					ELSE X 
				END
			) AS AccurateMOS
		FROM
			(
				SELECT 
					BF_SSN, 
					LN_SEQ,
					MIN(LD_DFR_BEG) LD_DFR_BEG,
					MAX(NXT_LD_DFR_END) NXT_LD_DFR_END,
					DATEDIFF(MONTH, MIN(LD_DFR_BEG), MAX(NXT_LD_DFR_END)) AS MOS,
					(DATEDIFF(DAY, MIN(LD_DFR_BEG), MAX(NXT_LD_DFR_END)))/XX.XX AS MOSbyXX
				FROM 
					#DEFS 
				GROUP BY 
					BF_SSN, 
					LN_SEQ 
			) [Data]
			INNER JOIN CDW..PDXX_PRS_NME PDXX
				ON [Data].BF_SSN = PDXX.DF_PRS_ID
		GROUP BY
			PDXX.DF_SPE_ACC_ID,
			[Data].BF_SSN,
			[Data].LN_SEQ,
			[Data].MOS,
			[Data].MOSbyXX,
			[Data].LD_DFR_BEG,
			[Data].NXT_LD_DFR_END
	) MOCALC
WHERE
	MOCALC.MOSbyXX > X

	--QUERY X detail
--SELECT
--	*
--FROM
--	CDW..LNXX_BR_DFR_APV LNXX
--	INNER JOIN CDW..DFXX_BR_DFR_REQ DFXX
--		ON DFXX.BF_SSN = LNXX.BF_SSN
--		AND DFXX.LF_DFR_CTL_NUM = LNXX.LF_DFR_CTL_NUM
--	INNER JOIN #DEFS D
--		ON D.BF_SSN = LNXX.BF_SSN
--		AND D.LN_SEQ = LNXX.LN_SEQ
--WHERE
--	LNXX.LC_DFR_RSP != 'XXX'
--	AND LNXX.LC_STA_LONXX = 'A'
--	AND DFXX.LC_STA_DFRXX = 'A'
--	AND DFXX.LC_DFR_STA = 'A'
--	AND DFXX.LC_DFR_TYP = 'XX'
--ORDER BY
--	LNXX.BF_SSN,
--	LNXX.LN_SEQ,
--	LNXX.LD_DFR_BEG