/*CREATE LIBNAME FOR REMOTE SERVER'S WORK FOLDER*/
LIBNAME WORKLOCL REMOTE SERVER=LEGEND SLIBREF=WORK;

/*CREATE FILENAME FOR OUTPUT*/
%LET RPTLIB = T:\SAS;
FILENAME REPORTX "&RPTLIB/CNH_XXXXX.XLSX"; 

/*CREATE LIBRARY OF EXCEL DATA*/
LIBNAME XLIB XLSX 'T:\SAS\UPDATED_TypeXXADJ.xlsx'; 

/*CREATE DATA SET FROM A SPECIFIC SHEET IN THE EXCEL FILE*/
DATA XLDATA; SET XLIB.ADXX; RUN; 

/*COPY EXCEL DATA TO REMOTE SERVER*/
DATA WORKLOCL.XDATA; SET XLDATA; RUN;

/*SUBMIT CODE TO REMOTE SERVER*/
RSUBMIT LEGEND;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;
LIBNAME AES DBX DATABASE=DNFPUTDL OWNER=AES;
%let DB = DNFPUTDL;
%let OWNR = PKUB;

PROC SQL STIMER;
	CONNECT TO DBX (DATABASE=&DB); 

/*	GET DATA FOR ALL LOANS*/
	CREATE TABLE JOINDATA AS
		SELECT 
			XDAT.*
			,DBXD.LD_LON_EFF_ADD

		FROM 
			CONNECTION TO DBX 
			(
				SELECT DISTINCT 
					LNXX.BF_SSN 
					,LNXX.LN_SEQ
					,LNXX.LD_LON_EFF_ADD
				FROM 
					&OWNR..LNXX_LON LNXX
		
				FOR READ ONLY WITH UR
			) DBXD
			INNER JOIN XDATA XDAT
				ON DBXD.BF_SSN = XDAT.BF_SSN
				AND DBXD.LN_SEQ = XDAT.LN_SEQ
	;
	DISCONNECT FROM DBX;


QUIT;

ENDRSUBMIT;

/*COPY JOINED DATA TO WORK*/
DATA JOINDATA; SET WORKLOCL.JOINDATA; RUN;

/*EXPORT JOINED DATA TO A REPORT*/
PROC EXPORT DATA= WORK.JOINDATA
	OUTFILE= REPORTX 
	REPLACE
	DBMS=XLSX;
RUN;
