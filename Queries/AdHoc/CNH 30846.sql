USE [CDW]
GO
/****** Object:  StoredProcedure [dbo].[GetPreTransferData]    Script Date: X/X/XXXX XX:XX:XX PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[GetPreTransferData]
	@LetterId varchar(XX)
AS

SELECT
	LTXX.LTXX_LETTER_REQUEST_ID [LetterRequestId],
	LTXX.RM_DSC_LTR_PRC [LetterId],
	LTXX.DF_SPE_ACC_ID [AccountNumber],
	LTXX.RF_SBJ_PRC [Ssn],
	CASE WHEN PHXX.[DI_CNC_ELT_OPI] = ' ' THEN X
		 ELSE ISNULL(PHXX.[DI_CNC_ELT_OPI], X)
	END [OnEcorr],
	ISNULL(PHXX.DI_VLD_CNC_EML_ADR, X) [ValidEcorrEmail],
	ISNULL(PHXX.DX_CNC_EML_ADR, '') [Email],
	PDXX.DM_PRS_X [FirstName],
	PDXX.DM_PRS_LST [LastName],
	PDXX.DX_STR_ADR_X [AddressX],
	PDXX.DX_STR_ADR_X [AddressX],
	PDXX.DM_CT [City],
	PDXX.DC_DOM_ST [State],
	PDXX.DF_ZIP_CDE [Zip],
	PDXX.DM_FGN_CNY[Country],
	PDXX.DI_VLD_ADR [ValidAddress],
	PS.LoanSaleStatus,
	PS.RegionDeconversion,
	PS.SellingOwnerId,
	PS.TransferDate,
	PS.DelayCancelCode,
	LNXX.LC_STA_LNXX [AchStatus],
	LNXX.LC_EFT_SUS_REA [AchSuspensionReason],
	LNXX.LD_FAT_EFF [LastPaymentDate],
	LNXX.LC_RMT_BCH_SRC_IPT [LastPaymentSource],
	RMXX.LC_RMT_PAY_SRC [LastPaymentSubSource],
	LNXX.DUE_DAY [DueDay]
FROM
	LTXX_LetterRequests LTXX
	LEFT JOIN PDXX_PRS_NME PDXX ON PDXX.DF_PRS_ID = LTXX.RF_SBJ_PRC
	LEFT JOIN PDXX_PRS_ADR PDXX ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
	LEFT JOIN PHXX_CNC_EML PHXX ON PHXX.DF_SPE_ID = PDXX.DF_SPE_ACC_ID
	LEFT JOIN 
	(--Presale info
		SELECT DISTINCT
			COALESCE(WKXJ.BF_SSN, LNXX.BF_SSN, 'Borrower Ssn Not Found') [BF_SSN],
			COALESCE(WKXJ.IF_LON_SLE, LNXX.IF_LON_SLE, 'Loan Sale Not Found') [IF_LON_SLE],
			OWXX.IC_LON_SLE_STA  AS [LoanSaleStatus],
			OWXX.IC_RGN_RCV_DCV_LON AS [RegionDeconversion],
			OWXX.IF_SLL_OWN AS [SellingOwnerId],
			OWXX.ID_LON_SLE AS [TransferDate],
			OWXX.IC_DLA_CAN_LTR AS [DelayCancelCode]
		FROM
			WKXJ_LON_SLE_PLR WKXJ
			LEFT JOIN LNXX_LON_SLE_FAT LNXX ON WKXJ.BF_SSN = LNXX.BF_SSN AND LNXX.LN_SEQ = WKXJ.LN_SEQ
			LEFT JOIN OWXX_LON_SLE_CTL OWXX ON OWXX.IF_LON_SLE = COALESCE(WKXJ.IF_LON_SLE, LNXX.IF_LON_SLE, 'Loan Sale Not Found')
		WHERE
			ISNULL(LNXX.LF_LST_DTS_LNXX, GETDATE()) > DATEADD(DAY, -XX, GETDATE())
	) PS ON PS.BF_SSN = PDXX.DF_PRS_ID
	LEFT JOIN 
	(
		SELECT
			LC_STA_LNXX,
			LC_EFT_SUS_REA,
			BF_SSN,
			LN_SEQ,
			LD_EFT_EFF_BEG,
			ROW_NUMBER() OVER(PARTITION BY BF_SSN ORDER BY BF_SSN, LD_EFT_EFF_BEG DESC) [MaxFlag]
		FROM
			LNXX_EFT_TO_LON
		WHERE
			LD_EFT_EFF_BEG <= GETDATE()
			AND 
			ISNULL(LD_EFT_EFF_END, DATEADD(DAY, X, GETDATE())) > GETDATE() --If we don't know what the date is, then the date is not set so use tomorrow's date
		) LNXX ON LTXX.RF_SBJ_PRC = LNXX.BF_SSN	AND LNXX.MaxFlag = X
	LEFT JOIN
	(
		SELECT
			LNXX.BF_SSN,
			LD_FAT_EFF,
			LN_SEQ,
			LN_FAT_SEQ,
			ROW_NUMBER() OVER (PARTITION BY LNXX.BF_SSN ORDER BY LD_FAT_EFF DESC) [MaxFlag]
		FROM
			LNXX_FIN_ATY LNXX
		WHERE
			LC_STA_LONXX = 'A'
			AND (LC_FAT_REV_REA = '' OR LC_FAT_REV_REA IS NULL)
			AND PC_FAT_TYP = 'XX'
			AND PC_FAT_SUB_TYP = 'XX'
	) LNXX ON LNXX.BF_SSN = PDXX.DF_PRS_ID AND LNXX.MaxFlag = X
	LEFT JOIN LNXX_LON_PAY_FAT LNXX ON LTXX.RF_SBJ_PRC = LNXX.BF_SSN AND LNXX.LN_SEQ = LNXX.LN_SEQ AND LNXX.LN_FAT_SEQ = LNXX.LN_FAT_SEQ
	LEFT JOIN RMXX_BR_RMT RMXX ON LNXX.LD_RMT_BCH_INI = RMXX.LD_RMT_BCH_INI
		AND LNXX.LC_RMT_BCH_SRC_IPT = RMXX.LC_RMT_BCH_SRC_IPT
		AND LNXX.LN_RMT_BCH_SEQ = RMXX.LN_RMT_BCH_SEQ
		AND LNXX.LN_RMT_SEQ = RMXX.LN_RMT_SEQ
		AND LNXX.LN_RMT_ITM = RMXX.LN_RMT_ITM
		AND LNXX.LN_RMT_ITM_SEQ = RMXX.LN_RMT_ITM_SEQ
		AND LTXX.RF_SBJ_PRC = RMXX.BF_SSN
	LEFT JOIN LNXX_RepaymentSched LNXX ON LNXX.DF_SPE_ACC_ID = LTXX.DF_SPE_ACC_ID
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
WHERE
    LTXX.RM_DSC_LTR_PRC = @LetterId
    AND LTXX.PrintedAt IS NULL
    AND LTXX.InactivatedAt IS NULL 
RETURN X

