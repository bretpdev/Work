/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
LIBNAME  DUSTER  REMOTE  SERVER=DUSTER  SLIBREF=WORK; /*live*/
/*LIBNAME  DUSTER  REMOTE  SERVER=QADBD004 SLIBREF=WORK ;*/ /*test*/

RSUBMIT;

%MACRO SQLCHECK ;
  %IF  &SQLXRC NE 0  %THEN  %DO  ;
    DATA _NULL_  ;
            FILE REPORTZ NOTITLES  ;
            PUT @01 " ********************************************************************* "
              / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
              / @01 " ****  THE SAS SHOULD BE REVIEWED.                                **** "       
              / @01 " ********************************************************************* "
              / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
              / @01 " ****  &SQLXMSG   **** "
              / @01 " ********************************************************************* "
            ;
         RUN  ;
  %END  ;
%MEND  ;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH); /*DLGSWQUT TEST*//*DLGSUTWH LIVE*/
CREATE TABLE RS10_Delete AS
SELECT 
	*
FROM CONNECTION TO DB2 
	(
		SELECT DISTINCT
			RS10.BF_SSN,
			RS10.LN_RPS_SEQ
		FROM
			OLWHRM1.LN10_LON LN10
			INNER JOIN OLWHRM1.LN65_LON_RPS LN65
				ON LN10.BF_SSN = LN65.BF_SSN
				AND LN10.LN_SEQ = LN65.LN_SEQ
			INNER JOIN OLWHRM1.RS10_BR_RPD RS10
				ON RS10.BF_SSN = LN65.BF_SSN
				AND RS10.LN_RPS_SEQ = LN65.LN_RPS_SEQ
			INNER JOIN OLWHRM1.LN30_LON_ERR LN30
				ON LN30.BF_SSN = LN10.BF_SSN
				AND LN30.LN_SEQ = LN10.LN_SEQ
				AND LN30.LC_STA_LON30 = 'A'
			LEFT OUTER JOIN 
				(
					SELECT
						LN65I.BF_SSN,
						LN65I.LN_SEQ,
						LN65I.LN_RPS_SEQ
					FROM
						OLWHRM1.RS10_BR_RPD RS10I
						INNER JOIN OLWHRM1.LN65_LON_RPS LN65I
							ON RS10I.BF_SSN = LN65I.BF_SSN
							AND RS10I.LN_RPS_SEQ = LN65I.LN_RPS_SEQ
						INNER JOIN OLWHRM1.LN10_LON LN10I
							ON LN10I.BF_SSN = LN65I.BF_SSN
							AND LN10I.LN_SEQ = LN65I.LN_SEQ
							AND LN10I.LA_CUR_PRI > 0 /*if there is a loan with a balance, dont delete RS10*/
				) HasLoanWithBal
				ON HasLoanWithBal.BF_SSN = LN10.BF_SSN
				AND HasLoanWithBal.LN_SEQ = LN10.LN_SEQ
			LEFT OUTER JOIN 
				(
					SELECT
						LN65I.BF_SSN,
						LN65I.LN_SEQ,
						LN65I.LN_RPS_SEQ
					FROM
						OLWHRM1.RS10_BR_RPD RS10I
						INNER JOIN OLWHRM1.LN65_LON_RPS LN65I
							ON RS10I.BF_SSN = LN65I.BF_SSN
							AND RS10I.LN_RPS_SEQ = LN65I.LN_RPS_SEQ
						LEFT OUTER JOIN 
							(	
								SELECT 
									LN10I.BF_SSN,
									LN10I.LN_SEQ
								FROM
									OLWHRM1.LN10_LON LN10I
								WHERE
									LN10I.LA_CUR_PRI = 0 /*Find loans without a balance*/
							) LN10I 
							ON LN10I.BF_SSN = LN65I.BF_SSN
							AND LN10I.LN_SEQ = LN65I.LN_SEQ
					WHERE
						LN10I.BF_SSN IS NULL /*NO LOANS ARE PAID OFF SO ALL SHOULD HAVE A BALANCE*/
				) AllLoansHaveBal
				ON AllLoansHaveBal.BF_SSN = LN10.BF_SSN
				AND AllLoansHaveBal.LN_SEQ = LN10.LN_SEQ
		WHERE
			LN30.PF_ERR_MSG = '05729'
			AND (AllLoansHaveBal.BF_SSN IS NOT NULL OR HasLoanWithBal.BF_SSN IS NULL)
	)
;

CREATE TABLE LN65_Delete AS
SELECT 
	*
FROM CONNECTION TO DB2 
	(
		SELECT DISTINCT
			LN65.BF_SSN,
			LN65.LN_SEQ,
			LN65.LN_RPS_SEQ
		FROM
			OLWHRM1.LN10_LON LN10
			INNER JOIN OLWHRM1.LN65_LON_RPS LN65
				ON LN65.BF_SSN = LN10.BF_SSN
				AND LN65.LN_SEQ = LN10.LN_SEQ
			INNER JOIN OLWHRM1.LN30_LON_ERR LN30
				ON LN30.BF_SSN = LN65.BF_SSN
				AND LN30.LN_SEQ = LN65.LN_SEQ
				AND LN30.LC_STA_LON30 = 'A'
		WHERE
			LN30.PF_ERR_MSG = '05729'
			AND(
				LN10.LA_CUR_PRI = 0
				OR DAYS(LN10.LD_END_GRC_PRD) > DAYS(CURRENT DATE)
				)
	)
;

CREATE TABLE LN66_Delete AS
SELECT 
	*
FROM CONNECTION TO DB2 
	(
		SELECT DISTINCT
			LN66.BF_SSN,
			LN66.LN_SEQ,
			LN66.LN_RPS_SEQ,
			LN66.LN_GRD_RPS_SEQ
		FROM
			OLWHRM1.LN10_LON LN10
			INNER JOIN OLWHRM1.LN66_LON_RPS_SPF LN66
				ON LN66.BF_SSN = LN10.BF_SSN
				AND LN66.LN_SEQ = LN10.LN_SEQ
			INNER JOIN OLWHRM1.LN30_LON_ERR LN30
				ON LN30.BF_SSN = LN66.BF_SSN
				AND LN30.LN_SEQ = LN66.LN_SEQ
				AND LN30.LC_STA_LON30 = 'A'
		WHERE
			LN30.PF_ERR_MSG = '05729'
			AND(
				LN10.LA_CUR_PRI = 0
				OR DAYS(LN10.LD_END_GRC_PRD) > DAYS(CURRENT DATE)
				)
	)
;

CREATE TABLE RS05_Delete AS
SELECT 
	*
FROM CONNECTION TO DB2 
	(
		SELECT DISTINCT
			RS05.BF_SSN,
			RS05.BD_CRT_RS05,
			RS05.BN_IBR_SEQ
		FROM
			OLWHRM1.LN10_LON LN10
			INNER JOIN OLWHRM1.RS05_IBR_RPS RS05
				ON RS05.BF_SSN = LN10.BF_SSN
			INNER JOIN OLWHRM1.LN30_LON_ERR LN30
				ON LN30.BF_SSN = RS05.BF_SSN
				AND LN30.LN_SEQ = LN10.LN_SEQ
				AND LN30.LC_STA_LON30 = 'A'
		WHERE
			LN30.PF_ERR_MSG = '05729'
			AND(
				LN10.LA_CUR_PRI = 0
				OR DAYS(LN10.LD_END_GRC_PRD) > DAYS(CURRENT DATE)
				)
	)
;

DISCONNECT FROM DB2;

%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>> ;  
%SQLCHECK;
QUIT;

ENDRSUBMIT;

DATA RS10_Delete;
	SET DUSTER.RS10_Delete;
RUN;
DATA LN65_Delete;
	SET DUSTER.LN65_Delete;
RUN;
DATA LN66_Delete;
	SET DUSTER.LN66_Delete;
RUN;
DATA RS05_Delete;
	SET DUSTER.RS05_Delete;
RUN;


PROC EXPORT DATA= WORK.RS10_Delete 
            OUTFILE= "T:\SAS\NH 25695.xls" 
            DBMS=EXCEL REPLACE;
     SHEET="RS10_Delete"; 
RUN;

PROC EXPORT DATA= WORK.LN65_Delete 
            OUTFILE= "T:\SAS\NH 25695.xls" 
            DBMS=EXCEL REPLACE;
     SHEET="LN65_Delete"; 
RUN;

PROC EXPORT DATA= WORK.LN66_Delete 
            OUTFILE= "T:\SAS\NH 25695.xls" 
            DBMS=EXCEL REPLACE;
     SHEET="LN66_Delete"; 
RUN;

PROC EXPORT DATA= WORK.RS05_Delete 
            OUTFILE= "T:\SAS\NH 25695.xls" 
            DBMS=EXCEL REPLACE;
     SHEET="RS05_Delete"; 
RUN;
