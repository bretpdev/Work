LIBNAME  DUSTER  REMOTE  SERVER=DUSTER  SLIBREF=WORK;
RSUBMIT;

PROC SQL;
	CONNECT TO DB2 (DATABASE=DLGSUTWH);

	CREATE TABLE DEMO AS
		SELECT 
			*
		FROM 
			CONNECTION TO DB2 
				(
					SELECT
						TRIM(PD01_B.DM_PRS_1) || ' ' || TRIM(PD01_B.DM_PRS_LST) AS BRW_NAME,
						PD01_B.DF_PRS_ID AS BRW_SSN,
						TRIM(PD01_C.DM_PRS_1) || ' ' || TRIM(PD01_C.DM_PRS_LST) AS COBRW_NAME,
						PD01_C.DF_PRS_ID AS COBRW_SSN,
						LN10.LN_SEQ,
						LN50.LD_DFR_BEG,
						LN50.LD_DFR_END,
						LN10.LA_CUR_PRI - COALESCE(LN90.LA_FAT_CUR_PRI,0) AS LA_FAT_CUR_PRI,
						LN50.LD_DFR_APL,
						LN10.LD_LON_EFF_ADD
					FROM	
						OLWHRM1.PD01_PDM_INF PD01_B
						JOIN OLWHRM1.LN10_LON LN10
							ON PD01_B.DF_PRS_ID = LN10.BF_SSN
						JOIN OLWHRM1.LN20_EDS LN20
							ON LN10.BF_SSN = LN20.BF_SSN
							AND LN10.LN_SEQ = LN20.LN_SEQ
							AND LN20.LC_EDS_TYP = 'M'
							AND LN20.LC_STA_LON20 = 'A'
						JOIN OLWHRM1.PD01_PDM_INF PD01_C
							ON LN20.LF_EDS = PD01_C.DF_PRS_ID
						JOIN OLWHRM1.LN50_BR_DFR_APV LN50
							ON LN10.BF_SSN = LN50.BF_SSN
							AND LN10.LN_SEQ = LN50.LN_SEQ
							AND LN50.LC_STA_LON50 = 'A'
							AND 
								(
									'2012-10-01' BETWEEN LN50.LD_DFR_BEG AND LN50.LD_DFR_END
									OR
									LN50.LD_DFR_BEG BETWEEN '2012-10-01' AND '2013-09-30'
								)
						JOIN 
							(
								SELECT
									LN90.BF_SSN,
									LN90.LN_SEQ,
									SUM(LN90.LA_FAT_CUR_PRI) AS LA_FAT_CUR_PRI
								FROM
									OLWHRM1.LN90_FIN_ATY LN90
									JOIN OLWHRM1.LN50_BR_DFR_APV LN50
										ON LN90.BF_SSN = LN50.BF_SSN
										AND LN90.LN_SEQ = LN50.LN_SEQ
										AND LN50.LC_STA_LON50 = 'A'
										AND 
											(
												'2012-10-01' BETWEEN LN50.LD_DFR_BEG AND LN50.LD_DFR_END
												OR
												LN50.LD_DFR_BEG BETWEEN '2012-10-01' AND '2013-09-30'
											)
								WHERE
									LN90.LD_FAT_EFF > LN50.LD_DFR_END
									AND LN90.LC_STA_LON90 = 'A'
									AND LN90.LC_FAT_REV_REA = ''
									AND LN90.PC_FAT_TYP IN ('70','10')
								GROUP BY
									LN90.BF_SSN,
									LN90.LN_SEQ
							) LN90
							ON LN10.BF_SSN = LN90.BF_SSN
							AND LN10.LN_SEQ = LN90.LN_SEQ
					WHERE
						'2012-10-01' BETWEEN LN50.LD_DFR_BEG AND LN50.LD_DFR_END
						OR
						LN50.LD_DFR_BEG BETWEEN '2012-10-01' AND '2013-09-30'
					FOR READ ONLY WITH UR
				)
			WHERE
				LD_LON_EFF_ADD <> '16MAY2013'D
				OR
				(LD_LON_EFF_ADD = '16MAY2013'D AND COALESCE(LD_DFR_APL,'01JAN1960'D) > '16MAY2013'D)
	;

	DISCONNECT FROM DB2;
QUIT;

ENDRSUBMIT;

DATA DEMO; SET DUSTER.DEMO; RUN;

PROC EXPORT
		OUTFILE = 'T:\SAS\NHUH 17766.XLS'
		DATA = DEMO
		REPLACE
	;
QUIT;
