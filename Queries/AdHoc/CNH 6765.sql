USE UDW
GO
 
SELECT DISTINCT
	ayXX.LD_ATY_REQ_RCV,
	LNXX.BF_SSN,
	LNXX.LN_SEQ,
	LNXX.LC_STA_LONXX,
	LNXX.LA_CUR_PRI, 
	LNXX.*
FROM
	UDW..AYXX_BR_LON_ATY AYXX
	INNER JOIN UDW..LNXX_LON_ATY LNXX
		ON LNXX.BF_SSN = AYXX.BF_SSN
		AND LNXX.LN_ATY_SEQ = AYXX.LN_ATY_SEQ
	INNER JOIN UDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	LEFT JOIN 
    (
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			LNXX.LD_BIL_DU_LON,
			LNXX.LA_BIL_CUR_DU,
			LNXX.LA_TOT_BIL_STS

			--CASE 
			--	WHEN COALESCE(LNXX.LA_BIL_CUR_DU,X) - COALESCE(LNXX.LA_TOT_BIL_STS,X) < X THEN X 
			--	ELSE COALESCE(LNXX.LA_BIL_CUR_DU,X) - COALESCE(LNXX.LA_TOT_BIL_STS,X) 
			--END AMOUT_DUE
		FROM
			UDW..LNXX_LON_BIL_CRF LNXX
			INNER JOIN
			(
				SELECT
					LNXX.BF_SSN,
					LNXX.LN_SEQ,
					MAX(LNXX.LN_SEQ_BIL_WI_DTE) LN_SEQ_BIL_WI_DTE,
					max(LNXX.LN_BIL_OCC_SEQ) LN_BIL_OCC_SEQ,
					MAX(LNXX.LD_BIL_CRT)  LD_BIL_CRT
				FROM 
					UDW..LNXX_LON_BIL_CRF LNXX
					INNER JOIN UDW..BLXX_BR_BIL BLXX
						ON BLXX.BF_SSN = LNXX.BF_SSN
						AND BLXX.LD_BIL_CRT = LNXX.LD_BIL_CRT
						AND BLXX.LN_SEQ_BIL_WI_DTE = LNXX.LN_SEQ_BIL_WI_DTE
				WHERE 
					LNXX.LC_STA_LONXX = 'A'
					AND CAST(LNXX.LD_BIL_DU_LON AS DATE) < CAST(GETDATE() AS DATE)
					AND BLXX.LC_BIL_TYP = 'P'
			   GROUP BY
					LNXX.BF_SSN,
					LNXX.LN_SEQ
			)MLNXX
				ON MLNXX.BF_SSN = lnXX.BF_SSN
				and MLNXX.LN_SEQ = LNXX.LN_SEQ
				AND MLNXX.LN_SEQ_BIL_WI_DTE = lnXX.LN_SEQ_BIL_WI_DTE
				AND MLNXX.LD_BIL_CRT = LNXX.LD_BIL_CRT
				AND MLNXX.LN_BIL_OCC_SEQ = lnXX.LN_BIL_OCC_SEQ
    ) LNXX
        ON LNXX.BF_SSN = LNXX.BF_SSN
        AND LNXX.LN_SEQ = LNXX.LN_SEQ
WHERE 
	PF_REQ_ACT = 'FNBIL'
	AND LA_CUR_PRI > X
order by LD_ATY_REQ_RCV 
