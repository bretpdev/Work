USE UDW
GO
 
SELECT DISTINCT
	PDXX.DF_SPE_ACC_ID,
	--lnXX.bf_ssn,
	LNXX.LN_SEQ,
	LNXX.LA_CUR_PRI, 
	min(ayXX.LD_ATY_REQ_RCV) over (partition by ayXX.bf_ssn, lnXX.ln_seq) as first_final_bill_letter,
	--max(ayXX.LD_ATY_REQ_RCV) over (partition by ayXX.bf_ssn, lnXX.ln_seq) as last_final_bill_letter,
	ISNULL(CONVERT(VARCHAR, LNXX.LD_BIL_DU_LON, XXX), 'N/A') AS LAST_BILL_DUE,
	ISNULL(CONVERT(VARCHAR, LNXX.LD_BIL_CRT, XXX), 'N/A') AS LAST_BILL_CREATE,
	ISNULL(CONVERT(VARCHAR(XX),LNXX.LA_BIL_CUR_DU),'N/A') AS LAST_BILL_AMT,
	ISNULL(CONVERT(VARCHAR, LNXXm.LD_BIL_DU_LON, XXX), 'N/A') AS FIRST_BILL_DUE,
	ISNULL(CONVERT(VARCHAR(XX),LNXXm.LA_BIL_CUR_DU),'N/A') AS FIRST_BILL_AMT,
	lpXX.pn_rpd_trm_max AS MAX_TERMS,
	pn_rps_trm_max_xtn AS XTN_MAX_TERMS,
	WD_LON_RPD_SR AS REPAYMENT_START_DATE,
	lnXX.IC_LON_PGM
FROM
	UDW..AYXX_BR_LON_ATY AYXX
	inner join udw..PDXX_PRS_NME pdXX
		on pdXX.DF_PRS_ID = ayXX.BF_SSN
	INNER JOIN UDW..LNXX_LON_ATY LNXX
		ON LNXX.BF_SSN = AYXX.BF_SSN
		AND LNXX.LN_ATY_SEQ = AYXX.LN_ATY_SEQ
	INNER JOIN UDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN UDW..DWXX_DW_CLC_CLU DWXX
		ON DWXX.BF_SSN = LNXX.BF_SSN
		AND DWXX.LN_SEQ = LNXX.LN_SEQ
	LEFT JOIN 
    (
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			max(LNXX.LD_BIL_DU_LON) over (partition by lnXX.bf_ssn, lnXX.ln_seq) LD_BIL_DU_LON,
			max(LNXX.LA_BIL_CUR_DU) over (partition by lnXX.bf_ssn, lnXX.ln_seq) LA_BIL_CUR_DU,
			max(LNXX.LD_BIL_CRT) over (partition by lnXX.bf_ssn, lnXX.ln_seq) LD_BIL_CRT

			--CASE 
			--	WHEN COALESCE(LNXX.LA_BIL_CUR_DU,X) - COALESCE(LNXX.LA_TOT_BIL_STS,X) < X THEN X 
			--	ELSE COALESCE(LNXX.LA_BIL_CUR_DU,X) - COALESCE(LNXX.LA_TOT_BIL_STS,X) 
			--END AMOUT_DUE
		FROM
			UDW..LNXX_LON_BIL_CRF LNXX
			INNER JOIN
			(
				SELECT
					LNXX.BF_SSN,
					LNXX.LN_SEQ,
					MAX(LNXX.LN_SEQ_BIL_WI_DTE) LN_SEQ_BIL_WI_DTE,
					--max(LNXX.LN_BIL_OCC_SEQ) LN_BIL_OCC_SEQ,
					MAX(LNXX.LD_BIL_CRT)  LD_BIL_CRT
				FROM 
					UDW..LNXX_LON_BIL_CRF LNXX
					INNER JOIN UDW..BLXX_BR_BIL BLXX
						ON BLXX.BF_SSN = LNXX.BF_SSN
						AND BLXX.LD_BIL_CRT = LNXX.LD_BIL_CRT
						AND BLXX.LN_SEQ_BIL_WI_DTE = LNXX.LN_SEQ_BIL_WI_DTE
					INNER JOIN UDW..AYXX_BR_LON_ATY AYXX
						ON AYXX.BF_SSN = LNXX.BF_SSN
						AND AYXX.PF_REQ_ACT = 'FNBIL'
						AND AYXX.LC_STA_ACTYXX = 'A'
				WHERE 
					LNXX.LC_STA_LONXX = 'A'
					--AND CAST(LNXX.LD_BIL_DU_LON AS DATE) < CAST(GETDATE() AS DATE)
					--AND BLXX.LC_BIL_TYP = 'P'
			   GROUP BY
					LNXX.BF_SSN,
					LNXX.LN_SEQ
			)MLNXX
				ON MLNXX.BF_SSN = lnXX.BF_SSN
				and MLNXX.LN_SEQ = LNXX.LN_SEQ
				AND MLNXX.LD_BIL_CRT = LNXX.LD_BIL_CRT
				--AND MLNXX.LN_BIL_OCC_SEQ = lnXX.LN_BIL_OCC_SEQ
    ) LNXX
        ON LNXX.BF_SSN = LNXX.BF_SSN
        AND LNXX.LN_SEQ = LNXX.LN_SEQ
		LEFT JOIN 
    (
		SELECT DISTINCT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			min(LNXX.LD_BIL_DU_LON) over (partition by lnXX.bf_ssn, lnXX.ln_seq) LD_BIL_DU_LON,
			LNXX.LA_BIL_CUR_DU,
			LNXX.LA_TOT_BIL_STS
		FROM
			UDW..LNXX_LON_BIL_CRF LNXX
			INNER JOIN
			(
				SELECT
					LNXX.BF_SSN,
					LNXX.LN_SEQ,
					MIN(LNXX.LN_SEQ_BIL_WI_DTE) LN_SEQ_BIL_WI_DTE,
					--MIN(LNXX.LN_BIL_OCC_SEQ) LN_BIL_OCC_SEQ,
					MIN(LNXX.LD_BIL_CRT)  LD_BIL_CRT
				FROM 
					UDW..LNXX_LON_BIL_CRF LNXX
					INNER JOIN UDW..AYXX_BR_LON_ATY AYXX
						ON AYXX.BF_SSN = LNXX.BF_SSN
						AND AYXX.PF_REQ_ACT = 'FNBIL'
						AND AYXX.LC_STA_ACTYXX = 'A'
				WHERE 
					LNXX.LC_STA_LONXX = 'A'
					
			   GROUP BY
					LNXX.BF_SSN,
					LNXX.LN_SEQ
			)MLNXX
				ON MLNXX.BF_SSN = lnXX.BF_SSN
				and MLNXX.LN_SEQ = LNXX.LN_SEQ
				
				AND MLNXX.LD_BIL_CRT = LNXX.LD_BIL_CRT
				--AND MLNXX.LN_BIL_OCC_SEQ = lnXX.LN_BIL_OCC_SEQ
    ) LNXXm
        ON LNXXm.BF_SSN = LNXX.BF_SSN
        AND LNXXm.LN_SEQ = LNXX.LN_SEQ
	left join openquery(duster, 'select * from olwhrmX.lPXX_RPY_PAR') lpXX
		on lpXX.PC_STA_LPDXX = 'a'
		and lpXX.ic_lon_pgm = lnXX.IC_lon_pgm
		and lpXX.pf_rgl_cat = lnXX.LF_RGL_CAT_LPXX
		and lpXX.if_gtr = lnXX.if_gtr
		and lpXX.IF_OWN = lnXX.LF_LON_CUR_OWN
WHERE 
	PF_REQ_ACT = 'FNBIL'
	AND LA_CUR_PRI > X
	AND AYXX.LC_STA_ACTYXX = 'A'


