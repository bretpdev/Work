USE ODW
GO

DROP TABLE IF EXISTS #POP

SELECT DISTINCT
	AF_APL_ID,
	AF_APL_ID_SFX,
	BF_SSN,
	SUM(LA_TRX) AS PAYMENT_AMOUNT
	--*
INTO #POP
FROM
	ODW..DC11_LON_FAT
WHERE
	LC_TRX_TYP in ('BR')
	AND LD_TRX_EFF >= '03/13/2020'
	AND LC_REV_IND_TYP = ''
GROUP BY
	AF_APL_ID,
	AF_APL_ID_SFX,
	BF_SSN

SELECT
	COUNT(DISTINCT P.BF_SSN) AS BORROWER_COUNT,
	COUNT(*) AS LOAN_COUNT,
	SUM(PAYMENT_AMOUNT) AS TOTAL_PAYMENT_AMOUNT,
	SUM(ISNULL(LA_CLM_BAL,0.00) - ISNULL(LA_CLM_PRJ_COL_CST,0.00)) AS OUTSTANDING_PRINCIPAL_INTEREST
FROM
	#POP P
	LEFT JOIN ODW..DC02_BAL_INT DC02
		ON DC02.AF_APL_ID = P.AF_APL_ID
		AND DC02.AF_APL_ID_SFX = P.AF_APL_ID_SFX