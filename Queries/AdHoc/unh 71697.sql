USE UDW
GO

SELECT DISTINCT
	LN10.BF_SSN AS SSN,
	LN10.LN_SEQ AS LOAN_SEQ,
	LN10.LD_LON_IBR_ENT AS IBR_SUBSIDY,
	RS.LD_RPS_1_PAY_DU AS IBR_FIRST_PAY_DUE,
	DATEDIFF(DAY, RS.LD_RPS_1_PAY_DU, LN10.LD_LON_IBR_ENT) AS DAY_DIFFERENCE,
	LN10.LA_CUR_PRI AS CURRENT_PRINCIPAL_BALANCE
FROM
	UDW..LN10_LON LN10
	INNER JOIN
	(
		SELECT
			RS10.BF_SSN,
			LN65.LN_SEQ,
			MIN(RS10.LD_RPS_1_PAY_DU) AS LD_RPS_1_PAY_DU --GETS THE FIRST PAYMENT FOR THE BORROWERS IBR
		FROM 
			UDW..RS10_BR_RPD RS10
			INNER JOIN UDW..LN65_LON_RPS LN65
				ON LN65.BF_SSN = RS10.BF_SSN
				AND LN65.LN_RPS_SEQ = RS10.LN_RPS_SEQ
		WHERE
			LN65.LC_TYP_SCH_DIS = 'IB'
		GROUP BY
			RS10.BF_SSN,
			LN65.LN_SEQ
	) RS
		ON RS.BF_SSN = LN10.BF_SSN
		AND RS.LN_SEQ = LN10.LN_SEQ
	LEFT JOIN UDW..LN09_RPD_PIO_CVN LN09
		ON LN09.BF_SSN = LN10.BF_SSN
		AND LN09.LN_SEQ = LN10.LN_SEQ
	LEFT JOIN UDW..LNPC_LFG_PAY_DTL LNPC
		ON LNPC.BF_SSN = LN10.BF_SSN
		AND LNPC.LN_SEQ = LN10.LN_SEQ
WHERE
	DATEDIFF(DAY, RS.LD_RPS_1_PAY_DU, LN10.LD_LON_IBR_ENT) > 180
	AND LN10.LA_CUR_PRI > 0
	AND LN10.LC_STA_LON10 = 'R'
	AND LN10.IC_LON_PGM IN ('STFFRD','SUBCNS','SUBSPC')
