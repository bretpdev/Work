USE ODW
GO

DROP TABLE IF EXISTS #POP

SELECT DISTINCT
	AF_APL_ID,
	AF_APL_ID_SFX,
	BF_SSN,
	SUM(LA_TRX) AS PAYMENT_AMOUNT
	--*
INTO #POP
FROM
	ODW..DC11_LON_FAT
WHERE
	LC_TRX_TYP IN ('GP','EP','SO','FO')
	AND LD_TRX_EFF >= '03/13/2020'
	AND LC_REV_IND_TYP = ''
GROUP BY
	AF_APL_ID,
	AF_APL_ID_SFX,
	BF_SSN

SELECT
	COUNT(DISTINCT P.BF_SSN) AS BORROWER_COUNT,
	COUNT(*) AS LOAN_COUNT,
	SUM(PAYMENT_AMOUNT) AS TOTAL_PAYMENT_AMOUNT,
	SUM(ISNULL(DC02.LA_CLM_BAL,0.00) + ISNULL(DC02.LA_CLM_INT_ACR,0.00)) AS OUTSTANDING_PRINCIPAL_INTEREST
FROM
	#POP P
	LEFT JOIN ODW..DC02_BAL_INT DC02
		ON DC02.AF_APL_ID = P.AF_APL_ID
		AND DC02.AF_APL_ID_SFX = P.AF_APL_ID_SFX

DROP TABLE IF EXISTS #POP1

SELECT DISTINCT
	AF_APL_ID,
	AF_APL_ID_SFX,
	BF_SSN,
	SUM(LA_TRX) AS PAYMENT_AMOUNT
	--*
INTO #POP1
FROM
	ODW..DC11_LON_FAT
WHERE
	LC_TRX_TYP IN ('GP','EP')
	AND LD_TRX_EFF >= '03/13/2020'
	AND LC_REV_IND_TYP = ''
GROUP BY
	AF_APL_ID,
	AF_APL_ID_SFX,
	BF_SSN

SELECT
	COUNT(DISTINCT P.BF_SSN) AS BORROWER_COUNT,
	COUNT(*) AS LOAN_COUNT,
	SUM(PAYMENT_AMOUNT) AS TOTAL_PAYMENT_AMOUNT,
	SUM(ISNULL(DC02.LA_CLM_BAL,0.00) + ISNULL(DC02.LA_CLM_INT_ACR,0.00)) AS OUTSTANDING_PRINCIPAL_INTEREST
FROM
	#POP1 P
	LEFT JOIN ODW..DC02_BAL_INT DC02
		ON DC02.AF_APL_ID = P.AF_APL_ID
		AND DC02.AF_APL_ID_SFX = P.AF_APL_ID_SFX

DROP TABLE IF EXISTS #POP2

SELECT DISTINCT
	AF_APL_ID,
	AF_APL_ID_SFX,
	BF_SSN,
	SUM(LA_TRX) AS PAYMENT_AMOUNT
	--*
INTO #POP2
FROM
	ODW..DC11_LON_FAT
WHERE
	LC_TRX_TYP IN ('GP','EP')
	AND LD_TRX_EFF >= '04-24-2021'
	AND LC_REV_IND_TYP = ''
GROUP BY
	AF_APL_ID,
	AF_APL_ID_SFX,
	BF_SSN

SELECT
	COUNT(DISTINCT P.BF_SSN) AS BORROWER_COUNT,
	COUNT(*) AS LOAN_COUNT,
	ISNULL(SUM(PAYMENT_AMOUNT),0.00) AS TOTAL_PAYMENT_AMOUNT,
	ISNULL(SUM(ISNULL(DC02.LA_CLM_BAL,0.00) + ISNULL(DC02.LA_CLM_INT_ACR,0.00)),0.00) AS OUTSTANDING_PRINCIPAL_INTEREST
FROM
	#POP2 P
	LEFT JOIN ODW..DC02_BAL_INT DC02
		ON DC02.AF_APL_ID = P.AF_APL_ID
		AND DC02.AF_APL_ID_SFX = P.AF_APL_ID_SFX