USE UDW
GO

SELECT DISTINCT
	count(distinct pd10.df_prs_id) as borrower_count,
	count(*) as loan_count
FROM
	UDW..PD10_PRS_NME PD10
	INNER JOIN UDW..LN10_LON LN10
		ON LN10.BF_SSN = PD10.DF_PRS_ID
		INNER JOIN
	(
		SELECT	
			CL10.BF_SSN
		FROM
			UDW..CL10_CLM_PCL CL10
			INNER JOIN 
			(
				SELECT 
					BF_SSN,
					MAX(LN_SEQ_CLM_PCL) AS LN_SEQ_CLM_PCL
				FROM
					UDW..CL10_CLM_PCL
				GROUP BY
					BF_SSN
			)MCL
			ON MCL.BF_SSN = CL10.BF_SSN
			AND MCL.LN_SEQ_CLM_PCL = CL10.LN_SEQ_CLM_PCL
		WHERE 
			CL10.LC_REA_CLM_PCL = '06'
	) CL10
		ON CL10.BF_SSN = LN10.BF_SSN
	INNER JOIN
	(
		SELECT
			BF_SSN,
			LN_SEQ,
			MAX(LD_FAT_EFF) AS LD_FAT_EFF
		FROM
			UDW..LN90_FIN_ATY LN90
		WHERE
			PC_FAT_TYP = '10'
			AND PC_FAT_SUB_TYP = '30'
			AND LC_STA_LON90 = 'A'
			AND ISNULL(LC_FAT_REV_REA,'') = ''
			AND LD_FAT_EFF >= '03/13/2020'
		GROUP BY
			BF_SSN,
			LN_SEQ
	) LN90
		ON LN10.BF_SSN = LN90.BF_SSN
		AND LN10.LN_SEQ = LN90.LN_SEQ