SELECT DISTINCT
	LNXX.BF_SSN,
	LTRIM(RTRIM(PDXX.DM_PRS_X)) AS FirstName,
	LTRIM(RTRIM(PDXX.DM_PRS_LST)) AS LastName,
	PDXX.DC_PHN AS PhoneType,
	CASE 
		WHEN PDXX.DC_PHN = 'H' THEN X
		WHEN PDXX.DC_PHN = 'A' THEN X
		WHEN PDXX.DC_PHN = 'W' THEN X
		WHEN PDXX.DC_PHN = 'M' THEN X
	END AS PHN_RNK,
	CASE WHEN PDXX.DC_ALW_ADL_PHN = 'P' THEN 'Y' ELSE 'N' END AS MobileConsent,
	COALESCE(PDXX.DN_DOM_PHN_ARA,'') + COALESCE(PDXX.DN_DOM_PHN_XCH,'') + COALESCE(PDXX.DN_DOM_PHN_LCL,'') AS PhoneNumber,
	--RTRIM(LTRIM(((COALESCE(PDXX.DN_FGN_PHN_INL,'') + COALESCE(PDXX.DN_FGN_PHN_CNY,'') + COALESCE(PDXX.DN_FGN_PHN_CT,'') + COALESCE(PDXX.DN_FGN_PHN_LCL,'')))) AS ForeignPhone,
	CONVERT(VARCHAR,LNXX.LD_LON_ACL_ADD,XXX) AS ActualLoanAdd,
	CONVERT(VARCHAR,LNXX.LD_LON_EFF_ADD,XXX) AS EffectiveLoanAdd,
	(MAX(LNXX.LN_DLQ_MAX) OVER(PARTITION BY LNXX.BF_SSN) + X) AS LN_DLQ_MAX
FROM
	CDW..PDXX_PRS_NME PDXX
	INNER JOIN 
	(
		SELECT
			BF_SSN,
			MIN(LD_LON_ACL_ADD) LD_LON_ACL_ADD,
			MIN(LD_LON_EFF_ADD) LD_LON_EFF_ADD
		FROM
			CDW..LNXX_LON LNXX
		WHERE
			LC_STA_LONXX = 'R'
			AND LA_CUR_PRI > X.XX
		GROUP BY
			BF_SSN
	)LNXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
	INNER JOIN CDW..LNXX_LON_DLQ_HST LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		--AND LNXX.LN_SEQ = LNXX.LN_SEQ
		AND LNXX.LC_STA_LONXX = 'X'
		AND CAST(DATEADD(DAY,-X,GETDATE()) AS DATE) > CAST(LNXX.LD_DLQ_OCC AS DATE)
	INNER JOIN CDW..PDXX_PRS_PHN PDXX
		ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
		AND PDXX.DI_PHN_VLD = 'Y'
ORDER BY
	LNXX.BF_SSN,
	PHN_RNK
