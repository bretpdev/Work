TRUNCATE TABLE CDW..CS_TransferPIFLoans
INSERT INTO CDW..CS_TransferPIFLoans(BF_SSN, LN_SEQ, LoanProgram, LoanSaleId)
SELECT 
	LNXX.BF_SSN,
	LNXX.LN_SEQ,
	CASE WHEN LNXX.LC_FED_PGM_YR = 'LNC' THEN 'LNC'
         WHEN LNXX.LC_FED_PGM_YR = 'DLO' THEN 'DLO'
	ELSE '' END AS LoanProgram,
	NULL AS LoanSaleId
FROM
	CDW..CS_TRANSFERPIF PIF
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = PIF.BF_SSN
	LEFT JOIN
	(
	SELECT DISTINCT
			LNXX.BF_SSN,
			LNXX.LN_SEQ
		FROM
			CDW..LNXX_FIN_ATY LNXX
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND COALESCE(rtrim(LNXX.LC_FAT_REV_REA),'') = ''
			AND LNXX.PC_FAT_TYP = 'XX'
			AND LNXX.PC_FAT_SUB_TYP = 'XX'
			AND LNXX.LD_FAT_EFF >= 'XX/XX/XXXX'
		
	) LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
WHERE
	LNXX.BF_SSN IS NULL
