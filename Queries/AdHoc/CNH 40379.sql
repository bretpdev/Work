DROP TABLE IF EXISTS #BASE
 DROP TABLE IF EXISTS #COMPLETE
DECLARE @QUEUE VARCHAR(X) = 'XX'

SELECT 
	WQXX.WF_QUE,
	WQXX.WF_SUB_QUE,
	WQXX.WN_CTL_TSK,
	WQXX.WF_CRT_DTS_WQXX,
	WQXX.WC_STA_WQUEXX,
	WQXX.BF_SSN
INTO #BASE
FROM
	CDW..WQXX_TSK_QUE_HST WQXX
WHERE 
	WF_QUE = @QUEUE
	AND	WQXX.WF_CRT_DTS_WQXX > 'XX-XX-XXXX'
	AND	WQXX.WC_STA_WQUEXX = 'U'
	AND WQXX.PF_REQ_ACT = 'DIBCR '

SELECT 
	PDXX.DF_SPE_ACC_ID,
	WQXX.BF_SSN,
	WQXX.WF_QUE,
	WQXX.WF_SUB_QUE,
	WQXX.WN_CTL_TSK,
	WQXX.WC_STA_WQUEXX,
	LKXX.PX_DSC_MDM,
	WQXX.WF_CRT_DTS_WQXX AS DATE_TASK_RECEIVED ,
	WQXX.WF_CRT_DTS_WQXX AS DATE_TASK_COMPLETED,
	CentralData.DBO.BusinessDaysDiff(WQXX.WF_CRT_DTS_WQXX, WQXX.WF_CRT_DTS_WQXX) AS BUSINESS_DAYS_TO_PROCESS
INTO #COMPLETE
FROM
	CDW..WQXX_TSK_QUE_HST WQXX
	INNER JOIN CDW..LKXX_LS_CDE_LKP LKXX
		ON LKXX.PM_ATR = 'WC-STA-WQUEXX'
		AND LKXX.PX_ATR_VAL = WQXX.WC_STA_WQUEXX
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = WQXX.BF_SSN
WHERE 
	WF_QUE = @QUEUE
	AND	WQXX.WF_CRT_DTS_WQXX > 'XX-XX-XXXX' 
	AND	WQXX.WC_STA_WQUEXX IN ('C','X')
	AND WQXX.PF_REQ_ACT = 'DIBCR '

SELECT 
	C.DF_SPE_ACC_ID,
	C.DATE_TASK_RECEIVED ,
	C.DATE_TASK_COMPLETED,
	C.PX_DSC_MDM AS TASK_STATUS,
	C.BUSINESS_DAYS_TO_PROCESS
	--C.DAYS_TO_PROCESS - XX AS DAYS_PAST_DUE
FROM 
	#COMPLETE C
WHERE
	DATE_TASK_COMPLETED BETWEEN 'XX-X-XXXX' AND 'XX-XX-XXXX'
ORDER BY 
	C.DATE_TASK_COMPLETED

--UNION ALL

--SELECT
--	PDXX.DF_SPE_ACC_ID,
--	B.WF_CRT_DTS_WQXX AS DATE_TASK_REC,
--	NULL AS DATE_TASK_PROCESSED,
--	LKXX.PX_DSC_MDM AS TASK_STATUS,
--	CentralData.DBO.BusinessDaysDiff(B.WF_CRT_DTS_WQXX, CAST(GETDATE() AS DATE)) AS DAYS_IN_PROCESS,
--	CentralData.DBO.BusinessDaysDiff(B.WF_CRT_DTS_WQXX, CAST(GETDATE() AS DATE)) - XX AS DAYS_PAST_DUE
--FROM
--	#BASE B
--	INNER JOIN ServicerInventoryMetrics..Deferment F
--		ON F.BF_SSN = B.BF_SSN
--	INNER JOIN CDW..PDXX_PRS_NME PDXX
--		ON PDXX.DF_PRS_ID = B.BF_SSN
--	INNER JOIN CDW..LKXX_LS_CDE_LKP LKXX
--		ON LKXX.PM_ATR = 'WC-STA-WQUEXX'
--		AND LKXX.PX_ATR_VAL = B.WC_STA_WQUEXX
--	LEFT JOIN #COMPLETE C
--		ON B.WF_QUE = C.WF_QUE
--		AND B.WF_SUB_QUE = C.WF_SUB_QUE
--		AND B.WN_CTL_TSK = C.WN_CTL_TSK
--WHERE
--	C.WF_QUE IS NULL
--	AND B.WF_CRT_DTS_WQXX < 'X-X-XXXX'