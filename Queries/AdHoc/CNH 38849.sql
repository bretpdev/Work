USE CDW
GO

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @SchoolCodes TABLE
(
	SchoolCode CHAR(X)
);
INSERT INTO
	@SchoolCodes
VALUES	  
--OPE ID'Closure Date
('XXXXXXXX')
--select * from @SchoolCodes

/*****************  MODIFIED QUERY  ***********************/
SELECT
	*
FROM
	(
		SELECT DISTINCT
			PDXX.DF_PRS_ID,
			CSREQ.LD_ATY_REQ_RCV AS AppSentDate,
			DICSK.LD_ATY_REQ_RCV AS AppReceivedDate,
			CASE WHEN CSDNY.BF_SSN IS NULL AND ADCSH.BF_SSN IS NULL THEN 'Pending'
				 WHEN CAST(ISNULL(CSDNY.LD_ATY_REQ_RCV,'XXXX-XX-XX') AS DATE) > CAST(ISNULL(ADCSH.LD_ATY_REQ_RCV,'XXXX-XX-XX') AS DATE) THEN 'Denied' 
				 WHEN CAST(ISNULL(CSDNY.LD_ATY_REQ_RCV,'XXXX-XX-XX') AS DATE) <= CAST(ISNULL(ADCSH.LD_ATY_REQ_RCV,'XXXX-XX-XX') AS DATE) THEN 'Approved' 
				 ELSE 'N/A' END AS AppStatus
		FROM
			PDXX_PRS_NME PDXX
			INNER JOIN LNXX_LON LNXX 
				ON LNXX.BF_SSN = PDXX.DF_PRS_ID
			INNER JOIN 
			(
				SELECT
					LNXX.LF_STU_SSN,
					SC.SchoolCode
				FROM
					@SchoolCodes SC
					INNER JOIN LNXX_LON LNXX 
						ON LNXX.LF_DOE_SCL_ORG = SC.SchoolCode

				UNION

				SELECT DISTINCT
					SDXX.LF_STU_SSN,
					SC.SchoolCode
				FROM
					@SchoolCodes SC
					INNER JOIN SDXX_STU_SPR SDXX 
						ON SDXX.LF_DOE_SCL_ENR_CUR = SC.SchoolCode
			) School 
				ON School.LF_STU_SSN = LNXX.LF_STU_SSN
			LEFT JOIN 
			(
				SELECT DISTINCT
					BF_SSN,
					MAX(LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
				FROM
					CDW..AYXX_BR_LON_ATY AYXX
				WHERE
					PF_REQ_ACT IN('CSREQ','DFSCH')
					AND LC_STA_ACTYXX = 'A'
				GROUP BY
					BF_SSN
			) CSREQ
				ON CSREQ.BF_SSN = LNXX.BF_SSN
			LEFT JOIN 
			(
				SELECT DISTINCT
					BF_SSN,
					MAX(LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
				FROM
					CDW..AYXX_BR_LON_ATY AYXX
				WHERE
					PF_REQ_ACT = 'CSDNY'
					AND LC_STA_ACTYXX = 'A'
				GROUP BY
					BF_SSN
			) CSDNY
				ON CSDNY.BF_SSN = LNXX.BF_SSN
			LEFT JOIN 
			(
				SELECT DISTINCT
					BF_SSN,
					MAX(LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
				FROM
					CDW..AYXX_BR_LON_ATY AYXX
				WHERE
					PF_REQ_ACT = 'ADCSH'
					AND LC_STA_ACTYXX = 'A'
				GROUP BY
					BF_SSN
			) ADCSH
				ON ADCSH.BF_SSN = LNXX.BF_SSN
			LEFT JOIN 
			(
				SELECT DISTINCT
					BF_SSN,
					MAX(LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
				FROM
					CDW..AYXX_BR_LON_ATY AYXX
				WHERE
					PF_REQ_ACT = 'DICSK'
					AND LC_STA_ACTYXX = 'A'
				GROUP BY
					BF_SSN
			) DICSK
				ON DICSK.BF_SSN = LNXX.BF_SSN
		WHERE
			LNXX.LA_CUR_PRI > X.XX
			AND LNXX.LA_LON_AMT_GTR > X.XX
	) X

;
