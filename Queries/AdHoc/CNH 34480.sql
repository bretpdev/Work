SELECT DISTINCT
	SUM(LNXX.LA_CUR_PRI + ISNULL(LNXX.LA_NSI_OTS,X)) AS BALANCE,
	COUNT(*) AS LOAN_COUNT
FROM
(
	SELECT DISTINCT
		PDXX.DF_PRS_ID
	FROM
		CDW..PDXX_PRS_ADR PDXX
		INNER JOIN AuditCDW..LNXX_LON_AprXXXX LNXX
			ON LNXX.BF_SSN = PDXX.DF_PRS_ID
	WHERE
		DC_DOM_ST = 'CA'
		AND DF_PRS_ID NOT LIKE 'P%'
		AND DI_VLD_ADR = 'Y'
		AND DF_LST_DTS_PDXX < 'XX/XX/XXXX'
		AND LA_CUR_PRI > X.XX
		AND LNXX.LC_STA_LONXX = 'R'


	UNION --NO UNION ALL BECASE WE WANT TO DEDUP

	SELECT DISTINCT
		F.DF_PRS_ID
	FROM
		(
			SELECT * FROM OPENQUERY(LEGEND,
			'
			SELECT
				PDXX.DF_PRS_ID
			FROM
				PKUB.PDXX_PRS_INA PDXX
				INNER JOIN 
				(
					SELECT
						DF_PRS_ID,
						MAX(DN_ADR_SEQ) AS DN_ADR_SEQ --GETS LAST VALID ADDRESS
					FROM
						PKUB.PDXX_PRS_INA PDXX
					WHERE
						PDXX.DF_PRS_ID NOT LIKE ''P%''
						AND PDXX.DI_VLD_ADR_HST = ''Y''
						AND PDXX.DF_LST_DTS_PDXX < ''XX/XX/XXXX''
					GROUP BY
						DF_PRS_ID
				) MS
					ON MS.DF_PRS_ID = PDXX.DF_PRS_ID
					AND MS.DN_ADR_SEQ = PDXX.DN_ADR_SEQ
			WHERE
				PDXX.DC_DOM_ST_HST = ''CA''

			') P
		) F
		INNER JOIN AuditCDW..LNXX_LON_AprXXXX LNXX
			ON LNXX.BF_SSN = F.DF_PRS_ID
	WHERE
		LA_CUR_PRI > X.XX
		AND LNXX.LC_STA_LONXX = 'R'
) ALL_BWRS
INNER JOIN AuditCDW..LNXX_LON_AprXXXX LNXX
		ON LNXX.BF_SSN = ALL_BWRS.DF_PRS_ID