USE UDW
GO

SELECT DISTINCT
	PD10.DF_SPE_ACC_ID,
	WQ20.WF_QUE,
	WQ20.WF_SUB_QUE,
	LN16.LN_DLQ_MAX,
	NCH.LastCall,
	DATEDIFF(DAY, ISNULL(NCH.LastCall, '01/01/1990'), GETDATE()) DaysSinceLastCall
FROM
	UDW..WQ20_TSK_QUE WQ20
	INNER JOIN UDW..PD10_PRS_NME PD10
		ON PD10.DF_PRS_ID = WQ20.BF_SSN
	INNER JOIN UDW..LN10_LON LN10
		ON LN10.BF_SSN = WQ20.BF_SSN
	INNER JOIN LN16_LON_DLQ_HST LN16
		ON LN10.BF_SSN = LN16.BF_SSN
		AND LN10.LN_SEQ = LN16.LN_SEQ
	LEFT JOIN
	(
		SELECT
			BF_SSN,
			MAX(LD_ATY_REQ_RCV) AS LastCall
		FROM
			UDW..AY10_BR_LON_ATY AY10
			
		WHERE
			LC_STA_ACTY10= 'A'
			AND PF_REQ_ACT = 'DDPHN'
		GROUP BY
			BF_SSN
	) NCH
		ON NCH.BF_SSN = WQ20.BF_SSN	
	
WHERE
	LN16.LC_STA_LON16 = '1'
	AND LN16.LC_DLQ_TYP = 'P' -- INSTALLMENT
	AND 
	(
		DATEADD(DAY,-5,CAST(GETDATE() AS DATE)) <= LN16.LD_DLQ_MAX --Account for AES holidays that we dont honor
	)
	AND	WQ20.WF_QUE = 'C0'
	AND LN10.LA_CUR_PRI > 0.00
	AND LN10.LC_STA_LON10 = 'R'
	AND DATEDIFF(DAY, ISNULL(NCH.LastCall, '01/01/1990'), GETDATE()) >= 30