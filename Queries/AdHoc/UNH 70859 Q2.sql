DROP TABLE IF EXISTS #PRE
SELECT	
	LN80.*
INTO #PRE
FROM
	UDW..LN80_LON_BIL_CRF LN80
	INNER JOIN
	(
		SELECT 
			BF_SSN,
			LN_SEQ,
			MAX(LD_BIL_CRT) AS LD_BIL_CRT
		FROM
			UDW..LN80_LON_BIL_CRF LN80
			INNER JOIN [UDW].[dbo].[UNH70859] UNH
				ON LN80.BF_SSN = UNH.SSN
				AND LN80.LN_SEQ = UNH.[LOAN SEQ]
		WHERE
			LD_BIL_CRT < '02/26/2021'
		GROUP BY
			BF_SSN,
			LN_SEQ
	)ML
		ON ML.BF_SSN = LN80.BF_SSN
		AND ML.LN_SEQ = LN80.LN_SEQ
		AND ML.LD_BIL_CRT = LN80.LD_BIL_CRT
WHERE 
	LN80.LD_NXT_PAY_DUE_AHD >= '04/01/2021'
ORDER BY 
	LD_BIL_DU_LON DESC

SELECT 'DONE WITH PRE'

SELECT 
	P.BF_SSN,
	P.LN_SEQ,
	P.LD_NXT_PAY_DUE_AHD AS BILL_BEFORE,
	NB.LD_NXT_PAY_DUE_AHD AS BILL_AFTER
FROM
	#PRE P
	INNER JOIN
	(
		SELECT
			LN80.*
		FROM
			UDW..LN80_LON_BIL_CRF LN80
			INNER JOIN
			(
				SELECT 
					BF_SSN,
					LN_SEQ,
					MIN(LD_BIL_CRT) AS LD_BIL_CRT
				FROM
					UDW..LN80_LON_BIL_CRF LN80
					INNER JOIN [UDW].[dbo].[UNH70859] UNH
						ON LN80.BF_SSN = UNH.SSN
						AND LN80.LN_SEQ = UNH.[LOAN SEQ]
				WHERE
					LD_BIL_CRT >= '02/26/2021'
				GROUP BY
					BF_SSN,
					LN_SEQ
			)ML
				ON ML.BF_SSN = LN80.BF_SSN
				AND ML.LN_SEQ = LN80.LN_SEQ
				AND ML.LD_BIL_CRT = LN80.LD_BIL_CRT
	) NB
		ON NB.BF_SSN = P.BF_SSN
		AND NB.LN_SEQ  = P.LN_SEQ
WHERE P.LD_NXT_PAY_DUE_AHD != ISNULL(NB.LD_NXT_PAY_DUE_AHD,'01/01/2000')