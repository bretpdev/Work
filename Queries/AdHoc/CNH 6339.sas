LIBNAME LEGEND REMOTE SERVER=LEGEND SLIBREF=WORK;
RSUBMIT;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;
PROC SQL;
	CREATE TABLE ECORR AS
		SELECT DISTINCT
			PDXX.DF_SPE_ACC_ID AS ACCOUNT_NUMBER,
			CATX(' ',PDXX.DM_PRS_X,PDXX.DM_PRS_LST) AS BORROWER_NAME,
			PDXX.DX_ADR_EML AS EMAIL_ADDRESS
		FROM
			PKUB.LNXX_LON LNXX
			JOIN PKUB.PDXX_PRS_NME PDXX
				ON LNXX.BF_SSN = PDXX.DF_PRS_ID
				AND LNXX.LA_CUR_PRI > X
				AND LNXX.LC_STA_LONXX = 'R'
			JOIN PKUB.PDXX_PRS_ADR_EML PDXX
				ON LNXX.BF_SSN = PDXX.DF_PRS_ID
				AND PDXX.DC_STA_PDXX= 'A' 
				AND PDXX.DI_VLD_ADR_EML = 'Y'
			JOIN PKUB.DWXX_DW_CLC_CLU DWXX
				ON LNXX.BF_SSN = DWXX.BF_SSN
				AND LNXX.LN_SEQ = DWXX.LN_SEQ
				AND DWXX.WC_DW_LON_STA ^= 'XX'
			LEFT JOIN PKUB.AYXX_BR_LON_ATY AYXX
				ON LNXX.BF_SSN = AYXX.BF_SSN
				AND AYXX.PF_REQ_ACT = 'ECORO'
		WHERE
			AYXX.BF_SSN IS NULL
	;
QUIT;
ENDRSUBMIT;

DATA ECORR; SET LEGEND.ECORR; RUN;

PROC EXPORT
		DATA=ECORR
		OUTFILE='T:\Ecorr Email X.CSV'
		REPLACE;
RUN;
