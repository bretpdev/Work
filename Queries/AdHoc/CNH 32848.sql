USE CDW
GO

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
GO

DECLARE @DATEX DATE = 'XX/X/XXXX';
DECLARE @DATEX DATE = 'XX/XX/XXXX';

/************** Xnd REQUEST  ************************/

--distinct list of ssn's
SELECT DISTINCT
	AYXX.BF_SSN
FROM
	..AYXX_BR_LON_ATY AYXX
WHERE
	AYXX.LD_ATY_REQ_RCV BETWEEN @DATEX AND @DATEX
	AND AYXX.LC_STA_ACTYXX = 'A'
	AND UPPER(AYXX.PF_REQ_ACT) IN ('MILRV', 'MILRN', 'RSCRA')

--all data
SELECT DISTINCT
	AYXX.BF_SSN
	,AYXX.LC_STA_ACTYXX
	,AYXX.PF_REQ_ACT	
	,CAST(AYXX.LD_ATY_REQ_RCV AS DATE) [LD_ATY_REQ_RCV]
FROM
	..AYXX_BR_LON_ATY AYXX
WHERE
	AYXX.LD_ATY_REQ_RCV BETWEEN @DATEX AND @DATEX
	AND AYXX.LC_STA_ACTYXX = 'A'
	AND UPPER(AYXX.PF_REQ_ACT) IN ('MILRV', 'MILRN', 'RSCRA')
ORDER BY
	[LD_ATY_REQ_RCV]





/************** Xst REQUEST  ************************/
--check to see anyone meets criteria
SELECT TOP XX
	BF_SSN
FROM
	..AYXX_ATY_TXT AYXX
WHERE
	UPPER(AYXX.LX_ATY) LIKE '% HEROES %'
	OR UPPER(AYXX.LX_ATY) LIKE '% HEROS %'

--check hit
SELECT * 
FROM ..AYXX_ATY_TXT AYXX
WHERE AYXX.BF_SSN = 'XXXXXXXXX'
AND (
		UPPER(AYXX.LX_ATY) LIKE '% HEROES %'
		OR UPPER(AYXX.LX_ATY) LIKE '% HEROS %'
	)


--output provided to FSA
;WITH SCRA AS
(
	SELECT DISTINCT
		PDXX.DF_PRS_ID AS BORROWER_SSN
		,PDXX.DM_PRS_X AS FIRST_NAME
		,PDXX.DM_PRS_LST AS LAST_NAME
		,BOR.BorrowerAccountNumber
		,BOR.EndorserAccountNumber
		,AD.*
	FROM
		CLS.scra.ACTIVEDUTY AD
		INNER JOIN CLS.scra.Borrowers BOR
			ON AD.BorrowerId = BOR.BorrowerId
		INNER JOIN CDW.dbo.PDXX_PRS_NME PDXX
			ON BOR.BorrowerAccountNumber = PDXX.DF_SPE_ACC_ID
	WHERE
		CAST(AD.BeginDate AS DATE) BETWEEN @DATEX AND @DATEX
		OR CAST(AD.EndDate AS DATE) BETWEEN @DATEX AND @DATEX
	--ORDER BY
	--	BeginDate
	--	,EndDate
)
SELECT 
	'HEROS/HEROES' AS [TYPE]
	,SCRA.*
FROM
	CDW.dbo.AYXX_ATY_TXT AYXX
	INNER JOIN SCRA
		ON AYXX.BF_SSN = SCRA.BORROWER_SSN
WHERE
	(
		UPPER(AYXX.LX_ATY) LIKE '% HEROES %'
		OR UPPER(AYXX.LX_ATY) LIKE '% HEROS %'
	)
	AND CAST(AYXX.LF_LST_DTS_AYXX AS DATE) BETWEEN @DATEX AND @DATEX

UNION

SELECT DISTINCT
	'DEFERMENT' AS [TYPE]
	--,LNXX.LD_DFR_BEG AS TYPE_BEG
	--,LNXX.LD_DFR_END AS TYPE_END
	,SCRA.*
FROM
	CDW.dbo.LNXX_BR_DFR_APV LNXX
	INNER JOIN CDW.dbo.DFXX_BR_DFR_REQ DFXX
		ON LNXX.BF_SSN = DFXX.BF_SSN
		AND LNXX.LF_DFR_CTL_NUM = DFXX.LF_DFR_CTL_NUM
	INNER JOIN SCRA
		ON SCRA.BORROWER_SSN = LNXX.BF_SSN
WHERE
	LNXX.LC_STA_LONXX = 'A'
	AND DFXX.LC_DFR_STA = 'A'
	AND
	(
		CAST(LNXX.LD_DFR_BEG AS DATE) BETWEEN @DATEX AND @DATEX
		OR CAST(LNXX.LD_DFR_END AS DATE) BETWEEN @DATEX AND @DATEX
	)

UNION

SELECT DISTINCT
	'FORBEARANCE' AS [TYPE]
	--,LNXX.LD_FOR_BEG AS TYPE_BEG
	--,LNXX.LD_FOR_END AS TYPE_END
	,SCRA.*
FROM
	CDW.dbo.LNXX_BR_FOR_APV LNXX
	INNER JOIN CDW.dbo.FBXX_BR_FOR_REQ FBXX
		ON LNXX.BF_SSN = FBXX.BF_SSN
		AND LNXX.LF_FOR_CTL_NUM = FBXX.LF_FOR_CTL_NUM
	INNER JOIN SCRA
		ON SCRA.BORROWER_SSN = LNXX.BF_SSN
WHERE
	LNXX.LC_STA_LONXX = 'A'
	AND FBXX.LC_FOR_STA = 'A'
	AND
	(
		CAST(LNXX.LD_FOR_BEG AS DATE) BETWEEN @DATEX AND @DATEX
		OR CAST(LNXX.LD_FOR_END AS DATE) BETWEEN @DATEX AND @DATEX
	)
