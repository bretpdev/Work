/*CREATE LIBNAME FOR REMOTE SERVER'S WORK FOLDER*/
LIBNAME WORKLOCL REMOTE SERVER=LEGEND SLIBREF=WORK;

/*CREATE FILENAME FOR OUTPUT*/
%LET RPTLIB = T:\SAS;
FILENAME REPORTX "&RPTLIB/GRXX.XLSX"; 

/*CREATE LIBRARY OF EXCEL DATA*/
LIBNAME XLIB XLSX 'T:\Copy of KU AQ results.xlsx'; 

/*CREATE DATA SET FROM A SPECIFIC SHEET IN THE EXCEL FILE*/
DATA XLDATA; SET XLIB.KUAQresults; RUN; 

/*CAST CHAR SEQ ATTRIBUTE TO NUMERIC ATTRIBUTE WITH THE SAME NAME AND COPY NEW DATA SET TO REMOTE SERVER*/
DATA XDATA (DROP = CHAR_SEQ);
	RETAIN BF_SSN LN_SEQ; /*only the attribute that was cast and any attributes to the left of it are needed*/
	SET XLDATA (RENAME = (lN_SEQ = CHAR_SEQ));
	lN_SEQ = INPUT(CHAR_SEQ, X.);
RUN;
DATA WORKLOCL.XDATA; SET XDATA; RUN;

/*SUBMIT CODE TO REMOTE SERVER*/
RSUBMIT LEGEND;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;
LIBNAME AES DBX DATABASE=DNFPUTDL OWNER=AES;
%let DB = DNFPUTDL;
%let OWNR = PKUB;

PROC SQL STIMER;
	CONNECT TO DBX (DATABASE=&DB); 

/*TODO: update SQL below*/
/*	GET DATA FOR ALL LOANS*/
	CREATE TABLE JOINDATA AS
		SELECT 
			DBXD.*
		FROM 
			CONNECTION TO DBX 
			(
				SELECT
					GRXX.*
				FROM 
					&OWNR..GRXX_RPT_LON_APL GRXX
		
				FOR READ ONLY WITH UR
			) DBXD
			INNER JOIN XDATA XDAT
				ON DBXD.BF_SSN = XDAT.BF_SSN
				AND DBXD.LN_SEQ = XDAT.LN_SEQ
	;
	DISCONNECT FROM DBX;


QUIT;

ENDRSUBMIT;

/*COPY JOINED DATA TO WORK*/
DATA JOINDATA; SET WORKLOCL.JOINDATA; RUN;

/*EXPORT JOINED DATA TO A REPORT*/
PROC EXPORT DATA= WORK.JOINDATA
	OUTFILE= REPORTX 
	REPLACE
	DBMS=XLSX;
RUN;
