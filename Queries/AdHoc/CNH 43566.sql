INSERT INTO CDW..CS_Transfer_EAXX(BF_SSN, LastName, FirstName, LoanId, LoanProgramType, GuarantyDate, SaleDate, DealId, PostSale, TransferNumber)
SELECT DISTINCT
	TX.BF_SSN,
	CentralData.dbo.TRIM(PDXX.DM_PRS_LST) AS LastName,
	CentralData.dbo.TRIM(PDXX.DM_PRS_X) AS FirstName,
	FSXX.LF_FED_AWD + RIGHT('XXX' + CAST(FSXX.LN_FED_AWD_SEQ AS VARCHAR(X)),X) AS LoanId,
	LNXX.IC_LON_PGM AS LoanProgramType,
	CONVERT(varchar,LNXX.LD_LON_GTR,XXX) AS GuarantyDate,
	'XX/XX/XXXX' AS SaleDate,
	'PSAOJ' AS DealId,
	'Y' AS PostSale,
	X AS TransferNumber
FROM
	CDW..CS_TransferX TX
	INNER JOIN CDW..CS_TransferXLoans TL
		ON TL.BF_SSN = TX.BF_SSN
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = TX.BF_SSN
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
		AND LNXX.LN_SEQ = TL.LN_SEQ
		AND LNXX.LA_CUR_PRI >= X.XX
		--AND LNXX.LC_STA_LONXX = 'R'
	INNER JOIN CDW..FSXX_DL_LON FSXX
		ON FSXX.BF_SSN = LNXX.BF_SSN
		AND FSXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN 
	(
		SELECT DISTINCT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			SUM(COALESCE(LA_FAT_CUR_PRI,X.XX)) AS LA_FAT_CUR_PRI,
			SUM(COALESCE(LA_FAT_NSI,X.XX)) AS LA_FAT_NSI,
			MAX(LD_FAT_EFF) AS LD_FAT_EFF
		FROM
			CDW..LNXX_FIN_ATY LNXX
			INNER JOIN CDW..LNXX_LON LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
				AND LNXX.LA_CUR_PRI >= X.XX
				AND LNXX.LC_FED_PGM_YR = 'LNC'
				AND LNXX.LD_PIF_RPT IS NULL		
			INNER JOIN CDW..CS_TransferXLoans TL
                ON TL.BF_SSN = LNXX.BF_SSN
                AND TL.LN_SEQ = LNXX.LN_SEQ
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND COALESCE(LNXX.LC_FAT_REV_REA,'') = ''
			AND LNXX.LD_FAT_EFF >= 'XXXX-XX-XX'
			AND LNXX.PC_FAT_TYP = 'XX'
			AND LNXX.PC_FAT_SUB_TYP = 'XX'
		GROUP BY
			LNXX.BF_SSN,
			LNXX.LN_SEQ
	) Trans
		ON Trans.BF_SSN = LNXX.BF_SSN
		AND Trans.LN_SEQ = LNXX.LN_SEQ
	LEFT JOIN
	(
		SELECT DISTINCT
			TX.BF_SSN
		FROM
			CDW..CS_TransferX TX
			INNER JOIN CDW..CS_TransferXLoans TL
				ON TL.BF_SSN = TX.BF_SSN
			INNER JOIN CDW..PDXX_PRS_NME PDXX
				ON PDXX.DF_PRS_ID = TX.BF_SSN
			INNER JOIN CDW..LNXX_LON LNXX
				ON LNXX.BF_SSN = PDXX.DF_PRS_ID
				AND LNXX.LN_SEQ = TL.LN_SEQ
				AND LNXX.LA_CUR_PRI >= X.XX
				--AND LNXX.LC_STA_LONXX = 'R'
			INNER JOIN CDW..FSXX_DL_LON FSXX
				ON FSXX.BF_SSN = LNXX.BF_SSN
				AND FSXX.LN_SEQ = LNXX.LN_SEQ
			INNER JOIN 
			(
				SELECT DISTINCT
					LNXX.BF_SSN,
					LNXX.LN_SEQ,
					SUM(COALESCE(LA_FAT_CUR_PRI,X.XX)) AS LA_FAT_CUR_PRI,
					SUM(COALESCE(LA_FAT_NSI,X.XX)) AS LA_FAT_NSI,
					MAX(LD_FAT_EFF) AS LD_FAT_EFF
				FROM
					CDW..LNXX_FIN_ATY LNXX
					INNER JOIN CDW..LNXX_LON LNXX
						ON LNXX.BF_SSN = LNXX.BF_SSN
						AND LNXX.LN_SEQ = LNXX.LN_SEQ
						AND LNXX.LA_CUR_PRI >= X.XX
						AND LNXX.LC_FED_PGM_YR = 'DLO'
						AND LNXX.LD_PIF_RPT IS NULL			
					INNER JOIN CDW..CS_TransferXLoans TL
						ON TL.BF_SSN = LNXX.BF_SSN
						AND TL.LN_SEQ = LNXX.LN_SEQ
				WHERE
					LNXX.LC_STA_LONXX = 'A'
					AND COALESCE(LNXX.LC_FAT_REV_REA,'') = ''
					AND LNXX.LD_FAT_EFF >= 'XXXX-XX-XX'
					AND LNXX.PC_FAT_TYP = 'XX'
					AND LNXX.PC_FAT_SUB_TYP = 'XX'
				GROUP BY
					LNXX.BF_SSN,
					LNXX.LN_SEQ
			) Trans
				ON Trans.BF_SSN = LNXX.BF_SSN
				AND Trans.LN_SEQ = LNXX.LN_SEQ
		WHERE
			LNXX.LC_FED_PGM_YR = 'DLO'
			AND LNXX.LD_PIF_RPT IS NULL
	) DLO
		ON DLO.BF_SSN = TX.BF_SSN
WHERE
	LNXX.LC_FED_PGM_YR = 'LNC'
	AND LNXX.LD_PIF_RPT IS NULL
	AND DLO.BF_SSN IS NULL --Exclude DLO people from showing up in both files

INSERT INTO CDW..CS_Transfer_EAXX(BF_SSN, LastName, FirstName, LoanId, LoanProgramType, GuarantyDate, SaleDate, DealId, PostSale, TransferNumber)
SELECT DISTINCT
	TX.BF_SSN,
	CentralData.dbo.TRIM(PDXX.DM_PRS_LST) AS LastName,
	CentralData.dbo.TRIM(PDXX.DM_PRS_X) AS FirstName,
	FSXX.LF_FED_AWD + RIGHT('XXX' + CAST(FSXX.LN_FED_AWD_SEQ AS VARCHAR(X)),X) AS LoanId,
	LNXX.IC_LON_PGM AS LoanProgramType,
	CONVERT(varchar,LNXX.LD_LON_GTR,XXX) AS GuarantyDate,
	'XX/XX/XXXX' AS SaleDate,
	'PSAOI' AS DealId,
	'Y' AS PostSale,
	X AS TransferNumber
FROM
	CDW..CS_TransferX TX
	INNER JOIN CDW..CS_TransferXLoans TL
		ON TL.BF_SSN = TX.BF_SSN
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = TX.BF_SSN
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
		AND LNXX.LN_SEQ = TL.LN_SEQ
		AND LNXX.LA_CUR_PRI >= X.XX
		--AND LNXX.LC_STA_LONXX = 'R'
	INNER JOIN CDW..FSXX_DL_LON FSXX
		ON FSXX.BF_SSN = LNXX.BF_SSN
		AND FSXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN 
	(
		SELECT DISTINCT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			SUM(COALESCE(LA_FAT_CUR_PRI,X.XX)) AS LA_FAT_CUR_PRI,
			SUM(COALESCE(LA_FAT_NSI,X.XX)) AS LA_FAT_NSI,
			MAX(LD_FAT_EFF) AS LD_FAT_EFF
		FROM
			CDW..LNXX_FIN_ATY LNXX
			INNER JOIN CDW..LNXX_LON LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
				AND LNXX.LA_CUR_PRI >= X.XX
				AND LNXX.LC_FED_PGM_YR = 'DLO'
				AND LNXX.LD_PIF_RPT IS NULL
			INNER JOIN CDW..CS_TransferXLoans TL
                ON TL.BF_SSN = LNXX.BF_SSN
                AND TL.LN_SEQ = LNXX.LN_SEQ
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND COALESCE(LNXX.LC_FAT_REV_REA,'') = ''
			AND LNXX.LD_FAT_EFF >= 'XXXX-XX-XX'
			AND LNXX.PC_FAT_TYP = 'XX'
			AND LNXX.PC_FAT_SUB_TYP = 'XX'
		GROUP BY
			LNXX.BF_SSN,
			LNXX.LN_SEQ
	) Trans
		ON Trans.BF_SSN = LNXX.BF_SSN
		AND Trans.LN_SEQ = LNXX.LN_SEQ
WHERE
	LNXX.LC_FED_PGM_YR = 'DLO'
	AND LNXX.LD_PIF_RPT IS NULL
