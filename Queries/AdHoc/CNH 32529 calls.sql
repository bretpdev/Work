--SELECT * FROM OPENQUERY(LEGEND,
--'
--SELECT DISTINCT
--	COUNT(DISTINCT PDXX.DF_PRS_ID) AS TOTAL_COUNT
--FROM
--	PKUB.PDXX_PRS_NME PDXX
--	INNER JOIN PKUB.LNXX_LON LNXX
--		ON PDXX.DF_PRS_ID = LNXX.BF_SSN
--	INNER JOIN PKUB.LNXX_FIN_ATY LNXX
--		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
--		AND LNXX.LN_SEQ = LNXX.LN_SEQ
--	INNER JOIN AES.PHXX_CNC_EML PHXX
--		ON RIGHT(CONCAT(''XXXXXXXXXX'', CAST(DF_SPE_ID AS VARCHAR(XX))), XX)= PDXX.DF_SPE_ACC_ID 
--	LEFT JOIN WEBFLSX.WBXX_CSM_USR_ACC WBXX
--		ON WBXX.DF_USR_SSN = PDXX.DF_PRS_ID
--WHERE
--	LNXX.PC_FAT_TYP = ''XX''
--	AND LNXX.PC_FAT_SUB_TYP = ''XX''
--	AND WBXX.DF_USR_SSN IS NULL
--	AND PHXX.DI_VLD_CNC_EML_ADR = ''Y''
--	AND (PHXX.DI_CNC_ELT_OPI = ''Y'' OR PHXX.DI_CNC_EBL_OPI = ''Y'' OR PHXX.DI_CNC_TAX_OPI = ''Y'')

--')


SELECT * FROM OPENQUERY(LEGEND,
'
SELECT DISTINCT
	--COUNT(DISTINCT PDXX.DF_PRS_ID) AS RS_COUNT
	PDXX.DF_SPE_ACC_ID
FROM
	PKUB.PDXX_PRS_NME PDXX
	INNER JOIN PKUB.LNXX_LON LNXX
		ON PDXX.DF_PRS_ID = LNXX.BF_SSN
	INNER JOIN PKUB.LNXX_FIN_ATY LNXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN PKUB.RSXX_BR_RPD RSXX
		ON RSXX.BF_SSN = PDXX.DF_PRS_ID
	INNER JOIN 
	(
		SELECT
			BF_SSN
		FROM
			PKUB.AYXX_BR_LON_ATY AYXX
		WHERE
			AYXX.PF_REQ_ACT IN (
								''CSVXX'',''DAXXX'',''DAXXX'',''DAXXX'',''DAXXX'',''DAXXX'',''DAXXX'',''DCXXX'',''DCXXX'',''DCXXX'',
								''DCXXX'',''DCXXX'',''DCXXX'',''DCXXX'',''DCXXX'',''DCXXX'',''DCXXX'',''DCXXX'',
								''DCXXX'',''DCXXX'',''DCXXX'',''DCXXX'',''DCXXX'',''DDPHN'',''DTXXX'',''NIDRA'',
								''OVRPS'',''PXXXA'',''PXXXC'',''PXXXJ'',''SXBCX'',''SXBCE'',''SXBDN'',''SXBDO'',
								''SXBRA'',''SXBRC'',''SXBRD'',''DDPHN'',''ADBPH'',''PXXXC''
								)
			AND AYXX.PF_RSP_ACT = ''CNTCT''

	) AYXX
		ON AYXX.BF_SSN = PDXX.DF_PRS_ID
	INNER JOIN AES.PHXX_CNC_EML PHXX
		ON RIGHT(CONCAT(''XXXXXXXXXX'', CAST(DF_SPE_ID AS VARCHAR(XX))), XX)= PDXX.DF_SPE_ACC_ID 
	LEFT JOIN WEBFLSX.WBXX_CSM_USR_ACC WBXX
		ON WBXX.DF_USR_SSN = PDXX.DF_PRS_ID
WHERE
	LNXX.PC_FAT_TYP = ''XX''
	AND LNXX.PC_FAT_SUB_TYP = ''XX''
	AND WBXX.DF_USR_SSN IS NULL
	AND PHXX.DI_VLD_CNC_EML_ADR = ''Y''
	AND (PHXX.DI_CNC_ELT_OPI = ''Y'' OR PHXX.DI_CNC_EBL_OPI = ''Y'' OR PHXX.DI_CNC_TAX_OPI = ''Y'')
	AND RSXX.LC_STA_RPSTXX = ''A''

')