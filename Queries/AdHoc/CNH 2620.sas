LIBNAME  LEGEND  REMOTE  SERVER=LEGEND SLIBREF=work  ;
RSUBMIT LEGEND;
/*%let DB = DNFPRQUT;  *This is test;*/
/*%let DB = DNFPRUUT;  *This is VUKX test;*/
%let DB = DNFPUTDL;  *This is live;

LIBNAME PKUB DBX DATABASE=&DB OWNER=PKUB;
PROC SQL;
	CREATE TABLE TOTALPOP AS
		SELECT DISTINCT
			PDXX.DF_SPE_ACC_ID AS Account_Number,
			PDXX.DF_PRS_ID
		FROM
			PKUB.PDXX_PRS_NME PDXX
		INNER JOIN PKUB.LNXX_LON_RPS LNXX
			ON LNXX.BF_SSN = PDXX.DF_PRS_ID
			AND LNXX.LC_TYP_SCH_DIS IN ('CA', 'CP', 'CQ', 'CX', 'CX', 'CX', 'IB', 'IL')
			AND LNXX.LC_STA_LONXX = 'A'
		INNER JOIN PKUB.RSXX_IBR_RPS RSXX
			ON RSXX.BF_SSN = PDXX.DF_PRS_ID
			AND RSXX.BD_ANV_QLF_IBR IS NULL
			AND RSXX.BC_STA_RSXX = 'A'
						
;
QUIT;
ENDRSUBMIT;

RSUBMIT LEGEND;
LIBNAME LEGEND DBX DATABASE=DNFPUTDL OWNER=PKUB;
PROC SQL;
	CREATE TABLE HASBALANCE AS
		SELECT DISTINCT
			TP.Account_Number,
			LNXX.LN_SEQ,
			LNXX.LA_CUR_PRI
		FROM
			PKUB.LNXX_LON LNXX
		INNER JOIN WORK.TOTALPOP TP
			ON TP.DF_PRS_ID = LNXX.BF_SSN
		WHERE LNXX.LA_CUR_PRI > X
						
;
QUIT;
ENDRSUBMIT;

RSUBMIT LEGEND;
LIBNAME LEGEND DBX DATABASE=DNFPUTDL OWNER=PKUB;
PROC SQL;
	CREATE TABLE NOBALANCE AS
		SELECT DISTINCT
			TP.Account_Number,
			LNXX.LN_SEQ,
			LNXX.LA_CUR_PRI
		FROM
			PKUB.LNXX_LON LNXX
		INNER JOIN WORK.TOTALPOP TP
			ON TP.DF_PRS_ID = LNXX.BF_SSN
		WHERE LNXX.LA_CUR_PRI <= X
						
;
QUIT;
ENDRSUBMIT;
DATA HASBALANCE; SET LEGEND.HASBALANCE; RUN;
DATA NOBALANCE; SET LEGEND.NOBALANCE; RUN;

PROC SQL;
	CREATE TABLE FINAL AS 
		SELECT DISTINCT
			BAL.Account_Number
		FROM WORK.HASBALANCE BAL
		INNER JOIN WORK.NOBALANCE NBAL
			ON NBAL.Account_Number = BAL.Account_Number
;
QUIT;

/*export to Excel spreadsheet*/
PROC EXPORT DATA= LEGEND.HASBALANCE 
            OUTFILE= "T:\SAS\NH_XXXX_HasBalance_&sysdate..xls" 
            DBMS=EXCEL REPLACE;
     SHEET="SheetX"; 
RUN;

PROC EXPORT DATA= WORK.NOBALANCE 
            OUTFILE= "T:\SAS\NH_XXXX_NoBalance_&sysdate..xls" 
            DBMS=EXCEL REPLACE;
     SHEET="SheetX"; 
RUN;

PROC EXPORT DATA= WORK.FINAL 
            OUTFILE= "T:\SAS\NH_XXXX_Loans_with_Balance_And_Zero_Balance_&sysdate..xls" 
            DBMS=EXCEL REPLACE;
     SHEET="SheetX"; 
RUN;

