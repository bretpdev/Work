DROP TABLE IF EXISTS #CREDIT

SELECT * INTO #CREDIT FROM
(
		SELECT 
			LN41.*
		FROM
			udw..LN41_LON_CRB_RPT LN41
			INNER JOIN udw..LN10_LON LN10
				ON LN10.BF_SSN = LN41.BF_SSN
				AND LN10.LN_SEQ = LN41.LN_SEQ
		WHERE
			LC_RPT_STA_CRB IN ('78','80','81','82','83','84')
			AND LD_RPT_CRB BETWEEN '06/01/2020' AND '02/28/2021'
			AND LN10.LA_CUR_PRI > 0
			AND LC_STA_LON10 = 'R'
) p


DROP TABLE IF EXISTS #PAST_DUE
DROP TABLE IF EXISTS #REPORTED
--The number of borrowers whose missed payments were reported to credit reporting agencies as current
SELECT  DISTINCT
	DD.bf_ssn,
	dd.ln_seq,
	CASE WHEN DD.AddedAt BETWEEN '06/01/2020' AND '06/30/2020' AND LN_DLQ_MAX > 60 THEN 1 ELSE NULL END D1,
	CASE WHEN DD.AddedAt BETWEEN '07/01/2020' AND '07/31/2020' AND LN_DLQ_MAX > 60 THEN 1 ELSE NULL END D2,
	CASE WHEN DD.AddedAt BETWEEN '08/01/2020' AND '08/31/2020' AND LN_DLQ_MAX > 60 THEN 1 ELSE NULL END D3,
	CASE WHEN DD.AddedAt BETWEEN '09/01/2020' AND '09/30/2020' AND LN_DLQ_MAX > 60 THEN 1 ELSE NULL END D4,
	CASE WHEN DD.AddedAt BETWEEN '10/01/2020' AND '10/31/2020' AND LN_DLQ_MAX > 60 THEN 1 ELSE NULL END D5,
	CASE WHEN DD.AddedAt BETWEEN '11/01/2020' AND '11/30/2020' AND LN_DLQ_MAX > 60 THEN 1 ELSE NULL END D6,
	CASE WHEN DD.AddedAt BETWEEN '12/01/2020' AND '12/31/2020' AND LN_DLQ_MAX > 60 THEN 1 ELSE NULL END D7,
	CASE WHEN DD.AddedAt BETWEEN '01/01/2021' AND '01/31/2021' AND LN_DLQ_MAX > 60 THEN 1 ELSE NULL END D8,
	CASE WHEN DD.AddedAt BETWEEN '02/01/2021' AND '02/28/2021' AND LN_DLQ_MAX > 60 THEN 1 ELSE NULL END D9
INTO #PAST_DUE
FROM 
	UDW.CALC.DailyDelinquency DD
	INNER JOIN 
		(
			SELECT DISTINCT
				LN10.BF_SSN
			FROM
				UDW..PD30_PRS_ADR PD30
				INNER JOIN UDW..PD10_PRS_NME PD10
					ON PD30.DF_PRS_ID = PD10.DF_PRS_ID
				INNER JOIN AuditUDW..LN10_LON_Feb2021 LN10
					ON LN10.BF_SSN = PD10.DF_PRS_ID
			WHERE
				PD30.DC_ADR = 'L'
				AND PD30.DC_DOM_ST = 'NY'
				AND CAST(PD30.DF_LST_DTS_PD30 AS DATE) <= CAST('02/28/2021' AS DATE)
				AND LN10.LC_STA_LON10 = 'R'
				AND LN10.LA_CUR_PRI > 0.00

			UNION ALL

			SELECT DISTINCT
				LN10.BF_SSN
			FROM
				UDW..PD31_PRS_INA PD31
				INNER JOIN UDW..PD10_PRS_NME PD10
					ON PD31.DF_PRS_ID = PD10.DF_PRS_ID
				INNER JOIN AuditUDW..LN10_LON_Feb2021 LN10
					ON LN10.BF_SSN = PD10.DF_PRS_ID
			WHERE
				PD31.DC_ADR_HST = 'L'
				AND PD31.DC_DOM_ST_HST = 'NY'
				AND CAST(PD31.DD_CRT_PD31 AS DATE) BETWEEN CAST('06/01/2020' AS DATE) AND CAST('02/28/2021' AS DATE)
				AND LN10.LC_STA_LON10 = 'R'
				AND LN10.LA_CUR_PRI > 0.00
		) ny
			ON NY.BF_SSN = DD.BF_SSN
WHERE 
	AddedAt BETWEEN '06/01/2020' AND '02/28/2021'
	AND LN_DLQ_MAX > 60



--The number of borrowers whose missed payments were not reported to credit reporting agencies as current
SELECT DISTINCT
	C.BF_SSN,
	C.LN_SEQ,
	CASE 
			WHEN LD_RPT_CRB between '06/01/2020' and '06/30/2020' then 
			1
			
		end AS d1,
		CASE 
			WHEN LD_RPT_CRB between '07/01/2020' and '07/31/2020' then 
			1
			
		end AS d2,
		CASE 
			WHEN LD_RPT_CRB between '08/01/2020' and '08/31/2020' then 
			1
			
		end AS d3,
		CASE 
			WHEN LD_RPT_CRB between '09/01/2020' and '09/30/2020' then 
			1
			
		end AS d4,
		CASE 
			WHEN LD_RPT_CRB between '10/01/2020' and '10/31/2020' then 
			1
			
		end AS d5,
		CASE 
			WHEN LD_RPT_CRB between '11/01/2020' and '11/30/2020' then 
			1
			
		end AS d6,
		CASE 
			WHEN LD_RPT_CRB between '12/01/2020' and '12/31/2020' then 
			1
			
		end AS d7,
		CASE 
			WHEN LD_RPT_CRB between '01/01/2021' and '01/31/2020' then 
			1
			
		end AS d8,
		CASE 
			WHEN LD_RPT_CRB between '02/01/2021' and '02/28/2021' then 
			1
			
		end AS d9
INTO #REPORTED
FROM 
	#CREDIT C
			INNER JOIN 
	(
		SELECT DISTINCT
			LN10.BF_SSN
		FROM
			UDW..PD30_PRS_ADR PD30
			INNER JOIN UDW..PD10_PRS_NME PD10
				ON PD30.DF_PRS_ID = PD10.DF_PRS_ID
			INNER JOIN AuditUDW..LN10_LON_Feb2021 LN10
				ON LN10.BF_SSN = PD10.DF_PRS_ID
		WHERE
			PD30.DC_ADR = 'L'
			AND PD30.DC_DOM_ST = 'NY'
			AND CAST(PD30.DF_LST_DTS_PD30 AS DATE) <= CAST('02/28/2021' AS DATE)
			AND LN10.LC_STA_LON10 = 'R'
			AND LN10.LA_CUR_PRI > 0.00

		UNION ALL

		SELECT DISTINCT
			LN10.BF_SSN
		FROM
			UDW..PD31_PRS_INA PD31
			INNER JOIN UDW..PD10_PRS_NME PD10
				ON PD31.DF_PRS_ID = PD10.DF_PRS_ID
			INNER JOIN AuditUDW..LN10_LON_Feb2021 LN10
				ON LN10.BF_SSN = PD10.DF_PRS_ID
		WHERE
			PD31.DC_ADR_HST = 'L'
			AND PD31.DC_DOM_ST_HST = 'NY'
			AND CAST(PD31.DD_CRT_PD31 AS DATE) BETWEEN CAST('06/01/2020' AS DATE) AND CAST('02/28/2021' AS DATE)
			AND LN10.LC_STA_LON10 = 'R'
			AND LN10.LA_CUR_PRI > 0.00
	) ny
		ON NY.BF_SSN = C.BF_SSN

SELECT 
	SUM(CASE WHEN PD.D1 IS NOT NULL AND R.D1 IS NULL THEN 1 ELSE 0 END) AS D1,
	SUM(CASE WHEN PD.D2 IS NOT NULL AND R.D2 IS NULL THEN 1 ELSE 0 END )AS D2,
	SUM(CASE WHEN PD.D3 IS NOT NULL AND R.D3 IS NULL THEN 1 ELSE 0 END) AS D3,
	SUM(CASE WHEN PD.D4 IS NOT NULL AND R.D4 IS NULL THEN 1 ELSE 0 END) AS D4,
	SUM(CASE WHEN PD.D5 IS NOT NULL AND R.D5 IS NULL THEN 1 ELSE 0 END) AS D5,
	SUM(CASE WHEN PD.D6 IS NOT NULL AND R.D6 IS NULL THEN 1 ELSE 0 END) AS D6,
	SUM(CASE WHEN PD.D7 IS NOT NULL AND R.D7 IS NULL THEN 1 ELSE 0 END) AS D7,
	SUM(CASE WHEN PD.D7 IS NOT NULL AND R.D7 IS NULL THEN 1 ELSE 0 END) AS D8,
	SUM(CASE WHEN PD.D7 IS NOT NULL AND R.D7 IS NULL THEN 1 ELSE 0 END) AS D9
FROM 
	#PAST_DUE PD
	LEFT JOIN #REPORTED R
		ON R.BF_SSN = PD.BF_SSN
		AND R.LN_SEQ = PD.LN_SEQ





--The number of borrowers whose missed payments were not reported to credit reporting agencies as current
SELECT DISTINCT
	sum(CASE 
			WHEN LD_RPT_CRB between '06/01/2020' and '06/30/2020' then
			1
			ELSE
			0
		end) over() AS d1,
		sum(CASE 
			WHEN LD_RPT_CRB between '07/01/2020' and '07/31/2020' then  
			1
			ELSE
			0
		end) over() AS d2,
		sum(CASE 
			WHEN LD_RPT_CRB between '08/01/2020' and '08/31/2020' then 
			1
			ELSE
			0
		end) over() AS d3,
		sum(CASE 
			WHEN LD_RPT_CRB between '09/01/2020' and '09/30/2020' then
			1
			ELSE
			0
		end) over() AS d4,
		sum(CASE 
			WHEN LD_RPT_CRB between '10/01/2020' and '10/31/2020' then
			1
			ELSE
			0
		end) over() AS d5,
		sum(CASE 
			WHEN LD_RPT_CRB between '11/01/2020' and '11/30/2020' then
			1
			ELSE
			0
		end) over() AS d6,
		sum(CASE 
			WHEN LD_RPT_CRB between '12/01/2020' and '12/31/2020' then 
			1
			ELSE
			0
		end) over() AS d7,
		sum(CASE 
			WHEN LD_RPT_CRB between '01/01/2021' and '01/31/2020' then  
			1
			ELSE
			0
		end) over() AS d8,
		sum(CASE 
			WHEN LD_RPT_CRB between '02/01/2021' and '02/28/2021' then 
			1
			ELSE
			0
		end) over() AS d9
FROM 
	#CREDIT C
			INNER JOIN 
	(
		SELECT DISTINCT
			LN10.BF_SSN
		FROM
			UDW..PD30_PRS_ADR PD30
			INNER JOIN UDW..PD10_PRS_NME PD10
				ON PD30.DF_PRS_ID = PD10.DF_PRS_ID
			INNER JOIN AuditUDW..LN10_LON_Feb2021 LN10
				ON LN10.BF_SSN = PD10.DF_PRS_ID
		WHERE
			PD30.DC_ADR = 'L'
			AND PD30.DC_DOM_ST = 'NY'
			AND CAST(PD30.DF_LST_DTS_PD30 AS DATE) <= CAST('02/28/2021' AS DATE)
			AND LN10.LC_STA_LON10 = 'R'
			AND LN10.LA_CUR_PRI > 0.00

		UNION ALL

		SELECT DISTINCT
			LN10.BF_SSN
		FROM
			UDW..PD31_PRS_INA PD31
			INNER JOIN UDW..PD10_PRS_NME PD10
				ON PD31.DF_PRS_ID = PD10.DF_PRS_ID
			INNER JOIN AuditUDW..LN10_LON_Feb2021 LN10
				ON LN10.BF_SSN = PD10.DF_PRS_ID
		WHERE
			PD31.DC_ADR_HST = 'L'
			AND PD31.DC_DOM_ST_HST = 'NY'
			AND CAST(PD31.DD_CRT_PD31 AS DATE) BETWEEN CAST('06/01/2020' AS DATE) AND CAST('02/28/2021' AS DATE)
			AND LN10.LC_STA_LON10 = 'R'
			AND LN10.LA_CUR_PRI > 0.00
	) ny
		ON NY.BF_SSN = C.BF_SSN