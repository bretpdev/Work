/*CREATE LIBNAME FOR REMOTE SERVER'S WORK FOLDER*/
/*TODO: delete the unneeded line*/
LIBNAME WORKLOCL REMOTE SERVER=LEGEND SLIBREF=WORK;


/*CREATE FILENAME FOR OUTPUT*/
%LET RPTLIB = T:\SAS;
FILENAME REPORTX "&RPTLIB/Texting X.XX.XX.XLSX"; /*TODO: update the outfile name*/

/*CREATE LIBRARY OF EXCEL DATA*/
LIBNAME XLIB XLSX 'T:\SAS\Texting X.XX.XX.xlsx'; /*TODO: update the infile name*/

/*CREATE DATA SET FROM A SPECIFIC SHEET IN THE EXCEL FILE*/
DATA XLDATA; SET XLIB.BRTXT_ARC_Add; RUN; /*TODO: update the sheet name*/

/*COPY EXCEL DATA TO REMOTE SERVER*/
DATA WORKLOCL.XDATA; SET XLDATA; RUN;

/*SUBMIT CODE TO REMOTE SERVER*/
RSUBMIT LEGEND;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;
LIBNAME AES DBX DATABASE=DNFPUTDL OWNER=AES;
%let DB = DNFPUTDL;
%let OWNR = PKUB;

PROC SQL STIMER;
	CONNECT TO DBX (DATABASE=&DB); 

/*	GET DATA FOR ALL BORROWERS*/
	CREATE TABLE JOINDATA AS
		SELECT 
			XDAT.*,
			DBXD.LD_ATY_REQ_RCV
		FROM 
			XDATA XDAT
			LEFT JOIN
				CONNECTION TO DBX 
				(
					SELECT
						PDXX.DF_SPE_ACC_ID,
						AYXX.LD_ATY_REQ_RCV
					FROM
						&OWNR..PDXX_PRS_NME PDXX
						INNER JOIN &OWNR..AYXX_BR_LON_ATY AYXX
							ON PDXX.DF_PRS_ID = AYXX.BF_SSN
							AND AYXX.PF_REQ_ACT = 'BRTXT'	
					FOR READ ONLY WITH UR
				) DBXD
					ON DBXD.DF_SPE_ACC_ID = XDAT.DF_SPE_ACC_ID
	;
	DISCONNECT FROM DBX;


QUIT;

ENDRSUBMIT;

/*COPY JOINED DATA TO WORK*/
DATA JOINDATA; SET WORKLOCL.JOINDATA; RUN;

/*EXPORT JOINED DATA TO A REPORT*/
/*PROC EXPORT DATA= WORK.JOINDATA*/
/*	OUTFILE= REPORTX */
/*	REPLACE*/
/*	DBMS=XLSX;*/
/*RUN;*/

PROC EXPORT 
	DATA= WORK.JOINDATA
	OUTFILE= "T:\SAS\UNH XXXXX.CSV" 
	DBMS=CSV; 
RUN;
