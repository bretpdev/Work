USE UDW
GO
DROP TABLE IF EXISTS #DATA 
DROP TABLE IF EXISTS #FINAL
SELECT DISTINCT
	PD10.DF_SPE_ACC_ID,
	LN40.BF_SSN,
	LN40.LN_SEQ,
	LN40.LD_SBM_CLM_PCL,
	LN16.LD_DLQ_OCC,
	LN16.LN_DLQ_MAX,
	DATEADD(DAY, 90, LN16.LD_DLQ_OCC) AS NINETY_DAYS
	INTO #DATA
FROM 
	UDW..LN40_LON_CLM_PCL LN40
	INNER JOIN UDW..PD10_PRS_NME PD10
		ON PD10.DF_PRS_ID = LN40.BF_SSN
	INNER JOIN
	(
		SELECT
			LN16.BF_SSN,
			LN16.LN_SEQ,
			LN16.LD_DLQ_OCC,
			LN16.LN_DLQ_MAX
		FROM	
			UDW..LN16_LON_DLQ_HST LN16
			INNER JOIN 
			(
				SELECT
					BF_SSN,
					LN_SEQ,
					MAX(LD_DLQ_OCC) AS LD_DLQ_OCC
				FROM 
					UDW..LN16_LON_DLQ_HST
				GROUP BY
					BF_SSN,
					LN_SEQ
			)M_DEL	
				ON M_DEL.BF_SSN = LN16.BF_SSN	
				AND M_DEL.LN_SEQ = LN16.LN_SEQ	
				AND M_DEL.LD_DLQ_OCC = LN16.LD_DLQ_OCC	
			
	) LN16
		ON LN16.BF_SSN = LN40.BF_SSN
		AND LN16.LN_SEQ = LN40.LN_SEQ
	LEFT JOIN
	(
		SELECT DISTINCT 
			BF_SSN, 
			LN_SEQ 
		FROM 
			UDW..LN40_LON_CLM_PCL 
		WHERE 
			LC_REA_CLP_LON != '06' 
			AND LD_CAN_CLM_PCL IS NULL
	) OCLM
		ON OCLM.BF_SSN = LN40.BF_SSN
		AND OCLM.LN_SEQ = LN40.LN_SEQ
WHERE
	YEAR(LN16.LD_DLQ_OCC) >= 2017
	AND LN16.LN_DLQ_MAX >= 90
	AND LN40.LD_SBM_CLM_PCL > LN16.LD_DLQ_OCC
	AND LN40.LC_TYP_REC_CLP_LON IN ('1','3')
	AND LN40.LD_CAN_CLM_PCL IS NULL
	AND OCLM.LN_SEQ IS NULL

SELECT
	D.DF_SPE_ACC_ID,
	D.BF_SSN,
	D.LN_SEQ,
	D.LD_SBM_CLM_PCL,
	D.LD_DLQ_OCC,
	D.NINETY_DAYS,
	COUNT(DISTINCT ACTIVITYDATE) AS AUTOMATED_COUNT,
	COUNT(DISTINCT MAN_CALLS.LD_ATY_REQ_RCV) AS MANUAL_DIAL_COUNT,
	COUNT(DISTINCT SKIP_CALLS.LD_ATY_REQ_RCV) AS SKIP_DIAL_COUNT
INTO #FINAL
FROM
	#DATA D
	LEFT JOIN 
	(
		SELECT DISTINCT
			ISNULL(PD10.DF_PRS_ID, NCH.AccountIdentifier) AS SSN, 
			PD10.DF_SPE_ACC_ID,
			NCH.AccountIdentifier,
			NCH.CallCampaign,
			NCH.ActivityDate,
			NCH.PhoneNumber,
			NCH.DispositionCode,
			NCH.IsInbound
		FROM
			NobleCalls..NobleCallHistory NCH
			LEFT JOIN UDW..PD10_PRS_NME PD10
				ON PD10.DF_SPE_ACC_ID = NCH.AccountIdentifier
				AND PD10.DF_PRS_ID NOT LIKE 'P%'
		WHERE
			NCH.RegionId = 2
			AND YEAR(NCH.CreatedAt) >= 2017
			AND NCH.AccountIdentifier IS NOT NULL
			AND NCH.DeletedAt IS NULL 
			
	) CALLS
		ON CALLS.SSN = D.BF_SSN
		AND CALLS.ActivityDate BETWEEN D.LD_DLQ_OCC AND NINETY_DAYS
	LEFT JOIN
	(
		SELECT
			BF_SSN,
			LD_ATY_REQ_RCV
		FROM
			UDW..AY10_BR_LON_ATY
		WHERE
			PF_REQ_ACT IN ('P199A')
			AND YEAR(LD_ATY_REQ_RCV) >= 2017
	)MAN_CALLS
		ON MAN_CALLS.BF_SSN = D.BF_SSN
		AND MAN_CALLS.LD_ATY_REQ_RCV BETWEEN D.LD_DLQ_OCC AND NINETY_DAYS
	LEFT JOIN
	(
		SELECT
			BF_SSN,
			LD_ATY_REQ_RCV
		FROM
			UDW..AY10_BR_LON_ATY ay10
		WHERE
			PF_REQ_ACT IN ('KABA2','KSEA1','KURDA','S1RDN','S1RDO','S1RDR','S1RDT','S1RFA','S1RFC','S1RFD','S1RFN','KEMP0','KURDA','S1BC2','S1BC3','S1BCE'
			,'S1BDN','S1BDO','S1BDR','S1BDS','S1BDT','S1BDV','S1BDX','S1BRA','S1BRC','S1BRD','S1BRN','S1EB1','S1EB2','S1EB3','S1EB4','S1EB5','S1EC2','S1EC3',
			'S1ECE','S1ED1','S1ED2','S1ED3','S1ED4','S1ED5','S1ED6','S1ED7','S1ED8','S1EDN','S1EDO','S1EDR','S1EDT','S1ENA','S1ENC','S1END','S1ENN','S1IBC','S1IBE',
			'S1IDA','S1IDE','S1IEC','S1IEE','S1IRC','S1IRE','S1MBC','S1MEC','S1OLE','S1ORL','S1PLA','S1RD1','S1RD2','S1RD3','S1RD4','S1RD5'
			,'KEMAL','S2LND','S2RFC','S2SCC','S3ELB','S3LND','S3PBP','S3PEP','S3RFC','S4ECB','S4ECE','S4ECM','S4ECR','S4ECS','S4LND','S4RPO','S4RPE','S6BE1','S6BE2','S6BE2','S6BE3','S6CES','S6CE7','S6CE6','S6CE5','S6EBS','S6EES','S6ER2','S6ER3','S6ERS','S6ERT','S6JBS','S6JES',
'S6LBB','S6LBD','S6LBD','S6LBL','S6RBO','S6RBS','S6RES','S6RFO','S6RFR','S6RFS','S6RFT','S7DDE','S7DDF','SEND1','SREF1','STPIV','STPNC','SKQ76',
'KULSK','KSBA1','KGNRL','KLVPA','KLSLT')
			AND YEAR(LD_ATY_REQ_RCV) >= 2017
	)SKIP_CALLS
		ON SKIP_CALLS.BF_SSN = D.BF_SSN
		AND SKIP_CALLS.LD_ATY_REQ_RCV BETWEEN D.LD_DLQ_OCC AND NINETY_DAYS
GROUP BY
	D.DF_SPE_ACC_ID,
	D.BF_SSN,
	D.LN_SEQ,
	D.LD_DLQ_OCC,
	D.LN_DLQ_MAX,
	D.NINETY_DAYS,
	D.LD_SBM_CLM_PCL

SELECT DISTINCT
	F.*, 
	(AUTOMATED_COUNT + MANUAL_DIAL_COUNT + SKIP_DIAL_COUNT) AS TOTAL_CALLS_MADE,
	GR10.LF_LON_CUR_OWN AS LENDER,
	GR10.IF_GTR AS GUARANTOR ,
	DW01.WC_DW_LON_STA,
	LK10.PX_DSC_MDM
FROM 
	#FINAL F
	INNER JOIN UDW..GR10_RPT_LON_APL GR10
		ON GR10.BF_SSN = F.BF_SSN
		AND GR10.LN_SEQ = F.LN_SEQ
	INNER JOIN UDW..DW01_DW_CLC_CLU DW01
		ON DW01.BF_SSN = F.BF_SSN
		AND DW01.LN_SEQ = F.LN_SEQ
		AND DW01.WC_DW_LON_STA NOT IN (06) --CURE
	left join (SELECT * FROM OPENQUERY(DUSTER, 'SELECT * FROM OLWHRM1.LK10_LS_CDE_LKP WHERE PM_ATR = ''WC-DW-LON-STA''')
	) LK10
		ON LK10.PX_ATR_VAL = DW01.WC_DW_LON_STA
ORDER BY 
	(AUTOMATED_COUNT + MANUAL_DIAL_COUNT + SKIP_DIAL_COUNT)