SELECT DISTINCT 
	LNXX.BF_SSN,
	LNXX.LN_SEQ,
	 FSXX.LF_FED_AWD + RIGHT('XXX' + CAST(FSXX.LN_FED_AWD_SEQ AS VARCHAR(XX)),X) AS AWARD_ID,
	lnXX.la_cur_pri as outstanding_balance, 
	LAST_PAY.LD_FAT_PST,
	 EAXX.TransferNumber AS TransferNumber
	 --CASE WHEN OT.c > X THEN 'Y' ELSE 'N' END AS APPLIED_TO_OTHER_LOANS_AS_WELL
FROM 
	CDW..LNXX_LON LNXX
	INNER JOIN CDW..FSXX_DL_LON FSXX
		ON FSXX.BF_SSN = LNXX.BF_SSN
		AND FSXX.LN_SEQ = LNXX.LN_SEQ
	left JOIN CDW..CS_Transfer_EAXX EAXX
		ON EAXX.BF_SSN = LNXX.BF_SSN
		and eaXX.TransferNumber in (X,X,X,X)
	LEFT JOIN 
	(
		SELECT
			LNXX.*
		FROM
			CDW..LNXX_FIN_ATY LNXX
			INNER JOIN 
			(
				SELECT DISTINCT
				   LNXX.BF_SSN,
				   LNXX.LN_SEQ,
				   MAX(LD_FAT_PST) AS LD_FAT_PST
				FROM
					   CDW..LNXX_FIN_ATY LNXX
				WHERE
					   LNXX.LC_STA_LONXX = 'A'
					   AND COALESCE(LNXX.LC_FAT_REV_REA,'') = ''
					   AND LNXX.PC_FAT_TYP != 'XX'
						AND LNXX.PC_FAT_SUB_TYP != 'XX'
				GROUP BY 
					LNXX.BF_SSN,
					LNXX.LN_SEQ
			)ML
				ON ML.BF_SSN = LNXX.BF_SSN
				AND ML.LN_SEQ = LNXX.LN_SEQ
				AND ML.LD_FAT_PST = LNXX.LD_FAT_EFF
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND COALESCE(LNXX.LC_FAT_REV_REA,'') = ''
	) LAST_PAY
		ON LAST_PAY.BF_SSN = LNXX.BF_SSN
		AND LAST_PAY.LN_SEQ = LNXX.LN_SEQ
	LEFT JOIN
	(
		select
p.BF_SSN,
count(distinct ln_seq) as c

from
(
select 
	lnXXX.*
	--count(*) as c 
from 
	(
	SELECT
		LNXX.*
	FROM
		CDW..LNXX_FIN_ATY LNXX
		INNER JOIN 
		(
			SELECT
				LNXX.BF_SSN,
				LNXX.LN_SEQ,
				MAX(LD_FAT_PST) AS LD_FAT_PST
			FROM
					CDW..LNXX_FIN_ATY LNXX
					INNER JOIN CDW..LNXX_LON LNXX
						ON LNXX.BF_SSN = LNXX.BF_SSN
						AND LNXX.LN_SEQ = LNXX.LN_SEQ
						AND LNXX.LC_STA_LONXX = 'R'
						AND LNXX.LA_CUR_PRI < X
			WHERE
					LNXX.LC_STA_LONXX = 'A'
					AND COALESCE(LNXX.LC_FAT_REV_REA,'') = ''
					AND LNXX.PC_FAT_TYP != 'XX'
					AND LNXX.PC_FAT_SUB_TYP != 'XX'
			GROUP BY 
				LNXX.BF_SSN,
				LNXX.LN_SEQ
	)ML
		ON ML.BF_SSN = LNXX.BF_SSN
		AND ML.LN_SEQ = LNXX.LN_SEQ
		AND ML.LD_FAT_PST = LNXX.LD_FAT_PST
WHERE
	LNXX.LC_STA_LONXX = 'A'
	AND COALESCE(LNXX.LC_FAT_REV_REA,'') = ''
	) LNXX
	INNER JOIN [CDW].[dbo].[LNXX_LON_PAY_FAT] LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
		AND LNXX.LN_FAT_SEQ = LNXX.LN_FAT_SEQ
	INNER JOIN [CDW].[dbo].[LNXX_LON_PAY_FAT] LNXXX
		ON LNXX.BF_SSN = LNXXX.BF_SSN
		--AND LNXX.LN_FAT_SEQ = LNXXX.LN_FAT_SEQ
		AND LNXX.LD_RMT_BCH_INI = LNXXX.LD_RMT_BCH_INI
		AND LNXX.LC_RMT_BCH_SRC_IPT = LNXXX.LC_RMT_BCH_SRC_IPT
		AND LNXX.LN_RMT_BCH_SEQ = LNXXX.LN_RMT_BCH_SEQ
		AND LNXX.LN_RMT_SEQ = LNXXX.LN_RMT_SEQ
		AND LNXX.LN_RMT_ITM = LNXXX.LN_RMT_ITM
		AND LNXX.LN_RMT_ITM_SEQ = LNXXX.LN_RMT_ITM_SEQ
where 
	LNXX.LC_STA_LONXX = 'A'
	AND COALESCE(LNXX.LC_FAT_REV_REA,'') = ''
	
--group by
--	LNXX.bf_ssn
)p
group by p.bf_ssn

	) OT
		ON OT.BF_SSN = LNXX.BF_SSN
WHERE 
	LNXX.LC_STA_LONXX = 'R' 
	AND LNXX.LA_CUR_PRI < X
	--AND LNXX.BF_SSN = 'XXXXXXXXX'
ORDER BY
	LNXX.BF_SSN,
	LNXX.LN_SEQ