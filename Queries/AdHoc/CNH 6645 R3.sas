%LET RPTLIB = Y:\Development\SAS Test Files\Riley\UNWSXX RX;
FILENAME REPORTX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTXX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTXX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTXX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTXX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTXX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTXX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTXX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTXX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTXX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTXX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTXX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTXX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTXX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";
FILENAME REPORTXX "&RPTLIB/UNWSXX.NWSXXRX.#XXXV.#XXXXXX";


/*XXXXXXXXXX,PHNUP,,,,XXXXXXXXX,E,XXXXXXXXX,ALL,Phone consent received per online terms and conditions*/
DATA ALLSET (DROP=V);
	INFILE REPORTX DSD;
	LENGTH DF_SPE_ACC_ID $ XX BF_SSN $ X LF_EDS $ X;
	INPUT DF_SPE_ACC_ID $ V $ V $ V $ V$ BF_SSN $ V $ LF_EDS $;
RUN;

%MACRO GETFILES(FNO);
	DATA INSET (DROP=V);
		INFILE REPORT&FNO DSD;
		LENGTH DF_SPE_ACC_ID $ XX BF_SSN $ X LF_EDS $ X;
		INPUT DF_SPE_ACC_ID $ V $ V $ V $ V$ BF_SSN $ V $ LF_EDS $;
	RUN;

	DATA ALLSET;
		SET ALLSET INSET;
	RUN;
%MEND;

%GETFILES(X);
%GETFILES(X);
%GETFILES(X);
%GETFILES(X);
%GETFILES(X);
%GETFILES(X);
%GETFILES(X);
%GETFILES(X);
%GETFILES(XX);
%GETFILES(XX);
%GETFILES(XX);
%GETFILES(XX);
%GETFILES(XX);
%GETFILES(XX);
%GETFILES(XX);
%GETFILES(XX);
%GETFILES(XX);
%GETFILES(XX);
%GETFILES(XX);
%GETFILES(XX);
%GETFILES(XX);
%GETFILES(XX);

PROC SORT DATA=ALLSET NODUPKEY;
	BY DF_SPE_ACC_ID;
RUN;

LIBNAME LEGEND REMOTE SERVER=LEGEND SLIBREF=WORK;
DATA LEGEND.ALLSET; SET ALLSET; RUN;
RSUBMIT;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;
PROC SQL;
	CREATE TABLE ENDS AS
		SELECT
			ALL.DF_SPE_ACC_ID,
			ALL.BF_SSN,
			ALL.LF_EDS,
			LNXX.LN_SEQ
		FROM
			ALLSET ALL
			JOIN PKUB.LNXX_EDS LNXX
				ON ALL.BF_SSN = LNXX.BF_SSN
				AND ALL.LF_EDS = LNXX.LF_EDS
		ORDER BY
			ALL.DF_SPE_ACC_ID,
			LNXX.LN_SEQ
	;
QUIT;
ENDRSUBMIT;

DATA ENDS; SET LEGEND.ENDS; RUN;

DATA RX (DROP=LN_SEQ);
	SET ENDS END=LAST;
	LENGTH VALLIST $XXX. ;
	BY DF_SPE_ACC_ID LN_SEQ;
	RETAIN VALLIST;

	IF FIRST.DF_SPE_ACC_ID THEN VALLIST = LEFT(PUT(LN_SEQ,X.));
	ELSE VALLIST = CATX(',',TRIM(VALLIST),LEFT(PUT(LN_SEQ,X.)));

	IF LAST.DF_SPE_ACC_ID THEN OUTPUT;
RUN;

DATA _NULL_;
	SET RX ;
	FILE 'T:\RX' DELIMITER=',' DSD DROPOVER LRECL=XXXXX;
	LENGTH COMMENT $XXX;
	COMMENT = CAT('Phn consent rcved per online terms and conditions END ACCT ',DF_SPE_ACC_ID);
	PUT DF_SPE_ACC_ID 'EWEBC,,,,' BF_SSN 'E,' LF_EDS VALLIST COMMENT;
RUN;
