LIBNAME LEGEND REMOTE SERVER=LEGEND SLIBREF=WORK;
RSUBMIT;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;

PROC SQL;
	CREATE TABLE BORROWER AS
		SELECT DISTINCT
			LNXX.BF_SSN,
			DF_SPE_ACC_ID,
			PDXX.DM_PRS_X || ' '  ||PDXX.DM_PRS_LST as name,
			PDXX.DX_STR_ADR_X,
			PDXX.DX_STR_ADR_X,
			PDXX.DM_CT,
			PDXX.DC_DOM_ST,
			PDXX.DF_ZIP_CDE,
			PDXX.DM_FGN_CNY,
			PDXX.DM_FGN_ST,
			LNXX.LN_SEQ,
			LNXX.LD_LON_X_DSB,
			LNXX.LA_LON_AMT_GTR,
			LNXX.LA_CUR_PRI,
			LNXX.IC_LON_PGM,
			(LNXX.LR_ITR / XXX) AS LR_ITR,
			LNXX.LC_TYP_SCH_DIS,
			LNXX.LA_TOT_RPD_DIS,
			LNXX.LA_ANT_CAP,
			RSXX.LD_RPS_X_PAY_DU,
			LNXX.LN_RPS_TRM,
			LNXX.LA_RPS_ISL 
		FROM 
			PKUB.AYXX_BR_LON_ATY AYXX
			INNER JOIN PKUB.PDXX_PRS_NME PDXX
				ON PDXX.DF_PRS_ID = AYXX.BF_SSN
			INNER JOIN PKUB.PDXX_PRS_ADR PDXX
				ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
			INNER JOIN PKUB.RSXX_BR_RPD RSXX
				ON RSXX.BF_SSN = AYXX.BF_SSN
			INNER JOIN PKUB.LNXX_LON_RPS LNXX
				ON RSXX.BF_SSN = LNXX.BF_SSN
				AND RSXX.LN_RPS_SEQ = LNXX.LN_RPS_SEQ
			INNER JOIN PKUB.LNXX_LON_RPS_SPF LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
				AND LNXX.LN_RPS_SEQ = LNXX.LN_RPS_SEQ
			INNER JOIN PKUB.LNXX_LON LNXX
				ON LNXX.BF_SSN = AYXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
			LEFT JOIN PKUB.LNXX_INT_RTE_HST LNXX
	            ON LNXX.BF_SSN = LNXX.BF_SSN
	            AND LNXX.LN_SEQ = LNXX.LN_SEQ
	            AND LNXX.LC_STA_LONXX = 'A'
	            AND TODAY() BETWEEN LNXX.LD_ITR_EFF_BEG AND LNXX.LD_ITR_EFF_END

		WHERE 
			AYXX.PF_REQ_ACT = 'APIDR'
			AND RSXX.LC_STA_RPSTXX = 'A'
			and LNXX.LC_STA_LONXX = 'A'
			AND PDXX.DC_ADR = 'L'
	;
QUIT;

ENDRSUBMIT;

DATA BORROWER;
SET LEGEND.BORROWER;
RUN;

%LET CDW = %STR(REQUIRED="FILEDSN=X:\PADR\ODBC\CDW.dsn; update_lock_typ=nolock; bl_keepnulls=no");
LIBNAME CDW ODBC &CDW ;

PROC SQL;
	CREATE TABLE LOANS AS 
		SELECT DISTINCT
			B.*,
			FMT.Label as lon_pgm
		FROM
			BORROWER B
		LEFT JOIN CDW.FormatTranslation FMT
			ON B.IC_LON_PGM = FMT.Start
;
QUIT;


%MACRO LN_BIL(DS,NEWDS,NEWCOL);
PROC TRANSPOSE DATA=&DS OUT=LOANS&NEWDS (DROP=_NAME_ _LABEL_) PREFIX=&NEWCOL;
	VAR &NEWCOL;
	BY BF_SSN;
RUN;
%MEND LN_BIL;

%LN_BIL(LOANS,X,LN_SEQ);
%LN_BIL(LOANS,X,LD_LON_X_DSB);
%LN_BIL(LOANS,X,LA_LON_AMT_GTR);
%LN_BIL(LOANS,X,LA_CUR_PRI);
%LN_BIL(LOANS,X,lon_pgm);
%LN_BIL(LOANS,X,LC_TYP_SCH_DIS);
%LN_BIL(LOANS,X,LA_TOT_RPD_DIS);
%LN_BIL(LOANS,X,LA_ANT_CAP);
%LN_BIL(LOANS,X,LD_RPS_X_PAY_DU);
%LN_BIL(LOANS,XX,LN_RPS_TRM);
%LN_BIL(LOANS,XX,LA_RPS_ISL);
%LN_BIL(LOANS,XX,LR_ITR);

DATA LOANS_DEM (KEEP= BF_SSN DF_SPE_ACC_ID name DX_STR_ADR_X DX_STR_ADR_X DM_CT DC_DOM_ST DF_ZIP_CDE DM_FGN_CNY DM_FGN_ST);
SET LOANS;
RUN;

PROC SORT DATA=LOANS_DEM NODUPKEY;
	BY BF_SSN;

DATA LOANS_F;
MERGE LOANSX LOANSX LOANSX LOANSX LOANSX LOANSX LOANSX LOANSX LOANSX LOANSXX LOANSXX LOANSXX;
BY BF_SSN;
RUN;

PROC SORT DATA=LOANS_F NODUPKEY;
	BY BF_SSN;

DATA FILE;
MERGE LOANS_DEM LOANS_F;
RUN;


DATA file (DROP = KEYSSN MODAY KEYLINE CHKDIG DIG I 
	CHKDIG CHKX CHKX CHKX CHKDIGIT CHECK);
SET FILE;
KEYSSN = TRANSLATE(bf_ssn,'MYLAUGHTER','XXXXXXXXXX');
MODAY = PUT(DATE(),MMDDYYNX.);
KEYLINE = "P"||KEYSSN||MODAY||"L";
CHKDIG = X;
LENGTH DIG $X.;
DO I = X TO LENGTH(KEYLINE);
	IF I/X NE ROUND(I/X,X) 
		THEN DIG = PUT(INPUT(SUBSTR(KEYLINE,I,X),BITSX.X) * X, X.);
	ELSE DIG = PUT(INPUT(SUBSTR(KEYLINE,I,X),BITSX.X), X.);
	IF SUBSTR(DIG,X,X) = " " 
		THEN CHKDIG = CHKDIG + INPUT(SUBSTR(DIG,X,X),X.);
		ELSE DO;
			CHKX = INPUT(SUBSTR(DIG,X,X),X.);
			CHKX = INPUT(SUBSTR(DIG,X,X),X.);
			IF CHKX + CHKX >= XX
				THEN DO;
					CHKX = PUT(CHKX + CHKX,X.);
					CHKX = INPUT(SUBSTR(CHKX,X,X),X.);
					CHKX = INPUT(SUBSTR(CHKX,X,X),X.);
				END;
			CHKDIG = CHKDIG + CHKX + CHKX;
		END;
END;
CHKDIGIT = XX - INPUT(SUBSTR((RIGHT(PUT(CHKDIG,X.))),X,X),X.);
IF CHKDIGIT = XX THEN CHKDIGIT = X;
CHECK = PUT(CHKDIGIT,X.);
ACSKEY = "#"||KEYLINE||CHECK||"#";
RUN;

%MACRO CREATE_BILL_FILES;
DATA _NULL_;
SET  WORK.file;
	FILE 'T:\IDR Clean Up.txt' DELIMITER=',' DSD DROPOVER LRECL=XXXXX;

	FORMAT LD_LON_X_DSBX-LD_LON_X_DSBXX MMDDYYXX.;
	FORMAT LD_RPS_X_PAY_DUX-LD_RPS_X_PAY_DUXX MMDDYYXX.;
	FORMAT LR_ITRX-LR_ITRXX percentXX.X;

IF _N_ = X THEN 
DO;
   PUT
   	'KeyLine' ','
	'BF_SSN' ','
	'AccountNumber' ',' 
	'Name' ',' 
	'AddressX' ',' 
	'AddressX' ','  
	'City' ',' 
	'State' ',' 
	'ZIP' ',' 
	'Country' ',' 
	'DM_FGN_ST' ','@;
	DO I=X TO XX;
		PUT 'LN_SEQ' I @;
		PUT 'First_Disbursement_Date' I @;
		PUT 'Original_Balance' I  @;
		PUT 'Current_Principal' I @;
		PUT 'Loan_Program' I @;
		PUT 'Interest_Rate' I @;
		PUT 'Schedule_Type' I @;
		PUT 'Total_Repay_Amount' I @;
		PUT 'Anticipated_Cap' I @;
		PUT 'Due_Date' I @;
		PUT 'Repay_Term_in_Months' I @;
		PUT 'Installment_Amount' I @;
	END;
	put 'test';
END;
DO;
	PUT ACSKEY $ @;
	PUT BF_SSN $ @;
	PUT DF_SPE_ACC_ID $ @;
	PUT name $ @;
	PUT DX_STR_ADR_X $ @;
	PUT DX_STR_ADR_X $ @;
	PUT DM_CT $ @;
	PUT DC_DOM_ST $ @;
	PUT DF_ZIP_CDE $ @;
	PUT DM_FGN_CNY $ @;
	PUT DM_FGN_ST $ @;
	%DO I=X %TO XX;
		PUT LN_SEQ&I @;
		PUT LD_LON_X_DSB&I @;
		PUT LA_LON_AMT_GTR&I  @;
		PUT LA_CUR_PRI&I @;
		PUT lon_pgm&I @;
		PUT LR_ITR&I @;
		PUT LC_TYP_SCH_DIS&I @;
		PUT LA_TOT_RPD_DIS&I @;
		PUT LA_ANT_CAP&I @;
		PUT LD_RPS_X_PAY_DU&I @;
		PUT LN_RPS_TRM&I @;
		PUT LA_RPS_ISL&I @;
	%END;
	put  ACSKEY $;
END;
RUN;
%mend;

%CREATE_BILL_FILES;

/*PROC EXPORT*/
/*		DATA=LEGEND.BORROWER*/
/*		OUTFILE="T:\SAS\CNH XXXX.xlsx"*/
/*		DBMS = EXCEL*/
/*		REPLACE;*/
/*		SHEET="A";*/
/*RUN;*/
