USE CDW
GO

DROP TABLE IF EXISTS #FINAL_DATA

;WITH DEFERMENT_DATA AS 
(
SELECT
	PDXX.DF_SPE_ACC_ID,
	LNXX.LN_SEQ,
	DFXX.LC_DFR_TYP,
	LNXX.LF_DFR_CTL_NUM,
	LNXX.LD_DFR_BEG,
	LNXX.LD_DFR_END
FROM
	CDW..LNXX_LON LNXX
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = LNXX.BF_SSN
	INNER JOIN CDW..DFXX_BR_DFR_REQ DFXX
		ON DFXX.BF_SSN = LNXX.BF_SSN
	INNER JOIN CDW..LNXX_BR_DFR_APV LNXX
		ON LNXX.BF_SSN = DFXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
		AND LNXX.LF_DFR_CTL_NUM = DFXX.LF_DFR_CTL_NUM
WHERE
	LNXX.LC_STA_LONXX = 'R'
	AND LNXX.LA_CUR_PRI > X.XX
	AND LNXX.LC_STA_LONXX = 'A'
	AND DFXX.LC_DFR_STA = 'A'
	AND DFXX.LC_STA_DFRXX = 'A'
	AND DFXX.LC_DFR_TYP IN ('XX','XX')
	AND LNXX.IC_LON_PGM = 'DLPLUS'

)
SELECT
	DD.DF_SPE_ACC_ID AS ACCOUNT_NUMBER,
	DD.LN_SEQ AS LOAN_SEQ,
	DD.LC_DFR_TYP AS DFR_TYP_XX,
	DD.LD_DFR_BEG AS DFR_BEGIN_TYP_XX,
	DD.LD_DFR_END AS DFR_END_TYP_XX,
	LEAD(LD_DFR_BEG, X) OVER (PARTITION BY DF_SPE_ACC_ID, LN_SEQ ORDER BY LF_DFR_CTL_NUM) AS DFR_BEGIN_TYP_XX,
	LEAD(LD_DFR_END, X) OVER (PARTITION BY DF_SPE_ACC_ID, LN_SEQ ORDER BY LF_DFR_CTL_NUM) AS DFR_END_TYP_XX,
	LEAD(LC_DFR_TYP, X) OVER (PARTITION BY DF_SPE_ACC_ID, LN_SEQ ORDER BY LF_DFR_CTL_NUM) AS DFR_TYP_XX
INTO #FINAL_DATA
FROM
	DEFERMENT_DATA DD


	
SELECT
	*
FROM
	#FINAL_DATA
WHERE
	DFR_TYP_XX = 'XX'
	AND DFR_TYP_XX = 'XX'
ORDER BY
	ACCOUNT_NUMBER,
	LOAN_SEQ