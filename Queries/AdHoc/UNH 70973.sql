USE UDW
GO

select * from
(
SELECT DISTINCT
	LT20.DF_SPE_ACC_ID AS BORROWER_ACCT_NUM,
	NULL AS CO_BWR_SSN,
	LN16.LD_DLQ_OCC AS DATE_DELQ_OCC,
	DATEADD(DAY, 60, LN16.LD_DLQ_OCC)  AS [60_DAY],
	CASE WHEN PrintedAt IS NOT NULL THEN PrintedAt ELSE EcorrDocumentCreatedAt END AS DATE_SENT
FROM
	UDW..LT20_LTR_REQ_PRC LT20
	INNER JOIN
	(
		SELECT
			LN16.BF_SSN,
			LN16.LD_DLQ_OCC
		FROM
			UDW..LN16_LON_DLQ_HST LN16
			INNER JOIN
			(
				SELECT
					LN16.BF_SSN,
					MAX(LN16.LD_DLQ_OCC) AS LD_DLQ_OCC
				FROM
					UDW..LN16_LON_DLQ_HST LN16
					INNER JOIN UDW..LT20_LTR_REQ_PRC LT20
						ON LT20.RF_SBJ_PRC = LN16.BF_SSN
						AND datediff(day, LD_DLQ_OCC, lt20.CreatedAt) > 50
				WHERE 
					RM_DSC_LTR_PRC = 'US09B60DEL'
					AND CreatedAt BETWEEN '03/01/2021' AND '03/24/2021'
					AND LT20.InactivatedAt IS NULL
					
				GROUP BY
					LN16.BF_SSN
			) M
				ON M.BF_SSN = LN16.BF_SSN
				AND M.LD_DLQ_OCC = LN16.LD_DLQ_OCC
	)	LN16
			ON LN16.BF_SSN = LT20.RF_SBJ_PRC
WHERE 
	RM_DSC_LTR_PRC = 'US09B60DEL'
	AND CreatedAt BETWEEN '03/01/2021' AND '03/24/2021'
	AND LT20.InactivatedAt IS NULL

UNION ALL

SELECT 
	LT20.Borrower_DF_SPE_ACC_ID AS BORROWER_ACCT_NUM,
	PD10.DF_PRS_ID AS CO_BWR_SSN,
	LN16.LD_DLQ_OCC AS DATE_DELQ_OCC,
	DATEADD(DAY, 60, LN16.LD_DLQ_OCC) AS [60_DAY],
	CASE WHEN PrintedAt IS NOT NULL THEN PrintedAt WHEN EcorrDocumentCreatedAt IS NOT NULL AND OnEcorr = 1 THEN EcorrDocumentCreatedAt  ELSE NULL END AS DATE_SENT
FROM
	UDW..LT20_LTR_REQ_PRC_Coborrower LT20
	INNER JOIN UDW..PD10_PRS_NME PD10
		ON PD10.DF_SPE_ACC_ID = LT20.DF_SPE_ACC_ID
	INNER JOIN UDW..LN85_LON_ATY LN85
		ON LN85.BF_SSN = LT20.RF_SBJ_PRC
		AND LN85.LN_ATY_SEQ = LT20.RN_ATY_SEQ_PRC
	INNER JOIN
	(
		SELECT
			LN16.BF_SSN,
			LN16.LN_SEQ,
			LN16.LD_DLQ_OCC
		FROM
			UDW..LN16_LON_DLQ_HST LN16
			INNER JOIN
			(
				SELECT
					LN16.BF_SSN,
					MAX(LN16.LN_DLQ_SEQ) AS LN_DLQ_SEQ
				FROM
					UDW..LN16_LON_DLQ_HST LN16
					INNER JOIN UDW..LT20_LTR_REQ_PRC LT20
						ON LT20.RF_SBJ_PRC = LN16.BF_SSN
						AND datediff(day, LD_DLQ_OCC, lt20.CreatedAt) > 50
				WHERE 
					RM_DSC_LTR_PRC = 'US09B60DEL'
					AND CreatedAt BETWEEN '03/01/2021' AND '03/24/2021'
					AND LT20.InactivatedAt IS NULL
				GROUP BY
					LN16.BF_SSN
			) M
				ON M.BF_SSN = LN16.BF_SSN
				AND M.LN_DLQ_SEQ = LN16.LN_DLQ_SEQ
	)	LN16
			ON LN16.BF_SSN = LT20.RF_SBJ_PRC
			AND LN16.LN_SEQ = LN85.LN_SEQ
WHERE 
	RM_DSC_LTR_PRC = 'US09B60DEL'
	AND CreatedAt BETWEEN '03/01/2021' AND '03/24/2021'
	AND LT20.InactivatedAt IS NULL
) p 


