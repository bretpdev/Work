%LET RPTLIB = T:\SAS;

/*DATA ACH1;*/
/*	INFILE 'T:\ACH_20160202152615.csv' FIRSTOBS=2 DLM=',' DSD;*/
/*	LENGTH SSN $ 9 ;*/
/*	INPUT SSN $ ;*/
/*RUN;*/
/**/
/*DATA ACH2;*/
/*	INFILE 'T:\ACH_20160215124613.csv' FIRSTOBS=2 DLM=',' DSD;*/
/*	LENGTH SSN $ 9 ;*/
/*	INPUT SSN $ ;*/
/*RUN;*/
/**/
/*DATA ACH3;*/
/*	INFILE 'T:\ACH_20160305140001.csv' FIRSTOBS=2 DLM=',' DSD;*/
/*	LENGTH SSN $ 9 ;*/
/*	INPUT SSN $ ;*/
/*RUN;*/

DATA ACH4;
	INFILE 'T:\ACH_20170104174912.csv' FIRSTOBS=2 DLM=',' DSD;
	LENGTH SSN $ 9 ;
	INPUT SSN $ ;
RUN;

/*DATA BORROWERS;*/
/*	SET ACH1 ACH2 ACH3;*/
/*RUN;*/

PROC SORT DATA=ACH4 NODUPKEY;
	BY SSN;
RUN;

LIBNAME  DUSTER  REMOTE  SERVER=DUSTER  SLIBREF=WORK;
DATA DUSTER.BORROWERS;
SET ACH4;
RUN;

RSUBMIT;

%LET DB = DLGSUTWH;
LIBNAME OLWHRM1 DB2 DATABASE=&DB OWNER=OLWHRM1; 

PROC SQL;
CREATE TABLE LoanDetail_1 AS
	SELECT DISTINCT
		LN10.BF_SSN				AS SSN
		,PD10.DF_SPE_ACC_ID		AS ACCT
		,LN10.LN_SEQ			AS LOAN
		,LN10.LF_LON_CUR_OWN	AS OWNER
		,LN10.LD_LON_EFF_ADD	AS PCV_DECON
		,LN10.LD_LON_ACL_ADD	AS CONVERTED
		,LN72A.ACH_ADD
		,LN72A.LD_ITR_EFF_BEG
		,RP30.PR_EFT_RIR		AS ACH_RIR
		,LN72.LR_ITR
	FROM 
		OLWHRM1.LN10_LON LN10
		INNER JOIN WORK.BORROWERS
			ON BORROWERS.SSN = LN10.BF_SSN
		INNER JOIN OLWHRM1.PD10_PRS_NME PD10
			ON LN10.BF_SSN = PD10.DF_PRS_ID
		INNER JOIN OLWHRM1.RP30_EFT_RIR_PAR RP30
			ON RP30.IF_OWN = LN10.LF_LON_CUR_OWN
		INNER JOIN OLWHRM1.LN72_INT_RTE_HST LN72
			ON LN10.BF_SSN = LN72.BF_SSN
			AND LN10.LN_SEQ = LN72.LN_SEQ
		INNER JOIN
			(
				SELECT DISTINCT
					LN72.BF_SSN
					,LN72.LN_SEQ
					,MAX(LN72.LD_ITR_EFF_BEG) AS LD_ITR_EFF_BEG
					,LN83.ACH_ADD
				FROM
					OLWHRM1.LN72_INT_RTE_HST LN72
					INNER JOIN 
						(
							SELECT DISTINCT
								LN83.BF_SSN
								,LN83.LN_SEQ
								,MIN(LN83.LD_EFT_EFF_BEG) 	AS ACH_ADD
							FROM
								OLWHRM1.LN83_EFT_TO_LON LN83
								INNER JOIN OLWHRM1.LN10_LON LN10
									ON LN10.BF_SSN = LN83.BF_SSN
									AND LN10.LN_SEQ = LN83.LN_SEQ
							WHERE
								LN83.LD_EFT_EFF_BEG > LN10.LD_LON_ACL_ADD
								AND LN10.LF_LON_CUR_OWN LIKE '8297690%'	
							GROUP BY
								LN83.BF_SSN
								,LN83.LN_SEQ
							) LN83
						ON LN72.BF_SSN = LN83.BF_SSN
						AND LN72.LN_SEQ = LN83.LN_SEQ
				WHERE
					LN72.LC_STA_LON72 = 'A'
					AND LN72.LD_ITR_EFF_BEG < LN83.ACH_ADD
				GROUP BY 
					LN72.BF_SSN
					,LN72.LN_SEQ
					,LN83.ACH_ADD
			) LN72A
				ON LN72.BF_SSN = LN72A.BF_SSN
				AND LN72.LN_SEQ = LN72A.LN_SEQ
				AND LN72.LD_ITR_EFF_BEG = LN72A.LD_ITR_EFF_BEG
	WHERE
		LN10.LF_LON_CUR_OWN LIKE '8297690%'						
		AND RP30.PC_EFT_RIR_STA = 'A'
	;
QUIT;

ENDRSUBMIT;

DATA LoanDetail_1;
	SET DUSTER.LoanDetail_1;
	FORMAT ACH_ADD LD_ITR_EFF_BEG DATE9. ;
	INFORMAT ACH_ADD LD_ITR_EFF_BEG DATE9. ;
	NEW_RATE = LR_ITR - ACH_RIR;
RUN;

PROC EXPORT
	DATA=LoanDetail_1
	OUTFILE="&RPTLIB\UNH 27264_WAVE4.xlsx"
	DBMS = EXCEL
	REPLACE;
RUN;
