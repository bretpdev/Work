USE CDW
GO

SELECT
	COUNT(LNXX.BF_SSN) [Total],
    SUM(CASE WHEN DAY(RSXX.LD_RPS_X_PAY_DU) BETWEEN XX AND XX THEN X ELSE X END) [DueDateBetweenXXandXX],
	SUM(CASE WHEN DAY(RSXX.LD_RPS_X_PAY_DU) BETWEEN XX AND XX THEN X ELSE X END) [DueDateBetweenXXandXX]
FROM
    CDW..LNXX_LON LNXX
    INNER JOIN CDW..LNXX_LON_RPS LNXX ON LNXX.BF_SSN = LNXX.BF_SSN AND LNXX.LN_SEQ = LNXX.LN_SEQ AND LNXX.LC_STA_LONXX = 'A'
    INNER JOIN CDW..RSXX_BR_RPD RSXX ON LNXX.BF_SSN = RSXX.BF_SSN AND LNXX.LN_RPS_SEQ = RSXX.LN_RPS_SEQ AND RSXX.LC_STA_RPSTXX = 'A'
    LEFT JOIN
    (
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ
		FROM
			CDW..DFXX_BR_DFR_REQ DFXX
			JOIN CDW..LNXX_BR_DFR_APV LNXX ON DFXX.BF_SSN = LNXX.BF_SSN	AND DFXX.LF_DFR_CTL_NUM = LNXX.LF_DFR_CTL_NUM
		WHERE
			DFXX.LC_DFR_STA = 'A'
			AND DFXX.LC_STA_DFRXX = 'A'
			AND LNXX.LC_STA_LONXX = 'A'
			AND GETDATE() BETWEEN LNXX.LD_DFR_BEG AND LNXX.LD_DFR_END
    ) DEFR ON LNXX.BF_SSN = DEFR.BF_SSN AND LNXX.LN_SEQ = DEFR.LN_SEQ
    LEFT JOIN
    (
        SELECT
            LNXX.BF_SSN,
            LNXX.LN_SEQ
        FROM
            CDW..FBXX_BR_FOR_REQ FBXX
            JOIN CDW..LNXX_BR_FOR_APV LNXX ON FBXX.BF_SSN = LNXX.BF_SSN AND FBXX.LF_FOR_CTL_NUM = LNXX.LF_FOR_CTL_NUM
        WHERE
			FBXX.LC_FOR_STA = 'A'
			AND FBXX.LC_STA_FORXX = 'A'
			AND LNXX.LC_STA_LONXX = 'A'
			AND GETDATE() BETWEEN LNXX.LD_FOR_BEG AND LNXX.LD_FOR_END
	) FORB ON LNXX.BF_SSN = FORB.BF_SSN AND LNXX.LN_SEQ = FORB.LN_SEQ
WHERE
    LNXX.LA_CUR_PRI > X
    AND LNXX.LC_STA_LONXX = 'R'
    AND DEFR.BF_SSN IS NULL
    AND FORB.BF_SSN IS NULL



SELECT
	LNXX.BF_SSN,
	DATEPART(DAY, RSXX.LD_RPS_X_PAY_DU) [LD_RPS_X_PAY_DU]
FROM
    CDW..LNXX_LON LNXX
    INNER JOIN CDW..LNXX_LON_RPS LNXX ON LNXX.BF_SSN = LNXX.BF_SSN AND LNXX.LN_SEQ = LNXX.LN_SEQ AND LNXX.LC_STA_LONXX = 'A'
    INNER JOIN CDW..RSXX_BR_RPD RSXX ON LNXX.BF_SSN = RSXX.BF_SSN AND LNXX.LN_RPS_SEQ = RSXX.LN_RPS_SEQ AND RSXX.LC_STA_RPSTXX = 'A'
    LEFT JOIN
    (
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ
		FROM
			CDW..DFXX_BR_DFR_REQ DFXX
			JOIN CDW..LNXX_BR_DFR_APV LNXX ON DFXX.BF_SSN = LNXX.BF_SSN	AND DFXX.LF_DFR_CTL_NUM = LNXX.LF_DFR_CTL_NUM
		WHERE
			DFXX.LC_DFR_STA = 'A'
			AND DFXX.LC_STA_DFRXX = 'A'
			AND LNXX.LC_STA_LONXX = 'A'
			AND GETDATE() BETWEEN LNXX.LD_DFR_BEG AND LNXX.LD_DFR_END
    ) DEFR ON LNXX.BF_SSN = DEFR.BF_SSN AND LNXX.LN_SEQ = DEFR.LN_SEQ
    LEFT JOIN
    (
        SELECT
            LNXX.BF_SSN,
            LNXX.LN_SEQ
        FROM
            CDW..FBXX_BR_FOR_REQ FBXX
            JOIN CDW..LNXX_BR_FOR_APV LNXX ON FBXX.BF_SSN = LNXX.BF_SSN AND FBXX.LF_FOR_CTL_NUM = LNXX.LF_FOR_CTL_NUM
        WHERE
			FBXX.LC_FOR_STA = 'A'
			AND FBXX.LC_STA_FORXX = 'A'
			AND LNXX.LC_STA_LONXX = 'A'
			AND GETDATE() BETWEEN LNXX.LD_FOR_BEG AND LNXX.LD_FOR_END
	) FORB ON LNXX.BF_SSN = FORB.BF_SSN AND LNXX.LN_SEQ = FORB.LN_SEQ
WHERE
    LNXX.LA_CUR_PRI > X
    AND LNXX.LC_STA_LONXX = 'R'
    AND DEFR.BF_SSN IS NULL
    AND FORB.BF_SSN IS NULL
GROUP BY
	LNXX.BF_SSN,
	RSXX.LD_RPS_X_PAY_DU
ORDER BY
	LNXX.BF_SSN
