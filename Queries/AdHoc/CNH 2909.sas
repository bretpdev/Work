
LIBNAME  LEGEND  REMOTE  SERVER=LEGEND SLIBREF=work  ;
/*%let DB = DNFPRQUT;  *This is test;*/
%let DB = DNFPUTDL;  *This is live;

RSUBMIT LEGEND;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;
PROC SQL;
CREATE TABLE NHXXXX AS
	SELECT	DISTINCT
		LNXX.BF_SSN,
		PDXX.DF_SPE_ACC_ID,
		LNXX.LN_SEQ,
		LNXX.LA_CUR_PRI,
		LNXX.LA_NSI_OTS

	FROM
		PKUB.LNXX_LON LNXX
	INNER JOIN PKUB.PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = LNXX.BF_SSN
	WHERE
	    LNXX.LC_STA_LONXX = 'D'      
	 	AND LNXX.LC_SST_LONXX = 'X'
;
QUIT;
ENDRSUBMIT;

DATA NHXXXX;
SET LEGEND.NHXXXX;
RUN;

PROC SQL;
CREATE TABLE SSNS AS
	SELECT DISTINCT
		BF_SSN
	FROM
		NHXXXX

;

CREATE TABLE SSN_COUNTS AS 
	SELECT
		COUNT(BF_SSN) AS BORROWER_COUNT
	FROM
		SSNS
	
;
QUIT;

PROC SQL;
CREATE TABLE LOANS AS
	SELECT DISTINCT
		BF_SSN,
		LN_SEQ
	FROM
		NHXXXX

;

CREATE TABLE LOAN_COUNTS AS 
	SELECT
		COUNT(LN_SEQ) as LOAN_COUNT
	FROM
		LOANS
	
;
QUIT;

PROC SQL;
CREATE TABLE TOTAL_BALANCE AS
	SELECT 
		SUM(LA_CUR_PRI + LA_NSI_OTS) AS TOTAL_BALANCE
	FROM
		NHXXXX
;
QUIT;


RSUBMIT LEGEND;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;
PROC SQL;
CREATE TABLE SUB_POP AS
	SELECT
		NH.BF_SSN,
		NH.DF_SPE_ACC_ID,
		NH.LN_SEQ,
		NH.LA_CUR_PRI,
		NH.LA_NSI_OTS,
		LNXX.IF_LON_SRV_DFL_LON
	FROM 
		NHXXXX NH
	INNER JOIN PKUB.LNXX_RPD_PIO_CVN LNXX
		ON LNXX.BF_SSN = NH.BF_SSN
		AND LNXX.LN_SEQ = NH.LN_SEQ
	WHERE LNXX.IF_LON_SRV_DFL_LON  <> ''

;
QUIT;
ENDRSUBMIT;

DATA SUB_POP;
SET LEGEND.SUB_POP;
RUN;

PROC SQL;
CREATE TABLE SSNS_SUB_POP AS
	SELECT DISTINCT
		BF_SSN
	FROM
		SUB_POP

;

CREATE TABLE SSN_COUNTS_SUB_POP AS 
	SELECT
		COUNT(BF_SSN) AS BORROWER_COUNT
	FROM
		SSNS_SUB_POP
	
;
QUIT;

PROC SQL;
CREATE TABLE LOANS_SUB_POP AS
	SELECT DISTINCT
		BF_SSN,
		LN_SEQ
	FROM
		SUB_POP

;

CREATE TABLE LOAN_COUNTS_SUB_POP AS 
	SELECT
		COUNT(LN_SEQ) as LOAN_COUNT
	FROM
		LOANS_SUB_POP
	
;
QUIT;

PROC SQL;
CREATE TABLE TOTAL_BALANCE_SUB_POP AS
	SELECT 
		SUM(LA_CUR_PRI + LA_NSI_OTS) AS TOTAL_BALANCE
	FROM
		SUB_POP
;
QUIT;

DATA SUB_POP_ACCT (DROP=BF_SSN);
SET LEGEND.SUB_POP;
RUN;

PROC EXPORT DATA= LEGEND.NHXXXX 
            OUTFILE= "T:\SAS\NH XXXX_TOTAL_POP.CSV" 
            DBMS=CSV REPLACE;
     PUTNAMES=YES;
RUN;

PROC EXPORT DATA= WORK.SUB_POP_ACCT 
            OUTFILE= "T:\SAS\NH XXXX_SUB_POP.CSV" 
            DBMS=CSV REPLACE;
     PUTNAMES=YES;
RUN;



