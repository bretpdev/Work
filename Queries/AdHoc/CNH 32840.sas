************* CNH XXXXX based on UTNWFXX *******************;

%LET RPTLIB = T:\SAS;
%LET FILEDIR = T:\SAS;
FILENAME REPORTZ "&RPTLIB/UNWFXX.NWFXXRZ";
FILENAME REPORTX "&RPTLIB/UNWFXX.NWFXXRX";
FILENAME REPORTX "&RPTLIB/UNWFXX.NWFXXRX";

/*use only if looking for a specific number of days*/
/*DATA DAYS;*/
/*	INFILE "&FILEDIR/SmallBalanceWriteOffDays.txt" ;*/
/*	INPUT VALX $ ;*/
/*RUN;*/
/*DATA _NULL_;*/
/*	SET DAYS;*/
/*	CALL SYMPUT('NUM_DAYS', VALX);*/
/*RUN;*/
/*%SYSLPUT NUM_DAYS = &NUM_DAYS;*/

LIBNAME  LEGEND  REMOTE  SERVER=LEGEND SLIBREF=work  ;
RSUBMIT;
/*%let DB = DNFPRQUT;  *This is test;*/
%LET DB = DNFPUTDL;  *This is live;

LIBNAME PKUB DBX DATABASE=&DB OWNER=PKUB;
PROC SQL;
	CREATE TABLE DEMON AS
	SELECT DISTINCT 
		BF_SSN
	FROM
		PKUB.LNXX_LON
	WHERE
		LA_CUR_PRI + LA_NSI_OTS < X
	;

	CREATE TABLE DEMO_X AS
	SELECT 
		LNXX.BF_SSN
		,LNXX.LN_SEQ
		,LNXX.LD_LON_X_DSB
		,SUM(LNXX.LA_CUR_PRI + LNXX.LA_NSI_OTS) AS OUTST
		,LNXX.OUTST_DISB
	FROM
		PKUB.LNXX_LON LNXX
		INNER JOIN PKUB.DWXX_DW_CLC_CLU DWXX
			ON LNXX.BF_SSN = DWXX.BF_SSN
			AND LNXX.LN_SEQ = DWXX.LN_SEQ
		LEFT JOIN 
		(
			SELECT 
				BF_SSN
				,LN_SEQ
				,SUM(LA_DSB - LA_DSB_CAN) AS OUTST_DISB
			FROM 
				PKUB.LNXX_DSB
			GROUP BY 
				BF_SSN
				,LN_SEQ
		) LNXX
			ON LNXX.BF_SSN = LNXX.BF_SSN 
			AND LNXX.LN_SEQ = LNXX.LN_SEQ
		LEFT JOIN DEMON D
			ON LNXX.BF_SSN = D.BF_SSN
	WHERE
		(
			LNXX.LC_STA_LONXX = 'R' 
			OR LNXX.LC_STA_LONXX = 'D'
		)
		AND DWXX.WC_DW_LON_STA ^= 'XX'
		AND LNXX.LA_CUR_PRI + LNXX.LA_NSI_OTS ^= X
		AND D.BF_SSN IS NULL
	GROUP BY 
		LNXX.BF_SSN
	HAVING 
		CALCULATED OUTST <= XX.XX
		AND CALCULATED OUTST >= XX.XX
	;

	CREATE TABLE MAX_TYP AS
	SELECT DISTINCT 
		PDXX.DF_SPE_ACC_ID
		,D.LN_SEQ
		,D.LD_LON_X_DSB
		,LNXX.PC_FAT_SUB_TYP
		,D.OUTST
		,D.OUTST_DISB
	FROM
		DEMO_X D
		INNER JOIN PKUB.PDXX_PRS_NME PDXX
			ON D.BF_SSN = PDXX.DF_PRS_ID
		LEFT JOIN 
		(
			SELECT 
				BF_SSN
				,LN_SEQ
				,MAX(LN_FAT_SEQ)
				,MAX(LD_FAT_EFF) AS MAX_LD_FAT_EFF
			FROM 
				PKUB.LNXX_FIN_ATY
			GROUP BY 
				BF_SSN
				,LN_SEQ
		) LNXX_MAX
			ON D.BF_SSN = LNXX_MAX.BF_SSN
			AND D.LN_SEQ = LNXX_MAX.LN_SEQ
		LEFT JOIN PKUB.LNXX_FIN_ATY LNXX
			ON LNXX_MAX.BF_SSN = LNXX.BF_SSN
			AND LNXX_MAX.LN_SEQ = LNXX.LN_SEQ
			AND LNXX.PC_FAT_TYP = 'XX'
			AND LNXX.PC_FAT_SUB_TYP IN ('XX','XX','XX')
	WHERE
		(
			LNXX.PC_FAT_SUB_TYP = 'XX'
			OR LNXX.BF_SSN IS NULL
		)
/*		AND (TODAY() - LNXX_MAX.MAX_LD_FAT_EFF) > &NUM_DAYS*/
	;
QUIT;

PROC SQL;
	CREATE TABLE DEMO_X AS
	SELECT 
		A.DF_SPE_ACC_ID
		,A.LN_SEQ
		,A.LD_LON_X_DSB
		,A.PC_FAT_SUB_TYP
	FROM
		MAX_TYP A
		LEFT JOIN
		(
			SELECT 
				DF_SPE_ACC_ID
			FROM
				MAX_TYP
			WHERE
				OUTST = OUTST_DISB
		) B
			ON A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
	WHERE 
		B.DF_SPE_ACC_ID IS NULL
	;
QUIT;
ENDRSUBMIT;
DATA DEMO_X;
	SET LEGEND.DEMO_X;
RUN;
DATA DEMO_X; 
	SET LEGEND.DEMO_X; 
RUN;


/*output files*/
DATA MAX_TYP; 
	SET LEGEND.MAX_TYP; 
RUN;

PROC EXPORT
	DATA=MAX_TYP
	OUTFILE="&RPTLIB\CNH XXXXX.xls"
	DBMS = EXCEL
	REPLACE;
	SHEET="RX_RX_pop";
RUN;

DATA _NULL_;
	SET MAX_TYP ;
	FILE REPORTX DELIMITER=',' DSD DROPOVER LRECL=XXXXX;
	WHERE PC_FAT_SUB_TYP = '';
	FORMAT LD_LON_X_DSB MMDDYYXX. ;
	IF _N_ = X THEN PUT "DF_SPE_ACC_ID,LN_SEQ,LD_LON_X_DSB";
	DO;
	   PUT DF_SPE_ACC_ID @;
	   PUT LN_SEQ @;
	   PUT LD_LON_X_DSB  ;
	END;
RUN;

DATA _NULL_;
	SET MAX_TYP ;
	WHERE PC_FAT_SUB_TYP = 'XX';
	ARC = 'SMBLR';
	FROM_DATE = '';
	TO_DATE = '';
	NEEDED_BY_DATE = '';
	RECIPIENT_ID = '';
	REGARDS_TO_CODE = '';
	REGARDS_TO_ID = 'B';
	LOAN_SEQ = 'ALL';
	COMMENTS = 'SMALL BALANCE CAUSED BY SCHOOL REFUND. REVIEW ACCOUNT.';
	FILE REPORTX DELIMITER=',' DSD DROPOVER LRECL=XXXXX;
	DO;
	   PUT DF_SPE_ACC_ID @;
	   PUT ARC @;
	   PUT FROM_DATE @;
	   PUT TO_DATE @;
	   PUT NEEDED_BY_DATE @;
	   PUT RECIPIENT_ID @;
	   PUT REGARDS_TO_CODE @;
	   PUT REGARDS_TO_ID @;
	   PUT LOAN_SEQ @;
	   PUT COMMENTS $;
	END;
RUN;
