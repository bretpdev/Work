

SELECT 
	PDXX.DF_SPE_ACC_ID,
	--LNXX.BF_SSN,
	LNXX.LN_SEQ, 
	LKXX.PX_DSC_MDM AS LOAN_STATUS, 
	MAX(LNXX.LD_FAT_EFF) AS DATE_ACCT_X
FROM 
	CDW..LNXX_FIN_ATY LNXX
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = LNXX.BF_SSN
	INNER JOIN CDW..DWXX_DW_CLC_CLU DWXX
		ON DWXX.BF_SSN = LNXX.BF_SSN
		AND DWXX.LN_SEQ = LNXX.LN_SEQ
		AND DWXX.WC_DW_LON_STA != 'XX'
		AND DWXX.WX_OVR_DW_LON_STA NOT IN ('DELINQUENCY TRANSFER','DECONVERTED','DISABILITY TRANSFER ')
	INNER JOIN CDW..LKXX_LS_CDE_LKP LKXX
		ON LKXX.PM_ATR = 'WC-DW-LON-STA'
		AND LKXX.PX_ATR_VAL = DWXX.WC_DW_LON_STA

WHERE 
	LNXX.LA_CUR_PRI <= X
GROUP BY 
	PDXX.DF_SPE_ACC_ID,
	LNXX.BF_SSN, 
	LNXX.LN_SEQ ,
	LKXX.PX_DSC_MDM
HAVING 
	SUM(LNXX.LA_FAT_CUR_PRI) <= X
	AND MAX(LNXX.LD_FAT_EFF) <= 'XX/XX/XXXX'
