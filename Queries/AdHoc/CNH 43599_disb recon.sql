USE CDW
GO



DROP TABLE IF EXISTS #DATA

SELECT 
	Dense_rank() OVER( ORDER BY TX.BF_SSN) AS RN,
	TX.BF_SSN AS SSN,
	FSXX.LF_FED_AWD + RIGHT('XXX' + CAST(FSXX.LN_FED_AWD_SEQ AS VARCHAR(XX)),X) AS AWARD_ID,
	RTRIM(PDXX.DM_PRS_LST) AS LAST_NAME,
	CONVERT(VARCHAR,PDXX.DD_BRT, XXX) AS DATE_OF_BIRTH,
	ISNULL(EMAIL.EmailAddress, 'N/A') AS EMAIL_ADDRESS,
	ABS(LNXX.LA_FAT_CUR_PRI) AS PRINCIPAL_TRANSFERED,
	ABS(LNXX.LA_FAT_NSI) AS INTEREST_TRANSFERED,
	LNXX.LA_CUR_PRI AS CURRENT_PRINCIPAL,
	DWXX.WA_TOT_BRI_OTS AS CURRENT_INTEREST,
	ISNULL(LNXX.LA_TOT_PRI_PD_PCV,X.XX) + ISNULL(TOTAL_PAID.LA_FAT_CUR_PRI,X.XX) AS PBO_PAID,
	ISNULL(TOTAL_PAID.LA_FAT_NSI,X.XX) AS INTEREST_PAID,
	ISNULL(LNXX.LA_ORG_CAP_INT,X.XX) + ISNULL(CAP.LA_FAT_CUR_PRI,X.XX) AS TOTAL_CAPITIALIZED_INTEREST,
	LNXX.LD_LON_X_DSB AS EARLIEST_DISBURSEMENT_DATE,
	DSB_AMT.DSB_AMT AS DISBURSEMENT_AMOUNT,
	DSB_AMT.LA_PCV_ADJ_CUR_PRI,
--	DSB_AMT.LNXX_AMT,
	LNXX.LC_FED_PGM_YR
into #data
FROM
	CDW..CS_TransferXLoans TX
	INNER JOIN 
	(
		SELECT DISTINCT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			SUM(COALESCE(LA_FAT_CUR_PRI,X.XX)) AS LA_FAT_CUR_PRI,
			SUM(COALESCE(LA_FAT_NSI,X.XX)) AS LA_FAT_NSI
		FROM
			CDW..LNXX_FIN_ATY LNXX
			INNER JOIN CDW..CS_TransferX TX
				ON TX.BF_SSN = LNXX.BF_SSN
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND COALESCE(rtrim(LNXX.LC_FAT_REV_REA),'') = ''
			AND LNXX.PC_FAT_TYP = 'XX'
			AND LNXX.PC_FAT_SUB_TYP = 'XX'
			AND LNXX.LD_FAT_EFF = 'XX/XX/XXXX'
		GROUP BY
			LNXX.BF_SSN,
			LNXX.LN_SEQ
	) LNXX
		ON LNXX.BF_SSN = TX.BF_SSN
		AND LNXX.LN_SEQ = TX.LN_SEQ
	INNER JOIN CDW..FSXX_DL_LON FSXX
		ON FSXX.BF_SSN = TX.BF_SSN
		AND FSXX.LN_SEQ = TX.LN_SEQ
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = TX.BF_SSN
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = TX.BF_SSN
		AND LNXX.LN_SEQ = TX.LN_SEQ
	INNER JOIN CDW..DWXX_DW_CLC_CLU DWXX
		ON DWXX.BF_SSN = TX.BF_SSN
		AND DWXX.LN_SEQ = TX.LN_SEQ
	LEFT JOIN CDW..LNXX_RPD_PIO_CVN LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	LEFT JOIN 
	(
		SELECT
			LNXX.BF_SSN,
			FSXX.LF_FED_AWD,
			FSXX.LN_FED_AWD_SEQ,
			SUM(ABS(COALESCE(LA_FAT_CUR_PRI,X.XX)) + abs(isnull(LNXX.LA_FAT_ILG_PRI,X.XX))) AS LA_FAT_CUR_PRI,
			ABS(SUM(COALESCE(LA_FAT_NSI,X.XX))) AS LA_FAT_NSI
		FROM
			CDW..LNXX_FIN_ATY LNXX
			INNER JOIN CDW..FSXX_DL_LON FSXX
				ON FSXX.BF_SSN = LNXX.BF_SSN
				AND FSXX.LN_SEQ = LNXX.LN_SEQ
			INNER JOIN 
			(
				SELECT DISTINCT
					LNXX.BF_SSN,
					LNXX.LN_SEQ
				FROM
					CDW..LNXX_FIN_ATY LNXX
					INNER JOIN CDW..CS_TransferX TX
						ON TX.BF_SSN = LNXX.BF_SSN
				WHERE
					LNXX.LC_STA_LONXX = 'A'
					AND COALESCE(rtrim(LNXX.LC_FAT_REV_REA),'') = ''
					AND LNXX.PC_FAT_TYP = 'XX'
					AND LNXX.PC_FAT_SUB_TYP = 'XX'
					AND LNXX.LD_FAT_EFF = 'XX/XX/XXXX'
				GROUP BY
					LNXX.BF_SSN,
					LNXX.LN_SEQ
			) TRANS
				ON TRANS.BF_SSN = LNXX.BF_SSN
				AND TRANS.LN_SEQ = LNXX.LN_SEQ
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND (LC_FAT_REV_REA = ' ' OR LC_FAT_REV_REA = '' OR LC_FAT_REV_REA IS NULL)
			AND LNXX.PC_FAT_TYP = 'XX'
			AND LNXX.PC_FAT_SUB_TYP in ('XX', 'XX','XX', 'XX', 'XX','XX','XX','XX','XX','XX','XX','XX','XX','XX', 'XX','XX', 'XX','XX','XX','XX','XX', 'XX','XX','XX', 'XX','XX','XX','XX','XX','XX')  
		GROUP BY
			LNXX.BF_SSN,
			FSXX.LF_FED_AWD,
			fsXX.LN_FED_AWD_SEQ
	) TOTAL_PAID
		ON TOTAL_PAID.BF_SSN = TX.BF_SSN
		AND TOTAL_PAID.LF_FED_AWD = FSXX.LF_FED_AWD
		AND TOTAL_PAID.LN_FED_AWD_SEQ = FSXX.LN_FED_AWD_SEQ
	LEFT JOIN 
	( 
		SELECT
			LNXX.BF_SSN,
			FSXX.LF_FED_AWD,
			FSXX.LN_FED_AWD_SEQ,
			SUM(LNXX.LA_FAT_CUR_PRI) AS LA_FAT_CUR_PRI
		FROM
			LNXX_FIN_ATY LNXX
			INNER JOIN CDW..FSXX_DL_LON FSXX
				ON FSXX.BF_SSN = LNXX.BF_SSN
				AND FSXX.LN_SEQ = LNXX.LN_SEQ
			INNER JOIN 
			(
				SELECT DISTINCT
					LNXX.BF_SSN,
					LNXX.LN_SEQ
				FROM
					CDW..LNXX_FIN_ATY LNXX
					INNER JOIN CDW..CS_TransferX TX
						ON TX.BF_SSN = LNXX.BF_SSN
				WHERE
					LNXX.LC_STA_LONXX = 'A'
					AND COALESCE(rtrim(LNXX.LC_FAT_REV_REA),'') = ''
					AND LNXX.PC_FAT_TYP = 'XX'
					AND LNXX.PC_FAT_SUB_TYP = 'XX'
					AND LNXX.LD_FAT_EFF = 'XX/XX/XXXX'
				GROUP BY
					LNXX.BF_SSN,
					LNXX.LN_SEQ
			) TRANS
				ON TRANS.BF_SSN = LNXX.BF_SSN
				AND TRANS.LN_SEQ = LNXX.LN_SEQ
		WHERE
			LNXX.PC_FAT_TYP = 'XX' 
			AND LNXX.PC_FAT_SUB_TYP = 'XX'
			AND LNXX.LC_STA_LONXX = 'A'
			AND COALESCE(LNXX.LC_FAT_REV_REA,'') = '' 
		GROUP BY
			LNXX.BF_SSN,
			FSXX.LF_FED_AWD,
			fsXX.LN_FED_AWD_SEQ
	) CAP 
		ON CAP.BF_SSN = LNXX.BF_SSN
		AND CAP.LF_FED_AWD = FSXX.LF_FED_AWD
		AND CAP.LN_FED_AWD_SEQ = FSXX.LN_FED_AWD_SEQ
	LEFT JOIN
	(
		SELECT DISTINCT
			EmailOrdering.DF_PRS_ID,
			EmailOrdering.EmailAddress
		FROM
			(
				SELECT
					EmailPrioritizing.DF_PRS_ID,
					EmailPrioritizing.EmailAddress,
					ROW_NUMBER() OVER (PARTITION BY EmailPrioritizing.DF_PRS_ID ORDER BY EmailPrioritizing.PriorityNumber) AS EmailPriority --number in order of Email.PriorityNumber
				FROM
					(
						SELECT DISTINCT
							PDXX.DF_PRS_ID,
							PDXX.DX_ADR_EML AS EmailAddress,
							CASE 
								WHEN PDXX.DC_ADR_EML = 'H' THEN X 
								WHEN PDXX.DC_ADR_EML = 'A' THEN X 
								WHEN PDXX.DC_ADR_EML = 'W' THEN X 
							END AS PriorityNumber
						FROM
							PDXX_PRS_NME PDXX 
							LEFT JOIN PDXX_PRS_ADR_EML PDXX
								ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
								AND PDXX.DI_VLD_ADR_EML = 'Y' 
								AND PDXX.DC_STA_PDXX = 'A' 
						WHERE
							PDXX.DF_PRS_ID LIKE '[X-X]%' 
					) EmailPrioritizing
				WHERE
					EmailPrioritizing.EmailAddress IS NOT NULL 
			) EmailOrdering
		WHERE
			EmailOrdering.EmailPriority = X 
	) EMAIL
		ON EMAIL.DF_PRS_ID = TX.BF_SSN
	LEFT JOIN 
	(
		SELECT 
			LNXX.BF_SSN,
			FSXX.LF_FED_AWD,
			FSXX.LN_FED_AWD_SEQ,
			SUM(LNXX.LA_DSB - ISNULL(LNXX.LA_DSB_CAN,X)  ) AS DSB_AMT,
			SUM(LNXX.LA_PCV_ADJ_CUR_PRI) AS LA_PCV_ADJ_CUR_PRI 
			--SUM(ISNULL(LNXX.LA_PCV_ADJ_CUR_PRI, X.XX)) AS LNXX_AMT
		FROM 
			CDW..LNXX_DSB LNXX
			INNER JOIN CDW..FSXX_DL_LON FSXX
				ON FSXX.BF_SSN = LNXX.BF_SSN
				AND FSXX.LN_SEQ = LNXX.LN_SEQ
			INNER JOIN 
			(
				SELECT DISTINCT
					LNXX.BF_SSN,
					LNXX.LN_SEQ
				FROM
					CDW..LNXX_FIN_ATY LNXX
				WHERE
					LNXX.LC_STA_LONXX = 'A'
					AND COALESCE(rtrim(LNXX.LC_FAT_REV_REA),'') = ''
					AND LNXX.PC_FAT_TYP = 'XX'
					AND LNXX.PC_FAT_SUB_TYP = 'XX'
					AND LNXX.LD_FAT_EFF = 'XX/XX/XXXX'
				GROUP BY
					LNXX.BF_SSN,
					LNXX.LN_SEQ
			) TRANS
				ON TRANS.BF_SSN = LNXX.BF_SSN
				AND TRANS.LN_SEQ = LNXX.LN_SEQ
			LEFT JOIN
			(
			SELECT
				LNXX.BF_SSN,
				FSXX.LF_FED_AWD,
				FSXX.LN_FED_AWD_SEQ,
				SUM(ISNULL(LNXX.LA_PCV_ADJ_CUR_PRI, X.XX)) AS LA_PCV_ADJ_CUR_PRI
			FROM
				CDW..LNXX_PCV_FIN_SCP LNXX  
				INNER JOIN CDW..FSXX_DL_LON FSXX
					ON FSXX.BF_SSN = LNXX.BF_SSN
					AND FSXX.LN_SEQ = LNXX.LN_SEQ
			WHERE
					LNXX.PC_FAT_TYP = 'XX' 
					AND LNXX.PC_FAT_SUB_TYP IN ('XX', 'XX') 
					AND LNXX.LC_STA_LONXX = 'A'
			GROUP BY
				LNXX.BF_SSN,
				FSXX.LF_FED_AWD,
				FSXX.LN_FED_AWD_SEQ
		) LNXX
			ON LNXX.BF_SSN = FSXX.BF_SSN
			AND LNXX.LF_FED_AWD = FSXX.LF_FED_AWD
			AND LNXX.LN_FED_AWD_SEQ = FSXX.LN_FED_AWD_SEQ
		WHERE 
			LC_DSB_TYP = X 
			AND LC_STA_LONXX IN (X,X)
		
			
		GROUP BY
			LNXX.BF_SSN,
			fsXX.LF_FED_AWD,
			FSXX.LN_FED_AWD_SEQ
	) DSB_AMT
		ON DSB_AMT.BF_SSN = TX.BF_SSN
		AND DSB_AMT.LF_FED_AWD = FSXX.LF_FED_AWD
		AND DSB_AMT.LN_FED_AWD_SEQ = FSXX.LN_FED_AWD_SEQ

SELECT distinct 
	D.*
FROM 
	#DATA D
	
where
	D.LC_FED_PGM_YR = 'LNC'

order by ssn