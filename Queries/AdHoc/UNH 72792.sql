DROP TABLE IF EXISTS #DATA
DROP TABLE IF EXISTS #DATA1

SELECT DISTINCT
	PD10.DF_SPE_ACC_ID AS ACCOUNT_NUMBER, 
	LTRIM(RTRIM(PD10.DM_PRS_LST)) AS LAST_NAME,
	RTRIM(PD10.DM_PRS_1) AS FIRST_NAME,
	WQ20.WF_QUE + WQ20.WF_SUB_QUE AS [QUEUE],
	LN16.LN_DLQ_MAX AS DAYS_PAST_DUE,
	
	DATEADD(MONTH, 12, RS.LD_RPS_1_PAY_DU) AS FINAL_PFH_DATE
	
INTO #DATA	
FROM
	UDW..PD10_PRS_NME PD10
	INNER JOIN UDW..LN10_LON LN10
		ON PD10.DF_PRS_ID = LN10.BF_SSN
	INNER JOIN 
	(
		SELECT
			LN16.BF_SSN,
			LN16.LN_SEQ,
			LN16.LD_DLQ_OCC,
			LN16.LN_DLQ_MAX + 1 AS LN_DLQ_MAX
		FROM
			UDW..LN16_LON_DLQ_HST LN16
			INNER JOIN
			(
				SELECT
					MinOcc.BF_SSN,
					MinOcc.LN_SEQ,
					MIN(MinOcc.LD_DLQ_OCC) OVER(PARTITION BY MinOcc.BF_SSN) AS MinOccurance,
					MaxDelq.MaxDelq
				FROM
					UDW..LN16_LON_DLQ_HST MinOcc
					INNER JOIN
					(
						SELECT
							BF_SSN,
							LN_SEQ,
							MAX(LD_DLQ_MAX) AS MaxDelq
						FROM
							UDW..LN16_LON_DLQ_HST
						WHERE
							LC_STA_LON16 = '1'
							 AND DATEDIFF(DAY, LD_DLQ_MAX, GETDATE()) <= 5
						GROUP BY
							BF_SSN,
							LN_SEQ			
					) MaxDelq
						ON MinOcc.BF_SSN = MaxDelq.BF_SSN
						AND MinOcc.LN_SEQ = MaxDelq.LN_SEQ
						AND MinOcc.LD_DLQ_MAX = MaxDelq.MaxDelq
			) EarliestOcc
				ON EarliestOcc.BF_SSN = LN16.BF_SSN
				AND EarliestOcc.LN_SEQ = LN16.LN_SEQ
				AND EarliestOcc.MaxDelq = LN16.LD_DLQ_MAX
				AND EarliestOcc.MinOccurance = LN16.LD_DLQ_OCC
	) LN16
		ON LN10.BF_SSN = LN16.BF_SSN
		AND LN10.LN_SEQ = LN16.LN_SEQ
	INNER JOIN UDW..WQ20_TSK_QUE WQ20
		ON LN10.BF_SSN = WQ20.BF_SSN
		AND WQ20.WC_STA_WQUE20 NOT IN ('C','X')
	LEFT JOIN UDW.calc.RepaymentSchedules RS
		ON RS.BF_SSN = LN10.BF_SSN
		AND RS.CurrentGradation = 1
		AND RS.LC_TYP_SCH_DIS = 'IB'	
WHERE
	LN10.LC_STA_LON10 = 'R'
	AND LN10.LA_CUR_PRI > 0.00
	AND WQ20.WD_ACT_REQ <= DATEADD(DAY,360,LN16.LD_DLQ_OCC)
	AND WQ20.WD_ACT_REQ > LN16.LD_DLQ_OCC
	AND LN16.LN_DLQ_MAX >= 30
	AND (WQ20.WF_QUE + WQ20.WF_SUB_QUE) IN ('S401','1P01','VRFB','VBFB','SF01','AW01','ATPD','2A01','8701','DUDT','2501','1501','PRDF','V801','WR01','2301', '2P01', 'I001')


SELECT DISTINCT
	PD10.DF_SPE_ACC_ID AS ACCOUNT_NUMBER, 
	LTRIM(RTRIM(PD10.DM_PRS_LST)) AS LAST_NAME,
	RTRIM(PD10.DM_PRS_1) AS FIRST_NAME,
	WQ20.WF_QUE + WQ20.WF_SUB_QUE AS [QUEUE],
	isnull(LN16.LN_DLQ_MAX,0) AS DAYS_PAST_DUE,
	DATEADD(MONTH, 12, RS.LD_RPS_1_PAY_DU) AS FINAL_PFH_DATE
	
INTO #DATA1	
FROM
	UDW..PD10_PRS_NME PD10
	INNER JOIN UDW..LN10_LON LN10
		ON PD10.DF_PRS_ID = LN10.BF_SSN
	INNER JOIN UDW..WQ20_TSK_QUE WQ20
		ON LN10.BF_SSN = WQ20.BF_SSN
		AND WQ20.WC_STA_WQUE20 NOT IN ('C','X')
	INNER JOIN UDW.calc.RepaymentSchedules RS
		ON RS.BF_SSN = LN10.BF_SSN
		AND RS.CurrentGradation = 1
		AND RS.LC_TYP_SCH_DIS = 'IB'
	LEFT JOIN 
	(
		SELECT
			LN16.BF_SSN,
			LN16.LN_SEQ,
			LN16.LD_DLQ_OCC,
			LN16.LN_DLQ_MAX + 1 AS LN_DLQ_MAX
		FROM
			UDW..LN16_LON_DLQ_HST LN16
			INNER JOIN
			(
				SELECT
					MinOcc.BF_SSN,
					MinOcc.LN_SEQ,
					MIN(MinOcc.LD_DLQ_OCC) OVER(PARTITION BY MinOcc.BF_SSN) AS MinOccurance,
					MaxDelq.MaxDelq
				FROM
					UDW..LN16_LON_DLQ_HST MinOcc
					INNER JOIN
					(
						SELECT
							BF_SSN,
							LN_SEQ,
							MAX(LD_DLQ_MAX) AS MaxDelq
						FROM
							UDW..LN16_LON_DLQ_HST
						WHERE
							LC_STA_LON16 = '1'
							AND DATEDIFF(DAY, LD_DLQ_MAX, GETDATE()) <= 5
						GROUP BY
							BF_SSN,
							LN_SEQ			
					) MaxDelq
						ON MinOcc.BF_SSN = MaxDelq.BF_SSN
						AND MinOcc.LN_SEQ = MaxDelq.LN_SEQ
						AND MinOcc.LD_DLQ_MAX = MaxDelq.MaxDelq
			) EarliestOcc
				ON EarliestOcc.BF_SSN = LN16.BF_SSN
				AND EarliestOcc.LN_SEQ = LN16.LN_SEQ
				AND EarliestOcc.MaxDelq = LN16.LD_DLQ_MAX
				AND EarliestOcc.MinOccurance = LN16.LD_DLQ_OCC
	) LN16
		ON LN10.BF_SSN = LN16.BF_SSN
		AND LN10.LN_SEQ = LN16.LN_SEQ	
WHERE
	LN10.LC_STA_LON10 = 'R'
	AND LN10.LA_CUR_PRI > 0.00
	AND (WQ20.WF_QUE + WQ20.WF_SUB_QUE) IN ('2A01', '2P01', 'I001')


--CASE
--		WHEN (WQ20.WF_QUE + WQ20.WF_SUB_QUE) IN ('S401','1P01') THEN 'Deferments'
--		WHEN (WQ20.WF_QUE + WQ20.WF_SUB_QUE) IN ('VRFB','VBFB','SF01') THEN 'Forbearances'
--		WHEN (WQ20.WF_QUE + WQ20.WF_SUB_QUE) IN ('AW01','ATPD') THEN 'Autopay/ACH'
--		WHEN (WQ20.WF_QUE + WQ20.WF_SUB_QUE) IN ('2A01', '2P01', 'I001') AND DATEDIFF(DAY, GETDATE(), DATEADD(MONTH, 12, RS.LD_RPS_1_PAY_DU)) <= 30 THEN 'IBR FINAL PFH'
--		WHEN (WQ20.WF_QUE + WQ20.WF_SUB_QUE) IN ('2A01', '2P01', 'I001') THEN 'Income Based Repayment'
--		WHEN (WQ20.WF_QUE + WQ20.WF_SUB_QUE) IN ('8701','DUDT','2501','1501','PRDF','V801','WR01','2301') THEN 'Other'
--	END AS [FILE],

SELECT
	WQ20.ACCOUNT_NUMBER,
	WQ20.FIRST_NAME,
	WQ20.LAST_NAME,
	WQ20.[QUEUE],
	WQ20.DAYS_PAST_DUE,
	'DEFERMENTS' AS REASON
FROM
	#DATA WQ20
WHERE
	WQ20.[QUEUE] IN ('S401','1P01') 

SELECT
	WQ20.ACCOUNT_NUMBER,
	WQ20.FIRST_NAME,
	WQ20.LAST_NAME,
	WQ20.[QUEUE],
	WQ20.DAYS_PAST_DUE,
	'FORBEARANCE' AS REASON
FROM
	#DATA WQ20
WHERE
	WQ20.[QUEUE] IN ('VRFB','VBFB','SF01') 


SELECT
	WQ20.ACCOUNT_NUMBER,
	WQ20.FIRST_NAME,
	WQ20.LAST_NAME,
	WQ20.[QUEUE],
	WQ20.DAYS_PAST_DUE,
	'AUTO PAY' AS REASON
FROM
	#DATA WQ20
WHERE
	WQ20.[QUEUE] IN ('AW01','ATPD')

SELECT
	WQ20.ACCOUNT_NUMBER,
	WQ20.FIRST_NAME,
	WQ20.LAST_NAME,
	WQ20.[QUEUE],
	WQ20.DAYS_PAST_DUE,
	wq20.FINAL_PFH_DATE,
	'IBR FINAL PFH' AS REASON
FROM
	#DATA1 WQ20
WHERE
	WQ20.[QUEUE] IN ('2A01', '2P01', 'I001') 
	AND DATEDIFF(DAY, GETDATE(),  WQ20.FINAL_PFH_DATE) <= 31
	AND WQ20.FINAL_PFH_DATE IS NOT NULL

SELECT
	WQ20.ACCOUNT_NUMBER,
	WQ20.FIRST_NAME,
	WQ20.LAST_NAME,
	WQ20.[QUEUE],
	WQ20.DAYS_PAST_DUE,
	'IBR' AS REASON
FROM
	#DATA WQ20
WHERE
	WQ20.[QUEUE] IN ('2A01', '2P01', 'I001') 

SELECT
	WQ20.ACCOUNT_NUMBER,
	WQ20.FIRST_NAME,
	WQ20.LAST_NAME,
	WQ20.[QUEUE],
	WQ20.DAYS_PAST_DUE,
	'OTHER' AS REASON
FROM
	#DATA WQ20
WHERE
	WQ20.[QUEUE] IN ('8701','DUDT','2501','1501','PRDF','V801','WR01','2301')
