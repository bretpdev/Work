USE UDW;
GO
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SELECT DISTINCT 
	PD10.DF_SPE_ACC_ID,
	LN10.LN_SEQ,
	BL10.LC_BIL_TYP,
	LN65.LC_TYP_SCH_DIS,
	LN65.LC_STA_LON65,
	LN80.LA_TOT_BIL_STS,
	LN80.LA_BIL_CUR_DU,
	BL10.LD_BIL_DU,
	LN10.LC_STA_LON10,
	LN80.LC_STA_LON80,
	BL10.LC_STA_BIL10,
	IIF(COALESCE(LN10.LA_CUR_PRI,0) + COALESCE(LN10.LA_NSI_OTS,0) > 0, '>0','0') AS BALANCE
FROM
	LN10_LON LN10
	INNER JOIN LN80_LON_BIL_CRF LN80
		ON LN10.BF_SSN = LN80.BF_SSN
		AND LN10.LN_SEQ = LN80.LN_SEQ
	INNER JOIN BL10_BR_BIL BL10
		ON LN80.BF_SSN = BL10.BF_SSN
		AND LN80.LD_BIL_CRT = BL10.LD_BIL_CRT
		AND LN80.LN_SEQ_BIL_WI_DTE = BL10.LN_SEQ_BIL_WI_DTE
	INNER JOIN LN65_LON_RPS LN65
		ON LN10.BF_SSN = LN65.BF_SSN
		AND LN10.LN_SEQ = LN65.LN_SEQ
	INNER JOIN PD10_PRS_NME PD10
		ON LN10.BF_SSN = PD10.DF_PRS_ID
WHERE
	BL10.LC_BIL_TYP = 'I' --interest bill
	AND LN65.LC_TYP_SCH_DIS IN ('IB','IL','IP','I3') --IBR plans UHEAA
	AND LN65.LC_STA_LON65 = 'A'
	AND BL10.LD_BIL_DU < CONVERT(DATE,GETDATE())
	AND LN80.LA_TOT_BIL_STS < LN80.LA_BIL_CUR_DU --bill not satisfied
	--from billing job:
	AND LN10.LC_STA_LON10 = 'R'
	AND COALESCE(LN10.LA_CUR_PRI,0) + COALESCE(LN10.LA_NSI_OTS,0) > 0
	AND LN80.LC_STA_LON80 = 'A'
	AND BL10.LC_STA_BIL10 = 'A'
ORDER BY 
	PD10.DF_SPE_ACC_ID,
	LN10.LN_SEQ