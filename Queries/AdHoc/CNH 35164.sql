SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF OBJECT_ID('tempdb..#POP') IS NOT NULL 
	DROP TABLE #POP

SELECT
	*
INTO #POP
FROM
(
	SELECT DISTINCT
		LNXX.BF_SSN,
		LNXX.LF_DOE_SCL_ORG,
		'IN-SCHOOL' AS TYP
	FROM
		CDW..DWXX_DW_CLC_CLU DWXX
		INNER JOIN CDW..LNXX_LON LNXX
			ON LNXX.BF_SSN = DWXX.BF_SSN
			AND LNXX.LN_SEQ = DWXX.LN_SEQ
	WHERE
		DWXX.WC_DW_LON_STA = 'XX'

	UNION 
	
	SELECT DISTINCT
		DFXX.BF_SSN,
		DFXX.LF_DOE_SCL_DFR,
		'SCHOOL DEFERMENT' AS TYP
	FROM
		CDW..DFXX_BR_DFR_REQ DFXX
		INNER JOIN CDW..LNXX_BR_DFR_APV LNXX
			ON LNXX.BF_SSN = DFXX.BF_SSN
			AND LNXX.LF_DFR_CTL_NUM = DFXX.LF_DFR_CTL_NUM
	WHERE
		DFXX.LC_STA_DFRXX = 'A'
		AND LNXX.LC_STA_LONXX = 'A'
		AND DFXX.LF_DOE_SCL_DFR IS NOT NULL
		AND DFXX.LC_DFR_STA = 'A'
		AND CAST(GETDATE() AS DATE) BETWEEN LNXX.LD_DFR_BEG AND LD_DFR_END
		AND DFXX.LC_DFR_TYP IN ('XX','XX','XX','XX','XX')
) POP

SELECT 
	LF_DOE_SCL_ORG AS "SCHOOL CODE",
	SCXX.IM_SCL_FUL AS "SCHOOL NAME",
	COUNT(*) AS "NUMBER OF BORROWERS"
FROM 
	#POP P
	INNER JOIN CDW..SCXX_SCH_DMO SCXX
		ON SCXX.IF_DOE_SCL = P.LF_DOE_SCL_ORG
GROUP BY
	LF_DOE_SCL_ORG,
	SCXX.IM_SCL_FUL
ORDER BY COUNT(*) DESC

