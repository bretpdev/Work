USE CDW
GO

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @SchoolCodes TABLE
(
	SchoolCode CHAR(X),
	SchoolCloseDate DATE
);

INSERT INTO
	@SchoolCodes
VALUES
--OPE ID	Closure Date
 ('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','X/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/X/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','X/X/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','X/X/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/X/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/X/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/X/XXXX')
,('XXXXXXXX','X/XX/XXXX')
,('XXXXXXXX','X/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','X/X/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/X/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/X/XXXX')
,('XXXXXXXX','XX/X/XXXX')
,('XXXXXXXX','XX/X/XXXX')
,('XXXXXXXX','XX/X/XXXX')
,('XXXXXXXX','XX/X/XXXX')
,('XXXXXXXX','XX/X/XXXX')
,('XXXXXXXX','XX/X/XXXX')
,('XXXXXXXX','X/X/XXXX')
,('XXXXXXXX','X/X/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','X/X/XXXX')
,('XXXXXXXX','X/XX/XXXX')
,('XXXXXXXX','X/XX/XXXX')
,('XXXXXXXX','X/X/XXXX')
,('XXXXXXXX','X/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','X/XX/XXXX')
,('XXXXXXXX','X/X/XXXX')
,('XXXXXXXX','X/X/XXXX')
,('XXXXXXXX','X/X/XXXX')
,('XXXXXXXX','X/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/X/XXXX')
,('XXXXXXXX','XX/X/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/X/XXXX')
,('XXXXXXXX','XX/X/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/X/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/XX/XXXX')
,('XXXXXXXX','XX/X/XXXX')
;
--select * from @SchoolCodes

/*****************  STANDARD QUERY  ***********************/
SELECT
	*
INTO 
	#STANDARD_QUERY
FROM
	(
		SELECT DISTINCT
			PDXX.DF_SPE_ACC_ID,
			PDXX.DM_PRS_X,
			PDXX.DM_PRS_MID,
			PDXX.DM_PRS_LST,
			PDXX.DX_STR_ADR_X,
			PDXX.DX_STR_ADR_X,
			PDXX.DX_STR_ADR_X,
			PDXX.DM_CT,
			PDXX.DC_DOM_ST,
			PDXX.DF_ZIP_CDE,
			PDXX.DI_VLD_ADR,
			LNXX.LF_DOE_SCL_ORG,
			SDXX.LF_DOE_SCL_ENR_CUR,
			SDXX.LC_REA_SCL_SPR,
			SDXX.LD_NTF_SCL_SPR,
			SDXX.LD_SCL_SPR [LastDayOfEnrollment],
			School.SchoolCloseDate
		FROM
			PDXX_PRS_NME PDXX
			INNER JOIN PDXX_PRS_ADR PDXX 
				ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
			INNER JOIN 
			(
				SELECT
					LNXX.BF_SSN,
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN LNXX_LON LNXX 
						ON LNXX.LF_DOE_SCL_ORG = SC.SchoolCode

				UNION

				SELECT DISTINCT
					SDXX.LF_STU_SSN [BF_SSN],
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN SDXX_STU_SPR SDXX 
						ON SDXX.LF_DOE_SCL_ENR_CUR = SC.SchoolCode
				WHERE
					SDXX.LC_STA_STUXX = 'A'
			) School 
				ON School.BF_SSN = PDXX.DF_PRS_ID
			INNER JOIN LNXX_LON LNXX 
				ON LNXX.BF_SSN = PDXX.DF_PRS_ID
			LEFT JOIN SDXX_STU_SPR SDXX 
				ON SDXX.LF_STU_SSN = PDXX.DF_PRS_ID 
				AND SDXX.LF_DOE_SCL_ENR_CUR = School.SchoolCode 
				AND SDXX.LC_STA_STUXX = 'A'
		WHERE
			DATEADD(DAY, XXX, SDXX.LD_SCL_SPR) > School.SchoolCloseDate
	) X
WHERE
	DATEADD(DAY, XXX,ISNULL( X.LastDayOfEnrollment, GETDATE())) > X.SchoolCloseDate
	AND
	(
		X.LF_DOE_SCL_ENR_CUR IN (SELECT SchoolCode FROM @SchoolCodes)
		OR	X.LF_DOE_SCL_ORG IN (SELECT SchoolCode FROM @SchoolCodes)
	)
ORDER BY
	X.DF_SPE_ACC_ID
;


/*****************  MODIFIED QUERY  ***********************/
SELECT
	*
INTO
	#MODIFIED_QUERY
FROM
	(
		SELECT DISTINCT
			PDXX.DF_SPE_ACC_ID,
			PDXX.DM_PRS_X,
			PDXX.DM_PRS_MID,
			PDXX.DM_PRS_LST,
			PDXX.DX_STR_ADR_X,
			PDXX.DX_STR_ADR_X,
			PDXX.DX_STR_ADR_X,
			PDXX.DM_CT,
			PDXX.DC_DOM_ST,
			PDXX.DF_ZIP_CDE,
			PDXX.DI_VLD_ADR,
			LNXX.LF_DOE_SCL_ORG,
			SDXX.LF_DOE_SCL_ENR_CUR,
			SDXX.LC_REA_SCL_SPR,
			SDXX.LD_NTF_SCL_SPR,
			SDXX.LD_SCL_SPR [LastDayOfEnrollment],
			School.SchoolCloseDate
		FROM
			PDXX_PRS_NME PDXX
			INNER JOIN PDXX_PRS_ADR PDXX 
				ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
			INNER JOIN 
			(
				SELECT
					LNXX.BF_SSN,
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN LNXX_LON LNXX 
						ON LNXX.LF_DOE_SCL_ORG = SC.SchoolCode

				UNION

				SELECT DISTINCT
					SDXX.LF_STU_SSN [BF_SSN],
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN SDXX_STU_SPR SDXX 
						ON SDXX.LF_DOE_SCL_ENR_CUR = SC.SchoolCode
				WHERE
					SDXX.LC_STA_STUXX = 'A'
			) School 
				ON School.BF_SSN = PDXX.DF_PRS_ID
			INNER JOIN LNXX_LON LNXX 
				ON LNXX.BF_SSN = PDXX.DF_PRS_ID
			LEFT JOIN SDXX_STU_SPR SDXX 
				ON SDXX.LF_STU_SSN = PDXX.DF_PRS_ID 
				AND SDXX.LF_DOE_SCL_ENR_CUR = School.SchoolCode 
				AND SDXX.LC_STA_STUXX = 'A'
		WHERE
			DATEADD(DAY, XXX, SDXX.LD_SCL_SPR) > School.SchoolCloseDate
			AND LNXX.LA_CUR_PRI > X.XX
			AND LNXX.LA_LON_AMT_GTR > X.XX
	) X
WHERE
	DATEADD(DAY, XXX,ISNULL( X.LastDayOfEnrollment, GETDATE())) > X.SchoolCloseDate
	AND
	(
		X.LF_DOE_SCL_ENR_CUR IN (SELECT SchoolCode FROM @SchoolCodes)
		OR	X.LF_DOE_SCL_ORG IN (SELECT SchoolCode FROM @SchoolCodes)
	)
ORDER BY
	X.DF_SPE_ACC_ID
;

--difference
SELECT * FROM #STANDARD_QUERY
EXCEPT
SELECT * FROM #MODIFIED_QUERY
;