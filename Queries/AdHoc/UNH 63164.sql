USE UDW
GO

SELECT DISTINCT
	wq21.*,
	DW01.LN_SEQ,
	DW01.LA_NSI_OTS,
	DW01.LA_NSI_ACR,
	DW01.WA_TOT_BRI_OTS
FROM
	UDW..DF10_BR_DFR_REQ DF10
	INNER JOIN UDW..LN50_BR_DFR_APV LN50
		ON LN50.BF_SSN = DF10.BF_SSN
		AND LN50.LF_DFR_CTL_NUM = DF10.LF_DFR_CTL_NUM
	INNER JOIN UDW..DW01_DW_CLC_CLU DW01
		ON DW01.BF_SSN = DF10.BF_SSN
		AND DW01.LN_SEQ = LN50.LN_SEQ
		AND DW01.WC_DW_LON_STA NOT IN ('04','22','12')
		AND DW01.WX_OVR_DW_LON_STA != 'DECONVERTED'
	INNER JOIN 
	(
		SELECT DISTINCT
			WQ21.WF_QUE,
			WQ21.WF_SUB_QUE,
			WQ21.BF_SSN,
			COUNT(DISTINCT WQ21.WN_CTL_TSK) AS TASK_COUNT
		FROM
			UDW..WQ21_TSK_QUE_HST WQ21
			INNER JOIN
			(
				SELECT DISTINCT
					BF_SSN
				FROM
					UDW..LN10_LON
				WHERE
					IC_LON_PGM = 'STFFRD'
			)LN10
				ON LN10.BF_SSN = WQ21.BF_SSN
		WHERE
			WQ21.WF_QUE = 'RB'
			AND WQ21.WD_ACT_REQ > '2019-07-20' 
		GROUP BY 
			WQ21.WF_QUE,
			WQ21.WF_SUB_QUE,
			WQ21.BF_SSN
		HAVING
			COUNT(DISTINCT WQ21.WN_CTL_TSK) > 1
	) WQ21
		ON WQ21.BF_SSN = DF10.BF_SSN
WHERE
	DF10.LD_DFR_REQ_END > '2019-07-22'
	AND DF10.LD_CRT_REQ_DFR > '2019-07-22'
	AND DF10.LD_CRT_REQ_DFR < '2019-07-30'