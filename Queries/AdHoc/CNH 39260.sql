DROP TABLE IF EXISTS #DATA


;WITH LNXX AS 
(
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			LNXX.LN_RPS_SEQ,
			LC_TYP_SCH_DIS,
			LD_CRT_LONXX,
			LNXX.LF_LST_DTS_LNXX,
			MAX(LNXX.LN_RPS_SEQ) OVER (PARTITION BY LNXX.BF_SSN, LNXX.LN_SEQ) AS MAX_SEQ,
			RSXX.LD_STA_RPSTXX
		FROM
			CDW..LNXX_LON_RPS LNXX
			INNER JOIN CDW..LNXX_LON LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
			INNER JOIN CDW..RSXX_BR_RPD RSXX
				ON RSXX.BF_SSN = LNXX.BF_SSN
				AND RSXX.LN_RPS_SEQ = LNXX.LN_RPS_SEQ
)
SELECT
	*,
	LEAD(L.LN_RPS_SEQ,X) OVER(PARTITION BY BF_SSN, LN_SEQ ORDER BY LN_RPS_SEQ DESC) AS LAST_SCHEDULE,
	LEAD(L.LN_RPS_SEQ,X) OVER(PARTITION BY BF_SSN, LN_SEQ ORDER BY LN_RPS_SEQ DESC) AS THIRD_SCHEDULE
INTO #DATA
FROM
	LNXX L


--PART C QUESTION X
--SELECT
--	COUNT(*) AS [BORROWER COUNT],
--	'CORNERSTONE' AS SERVICER,
--	ISNULL(LKXX.PX_DSC_MDM, CX.LC_TYP_SCH_DIS) AS [IDR PLAN],
--	CX.[YEAR],
--	CX.[STATE]	
--FROM
--(
--	SELECT DISTINCT
--		D.BF_SSN,
--		D.LC_TYP_SCH_DIS,
--		ISNULL(NULLIF(ISNULL(NULLIF(PDXX.DC_DOM_ST,''), PDXX.DM_FGN_ST),''), DM_FGN_CNY) AS [STATE] ,
--		YEAR(D.LD_CRT_LONXX) AS [YEAR]
--		--DX.*,

--		--CASE --IBR, REPAYE, IBRXXXX, PAYE, ICRX, ICRX, ICRX
--		--	WHEN D.LC_TYP_SCH_DIS IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX') AND DX.LC_TYP_SCH_DIS IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX') THEN 'Y' 
--		--	WHEN  D.LC_TYP_SCH_DIS NOT IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX') THEN NULL
--		--	ELSE 'N' 
--		--END AS DID_RECERT_ONTIME 
--	FROM
--		#DATA D
--		INNER JOIN CDW..PDXX_PRS_ADR PDXX
--			ON PDXX.DF_PRS_ID = D.BF_SSN
--			AND PDXX.DC_ADR = 'L'
--		INNER JOIN #DATA DX
--			ON D.BF_SSN = DX.BF_SSN
--			AND D.LN_SEQ = DX.LN_SEQ
--			AND D.LAST_SCHEDULE = DX.LN_RPS_SEQ
--WHERE 
--	CASE --IBR, REPAYE, IBRXXXX, PAYE, ICRX, ICRX, ICRX
--			WHEN D.LC_TYP_SCH_DIS IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX') AND DX.LC_TYP_SCH_DIS IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX') THEN X 
--			WHEN  D.LC_TYP_SCH_DIS NOT IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX') THEN NULL
--			ELSE X
--		END = X
--) CX
--LEFT JOIN CDW..LKXX_LS_CDE_LKP LKXX
--	ON LKXX.PM_ATR = 'LC-TYP-SCH-DIS'
--	AND LKXX.PX_ATR_VAL = CX.LC_TYP_SCH_DIS
--GROUP BY
--	CX.[STATE],
--	ISNULL(LKXX.PX_DSC_MDM, CX.LC_TYP_SCH_DIS),
--	CX.[YEAR]
--ORDER BY
--	CX.[STATE],
--	CX.[YEAR],
--	ISNULL(LKXX.PX_DSC_MDM, CX.LC_TYP_SCH_DIS) 

--PART C QUESTION X
--SELECT DISTINCT
--	COUNT(DISTINCT BF_SSN) AS [BORROWER COUNT],
--	ISNULL(NULLIF(MONTHS_TO_RECERT,X),X) AS MONTHS_TO_RECERT,
--	'CORNERSTONE' AS SERVICER,
--	ISNULL(LKXX.PX_DSC_MDM, CURRENT_SCHEDULE) AS [IDR PLAN],
--	[YEAR],
--	[STATE]
--FROM
--	(
--		SELECT
--			BF_SSN,
--			[STATE],
--			LX.CURRENT_SCHEDULE,
--			DATEDIFF(MONTH, CAST(LX.SECOND_SCHEDULE_CREATE AS DATE), LX.LD_CRT_LONXX) AS MONTHS_TO_RECERT, --TAKE THE CURRENT SCHEDUELL CREATE DATE - THE LAST UPDATE OF THE PREVIOUS SCHEDULE
--			YEAR(LX.LD_CRT_LONXX) AS [YEAR],
--			ROW_NUMBER() OVER(PARTITION BY 	BF_SSN ORDER BY LD_CRT_LONXX) AS FAILED_COUNT
--		FROM
--		(
--			SELECT DISTINCT
--				POPX.BF_SSN,
--				POPX.CURRENT_SCHEDULE,
--				POPX.SECOND_SCHEDULE,
--				POPX.LD_CRT_LONXX,
--				POPX.SECOND_SCHEDULE_CREATE,
--				DX.LD_CRT_LONXX AS THRID_SCHEDULE_CREATE_DATE,
--				DX.LC_TYP_SCH_DIS AS THRID_SCHEDULE,
--				POPX.[YEAR],
--				[STATE]
--			FROM
--			(
--				SELECT DISTINCT
--					D.BF_SSN,
--					D.LN_SEQ,
--					D.LC_TYP_SCH_DIS AS CURRENT_SCHEDULE,
--					D.LN_RPS_SEQ,
--					D.LAST_SCHEDULE,
--					D.THIRD_SCHEDULE,
--					D.LD_CRT_LONXX,
--					D.MAX_SEQ,
--					ISNULL(NULLIF(ISNULL(NULLIF(PDXX.DC_DOM_ST,''), PDXX.DM_FGN_ST),''), DM_FGN_CNY) AS [STATE] ,
--					YEAR(GETDATE()) AS [YEAR],
--					DX.LC_TYP_SCH_DIS AS SECOND_SCHEDULE,
--					DX.LD_CRT_LONXX AS SECOND_SCHEDULE_CREATE
--				FROM
--					#DATA D
--					INNER JOIN CDW..PDXX_PRS_ADR PDXX
--						ON PDXX.DF_PRS_ID = D.BF_SSN
--						AND PDXX.DC_ADR = 'L'
--					INNER JOIN #DATA DX
--						ON D.BF_SSN = DX.BF_SSN
--						AND D.LN_SEQ = DX.LN_SEQ
--						AND D.LAST_SCHEDULE = DX.LN_RPS_SEQ
--		) POPX
--		INNER JOIN #DATA DX
--			ON POPX.BF_SSN = DX.BF_SSN
--			AND POPX.LN_SEQ = DX.LN_SEQ
--			AND POPX.THIRD_SCHEDULE = DX.LN_RPS_SEQ
--		WHERE
--			CASE WHEN POPX.CURRENT_SCHEDULE IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX') 
--					AND POPX.SECOND_SCHEDULE IN ('CP', 'CQ', 'IL', 'IP', 'IA') 
--					AND DX.LC_TYP_SCH_DIS IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX')  THEN X 
--			WHEN  POPX.CURRENT_SCHEDULE NOT IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX') THEN NULL
--			ELSE X 
--			END = X
--	) LX
--) QX

--	LEFT JOIN CDW..LKXX_LS_CDE_LKP LKXX
--		ON LKXX.PM_ATR = 'LC-TYP-SCH-DIS'
--		AND LKXX.PX_ATR_VAL = QX.CURRENT_SCHEDULE
--	WHERE
--		QX.FAILED_COUNT = X
--group by
--	MONTHS_TO_RECERT,
--	ISNULL(LKXX.PX_DSC_MDM, CURRENT_SCHEDULE),
--	[STATE],
--	[YEAR]
--ORDER BY
--	[STATE],
--	[YEAR],
--	[IDR PLAN]


--PART C QUESTION X
--SELECT DISTINCT
--	COUNT(DISTINCT BF_SSN) AS [BORROWER COUNT],
--	NUM_OF_FAILED AS [NUMBER OF LATE RECERT], 
--	'CORNERSTONE' AS SERVICER,
--	ISNULL(LKXX.PX_DSC_MDM, CURRENT_SCHEDULE) AS [IDR PLAN],
--	[STATE],
--	YEAR(CAST(GETDATE() AS DATE)) AS [YEAR]
--FROM
--	(
--		SELECT
--			QX.BF_SSN,
--			QX.CURRENT_SCHEDULE,
--			QX.[STATE],
--			MAX(QX.FAILED_COUNT) OVER(PARTITION BY QX.BF_SSN) AS NUM_OF_FAILED
--		FROM
--		(
--			SELECT
--				BF_SSN,
--				[STATE],
--				LX.CURRENT_SCHEDULE,
--				ROW_NUMBER() OVER(PARTITION BY 	BF_SSN ORDER BY LD_CRT_LONXX) AS FAILED_COUNT
--			FROM
--			(
--				SELECT DISTINCT
--					POPX.BF_SSN,
--					POPX.CURRENT_SCHEDULE,
--					POPX.SECOND_SCHEDULE,
--					POPX.LD_CRT_LONXX,
--					POPX.SECOND_SCHEDULE_CREATE,
--					DX.LD_CRT_LONXX AS THRID_SCHEDULE_CREATE_DATE,
--					DX.LC_TYP_SCH_DIS AS THRID_SCHEDULE,
--					POPX.[YEAR],
--					[STATE]
--				FROM
--				(
--					SELECT DISTINCT
--						D.BF_SSN,
--						D.LN_SEQ,
--						D.LC_TYP_SCH_DIS AS CURRENT_SCHEDULE,
--						D.LN_RPS_SEQ,
--						D.LAST_SCHEDULE,
--						D.THIRD_SCHEDULE,
--						D.LD_CRT_LONXX,
--						D.MAX_SEQ,
--						ISNULL(NULLIF(ISNULL(NULLIF(PDXX.DC_DOM_ST,''), PDXX.DM_FGN_ST),''), DM_FGN_CNY) AS [STATE] ,
--						YEAR(GETDATE()) AS [YEAR],
--						DX.LC_TYP_SCH_DIS AS SECOND_SCHEDULE,
--						DX.LD_CRT_LONXX AS SECOND_SCHEDULE_CREATE
--					FROM
--						#DATA D
--						INNER JOIN CDW..PDXX_PRS_ADR PDXX
--							ON PDXX.DF_PRS_ID = D.BF_SSN
--							AND PDXX.DC_ADR = 'L'
--						INNER JOIN #DATA DX
--							ON D.BF_SSN = DX.BF_SSN
--							AND D.LN_SEQ = DX.LN_SEQ
--							AND D.LAST_SCHEDULE = DX.LN_RPS_SEQ
--			) POPX
--			INNER JOIN #DATA DX
--				ON POPX.BF_SSN = DX.BF_SSN
--				AND POPX.LN_SEQ = DX.LN_SEQ
--				AND POPX.THIRD_SCHEDULE = DX.LN_RPS_SEQ
--			WHERE
--				CASE WHEN POPX.CURRENT_SCHEDULE IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX') 
--						AND POPX.SECOND_SCHEDULE IN ('CP', 'CQ', 'IL', 'IP', 'IA') 
--						AND DX.LC_TYP_SCH_DIS IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX')  THEN X 
--				WHEN  POPX.CURRENT_SCHEDULE NOT IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX') THEN NULL
--				ELSE X 
--				END = X
--		) LX
--		) QX

--		LEFT JOIN CDW..LKXX_LS_CDE_LKP LKXX
--			ON LKXX.PM_ATR = 'LC-TYP-SCH-DIS'
--			AND LKXX.PX_ATR_VAL = QX.CURRENT_SCHEDULE
--		WHERE
--			QX.FAILED_COUNT > X
--)FINALQX
--LEFT JOIN CDW..LKXX_LS_CDE_LKP LKXX
--			ON LKXX.PM_ATR = 'LC-TYP-SCH-DIS'
--			AND LKXX.PX_ATR_VAL = FINALQX.CURRENT_SCHEDULE
--GROUP BY 
--ISNULL(LKXX.PX_DSC_MDM, CURRENT_SCHEDULE),
--	[STATE],
--	NUM_OF_FAILED
--order by 
--	[STATE],
--	[IDR PLAN]

--PART C QUESTION X
--SELECT
--	COUNT(*) AS [BORROWER COUNT],
--  'CORNERSTONE' AS SERVICER,
--	ISNULL(LKXX.PX_DSC_MDM, CX.LC_TYP_SCH_DIS) AS [IDR PLAN],
--	CX.[YEAR],
--	CX.[STATE]
--FROM
--(
--	SELECT DISTINCT
--		D.BF_SSN,
--		DX.LC_TYP_SCH_DIS,
--		ISNULL(NULLIF(ISNULL(NULLIF(PDXX.DC_DOM_ST,''), PDXX.DM_FGN_ST),''), DM_FGN_CNY) AS [STATE] ,
--		YEAR(GETDATE()) AS [YEAR]
--		--DX.*,

--		--CASE --IBR, REPAYE, IBRXXXX, PAYE, ICRX, ICRX, ICRX
--		--	WHEN D.LC_TYP_SCH_DIS IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX') AND DX.LC_TYP_SCH_DIS IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX') THEN 'Y' 
--		--	WHEN  D.LC_TYP_SCH_DIS NOT IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX') THEN NULL
--		--	ELSE 'N' 
--		--END AS DID_RECERT_ONTIME 
--	FROM
--		#DATA D
--		INNER JOIN CDW..PDXX_PRS_ADR PDXX
--			ON PDXX.DF_PRS_ID = D.BF_SSN
--			AND PDXX.DC_ADR = 'L'
--		INNER JOIN #DATA DX
--			ON D.BF_SSN = DX.BF_SSN
--			AND D.LN_SEQ = DX.LN_SEQ
--			AND D.LAST_SCHEDULE = DX.LN_RPS_SEQ
--WHERE 
--	 CASE --IBR, REPAYE, IBRXXXX, PAYE, ICRX, ICRX, ICRX
--			WHEN D.LC_TYP_SCH_DIS NOT IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX') AND DX.LC_TYP_SCH_DIS IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX') THEN X 
--			WHEN  D.LC_TYP_SCH_DIS NOT IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX') THEN NULL
--			ELSE X
--		END = X
--) CX
--LEFT JOIN CDW..LKXX_LS_CDE_LKP LKXX
--	ON LKXX.PM_ATR = 'LC-TYP-SCH-DIS'
--	AND LKXX.PX_ATR_VAL = CX.LC_TYP_SCH_DIS
--GROUP BY
--	CX.[STATE],
--	ISNULL(LKXX.PX_DSC_MDM, CX.LC_TYP_SCH_DIS),
--	CX.[YEAR]
--ORDER BY
--	CX.[STATE],
--	ISNULL(LKXX.PX_DSC_MDM, CX.LC_TYP_SCH_DIS) 

--PART D QUESTION X
--SELECT
--	COUNT(DISTINCT BF_SSN) AS [BORROWER COUNT],
--	'CONTERSTONE' AS SERVICER,
--	ISNULL(LKXX.PX_DSC_MDM, DX.LC_TYP_SCH_DIS) AS [IDR PLAN],
--	YEAR(LD_DLQ_MAX) AS [DEFAULT YEAR],
--	[STATE]
	
--FROM
--(
--SELECT DISTINCT
--		--D.BF_SSN,
--		D.LC_TYP_SCH_DIS,
--		ISNULL(NULLIF(ISNULL(NULLIF(PDXX.DC_DOM_ST,''), PDXX.DM_FGN_ST),''), DM_FGN_CNY) AS [STATE] ,
--		YEAR(GETDATE()) AS [YEAR],
--		 D.LD_CRT_LONXX,
--		 SUM(DATEDIFF(DAY,D.LD_CRT_LONXX,LNXX.LD_DLQ_MAX)/XXX.XX*XX.XX) OVER(PARTITION BY D.BF_SSN, D.LN_SEQ) AS DIF ,
--		 LNXX.*
--	FROM
--		#DATA D
--		INNER JOIN CDW..PDXX_PRS_ADR PDXX
--			ON PDXX.DF_PRS_ID = D.BF_SSN
--			AND PDXX.DC_ADR = 'L'
--		INNER JOIN #DATA DX
--			ON D.BF_SSN = DX.BF_SSN
--			AND D.LN_SEQ = DX.LN_SEQ
--			AND D.LAST_SCHEDULE = DX.LN_RPS_SEQ
--		INNER JOIN CDW..LNXX_LON_DLQ_HST LNXX
--			ON LNXX.BF_SSN = D.BF_SSN
--			AND LNXX.LN_SEQ = D.LN_SEQ
--			AND LNXX.LD_DLQ_OCC > D.LD_CRT_LONXX
--			AND LNXX.LC_STA_LONXX = 'X'
--			AND LNXX.LN_DLQ_MAX >= XXX
--WHERE 
--	 CASE --IBR, REPAYE, IBRXXXX, PAYE, ICRX, ICRX, ICRX
--			WHEN D.LC_TYP_SCH_DIS NOT IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX') AND DX.LC_TYP_SCH_DIS IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX') THEN X 
--			WHEN  D.LC_TYP_SCH_DIS NOT IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX') THEN NULL
--			ELSE X
--		END = X
--)DX
--LEFT JOIN CDW..LKXX_LS_CDE_LKP LKXX
--	ON LKXX.PM_ATR = 'LC-TYP-SCH-DIS'
--	AND LKXX.PX_ATR_VAL = DX.LC_TYP_SCH_DIS
--WHERE
--	DX.DIF BETWEEN XX.XX AND XX.XX
--GROUP BY
--	ISNULL(LKXX.PX_DSC_MDM, DX.LC_TYP_SCH_DIS),
--	[STATE],
--	YEAR(LD_DLQ_MAX)

--PART E QUESTIONX
--SELECT
--	COUNT(*) AS [BORROWER COUNT],
--	ISNULL(LKXX.PX_DSC_MDM, EX.LC_TYP_SCH_DIS) AS [IDR PLAN],
--	YEAR(EX.[BEGIN]) AS [YEAR],
--	'D-' + [TYPE] AS [TYPE],
--	[DURATION],
--	[STATE]
--FROM
--(
--	SELECT DISTINCT 
--		D.BF_SSN,
--		D.LD_CRT_LONXX AS [BEGIN],
--		D.LF_LST_DTS_LNXX AS [END],
--		D.LC_TYP_SCH_DIS,
--		LNXX.LD_DFR_BEG,
--		LNXX.LD_DFR_END,
--		ISNULL(LKXX.PX_DSC_MDM,  DFXX.LC_DFR_TYP) AS [TYPE],
--		ISNULL(NULLIF(DATEDIFF(MONTH, LNXX.LD_DFR_BEG, LNXX.LD_DFR_END),X),X) AS [DURATION],
--		ISNULL(NULLIF(ISNULL(NULLIF(PDXX.DC_DOM_ST,''), PDXX.DM_FGN_ST),''), DM_FGN_CNY) AS [STATE]
--	FROM
--		#DATA D
--		INNER JOIN CDW..DFXX_BR_DFR_REQ DFXX
--			ON DFXX.BF_SSN = D.BF_SSN
--		INNER JOIN CDW..LNXX_BR_DFR_APV LNXX
--			ON LNXX.BF_SSN = D.BF_SSN
--			AND LNXX.LN_SEQ = D.LN_SEQ
--			AND LNXX.LF_DFR_CTL_NUM = DFXX.LF_DFR_CTL_NUM
--			AND LNXX.LC_STA_LONXX = 'A'
--			AND DFXX.LC_DFR_STA = 'A'
--			AND DFXX.LC_STA_DFRXX = 'A'
--		INNER JOIN CDW..PDXX_PRS_ADR PDXX
--			ON PDXX.DF_PRS_ID = D.BF_SSN
--			AND PDXX.DC_ADR = 'L'
--		LEFT JOIN CDW..LKXX_LS_CDE_LKP LKXX
--			ON LKXX.PM_ATR = 'LC-DFR-TYP'
--			AND LKXX.PX_ATR_VAL = DFXX.LC_DFR_TYP
--	WHERE
--		D.LC_TYP_SCH_DIS IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX')
--		AND 
--		(
--			LNXX.LD_DFR_BEG BETWEEN D.LD_CRT_LONXX AND D.LF_LST_DTS_LNXX
--			OR
--			LNXX.LD_DFR_END BETWEEN D.LD_CRT_LONXX AND D.LF_LST_DTS_LNXX
--		)
--) EX
--LEFT JOIN CDW..LKXX_LS_CDE_LKP LKXX
--	ON LKXX.PM_ATR = 'LC-TYP-SCH-DIS'
--	AND LKXX.PX_ATR_VAL = EX.LC_TYP_SCH_DIS	
--GROUP BY
--	ISNULL(LKXX.PX_DSC_MDM, EX.LC_TYP_SCH_DIS),
--	YEAR(EX.[BEGIN]),
--	[TYPE],
--	[DURATION],
--	[STATE]

--UNION

--SELECT
--	COUNT(*) AS [BORROWER COUNT],
--	ISNULL(LKXX.PX_DSC_MDM, EX.LC_TYP_SCH_DIS) AS [IDR PLAN],
--	YEAR(EX.[BEGIN]) AS [YEAR],
--	'F-' + [TYPE] AS [TYPE],
--	[DURATION],
--	[STATE]
--FROM
--(
--	SELECT DISTINCT 
--		D.BF_SSN,
--		D.LD_CRT_LONXX AS [BEGIN],
--		D.LF_LST_DTS_LNXX AS [END],
--		D.LC_TYP_SCH_DIS,
--		LNXX.LD_FOR_BEG,
--		LNXX.LD_FOR_END,
--		ISNULL(LKXX.PX_DSC_MDM,  FBXX.LC_FOR_TYP) AS [TYPE],
--		ISNULL(NULLIF(DATEDIFF(MONTH, LNXX.LD_FOR_BEG, LNXX.LD_FOR_END),X),X) AS [DURATION],
--		ISNULL(NULLIF(ISNULL(NULLIF(PDXX.DC_DOM_ST,''), PDXX.DM_FGN_ST),''), DM_FGN_CNY) AS [STATE]
--	FROM
--		#DATA D
--		INNER JOIN CDW..FBXX_BR_FOR_REQ FBXX
--			ON FBXX.BF_SSN = D.BF_SSN
--		INNER JOIN CDW..LNXX_BR_FOR_APV LNXX
--			ON LNXX.BF_SSN = D.BF_SSN
--			AND LNXX.LN_SEQ = D.LN_SEQ
--			AND LNXX.LF_FOR_CTL_NUM = FBXX.LF_FOR_CTL_NUM
--			AND LNXX.LC_STA_LONXX = 'A'
--			AND FBXX.LC_FOR_STA = 'A'
--			AND FBXX.LC_STA_FORXX = 'A'
--		INNER JOIN CDW..PDXX_PRS_ADR PDXX
--			ON PDXX.DF_PRS_ID = D.BF_SSN
--			AND PDXX.DC_ADR = 'L'
--		LEFT JOIN CDW..LKXX_LS_CDE_LKP LKXX
--			ON LKXX.PM_ATR = 'LC-FOR-TYP'
--			AND LKXX.PX_ATR_VAL = FBXX.LC_FOR_TYP
--	WHERE
--		D.LC_TYP_SCH_DIS IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX')
--		AND 
--		(
--			LNXX.LD_FOR_BEG BETWEEN D.LD_CRT_LONXX AND D.LF_LST_DTS_LNXX
--			OR
--			LNXX.LD_FOR_BEG BETWEEN D.LD_CRT_LONXX AND D.LF_LST_DTS_LNXX
--		)
--) EX
--LEFT JOIN CDW..LKXX_LS_CDE_LKP LKXX
--	ON LKXX.PM_ATR = 'LC-TYP-SCH-DIS'
--	AND LKXX.PX_ATR_VAL = EX.LC_TYP_SCH_DIS	
--GROUP BY
--	ISNULL(LKXX.PX_DSC_MDM, EX.LC_TYP_SCH_DIS),
--	YEAR(EX.[BEGIN]),
--	[TYPE],
--	[DURATION],
--	[STATE]
--ORDER BY
--	[STATE],
--	[TYPE],
--	DURATION

--PART F QUESTION X
--SELECT DISTINCT 
--		PDXX.DF_SPE_ACC_ID AS [ACCOUNT NUMBER],
--		COUNT(*) OVER(PARTITION BY D.BF_SSN) AS [NUMBER OF LOANS],
--		SUM(LNXX.LA_FAT_CUR_PRI) OVER(PARTITION BY D.BF_SSN) AS [TOTAL PRINCIPAL BALANCE],
--		SUM(LNXX.LA_FAT_NSI) OVER(PARTITION BY D.BF_SSN) AS [TOTAL INTEREST BALANCE],
--		SUM(LNXX.LA_DSB) OVER(PARTITION BY D.BF_SSN) AS [TOTAL ORIGINAL BALANCE],
--		SUM((LNXX.LA_FAT_CUR_PRI + LNXX.LA_FAT_NSI)) OVER(PARTITION BY D.BF_SSN) AS [TOTAL COLLECTED],
--		D.LC_TYP_SCH_DIS AS [IDR PLAN],
--		MAX(CASE WHEN LNXX.IC_LON_PGM = 'DLPLGB' THEN X ELSE X END) OVER(PARTITION BY D.BF_SSN) AS [HAS GRADUATE LOANS],
--		'CORNERSTONE' AS SERICER,
--		ISNULL(NULLIF(ISNULL(NULLIF(PDXX.DC_DOM_ST,''), PDXX.DM_FGN_ST),''), DM_FGN_CNY) AS [STATE]
--	FROM
--		#DATA D
--		INNER JOIN CDW..PDXX_PRS_NME PDXX
--			ON PDXX.DF_PRS_ID = D.BF_SSN
--		INNER JOIN CDW..LNXX_LON LNXX
--			ON LNXX.BF_SSN = D.BF_SSN
--			AND LNXX.LN_SEQ = D.LN_SEQ
--		INNER JOIN CDW..PDXX_PRS_ADR PDXX
--			ON PDXX.DF_PRS_ID = D.BF_SSN
--			AND PDXX.DC_ADR = 'L'
--		INNER JOIN 
--		(
--			SELECT
--				LNXX.BF_SSN,
--				LNXX.LN_SEQ,
--				ABS(SUM(ISNULL(LNXX.LA_FAT_CUR_PRI,X))) AS LA_FAT_CUR_PRI,
--				ABS(SUM(ISNULL(LNXX.LA_FAT_NSI,X))) AS LA_FAT_NSI
--			FROM	
--				CDW..LNXX_FIN_ATY LNXX
--			WHERE
--				ISNULL(LNXX.LC_FAT_REV_REA,'') = ''
--				AND LNXX.LC_STA_LONXX = 'A'
--				AND LNXX.PC_FAT_TYP = 'XX'
--			GROUP BY
--				LNXX.BF_SSN,
--				LNXX.LN_SEQ
--		)LNXX
--			ON LNXX.BF_SSN = D.BF_SSN
--			AND LNXX.LN_SEQ = D.LN_SEQ
--		INNER JOIN 
--		(
--			SELECT
--				BF_SSN,
--				LN_SEQ,
--				SUM(ISNULL(LA_DSB,X) - ISNULL(LA_DSB_CAN,X)) AS LA_DSB
--			FROM
--				CDW..LNXX_DSB
--			WHERE
--				LC_STA_LONXX  = 'X'
--				AND LC_DSB_TYP = 'X'
--			GROUP BY
--				BF_SSN,
--				LN_SEQ

--		)LNXX
--			ON LNXX.BF_SSN = D.BF_SSN
--			AND LNXX.LN_SEQ = D.LN_SEQ
			
--	WHERE
--		D.LC_TYP_SCH_DIS IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX')
--		AND LNXX.LD_PIF_RPT BETWEEN D.LD_CRT_LONXX AND D.LD_STA_RPSTXX

--PART F QUESION X
--SELECT DISTINCT 
--		PDXX.DF_SPE_ACC_ID AS [ACCOUNT NUMBER],
--		COUNT(*) OVER(PARTITION BY D.BF_SSN) AS [NUMBER OF LOANS],
--		SUM(TOTAL_BALANCE.LA_FAT_CUR_PRI) OVER(PARTITION BY D.BF_SSN) AS [TOTAL PRINCIPAL BALANCE],
--		SUM(TOTAL_BALANCE.LA_FAT_NSI) OVER(PARTITION BY D.BF_SSN) AS [TOTAL INTEREST BALANCE],
--		SUM(LNXX.LA_DSB) OVER(PARTITION BY D.BF_SSN) AS [TOTAL ORIGINAL BALANCE],
--		SUM((ISNULL(LNXX.LA_FAT_CUR_PRI,X) + ISNULL(LNXX.LA_FAT_NSI,X))) OVER(PARTITION BY D.BF_SSN) AS [TOTAL COLLECTED],
--		D.LC_TYP_SCH_DIS AS [IDR PLAN],
--		MAX(CASE WHEN LNXX.IC_LON_PGM = 'DLPLGB' THEN X ELSE X END) OVER(PARTITION BY D.BF_SSN) AS [HAS GRADUATE LOANS],
--		'CORNERSTONE' AS SERICER,
--		CASE 
--			WHEN ARCS.PF_REQ_ACT = 'ADDTH' THEN 'Death'
--			WHEN ARCS.PF_REQ_ACT = 'ADCSH' THEN 'Closed School'
--			WHEN ARCS.PF_REQ_ACT = 'ADTLF' THEN 'Teacher Loan Forgiveness'
--			WHEN ARCS.PF_REQ_ACT = 'ADFCR' THEN 'False Certification'
--			WHEN ARCS.PF_REQ_ACT = 'ADUPR' THEN 'Unpaid Refund'
--			WHEN ARCS.PF_REQ_ACT = 'IDAPB' THEN 'ID Theft'
--			WHEN ARCS.PF_REQ_ACT = 'TPDAP' THEN 'Total Permanent Disability'
--			ELSE NULL
--		END AS [FPRGIVENESS PROGRAM],
--		ISNULL(NULLIF(ISNULL(NULLIF(PDXX.DC_DOM_ST,''), PDXX.DM_FGN_ST),''), DM_FGN_CNY) AS [STATE]
--	FROM
--		#DATA D
--		INNER JOIN CDW..PDXX_PRS_NME PDXX
--			ON PDXX.DF_PRS_ID = D.BF_SSN
--		INNER JOIN CDW..LNXX_LON LNXX
--			ON LNXX.BF_SSN = D.BF_SSN
--			AND LNXX.LN_SEQ = D.LN_SEQ
--		INNER JOIN CDW..PDXX_PRS_ADR PDXX
--			ON PDXX.DF_PRS_ID = D.BF_SSN
--			AND PDXX.DC_ADR = 'L'
--		INNER JOIN 
--		(
--			SELECT
--				BF_SSN,
--				LN_SEQ,
--				SUM(ISNULL(LA_DSB,X) - ISNULL(LA_DSB_CAN,X)) AS LA_DSB
--			FROM
--				CDW..LNXX_DSB
--			WHERE
--				LC_STA_LONXX  = 'X'
--				AND LC_DSB_TYP = 'X'
--			GROUP BY
--				BF_SSN,
--				LN_SEQ

--		)LNXX
--			ON LNXX.BF_SSN = D.BF_SSN
--			AND LNXX.LN_SEQ = D.LN_SEQ
--		INNER JOIN
--		(
--			SELECT
--				LNXX.BF_SSN,
--				LNXX.LN_SEQ,
--				AYXX.LD_ATY_REQ_RCV,
--				AYXX.PF_REQ_ACT
--			FROM
--				CDW..LNXX_LON_ATY LNXX
--				INNER JOIN CDW..AYXX_BR_LON_ATY AYXX
--					ON AYXX.BF_SSN = LNXX.BF_SSN
--					AND AYXX.LN_ATY_SEQ = LNXX.LN_ATY_SEQ
--			WHERE
--				AYXX.PF_REQ_ACT IN ('ADDTH','ADCSH','ADTLF','ADFCR','ADUPR','IDAPB','TPDAP')
--		) ARCS
--			ON ARCS.BF_SSN = D.BF_SSN
--			AND ARCS.LN_SEQ = D.LN_SEQ
--		INNER JOIN 
--		(
--			SELECT
--				LNXX.BF_SSN,
--				LNXX.LN_SEQ,
--				ABS(SUM(ISNULL(LNXX.LA_FAT_CUR_PRI,X))) AS LA_FAT_CUR_PRI,
--				ABS(SUM(ISNULL(LNXX.LA_FAT_NSI,X))) AS LA_FAT_NSI
--			FROM	
--				CDW..LNXX_FIN_ATY LNXX
--			WHERE
--				ISNULL(LNXX.LC_FAT_REV_REA,'') = ''
--				AND LNXX.LC_STA_LONXX = 'A'
--				AND LNXX.PC_FAT_TYP = 'XX'
--				AND LNXX.PC_FAT_SUB_TYP = 'XX'
--			GROUP BY
--				LNXX.BF_SSN,
--				LNXX.LN_SEQ
--		) TOTAL_BALANCE
--			ON TOTAL_BALANCE.BF_SSN = D.BF_SSN
--			AND TOTAL_BALANCE.LN_SEQ = D.LN_SEQ
--		LEFT JOIN 
--		(
--			SELECT
--				LNXX.BF_SSN,
--				LNXX.LN_SEQ,
--				ABS(SUM(ISNULL(LNXX.LA_FAT_CUR_PRI,X))) AS LA_FAT_CUR_PRI,
--				ABS(SUM(ISNULL(LNXX.LA_FAT_NSI,X))) AS LA_FAT_NSI
--			FROM	
--				CDW..LNXX_FIN_ATY LNXX
--			WHERE
--				ISNULL(LNXX.LC_FAT_REV_REA,'') = ''
--				AND LNXX.LC_STA_LONXX = 'A'
--				AND LNXX.PC_FAT_TYP = 'XX'
--			GROUP BY
--				LNXX.BF_SSN,
--				LNXX.LN_SEQ
--		)LNXX
--			ON LNXX.BF_SSN = D.BF_SSN
--			AND LNXX.LN_SEQ = D.LN_SEQ

			
--	WHERE
--		D.LC_TYP_SCH_DIS IN ('IB', 'IX', 'IX', 'CA', 'CX','CX','CX')
--		AND ARCS.LD_ATY_REQ_RCV BETWEEN D.LD_CRT_LONXX AND D.LD_STA_RPSTXX
