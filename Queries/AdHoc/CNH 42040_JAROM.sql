USE CDW

GO
--XXXXX
--XXXXX


--SELECT DISTINCT
--	FSXX.BF_SSN,
--	FSXX.LN_SEQ,
--	CNH.[AWARD ID],
--	ISNULL(FORB.LC_FOR_TYP, 'NO FORBEARANCE') AS FORB_TYPE
--FROM
--	CDW..[CNH XXXXX] CNH	
--	INNER JOIN CDW..FSXX_DL_LON FSXX
--		ON (FSXX.LF_FED_AWD + RIGHT('XXX' + CAST(FSXX.LN_FED_AWD_SEQ AS VARCHAR(XX)), X)) = CNH.[AWARD ID]
--	INNER JOIN CDW..LNXX_LON LNXX
--		ON LNXX.BF_SSN = FSXX.BF_SSN
--		AND LNXX.LN_SEQ = FSXX.LN_SEQ 
--	LEFT JOIN
--	(
--		SELECT 
--			LNXX.BF_SSN,
--			LNXX.LN_SEQ,
--			FBXX.LC_FOR_TYP
--		FROM
--			CDW..FBXX_BR_FOR_REQ FBXX
--			INNER JOIN CDW..LNXX_BR_FOR_APV LNXX
--				ON LNXX.BF_SSN = FBXX.BF_SSN
--				AND LNXX.LF_FOR_CTL_NUM = FBXX.LF_FOR_CTL_NUM
--			INNER JOIN CDW..LNXX_LON LNXX
--				ON LNXX.BF_SSN = LNXX.BF_SSN
--				AND LNXX.LN_SEQ = LNXX.LN_SEQ
--				AND LNXX.LA_CUR_PRI > X
--				AND LNXX.LC_STA_LONXX = 'R'
--		WHERE
--			LNXX.LC_STA_LONXX = 'A'
--			AND FBXX.LC_STA_FORXX = 'A'
--			AND FBXX.LC_FOR_STA = 'A' --denied records cant have this active
--			AND LNXX.LC_FOR_RSP != 'XXX'
	
--			AND	CAST(GETDATE() AS DATE) BETWEEN LNXX.LD_FOR_BEG AND LNXX.LD_FOR_END
--	) FORB 
--		ON FORB.BF_SSN = FSXX.BF_SSN
--		AND FORB.LN_SEQ = FSXX.LN_SEQ






SELECT DISTINCT
	FSXX.BF_SSN,
	FSXX.LN_SEQ,
	CNH.[AWARD ID],
	ISNULL(FORB.LC_FOR_TYP, 'NO') AS FORB_TYPE,
	DWXX.WC_DW_LON_STA,
	forbf.*,
	def.*
FROM
	CDW..[CNH XXXXX] CNH	
	INNER JOIN CDW..FSXX_DL_LON FSXX
		ON (FSXX.LF_FED_AWD + RIGHT('XXX' + CAST(FSXX.LN_FED_AWD_SEQ AS VARCHAR(XX)), X)) = CNH.[AWARD ID]
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = FSXX.BF_SSN
		AND LNXX.LN_SEQ = FSXX.LN_SEQ 
	INNER JOIN CDW..DWXX_DW_CLC_CLU DWXX
		ON DWXX.BF_SSN = LNXX.BF_SSN
		AND DWXX.LN_SEQ = LNXX.LN_SEQ
	LEFT JOIN
	(
		SELECT 
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			FBXX.LC_FOR_TYP
		FROM
			CDW..FBXX_BR_FOR_REQ FBXX
			INNER JOIN CDW..LNXX_BR_FOR_APV LNXX
				ON LNXX.BF_SSN = FBXX.BF_SSN
				AND LNXX.LF_FOR_CTL_NUM = FBXX.LF_FOR_CTL_NUM
			INNER JOIN CDW..LNXX_LON LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
				AND LNXX.LA_CUR_PRI > X
				AND LNXX.LC_STA_LONXX = 'R'
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND FBXX.LC_STA_FORXX = 'A'
			AND FBXX.LC_FOR_STA = 'A' --denied records cant have this active
			AND LNXX.LC_FOR_RSP != 'XXX'
	
			AND	CAST(GETDATE() AS DATE) BETWEEN LNXX.LD_FOR_BEG AND LNXX.LD_FOR_END
	) FORB 
		ON FORB.BF_SSN = FSXX.BF_SSN
		AND FORB.LN_SEQ = FSXX.LN_SEQ
	LEFT JOIN
	(
		SELECT 
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			LNXX.LD_FOR_BEG,
			lnXX.LD_FOR_END,
			FBXX.LC_FOR_TYP
		FROM
			CDW..FBXX_BR_FOR_REQ FBXX
			INNER JOIN CDW..LNXX_BR_FOR_APV LNXX
				ON LNXX.BF_SSN = FBXX.BF_SSN
				AND LNXX.LF_FOR_CTL_NUM = FBXX.LF_FOR_CTL_NUM
			INNER JOIN CDW..LNXX_LON LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
				AND LNXX.LA_CUR_PRI > X
				AND LNXX.LC_STA_LONXX = 'R'
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND FBXX.LC_STA_FORXX = 'A'
			AND FBXX.LC_FOR_STA = 'A' --denied records cant have this active
			AND LNXX.LC_FOR_RSP != 'XXX'
			AND LNXX.LD_FOR_BEG > GETDATE()
	) FORBF
		ON FORBF.BF_SSN = FSXX.BF_SSN
		AND FORBF.LN_SEQ = FSXX.LN_SEQ
	LEFT JOIN
	(
		SELECT	
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			LNXX.LD_DFR_BEG,
			lnXX.LD_DFR_END,
			DFXX.LC_DFR_TYP
		FROM
			CDW..DFXX_BR_DFR_REQ DFXX
			INNER JOIN CDW..LNXX_BR_DFR_APV LNXX
				ON LNXX.BF_SSN = DFXX.BF_SSN
				AND LNXX.LF_DFR_CTL_NUM = DFXX.LF_DFR_CTL_NUM
			INNER JOIN CDW..LNXX_LON LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
				AND LNXX.LA_CUR_PRI > X
				AND LNXX.LC_STA_LONXX = 'R'
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND DFXX.LC_STA_DFRXX = 'A'
			AND DFXX.LC_DFR_STA = 'A' --denied records cant have this active
			AND LNXX.LC_DFR_RSP != 'XXX'
			AND	LNXX.LD_DFR_BEG > GETDATE()
	)DEF
		ON DEF.BF_SSN = FSXX.BF_SSN
		AND DEF.LN_SEQ = FSXX.LN_SEQ
where forb.BF_SSN is null
--SELECT 
--SELECT 
--	(FSXX.LF_FED_AWD + LEFT('XX' + CAST(FSXX.LN_FED_AWD_SEQ AS VARCHAR(XX)), X)),
--	* 
--FROM 
--	CDW..FSXX_DL_LON FSXX
--WHERE LF_FED_AWD = 'XXXXXXXXXSXXGXXXXX'