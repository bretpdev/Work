USE UDW
GO

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @SchoolCodes TABLE
(
	SchoolCode CHAR(8),
	SchoolCloseDate DATE
);

INSERT INTO
	@SchoolCodes
VALUES
--OPE ID	Closure Date
('03164300','7/21/2021'),
('01028612','12/3/2020'),
('01028621','11/13/2020'),
('01028623','10/30/2020'),
('01028624','10/30/2020'),
('01028625','10/30/2020'),
('01028629','11/20/2020'),
('01028631','6/1/2020'),
('01028634','10/30/2020'),
('01028635','4/12/2021'),
('01028636','10/30/2020'),
('01028639','10/30/2020'),
('01028640','5/13/2021'),
('00207712','5/12/2021'),
('03032500','6/30/2021'),
('02159602','7/1/2019'),
('02159605','7/1/2019'),
('02159608','8/1/2017'),
('00252168','10/16/2020'),
('00157117','10/1/2020'),
('03237300','6/30/2021'),
('03237301','6/30/2021'),
('01072771','6/26/2021'),
('02567600','6/3/2021'),
('00178400','6/30/2021'),
('01072733','6/26/2021'),
('00234303','12/18/2020'),
('00234319','8/24/2018'),
('00234201','3/13/2020'),
('00234204','3/13/2020'),
('00234205','3/13/2020'),
('00314402','5/10/2021'),
('00392302','1/1/2021'),
('00109011','8/22/2016'),
('00773803','5/7/2021'),
('00252165','7/31/2020'),
('02572014','5/1/2021'),
('00315401','5/9/2091'),
('00315408','5/9/2019'),
('00315410','5/9/2019'),
('00316402','5/12/2021'),
('00357304','8/31/2015'),
('00405729','3/1/2021'),
('00317908','5/10/2019'),
('02572005','3/23/2021'),
('00252111','10/16/2020'),
('00252183','5/14/2021'),
('03164300','7/21/2021'),
('00348307','3/6/2020'),
('00135805','5/10/2018'),
('00252116','10/16/2020'),
('00226104','6/7/2021'),
('00226620','6/21/2021'),
('00757003','4/27/2020'),
('00757004','4/27/2020'),
('01186208','3/10/2021'),
('00117901','5/9/2020'),
('00117903','5/1/2020'),
('03670302','4/17/2021'),
('00380219','6/4/2091'),
('00305124','8/28/2017'),
('10252137','12/20/2019'),
('00252160','4/30/2020')


--select * from @SchoolCodes

/*****************  MODIFIED QUERY  ***********************/
SELECT
	*
FROM
	(
		SELECT DISTINCT
			PD10.DF_SPE_ACC_ID,
			PD10.DM_PRS_1,
			PD10.DM_PRS_MID,
			PD10.DM_PRS_LST,
			PD30.DX_STR_ADR_1,
			PD30.DX_STR_ADR_2,
			PD30.DX_STR_ADR_3,
			PD30.DM_CT,
			PD30.DC_DOM_ST,
			PD30.DF_ZIP_CDE,
			PD30.DI_VLD_ADR,
			LN10.LF_DOE_SCL_ORG,
			SD10.LF_DOE_SCL_ENR_CUR,
			SD10.LD_NTF_SCL_SPR,
			SD10.LC_REA_SCL_SPR,
			SD10.LD_SCL_SPR [LastDayOfEnrollment],
			School.SchoolCloseDate
		FROM
			PD10_PRS_NME PD10
			INNER JOIN PD30_PRS_ADR PD30 
				ON PD30.DF_PRS_ID = PD10.DF_PRS_ID
			INNER JOIN 
			(
				SELECT
					LN10.BF_SSN,
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN LN10_LON LN10 
						ON LN10.LF_DOE_SCL_ORG = SC.SchoolCode

				UNION

				SELECT DISTINCT
					SD10.LF_STU_SSN [BF_SSN],
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN SD10_STU_SPR SD10 
						ON SD10.LF_DOE_SCL_ENR_CUR = SC.SchoolCode
				WHERE
					SD10.LC_STA_STU10 = 'A'
			) School 
				ON School.BF_SSN = PD10.DF_PRS_ID
			INNER JOIN LN10_LON LN10 
				ON LN10.BF_SSN = PD10.DF_PRS_ID
			LEFT JOIN SD10_STU_SPR SD10 
				ON SD10.LF_STU_SSN = PD10.DF_PRS_ID 
				AND SD10.LF_DOE_SCL_ENR_CUR = School.SchoolCode 
				AND SD10.LC_STA_STU10 = 'A'
		WHERE
		--	DATEADD(DAY, 121, SD10.LD_SCL_SPR) > School.SchoolCloseDate
			 LN10.LA_CUR_PRI > 0.00
			AND LN10.LA_LON_AMT_GTR > 0.00
	) X
WHERE
	DATEADD(DAY, 121, ISNULL(X.LastDayOfEnrollment, GETDATE())) > X.SchoolCloseDate
	AND	(
			X.LF_DOE_SCL_ENR_CUR IN (SELECT SchoolCode FROM @SchoolCodes)
			OR	X.LF_DOE_SCL_ORG IN (SELECT SchoolCode FROM @SchoolCodes)
		)
ORDER BY
	X.DF_SPE_ACC_ID

 