USE CDW
GO

DROP TABLE IF EXISTS #POPX
DROP TABLE IF EXISTS #POPX

SELECT * INTO #POPX FROM OPENQUERY(LEGEND_TEST_VUKX,
'
SELECT DISTINCT
	LNXX.BF_SSN
FROM
	PKUB.LNXX_LON LNXX
	INNER JOIN PKUB.PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = LNXX.BF_SSN
	LEFT JOIN
	(
		SELECT
			BF_SSN,
			LN_SEQ,
			LD_LON_X_DSB
		FROM
			PKUB.LNXX_LON
		WHERE
			LD_LON_X_DSB >= ''XX/XX/XXXX''
			AND LA_CUR_PRI > X
			AND LC_STA_LONXX = ''R''
	) DISB
		ON DISB.BF_SSN = LNXX.BF_SSN
	LEFT JOIN
	(
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			LD_END_GRC_PRD
		FROM
			PKUB.LNXX_LON LNXX
			INNER JOIN PKUB.RSXX_BR_RPD RSXX
				ON RSXX.BF_SSN = LNXX.BF_SSN
			INNER JOIN PKUB.LNXX_LON_RPS LNXX
				ON LNXX.BF_SSN = RSXX.BF_SSN
				AND LNXX.LN_RPS_SEQ = RSXX.LN_RPS_SEQ
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
		WHERE
			LD_END_GRC_PRD + X <= ''XX/XX/XXXX''
			AND LA_CUR_PRI > X
			AND LC_STA_LONXX = ''R''
			and LC_STA_RPSTXX = ''A''
	) AF
		ON AF.BF_SSN = LNXX.BF_SSN
WHERE
	AF.BF_SSN IS NOT NULL 
	OR DISB.BF_SSN IS NOT NULL
')

USE CDW
GO

SELECT * INTO #POPX FROM  OPENQUERY(LEGEND_TEST_VUKX,
'
SELECT DISTINCT
	LNXX.BF_SSN
FROM
	PKUB.LNXX_LON LNXX
	INNER JOIN PKUB.PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = LNXX.BF_SSN
	INNER JOIN
	(
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			LD_LON_X_DSB
		FROM
			PKUB.LNXX_LON LNXX
			INNER JOIN PKUB.RSXX_BR_RPD RSXX
				ON RSXX.BF_SSN = LNXX.BF_SSN
			INNER JOIN PKUB.LNXX_LON_RPS LNXX
				ON LNXX.BF_SSN = RSXX.BF_SSN
				AND LNXX.LN_RPS_SEQ = RSXX.LN_RPS_SEQ
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
			--INNER JOIN PKUB.DWXX_DW_CLC_CLU DWXX
			--	ON DWXX.BF_SSN = LNXX.BF_SSN
			--	AND DWXX.LN_SEQ = LNXX.LN_SEQ
			--	AND DWXX.WC_DW_LON_STA != ''XX''
		WHERE
			LD_LON_X_DSB <= ''XX/XX/XXXX''
			AND LA_CUR_PRI > X
			AND LC_STA_LONXX = ''R''
	) DISB
		ON DISB.BF_SSN = LNXX.BF_SSN
	INNER JOIN
	(
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			LD_END_GRC_PRD
		FROM
			PKUB.LNXX_LON LNXX
			INNER JOIN PKUB.RSXX_BR_RPD RSXX
				ON RSXX.BF_SSN = LNXX.BF_SSN
			INNER JOIN PKUB.LNXX_LON_RPS LNXX
				ON LNXX.BF_SSN = RSXX.BF_SSN
				AND LNXX.LN_RPS_SEQ = RSXX.LN_RPS_SEQ
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
			--INNER JOIN PKUB.DWXX_DW_CLC_CLU DWXX
			--	ON DWXX.BF_SSN = LNXX.BF_SSN
			--	AND DWXX.LN_SEQ = LNXX.LN_SEQ
			--	AND DWXX.WC_DW_LON_STA != ''XX''
		WHERE
			LD_END_GRC_PRD + X >= ''XX/XX/XXXX''
			AND LA_CUR_PRI > X
			AND LC_STA_LONXX = ''R''
			
	) AF
		ON AF.BF_SSN = LNXX.BF_SSN

')

SELECT * FROM #POPX PX INNER JOIN #POPX PX ON PX.BF_SSN = PX.BF_SSN
