--Assigning to JR you will want to use PD30 and LN90 for Compass and PD03 and DC11 for OneLink.  Please talk with David if you need guidance on DC11
--Total and Separate by year

/*************************************************
	COMPASS:
*************************************************/
SELECT DISTINCT
	 LN90.BF_SSN
	,CASE
		WHEN DATEPART(YEAR,LN90.LD_FAT_EFF) = 2017
		THEN '2017'
		WHEN DATEPART(YEAR,LN90.LD_FAT_EFF) = 2018
		THEN '2018'
		ELSE 'ERROR'
	END AS [YEAR]
	,SUM(
		COALESCE(LN90.LA_FAT_PCL_FEE,0) + 
		COALESCE(LN90.LA_FAT_NSI,0) + 
		COALESCE(LN90.LA_FAT_LTE_FEE,0) + 
		COALESCE(LN90.LA_FAT_ILG_PRI,0) + 
		COALESCE(LN90.LA_FAT_CUR_PRI,0)
	) AS PAYMENT
	,LN90.PC_FAT_TYP
	,LN90.PC_FAT_SUB_TYP
	,LN90.LC_STA_LON90
	,PD30.DI_VLD_ADR
	,PD30.DC_DOM_ST
INTO
	#COMPASS
FROM
	UDW..LN90_FIN_ATY LN90
	INNER JOIN UDW..PD30_PRS_ADR PD30
		ON LN90.BF_SSN = PD30.DF_PRS_ID
WHERE
	DATEPART(YEAR,LN90.LD_FAT_EFF) IN (2017,2018)
	AND LN90.LC_STA_LON90 = 'A'
	AND LN90.PC_FAT_TYP = '10'
	AND PD30.DI_VLD_ADR = 'Y'
	AND PD30.DC_DOM_ST = 'WA'
GROUP BY
	 LN90.BF_SSN
	,DATEPART(YEAR,LN90.LD_FAT_EFF)
	,LN90.PC_FAT_TYP
	,LN90.PC_FAT_SUB_TYP
	,LN90.LC_STA_LON90
	,PD30.DI_VLD_ADR
	,PD30.DC_DOM_ST
;

--details tab
SELECT DISTINCT
	*
FROM 
	#COMPASS 
ORDER BY
	 BF_SSN
	,[YEAR]
;

--payment type by year tab
SELECT DISTINCT
	'COMPASS' AS [SYSTEM]
	,[YEAR]
	,PC_FAT_TYP
	,PC_FAT_SUB_TYP
	,SUM(PAYMENT) AS PAYMENT
FROM
	#COMPASS
GROUP BY
	[YEAR]
	,PC_FAT_TYP
	,PC_FAT_SUB_TYP
ORDER BY
	[YEAR]
	,PC_FAT_TYP
	,PC_FAT_SUB_TYP
;

/*************************************************
	ONELINK:
*************************************************/

SELECT DISTINCT
	*,
	CASE
		WHEN DATEPART(YEAR,[DATE]) = 2017
		THEN '2017'
		WHEN DATEPART(YEAR,[DATE]) = 2018
		THEN '2018'
		ELSE 'ERROR'
	END AS [YEAR]
INTO
	#ONELINK
FROM
	OPENQUERY 
	(
		DUSTER,
		'
			SELECT DISTINCT
				PD01.DF_PRS_ID
				,DC11.LA_TRX AS AMOUNT
				,DC11.LC_TRX_SRC
				,DC11.LC_TRX_TYP
				,DC11.LC_RCI_TYP
				,DC11.BD_TRX_PST_HST AS DATE
				,PD03.DI_VLD_ADR
				,PD03.DC_DOM_ST
			FROM
				OLWHRM1.GA01_APP GA01
				INNER JOIN OLWHRM1.GA10_LON_APP GA10
					ON GA01.AF_APL_ID = GA10.AF_APL_ID
				INNER JOIN OLWHRM1.DC01_LON_CLM_INF DC01
					ON GA01.AF_APL_ID = DC01.AF_APL_ID
					AND GA10.AF_APL_ID_SFX = DC01.AF_APL_ID_SFX
				INNER JOIN OLWHRM1.DC11_LON_FAT DC11
					ON DC01.AF_APL_ID = DC11.AF_APL_ID
					AND DC01.AF_APL_ID_SFX = DC11.AF_APL_ID_SFX
				INNER JOIN OLWHRM1.PD01_PDM_INF PD01
					ON GA01.DF_PRS_ID_BR = PD01.DF_PRS_ID
				INNER JOIN OLWHRM1.PD03_PRS_ADR_PHN PD03
					ON PD01.DF_PRS_ID = PD03.DF_PRS_ID
			WHERE
				PD03.DI_VLD_ADR = ''Y''
				AND PD03.DC_DOM_ST = ''WA''
				AND DC11.LC_TRX_TYP = ''BR''
				AND YEAR(DC11.BD_TRX_PST_HST) IN (2017,2018)
		') 
;

--select * from #ONELINK

--details tab
SELECT
	 DF_PRS_ID
	,[YEAR]
	,LC_TRX_SRC
	,LC_TRX_TYP
	,LC_RCI_TYP
	,DI_VLD_ADR
	,DC_DOM_ST
	,SUM(AMOUNT) AS AMOUNT
FROM 
	#ONELINK
GROUP BY
	 DF_PRS_ID
	,[YEAR]
	,LC_TRX_SRC
	,LC_TRX_TYP
	,LC_RCI_TYP
	,DI_VLD_ADR
	,DC_DOM_ST
ORDER BY
	DF_PRS_ID
	,[YEAR]
;

--payment type by year tab
SELECT
	'ONELINK' AS [SYSTEM]
	,[YEAR]
	,LC_RCI_TYP
	,SUM(AMOUNT) AS AMOUNT
FROM
	#ONELINK
GROUP BY
	 [YEAR]
	,LC_RCI_TYP
ORDER BY
	 [YEAR]
	,LC_RCI_TYP
;
