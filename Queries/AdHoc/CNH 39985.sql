USE CDW
GO
SELECT DISTINCT
	WQXX.WF_QUE,
	WQXX.WF_SUB_QUE,
	WQXX.WN_CTL_TSK,
	WQXX.BF_SSN,
	WQXX.WF_CRT_DTS_WQXX AS TASK_CREATE_DATE,
	LNXX.LA_CUR_PRI,
	CASE WHEN PDXX.DF_PRS_ID IS NULL THEN 'NO' ELSE 'YES' END AS HAS_VALID_ADDRESS,
	CASE WHEN P.DF_PRS_ID IS NULL THEN 'NO' ELSE 'YES' END AS HAS_VALID_PHONE
FROM
	CDW..WQXX_TSK_QUE WQXX
	INNER JOIN 
	(
		SELECT
			LNXX.BF_SSN,
			SUM(LNXX.LA_CUR_PRI) AS LA_CUR_PRI
		FROM
			CDW..LNXX_LON LNXX
		WHERE
			LC_STA_LONXX = 'R'
		GROUP BY
			BF_SSN
	) LNXX
		ON LNXX.BF_SSN = WQXX.BF_SSN
	LEFT JOIN CDW..PDXX_PRS_ADR PDXX
		ON PDXX.DF_PRS_ID = WQXX.BF_SSN
		AND PDXX.DC_ADR = 'L'
	LEFT JOIN CDW..PDXX_PRS_PHN PDXX	
		ON PDXX.DF_PRS_ID = WQXX.BF_SSN
	left join
		(
			SELECT DISTINCT
				PDXX.DF_PRS_ID,
				COALESCE(PDXX.DN_DOM_PHN_ARA,'') AS ARA,
				COALESCE(PDXX.DN_DOM_PHN_XCH,'') + COALESCE(PDXX.DN_DOM_PHN_LCL,'') AS PHN,
				PDXX.DC_PHN,
				DENSE_RANK() OVER (PARTITION BY PDXX.DF_PRS_ID ORDER BY Ranks.TypeRank) AS OverallRank /*Rank phones by type*/
			FROM
				CDW..PDXX_PRS_PHN PDXX
				INNER JOIN
				(
					SELECT
						*,
						CASE WHEN DC_PHN = 'H' THEN X
							 WHEN DC_PHN = 'A' THEN X
							 WHEN DC_PHN = 'W' THEN X
						END AS TypeRank
					FROM
						CDW..PDXX_PRS_PHN PDXX
					WHERE
						PDXX.DI_PHN_VLD = 'Y'
						AND PDXX.DC_NO_HME_PHN != 'J'
						AND PDXX.DC_ALW_ADL_PHN = 'P'
						AND PDXX.DC_PHN IN ('H','A','W')
						AND COALESCE(PDXX.DN_DOM_PHN_ARA,'') + COALESCE(PDXX.DN_DOM_PHN_XCH,'') + COALESCE(PDXX.DN_DOM_PHN_LCL,'') != ''
				) Ranks
					ON Ranks.DF_PRS_ID = PDXX.DF_PRS_ID
					AND Ranks.DC_PHN = PDXX.DC_PHN
			WHERE
				PDXX.DI_PHN_VLD = 'Y'
				AND PDXX.DC_NO_HME_PHN != 'J'
				AND PDXX.DC_ALW_ADL_PHN = 'P'
				AND PDXX.DC_PHN IN ('H','A','W')
				AND COALESCE(PDXX.DN_DOM_PHN_ARA,'') + COALESCE(PDXX.DN_DOM_PHN_XCH,'') + COALESCE(PDXX.DN_DOM_PHN_LCL,'') != ''
		) P
			ON P.DF_PRS_ID = WQXX.BF_SSN

WHERE
	WF_QUE = 'II'