/*CREATE LIBNAME FOR REMOTE SERVER'S WORK FOLDER*/
LIBNAME WORKLOCL REMOTE SERVER=LEGEND SLIBREF=WORK;

/*CREATE FILENAME FOR OUTPUT*/
%LET RPTLIB = T:\SAS;
FILENAME REPORTX "&RPTLIB/CNH_XXXXX.XLSX"; /*TODO: update the outfile name*/

/*CREATE LIBRARY OF EXCEL DATA*/
LIBNAME XLIB XLSX 'T:\trigger BL - Cornerstone.xlsx'; /*TODO: update the infile name*/

/*CREATE DATA SET FROM A SPECIFIC SHEET IN THE EXCEL FILE*/
DATA XLDATA; SET XLIB.SHEETX; RUN; /*TODO: update the sheet name*/


DATA WORKLOCL.XDATA; SET XLDATA; RUN;

/*SUBMIT CODE TO REMOTE SERVER*/
RSUBMIT LEGEND;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;
LIBNAME AES DBX DATABASE=DNFPUTDL OWNER=AES;
%let DB = DNFPUTDL;
%let OWNR = PKUB;

PROC SQL STIMER;
	CONNECT TO DBX (DATABASE=&DB); 

/*TODO: update SQL below*/
/*	GET DATA FOR ALL LOANS*/
	CREATE TABLE JOINDATA AS
		SELECT DISTINCT
			XDAT.BF_SSN
			,XDAT.LN_SEQ
			,DBXD.WN_SEQ_GRXX
			,DBXD.WC_NDS_IDR_PGS_RPT

		FROM 
			CONNECTION TO DBX 
			(
				SELECT DISTINCT 
					GRXX.BF_SSN
					,GRXX.LN_SEQ
					,GRXX.WN_SEQ_GRXX
					,GRXX.WC_NDS_IDR_PGS_RPT
				FROM 
					&OWNR..GRXX_RPT_LON_APL GRXX
		
				FOR READ ONLY WITH UR
			) DBXD
			INNER JOIN XDATA XDAT
				ON DBXD.BF_SSN = XDAT.BF_SSN
				AND DBXD.LN_SEQ = XDAT.LN_SEQ
	;
	DISCONNECT FROM DBX;


QUIT;

ENDRSUBMIT;

/*COPY JOINED DATA TO WORK*/
DATA JOINDATA; SET WORKLOCL.JOINDATA; RUN;

/*EXPORT JOINED DATA TO A REPORT*/
PROC EXPORT DATA= WORK.JOINDATA
	OUTFILE= REPORTX 
	REPLACE
	DBMS=XLSX;
RUN;
