--TOTAL NUMBER OF BORROWERS ON IDR
DROP TABLE IF EXISTS #QX, #QX

SELECT DISTINCT
	COUNT(DISTINCT RS.BF_SSN)
FROM
	CDW.calc.RepaymentSchedules RS
	INNER JOIN CDW..RSXX_IBR_RPS RSXX
		ON RSXX.BF_SSN = RS.BF_SSN
WHERE
	RS.CurrentGradation = X
	AND RS.LA_CUR_PRI > X
	AND RSXX.BC_STA_RSXX = 'A'
	AND RS.LC_TYP_SCH_DIS IN ('AG','CA','CP','CQ','CX','CX','CX','IA','IB','IL','IP','IX','IX')

--NUMBER OF BORROWER WITH A X PAYMENT
	SELECT DISTINCT
		RS.BF_SSN
	INTO #QX
	FROM
		CDW.calc.RepaymentSchedules RS
		INNER JOIN CDW..RSXX_IBR_RPS RSXX
			ON RSXX.BF_SSN = RS.BF_SSN
	WHERE
		RS.CurrentGradation = X
		AND RS.LA_CUR_PRI > X
		AND RSXX.BC_STA_RSXX = 'A'
		AND RS.LA_RPS_ISL = X.XX
		AND RS.LC_TYP_SCH_DIS IN ('AG','CA','CP','CQ','CX','CX','CX','IA','IB','IL','IP','IX','IX')
	GROUP BY
		RS.BF_SSN
	HAVING 
		SUM(RS.LA_RPS_ISL) = X.XX

SELECT
	COUNT(DISTINCT BF_SSN)
FROM
	#QX

--NUMBER OF BORROWER FROM QX WHERE THE BORROWER SELF CERTIFIED OR SENT IN A PAPER APP
SELECT
	*
INTO #QX
FROM
(
	SELECT DISTINCT
		Q.*
	FROM
		#QX Q
		INNER JOIN CDW..RSXX_IBR_RPS RSXX
		ON Q.BF_SSN = RSXX.BF_SSN
	WHERE
		RSXX.BC_STA_RSXX = 'A'
		AND RSXX.BC_IBR_INF_SRC_VER = 'ALT'

	UNION ALL

	SELECT DISTINCT
		MAPP.SSN
	FROM
		Income_Driven_Repayment..Applications A
		
		INNER JOIN 
		(
			SELECT
				MAX(A.application_id) AS application_id,
				B.SSN
			FROM
				Income_Driven_Repayment..Applications A
				INNER JOIN Income_Driven_Repayment..Loans L
					ON L.application_id = A.application_id
				INNER JOIN Income_Driven_Repayment..Borrowers B
					ON B.borrower_id = L.borrower_id
			GROUP BY
				B.SSN
		
		) MAPP
			ON MAPP.application_id = A.application_id
		INNER JOIN #QX Q
			ON Q.BF_SSN = MAPP.SSN
	WHERE
		A.application_source_id = X
) P

select top XXXX * from #qX

SELECT
	COUNT(DISTINCT BF_SSN)
FROM
	#QX

SELECT
	COUNT(DISTINCT Q.BF_SSN)
FROM
	#QX Q
	INNER JOIN CDW..RSXX_IBR_RPS RSXX
		ON Q.BF_SSN = RSXX.BF_SSN
	WHERE
		RSXX.BC_STA_RSXX = 'A'
		AND RSXX.BA_AGI = X

SELECT
	COUNT(DISTINCT Q.BF_SSN)
FROM
	#QX Q
	INNER JOIN CDW..RSXX_IBR_RPS RSXX
		ON Q.BF_SSN = RSXX.BF_SSN
	WHERE
		RSXX.BC_STA_RSXX = 'A'
		AND RSXX.BA_AGI != X

SELECT
	COUNT(DISTINCT RSXX.BF_SSN)
FROM
	CDW..RSXX_IBR_RPS RSXX
	INNER JOIN
	(
		SELECT DISTINCT
			RS.BF_SSN
		FROM
			CDW.calc.RepaymentSchedules RS
			INNER JOIN CDW..RSXX_IBR_RPS RSXX
				ON RSXX.BF_SSN = RS.BF_SSN
		WHERE
			RS.CurrentGradation = X
			AND RS.LA_CUR_PRI > X
			AND RSXX.BC_STA_RSXX = 'A'
			AND RS.LC_TYP_SCH_DIS IN ('AG','CA','CP','CQ','CX','CX','CX','IA','IB','IL','IP','IX','IX')
	) IDR
		ON IDR.BF_SSN = RSXX.BF_SSN
WHERE
		RSXX.BC_STA_RSXX = 'A'
		AND RSXX.BN_MEM_HSE_HLD > XX