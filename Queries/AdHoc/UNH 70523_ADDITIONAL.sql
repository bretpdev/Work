DROP TABLE IF EXISTS #COMPASS
SELECT
*
INTO #COMPASS
FROM
(
SELECT DISTINCT
	PD10.DF_PRS_ID,
	PD10.DF_SPE_ACC_ID,
	LN10.LN_SEQ,
	LN10.LA_CUR_PRI
FROM
	UDW..PD30_PRS_ADR PD30
	INNER JOIN UDW..PD10_PRS_NME PD10
		ON PD10.DF_PRS_ID = PD30.DF_PRS_ID
	INNER JOIN [AuditUDW].[dbo].[LN10_LON_Dec2020] LN10
		ON LN10.BF_SSN = PD30.DF_PRS_ID
WHERE
	DC_DOM_ST = 'RI'
	AND DC_ADR = 'L'
	AND DD_VER_ADR <= '12/31/2020'
	AND DI_VLD_ADR = 'Y'
	AND LN10.LA_CUR_PRI > 0
	AND LN10.LC_STA_LON10 = 'R'

UNION

SELECT DISTINCT
	PD31.DF_PRS_ID,
	PD10.DF_SPE_ACC_ID,
	LN10.LN_SEQ,
	LN10.LA_CUR_PRI
FROM
	UDW..PD31_PRS_INA PD31
	INNER JOIN UDW..PD10_PRS_NME PD10
		ON PD10.DF_PRS_ID = PD31.DF_PRS_ID
	INNER JOIN [AuditUDW].[dbo].[LN10_LON_Dec2020] LN10
		ON LN10.BF_SSN = PD31.DF_PRS_ID
	INNER JOIN
	(
		SELECT
			DF_PRS_ID,
			MAX(DN_ADR_SEQ) AS DN_ADR_SEQ
		FROM
			UDW..PD31_PRS_INA
		WHERE
			DD_VER_ADR_HST <= '12/31/2020'
			AND DC_ADR_HST = 'L'
		GROUP BY
			DF_PRS_ID
	) MPD31
		ON MPD31.DF_PRS_ID = PD31.DF_PRS_ID
		AND MPD31.DN_ADR_SEQ = PD31.DN_ADR_SEQ
WHERE
	DC_DOM_ST_HST = 'RI'
	AND LN10.LA_CUR_PRI > 0
	AND LN10.LC_STA_LON10 = 'R'
) P

DROP TABLE IF EXISTS #CREDIT

SELECT DISTINCT
C.DF_SPE_ACC_ID,
LN41.BF_SSN,
LN41.LN_SEQ,
C.LA_CUR_PRI
INTO #CREDIT
FROM
	#COMPASS C
	INNER JOIN UDW..LN41_LON_CRB_RPT LN41
		ON LN41.BF_SSN = C.DF_PRS_ID
		AND LN41.LN_SEQ = C.LN_SEQ
WHERE
	LN41.LC_RPT_STA_CRB IN ('71','80','82','83','84','88', '78')
	AND YEAR(LN41.LD_RPT_CRB) = 2020

SELECT
'NEG CREDIT RPT',
COUNT(DISTINCT BF_SSN) AS BORROWER_COUNT,
COUNT(*) AS LOAN_COUNT,
SUM(LA_CUR_PRI) AS TOTAL_PRINCIPAL
FROM
#CREDIT

SELECT DISTINCT
C.DF_SPE_ACC_ID
FROM
	#CREDIT C
	INNER JOIN UDW..AY10_BR_LON_ATY AY10
		ON AY10.BF_SSN = C.BF_SSN
		AND YEAR(AY10.LD_ATY_REQ_RCV) = 2020
		AND AY10.LC_STA_ACTY10 = 'A'
		AND AY10.PF_REQ_ACT = 'CRDSP'

SELECT
	'IN FORB IN 2020',
COUNT(DISTINCT BF_SSN) AS BORROWER_COUNT,
COUNT(*) AS LOAN_COUNT,
SUM(LA_CUR_PRI) AS TOTAL_PRINCIPAL
FROM
	#COMPASS C
	INNER JOIN 
	(
	SELECT DISTINCT 	
		LN60.BF_SSN,
		LN60.LN_SEQ
	FROM
		FB10_BR_FOR_REQ FB10
		INNER JOIN LN60_BR_FOR_APV LN60
			ON LN60.BF_SSN = FB10.BF_SSN
			AND LN60.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM
	WHERE
		LN60.LC_STA_LON60 = 'A'
		AND FB10.LC_STA_FOR10 = 'A'
		AND FB10.LC_FOR_STA = 'A' 
		AND
		(
			YEAR(LD_FOR_BEG) = 2020
		)
	) FORB
		ON FORB.BF_SSN = C.DF_PRS_ID	
		AND FORB.LN_SEQ = C.LN_SEQ

SELECT
	'FORB ENDED IN 2020',
COUNT(DISTINCT BF_SSN) AS BORROWER_COUNT,
COUNT(*) AS LOAN_COUNT,
SUM(LA_CUR_PRI) AS TOTAL_PRINCIPAL
FROM
	#COMPASS C
	INNER JOIN 
	(
	SELECT DISTINCT 	
		LN60.BF_SSN,
		LN60.LN_SEQ
	FROM
		FB10_BR_FOR_REQ FB10
		INNER JOIN LN60_BR_FOR_APV LN60
			ON LN60.BF_SSN = FB10.BF_SSN
			AND LN60.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM
	WHERE
		LN60.LC_STA_LON60 = 'A'
		AND FB10.LC_STA_FOR10 = 'A'
		AND FB10.LC_FOR_STA = 'A' 
		AND
		(
			
			YEAR(LD_FOR_END) = 2020
		)
	) FORB
		ON FORB.BF_SSN = C.DF_PRS_ID	
		AND FORB.LN_SEQ = C.LN_SEQ