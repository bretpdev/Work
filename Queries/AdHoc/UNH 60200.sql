USE UDW
GO

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @SchoolCodes TABLE
(
	SchoolCode CHAR(8),
	SchoolCloseDate DATE
);

INSERT INTO
	@SchoolCodes
VALUES
--OPE ID	Closure Date
 ('00940700','12/20/2018')
,('03965350','5/20/2018	')
,('02075700','12/18/2018')
,('00835000','12/14/2018')
,('00835001','12/14/2018')
,('00835002','12/31/2013')
,('00224373','8/5/2018	')
,('01204700','6/7/2002	')
,('00927002','12/14/2018')
,('02179918','12/14/2018')
,('01019500','12/14/2018')
,('01019501','12/14/2018')
,('03173301','5/24/2018	')
,('00292318','7/1/2018	')
,('00292911','5/10/2013	')
,('00292923','5/9/2014	')
,('00292926','5/10/2013	')
,('00887808','12/14/2018')
,('00887809','12/14/2018')
,('00296201','7/1/2018	')
,('00296203','7/1/2018	')
,('00296206','7/1/2018	')
,('00296208','7/1/2018	')
,('00927004','12/14/2018')
,('02179921','12/14/2018')
,('10914525','12/11/2018')
,('10914532','12/11/2018')
,('01258400','12/14/2018')
,('01258401','12/14/2018')
,('01258403','3/31/2015	')
,('00174604','9/22/2018	')
,('00174614','9/22/2018	')
,('04051304','12/14/2018')
,('00405715','4/22/2018	')
,('00405717','4/22/2018	')
,('00405727','4/22/2018	')
,('10224301','10/26/2018')
,('00405701','11/30/2018')
,('02581100','12/31/2018')
,('00355716','4/21/2008	')
,('00355723','1/8/2019	')
,('00355724','4/30/2013	')
,('00355728','11/15/2009')
,('00355729','11/15/2009')
,('00355730','7/23/2009	')
,('00355732','1/8/2019	')
,('00355734','8/1/2013	')
,('00355735','4/30/2013	')
,('00355737','4/30/2013	')
,('00355739','11/15/2009')
,('00355774','12/19/2012')
,('00355776','12/19/2012')
,('00355777','7/12/2017	')
,('00355778','7/21/2011	')
,('00355780','5/7/2018	')
,('00355781','12/13/2011')
,('00355782','4/25/2013	')
,('00355788','7/1/2017	')
,('00355789','7/1/2017	')
,('00355790','12/18/2012')
,('00355792','12/11/2012')
,('00405739','5/20/2018	')
,('04177800','12/28/2018')
,('00703214','12/31/2018')
,('00703216','4/26/2016	')
,('00405719','11/30/2018')
,('02179914','12/14/2018')
,('00927003','12/14/2018')
,('02179930','12/14/2018')
,('02078900','12/14/2018')
,('02078904','12/14/2018')
,('00226626','4/23/2018	')
,('00226628','2/23/2016	')
,('00226634','4/30/2012	')
,('00226639','12/11/2012')
,('00226642','4/24/2018	')
,('00226643','12/10/2013')
,('01258405','12/14/2018')
,('00233018','6/27/2018	')
,('00233019','4/30/2016	')
,('04051346','12/14/2018')
,('00108231','12/31/2017')
,('03359300','12/31/2018')
,('02179929','12/14/2018')
,('02179932','12/14/2018')
,('02179943','12/14/2018')
,('02179944','12/14/2018')
,('02179945','12/14/2018')
,('02179948','12/14/2018')
,('00115608','1/29/2019	')
,('00781900','12/14/2018')
,('00781902','12/14/2018')
,('00781903','12/14/2018')
,('02069300','10/30/2018')
,('02069305','10/30/2018')
,('02069306','10/28/2018')
,('02069304','6/10/2018 ')
;
--select * from @SchoolCodes



/**** UNH 23008 query **/

--SELECT DISTINCT
--	LN10.BF_SSN,
--	LN10.LN_SEQ,
--	LN10.LF_DOE_SCL_ORG
--FROM
--	LN10_LON LN10
--WHERE
--	LN10.LF_DOE_SCL_ORG IN (SELECT SchoolCode FROM @SchoolCodes)
--;


/*****************  MODIFIED QUERY  ***********************/
SELECT
	*
FROM
	(
		SELECT DISTINCT
			PD10.DF_SPE_ACC_ID,
			PD10.DM_PRS_1,
			PD10.DM_PRS_MID,
			PD10.DM_PRS_LST,
			PD30.DX_STR_ADR_1,
			PD30.DX_STR_ADR_2,
			PD30.DX_STR_ADR_3,
			PD30.DM_CT,
			PD30.DC_DOM_ST,
			PD30.DF_ZIP_CDE,
			PD30.DI_VLD_ADR,
			LN10.LF_DOE_SCL_ORG,
			SD10.LF_DOE_SCL_ENR_CUR,
			SD10.LC_REA_SCL_SPR,
			SD10.LD_NTF_SCL_SPR,
			SD10.LD_SCL_SPR [LastDayOfEnrollment],
			School.SchoolCloseDate
		FROM
			PD10_PRS_NME PD10
			INNER JOIN PD30_PRS_ADR PD30 
				ON PD30.DF_PRS_ID = PD10.DF_PRS_ID
			INNER JOIN 
			(
				SELECT
					LN10.BF_SSN,
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN LN10_LON LN10 
						ON LN10.LF_DOE_SCL_ORG = SC.SchoolCode

				UNION

				SELECT DISTINCT
					SD10.LF_STU_SSN [BF_SSN],
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN SD10_STU_SPR SD10 
						ON SD10.LF_DOE_SCL_ENR_CUR = SC.SchoolCode
				WHERE
					SD10.LC_STA_STU10 = 'A'
			) School 
				ON School.BF_SSN = PD10.DF_PRS_ID
			INNER JOIN LN10_LON LN10 
				ON LN10.BF_SSN = PD10.DF_PRS_ID
			LEFT JOIN SD10_STU_SPR SD10 
				ON SD10.LF_STU_SSN = PD10.DF_PRS_ID 
				AND SD10.LF_DOE_SCL_ENR_CUR = School.SchoolCode 
				AND SD10.LC_STA_STU10 = 'A'
		WHERE
			DATEADD(DAY, 121, SD10.LD_SCL_SPR) > School.SchoolCloseDate
			--AND LN10.LA_CUR_PRI > 0.00
			--AND LN10.LA_LON_AMT_GTR > 0.00
	) X
WHERE
	DATEADD(DAY, 121, ISNULL(X.LastDayOfEnrollment, GETDATE())) > X.SchoolCloseDate
	AND	(
			X.LF_DOE_SCL_ENR_CUR IN (SELECT SchoolCode FROM @SchoolCodes)
			OR	X.LF_DOE_SCL_ORG IN (SELECT SchoolCode FROM @SchoolCodes)
		)
ORDER BY
	X.DF_SPE_ACC_ID
;

