--Oct 9, 2019 through May 31, 2020
DROP TABLE IF EXISTS #NYAccounts;

SELECT DISTINCT
	LN10.BF_SSN,
	LN10.LN_SEQ
INTO 
	#NYAccounts
FROM
	UDW..PD30_PRS_ADR PD30
	INNER JOIN UDW..PD10_PRS_NME PD10
		ON PD30.DF_PRS_ID = PD10.DF_PRS_ID
	INNER JOIN AuditUDW..LN10_LON_May2020 LN10
		ON LN10.BF_SSN = PD10.DF_PRS_ID
WHERE
	PD30.DC_ADR = 'L'
	AND PD30.DC_DOM_ST = 'NY'
	AND CAST(PD30.DF_LST_DTS_PD30 AS DATE) <= CAST('2020-05-31' AS DATE)
	AND LN10.LC_STA_LON10 = 'R'
	AND LN10.LA_CUR_PRI > 0.00

UNION ALL

SELECT DISTINCT
	LN10.BF_SSN,
	LN10.LN_SEQ
FROM
	UDW..PD31_PRS_INA PD31
	INNER JOIN UDW..PD10_PRS_NME PD10
		ON PD31.DF_PRS_ID = PD10.DF_PRS_ID
	INNER JOIN AuditUDW..LN10_LON_May2020 LN10
		ON LN10.BF_SSN = PD10.DF_PRS_ID
WHERE
	PD31.DC_ADR_HST = 'L'
	AND PD31.DC_DOM_ST_HST = 'NY'
	AND CAST(PD31.DD_CRT_PD31 AS DATE) BETWEEN CAST('2019-10-09' AS DATE) AND CAST('2020-05-31' AS DATE)
	AND LN10.LC_STA_LON10 = 'R'
	AND LN10.LA_CUR_PRI > 0.00 
--Table 3: 1 Totals


SELECT
	COUNT(DISTINCT LN10.BF_SSN) AS TotalUnduplicatedBorrowers,
	COUNT(DISTINCT LN10.BF_SSN) AS TotalAccounts,
	SUM(ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00)) AS TotalLoanVolume,
	CAST(SUM(ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00)) AS money) / CAST(COUNT(*) AS money) AS MedianLoanAmount
FROM
	#NYAccounts NYA
	INNER JOIN AuditUDW..LN10_LON_May2020 LN10
		ON LN10.BF_SSN = NYA.BF_SSN
		AND LN10.LN_SEQ = NYA.LN_SEQ
	INNER JOIN AuditUDW..DW01_DW_CLC_CLU_May2020 DW01
		ON DW01.BF_SSN = LN10.BF_SSN
		AND DW01.LN_SEQ = LN10.LN_SEQ
WHERE
	LN10.LC_STA_LON10 = 'R'
	AND LN10.LA_CUR_PRI > 0.00

--Table 3: 2 Loan Type
SELECT
	CASE WHEN LN10.IC_LON_PGM = 'CNSLDN' THEN 'Consolidation (Non-Parent)'
		 WHEN LN10.IC_LON_PGM = 'COMPLT' THEN 'Other'
		 WHEN LN10.IC_LON_PGM = 'PLUS' THEN 'Parent PLUS'
		 WHEN LN10.IC_LON_PGM = 'PLUSGB' THEN 'Grad PLUS'
		 WHEN LN10.IC_LON_PGM = 'SLS' THEN 'Other'
		 WHEN LN10.IC_LON_PGM = 'STFFRD' THEN 'Stafford Subsidized (Undergraduate)'
		 WHEN LN10.IC_LON_PGM = 'SUBCNS' THEN 'Consolidation (Non-Parent)'
		 WHEN LN10.IC_LON_PGM = 'SUBSPC' THEN 'Consolidation (Non-Parent)'
		 WHEN LN10.IC_LON_PGM = 'TILP' THEN 'Other'
		 WHEN LN10.IC_LON_PGM = 'UNCNS' THEN 'Consolidation (Non-Parent)'
		 WHEN LN10.IC_LON_PGM = 'UNSPC' THEN 'Consolidation (Non-Parent)'
		 WHEN LN10.IC_LON_PGM = 'UNSTFD' THEN 'Stafford Unsubsidized (Undergraduate)'
	END AS LoanType,
	COUNT(1) AS Number
FROM
	#NYAccounts NYA
	INNER JOIN AuditUDW..LN10_LON_May2020 LN10
		ON LN10.BF_SSN = NYA.BF_SSN
		AND LN10.LN_SEQ = NYA.LN_SEQ
WHERE
	LN10.LC_STA_LON10 = 'R'
	AND LN10.LA_CUR_PRI > 0.00
GROUP BY
	CASE WHEN LN10.IC_LON_PGM = 'CNSLDN' THEN 'Consolidation (Non-Parent)'
		 WHEN LN10.IC_LON_PGM = 'COMPLT' THEN 'Other'
		 WHEN LN10.IC_LON_PGM = 'PLUS' THEN 'Parent PLUS'
		 WHEN LN10.IC_LON_PGM = 'PLUSGB' THEN 'Grad PLUS'
		 WHEN LN10.IC_LON_PGM = 'SLS' THEN 'Other'
		 WHEN LN10.IC_LON_PGM = 'STFFRD' THEN 'Stafford Subsidized (Undergraduate)'
		 WHEN LN10.IC_LON_PGM = 'SUBCNS' THEN 'Consolidation (Non-Parent)'
		 WHEN LN10.IC_LON_PGM = 'SUBSPC' THEN 'Consolidation (Non-Parent)'
		 WHEN LN10.IC_LON_PGM = 'TILP' THEN 'Other'
		 WHEN LN10.IC_LON_PGM = 'UNCNS' THEN 'Consolidation (Non-Parent)'
		 WHEN LN10.IC_LON_PGM = 'UNSPC' THEN 'Consolidation (Non-Parent)'
		 WHEN LN10.IC_LON_PGM = 'UNSTFD' THEN 'Stafford Unsubsidized (Undergraduate)'
	END

--Table 3: 3 Loan Status
SELECT
	/*In school*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '02' THEN 1 ELSE 0 END)  AS InSchoolNumber,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '02' THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS InSchoolDollar,
	/*In grace*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '01' THEN 1 ELSE 0 END)  AS InGraceNumber,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '01' THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS InGraceDollar,
	/*In repayment*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' THEN 1 ELSE 0 END)  AS InRepaymentNumber,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS InRepaymentDollar,
	/*current*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' AND LN16.BF_SSN IS NULL THEN 1 ELSE 0 END)  AS CurrentNumber,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' AND LN16.BF_SSN IS NULL THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS CurrentDollar,
	/*not current*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' AND LN16.BF_SSN IS NOT NULL THEN 1 ELSE 0 END)  AS NotCurrentNumber,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' AND LN16.BF_SSN IS NOT NULL THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS NotCurrentDollar,
	/*30-59 days*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' AND LN16.BF_SSN IS NOT NULL AND LN16.DDP BETWEEN 30 AND 59 THEN 1 ELSE 0 END) AS Number3059,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' AND LN16.BF_SSN IS NOT NULL AND LN16.DDP BETWEEN 30 AND 59 THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS Dollar3059,
	/*60-89 days*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' AND LN16.BF_SSN IS NOT NULL AND LN16.DDP BETWEEN 60 AND 89 THEN 1 ELSE 0 END) AS Number6089,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' AND LN16.BF_SSN IS NOT NULL AND LN16.DDP BETWEEN 60 AND 89 THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS Dollar6089,
	/*90-119 days*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' AND LN16.BF_SSN IS NOT NULL AND LN16.DDP BETWEEN 90 AND 119 THEN 1 ELSE 0 END) AS Number90119,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' AND LN16.BF_SSN IS NOT NULL AND LN16.DDP BETWEEN 90 AND 119 THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS Dollar90119,
	/*120-149 days*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' AND LN16.BF_SSN IS NOT NULL AND LN16.DDP BETWEEN 120 AND 149 THEN 1 ELSE 0 END) AS Number120149,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' AND LN16.BF_SSN IS NOT NULL AND LN16.DDP BETWEEN 120 AND 149 THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS Dollar120149,
	/*150-179 days*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' AND LN16.BF_SSN IS NOT NULL AND LN16.DDP BETWEEN 150 AND 179 THEN 1 ELSE 0 END) AS Number150179,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' AND LN16.BF_SSN IS NOT NULL AND LN16.DDP BETWEEN 150 AND 179 THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS Dollar150179,
	/*180-270 days*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' AND LN16.BF_SSN IS NOT NULL AND LN16.DDP BETWEEN 180 AND 270 THEN 1 ELSE 0 END) AS Number180270,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' AND LN16.BF_SSN IS NOT NULL AND LN16.DDP BETWEEN 180 AND 270 THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS Dollar180270,
	/*271+ days*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' AND LN16.BF_SSN IS NOT NULL AND LN16.DDP >=271 THEN 1 ELSE 0 END) AS Number270,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '03' AND LN16.BF_SSN IS NOT NULL AND LN16.DDP >=271 THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS Dollar270,
	/*deferment*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '04' THEN 1 ELSE 0 END)  AS InDefermentNumber,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '04' THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS InDefermentDollar,
	/*Unemployment or Hardship*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '04' AND Defer.DeferType = 'Unemp' THEN 1 ELSE 0 END)  AS UnempHardDeferNumber,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '04' AND Defer.DeferType = 'Unemp' THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS UnempHardDeferDollar,
	/*Unemployment or Hardship > 12 months*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '04' AND Defer.DeferType = 'Unemp' AND Defer.MonthsTotal > 12 THEN 1 ELSE 0 END) AS UnempHard12Number,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '04' AND Defer.DeferType = 'Unemp' AND Defer.MonthsTotal > 12 THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS UnempHard12Dollar,
	/*Military*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '04' AND Defer.DeferType = 'Military' THEN 1 ELSE 0 END)  AS MilitaryDeferNumber,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '04' AND Defer.DeferType = 'Military' THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS MilitaryDeferDollar,
	/*Military > 12 months*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '04' AND Defer.DeferType = 'Military' AND Defer.MonthsTotal > 12 THEN 1 ELSE 0 END)  AS MilitaryDefer12Number,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '04' AND Defer.DeferType = 'Military' AND Defer.MonthsTotal > 12 THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS MilitaryDefer12Dollar,
	/*School Defer*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '04' AND Defer.DeferType = 'School' THEN 1 ELSE 0 END)  AS SchoolDeferNumber,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '04' AND Defer.DeferType = 'School'  THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS SchoolDeferDollar,
	/*Other Defer*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '04' AND Defer.DeferType = 'Other' THEN 1 ELSE 0 END)  AS OtherDeferNumber,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '04' AND Defer.DeferType = 'Other' THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS OtherDeferDollar,
	/*forbearance*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '05' THEN 1 ELSE 0 END) AS InForbearanceNumber,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '05' THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS InForbearanceDollar,
	/*Admin forbearance*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '05' AND Forb.ForbType = 'Admin' THEN 1 ELSE 0 END) AS AdminForbNumber,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '05' AND Forb.ForbType = 'Admin' THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS AdminForbDollar,
	/*voluntary forbearance*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '05' AND Forb.ForbType = 'Voluntary' THEN 1 ELSE 0 END)  AS VoluntaryForbNumber,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '05' AND Forb.ForbType = 'Voluntary' THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS VoluntaryForbDollar,
	/*Long term voluntary forbearance*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '05' AND Forb.ForbType = 'Voluntary' AND Forb.MonthsTotal > 12 THEN 1 ELSE 0 END)  AS LongTermVoluntaryForbNumber,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '05' AND Forb.ForbType = 'Voluntary' AND Forb.MonthsTotal > 12 THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS LongTermVoluntaryForbDollar,
	/*serial voluntary forbearance*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '05' AND Forb.ForbType = 'Voluntary' AND Forb.MonthsTotal > 24 THEN 1 ELSE 0 END)  AS SerialForbNumber,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '05' AND Forb.ForbType = 'Voluntary' AND Forb.MonthsTotal > 24 THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS SerialForbDollar,
	/*other forbearance*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '05' AND Forb.ForbType = 'Other' THEN 1 ELSE 0 END)  AS OtherForbNumber,
	SUM(CASE WHEN DW01.WC_DW_LON_STA = '05' AND Forb.ForbType = 'Other' THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS OtherForbDollar,
	/*other*/
	SUM(CASE WHEN DW01.WC_DW_LON_STA NOT IN('01','02','03','04','05') THEN 1 ELSE 0 END)  AS InOtherNumber,
	SUM(CASE WHEN DW01.WC_DW_LON_STA NOT IN('01','02','03','04','05') THEN ISNULL(LN10.LA_CUR_PRI,0.00) + ISNULL(DW01.WA_TOT_BRI_OTS,0.00) ELSE 0.00 END) AS InOtherDollar
FROM
	#NYAccounts NYA
	INNER JOIN AuditUDW..LN10_LON_May2020 LN10
		ON LN10.BF_SSN = NYA.BF_SSN
		AND LN10.LN_SEQ = NYA.LN_SEQ
	INNER JOIN AuditUDW..DW01_DW_CLC_CLU_May2020 DW01
		ON DW01.BF_SSN = LN10.BF_SSN
		AND DW01.LN_SEQ = LN10.LN_SEQ
	LEFT JOIN
	(
		SELECT DISTINCT
			BF_SSN,
			LN_SEQ,
			MAX(CASE 
				WHEN CAST(LD_DLQ_MAX AS DATE) <= '05/31/2020' THEN DATEDIFF(DAY, LD_DLQ_OCC, LD_DLQ_MAX)
				ELSE DATEDIFF(DAY, LD_DLQ_OCC, '05/31/2020')
			END) AS DDP
		FROM
			UDW..LN16_LON_DLQ_HST LN16
		WHERE
			CAST(LD_DLQ_OCC AS DATE) <= '05/31/2020' --past due before the cutoff date 
			AND CAST(LD_DLQ_MAX AS DATE) > '05/31/2020' --past due after
		GROUP BY
			BF_SSN,
			LN_SEQ
	) LN16
		ON LN16.BF_SSN = LN10.BF_SSN
		AND LN16.LN_SEQ = LN16.LN_SEQ
	LEFT JOIN
	(
		SELECT DISTINCT
			LN50.BF_SSN,
			LN50.LN_SEQ,
			TotalDeferByType.DeferType,
			TotalDeferByType.MonthsTotal
		FROM
			UDW..LN50_BR_DFR_APV LN50
			INNER JOIN UDW..DF10_BR_DFR_REQ DF10
				ON DF10.BF_SSN = LN50.BF_SSN
				AND DF10.LF_DFR_CTL_NUM = LN50.LF_DFR_CTL_NUM
			LEFT JOIN 
			(
				SELECT DISTINCT
					LN50.BF_SSN,
					LN50.LN_SEQ,
					CASE WHEN DF10.LC_DFR_TYP IN('02','13','29') THEN 'Unemp'
					     WHEN DF10.LC_DFR_TYP IN('04','17','24','38','40') THEN 'Military'
						 WHEN DF10.LC_DFR_TYP IN('06','15','16','18','19','21','22','23','25','45') THEN 'School'
						 ELSE 'Other'
					END AS DeferType,
					SUM(CAST(DATEDIFF(DAY,LN50.LD_DFR_BEG,LN50.LD_DFR_END) AS DECIMAL)) / 30.25 AS MonthsTotal
				FROM
					UDW..LN50_BR_DFR_APV LN50
					INNER JOIN UDW..DF10_BR_DFR_REQ DF10
						ON DF10.BF_SSN = LN50.BF_SSN
						AND DF10.LF_DFR_CTL_NUM = LN50.LF_DFR_CTL_NUM
				WHERE
					LN50.LC_DFR_RSP != '003'
					AND LN50.LC_STA_LON50 = 'A'
					AND DF10.LC_DFR_STA = 'A'
					AND DF10.LC_STA_DFR10 = 'A'
					AND LN50.LD_DFR_BEG <= CAST('05/31/2020' AS DATE)
				GROUP BY
					LN50.BF_SSN,
					LN50.LN_SEQ,
					CASE WHEN DF10.LC_DFR_TYP IN('02','13','29') THEN 'Unemp'
					     WHEN DF10.LC_DFR_TYP IN('04','17','24','38','40') THEN 'Military'
						 WHEN DF10.LC_DFR_TYP IN('06','15','16','18','19','21','22','23','25','45') THEN 'School'
						 ELSE 'Other'
					END
			) TotalDeferByType
			 ON TotalDeferByType.BF_SSN = LN50.BF_SSN
			 AND TotalDeferByType.LN_SEQ = LN50.LN_SEQ
		WHERE
			CAST('05/31/2020' AS DATE) BETWEEN LN50.LD_DFR_BEG AND (CASE WHEN LN50.LD_DFR_END > CAST('05/31/2020' AS DATE) THEN CAST('05/31/2020' AS DATE) ELSE LN50.LD_DFR_END END)
			AND LN50.LC_DFR_RSP != '003'
			AND LN50.LC_STA_LON50 = 'A'
			AND DF10.LC_DFR_STA = 'A'
			AND DF10.LC_STA_DFR10 = 'A'
	) Defer
		ON Defer.BF_SSN = LN10.BF_SSN
		AND Defer.LN_SEQ = LN10.LN_SEQ
	LEFT JOIN
	(
		SELECT DISTINCT
			LN60.BF_SSN,
			LN60.LN_SEQ,
			TotalForbByType.ForbType,
			TotalForbByType.MonthsTotal
		FROM
			UDW..LN60_BR_FOR_APV LN60
			INNER JOIN UDW..FB10_BR_FOR_REQ FB10
				ON FB10.BF_SSN = LN60.BF_SSN
				AND FB10.LF_FOR_CTL_NUM = LN60.LF_FOR_CTL_NUM
			LEFT JOIN 
			(
				SELECT DISTINCT
					LN60.BF_SSN,
					LN60.LN_SEQ,
					CASE WHEN FB10.LC_FOR_TYP IN('01','02','03','04','06','07','09','10','11','12','13','14','15','16','17','18','20','21','22','25','26','27','28','32','33','34','35','36','37','38','39','40','41','42','43','44') THEN 'Admin'
					     WHEN FB10.LC_FOR_TYP IN('05','24','29','31') THEN 'Voluntary'
						 ELSE 'Other'
					END AS ForbType,
					SUM(CAST(DATEDIFF(DAY,LN60.LD_FOR_BEG,LN60.LD_FOR_END) AS DECIMAL)) / 30.25 AS MonthsTotal
				FROM
					UDW..LN60_BR_FOR_APV LN60
					INNER JOIN UDW..FB10_BR_FOR_REQ FB10
						ON FB10.BF_SSN = LN60.BF_SSN
						AND FB10.LF_FOR_CTL_NUM = LN60.LF_FOR_CTL_NUM
				WHERE
					LN60.LC_FOR_RSP != '003'
					AND LN60.LC_STA_LON60 = 'A'
					AND FB10.LC_FOR_STA = 'A'
					AND FB10.LC_STA_FOR10 = 'A'
					AND LN60.LD_FOR_BEG <= CAST('05/31/2020' AS DATE)
				GROUP BY
					LN60.BF_SSN,
					LN60.LN_SEQ,
					CASE WHEN FB10.LC_FOR_TYP IN('01','02','03','04','06','07','09','10','11','12','13','14','15','16','17','18','20','21','22','25','26','27','28','32','33','34','35','36','37','38','39','40','41','42','43','44') THEN 'Admin'
					     WHEN FB10.LC_FOR_TYP IN('05','24','29','31') THEN 'Voluntary'
						 ELSE 'Other'
					END
			) TotalForbByType
			 ON TotalForbByType.BF_SSN = LN60.BF_SSN
			 AND TotalForbByType.LN_SEQ = LN60.LN_SEQ
		WHERE
			CAST('05/31/2020' AS DATE) BETWEEN LN60.LD_FOR_BEG AND (CASE WHEN LN60.LD_FOR_END > CAST('05/31/2020' AS DATE) THEN CAST('05/31/2020' AS DATE) ELSE LN60.LD_FOR_END END)
			AND LN60.LC_FOR_RSP != '003'
			AND LN60.LC_STA_LON60 = 'A'
			AND FB10.LC_FOR_STA = 'A'
			AND FB10.LC_STA_FOR10 = 'A'
	) Forb
		ON Forb.BF_SSN = LN10.BF_SSN
		AND Forb.LN_SEQ = LN10.LN_SEQ

WHERE
	LN10.LC_STA_LON10 = 'R'
	AND LN10.LA_CUR_PRI > 0.00

--Table 3: 4 Defaults and Discharges
SELECT DISTINCT
	SUM(CASE WHEN LN90.PC_FAT_TYP ='10' AND LN90.PC_FAT_SUB_TYP = '30' THEN 1 ELSE 0 END) AS Defaults,
	SUM(CASE WHEN LN90.PC_FAT_TYP ='50' AND LN90.PC_FAT_SUB_TYP = '02' THEN 1 ELSE 0 END) AS Discharge
FROM
	#NYAccounts NYA
	INNER JOIN UDW..LN90_FIN_ATY LN90
		ON LN90.BF_SSN = NYA.BF_SSN
		AND LN90.LN_SEQ = NYA.LN_SEQ
		AND LN90.LC_STA_LON90 = 'A'
		AND ISNULL(RTRIM(LN90.LC_FAT_REV_REA),'') = ''
WHERE
	CAST(LN90.LD_FAT_EFF AS DATE) BETWEEN CAST('2019-10-09' AS DATE) AND CAST('2020-05-31' AS DATE)
	AND
	(
		(LN90.PC_FAT_TYP = '10' AND LN90.PC_FAT_SUB_TYP = '30')
		OR(LN90.PC_FAT_TYP ='50' AND LN90.PC_FAT_SUB_TYP = '02')
	)
--Table 3: 5 Degree Completion
SELECT DISTINCT
	SUM(CASE WHEN SD10.LC_REA_SCL_SPR = '01' THEN 1 ELSE 0 END) AS Completion,
	SUM(CASE WHEN SD10.LC_REA_SCL_SPR != '01' THEN 1 ELSE 0 END) AS NonCompletion
FROM
	#NYAccounts NYA
	INNER JOIN UDW..LN10_LON LN10
		ON LN10.BF_SSN = NYA.BF_SSN
		AND LN10.LN_SEQ = NYA.LN_SEQ
	INNER JOIN UDW..SD10_STU_SPR SD10
		ON SD10.LF_STU_SSN = LN10.LF_STU_SSN
WHERE
	SD10.LD_SCL_SPR BETWEEN CAST('2019-10-09' AS DATE) AND CAST('2020-05-31' AS DATE)

--Table 5: 1 Borrower Relief (Telephone contacts)
SELECT
	SUM(CASE WHEN CAST(NCH.ActivityDate AS DATE) BETWEEN '02/24/2020' AND  '03/08/2020' THEN 1 ELSE NULL END) TelephoneContacts1,
	SUM(CASE WHEN CAST(NCH.ActivityDate AS DATE) BETWEEN '03/09/2020' AND '03/22/2020' THEN 1 ELSE NULL END) TelephoneContacts2,
	SUM(CASE WHEN CAST(NCH.ActivityDate AS DATE) BETWEEN '03/23/2020' AND '04/05/2020' THEN 1 ELSE NULL END) TelephoneContacts3,
	SUM(CASE WHEN CAST(NCH.ActivityDate AS DATE) BETWEEN '04/06/2020' AND '04/19/2020' THEN 1 ELSE NULL END) TelephoneContacts4,
	SUM(CASE WHEN CAST(NCH.ActivityDate AS DATE) BETWEEN '04/20/2020' AND '05/03/2020' THEN 1 ELSE NULL END) TelephoneContacts5,
	SUM(CASE WHEN CAST(NCH.ActivityDate AS DATE) BETWEEN '05/04/2020' AND  '05/17/2020' THEN 1 ELSE NULL END) TelephoneContacts6,
	SUM(CASE WHEN CAST(NCH.ActivityDate AS DATE) BETWEEN '05/18/2020' AND '05/31/2020' THEN 1 ELSE NULL END) TelephoneContacts7
FROM																										  
	#NYAccounts NYA
	INNER JOIN UDW..PD10_PRS_NME PD10
		ON PD10.DF_PRS_ID = NYA.BF_SSN
	INNER JOIN NobleCalls..NobleCallHistory NCH
		ON PD10.DF_SPE_ACC_ID = NCH.AccountIdentifier
WHERE
	NCH.IsInbound = 1 
	AND NCH.RegionId = 2
	AND CAST(NCH.ActivityDate AS DATE) BETWEEN CAST('02/24/2020' AS DATE) AND CAST('05/31/2020' AS DATE)

--Table 5: 1 Borrower Relief (Other contacts)
SELECT
	SUM(CASE WHEN CAST(DP.AddedAt AS DATE) BETWEEN '02/24/2020' AND '03/08/2020' THEN 1 ELSE NULL END) OtherContacts1,
	SUM(CASE WHEN CAST(DP.AddedAt AS DATE) BETWEEN '03/09/2020' AND '03/22/2020' THEN 1 ELSE NULL END) OtherContacts2,
	SUM(CASE WHEN CAST(DP.AddedAt AS DATE) BETWEEN '03/23/2020' AND '04/05/2020' THEN 1 ELSE NULL END) OtherContacts3,
	SUM(CASE WHEN CAST(DP.AddedAt AS DATE) BETWEEN '04/06/2020' AND '04/19/2020' THEN 1 ELSE NULL END) OtherContacts4,
	SUM(CASE WHEN CAST(DP.AddedAt AS DATE) BETWEEN '04/20/2020' AND '05/03/2020' THEN 1 ELSE NULL END) OtherContacts5,
	SUM(CASE WHEN CAST(DP.AddedAt AS DATE) BETWEEN '05/04/2020' AND '05/17/2020' THEN 1 ELSE NULL END) OtherContacts6,
	SUM(CASE WHEN CAST(DP.AddedAt AS DATE) BETWEEN '05/18/2020' AND '05/31/2020' THEN 1 ELSE NULL END) OtherContacts7
FROM
	#NYAccounts NYA
	INNER JOIN UDW..PD10_PRS_NME PD10
		ON PD10.DF_PRS_ID = NYA.BF_SSN
	INNER JOIN ULS.docid.DocumentsProcessed DP
		ON PD10.DF_SPE_ACC_ID = DP.AccountIdentifier
WHERE
	CAST(DP.AddedAt AS DATE) BETWEEN CAST('02/24/2020' AS DATE) AND CAST('05/31/2020' AS DATE)

--Table 5: 1 Borrower Relief (Forbearance)
SELECT DISTINCT
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'XFORB' AND AY10.LD_ATY_REQ_RCV BETWEEN '02/24/2020' AND  '03/08/2020' THEN 1 ELSE NULL END) ForbRequest1,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'XFORB' AND AY10.LD_ATY_REQ_RCV BETWEEN '03/09/2020' AND '03/22/2020' THEN 1 ELSE NULL END) ForbRequest2,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'XFORB' AND AY10.LD_ATY_REQ_RCV BETWEEN '03/23/2020' AND '04/05/2020' THEN 1 ELSE NULL END) ForbRequest3,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'XFORB' AND AY10.LD_ATY_REQ_RCV BETWEEN '04/06/2020' AND '04/19/2020' THEN 1 ELSE NULL END) ForbRequest4,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'XFORB' AND AY10.LD_ATY_REQ_RCV BETWEEN '04/20/2020' AND '05/03/2020' THEN 1 ELSE NULL END) ForbRequest5,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'XFORB' AND AY10.LD_ATY_REQ_RCV BETWEEN '05/04/2020' AND  '05/17/2020' THEN 1 ELSE NULL END) ForbRequest6,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'XFORB' AND AY10.LD_ATY_REQ_RCV BETWEEN '05/18/2020' AND '05/31/2020' THEN 1 ELSE NULL END) ForbRequest7,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'FBAPV' AND AY10.LD_ATY_REQ_RCV BETWEEN '02/24/2020' AND  '03/08/2020' THEN 1 ELSE NULL END) ForbApprove1,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'FBAPV' AND AY10.LD_ATY_REQ_RCV BETWEEN '03/09/2020' AND '03/22/2020' THEN 1 ELSE NULL END) ForbApprove2,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'FBAPV' AND AY10.LD_ATY_REQ_RCV BETWEEN '03/23/2020' AND '04/05/2020' THEN 1 ELSE NULL END) ForbApprove3,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'FBAPV' AND AY10.LD_ATY_REQ_RCV BETWEEN '04/06/2020' AND '04/19/2020' THEN 1 ELSE NULL END) ForbApprove4,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'FBAPV' AND AY10.LD_ATY_REQ_RCV BETWEEN '04/20/2020' AND '05/03/2020' THEN 1 ELSE NULL END) ForbApprove5,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'FBAPV' AND AY10.LD_ATY_REQ_RCV BETWEEN '05/04/2020' AND  '05/17/2020' THEN 1 ELSE NULL END) ForbApprove6,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'FBAPV' AND AY10.LD_ATY_REQ_RCV BETWEEN '05/18/2020' AND '05/31/2020' THEN 1 ELSE NULL END) ForbApprove7,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'FBDNY' AND AY10.LD_ATY_REQ_RCV BETWEEN '02/24/2020' AND  '03/08/2020' THEN 1 ELSE NULL END) ForbDeny1,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'FBDNY' AND AY10.LD_ATY_REQ_RCV BETWEEN '03/09/2020' AND '03/22/2020' THEN 1 ELSE NULL END) ForbDeny2,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'FBDNY' AND AY10.LD_ATY_REQ_RCV BETWEEN '03/23/2020' AND '04/05/2020' THEN 1 ELSE NULL END) ForbDeny3,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'FBDNY' AND AY10.LD_ATY_REQ_RCV BETWEEN '04/06/2020' AND '04/19/2020' THEN 1 ELSE NULL END) ForbDeny4,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'FBDNY' AND AY10.LD_ATY_REQ_RCV BETWEEN '04/20/2020' AND '05/03/2020' THEN 1 ELSE NULL END) ForbDeny5,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'FBDNY' AND AY10.LD_ATY_REQ_RCV BETWEEN '05/04/2020' AND  '05/17/2020' THEN 1 ELSE NULL END) ForbDeny6,
	SUM(CASE WHEN AY10.PF_REQ_ACT = 'FBDNY' AND AY10.LD_ATY_REQ_RCV BETWEEN '05/18/2020' AND '05/31/2020' THEN 1 ELSE NULL END) ForbDeny7
FROM
	#NYAccounts NYA
	INNER JOIN UDW..AY10_BR_LON_ATY AY10
		ON AY10.BF_SSN = NYA.BF_SSN
WHERE
	AY10.LC_STA_ACTY10 = 'A'
	AND AY10.LD_ATY_REQ_RCV BETWEEN CAST('02/24/2020' AS DATE) AND CAST('05/31/2020' AS DATE)
	AND AY10.PF_REQ_ACT IN ('XFORB','FBAPV','FBDNY')

--Table 5: 1 Borrower relief (Late Payment Fees)
SELECT
	SUM(CASE WHEN ISNULL(RTRIM(LN80.LC_LTE_FEE_WAV_REA),'') != '' AND CAST(LN80.LD_BIL_DU_LON AS DATE) BETWEEN '02/24/2020' AND  '03/08/2020' THEN 1 ELSE NULL END) LateFeeWaived1,
	SUM(CASE WHEN ISNULL(RTRIM(LN80.LC_LTE_FEE_WAV_REA),'') != '' AND CAST(LN80.LD_BIL_DU_LON AS DATE) BETWEEN '03/09/2020' AND '03/22/2020' THEN 1 ELSE NULL END) LateFeeWaived2,
	SUM(CASE WHEN ISNULL(RTRIM(LN80.LC_LTE_FEE_WAV_REA),'') != '' AND CAST(LN80.LD_BIL_DU_LON AS DATE) BETWEEN '03/23/2020' AND '04/05/2020' THEN 1 ELSE NULL END) LateFeeWaived3,
	SUM(CASE WHEN ISNULL(RTRIM(LN80.LC_LTE_FEE_WAV_REA),'') != '' AND CAST(LN80.LD_BIL_DU_LON AS DATE) BETWEEN '04/06/2020' AND '04/19/2020' THEN 1 ELSE NULL END) LateFeeWaived4,
	SUM(CASE WHEN ISNULL(RTRIM(LN80.LC_LTE_FEE_WAV_REA),'') != '' AND CAST(LN80.LD_BIL_DU_LON AS DATE) BETWEEN '04/20/2020' AND '05/03/2020' THEN 1 ELSE NULL END) LateFeeWaived5,
	SUM(CASE WHEN ISNULL(RTRIM(LN80.LC_LTE_FEE_WAV_REA),'') != '' AND CAST(LN80.LD_BIL_DU_LON AS DATE) BETWEEN '05/04/2020' AND  '05/17/2020' THEN 1 ELSE NULL END) LateFeeWaived6,
	SUM(CASE WHEN ISNULL(RTRIM(LN80.LC_LTE_FEE_WAV_REA),'') != '' AND CAST(LN80.LD_BIL_DU_LON AS DATE) BETWEEN '05/18/2020' AND '05/31/2020' THEN 1 ELSE NULL END) LateFeeWaived7,
	SUM(CASE WHEN ISNULL(LN80.LA_LTE_FEE_ASS,0.00) != 0.00 AND CAST(LN80.LD_BIL_DU_LON AS DATE) BETWEEN '02/24/2020' AND  '03/08/2020' THEN 1 ELSE NULL END) LateFeeAssessed1,
	SUM(CASE WHEN ISNULL(LN80.LA_LTE_FEE_ASS,0.00) != 0.00 AND CAST(LN80.LD_BIL_DU_LON AS DATE) BETWEEN '03/09/2020' AND '03/22/2020' THEN 1 ELSE NULL END) LateFeeAssessed2,
	SUM(CASE WHEN ISNULL(LN80.LA_LTE_FEE_ASS,0.00) != 0.00 AND CAST(LN80.LD_BIL_DU_LON AS DATE) BETWEEN '03/23/2020' AND '04/05/2020' THEN 1 ELSE NULL END) LateFeeAssessed3,
	SUM(CASE WHEN ISNULL(LN80.LA_LTE_FEE_ASS,0.00) != 0.00 AND CAST(LN80.LD_BIL_DU_LON AS DATE) BETWEEN '04/06/2020' AND '04/19/2020' THEN 1 ELSE NULL END) LateFeeAssessed4,
	SUM(CASE WHEN ISNULL(LN80.LA_LTE_FEE_ASS,0.00) != 0.00 AND CAST(LN80.LD_BIL_DU_LON AS DATE) BETWEEN '04/20/2020' AND '05/03/2020' THEN 1 ELSE NULL END) LateFeeAssessed5,
	SUM(CASE WHEN ISNULL(LN80.LA_LTE_FEE_ASS,0.00) != 0.00 AND CAST(LN80.LD_BIL_DU_LON AS DATE) BETWEEN '05/04/2020' AND  '05/17/2020' THEN 1 ELSE NULL END) LateFeeAssessed6,
	SUM(CASE WHEN ISNULL(LN80.LA_LTE_FEE_ASS,0.00) != 0.00 AND CAST(LN80.LD_BIL_DU_LON AS DATE) BETWEEN '05/18/2020' AND '05/31/2020' THEN 1 ELSE NULL END) LateFeeAssessed7
FROM
	#NYAccounts NYA
	INNER JOIN UDW..LN80_LON_BIL_CRF LN80
		ON LN80.BF_SSN = NYA.BF_SSN
		AND LN80.LN_SEQ = NYA.LN_SEQ
		AND LN80.LC_STA_LON80 = 'A'
		AND CAST(LN80.LD_BIL_DU_LON AS DATE) BETWEEN CAST('02/24/2020' AS DATE) AND CAST('05/31/2020' AS DATE)
