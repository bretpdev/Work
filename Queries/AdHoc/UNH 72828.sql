USE ODW
GO

DROP TABLE IF EXISTS #ADD_EMAIL
DROP TABLE IF EXISTS #PHONE



SELECT DISTINCT
	DF_PRS_ID
INTO #ADD_EMAIL
FROM
	ODW..AY01_BR_ATY AY01
	INNER JOIN UDW..LN10_LON LN10
		ON LN10.BF_SSN = AY01.DF_PRS_ID
		AND LN10.LA_CUR_PRI > 0
WHERE
	PF_ACT = 'MXADD'
	AND BD_ATY_PRF BETWEEN '08/24/2020' AND '10/04/2021'
	and BX_CMT like '%ADDRESS SAME AS ON FILE%'

SELECT DISTINCT
	DF_PRS_ID
INTO #PHONE
FROM
	ODW..AY01_BR_ATY AY01
	INNER JOIN UDW..LN10_LON LN10
		ON LN10.BF_SSN = AY01.DF_PRS_ID
		AND LN10.LA_CUR_PRI > 0
WHERE
	PF_ACT = 'MXADD'
	AND BD_ATY_PRF BETWEEN '08/24/2020' AND '10/04/2021'
	and BX_CMT like '%PHONE NUMBER SAME AS ON FILE%'

--SELECT
--	ADDR.DF_PRS_ID,
--	CASE 
--		WHEN RTRIM(PD03.DI_VLD_ADR)   != RTRIM(PD30.DI_VLD_ADR) THEN 'VALIDITY DOES NOT MATCH'
--		WHEN RTRIM(PD03.DX_STR_ADR_1) != RTRIM(PD30.DX_STR_ADR_1) THEN 'ADDRESS 1'
--		WHEN RTRIM(PD03.DX_STR_ADR_2) != RTRIM(PD30.DX_STR_ADR_2) THEN 'ADDRESS 2'
--		WHEN RTRIM(PD03.DC_DOM_ST)    != RTRIM(PD30.DC_DOM_ST) THEN 'STATE'
--		WHEN RTRIM(PD03.DM_CT)        != RTRIM(PD30.DM_CT) THEN 'CITY'
--		WHEN SUBSTRING(PD03.DF_ZIP, 1,5)       != SUBSTRING(PD30.DF_ZIP_CDE, 1,5) THEN 'ZIP'
--		ELSE NULL
--	END AS REASON,
--	'ONELINK',
--	PD03.DI_VLD_ADR,  
--	PD03.DX_STR_ADR_1,
--	PD03.DX_STR_ADR_2,
--	PD03.DC_DOM_ST,
--	PD03.DM_CT,       
--	PD03.DF_ZIP,
--	'COMPASS',
--	PD30.DI_VLD_ADR,
--	PD30.DX_STR_ADR_1,
--	PD30.DX_STR_ADR_2,
--	PD30.DC_DOM_ST,
--	PD30.DM_CT ,
--	PD30.DF_ZIP_CDE       
--FROM
--	#ADD_EMAIL ADDR
--	INNER JOIN ODW..PD03_PRS_ADR_PHN PD03
--		ON PD03.DF_PRS_ID = ADDR.DF_PRS_ID
--		AND PD03.DC_ADR = 'L'
--	INNER JOIN UDW..PD30_PRS_ADR PD30
--		ON PD30.DF_PRS_ID = ADDR.DF_PRS_ID
--		AND PD30.DC_ADR = 'L'
--WHERE 
--	CASE 
--		WHEN RTRIM(PD03.DI_VLD_ADR)   != RTRIM(PD30.DI_VLD_ADR) THEN 'VALIDITY DOES NOT MATCH'
--		WHEN RTRIM(PD03.DX_STR_ADR_1) != RTRIM(PD30.DX_STR_ADR_1) THEN 'ADDRESS 1'
--		WHEN RTRIM(PD03.DX_STR_ADR_2) != RTRIM(PD30.DX_STR_ADR_2) THEN 'ADDRESS 2'
--		WHEN RTRIM(PD03.DC_DOM_ST)    != RTRIM(PD30.DC_DOM_ST) THEN 'STATE'
--		WHEN RTRIM(PD03.DM_CT)        != RTRIM(PD30.DM_CT) THEN 'CITY'
--		WHEN SUBSTRING(PD03.DF_ZIP, 1,5)       != SUBSTRING(PD30.DF_ZIP_CDE, 1,5) THEN 'ZIP'
--		ELSE NULL
--	END IS NOT NULL
INSERT INTO OLS.olqtskbldr.Queues(TargetId, QueueName, InstitutionId, InstitutionType,DateDue, TimeDue,
Comment, SourceFilename, ProcessedAt, AddedAt, AddedBy)
SELECT
	ADDR.DF_PRS_ID,
	'XDEMOE',
	NULL,
	NULL,
	NULL,
	NULL,
	',,,,,,,,' + PD32.DX_ADR_EML + ',' + PD32.DI_VLD_ADR_EML,
	NULL,
	NULL,
	GETDATE(),
	'UNH72828'
	--CASE 
	--	WHEN  RTRIM(PD03.DI_EML_ADR_VAL)  != RTRIM(PD32.DI_VLD_ADR_EML) AND PD32.DI_VLD_ADR_EML = 'Y' THEN 'VALIDITY DOES NOT MATCH'
	--	WHEN RTRIM(PD03.DX_EML_ADR) != RTRIM(PD32.DX_ADR_EML) AND PD32.DI_VLD_ADR_EML = 'Y' THEN 'EMAIL'
	--	ELSE NULL
	--END AS REASON,
	--'ONELINK',
	--PD03.DI_EML_ADR_VAL,  
	--PD03.DX_EML_ADR,
	--'COMPASS',
	--PD32.DI_VLD_ADR_EML,
	--PD32.DX_ADR_EML
	      
FROM
	#ADD_EMAIL ADDR
	INNER JOIN ODW..PD03_PRS_ADR_PHN PD03
		ON PD03.DF_PRS_ID = ADDR.DF_PRS_ID
		AND PD03.DC_ADR = 'L'
	INNER JOIN UDW..PD32_PRS_ADR_EML PD32
		ON PD32.DF_PRS_ID = ADDR.DF_PRS_ID
		AND PD32.DC_ADR_EML = 'H'
		AND PD32.DC_STA_PD32 = 'A'
WHERE
	CASE 
		WHEN  RTRIM(PD03.DI_EML_ADR_VAL)  != RTRIM(PD32.DI_VLD_ADR_EML) AND PD32.DI_VLD_ADR_EML = 'Y' THEN 'VALIDITY DOES NOT MATCH'
		WHEN RTRIM(PD03.DX_EML_ADR) != RTRIM(PD32.DX_ADR_EML) AND PD32.DI_VLD_ADR_EML = 'Y' THEN 'EMAIL'
		ELSE NULL
	END IS NOT NULL

INSERT INTO OLS.olqtskbldr.Queues(TargetId, QueueName, InstitutionId, InstitutionType,DateDue, TimeDue,
Comment, SourceFilename, ProcessedAt, AddedAt, AddedBy)
SELECT
	phn.DF_PRS_ID,
	'XDEMOG',
	NULL,
	NULL,
	NULL,
	NULL,
	',,,,,,' + PD42.DN_DOM_PHN_ARA + PD42.DN_DOM_PHN_XCH + PD42.DN_DOM_PHN_LCL + ',,,' + PD42.DI_PHN_VLD +',' + 
	CASE
		WHEN PD42.DC_ALW_ADL_PHN in ('L','Q')  THEN 'L'
		WHEN PD42.DC_ALW_ADL_PHN in ('N') THEN 'N'
		WHEN PD42.DC_ALW_ADL_PHN in ('P') THEN 'P' 
		WHEN PD42.DC_ALW_ADL_PHN in ('U','X') THEN 'U'
	END , 
	NULL,
	NULL,
	GETDATE(),
	'UNH72828'
	--CASE 
	--	WHEN  RTRIM(PD03.DI_PHN_VLD)  != RTRIM(PD42.DI_PHN_VLD) AND PD42.DI_PHN_VLD = 'Y' THEN 'VALIDITY DOES NOT MATCH'
	--	WHEN RTRIM(PD03.DN_PHN) != RTRIM(PD42.DN_DOM_PHN_ARA + PD42.DN_DOM_PHN_XCH + PD42.DN_DOM_PHN_LCL) AND PD42.DI_PHN_VLD = 'Y' THEN 'phn'
	--	ELSE NULL
	--END AS REASON,
	--'ONELINK',
	--PD03.DI_PHN_VLD,  
	--PD03.DN_PHN,
	--'COMPASS',
	--PD42.DI_PHN_VLD,
	--PD42.DN_DOM_PHN_ARA + PD42.DN_DOM_PHN_XCH + PD42.DN_DOM_PHN_LCL
	      
FROM
	#PHONE PHN
	INNER JOIN ODW..PD03_PRS_ADR_PHN PD03
		ON PD03.DF_PRS_ID = PHN.DF_PRS_ID
		AND PD03.DC_ADR = 'L'
	INNER JOIN UDW..PD42_PRS_PHN PD42
		ON PD42.DF_PRS_ID = PHN.DF_PRS_ID
		AND PD42.DC_PHN = 'H'
WHERE
	CASE 
		WHEN  RTRIM(PD03.DI_PHN_VLD)  != RTRIM(PD42.DI_PHN_VLD) AND PD42.DI_PHN_VLD = 'Y' THEN 'VALIDITY DOES NOT MATCH'
		WHEN  RTRIM(PD03.DN_PHN) != RTRIM(PD42.DN_DOM_PHN_ARA + PD42.DN_DOM_PHN_XCH + PD42.DN_DOM_PHN_LCL) AND PD42.DI_PHN_VLD = 'Y' THEN 'phn'
		ELSE NULL
	END IS NOT NULL
	and RTRIM(PD42.DN_DOM_PHN_ARA + PD42.DN_DOM_PHN_XCH + PD42.DN_DOM_PHN_LCL) != ''
--SELECT
--	*
--FROM
--	#PHONE	