USE CDW

GO

SELECT 
	RTRIM(PDXX.DM_PRS_LST) AS [Last Name],
	rtrim(pdXX.DM_PRS_X) as [First Name],
	CNH.BF_SSN,
	CNH.LN_SEQ,
	CNH.LF_FED_CLC_RSK,
	CNH.LC_FED_PGM_YR,
	REPLACE(CONVERT(VARCHAR(XX), CNH.LD_LON_X_DSB, XXX),'/','') AS LD_LON_X_DSB,
	DSB_AMT.DISB_AMT_C,
	CNH.LF_FED_AWD + RIGHT('XXX' + CAST(CNH.LN_FED_AWD_SEQ AS VARCHAR(XX)),X) AS AWARD_ID,
	CNH.LA_CUR_PRI, 
	CNH.LA_NSI_OTS,
	CONVERT(VARCHAR(XX),CNH.LD_NSI_ACR_THU, XXX) LD_NSI_ACR_THU,
	CNH.LC_STA_LONXX,
	CNH.LC_SST_LONXX,
	REPLACE(CONVERT(VARCHAR(XX), CNH.LD_FAT_EFF, XXX),'/','') AS LD_FAT_EFF,
	CNH.LC_STA_LONXX,
	CNH.PC_FAT_SUB_TYP,
	CNH.LA_FAT_CUR_PRI,
	CNH.LA_FAT_NSI,
	CNH.IC_RGN_RCV_DCV_LON,
	CNH.PM_BBS_PGM,
	CNH.LC_LON_BBT_STA,
	CNH.REBATE_TOTAL, 
	CNH.REBLST_TOTAL,
	CNH.LC_STA_FAT_ADJ_REQ,
	CONVERT(VARCHAR(XX), CNH.[PAYOFF DATE], XXX)[PAYOFF DATE],
	CNH.[TOTAL PAYOFF],
	CNH.PRINCIPAL,
	CNH.INTEREST,
	CNH.[DAILY INTEREST],
	CNH.[PAST DUE AMOUNT],
	CNH.[Pri Change],
	CNH.[Int Change],
	CNH.[Net Change]
FROM
	CDW..[CNHXXXXX] CNH
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = CNH .BF_SSN
	LEFT JOIN 
		(
			SELECT 
			TABX.BF_SSN, 
			FSXX.LF_FED_AWD ,
			FSXX.LN_FED_AWD_SEQ, 
			SUM(CASE WHEN LNXXAMT IS NOT NULL THEN LNXXAMT ELSE LNXXAMT END) AS DISB_AMT_C
		FROM
		( --aes's logic
			SELECT 
				LNXX.BF_SSN, 
				LNXX.LN_SEQ, 
				LN_BR_DSB_SEQ, 
				SUM(LA_DSB - COALESCE(LA_DSB_CAN,X)) AS LNXXAMT, 
				(
					SELECT 
						SUM(LA_PCV_ADJ_CUR_PRI) 
					FROM 
						CDW..LNXX_PCV_FIN_SCP LNXX 
					WHERE 
						LNXX.BF_SSN = LNXX.BF_SSN 
						AND LNXX.LN_SEQ = LNXX.LN_SEQ 
						AND LNXX.LN_BR_DSB_SEQ = LNXX.LN_BR_DSB_SEQ 
						AND LNXX.LC_STA_LONXX = 'A'
						AND LNXX.LN_SEQ_PCV_ADJ_REQ = 
						(
							SELECT 
								max(LN_SEQ_PCV_ADJ_REQ) 
							FROM 
								CDW..LNXX_PCV_FIN_SCP MXXX 				
								INNER JOIN CDW..[CNHXXXXX] CNH
									ON CNH.BF_SSN = MXXX.BF_SSN
									AND CNH.LN_SEQ = MXXX.LN_SEQ
							WHERE	
								LNXX.BF_SSN = MXXX.BF_SSN 
								AND LNXX.LN_SEQ = MXXX.LN_SEQ 
								AND LNXX.LN_BR_DSB_SEQ = MXXX.LN_BR_DSB_SEQ 
								AND MXXX.LC_REV_REA = ' '
								AND EXISTS(SELECT X FROM CDW..LNXX_PCV_FIN_SCP LNXXA WHERE MXXX.BF_SSN = LNXXA.BF_SSN AND MXXX.LN_SEQ = LNXXA.LN_SEQ AND MXXX.LN_SEQ_PCV_ADJ_REQ = LNXXA.LN_SEQ_PCV_ADJ_REQ AND LNXXA.LC_STA_LONXX = 'A' AND LNXXA.LC_REV_REA = ' ' AND LNXXA.PC_FAT_TYP = 'XX' AND LNXXA.PC_FAT_SUB_TYP = 'XX')
				
						)
				) AS LNXXAMT
		FROM 
			CDW..LNXX_DSB LNXX
			INNER JOIN CDW..[CNHXXXXX] CNH
				ON CNH.BF_SSN = LNXX.BF_SSN
				AND CNH.LN_SEQ = LNXX.LN_SEQ

		WHERE 
			LNXX.LC_DSB_TYP IN ('X') 
			AND LNXX.LC_STA_LONXX IN ('X','X')
		GROUP BY 
			LNXX.BF_SSN, 
			LNXX.LN_SEQ, 
			LN_BR_DSB_SEQ
	) 
	TABX
	INNER JOIN CDW..FSXX_DL_LON FSXX 
		ON TABX.BF_SSN = FSXX.BF_SSN 
		AND TABX.LN_SEQ = FSXX.LN_SEQ
	GROUP BY 
		TABX.BF_SSN, 
		FSXX.LF_FED_AWD ,
		FSXX.LN_FED_AWD_SEQ
) DSB_AMT
	ON DSB_AMT.BF_SSN = CNH.BF_SSN
	AND DSB_AMT.LF_FED_AWD = CNH.LF_FED_AWD
	AND DSB_AMT.LN_FED_AWD_SEQ = CNH.LN_FED_AWD_SEQ