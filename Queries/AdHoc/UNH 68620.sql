USE UDW
GO

SELECT DISTINCT
	PD10.DF_PRS_ID,
	LTRIM(RTRIM(PD10.DM_PRS_1)) + LTRIM(RTRIM(PD10.DM_PRS_LST)) AS [NAME],
	LN10.BALANCE,
	CASE 
		WHEN AY10.PF_REQ_ACT = 'DITLF' THEN 'TLF'
		WHEN AY10.PF_REQ_ACT = 'DIFCR' THEN 'FALSE CERT'
		WHEN AY10.PF_REQ_ACT = 'DICSK' THEN 'CLOSED SCHOOL'
		WHEN AY10.PF_REQ_ACT = 'DIUPR' THEN 'UNPAID REFUND'
	END AS DISCHARGE_TYPE,
	AY10.LD_ATY_REQ_RCV AS APPLICATION_REC_DATE,
	PROCESSED.LD_ATY_REQ_RCV AS APP_PROCESSED_DATE,
	PROCESSED.LF_USR_REQ_ATY AS PROCESSING_AGENT
FROM
	UDW..AY10_BR_LON_ATY AY10
	INNER JOIN
	(
		SELECT 
			BF_SSN,
			SUM(LA_CUR_PRI) AS BALANCE
		FROM
			UDW..LN10_LON LN10
		GROUP BY
			BF_SSN
		
	) LN10
		ON LN10.BF_SSN = AY10.BF_SSN
	INNER JOIN UDW..PD10_PRS_NME PD10
		ON PD10.DF_PRS_ID = AY10.BF_SSN
	LEFT JOIN
	(
		SELECT	
			*
		FROM
			UDW..AY10_BR_LON_ATY
		WHERE PF_REQ_ACT = 'PRFRG'
		AND LD_ATY_REQ_RCV >= '04-01-2020'
	) PROCESSED
		ON PROCESSED.BF_SSN = AY10.BF_SSN
		AND PROCESSED.LD_ATY_REQ_RCV >= AY10.LD_ATY_REQ_RCV
WHERE
	AY10.PF_REQ_ACT IN ('DITLF','DIFCR','DICSK','DIUPR') 
	AND AY10.LC_STA_ACTY10 = 'A'
	AND AY10.LD_ATY_REQ_RCV BETWEEN '04/01/2020' AND GETDATE()