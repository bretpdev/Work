USE UDW
GO

--IF OBJECT_ID('tempdb..#BAL') IS NULL
--BEGIN

--SELECT * INTO #BAL FROM
--(
--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'10/31/2018' AS ME
--FROM
--	AuditUDW..LN10_LON_OCT2018 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'11/30/2018' AS ME
--FROM
--	AuditUDW..LN10_LON_Nov2018 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'12/31/2018' AS ME
--FROM
--	AuditUDW..LN10_LON_DEC2018 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'01/31/2019' AS ME
--FROM
--	AuditUDW..LN10_LON_JAN2019 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'02/28/2019' AS ME
--FROM
--	AuditUDW..LN10_LON_Feb2019 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'03/31/2019' AS ME
--FROM
--	AuditUDW..LN10_LON_Mar2019 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'04/30/2019' AS ME
--FROM
--	AuditUDW..LN10_LON_aPR2019 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'05/31/2019' AS ME
--FROM
--	AuditUDW..LN10_LON_May2019 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'06/30/2019' AS ME
--FROM
--	AuditUDW..LN10_LON_Jun2019 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'07/31/2019' AS ME
--FROM
--	AuditUDW..LN10_LON_Jul2019 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'08/30/2019' AS ME
--FROM
--	AuditUDW..LN10_LON_jUL2019 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'09/30/2019' AS ME
--FROM
--	AuditUDW..LN10_LON_Sep2019 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'10/31/2019' AS ME
--FROM
--	AuditUDW..LN10_LON_oct2019 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'11/30/2019' AS ME
--FROM
--	AuditUDW..LN10_LON_Oct2019 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'12/31/2019' as me
--FROM
--	AuditUDW..LN10_LON_Dec2019 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'01/31/2020' AS ME
--FROM
--	AuditUDW..LN10_LON_JAN2020 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'02/28/2020' AS ME
--FROM
--	AuditUDW..LN10_LON_Jan2020 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'03/31/2020' AS ME
--FROM
--	AuditUDW..LN10_LON_Mar2020 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'04/30/2020' AS ME
--FROM
--	AuditUDW..LN10_LON_aPR2020 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'05/31/2020' AS ME
--FROM
--	AuditUDW..LN10_LON_May2020 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'06/30/2020' AS ME
--FROM
--	AuditUDW..LN10_LON_Jun2020 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'07/31/2020' AS ME
--FROM
--	AuditUDW..LN10_LON_Jul2020 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'08/30/2020' AS ME
--FROM
--	AuditUDW..LN10_LON_Aug2020 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'09/30/2020' AS ME
--FROM
--	AuditUDW..LN10_LON_Sep2020 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'10/31/2020' AS ME
--FROM
--	AuditUDW..LN10_LON_Sep2020 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'11/30/2020' AS ME
--FROM
--	AuditUDW..LN10_LON_Nov2020 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'12/31/2020' as me
--FROM
--	AuditUDW..LN10_LON_Dec2020 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'01/31/2021' AS ME
--FROM
--	AuditUDW..LN10_LON_JAN2021 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'02/28/2021' AS ME
--FROM
--	AuditUDW..LN10_LON_Feb2021 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'03/31/2021' AS ME
--FROM
--	AuditUDW..LN10_LON_Mar2021 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'04/30/2021' AS ME
--FROM
--	AuditUDW..LN10_LON_aPR2021 LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--	UNION ALL

--SELECT 
--	LN10.BF_SSN,
--	LN_SEQ,
--	LA_CUR_PRI,
--	'05/31/2021' AS ME
--FROM
--	UDW..LN10_LON LN10
--WHERE
--	LN10.LA_CUR_PRI > 0
--	AND LN10.LC_STA_LON10 = 'R'

--) B
--END



SELECT DISTINCT
	AY10.BF_SSN,
	RTRIM(PD10.DM_PRS_1) as [FirstName],
	RTRIM(PD10.DM_PRS_LST) AS [LastName],
	LN10.IC_LON_PGM as LoanType,
	LN85.LN_SEQ as LoanNumber,
	LN10.LA_CUR_PRI as CurrentPrincipalBalance,
	LN10.LD_LON_1_DSB AS FirstDisbDate,
	LN15.DSB_AMT OriginalPrincipalBalance ,
	AY10.LD_ATY_REQ_RCV IBRCreateDate
FROM
	UDW..AY10_BR_LON_ATY AY10
	INNER JOIN UDW..PD10_PRS_NME PD10
		ON PD10.DF_PRS_ID = AY10.BF_SSN
	INNER JOIN UDW..LN85_LON_ATY LN85
		ON LN85.BF_SSN = AY10.BF_SSN
		AND LN85.LN_ATY_SEQ = AY10.LN_ATY_SEQ
	INNER JOIN UDW..LN10_LON LN10
		ON LN10.BF_SSN = LN85.BF_SSN
		AND LN10.LN_SEQ = LN85.LN_SEQ
	INNER JOIN
	(
		SELECT
			LN15.BF_SSN,
			LN15.LN_SEQ,
			SUM(ISNULL(LN15.LA_DSB,0) - ISNULL(LN15.LA_DSB_CAN,0)) AS  DSB_AMT
		FROM
			UDW..LN15_DSB LN15
		GROUP BY
			LN15.BF_SSN,
			LN15.LN_SEQ
	) LN15
		ON LN15.BF_SSN = LN85.BF_SSN
		AND LN15.LN_SEQ = LN85.LN_SEQ
	--left JOIN
	--(	--Adding Active Interest Rate
	--	SELECT
	--		LN72.BF_SSN, 
	--		LN72.LN_SEQ,
	--		LN72.LR_ITR,
	--		LN72.LD_ITR_EFF_BEG,
	--		LN72.LD_ITR_EFF_END
	--		FROM
	--		LN72_INT_RTE_HST LN72
	--	WHERE
	--		LN72.LC_STA_LON72 = 'A'
	--) LN72 
	--	ON LN10.BF_SSN = LN72.BF_SSN
	--	AND LN10.LN_SEQ = LN72.LN_SEQ
	--	AND AY10.LD_ATY_REQ_RCV BETWEEN LD_ITR_EFF_BEG AND LD_ITR_EFF_END
	--left JOIN #BAL B
	--	ON B.BF_SSN = LN85.BF_SSN
	--	AND B.LN_SEQ = LN85.LN_SEQ
	--	AND MONTH(B.ME) = MONTH(AY10.LD_ATY_REQ_RCV)
	--	AND YEAR(B.ME) = YEAR(AY10.LD_ATY_REQ_RCV)
	
		
WHERE
	PF_REQ_ACT = 'IBAPV'
	AND LC_STA_ACTY10 = 'A'
	AND LD_ATY_REQ_RCV >= '10/01/2018'
ORDER BY
	AY10.BF_SSN,
	LN85.LN_SEQ