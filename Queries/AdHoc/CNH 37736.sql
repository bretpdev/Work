USE CDW;
GO

SELECT DISTINCT
	LNXX.BF_SSN AS SSN
	,LNXX.LN_SEQ AS LoanSequence
	,COUNT(AYXX.PF_REQ_ACT) OVER(PARTITION BY AYXX.BF_SSN, AYXX.LN_ATY_SEQ, LNXX.LN_SEQ) AS NumberOfDICSKArcs
	,CAST(MAX(AYXX.LD_ATY_REQ_RCV) OVER(PARTITION BY AYXX.BF_SSN) AS DATE) AS DateOfDICSK
	,IIF(AYXX_DENIAL.BF_SSN IS NOT NULL, 'YES', 'NO') AS DenialArc
	,SCXX.IM_SCL_FUL AS OriginalSchool_SchoolCode
	,IIF(LNXX_WRITEOFF.WriteOff	IS NOT NULL, CAST(LNXX_WRITEOFF.WriteOff AS VARCHAR(XX)), 'NO') AS WriteOff
	,LNXX.LA_CUR_PRI AS CurrentLoanBalance
	,PDXX.DC_DOM_ST AS StateOfBorrowersResidence
FROM
	AYXX_BR_LON_ATY AYXX
	INNER JOIN LNXX_LON LNXX
		ON AYXX.BF_SSN = LNXX.BF_SSN
	INNER JOIN LNXX_LON_ATY LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
		AND AYXX.LN_ATY_SEQ = LNXX.LN_ATY_SEQ
	INNER JOIN SCXX_SCH_DMO SCXX
		ON LNXX.LF_DOE_SCL_ORG = SCXX.IF_DOE_SCL
	INNER JOIN PDXX_PRS_ADR PDXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
	LEFT JOIN
	(--denial arc
		SELECT
			AYXX.BF_SSN
			,LNXX.LN_SEQ
		FROM
			AYXX_BR_LON_ATY AYXX
			INNER JOIN LNXX_LON LNXX
				ON AYXX.BF_SSN = LNXX.BF_SSN
			INNER JOIN LNXX_LON_ATY LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
				AND AYXX.LN_ATY_SEQ = LNXX.LN_ATY_SEQ
		WHERE
			AYXX.PF_REQ_ACT = 'CSDNY'
			AND AYXX.LC_STA_ACTYXX = 'A'
	) AYXX_DENIAL
		ON LNXX.BF_SSN = AYXX_DENIAL.BF_SSN
		AND LNXX.LN_SEQ = AYXX_DENIAL.LN_SEQ
	LEFT JOIN
	(--write off
		SELECT
			BF_SSN
			,LN_SEQ
			,SUM(LA_FAT_NSI + LA_FAT_CUR_PRI) AS WriteOff
		FROM
			LNXX_FIN_ATY
		WHERE
			PC_FAT_TYP = 'XX'
			AND PC_FAT_SUB_TYP = 'XX'
			AND LC_STA_LONXX = 'A'
			AND LC_FAT_REV_REA = ''
		GROUP BY
			BF_SSN
			,LN_SEQ
	) LNXX_WRITEOFF
		ON LNXX.BF_SSN = LNXX_WRITEOFF.BF_SSN
		AND LNXX.LN_SEQ = LNXX_WRITEOFF.LN_SEQ
WHERE
	AYXX.PF_REQ_ACT = 'DICSK'
	AND AYXX.LC_STA_ACTYXX = 'A'
	AND PDXX.DI_VLD_ADR = 'Y' 
	AND PDXX.DC_ADR = 'L'
;
