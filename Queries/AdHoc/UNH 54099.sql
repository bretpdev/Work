SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT DISTINCT
	PD10.DF_SPE_ACC_ID,
	DW01.WC_DW_LON_STA,
	ISNULL(RS.LC_TYP_SCH_DIS, '') AS LC_TYP_SCH_DIS,
	CASE WHEN DW01.WC_DW_LON_STA = '04' THEN ISNULL(DEF.LC_DFR_TYP,'') ELSE '' END AS DEF_TYPE,
	CASE WHEN DW01.WC_DW_LON_STA = '05' THEN ISNULL(FORB.LC_FOR_TYP,'') ELSE '' END AS FORB_TYPE,
	CAST(ISNULL(FORB.Months,0) AS DECIMAL(14,3)) AS HardshipForbMonths,
	LN10.LN_SEQ,
	LN10.IC_LON_PGM,
	LN10.LA_CUR_PRI,
	ISNULL(RS.LA_RPS_ISL,0.00) AS LA_RPS_ISL,
	CASE WHEN LN83.BF_SSN IS NOT NULL THEN 'Y' ELSE 'N' END AS Autopay,
	CASE WHEN ISNULL(LN65HadIBR.IBRPFH,0) != 0 THEN 'Y' ELSE 'N' END AS HadIBRPFH,
	CASE WHEN ISNULL(LN65HadIBR.IBRPS,0) != 0 THEN 'Y' ELSE 'N' END AS HadIBRPS,
	CASE WHEN Applications.NewPlan != 0 AND Applications.Recertification = 0 THEN 'Y' ELSE 'N' END AS NewPlan,
	ISNULL(Applications.Received,0) AS Received,
	ISNULL(Applications.Pended,0) AS Pended,
	ISNULL(Applications.Denied,0) AS Denied
FROM
	UDW..PD10_PRS_NME PD10
	INNER JOIN UDW..LN10_LON LN10
		ON LN10.BF_SSN = PD10.DF_PRS_ID
	INNER JOIN UDW..DW01_DW_CLC_CLU DW01
		ON DW01.BF_SSN = LN10.BF_SSN
		AND DW01.LN_SEQ = LN10.LN_SEQ
	INNER JOIN OPENQUERY
	(
		DUSTER,
		'
		SELECT DISTINCT
			DF_PRS_ID
		FROM 
			OLWHRM1.PD31_PRS_INA
		WHERE
			DC_DOM_ST_HST = ''CT''
			AND DF_LST_DTS_PD31 BETWEEN (CURRENT DATE - 2 YEARS) AND CURRENT DATE
			AND SUBSTR(DF_PRS_ID, 1, 1) != ''P''

		UNION

		SELECT DISTINCT
			DF_PRS_ID
		FROM
			OLWHRM1.PD30_PRS_ADR
		WHERE
			DC_DOM_ST = ''CT''
			AND SUBSTR(DF_PRS_ID, 1, 1) != ''P''
			AND 
			(
				DF_LST_DTS_PD30 BETWEEN (CURRENT DATE - 2 YEARS) AND CURRENT DATE
				OR DI_VLD_ADR = ''Y''
			)
		'
	) CTAddr
		ON CTAddr.DF_PRS_ID = LN10.BF_SSN
	LEFT JOIN UDW.calc.RepaymentSchedules RS
		ON RS.BF_SSN = LN10.BF_SSN
		AND RS.LN_SEQ = LN10.LN_SEQ
		AND RS.CurrentGradation = 1
	LEFT JOIN
	(
		SELECT 
			LN50.BF_SSN,
			LN50.LN_SEQ,
			DF10.LC_DFR_TYP AS LC_DFR_TYP,
			MAX(LN50.LD_STA_LON50) AS LD_STA_LON50
		FROM
			UDW..LN50_BR_DFR_APV LN50
			INNER JOIN UDW..DF10_BR_DFR_REQ DF10
				ON DF10.BF_SSN = LN50.BF_SSN
				AND DF10.LF_DFR_CTL_NUM = LN50.LF_DFR_CTL_NUM
		WHERE
			LN50.LC_STA_LON50 = 'A'
			AND DF10.LC_STA_DFR10 = 'A'
			AND DF10.LC_DFR_STA = 'A'
			AND LN50.LC_DFR_RSP != '003'
			AND LN50.LD_DFR_BEG <= CAST(GETDATE() AS DATE)
			AND CAST(GETDATE() AS DATE) BETWEEN LN50.LD_DFR_BEG AND LN50.LD_DFR_END
		GROUP BY
			LN50.BF_SSN,
			LN50.LN_SEQ,
			DF10.LC_DFR_TYP
	) DEF
		ON DEF.BF_SSN = LN10.BF_SSN
		AND DEF.LN_SEQ = LN10.LN_SEQ
	LEFT JOIN
	(
		SELECT
			LN60.BF_SSN,
			LN60.LN_SEQ, 
			FB10.LC_FOR_TYP AS LC_FOR_TYP,
			MAX(LN60.LD_STA_LON60) AS LD_STA_LON60,
			CASE WHEN FB10.LC_FOR_TYP = '05' THEN SUM(CAST(DATEDIFF(DAY,LN60.LD_FOR_BEG,LN60.LD_FOR_END) AS DECIMAL(14,2))/CAST(30 AS DECIMAL(14,2))) ELSE 0 END AS Months
		FROM
			UDW..FB10_BR_FOR_REQ FB10
			INNER JOIN UDW..LN60_BR_FOR_APV LN60
				ON LN60.BF_SSN = FB10.BF_SSN
				AND LN60.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM
		WHERE
			LN60.LC_STA_LON60 = 'A'
			AND FB10.LC_STA_FOR10 = 'A'
			AND FB10.LC_FOR_STA = 'A'
			AND LN60.LC_FOR_RSP != '003'
			AND LN60.LD_FOR_BEG <= CAST(GETDATE() AS DATE)
			AND CAST(GETDATE() AS DATE) BETWEEN LN60.LD_FOR_BEG AND LN60.LD_FOR_END
		GROUP BY
			LN60.BF_SSN,
			LN60.LN_SEQ,
			FB10.LC_FOR_TYP
	) FORB
		ON FORB.BF_SSN = LN10.BF_SSN
		AND FORB.LN_SEQ = LN10.LN_SEQ
	LEFT JOIN
	(
		SELECT
			LN65.BF_SSN,
			LN65.LN_SEQ,
			SUM(CASE WHEN LN65.LC_TYP_SCH_DIS IN('IB') THEN 1 ELSE 0 END) OVER(PARTITION BY LN65.BF_SSN, LN65.LN_SEQ) AS IBRPFH,
			SUM(CASE WHEN LN65.LC_TYP_SCH_DIS IN('IL') THEN 1 ELSE 0 END) OVER(PARTITION BY LN65.BF_SSN, LN65.LN_SEQ) AS IBRPS
		FROM
			UDW..LN65_LON_RPS LN65
		WHERE
			LN65.LC_TYP_SCH_DIS IN ('IB','IL')
			AND 
			(
				LN65.LD_CRT_LON65 BETWEEN DATEADD(YEAR,-2,GETDATE()) AND GETDATE()
				OR LN65.LD_RPD_MAX_TRM_SR BETWEEN DATEADD(YEAR,-2,GETDATE()) AND GETDATE()
			)
	) LN65HadIBR
		ON LN65HadIBR.BF_SSN = LN10.BF_SSN
		AND LN65HadIBR.LN_SEQ = LN10.LN_SEQ
	LEFT JOIN
	(
		SELECT
			LN83.BF_SSN,
			LN83.LN_SEQ
		FROM
			UDW..LN83_EFT_TO_LON LN83
		WHERE
			LN83.LC_STA_LN83 = 'A'
	) LN83
		ON LN83.BF_SSN = LN10.BF_SSN
		AND LN83.LN_SEQ = LN10.LN_SEQ
	LEFT JOIN
	(
		SELECT
			B.SSN AS BF_SSN,
			CAST(L.loan_seq AS INT) AS LN_SEQ,
			COUNT(A.application_id) AS Received,
			SUM(CASE WHEN A.repayment_plan_reason_id = 1 THEN 1 ELSE 0 END) AS NewPlan,
			SUM(CASE WHEN A.repayment_plan_reason_id = 2 THEN 1 ELSE 0 END) AS Recertification,
			SUM(CASE WHEN A.repayment_plan_status_id = 6 THEN 1 ELSE 0 END) AS Pended,
			SUM(CASE WHEN A.repayment_plan_status_id = 3 THEN 1 ELSE 0 END) AS Denied
		FROM
			IncomeBasedRepaymentUheaa..Applications A
			INNER JOIN IncomeBasedRepaymentUheaa..Loans L
				ON L.application_id = A.application_id
			INNER JOIN IncomeBasedRepaymentUheaa..Borrowers B
				ON B.borrower_id = L.borrower_id
		GROUP BY
			B.SSN,
			CAST(L.loan_seq AS INT)
	) Applications
		ON Applications.BF_SSN = LN10.BF_SSN
		AND Applications.LN_SEQ = LN10.LN_SEQ
WHERE
	LN10.LC_STA_LON10 = 'R'
	AND LN10.LA_CUR_PRI > 0.00