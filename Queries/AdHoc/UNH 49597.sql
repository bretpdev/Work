--OLDEST OPEN LOAN
SELECT 
	* 
INTO 
	#OPEN_OLD
FROM 
	OPENQUERY 
	(DUSTER,'
		SELECT DISTINCT
			GA01.DF_PRS_ID_BR
			,MIN(GA10.AD_PRC) AS AD_PRC
			,GA10.AC_PRC_STA
			,GA14.AC_LON_STA_TYP
			,DC01.LC_STA_DC10
		FROM
			OLWHRM1.GA01_APP GA01
			INNER JOIN OLWHRM1.GA10_LON_APP GA10
				ON GA01.AF_APL_ID = GA10.AF_APL_ID
			INNER JOIN OLWHRM1.GA14_LON_STA GA14
				ON GA10.AF_APL_ID = GA14.AF_APL_ID
				AND GA10.AF_APL_ID_SFX = GA14.AF_APL_ID_SFX
			INNER JOIN OLWHRM1.DC01_LON_CLM_INF DC01
				ON GA10.AF_APL_ID = DC01.AF_APL_ID
				AND GA10.AF_APL_ID_SFX = DC01.AF_APL_ID_SFX
		WHERE
			GA10.AC_PRC_STA = ''A''
			AND GA14.AC_LON_STA_TYP IN (''CR'', ''DA'', ''FB'', ''IA'', ''ID'', ''IG'', ''IM'', ''RP'')
		GROUP BY
			GA01.DF_PRS_ID_BR
			,GA10.AC_PRC_STA
			,GA14.AC_LON_STA_TYP
			,DC01.LC_STA_DC10
	')

SELECT * FROM #OPEN_OLD ORDER BY AD_PRC
--DROP TABLE #OPEN_OLD

;WITH CTE AS (
	SELECT 
		DENSE_RANK() OVER (ORDER BY AD_PRC,DF_PRS_ID_BR) AS BORROWER
		,*	
		,'OPEN' AS STATUS
	FROM
		#OPEN_OLD
) 
SELECT 
	* 
FROM 
	CTE 
WHERE 
	BORROWER < 31
ORDER BY 
	BORROWER




--OLDEST CLOSED LOAN
SELECT 
	* 
INTO 
	#CLOSED_OLD
FROM 
	OPENQUERY 
	(DUSTER,'
		SELECT DISTINCT
			 GA01.DF_PRS_ID_BR
			,MIN(GA10.AD_PRC) AS AD_PRC
			,GA10.AC_PRC_STA
			,GA14.AC_LON_STA_TYP
			,DC01.LC_STA_DC10
		FROM
			OLWHRM1.GA01_APP GA01
			INNER JOIN OLWHRM1.GA10_LON_APP GA10
				ON GA01.AF_APL_ID = GA10.AF_APL_ID
			INNER JOIN OLWHRM1.GA14_LON_STA GA14
				ON GA10.AF_APL_ID = GA14.AF_APL_ID
				AND GA10.AF_APL_ID_SFX = GA14.AF_APL_ID_SFX
			INNER JOIN OLWHRM1.DC01_LON_CLM_INF DC01
				ON GA10.AF_APL_ID = DC01.AF_APL_ID
				AND GA10.AF_APL_ID_SFX = DC01.AF_APL_ID_SFX
		WHERE
			GA10.AC_PRC_STA = ''A''
			AND GA14.AC_LON_STA_TYP IN (''AE'', ''AL'', ''CA'', ''PC'', ''PF'', ''PM'', ''PN'', ''RF'', ''UA'', ''UB'', ''UC'', ''UD'', ''UI'')
		GROUP BY
			GA01.DF_PRS_ID_BR
			,GA10.AC_PRC_STA
			,GA14.AC_LON_STA_TYP
			,DC01.LC_STA_DC10
	')

SELECT * FROM #CLOSED_OLD ORDER BY AD_PRC
--DROP TABLE #CLOSED_OLD


;WITH CTE AS (
	SELECT 
		DENSE_RANK() OVER (ORDER BY AD_PRC,DF_PRS_ID_BR) AS BORROWER
		,*	
		,'CLOSED' AS STATUS
	FROM
		#CLOSED_OLD
) 
SELECT 
	* 
FROM 
	CTE 
WHERE 
	BORROWER < 31
ORDER BY 
	BORROWER


