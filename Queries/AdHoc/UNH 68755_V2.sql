USE UDW
GO

DECLARE @DATA TABLE(BF_SSN CHAR(9),	LN_SEQ INT, LN_CU_SEQ INT, [CURRENT LC_CU_STA] VARCHAR(10),	[NEW LC_CU-STA] VARCHAR(10), LD_CU_END DATE)
INSERT INTO @DATA VALUES
('084660736',1,1,'S','T','2019-08-28'),
('084660736',2,1,'S','T','2019-08-28'),
('084660736',3,1,'S','T','2019-08-28'),
('085703223',1,1,'S','T','2019-08-28'),
('143848232',1,2,'S','T','2019-10-29'),
('143848232',2,2,'S','T','2019-10-29'),
('143848232',3,2,'S','T','2019-10-29'),
('143848232',4,2,'S','T','2019-10-29'),
('151666844',2,1,'S','T','2019-12-03'),
('255591167',1,1,'S','T','2020-02-26'),
('255591167',2,1,'S','T','2020-02-26'),
('255591167',3,1,'S','T','2020-02-26'),
('287965076',1,1,'S','T','2019-08-28'),
('287965076',2,1,'S','T','2019-08-28'),
('362060069',2,1,'S','T','2019-09-11'),
('426311356',1,1,'S','T','2019-03-26'),
('426311356',2,1,'S','T','2019-03-26'),
('449775175',1,1,'S','T','2019-08-28'),
('449775175',2,1,'S','T','2019-08-28'),
('520118344',1,1,'S','T','2019-08-28'),
('520118344',2,1,'S','T','2019-08-28'),
('520118344',3,1,'S','T','2019-08-28'),
('528653940',23,1,'S','T','2019-10-30'),
('528653940',24,1,'S','T','2019-10-30'),
('528653940',25,1,'S','T','2019-10-30'),
('528653940',26,1,'S','T','2019-10-30'),
('528653940',27,1,'S','T','2019-10-30'),
('528653940',28,1,'S','T','2019-10-30'),
('528653940',29,1,'S','T','2019-10-30'),
('528653940',30,1,'S','T','2019-10-30'),
('528653940',31,1,'S','T','2019-10-30'),
('528653940',32,1,'S','T','2019-10-30'),
('528653940',33,1,'S','T','2019-10-30'),
('553559803',1,1,'S','T','2020-02-06'),
('553559803',2,1,'S','T','2020-02-06'),
('553559803',3,1,'S','T','2020-02-06'),
('567730991',5,1,'S','T','2019-08-28'),
('567730991',6,1,'S','T','2019-08-28'),
('610665051',9,1,'S','T','2019-08-28'),
('610665051',10,1,'S','T','2019-08-28'),
('610665051',11,1,'S','T','2019-08-28'),
('610665051',12,1,'S','T','2019-08-28'),
('632160902',1,1,'S','T','2019-11-20')

SELECT DISTINCT
	D.*,
	LN38.LN_CU_STA_SEQ
FROM
	@DATA D
	INNER JOIN UDW..LN38_CU_STA_HST LN38
		ON LN38.BF_SSN = D.BF_SSN
		AND LN38.LN_SEQ = D.LN_SEQ
		AND LN38.LC_CU_STA = D.[CURRENT LC_CU_STA]
	INNER JOIN 
	(
		SELECT
			BF_SSN,
			LN_SEQ,
			MAX(LF_LST_DTS_LN38) AS max_LF_LST_DTS_LN38
		FROM
			UDW..LN38_CU_STA_HST 
		GROUP BY
			BF_SSN,
			LN_SEQ
	) LN38_MAX
		ON LN38.BF_SSN = LN38_MAX.BF_SSN
		AND LN38.LN_SEQ = LN38_MAX.LN_SEQ
		AND LN38.LF_LST_DTS_LN38 = LN38_MAX.max_LF_LST_DTS_LN38
		