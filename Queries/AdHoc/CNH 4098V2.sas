LIBNAME  LEGEND  REMOTE  SERVER=LEGEND SLIBREF=work  ;
RSUBMIT LEGEND;
/*%let DB = DNFPRQUT;  *This is test;*/
/*%let DB = DNFPRUUT;  *This is VUKX test;*/
%let DB = DNFPUTDL;  *This is live;

LIBNAME PKUB DBX DATABASE=&DB OWNER=PKUB;
PROC SQL;
	CONNECT TO DBX (DATABASE=&DB);

	CREATE TABLE COLUMNS AS
		SELECT	
			*
		FROM	
			CONNECTION TO DBX 
				(
					SELECT 
						C.NAME AS COLUMN_NAME,
						C.TBNAME
						
					FROM
						sysibm.SYSCOLUMNS C
					INNER JOIN 
					(
						SELECT *
						FROM
							SYSIBM.TABLES
						WHERE TABLE_SCHEMA = 'PKUB'

					) T
					ON T.TABLE_NAME = C.TBNAME
					where COLTYPE like '%CHAR%'
					and LENGTH  = X
					AND C.TBNAME = 'SCXX_SCH_DMO'

					FOR READ ONLY WITH UR
				)
	;

	DISCONNECT FROM DBX;
QUIT;

ENDRSUBMIT;

PROC SQL;
CREATE TABLE RESULTS
(
	TAB CHAR(XXX),
	COL CHAR(XXX),
	VALUE CHAR(XXX),
	MODE INT
);
quit;

LIBNAME  LEGEND  REMOTE  SERVER=LEGEND SLIBREF=WORK;
DATA LEGEND.RESULTS; *Send data to Legend;
SET RESULTS;
RUN;

%MACRO CHECKCOLUMNS(TAB, COL) ;

%SYSLPUT TAB = &TAB;
%SYSLPUT COL = &COL;

RSUBMIT LEGEND;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;
PROC SQL;
	CREATE TABLE COUNT AS
		SELECT DISTINCT
			&COL AS VALUE
		FROM
			 PKUB.&TAB
		WHERE 
			&COL IN ('Y','N')
;
QUIT;
ENDRSUBMIT;

DATA COUNT;
SET LEGEND.COUNT;
TABLE = "&TAB";
COL = "&COL";
RUN;

PROC SQL;
INSERT INTO RESULTS(TAB, COL, VALUE, MODE)
SELECT TABLE, COL, VALUE, X FROM COUNT
;
QUIT;

RSUBMIT LEGEND;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;
PROC SQL;
	CREATE TABLE COUNT AS
		SELECT	DISTINCT
			&COL AS VALUE
		FROM
			 PKUB.&TAB
		WHERE
			&COL NOT IN ('Y','N')
;
QUIT;
ENDRSUBMIT;

DATA COUNT;
SET LEGEND.COUNT;
TABLE = "&TAB";
COL = "&COL";
RUN;

PROC SQL;
INSERT INTO RESULTS(TAB, COL, VALUE, MODE)
SELECT  TABLE, COL, VALUE, X FROM COUNT
;
QUIT;

  
%MEND  ;



DATA COLUMNS;
SET LEGEND.COLUMNS;
RUN;

DATA COLUMNSX;
	SET COLUMNS;

		CALL SYMPUT('T',TBNAME);
		CALL SYMPUT('C',COLUMN_NAME);
		CALL EXECUTE ('%CHECKCOLUMNS(&T, &C)');
RUN;


PROC SQL;	
	CREATE TABLE Y AS 
		SELECT
			*
		FROM
			RESULTS
		WHERE
			MODE = X
;
	CREATE TABLE N AS 
		SELECT
			*
		FROM
			RESULTS
		WHERE 
			MODE = X
;
	CREATE TABLE FINAL AS 
		SELECT DISTINCT
			Y.*
		FROM
			Y
		LEFT JOIN N
			ON N.COL = Y.COL
		WHERE
			N.COL IS NULL
;
QUIT;

DATA FINAL;
SET RESULTS;
WHERE COUNT > X;
RUN;

PROC EXPORT DATA = FINAL 
            OUTFILE = "T:\SAS\csnh XXXXvX.xls" 
            DBMS = EXCEL
			REPLACE;
     SHEET="A"; 
RUN;
