SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT DISTINCT 
	PDXX.DF_SPE_ACC_ID AS ACCOUNT_NUMBER,
	CAST(LNXX.LD_DLQ_OCC AS DATE) DATE_DELQ_OCC,
	LNXX.LN_DLQ_MAX DAYS_PAST_DUE,
	RSXX.LD_RPS_X_PAY_DU FIRST_PAY_DUE
FROM
	CDW..LNXX_LON LNXX
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = LNXX.BF_SSN
	INNER JOIN 
	(
		SELECT	
			BF_SSN,
			COUNT(*) AS C
		FROM
			CDW..RSXX_BR_RPD
		GROUP BY
			BF_SSN
	) RST
		ON RST.BF_SSN = LNXX.BF_SSN
	INNER JOIN 
	(
		SELECT	
			BF_SSN,
			COUNT(*) AS C
		FROM
			CDW..RSXX_BR_RPD
		WHERE 
			LC_STA_RPSTXX = 'A'
		GROUP BY
			BF_SSN
	) RSA
		ON RSA.BF_SSN = LNXX.BF_SSN
	INNER JOIN CDW..RSXX_BR_RPD RSXX
		ON RSXX.BF_SSN = LNXX.BF_SSN
	--inner join openquery(legend, 'select BF_SSN, LN_SEQ, LD_DLQ_OCC, LD_DLQ_MAX, LN_DLQ_MAX from pkus.LNXX_LON_DLQ_HST where LC_STA_LONXX = ''X''') lnXX
	INNER JOIN CDW..LNXX_LON_DLQ_HST LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
		AND LNXX.LC_STA_LONXX = 'X'
	LEFT JOIN CDW..LNXX_FIN_ATY LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
		AND LNXX.PC_FAT_TYP = 'XX'
	
WHERE
	LNXX.LA_CUR_PRI > X
	AND
	LNXX.LC_STA_LONXX = 'R'
	AND
	RSXX.LC_STA_RPSTXX = 'A'
	AND
	DATEDIFF(DAY, RSXX.LD_RPS_X_PAY_DU, GETDATE()) <= XX
	AND 
	LNXX.BF_SSN IS NULL --NEVER MADE A PAYMENT NOTE JOIN ON PAYMENT TYPE
	AND 
	LNXX.LD_DLQ_OCC < 'XX/XX/XXXX'
	AND 
	LNXX.LN_DLQ_MAX BETWEEN X AND XX
	AND 
	RSA.C = RST.C --NUMBER OF ACTIVE SCHEDULES = NUMBER OF TOTAL TO MAKE SURE WE HAVE ONLY PEOPLE WHO ARE THEIR FIRST SCHEDULE

	
