/*delete the first row of the Excel file attached to the Need Help ticket so the second row will be used for column names*/

LIBNAME LEGEND REMOTE SERVER=LEGEND SLIBREF=WORK;
LIBNAME XL 'T:\Trigger file for compare XXXXXX.XLSX';

RSUBMIT;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;

PROC SQL;
	CREATE TABLE SCHOOLS AS
		SELECT DISTINCT
			SCH_CODE,
			PUT(SCH_CODE,ZX.) AS SCH_CODE_X
		FROM
			XL.'CSPortCSV SepX$'N
	;
QUIT;

DATA LEGEND.SCHOOLS; SET SCHOOLS; RUN;

PROC SQL;
	CREATE TABLE NO_SCHOOL AS
		SELECT
			SCH.SCH_CODE,
			SCH.SCH_CODE_X,
			SCXX.IF_DOE_SCL
		FROM
			SCHOOLS SCH
			LEFT JOIN PKUB.SCXX_SCH_DMO SCXX
				ON SUBSTR(SCH.SCH_CODE_X,X,X) = SUBSTR(SCXX.IF_DOE_SCL,X,X)
		WHERE
			SCXX.IF_DOE_SCL IS NULL
	;

	CREATE TABLE SCHOOL_XREF AS
		SELECT
			SCH.SCH_CODE,
			SCH.SCH_CODE_X,
			SCXX.IF_DOE_SCL,
			SCXX.IM_SCL_SHO
		FROM
			SCHOOLS SCH
			LEFT JOIN PKUB.SCXX_SCH_DMO SCXX
				ON SUBSTR(SCH.SCH_CODE_X,X,X) = SUBSTR(SCXX.IF_DOE_SCL,X,X)
	;

	CREATE TABLE CS_SCHOOLS AS
		SELECT DISTINCT
			SCXX.IF_DOE_SCL
		FROM
			PKUB.SCXX_SCH_DMO SCXX
	;
QUIT;

ENDRSUBMIT;
DATA NO_SCHOOL; SET LEGEND.NO_SCHOOL; RUN;
DATA CS_SCHOOLS; SET LEGEND.CS_SCHOOLS; RUN;
DATA SCHOOL_XREF; SET LEGEND.SCHOOL_XREF; RUN;

PROC SQL;
	CREATE TABLE MISSES AS
		SELECT
			AWARD_ID,
			BF_SSN,
			LN_SEQ,
			SCH_CODE,
			SCH_TYPE,
			IF_DOE_SCL,
			IC_SCL_OWN_CTL_TYP
		FROM
			NSLDS
		WHERE
			IF_DOE_SCL NOT IN ('XXXXXXXX','XXXXXXXX','XXXXXXXX','XXXXXXXX','XXXXXXXX','XXXXXXXX')
			AND PUT(SCH_TYPE,X.) NE IC_SCL_OWN_CTL_TYP
	;
QUIT;

DATA LEGEND.MISSES; SET MISSES; RUN;
			
RSUBMIT;
PROC SQL;
	CREATE TABLE LNXXES AS
		SELECT 
			M.AWARD_ID,
			LNXX.*
		FROM
			MISSES M
			LEFT JOIN PKUB.LNXX_LON LNXX
				ON M.BF_SSN = LNXX.BF_SSN
				AND M.LN_SEQ = LNXX.LN_SEQ
	;
QUIT;
ENDRSUBMIT;
DATA LNXXES; SET LEGEND.LNXXES; RUN;

RSUBMIT;
PROC SQL;
	CREATE TABLE SCXXX AS
		SELECT
			*
		FROM
			PKUB.SCXX_SCH_DMO SCXX
		WHERE
			IF_DOE_SCL IN ('XXXXXXXX','XXXXXXXX')
	;
QUIT;
ENDRSUBMIT;
