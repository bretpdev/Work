LIBNAME LEGEND REMOTE SERVER=LEGEND SLIBREF=WORK;
RSUBMIT;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;
PROC SQL;
	CREATE TABLE DEFS AS
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			LNXX.LF_DFR_CTL_NUM,
			LNXX.LN_DFR_OCC_SEQ,
			INTCK('DAY',LNXX.LD_DFR_BEG,LNXX.LD_DFR_END) AS DF_DAYS
		FROM
			PKUB.DFXX_BR_DFR_REQ DFXX
			JOIN PKUB.LNXX_BR_DFR_APV LNXX
				ON DFXX.BF_SSN = LNXX.BF_SSN
				AND DFXX.LF_DFR_CTL_NUM = LNXX.LF_DFR_CTL_NUM
		WHERE
			DFXX.LC_DFR_TYP = 'XX'
			AND DFXX.LC_DFR_STA = 'A' 
			AND DFXX.LC_STA_DFRXX = 'A' 
			AND LNXX.LC_STA_LONXX = 'A' 
			AND LNXX.LC_DFR_RSP ^= 'XXX'
		ORDER BY
			LNXX.BF_SSN,
			LNXX.LN_SEQ
	;
QUIT;

PROC SQL;
	CREATE TABLE LN_DAYS AS
		SELECT DISTINCT 
			BF_SSN,
			LN_SEQ,
			SUM(DF_DAYS) AS DF_DAYS
		FROM 
			DEFS
		GROUP BY
			BF_SSN,
			LN_SEQ
		ORDER BY
			BF_SSN
	;
QUIT;

PROC SQL;
	CREATE TABLE MAX_DAYS AS
		SELECT DISTINCT 
			BF_SSN,
			MAX(DF_DAYS) + X AS DF_DAYS
		FROM 
			LN_DAYS
		GROUP BY
			BF_SSN
		ORDER BY
			BF_SSN
	;		
QUIT;

PROC SQL;
	CREATE TABLE EH_DEF_XX AS
		SELECT DISTINCT 
			BF_SSN,
			DF_DAYS
		FROM 
			MAX_DAYS
		WHERE
			DF_DAYS > XXXX
		ORDER BY
			BF_SSN
	;
QUIT;

ENDRSUBMIT; 

/*DATA DEFS; SET LEGEND.DEFS; RUN;*/
/*DATA LN_DAYS; SET LEGEND.LN_DAYS; RUN;*/
/*DATA MAX_DAYS; SET LEGEND.MAX_DAYS; RUN;*/
DATA EH_DEF_XX; SET LEGEND.EH_DEF_XX; RUN;

PROC EXPORT
		DATA=EH_DEF_XX
		OUTFILE='T:\Query for EH Deferments - XX Months Used.XLSX'
		REPLACE;
RUN;
