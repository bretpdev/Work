SELECT
	TX.BF_SSN,
	DP.AccountIdentifier,
	D.Document,
	DP.AddedAt,
	TX.BF_SSN,
	CentralData.dbo.TRIM(PDXX.DM_PRS_LST) AS LastName,
	CentralData.dbo.TRIM(PDXX.DM_PRS_X) AS FirstName,
	CONVERT(VARCHAR, LNXX.LD_LON_GTR, XXX) AS GuarantyDate
FROM
	CDW..CS_TransferX TX
	INNER JOIN CDW..CS_TransferXLoans TL
		ON TX.BF_SSN = TL.BF_SSN
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = TX.BF_SSN
	INNER JOIN 
	(
		SELECT DISTINCT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			SUM(COALESCE(LA_FAT_CUR_PRI,X.XX)) AS LA_FAT_CUR_PRI,
			SUM(COALESCE(LA_FAT_NSI,X.XX)) AS LA_FAT_NSI,
			MAX(LD_FAT_EFF) AS LD_FAT_EFF
		FROM
			CDW..LNXX_FIN_ATY LNXX
			INNER JOIN CDW..LNXX_LON LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
				AND LNXX.LA_CUR_PRI >= X.XX
				AND LNXX.LC_FED_PGM_YR = 'LNC'
				AND LNXX.LD_PIF_RPT IS NULL		
			INNER JOIN CDW..CS_TransferXLoans TL
                ON TL.BF_SSN = LNXX.BF_SSN
                AND TL.LN_SEQ = LNXX.LN_SEQ
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND COALESCE(LNXX.LC_FAT_REV_REA,'') = ''
			AND LNXX.PC_FAT_TYP = 'XX'
			AND LNXX.PC_FAT_SUB_TYP = 'XX'
		GROUP BY
			LNXX.BF_SSN,
			LNXX.LN_SEQ
	) Trans
		ON Trans.BF_SSN = TL.BF_SSN
		AND Trans.LN_SEQ = TL.LN_SEQ
	INNER JOIN CLS.docid.DocumentsProcessed DP
		ON DP.AccountIdentifier = TL.BF_SSN
	INNER JOIN CLS.docid.Documents D
		ON D.DocumentsId = DP.DocumentsId
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = TX.BF_SSN
		AND LNXX.LN_SEQ = TL.LN_SEQ
WHERE
	CAST(DP.AddedAt AS DATE) = CAST(DATEADD(DAY,-X,GETDATE()) AS DATE)

UNION ALL

SELECT
	TX.BF_SSN,
	DP.AccountIdentifier,
	D.Document,
	DP.AddedAt,
	TX.BF_SSN,
	CentralData.dbo.TRIM(PDXX.DM_PRS_LST) AS LastName,
	CentralData.dbo.TRIM(PDXX.DM_PRS_X) AS FirstName,
	CONVERT(VARCHAR, LNXX.LD_LON_GTR, XXX) AS GuarantyDate
FROM
	CDW..CS_TransferX TX
	INNER JOIN CDW..CS_TransferXLoans TL
		ON TX.BF_SSN = TL.BF_SSN
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = TX.BF_SSN
	INNER JOIN 
	(
		SELECT DISTINCT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			SUM(COALESCE(LA_FAT_CUR_PRI,X.XX)) AS LA_FAT_CUR_PRI,
			SUM(COALESCE(LA_FAT_NSI,X.XX)) AS LA_FAT_NSI,
			MAX(LD_FAT_EFF) AS LD_FAT_EFF
		FROM
			CDW..LNXX_FIN_ATY LNXX
			INNER JOIN CDW..LNXX_LON LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
				AND LNXX.LA_CUR_PRI >= X.XX
				AND LNXX.LC_FED_PGM_YR = 'LNC'
				AND LNXX.LD_PIF_RPT IS NULL		
			INNER JOIN CDW..CS_TransferXLoans TL
                ON TL.BF_SSN = LNXX.BF_SSN
                AND TL.LN_SEQ = LNXX.LN_SEQ
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND COALESCE(LNXX.LC_FAT_REV_REA,'') = ''
			AND LNXX.PC_FAT_TYP = 'XX'
			AND LNXX.PC_FAT_SUB_TYP = 'XX'
		GROUP BY
			LNXX.BF_SSN,
			LNXX.LN_SEQ
	) Trans
		ON Trans.BF_SSN = TL.BF_SSN
		AND Trans.LN_SEQ = TL.LN_SEQ
	INNER JOIN CLS.docid.DocumentsProcessed DP
		ON DP.AccountIdentifier = PDXX.DF_SPE_ACC_ID
	INNER JOIN CLS.docid.Documents D
		ON D.DocumentsId = DP.DocumentsId
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = TX.BF_SSN
		AND LNXX.LN_SEQ = TL.LN_SEQ
WHERE
	CAST(DP.AddedAt AS DATE) = CAST(DATEADD(DAY,-X,GETDATE()) AS DATE)
