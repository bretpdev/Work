USE CDW
GO
--Issue:
--We need to identify any loans where there is an active Type XX and/or XX Forbearance with Begin Date prior to the Repayment Start Date.

--Output:
--Account Number
--Loan Sequence
--Forbearance Type 
--Forbearance Begin/End Dates
--Repayment Start Date


SELECT DISTINCT
	PDXX.DF_SPE_ACC_ID,
	LNXX.LN_SEQ,
	FBXX.LC_FOR_TYP,
	LNXX.LD_FOR_BEG,
	LNXX.LD_FOR_END,
	DWXX.WD_LON_RPD_SR
FROM
	CDW..PDXX_PRS_NME PDXX
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
		AND LNXX.LA_CUR_PRI > X.XX
		AND LNXX.LC_STA_LONXX = 'R'
	INNER JOIN CDW..LNXX_BR_FOR_APV LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
		AND LNXX.LC_FOR_RSP != 'XXX'
		AND LNXX.LC_STA_LONXX = 'A'
		AND CAST(GETDATE() AS DATE) BETWEEN CAST(LNXX.LD_FOR_BEG AS DATE) AND CAST(LNXX.LD_FOR_END AS DATE)
	INNER JOIN CDW..FBXX_BR_FOR_REQ FBXX
		ON FBXX.BF_SSN = LNXX.BF_SSN
		AND FBXX.LF_FOR_CTL_NUM = LNXX.LF_FOR_CTL_NUM
		AND FBXX.LC_STA_FORXX = 'A'
		AND FBXX.LC_FOR_STA = 'A'
		AND FBXX.LC_FOR_TYP IN('XX','XX')
	INNER JOIN CDW..DWXX_DW_CLC_CLU DWXX
		ON DWXX.BF_SSN = LNXX.BF_SSN
		AND DWXX.LN_SEQ = LNXX.LN_SEQ
		AND CAST(DWXX.WD_LON_RPD_SR AS DATE) > CAST(LNXX.LD_FOR_BEG AS DATE)
ORDER BY
	PDXX.DF_SPE_ACC_ID,
	LNXX.LN_SEQ