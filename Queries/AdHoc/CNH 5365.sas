LIBNAME LEGEND REMOTE SERVER=LEGEND SLIBREF=WORK;
RSUBMIT;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;

PROC SQL;
	CREATE TABLE ADDRS AS
		SELECT DISTINCT
			PDXX.DF_SPE_ACC_ID,
			PDXX.DF_PRS_ID,
			PDXX.DX_STR_ADR_X,
			PDXX.DX_STR_ADR_X, 
			PDXX.DM_CT, 
			PDXX.DC_DOM_ST, 
			PDXX.DF_ZIP_CDE,
			CATX(' ',PDXX.DX_STR_ADR_X,PDXX.DX_STR_ADR_X,PDXX.DM_CT,PDXX.DC_DOM_ST,PDXX.DF_ZIP_CDE) AS ADDR
		FROM
			PKUB.PDXX_PRS_NME PDXX
			JOIN PKUB.PDXX_PRS_ADR PDXX
				ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
		WHERE
			PDXX.DI_VLD_ADR = 'Y'
			AND SUBSTR(PDXX.DF_PRS_ID,X,X) NE 'P'
	;
	
	CREATE TABLE CNTS AS
		SELECT
			COUNT(DISTINCT DF_SPE_ACC_ID) AS CNT,
			ADDR
		FROM
			ADDRS
		GROUP BY
			ADDR
	;

	CREATE TABLE MULTS AS
		SELECT
			ADDRS.DF_SPE_ACC_ID,
			ADDRS.DX_STR_ADR_X,
			ADDRS.DX_STR_ADR_X, 
			ADDRS.DM_CT, 
			ADDRS.DC_DOM_ST, 
			ADDRS.DF_ZIP_CDE
		FROM
			CNTS
			JOIN ADDRS
				ON CNTS.ADDR = ADDRS.ADDR
		WHERE
			CNTS.CNT GE X
		ORDER BY
			ADDRS.ADDR,
			ADDRS.DF_SPE_ACC_ID
	;
QUIT;

ENDRSUBMIT;

DATA MULTS; SET LEGEND.MULTS; RUN;

PROC EXPORT
		DATA=MULTS
		OUTFILE='T:\SAS\COMMON ADDRESSES.XLSX'
		REPLACE;
RUN;
