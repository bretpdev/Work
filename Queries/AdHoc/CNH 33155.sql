USE CDW
GO

DECLARE @BEGINDATE DATE = 'XX/XX/XXXX';
DECLARE @ENDDATE DATE = 'XX/XX/XXXX';
--SELECT @BEGINDATE,@ENDDATE

;WITH ARCS AS
(
	SELECT
		ROW_NUMBER() OVER(PARTITION BY BF_SSN ORDER BY BF_SSN, LN_ATY_SEQ DESC) [ROWNUM]
		,BF_SSN
		,LN_ATY_SEQ
		,CAST(LD_ATY_REQ_RCV AS DATE) [LD_ATY_REQ_RCV]
		,PF_REQ_ACT
		,CASE
			WHEN PF_REQ_ACT = 'DICSK'
			THEN 'application received'
			WHEN PF_REQ_ACT = 'CSDNY'
			THEN 'denied'
			WHEN PF_REQ_ACT = 'ADCSH'
			THEN 'approved'
			WHEN PF_REQ_ACT = 'CSFSA'
			THEN 'pending'
		END AS 'Application Status'
	FROM
		AYXX_BR_LON_ATY
	WHERE
		PF_REQ_ACT IN ('DICSK','CSDNY','ADCSH','CSFSA')
		AND LD_ATY_REQ_RCV BETWEEN @BEGINDATE AND @ENDDATE
	--ORDER BY 
	--	BF_SSN
	--	,LN_ATY_SEQ
)
SELECT 
	BF_SSN
	,LN_ATY_SEQ
	,LD_ATY_REQ_RCV
	,PF_REQ_ACT
	,[Application Status]	
FROM
	ARCS
WHERE ROWNUM = X --current status
ORDER BY 
	BF_SSN
	,LN_ATY_SEQ
