DROP TABLE IF EXISTS #DATA
DROP TABLE IF EXISTS #DATAX


SELECT DISTINCT
	 DF_SPE_ACC_ID,
	 DF_PRS_ID
INTO #DATA
FROM
(
SELECT DISTINCT
	PDXX.DF_SPE_ACC_ID,
	PDXX.DF_PRS_ID
FROM
	CDW..PDXX_PRS_ADR PDXX
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
WHERE
	DC_DOM_ST = 'WA'
	AND DC_ADR = 'L'
	AND DD_VER_ADR <= 'XX/XX/XXXX'
	AND DI_VLD_ADR = 'Y'

UNION ALL

SELECT DISTINCT
	PDXX.DF_SPE_ACC_ID,
	PDXX.DF_PRS_ID
FROM
	CDW..PDXX_PRS_INA PDXX
		INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
	INNER JOIN
	(
		SELECT
			DF_PRS_ID,
			MAX(DN_ADR_SEQ) AS DN_ADR_SEQ
		FROM
			CDW..PDXX_PRS_INA
		WHERE
			DD_VER_ADR_HST <= 'XX/XX/XXXX'
			AND DC_ADR_HST = 'L'
		GROUP BY
			DF_PRS_ID
	) MPDXX
		ON MPDXX.DF_PRS_ID = PDXX.DF_PRS_ID
		AND MPDXX.DN_ADR_SEQ = PDXX.DN_ADR_SEQ
WHERE
	DC_DOM_ST_HST = 'WA'
) POP


SELECT
	D.DF_SPE_ACC_ID AS ACCOUNT_NUMBER,
	SUM(LA_CUR_PRI) AS [BALANCE AS OF XX-XXXX]
FROM
	#DATA D
	INNER JOIN AuditCDW..LNXX_LON_DECXXXX LNXX
		ON LNXX.BF_SSN = D.DF_PRS_ID
		AND LNXX.LC_STA_LONXX = 'R'
		AND LNXX.LA_CUR_PRI > X
GROUP BY
	D.DF_SPE_ACC_ID

SELECT
	D.DF_SPE_ACC_ID AS ACCOUNT_NUMBER,
	LNXX.LN_SEQ AS LOAN_SEQ,
	LNXX.LA_CUR_PRI AS CURRENT_BALANCE,
	LNXX.LD_DSB AS FIRST_DSB_DATE,
	LNXX.DSB_AMT AS FIRST_DSB_AMT
FROM
	#DATA D
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = D.DF_PRS_ID
	INNER JOIN
	(
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			LNXX.LD_DSB,
			SUM((LA_DSB - ISNULL(LA_DSB_CAN,X))) AS DSB_AMT
		FROM
			CDW..LNXX_DSB LNXX
			INNER JOIN 
			(
				SELECT
					BF_SSN,
					LN_SEQ,
					MIN(LD_DSB) AS MIN_LD_DSB
				FROM
					CDW..LNXX_DSB
				WHERE 
					LC_STA_LONXX IN ('X','X')
				GROUP BY
					BF_SSN,
					LN_SEQ
			) MLNXX
				ON MLNXX.BF_SSN = LNXX.BF_SSN
				AND MLNXX.LN_SEQ = LNXX.LN_SEQ
				AND MLNXX.MIN_LD_DSB = LNXX.LD_DSB
		WHERE 
			LC_STA_LONXX IN ('X','X')
		GROUP BY
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			LNXX.LD_DSB
	) LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
WHERE
	YEAR(LNXX.LD_LON_EFF_ADD) = XXXX
ORDER BY 
	LNXX.LD_DSB

SELECT DISTINCT
	 DF_SPE_ACC_ID,
	 DF_PRS_ID
INTO #DATAX
FROM
(
SELECT DISTINCT
	PDXX.DF_SPE_ACC_ID,
	PDXX.DF_PRS_ID
FROM
	CDW..PDXX_PRS_ADR PDXX
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
WHERE
	DC_DOM_ST = 'WA'
	AND DC_ADR = 'L'
	AND DD_VER_ADR <= 'XX/XX/XXXX'
	AND DI_VLD_ADR = 'Y'

UNION ALL

SELECT DISTINCT
	PDXX.DF_SPE_ACC_ID,
	PDXX.DF_PRS_ID
FROM
	CDW..PDXX_PRS_INA PDXX
		INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
	INNER JOIN
	(
		SELECT
			DF_PRS_ID,
			MAX(DN_ADR_SEQ) AS DN_ADR_SEQ
		FROM
			CDW..PDXX_PRS_INA
		WHERE
			DD_VER_ADR_HST <= 'XX/XX/XXXX'
			AND DC_ADR_HST = 'L'
		GROUP BY
			DF_PRS_ID
	) MPDXX
		ON MPDXX.DF_PRS_ID = PDXX.DF_PRS_ID
		AND MPDXX.DN_ADR_SEQ = PDXX.DN_ADR_SEQ
WHERE
	DC_DOM_ST_HST = 'WA'
) POP

SELECT
	D.DF_SPE_ACC_ID AS ACCOUNT_NUMBER,
	SUM(LA_CUR_PRI) AS [BALANCE AS OF XX-XXXX]
FROM
	#DATAX D
	INNER JOIN AuditCDW..LNXX_LON_DECXXXX LNXX
		ON LNXX.BF_SSN = D.DF_PRS_ID
		AND LNXX.LC_STA_LONXX = 'R'
		AND LNXX.LA_CUR_PRI > X
	LEFT JOIN #DATA DX
		ON DX.DF_PRS_ID = D.DF_PRS_ID
WHERE
	DX.DF_PRS_ID IS NULL
GROUP BY
	D.DF_SPE_ACC_ID