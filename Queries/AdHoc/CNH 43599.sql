USE CDW
GO

DROP TABLE IF EXISTS #DATA

SELECT 
	Dense_rank() OVER( ORDER BY TX.BF_SSN) AS RN,
	TX.BF_SSN AS SSN,
	lnXX.ln_seq,
	FSXX.LF_FED_AWD + RIGHT('XXX' + CAST(FSXX.LN_FED_AWD_SEQ AS VARCHAR(XX)),X) AS AWARD_ID,
	RTRIM(PDXX.DM_PRS_LST) AS LAST_NAME,
	CONVERT(VARCHAR,PDXX.DD_BRT, XXX) AS DATE_OF_BIRTH,
	ISNULL(EMAIL.EmailAddress, 'N/A') AS EMAIL_ADDRESS,
	ABS(LNXX.LA_FAT_CUR_PRI) AS PRINCIPAL_TRANSFERED,
	ABS(LNXX.LA_FAT_NSI) AS INTEREST_TRANSFERED,
	LNXX.LA_CUR_PRI AS CURRENT_PRINCIPAL,
	DWXX.WA_TOT_BRI_OTS AS CURRENT_INTEREST,
	ISNULL(LNXX.LA_TOT_PRI_PD_PCV,X.XX) + ISNULL(TOTAL_PAID.LA_FAT_CUR_PRI,X.XX) AS PBO_PAID,
	TP.[PH Prin Paid],
	ISNULL(LNXX.LA_TOT_INT_PD_PCV,X.XX) + ISNULL(TOTAL_PAID.LA_FAT_NSI,X.XX) AS INTEREST_PAID,
	ISNULL(LNXX.LA_ORG_CAP_INT,X.XX) + ISNULL(CAP.LA_FAT_CUR_PRI,X.XX) AS TOTAL_CAPITIALIZED_INTEREST,
	LNXX.LD_LON_X_DSB AS EARLIEST_DISBURSEMENT_DATE,
	DSB_AMT.DSB_AMT AS DISBURSEMENT_AMOUNT
into #data
FROM
	CDW..CS_TransferXLoans TX
	INNER JOIN 
	(
		SELECT DISTINCT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			SUM(COALESCE(LA_FAT_CUR_PRI,X.XX)) AS LA_FAT_CUR_PRI,
			SUM(COALESCE(LA_FAT_NSI,X.XX)) AS LA_FAT_NSI
		FROM
			CDW..LNXX_FIN_ATY LNXX
			INNER JOIN CDW..CS_TransferX TX
				ON TX.BF_SSN = LNXX.BF_SSN
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND COALESCE(LNXX.LC_FAT_REV_REA,'') = ''
			AND LNXX.PC_FAT_TYP = 'XX'
			AND LNXX.PC_FAT_SUB_TYP = 'XX'
			AND LNXX.LD_FAT_EFF = 'XX/XX/XXXX'
		GROUP BY
			LNXX.BF_SSN,
			LNXX.LN_SEQ
	) LNXX
		ON LNXX.BF_SSN = TX.BF_SSN
		AND LNXX.LN_SEQ = TX.LN_SEQ
	INNER JOIN CDW..FSXX_DL_LON FSXX
		ON FSXX.BF_SSN = TX.BF_SSN
		AND FSXX.LN_SEQ = TX.LN_SEQ
	INNER JOIN CDW..[TransferXPrinPd] TP
		ON TP.[PBO Prin Pd award] = FSXX.LF_FED_AWD + RIGHT('XXX' + CAST(FSXX.LN_FED_AWD_SEQ AS VARCHAR(XX)),X)
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = TX.BF_SSN
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = TX.BF_SSN
		AND LNXX.LN_SEQ = TX.LN_SEQ
	INNER JOIN CDW..DWXX_DW_CLC_CLU DWXX
		ON DWXX.BF_SSN = TX.BF_SSN
		AND DWXX.LN_SEQ = TX.LN_SEQ
	LEFT JOIN CDW..LNXX_RPD_PIO_CVN LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	LEFT JOIN 
	(
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			SUM(ABS(COALESCE(LA_FAT_CUR_PRI,X.XX))) AS LA_FAT_CUR_PRI,
			SUM(ABS(COALESCE(LA_FAT_NSI,X.XX))) AS LA_FAT_NSI
		FROM
			CDW..LNXX_FIN_ATY LNXX
			INNER JOIN CDW..CS_TransferX TX
				ON TX.BF_SSN = LNXX.BF_SSN
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND COALESCE(LNXX.LC_FAT_REV_REA,'') = ''
			AND LNXX.PC_FAT_TYP = 'XX'
			AND LNXX.PC_FAT_SUB_TYP = 'XX'
		GROUP BY
			LNXX.BF_SSN,
			LNXX.LN_SEQ
	) TOTAL_PAID
		ON TOTAL_PAID.BF_SSN = TX.BF_SSN
		AND TOTAL_PAID.LN_SEQ = TX.LN_SEQ
	LEFT JOIN 
	( 
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			SUM(LNXX.LA_FAT_CUR_PRI) AS LA_FAT_CUR_PRI
		FROM
			LNXX_FIN_ATY LNXX
			INNER JOIN CDW..CS_TransferX TX
				ON TX.BF_SSN = LNXX.BF_SSN
		WHERE
			LNXX.PC_FAT_TYP = 'XX' 
			AND LNXX.PC_FAT_SUB_TYP = 'XX'
			AND LNXX.LC_STA_LONXX = 'A'
			AND COALESCE(LNXX.LC_FAT_REV_REA,'') = '' 
		GROUP BY
			LNXX.BF_SSN,
			LNXX.LN_SEQ
	) CAP 
		ON CAP.BF_SSN = LNXX.BF_SSN
		AND CAP.LN_SEQ = LNXX.LN_SEQ
	LEFT JOIN
	(
		SELECT DISTINCT
			EmailOrdering.DF_PRS_ID,
			EmailOrdering.EmailAddress
		FROM
			(
				SELECT
					EmailPrioritizing.DF_PRS_ID,
					EmailPrioritizing.EmailAddress,
					ROW_NUMBER() OVER (PARTITION BY EmailPrioritizing.DF_PRS_ID ORDER BY EmailPrioritizing.PriorityNumber) AS EmailPriority --number in order of Email.PriorityNumber
				FROM
					(
						SELECT DISTINCT
							PDXX.DF_PRS_ID,
							ISNULL(PHXX.DX_CNC_EML_ADR, PDXX.DX_ADR_EML) AS EmailAddress,
							CASE 
								WHEN PHXX.DX_CNC_EML_ADR IS NOT NULL THEN X 
								WHEN PDXX.DC_ADR_EML = 'H' THEN X 
								WHEN PDXX.DC_ADR_EML = 'A' THEN X 
								WHEN PDXX.DC_ADR_EML = 'W' THEN X 
							END AS PriorityNumber
						FROM
							PDXX_PRS_NME PDXX
							INNER JOIN CDW..CS_TransferX TX
									ON TX.BF_SSN = PDXX.DF_PRS_ID
							LEFT JOIN PHXX_CNC_EML PHXX
								ON PHXX.DF_SPE_ID = PDXX.DF_SPE_ACC_ID
								AND PHXX.DI_VLD_CNC_EML_ADR = 'Y' 
							LEFT JOIN PDXX_PRS_ADR_EML PDXX
								ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
								AND PDXX.DI_VLD_ADR_EML = 'Y' 
								AND PDXX.DC_STA_PDXX = 'A' 
						WHERE
							PDXX.DF_PRS_ID LIKE '[X-X]%' 
					) EmailPrioritizing
				WHERE
					EmailPrioritizing.EmailAddress IS NOT NULL 
			) EmailOrdering
		WHERE
			EmailOrdering.EmailPriority = X 
	) EMAIL
		ON EMAIL.DF_PRS_ID = TX.BF_SSN
	LEFT JOIN 
	(
		SELECT 
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			SUM(LNXX.LA_DSB) AS DSB_AMT
		FROM 
			CDW..LNXX_DSB LNXX
			INNER JOIN CDW..CS_TransferX TX
				ON TX.BF_SSN = LNXX.BF_SSN
		WHERE 
			LC_DSB_TYP = X 
			AND LC_STA_LONXX = X
		GROUP BY
			LNXX.BF_SSN,
			LNXX.LN_SEQ
	) DSB_AMT
		ON DSB_AMT.BF_SSN = TX.BF_SSN
		AND DSB_AMT.LN_SEQ = TX.LN_SEQ

SELECT 
	D.* 
FROM 
	#DATA D
WHERE PBO_PAID != [PH Prin Paid]
order by rn