LIBNAME LEGEND REMOTE SERVER=LEGEND SLIBREF=WORK;
RSUBMIT;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;
PROC SQL;
	CREATE TABLE SANTACLARA AS
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			DWXX.WC_DW_LON_STA,
			COALESCE(LNXX.LN_DLQ_MAX,X) AS LN_DLQ_MAX,
			DEFR.LD_DFR_BEG,
			DEFR.LD_DFR_END
		FROM
			PKUB.LNXX_LON LNXX
			JOIN PKUB.DWXX_DW_CLC_CLU DWXX
				ON LNXX.BF_SSN = DWXX.BF_SSN
				AND LNXX.LN_SEQ = DWXX.LN_SEQ
			LEFT JOIN PKUB.LNXX_LON_DLQ_HST LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
				AND LC_STA_LONXX = 'X'
			LEFT JOIN
				(
					SELECT
						LNXX.BF_SSN,
						LNXX.LN_SEQ,
						LNXX.LD_DFR_BEG,
						LNXX.LD_DFR_END
					FROM
						PKUB.DFXX_BR_DFR_REQ DFXX
						JOIN PKUB.LNXX_BR_DFR_APV LNXX
							ON DFXX.BF_SSN = LNXX.BF_SSN
							AND DFXX.LF_DFR_CTL_NUM = LNXX.LF_DFR_CTL_NUM
					WHERE
						DFXX.LC_DFR_STA = 'A'
						AND LNXX.LC_STA_LONXX = 'A'
						AND 
							(
								LNXX.LD_DFR_BEG BETWEEN 'XXAUGXXXX'D AND 'XXMAYXXXX'D
								OR LNXX.LD_DFR_END BETWEEN 'XXAUGXXXX'D AND 'XXMAYXXXX'D
							)
				) DEFR
				ON LNXX.BF_SSN = DEFR.BF_SSN
				AND LNXX.LN_SEQ = DEFR.LN_SEQ
		WHERE
			LNXX.LF_DOE_SCL_ORG = 'XXXXXXXX'
			AND LNXX.LN_DLQ_MAX > XXX OR DEFR.BF_SSN IS NOT NULL
		ORDER BY
			LNXX.BF_SSN,
			LNXX.LN_SEQ
	;
QUIT;
ENDRSUBMIT;

DATA SANTACLARA; SET LEGEND.SANTACLARA; RUN;

PROC EXPORT
		DATA=SANTACLARA
		OUTFILE='T:\SAS\Santa Clara University Quck Query for XXXX-XX.XLSX'
		REPLACE;
RUN;
