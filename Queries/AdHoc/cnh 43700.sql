SELECT
	DEF.*
FROM
	CDW..CS_Transfer3 T2
	INNER JOIN 
	(
		SELECT DISTINCT	
			DF10.BF_SSN,
			FS10.LF_FED_AWD,
			FS10.LN_FED_AWD_SEQ,
			(FS10.LF_FED_AWD + RIGHT('000' + CAST(FS10.LN_FED_AWD_SEQ AS VARCHAR(10)), 3)) AS COMBINED_AWARDID_SEQ,
			'DEFERMENT '  +
			DF10.LC_DFR_TYP AS [TYPE],
			LN50.LD_DFR_BEG BEGIN_DATE,
			LN50.LD_DFR_END END_DATE
		FROM
			CDW..DF10_BR_DFR_REQ DF10
			INNER JOIN CDW..LN50_BR_DFR_APV LN50
				ON LN50.BF_SSN = DF10.BF_SSN
				AND LN50.LF_DFR_CTL_NUM = DF10.LF_DFR_CTL_NUM
			INNER JOIN CDW..FS10_DL_LON FS10
				ON FS10.BF_SSN = LN50.BF_SSN
				AND FS10.LN_SEQ = LN50.LN_SEQ
			INNER JOIN 
			(
				SELECT DISTINCT
					LN90.BF_SSN,
					LN90.LN_SEQ
				FROM
					CDW..LN90_FIN_ATY LN90
					INNER JOIN CDW..CS_Transfer3 T2
						ON LN90.BF_SSN = T2.BF_SSN
				WHERE
					LN90.LC_STA_LON90 = 'A'
					AND COALESCE(LN90.LC_FAT_REV_REA,'') = ''
					AND LN90.PC_FAT_TYP = '04'
					AND LN90.PC_FAT_SUB_TYP = '96'
					AND LN90.LD_FAT_EFF > '11/11/2020'
					AND T2.DidTransfer = 1
			) LN90
				ON LN90.BF_SSN = LN50.BF_SSN
				AND LN90.LN_SEQ = LN50.LN_SEQ
		WHERE
			LN50.LC_STA_LON50 = 'A'
			AND DF10.LC_STA_DFR10 = 'A'
			AND DF10.LC_DFR_STA = 'A' --denied records cant have this active
			AND LN50.LC_DFR_RSP != '003'
			AND LN50.LD_DFR_BEG >= '01/01/2020'
	) DEF
		ON DEF.BF_SSN = T2.BF_SSN
WHERE
	T2.DidTransfer = 1
UNION ALL
SELECT
	FORB.*
FROM
	CDW..CS_Transfer3 T2
	INNER JOIN 
	(
		SELECT DISTINCT	
			FB10.BF_SSN,
			FS10.LF_FED_AWD,
			FS10.LN_FED_AWD_SEQ,
			(FS10.LF_FED_AWD + RIGHT('000' + CAST(FS10.LN_FED_AWD_SEQ AS VARCHAR(10)), 3)) AS COMBINED_AWARDID_SEQ,
			'FORBEARANCE ' +
			FB10.LC_FOR_TYP AS [TYPE],
			LN60.LD_FOR_BEG BEGIN_DATE,
			LN60.LD_FOR_END END_DATE
		FROM
			CDW..FB10_BR_FOR_REQ FB10
			INNER JOIN CDW..LN60_BR_FOR_APV LN60
				ON LN60.BF_SSN = FB10.BF_SSN
				AND LN60.LF_FOR_CTL_NUM = FB10.LF_DFR_CTL_NUM
			INNER JOIN CDW..FS10_DL_LON FS10
				ON FS10.BF_SSN = LN60.BF_SSN
				AND FS10.LN_SEQ = LN60.LN_SEQ
			INNER JOIN 
			(
				SELECT DISTINCT
					LN90.BF_SSN,
					LN90.LN_SEQ
				FROM
					CDW..LN90_FIN_ATY LN90
					INNER JOIN CDW..CS_Transfer3 T2
						ON LN90.BF_SSN = T2.BF_SSN
				WHERE
					LN90.LC_STA_LON90 = 'A'
					AND COALESCE(LN90.LC_FAT_REV_REA,'') = ''
					AND LN90.PC_FAT_TYP = '04'
					AND LN90.PC_FAT_SUB_TYP = '96'
					AND LN90.LD_FAT_EFF > '11/11/2020'
					AND T2.DidTransfer = 1
			) LN90
				ON LN90.BF_SSN = LN60.BF_SSN
				AND LN90.LN_SEQ = LN60.LN_SEQ
		WHERE
			LN60.LC_STA_LON60 = 'A'
			AND FB10.LC_STA_FOR10 = 'A'
			AND FB10.LC_FOR_STA = 'A' --denied records cant have this active
			AND LN60.LC_FOR_RSP != '003'
			AND LN60.LD_FOR_BEG >= '01/01/2020'
	) FORB
		ON FORB.BF_SSN = T2.BF_SSN
WHERE
	T2.DidTransfer = 1
ORDER BY
	BF_SSN,BEGIN_DATE
