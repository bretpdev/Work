USE UDW
GO

DECLARE @SchoolCodes TABLE (SchoolCode CHAR(8),	SchoolCloseDate DATE);
INSERT INTO	@SchoolCodes (SchoolCode, SchoolCloseDate) VALUES
--OPE ID	Closure Date
('00284301','7/21/2000'),
('00284302','7/31/2019'),
('00339406','1/1/2016 '),
('00339407','1/1/2014 '),
('00339408','1/1/2012 '),
('00339410','9/1/2010 '),
('00339411','9/1/2018 '),
('00339412','5/15/2015'),
('00339413','9/1/2016 '),
('00339414','5/15/2010'),
('00339415','9/1/2012 '),
('00339416','9/1/2012 '),
('00339417','9/1/2019 '),
('00339418','9/1/2014 '),
('00339419','9/1/2014 '),
('00339420','9/1/2014 '),
('00339421','5/15/2014'),
('00339423','9/1/2014 '),
('00339425','1/1/2016 '),
('00339426','9/1/2014 '),
('00339427','9/1/2014 '),
('00339428','9/1/2014 '),
('00339429','9/1/2018 '),
('00339430','1/1/2014 '),
('00339431','9/1/2019 '),
('00339432','9/1/2015 '),
('00339433','9/1/2019 '),
('00339434','9/1/2019 '),
('00339435','9/1/2019 '),
('00339436','9/1/2019 '),
('00339437','5/5/2010 '),
('00339438','5/15/2013'),
('00339439','5/15/2013'),
('00339440','9/1/2014 '),
('00339441','5/15/2017'),
('00339442','5/15/2017'),
('00339443','9/1/2013 '),
('00339444','1/1/2014 '),
('00339445','1/1/2014 '),
('00339446','5/15/2015'),
('00339447','9/1/2019 '),
('00339448','1/1/2011 '),
('00339449','5/15/2014'),
('00339450','5/15/2017'),
('00339451','9/1/2019 '),
('00339453','9/1/2019 '),
('00339454','1/1/2016 '),
('00339455','9/1/2019 '),
('00339456','9/1/2019 '),
('00339457','9/1/2019 '),
('82098882','3/12/2020'),
('04220900','12/5/2019'),
('04220901','12/5/2019'),
('00110104','5/15/2020'),
('52098843','4/26/2020'),
('00358401','5/6/2018 '),
('02241702','5/15/2020'),
('00224930','4/24/2020'),
('00224950','4/24/2020'),
('00224951','4/24/2020'),
('00136006','5/15/2020'),
('00339458','5/1/2017 '),
('04145000','3/31/2020'),
('72098836','3/24/2020'),
('00172707','6/30/2018'),
('02166400','4/25/2019'),
--('03730302','N/A      ')
('03730302','         ')
;
--select * from @SchoolCodes

/**** UNH 23008 query **/

--SELECT DISTINCT
--	LN10.BF_SSN,
--	LN10.LN_SEQ,
--	LN10.LF_DOE_SCL_ORG
--FROM
--	LN10_LON LN10
--WHERE
--	LN10.LF_DOE_SCL_ORG IN (SELECT SchoolCode FROM @SchoolCodes)
--;
----0

--SELECT DISTINCT
--	MR01.LF_STU_SSN,
--	MR01.LF_DOE_SCL_ORG,
--	MR01.LF_DOE_SCL_ENR_CUR,
--	SD10.LD_SCL_SPR
--FROM
--	MR01_MGT_RPT_LON MR01
--	LEFT JOIN SD10_STU_SPR SD10 
--		ON SD10.LF_STU_SSN = MR01.LF_STU_SSN
--WHERE
--	MR01.LF_DOE_SCL_ORG IN (SELECT SchoolCode FROM @SchoolCodes)
--	OR MR01.LF_DOE_SCL_ENR_CUR IN (SELECT SchoolCode FROM @SchoolCodes)
--;
----18

--SELECT DISTINCT
--	LN10.BF_SSN,
--	--LN10.LN_SEQ,
--	LN10.LF_DOE_SCL_ORG,
--	MR01.LF_DOE_SCL_ORG,
--	MR01.LF_DOE_SCL_ENR_CUR,
--	SD10.LD_SCL_SPR,
--	SchoolCodes.SchoolCloseDate
--FROM
--	LN10_LON LN10
--	INNER JOIN MR01_MGT_RPT_LON MR01
--		ON LN10.BF_SSN = MR01.LF_STU_SSN
--	INNER JOIN @SchoolCodes SchoolCodes
--		ON MR01.LF_DOE_SCL_ORG = SchoolCodes.SchoolCode
--		OR MR01.LF_DOE_SCL_ENR_CUR = SchoolCodes.SchoolCode
--	LEFT JOIN SD10_STU_SPR SD10 
--		ON SD10.LF_STU_SSN = LN10.BF_SSN 
--WHERE
--	LN10.LA_CUR_PRI > 0.00
--	AND LN10.LC_STA_LON10 = 'R'
--	AND DATEADD(DAY, 121, ISNULL(SD10.LD_SCL_SPR, GETDATE())) > SchoolCodes.SchoolCloseDate
--ORDER BY
--	BF_SSN
--;
----0

/*****************  MODIFIED QUERY  ***********************/
SELECT
	*
FROM
	(
		SELECT DISTINCT
			PD10.DF_SPE_ACC_ID,
			PD10.DM_PRS_1,
			PD10.DM_PRS_MID,
			PD10.DM_PRS_LST,
			PD30.DX_STR_ADR_1,
			PD30.DX_STR_ADR_2,
			PD30.DX_STR_ADR_3,
			PD30.DM_CT,
			PD30.DC_DOM_ST,
			PD30.DF_ZIP_CDE,
			PD30.DI_VLD_ADR,
			LN10.LF_DOE_SCL_ORG,
			SD10.LF_DOE_SCL_ENR_CUR,
			SD10.LC_REA_SCL_SPR,
			SD10.LD_NTF_SCL_SPR,
			SD10.LD_SCL_SPR [LastDayOfEnrollment],
			School.SchoolCloseDate
			--,SUM(LN10.LA_CUR_PRI) OVER(PARTITION BY LN10.BF_SSN) AS sum_LA_CUR_PRI
			--,SUM(LN10.LA_LON_AMT_GTR) OVER(PARTITION BY LN10.BF_SSN) AS sum_LA_LON_AMT_GTR
		FROM
			PD10_PRS_NME PD10
			INNER JOIN PD30_PRS_ADR PD30 
				ON PD30.DF_PRS_ID = PD10.DF_PRS_ID
			INNER JOIN LN10_LON LN10 
				ON LN10.BF_SSN = PD10.DF_PRS_ID
			INNER JOIN 
			(
				SELECT
					LN10.BF_SSN,
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN LN10_LON LN10 
						ON LN10.LF_DOE_SCL_ORG = SC.SchoolCode

				UNION ALL

				SELECT DISTINCT
					SD10.LF_STU_SSN AS BF_SSN,
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN SD10_STU_SPR SD10 
						ON SD10.LF_DOE_SCL_ENR_CUR = SC.SchoolCode
				WHERE
					SD10.LC_STA_STU10 = 'A'
			) School 
				ON School.BF_SSN = PD10.DF_PRS_ID
			LEFT JOIN SD10_STU_SPR SD10 
				ON SD10.LF_STU_SSN = PD10.DF_PRS_ID 
				AND SD10.LF_DOE_SCL_ENR_CUR = School.SchoolCode 
				AND SD10.LC_STA_STU10 = 'A'
		WHERE
			DATEADD(DAY, 121, SD10.LD_SCL_SPR) > School.SchoolCloseDate
			AND LN10.LA_CUR_PRI > 0.00
			AND LN10.LA_LON_AMT_GTR > 0.00
	) X
WHERE
	DATEADD(DAY, 121, ISNULL(X.LastDayOfEnrollment, GETDATE())) > X.SchoolCloseDate
	AND	(
			X.LF_DOE_SCL_ENR_CUR IN (SELECT SchoolCode FROM @SchoolCodes)
			OR	X.LF_DOE_SCL_ORG IN (SELECT SchoolCode FROM @SchoolCodes)
		)
ORDER BY
	X.DF_SPE_ACC_ID
;

