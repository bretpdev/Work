USE CDW;
GO

--deferments
SELECT DISTINCT
	LNXX.BF_SSN AS SSN,
	LNXX.LN_SEQ AS LoanSequence,
	DFXX.LC_DFR_TYP AS DefermentType,
	LNXX.LD_DFR_BEG AS DefermentBeginDate,
	LNXX.LD_DFR_END AS DefermentEndDate,
	--validation fields:
	LNXX.LC_STA_LONXX,
	LNXX.LC_STA_LONXX,
	DFXX.LC_DFR_STA,
	DFXX.LC_STA_DFRXX,
	IIF(LNXX.LC_DFR_RSP != 'XXX', 'not denied',NULL) AS LC_DFR_RSP,
	IIF(LNXX.LA_CUR_PRI > X.XX, '>X',NULL) AS CURRENT_PRINCIPAL
FROM
	LNXX_LON LNXX
	INNER JOIN LNXX_BR_DFR_APV LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN DFXX_BR_DFR_REQ DFXX
		ON DFXX.BF_SSN = LNXX.BF_SSN
		AND DFXX.LF_DFR_CTL_NUM = LNXX.LF_DFR_CTL_NUM
WHERE	
	LNXX.LC_STA_LONXX = 'A'
	AND LNXX.LC_DFR_RSP != 'XXX' --not denied
	AND DFXX.LC_DFR_STA = 'A'
	AND DFXX.LC_STA_DFRXX = 'A' --approved
	AND LNXX.LA_CUR_PRI > X.XX
	AND LNXX.LC_STA_LONXX = 'R'
	AND DFXX.LC_DFR_TYP = 'XX'
	AND LNXX.LD_DFR_BEG >= CONVERT(DATE,'XXXXXXXX')
	

--forbearances
SELECT DISTINCT
	LNXX.BF_SSN AS SSN,
	LNXX.LN_SEQ AS LoanSequence,
	FBXX.LC_FOR_TYP AS ForbearanceType,
	CONVERT(DATE,LNXX.LD_FOR_BEG) AS ForbearanceBeginDate,
	CONVERT(DATE,LNXX.LD_FOR_END) AS ForbearanceEndDate,
	--validation fields
	LNXX.LC_STA_LONXX,
	LNXX.LC_STA_LONXX,
	FBXX.LC_FOR_STA,
	FBXX.LC_STA_FORXX,
	IIF(LNXX.LC_FOR_RSP != 'XXX', 'not denied',NULL) AS LC_FOR_RSP,
	IIF(LNXX.LA_CUR_PRI > X.XX, '>X',NULL) AS CURRENT_PRINCIPAL
FROM
	LNXX_LON LNXX
	INNER JOIN LNXX_BR_FOR_APV LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN FBXX_BR_FOR_REQ FBXX
		ON FBXX.BF_SSN = LNXX.BF_SSN
		AND FBXX.LF_FOR_CTL_NUM = LNXX.LF_FOR_CTL_NUM
WHERE	
	LNXX.LC_STA_LONXX = 'A'
	AND LNXX.LC_FOR_RSP != 'XXX' --not denied
	AND FBXX.LC_STA_FORXX = 'A'
	AND FBXX.LC_FOR_STA = 'A' --approved
	AND LNXX.LA_CUR_PRI > X.XX
	AND LNXX.LC_STA_LONXX = 'R'
	AND FBXX.LC_FOR_TYP = 'XX'
	AND CONVERT(DATE,LNXX.LD_FOR_BEG) >= CONVERT(DATE,'XXXXXXXX')