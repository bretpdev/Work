USE CDW
GO

SELECT DISTINCT
	PDXX.DF_SPE_ACC_ID AS ACCOUNT_NUMBER,
	LNXX.LN_SEQ AS LOAN_SEQ,
	DEF.LC_DFR_TYP AS DEFERMENT_TYPE,
	DEF.LD_DFR_BEG AS DEFERMENT_BEGIN_DATE,
	DEF.LD_DFR_END AS DEFERMENT_END_DATE
FROM
	CDW..PDXX_PRS_NME PDXX
	INNER JOIN CDW..AYXX_BR_LON_ATY AYXX
		ON AYXX.BF_SSN = PDXX.DF_PRS_ID
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
	INNER JOIN
	(
		SELECT 
			DFXX.BF_SSN,
			LNXX.LN_SEQ,
			DFXX.LC_DFR_TYP,
			LNXX.LD_DFR_BEG,
			LNXX.LD_DFR_END,
			LNXX.LC_STA_LONXX,
			DFXX.LC_DFR_STA,
			DFXX.LC_STA_DFRXX
		FROM
			CDW..DFXX_BR_DFR_REQ DFXX
			INNER JOIN CDW..LNXX_BR_DFR_APV LNXX
				ON LNXX.BF_SSN = DFXX.BF_SSN
				AND LNXX.LF_DFR_CTL_NUM = DFXX.LF_DFR_CTL_NUM
		WHERE
			DFXX.LC_DFR_TYP NOT IN ('XX','XX','XX','XX','XX','XX','XX','XX','XX','XX','XX')
			AND LNXX.LC_DFR_RSP != 'XXX'
			AND LNXX.LC_STA_LONXX = 'A'
			AND 
			(
				LNXX.LD_DFR_BEG BETWEEN 'XX/XX/XXXX' AND 'XX/XX/XXXX'
				OR
				LNXX.LD_DFR_END BETWEEN 'XX/XX/XXXX' AND 'XX/XX/XXXX'
			)
	) DEF
		ON DEF.BF_SSN = PDXX.DF_PRS_ID
		AND DEF.LN_SEQ = LNXX.LN_SEQ
WHERE
	AYXX.PF_REQ_ACT = 'CVDOO'
	AND AYXX.LC_STA_ACTYXX = 'A'