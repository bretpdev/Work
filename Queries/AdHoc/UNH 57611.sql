USE UDW
GO

DECLARE @TODAY DATE = GETDATE();

--details:
SELECT DISTINCT
	LN10.BF_SSN
	,LN10.IC_LON_PGM
	,CASE
		WHEN LN10.LA_CUR_PRI > 0.00
		THEN '>0'
		ELSE 'ERROR'
	END AS LA_CUR_PRI
	,MIN(LN10.LD_LON_1_DSB) OVER (PARTITION BY LN10.BF_SSN) AS FirstDisbDate
	,MIN(YEAR(LN10.LD_LON_1_DSB)) OVER (PARTITION BY LN10.BF_SSN) AS EarliestYear
	,RS10.LC_STA_RPST10
	,RS10.LD_RPS_1_PAY_DU
FROM
	LN10_LON LN10
	INNER JOIN RS10_BR_RPD RS10
		ON LN10.BF_SSN = RS10.BF_SSN
WHERE
	LN10.IC_LON_PGM = 'TILP'
	AND LN10.LA_CUR_PRI > 0.00
	AND RS10.LC_STA_RPST10 = 'A'
	AND RS10.LD_RPS_1_PAY_DU < @TODAY
	AND LN10.LD_LON_1_DSB IS NOT NULL
ORDER BY 
	--BF_SSN
	LD_RPS_1_PAY_DU DESC


--count
SELECT
	COUNT(DISTINCT LN10.BF_SSN) AS UNIQUE_BORROWER_COUNT
FROM
	LN10_LON LN10
	INNER JOIN RS10_BR_RPD RS10
		ON LN10.BF_SSN = RS10.BF_SSN
WHERE
	LN10.IC_LON_PGM = 'TILP'
	AND LN10.LA_CUR_PRI > 0.00
	AND RS10.LC_STA_RPST10 = 'A'
	AND RS10.LD_RPS_1_PAY_DU < @TODAY
	AND LN10.LD_LON_1_DSB IS NOT NULL
