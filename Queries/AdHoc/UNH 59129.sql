--run on UHEAASQLDB
USE ULS
GO

BEGIN TRANSACTION
	DECLARE @ERROR INT = 0
	DECLARE @ROWCOUNT INT = 0
	DECLARE @ExpectedRowCount INT = 579 --# of distinct zips + 1 disaster forb

	DECLARE @Disaster VARCHAR(100) = 'California Fires (DR-4407)'
	DECLARE @BeginDate DATE = '11/12/2018'
	DECLARE @AddedBy VARCHAR(50) = 'UNH 59129'

	DECLARE @DisasterID_initial INT = (SELECT MAX(DisasterId)+1 FROM dasforbfed.Disasters)
	INSERT INTO [dasforbfed].[Disasters] (DisasterId, Disaster, BeginDate, EndDate, MaxEndDate, Active, AddedBy)
	VALUES(@DisasterID_initial, @Disaster, @BeginDate, DATEADD(DAY, 89, @BeginDate), DATEADD(DAY, 89, @BeginDate), 1, @AddedBy)
	--1

	-- Save/Set the row count and error number (if any) from the previously executed statement
	SELECT @ROWCOUNT = @@ROWCOUNT, @ERROR = @@ERROR
	
	--Affected zip codes:
	DECLARE @DisasterID INT = (SELECT DisasterId FROM dasforbfed.Disasters WHERE Disaster = @Disaster)
	
	DECLARE @Zips TABLE (ZipCode VARCHAR(5))
	INSERT INTO @Zips (ZipCode) VALUES
--Butte 	Los Angeles	Ventura 
('95938'),	('91410'),	('93006'),
('95930'),	('91412'),	('93007'),
('95929'),	('91411'),	('93009'),
('95942'),	('91409'),	('93003'),
('95941'),	('91406'),	('93004'),
('95940'),	('91407'),	('93005'),
('95917'),	('91408'),	('93015'),
('95916'),	('90034'),	('93016'),
('95914'),	('91426'),	('93020'),
('95928'),	('91436'),	('93010'),
('95927'),	('91470'),	('93011'),
('95926'),	('91413'),	('93012'),
('95973'),	('91416'),	('93002'),
('95969'),	('91423'),	('91359'),
('95968'),	('91393'),	('91360'),
('95978'),	('91394'),	('91361'),
('95976'),	('91395'),	('91319'),
('95974'),	('91392'),	('91320'),
('95958'),	('91390'),	('91358'),
('95954'),	('90030'),	('91362'),
('95948'),	('91387'),	('91377'),
('95967'),	('91396'),	('93001'),
('95966'),	('91404'),	('91361'),
('95965'),	('91405'),	('91361'),
			('90079'),	('91361'),
			('91403'),	('93021'),
			('90033'),	('93060'),
			('91401'),	('93061'),
			('91402'),	('93062'),
			('90026'),	('93042'),
			('91523'),	('93043'),
			('91526'),	('93044'),
			('91522'),	('93066'),
			('91521'),	('93094'),
			('90021'),	('93099'),
			('90027'),	('93063'),
			('91601'),	('93064'),
			('93536'),	('93065'),
			('90295'),	('93041'),
			('90035'),	('93031'),
			('91605'),	('93032'),
			('91602'),	('93033'),
			('91603'),	('93030'),
			('91604'),	('93022'),
			('91510'),	('93023'),
			('91501'),	('93024'),
			('90029'),	('93036'),
			('90274'),	('93035'),
			('91499'),	('93034'),
			('91482'),	('93040'),
			('91495'),	
			('91496'),	
			('91502'),	
			('90028'),	
			('91507'),	
			('91508'),	
			('91506'),	
			('91503'),	
			('91504'),	
			('91505'),	
			('91386'),	
			('91326'),	
			('91327'),	
			('91328'),	
			('91325'),	
			('91321'),	
			('91322'),	
			('91324'),	
			('91329'),	
			('91335'),	
			('91337'),	
			('91340'),	
			('91334'),	
			('91330'),	
			('91331'),	
			('91333'),	
			('91316'),	
			('91306'),	
			('90001'),	
			('91307'),	
			('91305'),	
			('90002'),	
			('91303'),	
			('91304'),	
			('91308'),	
			('91311'),	
			('90081'),	
			('91313'),	
			('90301'),	
			('91309'),	
			('91310'),	
			('90031'),	
			('91367'),	
			('90032'),	
			('91371'),	
			('91365'),	
			('91357'),	
			('91361'),	
			('91364'),	
			('91372'),	
			('91383'),	
			('91384'),	
			('91385'),	
			('91382'),	
			('91376'),	
			('91380'),	
			('91381'),	
			('91356'),	
			('90080'),	
			('90296'),	
			('91345'),	
			('91344'),	
			('91341'),	
			('91342'),	
			('91343'),	
			('91346'),	
			('90020'),	
			('91354'),	
			('91355'),	
			('91353'),	
			('91350'),	
			('91351'),	
			('91352'),	
			('91775'),	
			('90056'),	
			('91776'),	
			('90291'),	
			('91773'),	
			('90054'),	
			('90055'),	
			('90278'),	
			('91780'),	
			('93543'),	
			('90275'),	
			('91778'),	
			('90290'),	
			('90023'),	
			('90071'),	
			('91772'),	
			('90052'),	
			('91756'),	
			('91765'),	
			('91755'),	
			('91749'),	
			('91750'),	
			('91754'),	
			('90025'),	
			('91769'),	
			('91770'),	
			('91771'),	
			('91768'),	
			('91766'),	
			('91767'),	
			('90053'),	
			('90066'),	
			('90065'),	
			('90059'),	
			('91899'),	
			('91896'),	
			('90058'),	
			('90067'),	
			('90064'),	
			('93539'),	
			('90061'),	
			('90277'),	
			('90062'),	
			('90280'),	
			('90063'),	
			('90060'),	
			('91804'),	
			('90057'),	
			('90069'),	
			('90068'),	
			('91789'),	
			('90024'),	
			('90070'),	
			('91788'),	
			('91790'),	
			('91801'),	
			('91802'),	
			('91803'),	
			('91793'),	
			('90067'),	
			('91791'),	
			('91792'),	
			('91616'),	
			('90044'),	
			('91617'),	
			('91615'),	
			('91612'),	
			('91614'),	
			('90043'),	
			('90045'),	
			('90075'),	
			('90294'),	
			('91706'),	
			('91702'),	
			('90077'),	
			('90076'),	
			('91618'),	
			('91611'),	
			('91607'),	
			('91608'),	
			('90038'),	
			('90037'),	
			('93510'),	
			('91606'),	
			('90036'),	
			('90022'),	
			('90041'),	
			('91610'),	
			('90042'),	
			('90040'),	
			('90078'),	
			('91609'),	
			('90039'),	
			('91733'),	
			('91734'),	
			('91735'),	
			('91732'),	
			('91723'),	
			('91724'),	
			('91731'),	
			('91740'),	
			('91746'),	
			('91747'),	
			('91748'),	
			('91745'),	
			('90051'),	
			('91741'),	
			('91744'),	
			('91722'),	
			('91714'),	
			('90073'),	
			('90046'),	
			('90074'),	
			('91711'),	
			('90293'),	
			('90292'),	
			('91715'),	
			('90049'),	
			('93544'),	
			('90050'),	
			('91716'),	
			('90047'),	
			('90072'),	
			('90048'),	
			('91302'),	
			('90239'),	
			('90749'),	
			('90801'),	
			('90755'),	
			('90240'),	
			('90241'),	
			('90748'),	
			('90747'),	
			('90407'),	
			('90233'),	
			('90232'),	
			('90406'),	
			('90409'),	
			('90802'),	
			('90408'),	
			('90803'),	
			('90746'),	
			('90717'),	
			('90716'),	
			('90242'),	
			('90723'),	
			('90713'),	
			('90712'),	
			('90715'),	
			('90714'),	
			('90744'),	
			('90734'),	
			('90745'),	
			('93584'),	
			('90732'),	
			('90731'),	
			('93563'),	
			('90733'),	
			('90804'),	
			('90844'),	
			('90842'),	
			('90847'),	
			('90846'),	
			('90834'),	
			('90833'),	
			('90840'),	
			('90835'),	
			('90016'),	
			('90213'),	
			('90212'),	
			('90017'),	
			('90221'),	
			('90848'),	
			('90220'),	
			('90853'),	
			('90832'),	
			('90809'),	
			('90231'),	
			('90224'),	
			('90230'),	
			('90806'),	
			('90805'),	
			('90808'),	
			('90807'),	
			('90815'),	
			('90814'),	
			('90831'),	
			('90822'),	
			('90223'),	
			('90810'),	
			('90813'),	
			('90222'),	
			('90606'),	
			('90605'),	
			('90607'),	
			('90266'),	
			('90602'),	
			('90601'),	
			('90604'),	
			('90603'),	
			('90609'),	
			('90263'),	
			('90637'),	
			('90610'),	
			('90265'),	
			('90608'),	
			('90264'),	
			('90014'),	
			('90013'),	
			('90505'),	
			('90504'),	
			('90010'),	
			('90270'),	
			('90502'),	
			('90501'),	
			('90009'),	
			('90503'),	
			('90508'),	
			('90012'),	
			('90510'),	
			('90509'),	
			('90011'),	
			('90267'),	
			('90507'),	
			('90506'),	
			('90638'),	
			('90015'),	
			('90671'),	
			('90702'),	
			('90701'),	
			('90411'),	
			('90662'),	
			('90410'),	
			('90670'),	
			('90245'),	
			('90707'),	
			('90711'),	
			('90710'),	
			('90704'),	
			('90703'),	
			('90247'),	
			('90706'),	
			('90248'),	
			('90260'),	
			('90261'),	
			('90651'),	
			('90255'),	
			('90640'),	
			('90639'),	
			('90650'),	
			('90262'),	
			('90661'),	
			('90660'),	
			('90249'),	
			('93535'),	
			('90254'),	
			('90652'),	
			('90250'),	
			('90251'),	
			('90401'),	
			('91114'),	
			('91115'),	
			('90086'),	
			('91109'),	
			('90402'),	
			('90087'),	
			('91110'),	
			('90007'),	
			('90310'),	
			('90006'),	
			('90309'),	
			('90312'),	
			('91116'),	
			('90311'),	
			('91117'),	
			('91206'),	
			('91104'),	
			('90008'),	
			('91106'),	
			('91105'),	
			('90088'),	
			('91102'),	
			('90405'),	
			('91103'),	
			('91108'),	
			('93532'),	
			('91207'),	
			('91208'),	
			('91209'),	
			('90404'),	
			('90403'),	
			('91107'),	
			('91199'),	
			('90306'),	
			('90305'),	
			('90272'),	
			('91188'),	
			('91185'),	
			('93551'),	
			('91189'),	
			('93552'),	
			('90304'),	
			('90004'),	
			('90303'),	
			('93553'),	
			('91201'),	
			('91203'),	
			('91202'),	
			('90082'),	
			('91205'),	
			('90307'),	
			('91123'),	
			('91121'),	
			('90084'),	
			('91118'),	
			('90308'),	
			('90005'),	
			('91129'),	
			('91126'),	
			('91184'),	
			('91182'),	
			('91124'),	
			('90083'),	
			('91204'),	
			('91125'),	
			('91010'),	
			('91009'),	
			('91012'),	
			('91011'),	
			('91006'),	
			('91003'),	
			('91008'),	
			('91007'),	
			('91016'),	
			('91023'),	
			('91021'),	
			('90094'),	
			('91024'),	
			('91020'),	
			('91017'),	
			('90094'),	
			('90003'),	
			('91001'),	
			('90202'),	
			('90202'),	
			('90201'),	
			('90201'),	
			('90018'),	
			('90211'),	
			('90209'),	
			('90210'),	
			('91301'),	
			('91226'),	
			('90095'),	
			('90899'),	
			('90895'),	
			('90134'),	
			('90189'),	
			('90096'),	
			('90099'),	
			('91224'),	
			('91225'),	
			('93534'),	
			('91222'),	
			('90090'),	
			('93591'),	
			('91066'),	
			('91046'),	
			('91221'),	
			('91101'),	
			('91077'),	
			('91210'),	
			('90089'),	
			('90302'),	
			('93550'),	
			('91214'),	
			('93599'),	
			('91031'),	
			('91030'),	
			('90091'),	
			('93586'),	
			('90093'),	
			('91040'),	
			('91041'),	
			('93590'),	
			('91043'),	
			('90019'),	
			('91025'),	
			('91042')
;

--select count(*) as AllZips from @Zips
----586
--select count(distinct ZipCode) as DistinctZips from @Zips
----578
--select ZipCode,count(ZipCode) from @Zips group by ZipCode having count(ZipCode) > 1


	IF NOT EXISTS 
	(
		SELECT 
			ZipId 
		FROM 
			[dasforbfed].[Zips] Z1
			INNER JOIN @Zips Z2
				ON Z1.ZipCode = Z2.ZipCode
		WHERE
			Z1.DisasterId = @DisasterID
	)
	BEGIN
		INSERT INTO [dasforbfed].[Zips]	(ZipCode, DisasterId)
		SELECT DISTINCT
			ZipCode
			,@DisasterID 
		FROM 
			@Zips
	END

	SELECT @ROWCOUNT = @ROWCOUNT + @@ROWCOUNT, @ERROR = @ERROR + @@ERROR

IF @ROWCOUNT = @ExpectedRowCount AND @ERROR = 0
	BEGIN
		PRINT 'Transaction committed'
		COMMIT TRANSACTION
		--ROLLBACK TRANSACTION
	END
ELSE
	BEGIN
		PRINT 'ROWCOUNT:  ' + CAST(@ROWCOUNT AS VARCHAR(10))
		PRINT 'ERROR:  ' + CAST(@ERROR AS VARCHAR(10))
		PRINT 'Transaction NOT committed'
		ROLLBACK TRANSACTION
	END