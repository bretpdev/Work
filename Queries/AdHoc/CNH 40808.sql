SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SELECT DISTINCT
	COUNT(LNXX.LN_SEQ) OVER(PARTITION BY LNXX.IC_LON_PGM) AS CountLoans,
	LNXX.IC_LON_PGM
FROM
	CDW..LNXX_LON LNXX
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = LNXX.BF_SSN
	INNER JOIN CDW..GRXX_RPT_LON_APL GRXX
		ON GRXX.BF_SSN = LNXX.BF_SSN
		AND GRXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN CDW.calc.RepaymentSchedules RS
		ON RS.BF_SSN = LNXX.BF_SSN
		AND RS.LN_SEQ = LNXX.LN_SEQ
	LEFT JOIN CDW..AYXX_BR_LON_ATY AYXX
		ON AYXX.BF_SSN = LNXX.BF_SSN
		AND AYXX.PF_REQ_ACT = 'IDRPN'
		AND AYXX.LC_STA_ACTYXX = 'A'
	LEFT JOIN CLS.emailbtcf.CampaignData CD
		ON CD.AccountNumber = PDXX.DF_SPE_ACC_ID
		AND CD.AddedBy = 'UTNWOXX'
		AND CD.InactivatedAt IS NULL
		AND 
		(	
			CD.EmailSentAt IS NOT NULL
			OR CD.ArcProcessedAt IS NOT NULL
		)
WHERE
	LNXX.IC_LON_PGM IN('DLSTFD','DLUNST') --Stafford loans
	AND LNXX.LA_CUR_PRI > X.XX
	AND LNXX.LC_STA_LONXX = 'R'
	AND GRXX.WD_BR_SIG_MPN >= 'XXXX-XX-XX' --MPN date
	AND RS.CurrentGradation = X
	AND RS.LC_TYP_SCH_DIS IN ('CX','CX','CX','CQ','CA','CP','IX','IA','IB','IL','IX','IP') --IDR plans
	AND CAST(DATEADD(MONTH,RS.LN_RPS_TRM, RS.TermStartDate) AS DATE) BETWEEN 'XXXX-XX-XX' AND 'XXXX-XX-XX'
	AND AYXX.BF_SSN IS NULL --No IDRPN arc
	AND CD.AccountNumber IS NULL --No UTNWOXX


