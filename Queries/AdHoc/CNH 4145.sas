/*NOTE: 	open Q:\CS Systems Support\Data Mart Validation Reports\DISB COMPARE\NSLDS CS Disb Compare.xlsx using password R$XpQyiZ%X#m*/
/*			before running this job*/

LIBNAME LEGEND REMOTE SERVER=LEGEND SLIBREF=WORK;
LIBNAME NSLDS 'Q:\CS Systems Support\Data Mart Validation Reports\DISB COMPARE\NSLDS CS Disb Compare.xlsx';

DATA LEGEND.NSLDS_CS; SET NSLDS.'On NSLDS not on CS$'N; RUN;

RSUBMIT;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;

PROC SQL;
	CREATE TABLE NSLDS_CSX AS
		SELECT
			CS.NSL_ID,
			CS.CS_ID,
			CS.NSL_DIS,
			CS.CS_DIS,
			CS.DIFF,
			DWXX.WC_DW_LON_STA,
			LNXX.DSB_AMT
		FROM
			NSLDS_CS CS
			LEFT JOIN PKUB.FSXX_DL_LON FSXX
				ON SUBSTR(CS.NSL_ID,X,XX) = FSXX.LF_FED_AWD
				AND INPUT(SUBSTR(CS.NSL_ID,XX,X),X.) = FSXX.LN_FED_AWD_SEQ
			LEFT JOIN PKUB.DWXX_DW_CLC_CLU DWXX
				ON FSXX.BF_SSN = DWXX.BF_SSN
				AND FSXX.LN_SEQ = DWXX.LN_SEQ
			LEFT JOIN 
				(
					SELECT DISTINCT
						BF_SSN,
						LN_SEQ,
						SUM(LA_DSB - COALESCE(LA_DSB_CAN,X)) AS DSB_AMT
					FROM 
						PKUB.LNXX_DSB
					WHERE
						LC_STA_LONXX IN ('X','X') /*'Active' or 'Active Reissue'*/
					GROUP BY
						BF_SSN,
						LN_SEQ
				) LNXX
				ON FSXX.BF_SSN = LNXX.BF_SSN
				AND FSXX.LN_SEQ = LNXX.LN_SEQ
	;
QUIT;

ENDRSUBMIT;

DATA NSLDS_CSX; SET LEGEND.NSLDS_CSX; RUN;

PROC EXPORT
		DATA=NSLDS_CSX
		OUTFILE='T:\SAS\NSLDS Disb Compare XXXXXX.XLSX'
		REPLACE;
RUN;
