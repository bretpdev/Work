USE CDW
GO
--T:\Consol precon\NAtoCSTLCXXXXXXXX_X.xlsx                                                           
SELECT DISTINCT
	PDXX.DF_PRS_ID,
	LTRIM(RTRIM(PDXX.DM_PRS_X)) + ' ' + LTRIM(RTRIM(PDXX.DM_PRS_LST)) AS [NAME],
	cnh.CONFRIMATION_DATE,
	CNH.[CONSOLIDATION LOAN ID_(AWARD ID)] AS AWARD_ID,
	LNXX.IC_LON_PGM,
	LD_DSB,
	LNXX.LR_INT_RDC_PGM_ORG as system_rate,
	cast((cnh.Interst_rate_from_file * XXX) as numeric(XX,X)) as file_rate,
	CASE WHEN LNXX.LR_INT_RDC_PGM_ORG != cast((cnh.Interst_rate_from_file * XXX) as numeric(XX,X)) THEN X ELSE X END,
	cnh.FileName,
	LNXX.LA_CUR_PRI AS LOAN_BALANCE,
	CASE WHEN AP.BF_SSN IS NOT NULL THEN 'Y' ELSE 'N' END AS ON_AUTOPAY,
	ISNULL(LA_DSB,X) - ISNULL(LA_DSB_CAN,X) AS DISBURSEMENT_AMOUNT,
	LKXX.PX_DSC_LNG AS LOAN_STATUS,
	LNXX.LN_SEQ AS LOAN_SEQ
	 

FROM
	CDW..[CNH XXXXX] CNH
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = RIGHT('XXXXXXXX' + LTRIM(RTRIM(STR(SSSN))),  X)
	INNER JOIN  CDW..FSXX_DL_LON FSXX
		ON FSXX.BF_SSN = PDXX.DF_PRS_ID
		AND FSXX.LF_FED_AWD = SUBSTRING(LTRIM(RTRIM(CNH.[CONSOLIDATION LOAN ID_(AWARD ID)])),X,XX)
		AND FSXX.LN_FED_AWD_SEQ = CAST(SUBSTRING(LTRIM(RTRIM(CNH.[CONSOLIDATION LOAN ID_(AWARD ID)])), XX,X) AS INT)
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = FSXX.BF_SSN
		AND LNXX.LN_SEQ = FSXX.LN_SEQ
	INNER JOIN CDW..LNXX_DSB LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN CDW..DWXX_DW_CLC_CLU DWXX
		ON DWXX.BF_SSN = LNXX.BF_SSN
		AND DWXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN CDW..LKXX_LS_CDE_LKP LKXX
		ON LKXX.PM_ATR = 'WC-DW-LON-STA'
		AND LKXX.PX_ATR_VAL = DWXX.WC_DW_LON_STA
	INNER JOIN
	(
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			LNXX.LR_ITR,
			LR_INT_RDC_PGM_ORG,
			ROW_NUMBER() OVER (PARTITION BY LNXX.BF_SSN, LNXX.LN_SEQ ORDER BY LD_STA_LONXX DESC) AS SEQ
		FROM
			LNXX_INT_RTE_HST LNXX
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND CAST(GETDATE() AS DATE) BETWEEN LNXX.LD_ITR_EFF_BEG AND LNXX.LD_ITR_EFF_END
	) LNXX 
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
		AND LNXX.SEQ = X
	LEFT JOIN
	(
		SELECT 
			LNXX.BF_SSN,
			LNXX.LN_SEQ
		FROM 
			CDW..BRXX_BR_EFT BRXX
			INNER JOIN CDW..LNXX_EFT_TO_LON LNXX
				ON LNXX.BF_SSN = BRXX.BF_SSN
				AND LNXX.BN_EFT_SEQ = BRXX.BN_EFT_SEQ
		WHERE
			BRXX.BC_EFT_STA = 'A'
	) AP
		ON AP.BF_SSN = LNXX.BF_SSN
		AND AP.LN_SEQ = LNXX.LN_SEQ
		

                                                          