USE CDW
GO

SELECT DISTINCT
	POP.BF_SSN,
	POP.LN_SEQ,
	'DEFERMENT' AS [LOAN_STATUS]
FROM
(
	SELECT
		DWXX.BF_SSN,
		DWXX.LN_SEQ,
		'DEFERMENT' AS [LOAN_STATUS]
	FROM
		CDW..DWXX_DW_CLC_CLU DWXX
		INNER JOIN CDW..LNXX_LON LNXX
			ON DWXX.BF_SSN = LNXX.BF_SSN
			AND DWXX.LN_SEQ = LNXX.LN_SEQ
		INNER JOIN CDW..WQXX_TSK_QUE WQXX
			ON WQXX.BF_SSN = DWXX.BF_SSN
			AND WQXX.WF_QUE = 'XX'
			AND WQXX.WF_SUB_QUE = 'XX'
			AND WQXX.PF_REQ_ACT = 'DIFST'
		LEFT JOIN 
		(
			SELECT DISTINCT
				LNXX.BF_SSN
			FROM
				CDW..LNXX_LON_DLQ_HST LNXX
				INNER JOIN CDW..LNXX_LON LNXX
					ON LNXX.BF_SSN = LNXX.BF_SSN
					AND LNXX.LN_SEQ = LNXX.LN_SEQ
			WHERE
				LNXX.LC_STA_LONXX = 'X'
				AND LNXX.LC_STA_LONXX = 'R'
				AND LNXX.LA_CUR_PRI > X
		) LNXX
			ON LNXX.BF_SSN = DWXX.BF_SSN
	WHERE
		DWXX.WC_DW_LON_STA = 'XX'
		AND LNXX.LC_STA_LONXX = 'R'
		AND LNXX.LA_CUR_PRI > X
		AND LNXX.BF_SSN IS NULL
) POP
INNER JOIN CDW..DWXX_DW_CLC_CLU DWXX
	ON DWXX.BF_SSN = POP.BF_SSN
	AND DWXX.WC_DW_LON_STA = 'XX'

UNION 


SELECT DISTINCT
	DWXX.BF_SSN,
	DWXX.LN_SEQ,
	'NOT FULLY DISB' AS LOAN_STATUS
FROM
(
	SELECT
		DWXX.BF_SSN,
		DWXX.LN_SEQ,
		'DEFERMENT' AS [LOAN_STATUS]
	FROM
		CDW..DWXX_DW_CLC_CLU DWXX
		INNER JOIN CDW..LNXX_LON LNXX
			ON DWXX.BF_SSN = LNXX.BF_SSN
			AND DWXX.LN_SEQ = LNXX.LN_SEQ
		INNER JOIN CDW..WQXX_TSK_QUE WQXX
			ON WQXX.BF_SSN = DWXX.BF_SSN
			AND WQXX.WF_QUE = 'XX'
			AND WQXX.WF_SUB_QUE = 'XX'
			AND WQXX.PF_REQ_ACT = 'DIFST'
		LEFT JOIN 
		(
			SELECT DISTINCT
				LNXX.BF_SSN
			FROM
				CDW..LNXX_LON_DLQ_HST LNXX
				INNER JOIN CDW..LNXX_LON LNXX
					ON LNXX.BF_SSN = LNXX.BF_SSN
					AND LNXX.LN_SEQ = LNXX.LN_SEQ
			WHERE
				LNXX.LC_STA_LONXX = 'X'
				AND LNXX.LC_STA_LONXX = 'R'
				AND LNXX.LA_CUR_PRI > X
		) LNXX
			ON LNXX.BF_SSN = DWXX.BF_SSN
	WHERE
		DWXX.WC_DW_LON_STA = 'XX'
		AND LNXX.LC_STA_LONXX = 'R'
		AND LNXX.LA_CUR_PRI > X
		AND LNXX.BF_SSN IS NULL
) POP
INNER JOIN CDW..DWXX_DW_CLC_CLU DWXX
	ON DWXX.BF_SSN = POP.BF_SSN
	AND DWXX.WC_DW_LON_STA = 'XX'
ORDER BY 
	BF_SSN