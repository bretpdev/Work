SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
DROP TABLE IF EXISTS #POP
SELECT DISTINCT
	LN10.BF_SSN,
	LN10.LN_SEQ,
	LN10.LA_CUR_PRI,
	LN10.IF_DOE_LDR,
	LN35.IF_BND_ISS,
	LK10.PX_DSC_MDM AS LOAN_STATUS
INTO #POP
FROM 
	UDW..LN35_LON_OWN LN35
	INNER JOIN UDW..LN10_LON LN10
		ON LN10.BF_SSN = LN35.BF_SSN
		AND LN10.LN_SEQ = LN35.LN_SEQ
	INNER JOIN UDW..DW01_DW_CLC_CLU DW01
		ON DW01.BF_SSN = LN10.BF_SSN
		AND DW01.LN_SEQ = LN10.LN_SEQ
	INNER JOIN UDW..LK10_LS_CDE_LKP LK10
		ON LK10.PM_ATR = 'WC-DW-LON-STA'
		AND LK10.PX_ATR_VAL = DW01.WC_DW_LON_STA
	LEFT JOIN
	(
		SELECT DISTINCT
			BF_SSN
		FROM
			UDW..LN10_LON
		WHERE
			LA_CUR_PRI > 25
			
	) BAL2
		ON BAL2.BF_SSN = LN10.BF_SSN
	LEFT JOIN 
	(
		SELECT DISTINCT
			BF_SSN
		FROM
			UDW..LN10_LON
		WHERE
			LA_CUR_PRI <= 25
			AND LA_CUR_PRI > 0
	)BAL3
		ON BAL3.BF_SSN = LN10.BF_SSN
WHERE 
	IF_BND_ISS IN 
	(
		'93002011',
		'9301999O',
		'9302001R',
		'9302001S',
		'932006DD',
		'932010EE'
	)
	AND LC_STA_LON35 = 'A'
	AND GETDATE() BETWEEN LD_OWN_EFF_SR AND ISNULL(LD_OWN_EFF_END, '01-01-2099')
	AND LN10.LA_CUR_PRI > 0
	AND LC_STA_LON10 = 'R'
	AND 
	(
		BAL2.BF_SSN IS NULL  --LOANS WITH A BALANCE > 25
		OR
		BAL3.BF_SSN IS NOT NULL AND BAL2.BF_SSN IS NULL  --LOANS WITH A BALANCE < 25 AND > 25
	)


	SELECT * FROM #POP ORDER BY BF_SSN
SELECT DISTINCT
	LN10.*
FROM
	UDW..LN10_LON LN10
	INNER JOIN #POP P
		ON P.BF_SSN = LN10.BF_SSN
WHERE LN10.LA_CUR_PRI > 0
ORDER BY LN10.BF_SSN

		--SELECT
		--	BF_SSN,
		--	LN_SEQ,
		--	LA_CUR_PRI
		--FROM
		--	UDW..LN10_LON
		--WHERE
		--	LA_CUR_PRI <= 25
		--	AND LA_CUR_PRI > 0
		--	AND BF_SSN = ''