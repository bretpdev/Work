USE CDW
GO

;WITH ACTIVE_BORROWERS AS
(--get Active Duty borrowers from new SCRA tables:
	SELECT
		 DC.BorrSSN
	FROM
		[CLS].[scra].[DataComparison] DC
	WHERE
		DC.ActiveRow IN ('X')
		AND DC.CreatedAt > ('XXXX-XX-XX')--current month's file
		AND (
				BorrActive IN ('X')
				OR EndrActive IN ('X')
			)
)
SELECT DISTINCT 
	PDXX.DF_SPE_ACC_ID
	,PDXX.DM_PRS_X
	,PDXX.DM_PRS_MID
	,PDXX.DM_PRS_LST
	--,LNXX.LC_STA_LONXX
	,LNXX.LN_DLQ_MAX+X AS DELINQUENCY
FROM
	ACTIVE_BORROWERS AB
	INNER JOIN CDW..LNXX_LON LNXX
		ON AB.BorrSSN = LNXX.BF_SSN
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
	INNER JOIN CDW..LNXX_LON_DLQ_HST LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
WHERE
	LNXX.LA_CUR_PRI > X.XX
	AND LNXX.LC_STA_LONXX = 'R'
	AND	LNXX.LC_STA_LONXX = 'X'
ORDER BY
	DF_SPE_ACC_ID