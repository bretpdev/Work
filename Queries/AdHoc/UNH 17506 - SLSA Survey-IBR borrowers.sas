LIBNAME  DUSTER  REMOTE  SERVER=DUSTER  SLIBREF=WORK;
RSUBMIT;

PROC SQL;
	CONNECT TO DB2 (DATABASE=DLGSUTWH);

/*  1*/
	CREATE TABLE Q1 AS
		SELECT 
			*
		FROM 
			CONNECTION TO DB2 
				(
					SELECT
						1 AS NO,
						'Active IBR Borrower Count' AS QUESTION,
						COUNT(DISTINCT LN65.BF_SSN) AS ANSWER
					FROM	
						OLWHRM1.LN65_LON_RPS LN65
						JOIN OLWHRM1.DW01_DW_CLC_CLU DW01
							ON LN65.BF_SSN = DW01.BF_SSN
							AND LN65.LN_SEQ = DW01.LN_SEQ
					WHERE
						LN65.LC_TYP_SCH_DIS IN ('IB','IL')
						AND LN65.LC_STA_LON65 = 'A'
						AND DW01.WC_DW_LON_STA = '03'

					FOR READ ONLY WITH UR
				)
	;

/*	2*/
	CREATE TABLE Q2 AS
		SELECT 
			*
		FROM 
			CONNECTION TO DB2 
				(
					SELECT
						2 AS NO,
						'IBR and have PFH Borrower Count' AS QUESTION,
						COUNT(DISTINCT LN65.BF_SSN) AS ANSWER
					FROM	
						OLWHRM1.LN65_LON_RPS LN65
					WHERE
						LN65.LC_TYP_SCH_DIS IN ('IB')	
						AND LN65.LC_STA_LON65 = 'A'

					FOR READ ONLY WITH UR
				)
	;

/*  3*/
	CREATE TABLE Q3 AS
		SELECT 
			*
		FROM 
			CONNECTION TO DB2 
				(
					SELECT
						3 AS NO,
						'IBR with 0 PFH Payment Borrower Count' AS QUESTION,
						COUNT(DISTINCT LN65.BF_SSN) AS ANSWER
					FROM	
						OLWHRM1.LN65_LON_RPS LN65
						JOIN OLWHRM1.LN66_LON_RPS_SPF LN66
							ON LN65.BF_SSN = LN66.BF_SSN
							AND LN65.LN_SEQ = LN66.LN_SEQ
					WHERE
						LN65.LC_TYP_SCH_DIS IN ('IB')	
						AND LN65.LC_STA_LON65 = 'A'
						AND LN66.LA_RPS_ISL = 0

					FOR READ ONLY WITH UR
				)
	;

/*  4*/
	CREATE TABLE Q4 AS
		SELECT 
			*
		FROM 
			CONNECTION TO DB2 
				(
					SELECT
						4 AS NO,
						'IBR in Deferment or Forbearance Borrower Count' AS QUESTION,
						COUNT(DISTINCT LN65.BF_SSN) AS ANSWER
					FROM	
						OLWHRM1.LN65_LON_RPS LN65
						JOIN OLWHRM1.DW01_DW_CLC_CLU DW01
							ON LN65.BF_SSN = DW01.BF_SSN
							AND LN65.LN_SEQ = DW01.LN_SEQ
					WHERE
						LN65.LC_TYP_SCH_DIS IN ('IB','IL')
						AND LN65.LC_STA_LON65 = 'A'
						AND DW01.WC_DW_LON_STA IN ('04','05')

					FOR READ ONLY WITH UR
				)
	;

/*  5*/
	CREATE TABLE Q5 AS
		SELECT 
			*
		FROM 
			CONNECTION TO DB2 
				(
					SELECT DISTINCT
						5 AS NO,
						'Left IBR Borrower Count' AS QUESTION,
						COUNT(DISTINCT IIBR.BF_SSN) AS ANSWER
					FROM	
						OLWHRM1.LN65_LON_RPS IIBR
						JOIN OLWHRM1.LN65_LON_RPS LN65
							ON IIBR.BF_SSN = LN65.BF_SSN
							AND IIBR.LN_SEQ = LN65.LN_SEQ
					WHERE
						IIBR.LC_TYP_SCH_DIS IN ('IB','IL')
						AND IIBR.LC_STA_LON65 = 'I'
						AND LN65.LC_TYP_SCH_DIS NOT IN ('IB','IL')
						AND LN65.LC_STA_LON65 = 'A'
						AND LN65.LD_CRT_LON65 > IIBR.LD_CRT_LON65

					FOR READ ONLY WITH UR
				)
	;

/*  6*/
	CREATE TABLE Q6 AS
		SELECT 
			6 AS NO,
			'Active Repayment Loan Volume' AS QUESTION,
			SUM(LA_CUR_PRI) AS ANSWER
		FROM 
			CONNECTION TO DB2 
				(
					SELECT DISTINCT
						LN10.BF_SSN,
						LN10.LN_SEQ,
						LN10.LA_CUR_PRI
					FROM	
						OLWHRM1.LN65_LON_RPS LN65
						JOIN OLWHRM1.DW01_DW_CLC_CLU DW01
							ON LN65.BF_SSN = DW01.BF_SSN
							AND LN65.LN_SEQ = DW01.LN_SEQ
						JOIN OLWHRM1.LN10_LON LN10
							ON LN65.BF_SSN = LN10.BF_SSN
							AND LN65.LN_SEQ = LN10.LN_SEQ
					WHERE
						LN65.LC_TYP_SCH_DIS IN ('IB','IL')
						AND LN65.LC_STA_LON65 = 'A'
						AND DW01.WC_DW_LON_STA IN ('03')

					FOR READ ONLY WITH UR
				)
	;

/*  7*/
	CREATE TABLE Q7 AS
		SELECT 
			7 AS NO,
			'IBR not in Deferment or Forbearance Loan Volume' AS QUESTION,
			SUM(LA_CUR_PRI) AS ANSWER
		FROM 
			CONNECTION TO DB2 
				(
					SELECT DISTINCT
						LN10.BF_SSN,
						LN10.LN_SEQ,
						LN10.LA_CUR_PRI
					FROM	
						OLWHRM1.LN65_LON_RPS LN65
						JOIN OLWHRM1.DW01_DW_CLC_CLU DW01
							ON LN65.BF_SSN = DW01.BF_SSN
							AND LN65.LN_SEQ = DW01.LN_SEQ
						JOIN OLWHRM1.LN10_LON LN10
							ON LN65.BF_SSN = LN10.BF_SSN
							AND LN65.LN_SEQ = LN10.LN_SEQ
					WHERE
						LN65.LC_TYP_SCH_DIS IN ('IB','IL')
						AND LN65.LC_STA_LON65 = 'A'
						AND DW01.WC_DW_LON_STA IN ('03')

					FOR READ ONLY WITH UR
				)
	;

/*  8*/
	CREATE TABLE Q8 AS
		SELECT 
			8 AS NO,
			'IBR and have PFH Loan Volume' AS QUESTION,
			SUM(LA_CUR_PRI) AS ANSWER
		FROM 
			CONNECTION TO DB2 
				(
					SELECT DISTINCT
						LN10.BF_SSN,
						LN10.LN_SEQ,
						LN10.LA_CUR_PRI
					FROM	
						OLWHRM1.LN65_LON_RPS LN65
						JOIN OLWHRM1.DW01_DW_CLC_CLU DW01
							ON LN65.BF_SSN = DW01.BF_SSN
							AND LN65.LN_SEQ = DW01.LN_SEQ
						JOIN OLWHRM1.LN10_LON LN10
							ON LN65.BF_SSN = LN10.BF_SSN
							AND LN65.LN_SEQ = LN10.LN_SEQ
					WHERE
						LN65.LC_TYP_SCH_DIS IN ('IB')
						AND LN65.LC_STA_LON65 = 'A'
						AND DW01.WC_DW_LON_STA IN ('03')

					FOR READ ONLY WITH UR
				)
	;

/*  9*/
	CREATE TABLE Q9 AS
		SELECT 
			9 AS NO,
			'IBR with 0 PFH Payment Loan Volume' AS QUESTION,
			SUM(LA_CUR_PRI) AS ANSWER
		FROM 
			CONNECTION TO DB2 
				(
					SELECT DISTINCT
						LN10.BF_SSN,
						LN10.LN_SEQ,
						LN10.LA_CUR_PRI
					FROM	
						OLWHRM1.LN65_LON_RPS LN65
						JOIN OLWHRM1.LN10_LON LN10
							ON LN65.BF_SSN = LN10.BF_SSN
							AND LN65.LN_SEQ = LN10.LN_SEQ
						JOIN OLWHRM1.LN66_LON_RPS_SPF LN66
							ON LN65.BF_SSN = LN66.BF_SSN
							AND LN65.LN_SEQ = LN66.LN_SEQ
					WHERE
						LN65.LC_TYP_SCH_DIS IN ('IB')
						AND LN65.LC_STA_LON65 = 'A'
						AND LN66.LA_RPS_ISL = 0

					FOR READ ONLY WITH UR
				)
	;

/*  10*/
	CREATE TABLE Q10 AS
		SELECT
			10 AS NO,
			'IBR in Deferment or Forbearance Loan Volume' AS QUESTION,
			SUM(LA_CUR_PRI) AS ANSWER
		FROM 
			CONNECTION TO DB2 
				(
					SELECT DISTINCT
						LN10.BF_SSN,
						LN10.LN_SEQ,
						LN10.LA_CUR_PRI
					FROM	
						OLWHRM1.LN65_LON_RPS LN65
						JOIN OLWHRM1.DW01_DW_CLC_CLU DW01
							ON LN65.BF_SSN = DW01.BF_SSN
							AND LN65.LN_SEQ = DW01.LN_SEQ
						JOIN OLWHRM1.LN10_LON LN10
							ON LN65.BF_SSN = LN10.BF_SSN
							AND LN65.LN_SEQ = LN10.LN_SEQ
					WHERE
						LN65.LC_TYP_SCH_DIS IN ('IB','IL')
						AND LN65.LC_STA_LON65 = 'A'
						AND DW01.WC_DW_LON_STA IN ('04','05')

					FOR READ ONLY WITH UR
				)
	;

/*  11*/
	CREATE TABLE Q11 AS
		SELECT 
			11 AS NO,
			'Left IBR Loan Volume' AS QUESTION,
			SUM(LA_CUR_PRI) AS ANSWER
		FROM 
			CONNECTION TO DB2 
				(
					SELECT DISTINCT
						LN10.BF_SSN,
						LN10.LN_SEQ,
						LN10.LA_CUR_PRI
					FROM	
						OLWHRM1.LN65_LON_RPS IIBR
						JOIN OLWHRM1.LN65_LON_RPS LN65
							ON IIBR.BF_SSN = LN65.BF_SSN
							AND IIBR.LN_SEQ = LN65.LN_SEQ
						JOIN OLWHRM1.LN10_LON LN10
							ON LN65.BF_SSN = LN10.BF_SSN
							AND LN65.LN_SEQ = LN10.LN_SEQ
					WHERE
						IIBR.LC_TYP_SCH_DIS IN ('IB','IL')
						AND IIBR.LC_STA_LON65 = 'I'
						AND LN65.LC_TYP_SCH_DIS NOT IN ('IB','IL')
						AND LN65.LC_STA_LON65 = 'A'
						AND LN65.LD_CRT_LON65 > IIBR.LD_CRT_LON65

					FOR READ ONLY WITH UR
				)
	;

	DISCONNECT FROM DB2;

QUIT;

DATA RESULTS;
	FORMAT NO 2.;
	FORMAT QUESTION $50.;
	FORMAT ANSWER COMMA15.2;
	SET Q1 Q2 Q3 Q4 Q5 Q6 Q7 Q8 Q9 Q10 Q11;
RUN;

ENDRSUBMIT;

DATA RESULTS; SET DUSTER.RESULTS; RUN;

PROC EXPORT
		DATA = RESULTS
		OUTFILE = 'T:\SAS\NH 17506.XLS'
		REPLACE;
RUN;
