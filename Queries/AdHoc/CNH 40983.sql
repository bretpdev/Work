USE CDW
GO

SELECT
	PDXX.DF_SPE_ACC_ID AS ACCOUNT_NUMBER,
	LTRIM(RTRIM(PDXX.DM_PRS_X)) + ' ' + LTRIM(RTRIM(PDXX.DM_PRS_LST)) AS [NAME],
	LNXX.LN_SEQ AS LOAN_SEQ,
	LNXX.LA_CUR_PRI AS LOAN_BALANCE,
	ISNULL(CONVERT(VARCHAR(XX), DATEADD(MONTH, RS.LN_RPS_TRM, RS.TermStartDate), XXX), 'N/A') AS EXPECTED_PAYOFF,
	ISNULL(RS.PX_DSC_LNG, 'N/A')
FROM
	CDW..LNXX_LON LNXX
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = LNXX.BF_SSN
	LEFT JOIN 
	(
		SELECT
			RS.*,
			LKXX.PX_DSC_LNG
		FROM
			CDW.calc.RepaymentSchedules RS
			INNER JOIN CDW..LKXX_LS_CDE_LKP LKXX
				ON LKXX.PM_ATR = 'LC-TYP-SCH-DIS'
				AND LKXX.PX_ATR_VAL = RS.LC_TYP_SCH_DIS
			INNER JOIN 
			(
				SELECT
					BF_SSN,
					LN_SEQ,
					MAX(LN_GRD_RPS_SEQ) AS LN_GRD_RPS_SEQ
				FROM
					CDW.calc.RepaymentSchedules
				GROUP BY
					BF_SSN,
					LN_SEQ
			) MRS
				ON MRS.BF_SSN = RS.BF_SSN
				AND MRS.LN_SEQ = RS.LN_SEQ
				AND MRS.LN_GRD_RPS_SEQ = RS.LN_GRD_RPS_SEQ
	) RS
		ON RS.BF_SSN = LNXX.BF_SSN
		AND RS.LN_SEQ = LNXX.LN_SEQ
WHERE
	LNXX.IC_LON_PGM IN 
	(
	'DLSPCN', 'DLSSPL', 'DLUSPL'
	)	
	AND LNXX.LA_CUR_PRI > X
	AND LNXX.LC_STA_LONXX = 'R'