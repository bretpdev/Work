USE ODW
GO


SELECT DISTINCT
	PD01.DF_SPE_ACC_ID AS [Account Number],
	MAX(GA10.Loans) AS [Amount of Loans],
	MAX(GA10.Balance) AS [Outstanding Principal]
	--PD01.DM_PRS_1 AS [First Name],
	--PD01.DM_PRS_LST AS [Last Name],
	--ISNULL(DC11.LD_TRX_EFF, RM10.LX_RMT_TRX_EFF_DTE) AS [Effective Date],
	--ISNULL(DC11.LC_TRX_TYP, RM10.LC_RMT_TRX_TYP) AS [Transaction Type],
	--SUM(ISNULL(DC11.LA_TRX, LX_RMT_TRX_AMT)) AS Amount
FROM
	PD01_PDM_INF PD01
	INNER JOIN DC01_LON_CLM_INF DC01
		ON DC01.BF_SSN = PD01.DF_PRS_ID
	LEFT JOIN DC11_LON_FAT DC11
		ON DC11.BF_SSN = PD01.DF_PRS_ID
		AND DC11.LC_TRX_TYP IN ('DC')
		AND DC11.LD_TRX_EFF >= '03/13/2020' 
		AND 
		(
			DC11.LD_TRX_ADJ IS NULL
			OR (DC11.LD_TRX_ADJ IS NOT NULL AND DC11.LC_REV_IND_TYP != '')
		)
	LEFT JOIN 
	(
		SELECT
			*
		FROM
			OPENQUERY (DUSTER,
			'
				SELECT
					LF_PRS_ID,
					LC_RMT_TRX_TYP,
					LX_RMT_TRX_EFF_DTE,
					LX_RMT_TRX_AMT
				FROM
					OLWHRM1.RM10_RMT_SUS_DTL
				WHERE
					LC_RMT_TRX_TYP IN (''DC'')
					AND LX_RMT_TRX_EFF_DTE >= ''03/13/2020''
					AND LC_RMT_STA = ''S''
			')
	) RM10
		ON RM10.LF_PRS_ID = PD01.DF_PRS_ID
	LEFT JOIN
	(
		SELECT
			DF_PRS_ID,
			COUNT(AF_APL_ID_SFX) AS Loans,
			SUM(AA_CUR_PRI) AS Balance
		FROM
			PD01_PDM_INF PD01
			INNER JOIN GA01_APP GA01
				ON GA01.DF_PRS_ID_BR = PD01.DF_PRS_ID
			INNER JOIN GA10_LON_APP GA10
				ON GA10.AF_APL_ID = GA01.AF_APL_ID
		GROUP BY
			DF_PRS_ID
	) GA10
		ON GA10.DF_PRS_ID = PD01.DF_PRS_ID
WHERE
	(
		DC11.BF_SSN IS NOT NULL
		OR RM10.LF_PRS_ID IS NOT NULL
	)
	AND DC01.LF_CLM_ID != ''
GROUP BY
	PD01.DF_SPE_ACC_ID
	--PD01.DM_PRS_1 ,
	--PD01.DM_PRS_LST ,
	--ISNULL(DC11.LD_TRX_EFF, RM10.LX_RMT_TRX_EFF_DTE) ,
	--ISNULL(DC11.LC_TRX_TYP, RM10.LC_RMT_TRX_TYP) 
ORDER BY
	PD01.DF_SPE_ACC_ID ASC
	--ISNULL(DC11.LD_TRX_EFF, RM10.LX_RMT_TRX_EFF_DTE) ASC

