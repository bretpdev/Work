/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORTZ "&RPTLIB/UNWSXX.NWSXXRZ";
FILENAME REPORTX "&RPTLIB/UNWSXX.NWSXXRX";
LIBNAME  LEGEND  REMOTE  SERVER=LEGEND SLIBREF=work  ;

%LET START_DATE = 'XX/XX/XXXX';
%LET FINISH_DATE = 'XX/XX/XXXX';

%SYSLPUT START_DATE = &START_DATE;
%SYSLPUT FINISH_DATE  = &FINISH_DATE;

RSUBMIT LEGEND;
PROC SQL;
CONNECT TO DBX (DATABASE=DNFPUTDL);
CREATE TABLE PAIAQFAFED AS
SELECT *
FROM CONNECTION TO DBX(
	SELECT B.DF_SPE_ACC_ID
		,RTRIM(B.DM_PRS_X)||' '||RTRIM(B.DM_PRS_MID)||' '||B.DM_PRS_LST AS NAME
		,C.LF_FED_AWD
		,C.LN_FED_AWD_SEQ
		,A.LD_FAT_APL 
		,A.LD_FAT_EFF
		,A.PC_FAT_SUB_TYP
		,A.LA_FAT_CUR_PRI
		,A.LA_FAT_NSI
	FROM PKUB.LNXX_FIN_ATY A
	INNER JOIN PKUB.PDXX_PRS_NME B
		ON A.BF_SSN = B.DF_PRS_ID
	INNER JOIN PKUB.FSXX_DL_LON C
		ON A.BF_SSN = C.BF_SSN
		AND A.LN_SEQ = C.LN_SEQ
	WHERE A.PC_FAT_TYP = 'XX'
		AND A.LC_FAT_REV_REA IN ('X','X')
		AND DAYS(A.LD_FAT_APL) BETWEEN DAYS(&START_DATE) AND DAYS(&FINISH_DATE)
	FOR READ ONLY WITH UR);
	DISCONNECT FROM DBX;
QUIT;
ENDRSUBMIT;
DATA PAIAQFAFED;
	SET LEGEND.PAIAQFAFED; 
RUN;
PROC SORT DATA=PAIAQFAFED;
	BY LD_FAT_APL DF_SPE_ACC_ID LF_FED_AWD LN_FED_AWD_SEQ;
RUN;
DATA _NULL_;
	SET PAIAQFAFED;
	AWD_ID = CATT(LF_FED_AWD,PUT(LN_FED_AWD_SEQ,ZX.));
	FILE 'T:\SAS\PrincipalandInterestAdjustmentQueryForAuditFED.txt' delimiter=',' DSD DROPOVER lrecl=XXXXX;
	FORMAT DF_SPE_ACC_ID $XX. ;
	FORMAT NAME $XX. ;
	FORMAT AWD_ID $XX. ;
	FORMAT LD_FAT_APL MMDDYYXX. ;
	FORMAT LD_FAT_EFF MMDDYYXX. ;
	FORMAT PC_FAT_SUB_TYP $X. ;
	FORMAT LA_FAT_CUR_PRI XX.X ;
	FORMAT LA_FAT_NSI XX.X ;
	IF _N_ = X THEN DO;
		PUT 'Account Number'
			','
			'Name' 
			','
			'Award ID' 
			','
			'Applied Date' 
			','
			'Effective Date' 
			','
			'Payment Sub-Type' 
			','
			'Principal'
			','
			'Interest';
		END;
	DO;
		PUT DF_SPE_ACC_ID $ @;
		PUT NAME $ @;
		PUT AWD_ID $ @;
		PUT LD_FAT_APL @;
		PUT LD_FAT_EFF @;
		PUT PC_FAT_SUB_TYP $ @;
		PUT LA_FAT_CUR_PRI  @;
		PUT LA_FAT_NSI ;
	END;
RUN;
