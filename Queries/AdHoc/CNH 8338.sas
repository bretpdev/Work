LIBNAME  LEGEND  REMOTE  SERVER=LEGEND SLIBREF=work  ;
RSUBMIT LEGEND;
/*%let DB = DNFPRQUT;  *This is test;*/
/*%let DB = DNFPRUUT;  *This is VUKX test;*/
%let DB = DNFPUTDL;  *This is live;

LIBNAME PKUB DBX DATABASE=&DB OWNER=PKUB;


PROC SQL;
	CREATE TABLE RECRT_DUE AS
		SELECT DISTINCT
			RSXX.BF_SSN,
			MAX(BD_ANV_QLF_IBR) AS BD_ANV_QLF_IBR
		FROM
			PKUB.RSXX_IBR_RPS RSXX
			INNER JOIN PKUB.LNXX_LON_RPS LNXX
				ON LNXX.BF_SSN = RSXX.BF_SSN
		WHERE
			LNXX.LC_TYP_SCH_DIS IN('CA', 'CP', 'CQ', 'CX', 'CX', 'CX', 'IA', 'IB', 'IL', 'IP', 'IX', 'IX')
			AND LNXX.LC_STA_LONXX = 'A'
			AND RSXX.BC_STA_RSXX = 'A'
		GROUP BY
			RSXX.BF_SSN

;		
QUIT;

DATA DID_NOT_RECRT_CURRENT; SET LEGEND.DID_NOT_RECRT_CURRENT; RUN;

DATA FINAL;
	SET RECRT_DUE;
RUN;

ENDRSUBMIT;

DATA FINAL; SET LEGEND.FINAL; RUN;


%MACRO CREATE(NEWDS, TITLE);
PROC SQL;
	CREATE TABLE &NEWDS AS 
		SELECT DISTINCT
			&TITLE AS TITLE,
			JAN.JANURARY,
			FEB.FEBURARY,
			MAR.MARCH,
			APR.APRIL,
			M.MAY,
			JUN.JUNE,
			JUL.JULY,
			AUG.AUGUST,
			SEP.SEPTEMBER,
			OCT.OCTOBER,
			NOV.NOVEMBER,
			DEC.DECEMBER
		FROM
			FINAL 
		LEFT JOIN (
				SELECT 
					&TITLE AS TITLE,
					COUNT(DISTINCT BF_SSN) AS JANURARY
				FROM 
					FINAL 
				WHERE  
					MONTH(BD_ANV_QLF_IBR) = X
				)JAN
					ON JAN.TITLE = &TITLE
		LEFT JOIN (
					SELECT
						&TITLE AS TITLE,
						COUNT(DISTINCT BF_SSN) AS FEBURARY
					FROM
						FINAL
					WHERE
						MONTH(BD_ANV_QLF_IBR) = X 
				)FEB
					ON FEB.TITLE = &TITLE
		LEFT JOIN (
					SELECT
						&TITLE AS TITLE,
						COUNT(DISTINCT BF_SSN) AS MARCH
					FROM
						FINAL
					WHERE
						MONTH(BD_ANV_QLF_IBR) =X
					) MAR
						ON MAR.TITLE = &TITLE
		LEFT JOIN (
					SELECT
						&TITLE AS TITLE,
						COUNT(DISTINCT BF_SSN) AS APRIL
					FROM
						FINAL
					WHERE
						MONTH(BD_ANV_QLF_IBR) = X
					)APR
						ON APR.TITLE = &TITLE
		LEFT JOIN (
					SELECT
						&TITLE AS TITLE,
						COUNT(DISTINCT BF_SSN) AS MAY
					FROM
						FINAL
					WHERE
						MONTH(BD_ANV_QLF_IBR) = X
				)M
					ON M.TITLE = &TITLE
		LEFT JOIN (
					SELECT
						&TITLE AS TITLE,
						COUNT(DISTINCT BF_SSN) AS JUNE
					FROM
						FINAL
					WHERE
						MONTH(BD_ANV_QLF_IBR) = X
				)JUN
					ON JUN.TITLE = &TITLE
		LEFT JOIN (
					SELECT
						&TITLE AS TITLE,
						COUNT(DISTINCT BF_SSN) AS JULY
					FROM
						FINAL
					WHERE
						MONTH(BD_ANV_QLF_IBR) = X 
				) JUL
					ON JUL.TITLE = &TITLE
		LEFT JOIN (
					SELECT
						&TITLE AS TITLE,
						COUNT(DISTINCT BF_SSN) AS AUGUST
					FROM
						FINAL
					WHERE
						MONTH(BD_ANV_QLF_IBR) = X 
				)AUG
					ON AUG.TITLE = &TITLE
		LEFT JOIN (
					SELECT
						&TITLE AS TITLE,
						COUNT(DISTINCT BF_SSN) AS SEPTEMBER
					FROM
						FINAL
					WHERE
						MONTH(BD_ANV_QLF_IBR) = X 
				)SEP
					ON SEP.TITLE = &TITLE
		LEFT JOIN (
					SELECT
						&TITLE AS TITLE,
						COUNT(DISTINCT BF_SSN) AS OCTOBER
					FROM
						FINAL
					WHERE
						MONTH(BD_ANV_QLF_IBR) = XX 
				)OCT
					ON OCT.TITLE = &TITLE
		LEFT JOIN (
					SELECT
						&TITLE AS TITLE,
						COUNT(DISTINCT BF_SSN) AS NOVEMBER
					FROM
						FINAL
					WHERE
						MONTH(BD_ANV_QLF_IBR) = XX 
				)NOV
					ON NOV.TITLE = &TITLE
		LEFT JOIN (
					SELECT
						&TITLE AS TITLE,
						COUNT(DISTINCT BF_SSN) AS DECEMBER
					FROM
						FINAL
					WHERE
						MONTH(BD_ANV_QLF_IBR) = XX 
				)DEC
					ON DEC.TITLE = &TITLE
;
QUIT;
%MEND;

%CREATE(OUTPUTX, 'IDR BORROWERS BY ANNIVERSARY DATE');


DATA TOTALS;
	LENGTH TITLE $XXX.;
	SET OUTPUTX;
RUN; 


PROC EXPORT DATA = WORK.TOTALS 
            OUTFILE = "T:\NH XXXX.xlsx" 
            DBMS = EXCEL
			REPLACE;
     SHEET="SHEETX"; 
RUN;
