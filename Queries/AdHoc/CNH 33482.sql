SELECT DISTINCT
	PDXX.DF_PRS_ID AS BF_SSN,
	PDXX.DM_PRS_X AS FirstName,
	PDXX.DM_PRS_MID AS MiddleName,
	PDXX.DM_PRS_LST AS LastName,
	CONVERT(VARCHAR,PDXX.DD_BRT,XXX) AS DateOfBirth,
	PDXX.DC_SKP_TYP AS SkipType,
	PDXX.LastKnownPhone,
	PDXX.PhoneType,
	PDXX.PhoneVerifiedDate,
	PDXX.AddrX,
	PDXX.AddrX,
	PDXX.AddrX,
	PDXX.City,
	PDXX.State,
	PDXX.Zip,
	PDXX.AddressVerifiedDate,	
	LNXX.LF_DOE_SCL_ORG AS OriginalSchool,
	SDXX.LF_DOE_SCL_ENR_CUR AS CurrentSchool
FROM
	CDW..PDXX_PRS_NME PDXX
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
	LEFT JOIN CDW..LNXX_LON_STU_OSD LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	LEFT JOIN CDW..SDXX_STU_SPR SDXX
		ON SDXX.LF_STU_SSN = LNXX.LF_STU_SSN
		AND SDXX.LN_STU_SPR_SEQ = LNXX.LN_STU_SPR_SEQ
	INNER JOIN OPENQUERY
	(	
		LEGEND,
		'
			SELECT
				DF_PRS_ID,
				DC_SKP_TYP
			FROM
				PKUB.PDXX_PRS_SKP_PRC
			WHERE
				DC_STA_SKP = ''X''
				AND DD_SKP_END IS NULL
		'
	) PDXX
		ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
	LEFT JOIN 
	(
		SELECT
			PDXX.DF_PRS_ID,
			COALESCE(PDXX.DN_DOM_PHN_ARA,'') + COALESCE(PDXX.DN_DOM_PHN_XCH,'') + COALESCE(PDXX.DN_DOM_PHN_LCL,'') + COALESCE(PDXX.DN_PHN_XTN,'') AS LastKnownPhone,
			CASE WHEN PDXX.DC_PHN = 'A' THEN 'Alternate'
				 WHEN PDXX.DC_PHN = 'H' THEN 'Home'
				 WHEN PDXX.DC_PHN = 'W' THEN 'Work'
				 WHEN PDXX.DC_PHN = 'M' THEN 'Mobile'
				 ELSE '' END AS PhoneType,
			MAX(PDXX.DD_PHN_VER) AS PhoneVerifiedDate
		FROM
			CDW..PDXX_PRS_PHN PDXX
		GROUP BY
			PDXX.DF_PRS_ID,
			COALESCE(PDXX.DN_DOM_PHN_ARA,'') + COALESCE(PDXX.DN_DOM_PHN_XCH,'') + COALESCE(PDXX.DN_DOM_PHN_LCL,'') + COALESCE(PDXX.DN_PHN_XTN,''),
			CASE WHEN PDXX.DC_PHN = 'A' THEN 'Alternate'
				 WHEN PDXX.DC_PHN = 'H' THEN 'Home'
				 WHEN PDXX.DC_PHN = 'W' THEN 'Work'
				 WHEN PDXX.DC_PHN = 'M' THEN 'Mobile'
				 ELSE '' END
	) PDXX
		ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
	LEFT JOIN
	(
		SELECT
			PDXX.DF_PRS_ID,
			COALESCE(PDXX.DX_STR_ADR_X,'') AS AddrX,
			COALESCE(PDXX.DX_STR_ADR_X,'') AS AddrX,
			COALESCE(PDXX.DX_STR_ADR_X,'') AS AddrX,
			COALESCE(PDXX.DM_CT,'') AS City,
			COALESCE(PDXX.DC_DOM_ST,'') AS State,
			COALESCE(PDXX.DF_ZIP_CDE,'') AS Zip,
			MAX(PDXX.DD_VER_ADR) AS AddressVerifiedDate
		FROM
			CDW..PDXX_PRS_ADR PDXX
		WHERE
			PDXX.DC_ADR = 'L'
		GROUP BY
			PDXX.DF_PRS_ID,
			COALESCE(PDXX.DX_STR_ADR_X,''),
			COALESCE(PDXX.DX_STR_ADR_X,''),
			COALESCE(PDXX.DX_STR_ADR_X,''),
			COALESCE(PDXX.DM_CT,''),
			COALESCE(PDXX.DC_DOM_ST,''),
			COALESCE(PDXX.DF_ZIP_CDE,'')
	) PDXX
		ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
