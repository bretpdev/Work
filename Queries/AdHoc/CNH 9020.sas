%LET RPTLIB = T:\SAS;

LIBNAME  LEGEND  REMOTE  SERVER=LEGEND SLIBREF=WORK;

RSUBMIT;

%LET DB = DNFPUTDL; /*live*/
/*%LET DB = DLGSWQUT; /*test*/
LIBNAME PKUB DBX DATABASE=&DB OWNER=PKUB;

%MACRO SQLCHECK ;
  %IF  &SQLXRC NE X  %THEN  %DO  ;
    DATA _NULL_  ;
            FILE REPORTZ NOTITLES  ;
            PUT @XX " ********************************************************************* "
              / @XX " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
              / @XX " ****  THE SAS SHOULD BE REVIEWED.                                **** "       
              / @XX " ********************************************************************* "
              / @XX " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
              / @XX " ****  &SQLXMSG   **** "
              / @XX " ********************************************************************* "
            ;
         RUN  ;
  %END  ;
%MEND  ;

PROC SQL;
CONNECT TO DBX (DATABASE=&DB); 
CREATE TABLE BORROWERS_X AS
	SELECT *
	FROM CONNECTION TO DBX 
		(
		SELECT DISTINCT
			PDXX.DM_PRS_X AS FIRST_NAME
			,PDXX.DM_PRS_LST AS LAST_NAME
			,PDXX.DF_PRS_ID AS SSN
			,LNXX.LA_CUR_PRI
			,LNXX.LC_STA_LONXX
			,AYXX.PF_REQ_ACT
			,AYXX.LD_ATY_REQ_RCV
			,LNXX.LC_STA_LONXX 
			,LNXX.LC_INT_RDC_PGM
			,DFXX.LC_DFR_TYP
			,DFXX.LC_STA_DFRXX
		FROM 
			PKUB.PDXX_PRS_NME PDXX
			INNER JOIN PKUB.LNXX_LON LNXX
				ON PDXX.DF_PRS_ID = LNXX.BF_SSN
			INNER JOIN PKUB.LNXX_INT_RTE_HST LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
			INNER JOIN PKUB.DFXX_BR_DFR_REQ DFXX
				ON PDXX.DF_PRS_ID = DFXX.BF_SSN
			INNER JOIN PKUB.AYXX_BR_LON_ATY AYXX
				ON PDXX.DF_PRS_ID = AYXX.BF_SSN
		WHERE
			/*query X*/
			LNXX.LA_CUR_PRI > X 
			AND LNXX.LC_STA_LONXX = 'R'
			AND AYXX.PF_REQ_ACT IN ('DIBCR','DIDFR') 
			AND DAYS(AYXX.LD_ATY_REQ_RCV) BETWEEN DAYS('XX/XX/XXXX') AND DAYS('XX/XX/XXXX')
			/*section X: no military interest rate or deferment*/	
			AND LNXX.LC_STA_LONXX = 'A' 
			AND LNXX.LC_INT_RDC_PGM ='M'
			AND DFXX.LC_DFR_TYP IN ('XX','XX','XX','XX','XX')
			AND DFXX.LC_STA_DFRXX = 'A'
		)
;
CREATE TABLE BORROWERS_X AS
	SELECT *
	FROM CONNECTION TO DBX 
		(
		SELECT DISTINCT
			PDXX.DM_PRS_X AS FIRST_NAME
			,PDXX.DM_PRS_LST AS LAST_NAME
			,PDXX.DF_PRS_ID AS SSN
			,CASE
				WHEN LNXX.LC_STA_LONXX = 'A' 
					AND LNXX.LC_INT_RDC_PGM = 'M'
				THEN 'YES' 
				ELSE 'NO'
			END AS SCRA_REDUCTION
			,CASE
				WHEN DFXX.LC_DFR_TYP IN ('XX','XX','XX','XX','XX')
					AND DFXX.LC_STA_DFRXX = 'A'
				THEN 'YES' 
				ELSE 'NO'
			END AS MILITARY_DEFERMENT
			,LNXX.LA_CUR_PRI
			,LNXX.LC_STA_LONXX
			,AYXX.PF_REQ_ACT
			,AYXX.LD_ATY_REQ_RCV
			,LNXX.LC_STA_LONXX 
			,LNXX.LC_INT_RDC_PGM
			,DFXX.LC_DFR_TYP
			,DFXX.LC_STA_DFRXX
		FROM 
			PKUB.PDXX_PRS_NME PDXX
			INNER JOIN PKUB.LNXX_LON LNXX
				ON PDXX.DF_PRS_ID = LNXX.BF_SSN
			INNER JOIN PKUB.LNXX_INT_RTE_HST LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
			INNER JOIN PKUB.DFXX_BR_DFR_REQ DFXX
				ON PDXX.DF_PRS_ID = DFXX.BF_SSN
			INNER JOIN PKUB.AYXX_BR_LON_ATY AYXX
				ON PDXX.DF_PRS_ID = AYXX.BF_SSN
		WHERE
			/*query X*/
			LNXX.LA_CUR_PRI > X 
			AND LNXX.LC_STA_LONXX = 'R'
			AND AYXX.PF_REQ_ACT IN ('DIBCR','DIDFR') 
			AND DAYS(AYXX.LD_ATY_REQ_RCV) BETWEEN DAYS('XX/XX/XXXX') AND DAYS('XX/XX/XXXX')
			/*section X*/
			AND PDXX.DF_PRS_ID NOT IN 
				(
				SELECT DISTINCT
					PDXX.DF_PRS_ID
				FROM 
					PKUB.PDXX_PRS_NME PDXX
					INNER JOIN PKUB.LNXX_LON LNXX
						ON PDXX.DF_PRS_ID = LNXX.BF_SSN
					INNER JOIN PKUB.LNXX_INT_RTE_HST LNXX
						ON LNXX.BF_SSN = LNXX.BF_SSN
						AND LNXX.LN_SEQ = LNXX.LN_SEQ
					INNER JOIN PKUB.DFXX_BR_DFR_REQ DFXX
						ON PDXX.DF_PRS_ID = DFXX.BF_SSN
					INNER JOIN PKUB.AYXX_BR_LON_ATY AYXX
						ON PDXX.DF_PRS_ID = AYXX.BF_SSN
				WHERE
					/*query X*/
					LNXX.LA_CUR_PRI > X 
					AND LNXX.LC_STA_LONXX = 'R'
					AND AYXX.PF_REQ_ACT IN ('DIBCR','DIDFR') 
					AND DAYS(AYXX.LD_ATY_REQ_RCV) BETWEEN DAYS('XX/XX/XXXX') AND DAYS('XX/XX/XXXX')
					/*section X: no military interest rate or deferment*/	
					AND LNXX.LC_STA_LONXX = 'A' 
					AND LNXX.LC_INT_RDC_PGM ='M'
					AND DFXX.LC_DFR_TYP IN ('XX','XX','XX','XX','XX')
					AND DFXX.LC_STA_DFRXX = 'A'
				)
		)
;
CREATE TABLE BORROWERS_X AS
	SELECT *
	FROM CONNECTION TO DBX 
		(
		SELECT DISTINCT
			PDXX.DM_PRS_X AS FIRST_NAME
			,PDXX.DM_PRS_LST AS LAST_NAME
			,PDXX.DF_PRS_ID AS SSN
			,CASE
				WHEN LNXX.LC_STA_LONXX = 'A' 
					AND LNXX.LC_INT_RDC_PGM = 'M'
				THEN 'YES' 
				ELSE 'NO'
			END AS SCRA_REDUCTION
			,CASE
				WHEN DFXX.LC_DFR_TYP IN ('XX','XX','XX','XX','XX')
					AND DFXX.LC_STA_DFRXX = 'A'
				THEN 'YES' 
				ELSE 'NO'
			END AS MILITARY_DEFERMENT
			,LNXX.LA_CUR_PRI
			,LNXX.LC_STA_LONXX
			,AYXX.PF_REQ_ACT
			,AYXX.LD_ATY_REQ_RCV
			,LNXX.LC_STA_LONXX
			,LNXX.LC_INT_RDC_PGM
			,DFXX.LC_DFR_TYP
			,DFXX.LC_STA_DFRXX
		FROM 
			PKUB.PDXX_PRS_NME PDXX
			INNER JOIN PKUB.LNXX_LON LNXX
				ON PDXX.DF_PRS_ID = LNXX.BF_SSN
			INNER JOIN PKUB.LNXX_INT_RTE_HST LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
			INNER JOIN PKUB.DFXX_BR_DFR_REQ DFXX
				ON PDXX.DF_PRS_ID = DFXX.BF_SSN
			INNER JOIN PKUB.AYXX_BR_LON_ATY AYXX
				ON PDXX.DF_PRS_ID = AYXX.BF_SSN
		WHERE
			/*query X*/
			LNXX.LA_CUR_PRI > X 
			AND LNXX.LC_STA_LONXX = 'R'
			AND AYXX.PF_REQ_ACT IN ('SCRAA','SCRAD','MILAP','MIDNY') 
			AND DAYS(AYXX.LD_ATY_REQ_RCV) >= DAYS('XX/XX/XXXX')
		)
;
DISCONNECT FROM DBX;
%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>> ;  

QUIT;

ENDRSUBMIT;

DATA BORROWERS_X;
	SET LEGEND.BORROWERS_X;
RUN;

DATA BORROWERS_X;
	SET LEGEND.BORROWERS_X;
RUN;

DATA BORROWERS_X;
	SET LEGEND.BORROWERS_X;
RUN;

PROC EXPORT
		DATA=BORROWERS_X
		OUTFILE="&RPTLIB\CNH XXXX.xlsx"
		DBMS = EXCEL
		REPLACE;
		SHEET="QueryX_SectionX";
RUN;

PROC EXPORT
		DATA=BORROWERS_X
		OUTFILE="&RPTLIB\CNH XXXX.xlsx"
		DBMS = EXCEL
		REPLACE;
		SHEET="QueryX_SectionX";
RUN;

PROC EXPORT
		DATA=BORROWERS_X
		OUTFILE="&RPTLIB\CNH XXXX.xlsx"
		DBMS = EXCEL
		REPLACE;
		SHEET="QueryX_Output";
RUN;
