DROP TABLE IF EXISTS #POP

SELECT DISTINCT
--	PD10.DF_SPE_ACC_ID,
	LN10.BF_SSN,
	LN10.LN_SEQ,
	LN10.LC_STA_LON10 AS LOAN_STATUS, 
	LN10.LA_CUR_PRI AS CURRENT_PRINCIPAL_BALANCE,
	LN16.LN_DLQ_MAX + 1 AS DAYS_PAST_DUE,
	ISNULL(AY10_C.CALL_COUNT, 0) AS CALL_COUNT ,
	ISNULL(AY10_L.CALL_COUNT, 0) AS LETTER_COUNT 
INTO #POP
FROM 
	UDW..UNH70745 UNH
	--left JOIN UDW..PD10_PRS_NME PD10
	--	ON PD10.DF_PRS_ID = UNH.SSN
	INNER JOIN UDW..LN10_LON LN10
		ON LN10.BF_SSN = UNH.SSN
		AND LN10.LN_SEQ = UNH.[LOAN SEQ]
	INNER JOIN UDW..LN16_LON_DLQ_HST LN16
		ON UNH.SSN = LN16.BF_SSN
		AND UNH.[LOAN SEQ] = LN16.LN_SEQ
		AND LN16.LC_STA_LON16 = '1'
	LEFT JOIN 
	(
		SELECT
			BF_SSN,
			COUNT(*) AS CALL_COUNT
		FROM
			UDW..AY10_BR_LON_ATY AY10
		WHERE
			AY10.LC_STA_ACTY10 = 'A'
			AND AY10.PF_REQ_ACT = 'DDPHN'
			AND AY10.LD_ATY_REQ_RCV >= '02/25/2021'
			and AY10.LD_ATY_REQ_RCV < '03/04/2021'
		GROUP BY
			BF_SSN
	) AY10_C
		ON AY10_C.BF_SSN = LN10.BF_SSN
	LEFT JOIN 
	(
		SELECT
			BF_SSN,
			COUNT(*) AS CALL_COUNT
		FROM
			UDW..AY10_BR_LON_ATY AY10
		WHERE
			AY10.LC_STA_ACTY10 = 'A'
			AND AY10.PF_REQ_ACT IN ('DL200','DL201','DL400', 'DL401','DL800', 'DL801','DL910',
			 'DL911','DL140', 'DL141','DL170', 'DL171','DL202', 'DL203','DL230')
			AND AY10.LD_ATY_REQ_RCV >= '02/25/2021'
	
		GROUP BY
			BF_SSN
	) AY10_L
		ON AY10_L.BF_SSN = LN10.BF_SSN
		
SELECT
	*
FROM
	#POP 
WHERE
	CALL_COUNT > 0
	OR LETTER_COUNT > 0

SELECT 
	* 
FROM 
	#POP
WHERE
	CALL_COUNT = 0
	AND LETTER_COUNT = 0