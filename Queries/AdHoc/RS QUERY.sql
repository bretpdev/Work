SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


--CDW COUNTS
SELECT
	ISNULL(lkXX.PX_DSC_EX_LNG, LC_TYP_SCH_DIS) AS "REPAYMENT SCHEDULE",
	COUNT(DISTINCT RS.BF_SSN) AS "BORROWER COUNT",
	COUNT(*) AS "LOAN COUNT"
FROM
	CDW.calc.RepaymentSchedules RS
	LEFT JOIN 
	(
		SELECT * FROM OPENQUERY(DUSTER, 'SELECT * FROM OLWHRMX.LKXX_LS_CDE_LKP WHERE PM_ATR = ''LC-TYP-SCH-DIS''')
	) LKXX
		on LKXX.PX_ATR_VAL = RS.LC_TYP_SCH_DIS
WHERE
	RS.CurrentGradation = X
GROUP BY
	ISNULL(LKXX.PX_DSC_EX_LNG, LC_TYP_SCH_DIS)
ORDER BY
	COUNT(DISTINCT RS.BF_SSN) DESC

GO

--CDW BORROWER DETAIL


SELECT
	* 
	--PDXX.DF_SPE_ACC_ID AS "Account Number",
	--ISNULL(lkXX.PX_DSC_EX_LNG, LC_TYP_SCH_DIS) AS "REPAYMENT SCHEDULE"
FROM
	CDW.calc.RepaymentSchedules RS
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = RS.BF_SSN
	INNER JOIN CDW..LNXX_LON LNXX
		ON RS.BF_SSN = LNXX.BF_SSN
		AND RS.LN_SEQ = LNXX.LN_SEQ
	LEFT JOIN 
	(
		SELECT * FROM OPENQUERY(LEGEND, 'SELECT PM_ATR
		,TRIM(PX_ATR_VAL) AS PX_ATR_VAL 
		,TRIM(PX_DSC_EX_LNG) AS PX_DSC_EX_LNG
		FROM PKUB.LKXX_LS_CDE_LKP WHERE PM_ATR = ''LC-TYP-SCH-DIS''')
	) LKXX
		on LKXX.PX_ATR_VAL = RS.LC_TYP_SCH_DIS
WHERE
	DF_SPE_ACC_ID = 'XXXXXXXXXX'
	--RS.CurrentGradation = X
	AND LNXX.LC_STA_LONXX = 'R'
	AND LNXX.LA_CUR_PRI > X
	--order by [Account Number]

go

--UDW COUNTS
SELECT 
	ISNULL(lkXX.PX_DSC_EX_LNG, LC_TYP_SCH_DIS) AS "REPAYMENT SCHEDULE",
	COUNT(DISTINCT RS.BF_SSN) AS "BORROWER COUNT",
	COUNT(*) AS "LOAN COUNT"
FROM
	UDW.calc.RepaymentSchedules RS
	LEFT JOIN 
	(
		SELECT * FROM OPENQUERY(DUSTER, 'SELECT * FROM OLWHRMX.LKXX_LS_CDE_LKP WHERE PM_ATR = ''LC-TYP-SCH-DIS''')
	) LKXX
		on LKXX.PX_ATR_VAL = RS.LC_TYP_SCH_DIS
WHERE
	RS.CurrentGradation = X
GROUP BY
	ISNULL(LKXX.PX_DSC_EX_LNG, LC_TYP_SCH_DIS)
ORDER BY
	COUNT(DISTINCT RS.BF_SSN) DESC

--UDW BORROWER DETAIL
USE UDW
SELECT DISTINCT
	PDXX.DF_SPE_ACC_ID AS "Account Number",
	ISNULL(lkXX.PX_DSC_EX_LNG, LC_TYP_SCH_DIS) AS "REPAYMENT SCHEDULE"
FROM
	UDW.calc.RepaymentSchedules RS
	INNER JOIN UDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = RS.BF_SSN
	LEFT JOIN 
	(
		SELECT * FROM OPENQUERY(DUSTER, 'SELECT * FROM OLWHRMX.LKXX_LS_CDE_LKP WHERE PM_ATR = ''LC-TYP-SCH-DIS''')
	) LKXX
		on LKXX.PX_ATR_VAL = RS.LC_TYP_SCH_DIS
WHERE
	RS.CurrentGradation = X
AND LA_CUR_PRI > X