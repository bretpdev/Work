--run on UHEAASQLDB
USE ULS
GO

BEGIN TRY
	BEGIN TRANSACTION;

		DECLARE @ROWCOUNT INT = 0
				,@ExpectedRowCount INT = 535 --# of distinct zips + 1 disaster forb
				,@Disaster VARCHAR(100) = 'South Carolina Severe Storms, Tornadoes, And Straight-line Winds (DR-4542)'
				,@BeginDate DATE = CONVERT(DATE,'20200502') --declaration date
				,@AddedBy VARCHAR(50) = 'UNH 67213' --change to current NH ticket
				,@DisasterID_initial INT = (SELECT MAX(DisasterId)+1 FROM dasforbuh.Disasters)
				,@DelinquencyOverride BIT = 0 --default 0, COVID 1;

		--SET IDENTITY_INSERT [dasforbuh].[Disasters] ON; --OPSDEV ONLY

			INSERT INTO [dasforbuh].[Disasters]
			(
				DisasterId, 
				Disaster, 
				BeginDate, 
				EndDate, 
				MaxEndDate, 
				DelinquencyOverride, --set to 1 for COVID
				Active, 
				AddedBy
			)
			VALUES
			(
				@DisasterID_initial, 
				@Disaster, 
				@BeginDate, 
				DATEADD(DAY, 89, @BeginDate), 
				DATEADD(DAY, 89, @BeginDate), 
				@DelinquencyOverride, 
				1, 
				@AddedBy
			);--1
			-- Save/Set the row count from the previously executed statement
			SELECT @ROWCOUNT = @@ROWCOUNT;		
		
		--SET IDENTITY_INSERT [dasforbuh].[Disasters] OFF; --OPSDEV ONLY
		
		--Affected zip codes:
		DECLARE @DisasterID INT = (SELECT DisasterId FROM dasforbuh.Disasters WHERE Disaster = @Disaster);

		DECLARE @Zips1 TABLE (ZipCode VARCHAR(5)); 
		INSERT INTO @Zips1 (ZipCode) VALUES
('29485'),
('29532'),
('29078'),
('29152'),
('29229'),
('29484'),
('29717'),
('29062'),
('29681'),
('29543'),
('29426'),
('29067'),
('29065'),
('29045'),
('29403'),
('29351'),
('29501'),
('29530'),
('29406'),
('29842'),
('29376'),
('29487'),
('29702'),
('29104'),
('29304'),
('29647'),
('29527'),
('29409'),
('29016'),
('29113'),
('29046'),
('29643'),
('29929'),
('29053'),
('29935'),
('29646'),
('29145'),
('29727'),
('29568'),
('29330'),
('29829'),
('29614'),
('29715'),
('29682'),
('29567'),
('29215'),
('29940'),
('29290'),
('29912'),
('29687'),
('29594'),
('29692'),
('29588'),
('29115'),
('29926'),
('29168'),
('29941'),
('29578'),
('29582'),
('29058'),
('29127'),
('29201'),
('29822'),
('29659'),
('29125'),
('29138'),
('29370'),
('29360'),
('29540'),
('29080'),
('29353'),
('29726'),
('29566'),
('29686'),
('29048'),
('29916'),
('29604'),
('29933'),
('29612'),
('29729'),
('29575'),
('29135'),
('29510'),
('29712'),
('29922'),
('29742'),
('29044'),
('29332'),
('29203'),
('29563'),
('29410'),
('29813'),
('29349'),
('29860'),
('29202'),
('29161'),
('29221'),
('29412'),
('29519'),
('29627'),
('29602'),
('29503'),
('29431'),
('29042'),
('29030'),
('29414'),
('29483'),
('29716'),
('29556'),
('29102'),
('29581'),
('29474'),
('29709'),
('29654'),
('29148'),
('29801'),
('29305'),
('29417'),
('29323'),
('29849'),
('29118'),
('29693'),
('29526'),
('29905'),
('29378'),
('29587'),
('29921'),
('29469'),
('29938'),
('29564'),
('29626'),
('29721'),
('29673'),
('29685'),
('29457'),
('29610'),
('29732'),
('29047'),
('29292'),
('29334'),
('29059'),
('29714'),
('29331'),
('29170'),
('29070'),
('29653'),
('29551'),
('29679'),
('29212'),
('29541'),
('29146'),
('29846'),
('29365'),
('29927'),
('29355'),
('29597'),
('29576'),
('29423'),
('29516'),
('29722'),
('29434'),
('29101'),
('29321'),
('29227'),
('29450'),
('29903'),
('29628'),
('29133'),
('29384'),
('29915'),
('29745'),
('29932'),
('29812'),
('29724'),
('29598'),
('29464'),
('29658'),
('29570'),
('29105'),
('29636'),
('29924'),
('29217'),
('29002'),
('29219'),
('29333'),
('29415'),
('29667'),
('29021'),
('29015'),
('29230'),
('29545'),
('29180'),
('29175'),
('29031'),
('29631'),
('29130'),
('29369'),
('29033'),
('29439'),
('29452'),
('29943'),
('29838'),
('29828'),
('29661'),
('29032'),
('29472'),
('29608'),
('29129'),
('29911'),
('29695'),
('29451'),
('29072'),
('29918'),
('29316'),
('29493'),
('29018'),
('29554'),
('29639'),
('29301'),
('29704'),
('29122'),
('29802'),
('29634'),
('29632'),
('29061'),
('29841'),
('29001'),
('29010'),
('29440'),
('29218'),
('29054'),
('29226'),
('29449'),
('29669'),
('29683'),
('29210'),
('29914'),
('29560'),
('29240'),
('29225'),
('29303'),
('29656'),
('29642'),
('29821'),
('29591'),
('29107'),
('29571'),
('29453'),
('29036'),
('29117'),
('29442'),
('29696'),
('29677'),
('29037'),
('29465'),
('29645'),
('29831'),
('29324'),
('29585'),
('29665'),
('29420'),
('29590'),
('29432'),
('29844'),
('29899'),
('29901'),
('29438'),
('29601'),
('29504'),
('29657'),
('29348'),
('29856'),
('29648'),
('29550'),
('29906'),
('29492'),
('29335'),
('29652'),
('29385'),
('29137'),
('29670'),
('29625'),
('29447'),
('29081'),
('29056'),
('29555'),
('29861'),
('29437'),
('29216'),
('29419'),
('29260'),
('29063'),
('29835'),
('29718'),
('29834'),
('29147'),
('29728'),
('29520'),
('29651'),
('29208'),
('29920'),
('29583'),
('29209'),
('29340'),
('29456'),
('29936'),
('29904'),
('29479'),
('29819'),
('29325'),
('29207'),
('29678'),
('29925'),
('29040'),
('29488'),
('29505'),
('29708'),
('29151'),
('29123'),
('29607'),
('29689'),
('29162'),
('29902'),
('29945'),
('29320'),
('29014'),
('29178'),
('29436'),
('29475'),
('29468'),
('29731'),
('29319'),
('29150'),
('29128'),
('29073'),
('29609'),
('29404'),
('29214'),
('29913'),
('29688'),
('29402'),
('29069'),
('29143'),
('29346'),
('29672'),
('29613'),
('29832'),
('29706'),
('29720'),
('29166'),
('29733'),
('29909'),
('29116'),
('29356'),
('29039'),
('29923'),
('29848'),
('29250'),
('29172'),
('29112'),
('29730'),
('29020'),
('29142'),
('29071'),
('29907'),
('29816'),
('29928'),
('29220'),
('29840'),
('29630'),
('29422'),
('29006'),
('29338'),
('29577'),
('29544'),
('29379'),
('29425'),
('29580'),
('29615'),
('29824'),
('29569'),
('29635'),
('29336'),
('29041'),
('29377'),
('29690'),
('29302'),
('29734'),
('29405'),
('29079'),
('29839'),
('29169'),
('29662'),
('29697'),
('29644'),
('29741'),
('29205'),
('29401'),
('29470'),
('29547'),
('29160'),
('29055'),
('29461'),
('29624'),
('29620'),
('29163'),
('29638'),
('29153'),
('29154'),
('29603'),
('29707'),
('29455'),
('29850'),
('29680'),
('29224'),
('29003'),
('29836'),
('29710'),
('29703'),
('29038'),
('29572'),
('29228'),
('29341'),
('29206'),
('29009'),
('29386'),
('29596'),
('29650'),
('29075'),
('29126'),
('29329'),
('29574'),
('29666'),
('29525'),
('29418'),
('29177'),
('29805'),
('29621'),
('29845'),
('29486'),
('29675'),
('29052'),
('29171'),
('29407'),
('29809'),
('29413'),
('29817'),
('29640'),
('29843'),
('29617'),
('29810'),
('29482'),
('29074'),
('29375'),
('29416'),
('29512'),
('29611'),
('29435'),
('29826'),
('29847'),
('29622'),
('29676'),
('29445'),
('29307'),
('29518'),
('29536'),
('29372'),
('29458'),
('29306'),
('29342'),
('29111'),
('29671'),
('29204'),
('29664'),
('29579'),
('29322'),
('29589'),
('29223'),
('29477'),
('29649'),
('29082'),
('29584'),
('29623'),
('29605'),
('29910'),
('29388'),
('29429'),
('29808'),
('29395'),
('29528'),
('29691'),
('29939'),
('29506'),
('29481'),
('29804'),
('29132'),
('29633'),
('29433'),
('29108'),
('29593'),
('29114'),
('29424'),
('29364'),
('29511'),
('29471'),
('29744'),
('29448'),
('29476'),
('29565'),
('29641'),
('29606'),
('29944'),
('29592'),
('29934'),
('29931'),
('29803'),
('29373'),
('29827'),
('29222'),
('29616'),
('29743'),
('29502'),
('29211'),
('29051'),
('29164'),
('29655'),
('29684'),
('29374'),
('29368'),
('29851'),
('29853'),
('29466'),
('29446'),
('29546')
;
--		DECLARE @Zips2 TABLE (ZipCode VARCHAR(5));
--		INSERT INTO @Zips2 (ZipCode) VALUES 
--;

--		DECLARE @Zips3 TABLE (ZipCode VARCHAR(5));
--		INSERT INTO @Zips3 (ZipCode) VALUES
--;


--;WITH Z AS
--(
--	SELECT * FROM @ZIPS1 
--	--UNION ALL
--	--SELECT * FROM @ZIPS2 
--	--UNION ALL
--	--SELECT * FROM @ZIPS3
--)
--	select 'all_zips' as category, count(ZipCode) as tally from z
--	union all
--	select 'distinct_zips' as category, count(distinct ZipCode) as tally from z
--;
----534

		IF NOT EXISTS 
		(
			SELECT 
				ZipId 
			FROM 
				[dasforbuh].[Zips] Z1
				INNER JOIN 
				(
					SELECT * FROM @ZIPS1 
					--UNION ALL
					--SELECT * FROM @ZIPS2 
					--UNION ALL
					--SELECT * FROM @ZIPS3 			
				) Z2
					ON Z1.ZipCode = Z2.ZipCode
			WHERE
				Z1.DisasterId = @DisasterID
		)
		BEGIN
			INSERT INTO 
				[dasforbuh].[Zips]	(ZipCode, DisasterId)
			SELECT DISTINCT
				ZipCode
				,@DisasterID 
			FROM 
				(
					SELECT * FROM @ZIPS1 
					--UNION ALL
					--SELECT * FROM @ZIPS2 
					--UNION ALL
					--SELECT * FROM @ZIPS3 			
				)z
		END;

		-- Save/Set the row count from the previously executed statement
		SELECT @ROWCOUNT = @ROWCOUNT + @@ROWCOUNT;

	IF @ROWCOUNT = @ExpectedRowCount
		BEGIN
			PRINT 'Transaction committed.'
			COMMIT TRANSACTION
			--ROLLBACK TRANSACTION
		END
	ELSE
		BEGIN
			PRINT 'Transaction NOT committed.';
			PRINT 'Expected row count not met. Expecting ' +  CAST(@ExpectedRowCount AS VARCHAR(10)) + ' rows, but returned ' + CAST(@ROWCOUNT AS VARCHAR(10))+ ' rows.';
			ROLLBACK TRANSACTION;
		END
END TRY
BEGIN CATCH
	PRINT 'Transaction NOT committed. Errors found in SQL statement.';
	ROLLBACK TRANSACTION;
	THROW;
END CATCH;
