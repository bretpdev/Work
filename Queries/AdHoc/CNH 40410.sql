
SELECT
POP.*,
CONCAT(RIGHT('XX' + CAST(MONTH(DATEADD(MONTH, X, GETDATE())) AS VARCHAR(XX)), X) + '/',  RIGHT('XX' + CAST(POP.DUE_DATE_BEFORE_FORB AS VARCHAR(X)), X) + '/', CAST(YEAR(GETDATE()) AS VARCHAR(XX))) AS EXPECTED_NEXT_DUE_DATE
FROM
(
	SELECT
		LNXX.BF_SSN,
		LNXX.LN_SEQ,
		DAY(LD_BIL_DU_LON) AS DUE_DATE_BEFORE_FORB,
		CASE 
			WHEN DAY(CAST(GETDATE() AS DATE)) <= DAY(DATEADD(DAY, -XX, LD_BIL_DU_LON)) 
			THEN CONCAT(RIGHT('XX' + CAST(MONTH(GETDATE()) AS VARCHAR(XX)), X) + '/',  RIGHT('XX' + CAST(DAY(DATEADD(DAY, -XX, LD_BIL_DU_LON)) AS VARCHAR(XX)),X) + '/', CAST(YEAR(GETDATE()) AS VARCHAR(XX)))
			ELSE  CONCAT(RIGHT('XX' + CAST(MONTH(DATEADD(MONTH, X, GETDATE())) AS VARCHAR(XX)), X) + '/',  RIGHT('XX' + CAST(DAY(DATEADD(DAY, -XX, LD_BIL_DU_LON)) AS VARCHAR(XX)),X) + '/', CAST(YEAR(GETDATE()) AS VARCHAR(XX)))
		END AS FORB_END_DATE
	--	*
	FROM
		CDW..LNXX_LON_BIL_CRF LNXX
		INNER JOIN 
		(
			SELECT 
				BF_SSN,
				LN_SEQ,
				MAX(LD_BIL_CRT) AS MAX_LD_BIL_CRT
			FROM
				CDW..LNXX_LON_BIL_CRF
			WHERE
				BF_SSN IN 
				(
				'XXXXXXXXX',
				'XXXXXXXXX',
				'XXXXXXXXX',
				'XXXXXXXXX',
				'XXXXXXXXX',
				'XXXXXXXXX',
				'XXXXXXXXX',
				'XXXXXXXXX',
				'XXXXXXXXX',
				'XXXXXXXXX',
				'XXXXXXXXX',
				'XXXXXXXXX',
				'XXXXXXXXX',
				'XXXXXXXXX'
				)
			GROUP BY
				BF_SSN,
				LN_SEQ

		)MLNXX
			ON MLNXX.BF_SSN = LNXX.BF_SSN
			AND MLNXX.LN_SEQ = LNXX.LN_SEQ
			AND MLNXX.MAX_LD_BIL_CRT = LNXX.LD_BIL_CRT

) POP
	ORDER BY
		POP.BF_SSN,
		POP.LN_SEQ