USE ODW
GO

SELECT
	PD01.DF_SPE_ACC_ID,
	CAST(MAX(AY01.BF_CRT_DTS_AY01) AS DATE) AS ACTION_DATE
FROM
	ODW..AY01_BR_ATY AY01
	INNER JOIN ODW..PD01_PDM_INF PD01
		ON PD01.DF_PRS_ID = AY01.DF_PRS_ID
	INNER JOIN 
	(
		SELECT
			DC01.*
		FROM
			ODW..DC01_LON_CLM_INF DC01
			INNER JOIN 
			(
				SELECT DISTINCT
					DC01.BF_SSN,
					DC01.AF_APL_ID,
					DC01.AF_APL_ID_SFX,
					MAX(DC01.LF_CRT_DTS_DC10) AS MaxDate
				FROM
					ODW..DC01_LON_CLM_INF DC01
				GROUP BY
					DC01.BF_SSN,
					DC01.AF_APL_ID,
					DC01.AF_APL_ID_SFX
				) DC01M
					ON DC01.AF_APL_ID = DC01M.AF_APL_ID
					AND DC01.AF_APL_ID_SFX = DC01M.AF_APL_ID_SFX
					AND DC01.LF_CRT_DTS_DC10 = DC01M.MaxDate
			WHERE
					DC01.LC_PCL_REA = 'DF'
					AND DC01.LC_STA_DC10 = '03'
					AND DC01.LD_CLM_ASN_DOE IS NULL
					
					AND ISNULL(DC01.LC_REA_CLM_ASN_DOE,'') = ''
	) DC01
		ON DC01.BF_SSN = AY01.DF_PRS_ID
		INNER JOIN ODW..DC02_BAL_INT DC02 --STILL CURRENTLY IN DEFAULT
			ON DC02.AF_APL_ID = DC01.AF_APL_ID
			AND DC02.AF_APL_ID_SFX = DC01.AF_APL_ID_SFX
			AND DC02.LF_CRT_DTS_DC10 = DC01.LF_CRT_DTS_DC10
			AND DC02.LA_CLM_BAL > 0.00
WHERE
	PF_ACT = 'DLDF1'
	AND BF_CRT_DTS_AY01 >= '03/13/2020'
GROUP BY
	PD01.DF_SPE_ACC_ID