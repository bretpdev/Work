PROC IMPORT
		OUT=SLMA
		DATAFILE='T:\SLMA BORRS - ISSUE X.XLSX'
		DBMS=EXCEL
		REPLACE;
RUN;
		
LIBNAME LEGEND REMOTE SERVER=LEGEND SLIBREF=WORK;

DATA LEGEND.SLMA; SET SLMA; RUN;

RSUBMIT;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;

PROC SQL;
	CREATE TABLE SLMA_INFO AS
		SELECT DISTINCT
			SLMA.BF_SSN,
			FSXX.LN_SEQ,
			FSXX.LF_FED_AWD||PUT(FSXX.LN_FED_AWD_SEQ,ZX.) AS Award_ID,
     		RSXX.BD_ANV_QLF_IBR AS ICR_Anniv_Date,
     		FSXX.LA_ICR_BAL_RPY_SR AS Princ_Bal_at_Repayment,
     		RSXX.LA_PMN_STD_PAY AS Perm_Standard_Amt,
			CASE
				WHEN  FSXX.LA_ICR_NEG_AMR_IC GE FSXX.LA_ICR_CAP_LMT_NEG THEN 'Y'
				ELSE 'N'
			END AS ICR_XX_Percent_Indicator,
			FSXX.LD_LON_ICR_ENT
	 	FROM
			SLMA
			JOIN PKUB.FSXX_DL_LON FSXX
				ON SLMA.BF_SSN = FSXX.BF_SSN
			JOIN PKUB.RSXX_IBR_IRL_LON RSXX
				ON FSXX.BF_SSN = RSXX.BF_SSN
				AND FSXX.LN_SEQ = RSXX.LN_SEQ
			JOIN PKUB.RSXX_IBR_RPS RSXX
				ON RSXX.BF_SSN = RSXX.BF_SSN
				AND RSXX.BD_CRT_RSXX = RSXX.BD_CRT_RSXX
				AND RSXX.BN_IBR_SEQ = RSXX.BN_IBR_SEQ
		ORDER BY
			SLMA.BF_SSN
	;

	CREATE TABLE ICR_CAP AS
		SELECT DISTINCT
			SI.BF_SSN,
			SI.LN_SEQ,
			MAX(LNXX.LD_FAT_EFF) AS ICR_Cap_Interest_Date
		FROM
			SLMA_INFO SI
			LEFT JOIN PKUB.LNXX_FIN_ATY LNXX
				ON SI.BF_SSN = LNXX.BF_SSN
				AND SI.LN_SEQ = LNXX.LN_SEQ
				AND LNXX.PC_FAT_TYP = 'XX'
				AND LNXX.PC_FAT_SUB_TYP = 'XX'
				AND LNXX.LC_FAT_REV_REA = ''
				AND LNXX.LC_STA_LONXX = 'A'
			LEFT JOIN PKUB.LNXX_BR_DFR_APV LNXX
				ON SI.BF_SSN = LNXX.BF_SSN
				AND SI.LN_SEQ = LNXX.LN_SEQ
				AND LNXX.LC_STA_LONXX = 'A'
			LEFT JOIN PKUB.LNXX_BR_FOR_APV LNXX
				ON SI.BF_SSN = LNXX.BF_SSN
				AND SI.LN_SEQ = LNXX.LN_SEQ
				AND LNXX.LC_STA_LONXX = 'A'
		WHERE
			LNXX.LD_FAT_EFF NE LNXX.LD_DFR_END
			AND LNXX.LD_FAT_EFF NE LNXX.LD_FOR_END
		GROUP BY
			SI.BF_SSN,
			SI.LN_SEQ			
	;

/*	CREATE TABLE ICR_PMT_CNTR AS*/
/*		SELECT DISTINCT*/
/*			SI.BF_SSN,*/
/*			SI.LN_SEQ,*/
/*			CASE*/
/*				WHEN LNXX.LC_TYP_SCH_DIS IN ('CX', 'CX', 'CX', 'CL', 'CQ') THEN X*/
/*				WHEN COALESCE(LNXX.LA_TOT_BIL_STS,X) GE DWXX.WA_STD_STD_ISL THEN X*/
/*				WHEN LNXX.LA_BIL_CUR_DU = X THEN X*/
/*				ELSE X*/
/*			END AS CNT,*/
/*			LNXX.LD_BIL_CRT,*/
/*			LNXX.LN_SEQ_BIL_WI_DTE,*/
/*			DWXX.WA_STD_STD_ISL*/
/*		FROM*/
/*			SLMA_INFO SI*/
/*			JOIN PKUB.LNXX_LON_BIL_CRF LNXX*/
/*				ON SI.BF_SSN = LNXX.BF_SSN*/
/*				AND SI.LN_SEQ = LNXX.LN_SEQ*/
/*				AND LNXX.LD_BIL_DU_LON > SI.LD_LON_ICR_ENT*/
/*				AND LNXX.LC_LON_STA_BIL = 'X'*/
/*				AND LNXX.LC_STA_LONXX = 'A'*/
/*			LEFT JOIN PKUB.RMXX_BR_RMT RMXX*/
/*				ON LNXX.BF_SSN = RMXX.BF_SSN*/
/*				AND LNXX.LD_BIL_CRT = RMXX.LD_BIL_CRT*/
/*				AND LNXX.LN_SEQ_BIL_WI_DTE = RMXX.LN_SEQ_BIL_WI_DTE*/
/*			LEFT JOIN PKUB.LNXX_LON_PAY_FAT LNXX*/
/*				ON SI.BF_SSN = LNXX.BF_SSN*/
/*				AND SI.LN_SEQ = LNXX.LN_SEQ*/
/*				AND RMXX.LD_RMT_BCH_INI = LNXX.LD_RMT_BCH_INI*/
/*				AND RMXX.LC_RMT_BCH_SRC_IPT = LNXX.LC_RMT_BCH_SRC_IPT*/
/*				AND RMXX.LN_RMT_BCH_SEQ = LNXX.LN_RMT_BCH_SEQ*/
/*				AND RMXX.LN_RMT_SEQ = LNXX.LN_RMT_SEQ*/
/*				AND RMXX.LN_RMT_ITM = LNXX.LN_RMT_ITM */
/*				AND RMXX.LN_RMT_ITM_SEQ = LNXX.LN_RMT_ITM_SEQ*/
/*			LEFT JOIN PKUB.LNXX_FIN_ATY LNXX*/
/*				ON LNXX.BF_SSN = LNXX.BF_SSN*/
/*				AND LNXX.LN_SEQ = LNXX.LN_SEQ*/
/*				AND LNXX.LN_FAT_SEQ = LNXX.LN_FAT_SEQ*/
/*				AND LNXX.LC_FAT_REV_REA = ''*/
/*				AND LNXX.LC_STA_LONXX = 'A'*/
/*				AND LNXX.LD_FAT_EFF GE SI.LD_LON_ICR_ENT*/
/*			LEFT JOIN PKUB.LNXX_LON_RPS LNXX*/
/*				ON SI.BF_SSN = LNXX.BF_SSN*/
/*				AND SI.LN_SEQ = LNXX.LN_SEQ*/
/*			LEFT JOIN PKUB.LNXX_LON_RPS_SPF LNXX*/
/*				ON LNXX.BF_SSN = LNXX.BF_SSN*/
/*				AND LNXX.LN_SEQ = LNXX.LN_SEQ*/
/*				AND LNXX.LN_RPS_SEQ = LNXX.LN_RPS_SEQ*/
/*				AND LNXX.LA_TOT_BIL_STS = LNXX.LA_RPS_ISL*/
/*			LEFT JOIN PKUB.DWXX_DW_CLC_CLU DWXX*/
/*				ON SI.BF_SSN = DWXX.BF_SSN*/
/*				AND SI.LN_SEQ = DWXX.LN_SEQ*/
/*	;	*/

	CREATE TABLE EXPANDED_SLMA_INFO AS
		SELECT
			SI.*,
			CAP.ICR_Cap_Interest_Date,
			ICPC.ICR_Payment_Counter
		FROM
			SLMA_INFO SI
			LEFT JOIN ICR_CAP AS CAP
				ON SI.BF_SSN = CAP.BF_SSN
				AND SI.LN_SEQ = CAP.LN_SEQ
			LEFT JOIN
				(
					SELECT
						BF_SSN,
						LN_SEQ,
						COUNT(CNT) AS ICR_Payment_Counter
					FROM
						ICR_PMT_CNTR
					GROUP BY
						BF_SSN,
						LN_SEQ
				) ICPC
				ON SI.BF_SSN = ICPC.BF_SSN
				AND SI.LN_SEQ = ICPC.LN_SEQ
	;

QUIT;

DATA EXPANDED_SLMA_INFO;
	SET EXPANDED_SLMA_INFO;

	FORMAT ICR_Cap_Interest_Date DATEX.;
	ICR_Payment_Counter = INTCK('MONTH',LD_LON_ICR_ENT,TODAY());
RUN;

ENDRSUBMIT;

DATA EXPANDED_SLMA_INFO; SET LEGEND.EXPANDED_SLMA_INFO; RUN;

PROC EXPORT
		DATA=EXPANDED_SLMA_INFO
		OUTFILE='T:\SLMA_INFO_TABX.XLSX'
		REPLACE;
RUN;
