USE CDW
GO

SELECT DISTINCT
	AYXX.BF_SSN AS SSN,
	PDXX.DM_PRS_X [FIRST NAME],
	PDXX.DM_PRS_LST [LAST NAME]
FROM
	CDW..AYXX_BR_LON_ATY AYXX
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = AYXX.BF_SSN 
WHERE
	AYXX.PF_REQ_ACT = 'DITLF'
	AND AYXX.LD_ATY_REQ_RCV BETWEEN 'XX/XX/XXXX' AND 'XX/XX/XXXX'




SELECT 
	BP.BF_SSN AS SSN,
	PDXX.DM_PRS_X [FIRST NAME],
	PDXX.DM_PRS_LST [LAST NAME],
	CASE 
		WHEN [STATUS] = X THEN 'TLFSA'
		WHEN [STATUS] = X THEN 'ADTLF'
		WHEN [STATUS] = X THEN 'TLDNY'
	END AS ARC,
	CASE 
		WHEN [STATUS] > X THEN 'APPROVED' 
		ELSE 'DENIED' 
	END AS [APPLICATION STATUS]
FROM
	(
	SELECT 
		AYXX.BF_SSN,
		MAX(CASE 
			WHEN PF_REQ_ACT IN ('TLFSA') THEN X
			WHEN PF_REQ_ACT IN ('ADTLF') THEN X
			WHEN PF_REQ_ACT = 'TLDNY' THEN X
		END) AS [STATUS]
	FROM
		CDW..AYXX_BR_LON_ATY AYXX
		INNER JOIN
		(
			SELECT DISTINCT
				BF_SSN
			FROM
				CDW..AYXX_BR_LON_ATY AYXX
			WHERE
				AYXX.PF_REQ_ACT = 'DITLF'
				AND AYXX.LD_ATY_REQ_RCV BETWEEN 'XX/XX/XXXX' AND 'XX/XX/XXXX'
		)REC
			ON REC.BF_SSN = AYXX.BF_SSN
	WHERE
		AYXX.PF_REQ_ACT IN ('TLFSA','ADTLF','TLDNY')
		AND AYXX.LD_ATY_REQ_RCV BETWEEN 'XX/XX/XXXX' AND 'XX/XX/XXXX'
	GROUP BY
		AYXX.BF_SSN
	) BP
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = BP.BF_SSN
ORDER BY 
	SSN