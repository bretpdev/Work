USE UDW
GO

SELECT
	ACCOUNT_NUMBER,
	LOAN_SEQ,
	lOAN_STATUS,
	CASE WHEN TILP_COUNT != TOTAL_LOAN_COUNT THEN 'Y' ELSE 'N' END AS OTHER_LOANS
FROM
(
SELECT
	PD10.DF_SPE_ACC_ID AS ACCOUNT_NUMBER,
	LN10.LN_SEQ AS LOAN_SEQ,
	LK10.PX_DSC_LNG AS LOAN_STATUS,
	COUNT(*) OVER (PARTITION BY LN10.BF_SSN) AS TILP_COUNT,
	LN10B.TOTAL_LOAN_COUNT

FROM
	UDW..LN10_LON LN10
	INNER JOIN UDW..DW01_DW_CLC_CLU DW01
		ON DW01.BF_SSN = LN10.BF_SSN
		AND DW01.LN_SEQ = LN10.LN_SEQ
	INNER JOIN UDW..PD10_PRS_NME PD10
		ON PD10.DF_PRS_ID = LN10.BF_SSN
	INNER JOIN UDW..LK10_LS_CDE_LKP LK10
		ON LK10.PM_ATR = 'WC-DW-LON-STA'
		AND LK10.PX_ATR_VAL = DW01.WC_DW_LON_STA
	LEFT JOIN
	(
		SELECT
			BF_SSN,
			COUNT(*) AS TOTAL_LOAN_COUNT
		FROM
			UDW..LN10_LON
		WHERE
			LC_STA_LON10 = 'R' 
			AND LA_CUR_PRI > 0
		GROUP BY 
			BF_SSN
	)LN10B
		ON LN10B.BF_SSN = LN10.BF_SSN 
WHERE 
	LA_CUR_PRI > 0.00
	AND LC_STA_LON10 = 'R'
	AND IC_LON_PGM = 'TILP'
) POP