USE CDW
GO


IF OBJECT_ID('tempdb..#POP') IS NOT NULL 
	DROP TABLE #POP

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
SELECT DISTINCT
	DF10.BF_SSN,
	DF10.LC_DFR_TYP,
	FT.Label
INTO #POP
FROM
	CDW..DF10_BR_DFR_REQ DF10
	INNER JOIN CDW..LN50_BR_DFR_APV LN50 
		ON DF10.BF_SSN = LN50.BF_SSN 
		AND DF10.LF_DFR_CTL_NUM = LN50.LF_DFR_CTL_NUM
	LEFT JOIN CDW..FormatTranslation FT
		ON FT.Start = DF10.LC_DFR_TYP
		AND FT.FmtName = '$DEFSTA'
WHERE
	DF10.LC_DFR_STA = 'A'
	AND LN50.LC_STA_LON50 = 'A'
	AND DF10.LC_STA_DFR10 = 'A'
	AND LN50.LC_DFR_RSP != '003'     
	AND LN50.LD_DFR_END >= CAST(GETDATE() AS DATE)
	AND LN50.LD_DFR_BEG <= CAST(GETDATE() AS DATE) 

SELECT * FROM #POP ORDER BY Label, BF_SSN

SELECT LC_DFR_TYP AS "DEFERMENT TYPE", Label AS "TRANSLATED", COUNT(*) AS "DEFERMENT COUNT" FROM #POP GROUP BY LC_DFR_TYP, Label order by count(*) desc