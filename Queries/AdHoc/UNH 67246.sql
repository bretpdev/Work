USE UDW
GO

DROP TABLE IF EXISTS #POP

SELECT DISTINCT
	P39.*
INTO #POP
FROM
(
SELECT DISTINCT
	FB10.BF_SSN
FROM
	UDW..FB10_BR_FOR_REQ FB10
	INNER JOIN UDW..PD10_PRS_NME PD10
		ON PD10.DF_PRS_ID = FB10.BF_SSN
	INNER JOIN UDW..LN60_BR_FOR_APV LN60
		ON LN60.BF_SSN = FB10.BF_SSN
		AND LN60.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM
	INNER JOIN UDW..LN10_LON LN10
		ON LN10.BF_SSN = LN60.BF_SSN
		AND LN10.LN_SEQ = LN60.LN_SEQ
		AND LN10.LA_CUR_PRI > 0
		AND LN10.LC_STA_LON10 = 'R'
WHERE
	LN60.LC_STA_LON60 = 'A'
	AND FB10.LC_STA_FOR10 = 'A'
	AND FB10.LC_FOR_STA = 'A' --denied records cant have this active
	AND LN60.LC_FOR_RSP != '003'
	AND FB10.LC_FOR_TYP = '39'
	--AND CAST(GETDATE() AS DATE)  BETWEEN CAST(LN60.LD_FOR_BEG AS DATE) AND CAST(LN60.LD_FOR_END AS DATE)
) P39
LEFT JOIN
(
SELECT DISTINCT
	FB10.BF_SSN
FROM
	UDW..FB10_BR_FOR_REQ FB10
	INNER JOIN UDW..PD10_PRS_NME PD10
		ON PD10.DF_PRS_ID = FB10.BF_SSN
	INNER JOIN UDW..LN60_BR_FOR_APV LN60
		ON LN60.BF_SSN = FB10.BF_SSN
		AND LN60.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM
	INNER JOIN UDW..LN10_LON LN10
		ON LN10.BF_SSN = LN60.BF_SSN
		AND LN10.LN_SEQ = LN60.LN_SEQ
		AND LN10.LA_CUR_PRI > 0
		AND LN10.LC_STA_LON10 = 'R'
WHERE
	LN60.LC_STA_LON60 = 'A'
	AND FB10.LC_STA_FOR10 = 'A'
	AND FB10.LC_FOR_STA = 'A' --denied records cant have this active
	AND LN60.LC_FOR_RSP != '003'
	AND FB10.LC_FOR_TYP = '40'
) P40
	ON P40.BF_SSN = P39.BF_SSN
where p40.BF_SSN is null

SELECT
	*
FROM 
	#POP P


		


SELECT DISTINCT
	POP.BF_SSN, 
	LN60.LN_SEQ,
	FB10.LF_FOR_CTL_NUM,
	FB10.LC_FOR_TYP
FROM 
	#POP POP
	INNER JOIN UDW..FB10_BR_FOR_REQ FB10
		ON POP.BF_SSN = FB10.BF_SSN
	INNER JOIN UDW..PD10_PRS_NME PD10
		ON PD10.DF_PRS_ID = FB10.BF_SSN
	INNER JOIN UDW..LN60_BR_FOR_APV LN60
		ON LN60.BF_SSN = FB10.BF_SSN
		AND LN60.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM
	INNER JOIN UDW..LN10_LON LN10
		ON LN10.BF_SSN = LN60.BF_SSN
		AND LN10.LN_SEQ = LN60.LN_SEQ
		AND LN10.LA_CUR_PRI > 0
		AND LN10.LC_STA_LON10 = 'R'
WHERE
	FB10.LC_FOR_TYP = '09'
	--AND DATEADD(DAY, 1, LN60.LD_FOR_END) = POP.LD_FOR_BEG
	AND FB10.LD_CRT_REQ_FOR >= '03/13/2020'