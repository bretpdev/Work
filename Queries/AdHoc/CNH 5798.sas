LIBNAME LEGEND REMOTE SERVER=LEGEND SLIBREF=WORK;
RSUBMIT;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;
PROC SQL;
	CREATE TABLE CRXXXX_DET AS
		SELECT DISTINCT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			LNXX.LN_FAT_SEQ,
			LNXX.LC_FED_PGM_YR AS Loan_Program,
			 CASE
			 	WHEN LNXX.LC_WOF_WUP_REA = 'Z' AND LNXX.PC_FAT_SUB_TYP = 'XX' AND (LNXX.LA_FAT_CUR_PRI + LNXX.LA_FAT_NSI + LNXX.LA_FAT_LTE_FEE)*-X < XX THEN 'SMALL BALANCE WRITE-OFF'
				WHEN LNXX.LC_WOF_WUP_REA = 'Z' AND LNXX.PC_FAT_SUB_TYP = 'XX' AND (LNXX.LA_FAT_CUR_PRI + LNXX.LA_FAT_NSI + LNXX.LA_FAT_LTE_FEE)*-X >= XX THEN 'DISABILITY'
				WHEN LNXX.PC_FAT_SUB_TYP = 'XX' THEN 'SMALL BALANCE WRITE-OFF'
				ELSE LKXX.PX_DSC_EX_LNG
			END AS Write_Off_Reason,
			LNXX.LA_FAT_CUR_PRI AS Principal_Written_Off,
			LNXX.LA_FAT_NSI AS Interest_Written_Off,
			LNXX.LA_FAT_LTE_FEE AS Fees_Written_Off, 
			LNXX.LD_FAT_APL,
			LNXX.PC_FAT_TYP,
			LNXX.PC_FAT_SUB_TYP,
			LNXX.LC_WOF_WUP_REA
		FROM
			PKUB.LNXX_LON LNXX
			JOIN PKUB.LNXX_FIN_ATY LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
				AND LNXX.PC_FAT_TYP IN ('XX','XX')
				AND LNXX.PC_FAT_SUB_TYP IN ('XX','XX')
				AND LNXX.LD_FAT_APL BETWEEN 'XXOCTXXXX'D AND 'XXSEPXXXX'D
			LEFT JOIN PKUB.LKXX_LS_CDE_LKP LKXX
				ON  LKXX.PM_ATR = 'LC-WOF-WUP-REA'
				AND LNXX.LC_WOF_WUP_REA = LKXX.PX_ATR_VAL
	;
QUIT;
ENDRSUBMIT;

DATA CRXXXX_DET; set LEGEND.CRXXXX_DET; RUN;

PROC SQL;
	CREATE TABLE CRXXXX AS
		SELECT
			WRITE_OFF_REASON,
			LOAN_PROGRAM,
			SUM(PRINCIPAL_WRITTEN_OFF) AS PRINCIPAL_WRITTEN_OFF,
			SUM(INTEREST_WRITTEN_OFF) AS INTEREST_WRITTEN_OFF,
			SUM(FEES_WRITTEN_OFF) AS FEES_WRITTEN_OFF
		FROM
			CRXXXX_DET
		GROUP BY
			WRITE_OFF_REASON,
			LOAN_PROGRAM
	;
QUIT;

PROC EXPORT
		DATA=CRXXXX
		OUTFILE='T:\SAS\Quick Query Needed for FSA CR XXXX.XLSX'
		REPLACE;
RUN;
