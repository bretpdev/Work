/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORTZ "&RPTLIB/UNWSXX.NWSXXRZ";
FILENAME REPORTX "&RPTLIB/UNWSXX.NWSXXRX";

PROC IMPORT OUT = WORK.SOURCE
            DATAFILE = "T:\updated due date query.xlsx" 
            DBMS = xlsx REPLACE;
   			SHEET = 'SheetX'; 
RUN;

data source;
	set source;
	format ssn zX.	accountnumber zXX.;
run;

LIBNAME  LEGEND  REMOTE  SERVER=LEGEND SLIBREF=WORK;
DATA LEGEND.SOURCE;
SET SOURCE;
RUN;

LIBNAME  LEGEND  REMOTE  SERVER=LEGEND SLIBREF=work  ;
RSUBMIT LEGEND;
/*%let DB = DNFPRQUT;  *This is test;*/
/*%let DB = DNFPRUUT;  *This is VUKX test;*/
%let DB = DNFPUTDL;  *This is live;

LIBNAME PKUB DBX DATABASE=&DB OWNER=PKUB;

%MACRO SQLCHECK ;
  %IF  &SQLXRC NE X  %THEN  %DO  ;
    DATA _NULL_  ;
            FILE REPORTZ NOTITLES  ;
            PUT @XX " ********************************************************************* "
              / @XX " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
              / @XX " ****  THE SAS SHOULD BE REVIEWED.                                **** "       
              / @XX " ********************************************************************* "
              / @XX " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
              / @XX " ****  &SQLXMSG   **** "
              / @XX " ********************************************************************* "
            ;
         RUN  ;
  %END  ;
%MEND  ;

PROC SQL ;
	CREATE TABLE DEMO As
		SELECT DISTINCT
			LNXX.BF_SSN,
			SUM((COALESCE(LNXX.LA_FAT_CUR_PRI, X) + COALESCE(LNXX.LA_FAT_NSI, X))) AS PMT,
			LNXX.LD_FAT_EFF
		FROM
			PKUB.LNXX_LON_DLQ_HST LNXX
		INNER JOIN PKUB.RSXX_BR_RPD RSXX
			ON RSXX.BF_SSN = LNXX.BF_SSN
		INNER JOIN PKUB.LNXX_LON_RPS LNXX
			ON LNXX.BF_SSN = LNXX.BF_SSN
			AND LNXX.LN_SEQ = LNXX.LN_SEQ
			AND LNXX.LN_RPS_SEQ = RSXX.LN_RPS_SEQ
		INNER JOIN PKUB.LNXX_FIN_ATY LNXX
			ON LNXX.BF_SSN = LNXX.BF_SSN
			AND LNXX.LN_SEQ = LNXX.LN_SEQ
		LEFT JOIN PKUB.LNXX_BIL_LON_FAT LNXX
			ON LNXX.BF_SSN = LNXX.BF_SSN
			AND LNXX.LN_SEQ = LNXX.LN_SEQ
			AND LNXX.LN_FAT_SEQ = LNXX.LN_FAT_SEQ
		LEFT JOIN PKUB.LNXX_LON_BIL_CRF LNXX
			ON LNXX.BF_SSN = LNXX.BF_SSN
			AND LNXX.LN_SEQ = LNXX.LN_SEQ
			AND LNXX.LD_BIL_CRT = LNXX.LD_BIL_CRT
			AND LNXX.LN_SEQ_BIL_WI_DTE = LNXX.LN_SEQ_BIL_WI_DTE
			AND LNXX.LN_BIL_OCC_SEQ = LNXX.LN_BIL_OCC_SEQ
		
		INNER JOIN SOURCE S
			ON S.SSN = INPUT(LNXX.BF_SSN, BESTXX.)
		WHERE
			LNXX.LC_STA_LONXX = 'X'
			AND RSXX.LC_STA_RPSTXX = 'A'
			AND LNXX.LC_STA_LONXX = 'A'
			AND DAY(RSXX.LD_RPS_X_PAY_DU) = XX
			AND (LD_FAT_EFF BETWEEN INPUT('XX/XX/XXXX', MMDDYYXX.) AND INPUT('XX/XX/XXXX', MMDDYYXX.) AND PC_FAT_TYP = 'XX' AND PC_FAT_SUB_TYP = 'XX')
			AND LNXX.LC_STA_LONXX = 'A'
			AND LNXX.LC_FAT_REV_REA = ''
			AND (LNXX.BF_SSN IS NULL OR (LNXX.LA_TOT_BIL_STS <= COALESCE(LNXX.LA_BIL_CUR_DU,X) AND LNXX.LD_BIL_CRT BETWEEN INPUT('XX/XX/XXXX', MMDDYYXX.) AND INPUT('XX/XX/XXXX', MMDDYYXX.)))
		GROUP BY
			LNXX.BF_SSN,
			LNXX.LD_FAT_EFF
;
QUIT;

ENDRSUBMIT;

DATA DEMO; SET LEGEND.DEMO; RUN;

PROC EXPORT DATA= WORK.DEMO 
            OUTFILE= "T:\NH XXXX_XX-XX-XXXX_VX.xlsx" 
            DBMS=EXCEL REPLACE;
     SHEET="SheetX"; 
RUN;
