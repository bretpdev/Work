USE CDW
GO

IF OBJECT_ID('tempdb..#FINAL_POP') IS NOT NULL 
	DROP TABLE #FINAL_POP

IF OBJECT_ID('tempdb..#GRP_POP') IS NOT NULL 
	DROP TABLE #GRP_POP

SELECT DISTINCT
	LN65.BF_SSN,
	LN65.LC_STA_LON65,
	CAST(SUM(LN66.LA_RPS_ISL) AS DECIMAL(18,2)) AS LA_RPS_ISL
INTO #FINAL_POP
FROM
	CDW..LN65_LON_RPS LN65
	INNER JOIN
	(
		SELECT DISTINCT
			LN65.BF_SSN,
			LN65.LN_SEQ,
			MIN(LN65.LN_RPS_SEQ) AS LN_RPS_SEQ
		FROM CLS..DueDateChange DDC
			INNER JOIN CDW..LN65_LON_RPS LN65
				ON LN65.BF_SSN = DDC.Ssn
		WHERE
			LN65.LF_LST_DTS_LN65 BETWEEN '03/13/2018' AND '03/27/2018' 
			AND CAST(ProcessedAt AS DATE) > '03/13/2018'
			AND Successful = 1
			AND LN65.LC_STA_LON65 = 'I'
		GROUP BY
			LN65.BF_SSN,
			LN65.LN_SEQ

		UNION ALL

		SELECT DISTINCT
			LN65.BF_SSN,
			LN65.LN_SEQ,
			MIN(LN65.LN_RPS_SEQ) AS LN_RPS_SEQ
		FROM CLS..DueDateChange DDC
			INNER JOIN CDW..LN65_LON_RPS LN65
				ON LN65.BF_SSN = DDC.Ssn
		WHERE
			LN65.LF_LST_DTS_LN65 BETWEEN '03/13/2018' AND '03/27/2018' 
			AND CAST(ProcessedAt AS DATE) > '03/13/2018'
			AND Successful = 1
			AND LN65.LC_STA_LON65 = 'A'
		GROUP BY
			LN65.BF_SSN,
			LN65.LN_SEQ
	) POP
		ON POP.BF_SSN = LN65.BF_SSN
		AND POP.LN_SEQ = LN65.LN_SEQ
		AND POP.LN_RPS_SEQ = LN65.LN_RPS_SEQ
	INNER JOIN CDW..LN66_LON_RPS_SPF LN66
		ON LN66.BF_SSN = LN65.BF_SSN
		AND LN66.LN_SEQ = LN65.LN_SEQ
		AND LN66.LN_RPS_SEQ = LN65.LN_RPS_SEQ
		AND LN66.LN_GRD_RPS_SEQ = 1
GROUP BY
	LN65.BF_SSN, 
	LN65.LC_STA_LON65



SELECT DISTINCT
	FP.BF_SSN,
	CAST((FP.LA_RPS_ISL - FPS.LA_RPS_ISL) AS DECIMAL(18,2)) AS DIFF 
INTO #GRP_POP
FROM 
	#FINAL_POP FP
	INNER JOIN #FINAL_POP FPS
		ON FP.BF_SSN = FPS.BF_SSN
		AND FPS.LC_STA_LON65 = 'I'
WHERE
	FP.LC_STA_LON65 = 'A'
	AND FPS.LC_STA_LON65 = 'I'

	SELECT COUNT(DISTINCT BF_SSN) FROM #GRP_POP WHERE DIFF > 0
SELECT  distinct
	PD10.DF_SPE_ACC_ID 
FROM 
	#GRP_POP g 
INNER JOIN CDW..PD10_PRS_NME PD10 
	ON PD10.DF_PRS_ID = G.BF_SSN 
left join cdw..PD32_PRS_ADR_EML pd32
	on pd32.DF_PRS_ID = g.BF_SSN
	and pd32.DI_VLD_ADR_EML = 'y'
left JOIN
		(
			SELECT
				PD10.DF_PRS_ID,
				COALESCE((PD40H.DN_DOM_PHN_ARA + PD40H.DN_DOM_PHN_XCH + PD40H.DN_DOM_PHN_LCL),'') AS HOME_PHONE,
				CASE
					WHEN PD40H.DC_ALW_ADL_PHN IN ('L','Q','P') THEN 'Y'
					WHEN PD40H.DC_ALW_ADL_PHN NOT IN('L','Q','P') THEN 'N'
					ELSE ''
				END AS HOME_CONSENT,
				COALESCE((PD40A.DN_DOM_PHN_ARA + PD40A.DN_DOM_PHN_XCH + PD40A.DN_DOM_PHN_LCL),'') AS ALT_PHONE,
				CASE
					WHEN PD40A.DC_ALW_ADL_PHN IN ('L','Q','P') THEN 'Y'
					WHEN PD40A.DC_ALW_ADL_PHN NOT IN('L','Q','P') THEN 'N'
					ELSE ''
				END AS ALT_CONSENT,
				COALESCE((PD40W.DN_DOM_PHN_ARA + PD40W.DN_DOM_PHN_XCH + PD40W.DN_DOM_PHN_LCL),'') AS WORK_PHONE,
				CASE
					WHEN PD40W.DC_ALW_ADL_PHN IN ('L','Q','P') THEN 'Y'
					WHEN PD40W.DC_ALW_ADL_PHN NOT IN('L','Q','P') THEN 'N'
					ELSE ''
				END AS WORK_CONSENT
			FROM
				CDW..PD10_PRS_NME PD10
				LEFT JOIN CDW..PD40_PRS_PHN PD40H
					ON PD40H.DF_PRS_ID = PD10.DF_PRS_ID
					AND PD40H.DC_PHN = 'H'
					AND PD40H.DI_PHN_VLD = 'Y'
				LEFT JOIN CDW..PD40_PRS_PHN PD40A
					ON PD40A.DF_PRS_ID = PD10.DF_PRS_ID
					AND PD40A.DC_PHN = 'A'
					AND PD40A.DI_PHN_VLD = 'Y'
				LEFT JOIN CDW..PD40_PRS_PHN PD40W
					ON PD40W.DF_PRS_ID = PD10.DF_PRS_ID
					AND PD40W.DC_PHN = 'W'
					AND PD40W.DI_PHN_VLD = 'Y'
			WHERE
				COALESCE(PD40H.DF_PRS_ID,PD40A.DF_PRS_ID,PD40W.DF_PRS_ID) IS NOT NULL/*HAS AT LEAST 1 VALID PHONE*/
		)PD40
			ON PD40.DF_PRS_ID = PD10.DF_PRS_ID
where 
	DIFF >= .01 AND (PD40.DF_PRS_ID IS NULL and pd32.DF_PRS_ID is null)

select count(distinct bf_ssn), count(*) from #GRP_POP
SELECT
	GP.GRP,
	COUNT(*) AS GRP_COUNT
	--gp1.*
FROM 
	#GRP_POP GP1
	INNER JOIN 
	(
		SELECT 
			BF_SSN,
			CASE 
				WHEN DIFF BETWEEN .01 AND 10.00 THEN '.01 - 10.00'
				WHEN DIFF BETWEEN 10.01 AND 25.00 THEN '10.01 - 25.00'
				WHEN DIFF BETWEEN 25.01 AND 50.00 THEN '25.01 - 50.00'
				WHEN DIFF BETWEEN 50.01 AND 100.00 THEN '50.01 - 100.00'
				WHEN DIFF > 100.01  THEN '100.01 +'
				WHEN DIFF = 0.00 THEN 'NO CHANGE'
				WHEN DIFF < 0 AND ABS(DIFF) BETWEEN .01 AND 10.00 THEN '-.01 - 10.00'
				WHEN DIFF < 0 AND ABS(DIFF) BETWEEN 10.01 AND 25.00 THEN '-10.01 - 25.00'
				WHEN DIFF < 0 AND ABS(DIFF) BETWEEN 25.01 AND 50.00 THEN '-25.01 - 50.00'
				WHEN DIFF < 0 AND ABS(DIFF) BETWEEN 50.01 AND 100.00 THEN '-50.01 - 100.00'
				WHEN DIFF < 0 AND ABS(DIFF) BETWEEN 100.01 AND 10000.00   THEN '-100.01 +'

			END AS GRP
		FROM 
			#GRP_POP
	) GP
		ON GP.BF_SSN = GP1.BF_SSN
GROUP BY
	GP.GRP
ORDER BY GRP



----SELECT
----	gp1.*
----FROM 
----	#GRP_POP GP1
----	INNER JOIN 
----	(
----		SELECT 
----			BF_SSN,
----			CASE 
----				WHEN DIFF BETWEEN .01 AND 10.00 THEN '.01 - 10.00'
----				WHEN DIFF BETWEEN 10.01 AND 25.00 THEN '10.01 - 25.00'
----				WHEN DIFF BETWEEN 25.01 AND 50.00 THEN '25.01 - 50.00'
----				WHEN DIFF BETWEEN 50.01 AND 100.00 THEN '50.01 - 100.00'
----				WHEN DIFF > 100.01  THEN '100.01 +'
----				WHEN DIFF = 0.00 THEN 'NO CHANGE'

----				WHEN DIFF < 0 AND ABS(DIFF) BETWEEN .01 AND 10.00 THEN '-.01 - 10.00'
----				WHEN DIFF < 0 AND ABS(DIFF) BETWEEN 10.01 AND 25.00 THEN '-10.01 - 25.00'
----				WHEN DIFF < 0 AND ABS(DIFF) BETWEEN 25.01 AND 50.00 THEN '-25.01 - 50.00'
----				WHEN DIFF < 0 AND ABS(DIFF) BETWEEN 50.01 AND 100.00 THEN '-50.01 - 100.00'
----				WHEN DIFF < 0 AND ABS(DIFF) BETWEEN 100.01 AND 10000.00   THEN '-100.01 +'
				
----			END AS GRP
----		FROM 
----			#GRP_POP
----	) GP
----		ON GP.BF_SSN = GP1.BF_SSN
----	WHERE gp.GRP IS NULL
