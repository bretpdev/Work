USE CDW
GO

IF OBJECT_ID('tempdb..#BASE_POP') IS NOT NULL 
       DROP TABLE #BASE_POP

IF OBJECT_ID('tempdb..#FS') IS NOT NULL 
    DROP TABLE #FS

IF OBJECT_ID('tempdb..#CS') IS NOT NULL 
    DROP TABLE #CS


SELECT * INTO #BASE_POP FROM OPENQUERY(LEGEND,
'
SELECT
	CASE 
		WHEN AYXX.PF_REQ_ACT IN (''DICSK'', ''CSFSA'', ''ADCSH'', ''CSDNY'') THEN ''CS''
		WHEN AYXX.PF_REQ_ACT IN (''DIFCR'', ''FCFSA'', ''ADFCR'', ''FCDNY'') THEN ''FS''
	END AS TYPE,
	PDXX.DF_SPE_ACC_ID,
	LNXX.LN_SEQ,
	LNXX.LF_DOE_SCL_ORG,
	MRXB.LF_DOE_SCL_ENR_CUR,
	COALESCE(SCXXL.IC_TYP_SCL, SCXXM.IC_TYP_SCL) AS IC_TYP_SCL,
	AYXX.PF_REQ_ACT,
	AYXX.LD_ATY_REQ_RCV,
	ACXX.PX_ACT_DSC_REQ
FROM 
	PKUB.AYXX_BR_LON_ATY AYXX
	INNER JOIN PKUB.PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = AYXX.BF_SSN
	INNER JOIN PKUB.LNXX_LON_ATY LNXX
		ON LNXX.BF_SSN = AYXX.BF_SSN
		AND LNXX.LN_ATY_SEQ = AYXX.LN_ATY_SEQ
	INNER JOIN PKUB.LNXX_LON LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN PKUB.ACXX_ACT_REQ ACXX
		ON ACXX.PF_REQ_ACT = AYXX.PF_REQ_ACT
	LEFT JOIN PKUR.MRXB_MR_LON_MTH_XX MRXB
		ON MRXB.BF_SSN = LNXX.BF_SSN
		AND MRXB.LN_SEQ = LNXX.LN_SEQ
	LEFT JOIN PKUB.SCXX_SCH_DMO SCXXL	
		ON SCXXL.IF_DOE_SCL = LNXX.LF_DOE_SCL_ORG
	LEFT JOIN PKUB.SCXX_SCH_DMO SCXXM	
		ON SCXXM.IF_DOE_SCL = MRXB.LF_DOE_SCL_ENR_CUR
WHERE
	AYXX.PF_REQ_ACT IN (''DIFCR'', ''FCFSA'', ''ADFCR'',  ''FCDNY'',''DICSK'', ''CSFSA'', ''ADCSH'', ''CSDNY'')
	AND AYXX.LD_ATY_REQ_RCV between ''X/X/XXXX'' and ''XX/XX/XXXX''

')

SELECT * INTO #CS FROM #BASE_POP WHERE [TYPE] = 'CS'
SELECT * INTO #FS FROM #BASE_POP WHERE [TYPE] = 'FS'

SELECT * FROM #CS --DETAIL
SELECT * FROM #FS --DETAIL


SELECT
	IC_TYP_SCL,
	PF_REQ_ACT, 
	PX_ACT_DSC_REQ,
	COUNT(DISTINCT DF_SPE_ACC_ID) AS ARC_COUNT
FROM
	#CS
GROUP BY
	IC_TYP_SCL,
	PF_REQ_ACT,
	PX_ACT_DSC_REQ
ORDER BY
	IC_TYP_SCL

SELECT
	IC_TYP_SCL,
	PF_REQ_ACT, 
	PX_ACT_DSC_REQ,
	COUNT(DISTINCT DF_SPE_ACC_ID) AS ARC_COUNT
FROM
	#FS
GROUP BY
	IC_TYP_SCL,
	PF_REQ_ACT,
	PX_ACT_DSC_REQ
ORDER BY
	IC_TYP_SCL


SELECT
	LF_DOE_SCL_ORG,
	PF_REQ_ACT, 
	PX_ACT_DSC_REQ,
	COUNT(DISTINCT DF_SPE_ACC_ID) AS ARC_COUNT
FROM
	#CS
GROUP BY
	LF_DOE_SCL_ORG,
	PF_REQ_ACT,
	PX_ACT_DSC_REQ
ORDER BY
	LF_DOE_SCL_ORG

SELECT
	LF_DOE_SCL_ORG,
	PF_REQ_ACT, 
	PX_ACT_DSC_REQ,
	COUNT(DISTINCT DF_SPE_ACC_ID) AS ARC_COUNT
FROM
	#FS
GROUP BY
	LF_DOE_SCL_ORG,
	PF_REQ_ACT,
	PX_ACT_DSC_REQ
ORDER BY
	LF_DOE_SCL_ORG
