--SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

--scheduled payment amount per loan for schedules listed
SELECT DISTINCT
	PDXX.DF_SPE_ACC_ID
	,LNXX.BF_SSN
	,LNXX.LN_SEQ
	,LNXX.LA_CUR_PRI
	,RS.LA_RPS_ISL  --scheduled payment amount
INTO
	#SCHEDULE
FROM
	[AuditCDW].[dbo].[LNXX_LON_DecXXXX] LNXX
	INNER JOIN CDW..LNXX_LON_RPS LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN CDW..LNXX_LON_RPS_SPF LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
		AND LNXX.LN_RPS_SEQ = LNXX.LN_RPS_SEQ
	INNER JOIN CDW.calc.RepaymentSchedules RS
		ON LNXX.BF_SSN = RS.BF_SSN
		AND LNXX.LN_SEQ = RS.LN_SEQ
		AND LNXX.LN_RPS_SEQ = RS.LN_RPS_SEQ
		AND LNXX.LN_GRD_RPS_SEQ = RS.LN_GRD_RPS_SEQ
	INNER JOIN
	(--get end of December start date
		SELECT 
			MAX(TermStartDate) AS max_TermStartDate
			,BF_SSN
			,LN_SEQ 
		FROM 
			CDW.calc.RepaymentSchedules 
		WHERE 
			TermStartDate < 'XXXX-XX-XX' 
			AND DATEADD(MONTH,LN_RPS_TRM,TermStartDate) >= 'XXXX-XX-XX' 
		GROUP BY 
			BF_SSN
			,LN_SEQ
	) RS_max
		ON RS.BF_SSN = RS_max.BF_SSN
		AND RS.LN_SEQ = RS_max.LN_SEQ
		AND RS.TermStartDate = RS_max.max_TermStartDate
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
	LEFT JOIN
	(--exclude XX/XX/XX deferments
		SELECT
			BF_SSN
			,LN_SEQ
		FROM
			CDW..LNXX_BR_DFR_APV
		WHERE
			CONVERT(DATE,'XXXXXXXX') BETWEEN LD_DFR_BEG AND LD_DFR_END
	) LNXX
		ON  LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	LEFT JOIN
	(--exclude XX/XX/XX forbearances
		SELECT
			BF_SSN
			,LN_SEQ
		FROM
			CDW..LNXX_BR_FOR_APV
		WHERE
			CONVERT(DATE,'XXXXXXXX') BETWEEN LD_FOR_BEG AND LD_FOR_END
	) LNXX
		ON  LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
WHERE
	LNXX.LC_TYP_SCH_DIS IN ('CA', 'CP', 'CQ', 'CX', 'CX', 'CX', 'IB', 'IL', 'IP', 'IX', 'IX', 'IA')
	AND LNXX.LA_CUR_PRI > X.XX
	AND LNXX.LC_STA_LONXX = 'R'
	AND LNXX.BF_SSN IS NULL --exclude XX/XX/XX deferments
	AND LNXX.BF_SSN IS NULL --exclude XX/XX/XX forbearances
--AND PDXX.DF_SPE_ACC_ID = 'XXXXXXXXXX' --test
;
--select * from #SCHEDULE


--Dec.XXXX sum of accrued interest
SELECT
	LNXX.BF_SSN
	,LNXX.LN_SEQ
	,SUM(LNXX.LA_FAT_NSI_ACR) AS sum_dec_LA_FAT_NSI_ACR
INTO
	#DECEMBER
FROM 
	#SCHEDULE S
	LEFT JOIN CDW..LNXX_FIN_ATY LNXX
		ON LNXX.BF_SSN = S.BF_SSN
		AND LNXX.LN_SEQ = S.LN_SEQ
	LEFT JOIN
	(--exclude XXXX XX/XX/XXXX transactions
		SELECT
			BF_SSN
			,LN_SEQ
			,LN_FAT_SEQ
		FROM
			CDW..LNXX_FIN_ATY
		WHERE
			PC_FAT_TYP = 'XX'
			AND PC_FAT_SUB_TYP = 'XX'
			AND LD_FAT_EFF = CONVERT(DATE,'XXXXXXXX')
	) LNXXX
		ON  LNXX.BF_SSN = LNXXX.BF_SSN
		AND LNXX.LN_SEQ = LNXXX.LN_SEQ
		AND LNXX.LN_FAT_SEQ = LNXXX.LN_FAT_SEQ
WHERE
	MONTH(LNXX.LD_FAT_EFF) = XX
	AND YEAR(LNXX.LD_FAT_EFF) = XXXX
	AND LNXXX.BF_SSN IS NULL --exclude XXXX XX/XX/XXXX transactions
GROUP BY
	LNXX.BF_SSN
	,LNXX.LN_SEQ
;
--select * from #DECEMBER

--X/X/XXXX sum of accrued interest
SELECT
	 S.BF_SSN
	,S.LN_SEQ
	,SUM(COALESCE(LNXX_A.LA_FAT_NSI_ACR,X) + COALESCE(LNXX_B.LA_FAT_NSI_ACR,X)) AS sum_jan_LA_FAT_NSI_ACR
INTO
	#JANUARY
FROM 
	#SCHEDULE S
	LEFT JOIN
	(
		SELECT
			BF_SSN
			,LN_SEQ
			,LA_FAT_NSI_ACR
		FROM
			CDW..LNXX_FIN_ATY 
		WHERE
			PC_FAT_TYP = 'XX'
			AND PC_FAT_SUB_TYP IN ('XX','XX')
			AND LD_FAT_EFF = CONVERT(DATE,'XXXXXXXX')
			--AND LC_STA_LONXX = 'A'
	) LNXX_A
		ON  LNXX_A.BF_SSN = S.BF_SSN
		AND LNXX_A.LN_SEQ = S.LN_SEQ
	LEFT JOIN 
	(
		SELECT
			BF_SSN
			,LN_SEQ
			,LA_FAT_NSI_ACR
		FROM
			CDW..LNXX_FIN_ATY 
		WHERE
			PC_FAT_TYP = 'XX'
			AND PC_FAT_SUB_TYP = 'XX'
			AND LD_FAT_EFF = CONVERT(DATE,'XXXXXXXX')
			--AND LC_STA_LONXX = 'A'
	) LNXX_B
		ON  LNXX_B.BF_SSN = S.BF_SSN
		AND LNXX_B.LN_SEQ = S.LN_SEQ
GROUP BY
	 S.BF_SSN
	,S.LN_SEQ
;
--select * from #JANUARY

--final output
SELECT
	S.DF_SPE_ACC_ID
	--,S.BF_SSN
	,S.LN_SEQ
	,S.LA_CUR_PRI
	,S.LA_RPS_ISL
	,D.sum_dec_LA_FAT_NSI_ACR AS dec_LA_FAT_NSI_ACR
	,J.sum_jan_LA_FAT_NSI_ACR AS jan_LA_FAT_NSI_ACR
	,COALESCE(D.sum_dec_LA_FAT_NSI_ACR,X) + COALESCE(J.sum_jan_LA_FAT_NSI_ACR,X) AS tot_LA_FAT_NSI_ACR
	,IIF((COALESCE(D.sum_dec_LA_FAT_NSI_ACR,X) + COALESCE(J.sum_jan_LA_FAT_NSI_ACR,X)) > S.LA_RPS_ISL, 'neg am', '') AS FLAG
FROM
	#SCHEDULE S
	LEFT JOIN #DECEMBER D
		ON S.BF_SSN = D.BF_SSN
		AND S.LN_SEQ = D.LN_SEQ
	LEFT JOIN #JANUARY J
		ON D.BF_SSN = J.BF_SSN
		AND D.LN_SEQ = J.LN_SEQ

--WHERE DF_SPE_ACC_ID = 'XXXXXXXXXX'

ORDER BY
	S.DF_SPE_ACC_ID
	,S.LN_SEQ
;


--select * from #SCHEDULE
--select * from #DECEMBER
--select * from #JANUARY

--DROP TABLE #JANUARY