USE UDW
GO

SELECT DISTINCT
	LN10.BF_SSN
	,CASE
		WHEN LN16.LN_DLQ_MAX >= 60
		THEN '>=60'
		ELSE NULL
	END AS LN_DLQ_MAX
	,PD30.DC_DOM_ST
	,PD31.DC_DOM_ST_HST
	,PD31.DD_CRT_PD31
	,CASE
		WHEN PD31.DD_CRT_PD31 BETWEEN '2017-09-01' AND '2018-03-31'
			AND PD31.DC_DOM_ST_HST = 'PR'
		THEN CAST(PD31.DD_CRT_PD31 AS VARCHAR(10))
		ELSE 'N/A'
	END AS PD31_CRITERIA
FROM
	LN10_LON LN10
	INNER JOIN LN16_LON_DLQ_HST LN16
		ON LN10.BF_SSN = LN16.BF_SSN
		AND LN10.LN_SEQ = LN16.LN_SEQ
	LEFT JOIN PD30_PRS_ADR PD30
		ON LN10.BF_SSN = PD30.DF_PRS_ID
	LEFT JOIN PD31_PRS_INA PD31
		ON LN10.BF_SSN = PD31.DF_PRS_ID
WHERE
	LN16.LN_DLQ_MAX >= 60
	AND	(
			PD30.DC_DOM_ST = 'PR'
			OR (
					PD31.DC_DOM_ST_HST = 'PR'
					AND PD31.DD_CRT_PD31 BETWEEN '2017-09-01' AND '2018-03-31'
				)
		)

