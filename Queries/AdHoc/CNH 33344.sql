USE CDW
GO
SELECT * FROM OPENQUERY(LEGEND,
'
SELECT 
	PDXX.DF_SPE_ACC_ID,
	lnXX.bf_ssn,
	LNXX.LN_SEQ,
	(LNXX.LA_CUR_PRI + COALESCE(LNXX.LA_NSI_OTS,X)) AS TOTAL_BALANCE,
	LNXX.DISB_AMT,
	(X*LNXX.DISB_AMT) AS DBL
FROM 
	PKUB.LNXX_LON LNXX
	INNER JOIN PKUB.PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = LNXX.BF_SSN
	INNER JOIN
	(
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			SUM(COALESCE(LNXX.LA_DSB,X) - COALESCE(LNXX.LA_DSB_CAN,X)) AS DISB_AMT
		FROM
			PKUB.LNXX_DSB LNXX
		GROUP BY
			LNXX.BF_SSN,
			LNXX.LN_SEQ
	)LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
WHERE
	LNXX.IC_LON_PGM NOT IN (''DLPCNS'', ''DLCNSL'', ''DLSCNS'', ''DLSPCN'', ''DLSSPL'', ''DLUCNS'', ''DLUSPL'')
	AND (LNXX.LA_CUR_PRI + COALESCE(LNXX.LA_NSI_OTS,X)) >= (X*LNXX.DISB_AMT)
	AND LNXX.LC_STA_LONXX = ''R''
	AND LNXX.LA_CUR_PRI > X.XX
ORDER BY
	PDXX.DF_SPE_ACC_ID,
	LNXX.LN_SEQ
')