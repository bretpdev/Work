USE CDW
GO

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED					
					
					
--*** FILE X - ADDITIONAL INPUT***					
--Borrower has a X.XX account balance					
SELECT DISTINCT					
	WQXX.WF_QUE,				
	WQXX.WF_SUB_QUE,				
	WQXX.WN_CTL_TSK,				
	WQXX.PF_REQ_ACT				
FROM					
	WQXX_TSK_QUE WQXX				
	INNER JOIN 				
	(  -- has a balance				
		SELECT			
			LNXX.BF_SSN,		
			SUM(ISNULL(LNXX.LA_CUR_PRI, X.XX) + ISNULL(DWXX.WA_TOT_BRI_OTS, X.XX)) [balance]		
		FROM			
			CDW..LNXX_LON LNXX		
			INNER JOIN CDW..DWXX_DW_CLC_CLU DWXX ON DWXX.BF_SSN = LNXX.BF_SSN AND DWXX.LN_SEQ = LNXX.LN_SEQ		
			INNER JOIN CDW..WQXX_TSK_QUE WQXX ON WQXX.BF_SSN = LNXX.BF_SSN		
		WHERE			
			WQXX.WC_STA_WQUEXX NOT IN ('X', 'C')		
			AND		
			WQXX.WF_QUE = 'RB'		
		GROUP BY			
			LNXX.BF_SSN		
		HAVING			
			SUM(ISNULL(LNXX.LA_CUR_PRI, X.XX) + ISNULL(DWXX.WA_TOT_BRI_OTS, X.XX)) <= X.XX		
	) BAL ON BAL.BF_SSN = WQXX.BF_SSN				
WHERE					
	WQXX.WC_STA_WQUEXX NOT IN ('X', 'C')				
	AND				
	WQXX.WF_QUE = 'RB'				
					
					
--*** FILE X - ADDITIONAL INPUT ***					
					
SELECT					
	WQXX.WF_QUE,				
	WQXX.WF_SUB_QUE,				
	WQXX.WN_CTL_TSK,				
	WQXX.PF_REQ_ACT--				
	--WQXX.WD_ACT_REQ,							
FROM					
	(				
		SELECT			
			--COUNT(*) OVER (PARTITION BY WQXX.BF_SSN) [BorrowerQCount],		
			ROW_NUMBER() OVER (PARTITION BY WQXX.BF_SSN ORDER BY WD_ACT_REQ) [RowNumber],		
			WQXX.BF_SSN,		
			WQXX.WF_QUE,		
			WQXX.WF_SUB_QUE,		
			WQXX.WN_CTL_TSK,		
			WQXX.PF_REQ_ACT,		
			WD_ACT_REQ		
		FROM			
			CDW..WQXX_TSK_QUE WQXX		
		WHERE			
			WQXX.WC_STA_WQUEXX NOT IN ('X', 'C')		
			AND		
			WQXX.WF_QUE = 'RB'		
	) WQXX				
WHERE					
	WQXX.RowNumber != X				
					
					
--*** File X - ADDITIONAL INPUT ***					
--WQXX.WX_MSG_X_TSK = 'CERT DTE EQUAL-CONFLICT BETWEEN INCOMING ENROL AND EXISTING DFR' 					
SELECT DISTINCT					
	WQXX.WF_QUE,				
	WQXX.WF_SUB_QUE,				
	WQXX.WN_CTL_TSK,				
	WQXX.PF_REQ_ACT--			
FROM					
	CDW..LNXX_LON LNXX							
	INNER JOIN CDW..WQXX_TSK_QUE WQXX ON WQXX.BF_SSN = LNXX.BF_SSN				
WHERE					
	WQXX.WC_STA_WQUEXX NOT IN ('X', 'C')				
	AND				
	WQXX.WF_QUE = 'RB'				
	AND				
	WQXX.WX_MSG_X_TSK = 'CERT DTE EQUAL-CONFLICT BETWEEN INCOMING ENROL AND EXISTING DFR' 								
	--SDXX.LC_STA_STUXX = 'A'				
					
--*** FILE X - ADDITIONAL INPUT***									
SELECT DISTINCT					
	WQXX.WF_QUE,				
	WQXX.WF_SUB_QUE,				
	WQXX.WN_CTL_TSK,				
	WQXX.PF_REQ_ACT				
FROM					
	CDW..WQXX_TSK_QUE WQXX				
	INNER JOIN 				
		(			
			SELECT DISTINCT		
				BF_SSN	
			FROM		
				CDW..WQXX_TSK_QUE	
			WHERE		
				WC_STA_WQUEXX NOT IN ('X', 'C')	
				AND	WF_QUE = 'DR'
		) DRTASK			
			ON WQXX.BF_SSN = DRTASK.BF_SSN		
WHERE					
	WQXX.WC_STA_WQUEXX NOT IN ('X', 'C')				
	AND	WQXX.WF_QUE = 'RB'			
