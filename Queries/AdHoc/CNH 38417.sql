SELECT
	REPLACE(CONVERT(VARCHAR, CONVERT(MONEY, CountBorrowersInRepay), X), '.XX', '')  AS CountBorrowersInRepay,
	REPLACE(CONVERT(VARCHAR, CONVERT(MONEY, CountAutoDebit), X), '.XX', '') AS CountAutoDebit,
	CAST(CAST(CAST(CountAutoDebit AS decimal(XX,X)) / CAST(CountBorrowersInRepay AS decimal(XX,X)) * XXX AS decimal(XX,X)) AS VARCHAR) + '%' AS PercentageInACH
FROM
(
	SELECT DISTINCT
		COUNT(LNXX.BF_SSN) OVER() AS CountBorrowersInRepay,
		SUM(CASE WHEN LNXX.BF_SSN IS NULL THEN X ELSE X END) OVER() AS CountAutoDebit
	FROM
		CDW..LNXX_LON LNXX
		INNER JOIN CDW.calc.RepaymentSchedules RS
			ON RS.BF_SSN = LNXX.BF_SSN
			AND RS.LN_SEQ = LNXX.LN_SEQ
		LEFT JOIN CDW..LNXX_EFT_TO_LON LNXX
			ON LNXX.BF_SSN = RS.BF_SSN
			AND LNXX.LN_SEQ = RS.LN_SEQ
			AND LNXX.LC_STA_LNXX = 'A'
			AND CAST(GETDATE() AS DATE) BETWEEN CAST(LNXX.LD_EFT_EFF_BEG AS DATE) AND CAST(COALESCE(LNXX.LD_EFT_EFF_END,'XXXX-XX-XX') AS DATE)
	WHERE
		RS.CurrentGradation = X
		AND LNXX.LA_CUR_PRI > X.XX
		AND LNXX.LC_STA_LONXX = 'R'
) AutoPayStatistics
