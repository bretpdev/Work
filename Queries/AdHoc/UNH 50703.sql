SELECT * FROM OPENQUERY
(
	DUSTER,
	'
		SELECT 
			CASE WHEN LN50.BF_SSN IS NOT NULL THEN ''R2D''
				 WHEN LN60.BF_SSN IS NOT NULL THEN ''R2F''
				 ELSE '''' END AS Report,
			LN10.BF_SSN AS SSN,
			PD10.DF_SPE_ACC_ID AS AccountNumber,
			LN10.LN_SEQ AS LoanSequence,
			LN10.LF_LON_CUR_OWN AS OwnerCode,
			NULL AS DefForbOrigBegDate,
			NULL AS DefForbOrigEndDate,
			VARCHAR_FORMAT(COALESCE(LN50.BEGINDATE, LN60.BEGINDATE), ''MM-DD-YYYY'') AS DefForbBegDate,
			VARCHAR_FORMAT(COALESCE(LN50.ENDDATE, LN60.ENDDATE), ''MM-DD-YYYY'') AS DefForbEndDate,
			VARCHAR_FORMAT(CURRENT DATE, ''MM-DD-YYYY'') AS UpdatedAt,
			NULL AS ProcessedAt,
			NULL AS ProcessedBy,
			VARCHAR_FORMAT(CURRENT DATE, ''MM-DD-YYYY'') AS CreatedAt,
			''UNH 50703'' AS CreatedBy
		FROM
			OLWHRM1.PD10_PRS_NME PD10
			INNER JOIN OLWHRM1.LN10_LON LN10 
				ON LN10.BF_SSN = PD10.DF_PRS_ID
			INNER JOIN OLWHRM1.BR30_BR_EFT BR30 
				ON BR30.BF_SSN = LN10.BF_SSN
			LEFT OUTER JOIN 
			(
				SELECT
					MAX(LN60.LD_FOR_END) AS ENDDATE,
					MAX(LN60.LD_FOR_BEG) AS BEGINDATE,
					LN60.BF_SSN,
					LN60.LN_SEQ
				FROM
					OLWHRM1.LN60_BR_FOR_APV LN60
					LEFT OUTER JOIN OLWHRM1.FB10_BR_FOR_REQ FB10
						ON FB10.BF_SSN = LN60.BF_SSN 
						AND FB10.LF_FOR_CTL_NUM = LN60.LF_FOR_CTL_NUM
				WHERE
					FB10.LC_FOR_STA = ''A''
					AND FB10.LC_STA_FOR10 = ''A''
					AND	LN60.LC_STA_LON60 = ''A''
				GROUP BY
					LN60.BF_SSN,
					LN60.LN_SEQ,
					LN60.LF_FOR_CTL_NUM
			) LN60 
				ON LN60.BF_SSN = LN10.BF_SSN 
				AND LN60.LN_SEQ = LN10.LN_SEQ 
				AND LN60.ENDDATE >= LN10.LD_LON_ACL_ADD
			LEFT OUTER JOIN 
			(
				SELECT
					MAX(LN50.LD_DFR_END) AS ENDDATE,
					MAX(LN50.LD_DFR_BEG) AS BEGINDATE,
					LN50.BF_SSN,
					LN50.LN_SEQ
				FROM
					OLWHRM1.LN50_BR_DFR_APV LN50
					LEFT OUTER JOIN OLWHRM1.DF10_BR_DFR_REQ DF10
						ON DF10.BF_SSN = LN50.BF_SSN 
						AND DF10.LF_DFR_CTL_NUM = LN50.LF_DFR_CTL_NUM
				WHERE
					DF10.LC_DFR_STA = ''A''
					AND DF10.LC_STA_DFR10  = ''A''
					AND	LN50.LC_STA_LON50 = ''A''
				GROUP BY
					LN50.BF_SSN,
					LN50.LN_SEQ,
					LN50.LF_DFR_CTL_NUM
			) LN50 
				ON LN50.BF_SSN = LN10.BF_SSN 
				AND LN50.LN_SEQ = LN10.LN_SEQ 
				AND LN50.ENDDATE >= LN10.LD_LON_ACL_ADD
		WHERE
			LN10.LF_LON_CUR_OWN IN (''82976901'', ''82976902'', ''82976903'', ''82976904'', ''82976905'', ''82976906'', ''82976907'', ''82976908'')
			AND	BR30.BC_EFT_STA = ''A''
			AND	LN10.LD_LON_ACL_ADD IN (''2016-02-11'', ''2016-02-26'', ''2016-03-16'')
			AND 
			(
				LN50.BF_SSN IS NOT NULL
				OR LN60.BF_SSN IS NOT NULL
			)
		ORDER BY
			LN10.BF_SSN,
			LN10.LN_SEQ
	'
)
