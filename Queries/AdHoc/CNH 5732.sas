LIBNAME CS 'T:\CornerStone over XXX Sep X.xlsx';
LIBNAME COMPASS 'T:\Compass over XXX.xlsx';
LIBNAME LEGEND REMOTE SERVER=LEGEND SLIBREF=WORK;

DATA CSGTXXX ; SET CS.'Cornerstone$'N ; RUN;
DATA COMP; SET COMPASS.'sheetX$'N; RUN;

DATA LEGEND.CSGTXXX; SET CSGTXXX; RUN;
DATA LEGEND.COMP; SET COMP; RUN;

RSUBMIT;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;
PROC SQL;
	CREATE TABLE DSX AS
		SELECT
			CSGTXXX.AWARD_ID,
			FSXX.BF_SSN,
			FSXX.LN_SEQ,
			LNXX.LC_STA_LONXX,
			DWXX.WC_DW_LON_STA
		FROM
			CSGTXXX
			LEFT JOIN PKUB.FSXX_DL_LON FSXX
				ON CSGTXXX.AWARD_ID = CATX('',FSXX.LF_FED_AWD,PUT(FSXX.LN_FED_AWD_SEQ,ZX.))
			LEFT JOIN PKUB.LNXX_LON LNXX
				ON FSXX.BF_SSN = LNXX.BF_SSN
				AND FSXX.LN_SEQ = LNXX.LN_SEQ
			LEFT JOIN PKUB.DWXX_DW_CLC_CLU DWXX
				ON FSXX.BF_SSN = DWXX.BF_SSN
				AND FSXX.LN_SEQ = DWXX.LN_SEQ
	;

	CREATE TABLE DSX AS
		SELECT
			COMP.BF_SSN,
			COMP.LN_SEQ,
			CATX('',FSXX.LF_FED_AWD,PUT(FSXX.LN_FED_AWD_SEQ,ZX.)) AS AWARD_ID,
			LNXX.LC_STA_LONXX,
			DWXX.WC_DW_LON_STA
		FROM
			COMP
			LEFT JOIN PKUB.FSXX_DL_LON FSXX
				ON COMP.BF_SSN = FSXX.BF_SSN
				AND COMP.LN_SEQ = FSXX.LN_SEQ
			LEFT JOIN PKUB.LNXX_LON LNXX
				ON FSXX.BF_SSN = LNXX.BF_SSN
				AND FSXX.LN_SEQ = LNXX.LN_SEQ
			LEFT JOIN PKUB.DWXX_DW_CLC_CLU DWXX
				ON FSXX.BF_SSN = DWXX.BF_SSN
				AND FSXX.LN_SEQ = DWXX.LN_SEQ
	;
				
QUIT;
ENDRSUBMIT;

DATA DSX; SET LEGEND.DSX; RUN;
DATA DSX; SET LEGEND.DSX; RUN;

PROC SQL;
	CREATE TABLE MATCHES AS
		SELECT
			DSX.BF_SSN,
			DSX.AWARD_ID,
			DSX.LN_SEQ,
			DSX.LC_STA_LONXX,
			DSX.WC_DW_LON_STA
		FROM
			DSX
			JOIN DSX
				ON DSX.BF_SSN = DSX.BF_SSN
				AND DSX.LN_SEQ = DSX.LN_SEQ
	;

	CREATE TABLE IN_NSLDS AS
		SELECT
			DSX.BF_SSN,
			DSX.AWARD_ID,
			DSX.LN_SEQ,
			DSX.LC_STA_LONXX,
			DSX.WC_DW_LON_STA
		FROM
			DSX
			LEFT JOIN DSX
				ON DSX.BF_SSN = DSX.BF_SSN
				AND DSX.LN_SEQ = DSX.LN_SEQ
		WHERE
			DSX.BF_SSN IS NULL
	;

	CREATE TABLE IN_OURS AS
		SELECT
			DSX.BF_SSN,
			DSX.AWARD_ID,
			DSX.LN_SEQ,
			DSX.LC_STA_LONXX,
			DSX.WC_DW_LON_STA
		FROM
			DSX
			LEFT JOIN DSX
				ON DSX.BF_SSN = DSX.BF_SSN
				AND DSX.LN_SEQ = DSX.LN_SEQ
		WHERE
			DSX.BF_SSN IS NULL
	;
QUIT;
			
PROC EXPORT
		DATA=MATCHES
		OUTFILE='T:\NSLDS Trigger file - XXX+ days compare.xlsx'
		REPLACE;
RUN;

PROC EXPORT
		DATA=IN_NSLDS
		OUTFILE='T:\NSLDS Trigger file - XXX+ days compare.xlsx'
		REPLACE;
RUN;

PROC EXPORT
		DATA=IN_OURS
		OUTFILE='T:\NSLDS Trigger file - XXX+ days compare.xlsx'
		REPLACE;
RUN;
