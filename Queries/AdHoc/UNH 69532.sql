USE UDW
GO

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @SchoolCodes TABLE
(
	SchoolCode CHAR(8),
	SchoolCloseDate DATE
);

INSERT INTO
	@SchoolCodes
VALUES
--OPE ID	Closure Date
('217511',	'09/06/2011'),
('217518',	'12/20/2016'),
('527704',	'08/24/2020'),
('262903',	'05/25/2001'),
('262924',	'09/01/2020'),
('262925',	'09/01/2020'),
('400327',	'03/29/2018'),
('966409',	'08/21/2020'),
('160203',	'12/22/2019'),
('170807',	'05/31/2018'),
('197216',	'12/13/2019'),
('867703',	'05/07/2016'),
('139725',	'08/31/2020'),
('356002',	'05/13/2020'),
('356003',	'12/19/2013'),
('356013',	'12/19/2013'),
('356014',	'12/18/2014'),
('356016',	'05/17/2013'),
('356019',	'12/19/2013'),
('366208',	'05/10/2019'),
('197207',	'12/13/2019'),
('197229',	'12/08/2018'),
('2099505',	'01/01/1990'),
('2099506',	'01/01/1990'),
('2099507',	'01/01/1990'),
('2099508',	'01/01/1990'),
('2099509',	'01/01/1990'),
('2099510',	'01/01/1990'),
('2099512',	'01/01/1990'),
('2099513',	'01/01/1990'),
('2099514',	'01/01/1990'),
('2099515',	'01/01/1990'),
('2099516',	'01/01/1990'),
('2099518',	'01/01/1990'),
('2099519',	'01/01/1990'),
('2099521',	'01/01/1990'),
('2099522',	'01/01/1990'),
('2099523',	'01/01/1990'),
('2099524',	'01/01/1990'),
('2099525',	'01/01/1990'),
('2099526',	'01/01/1990'),
('2099527',	'01/01/1990'),
('2099528',	'01/01/1990'),
('2099529',	'01/01/1990'),
('2099530',	'01/01/1990'),
('2099531',	'01/01/1990'),
('2099532',	'01/01/1990'),
('2099533',	'01/01/1990'),
('2099534',	'01/01/1990'),
('2099535',	'01/01/1990'),
('2099536',	'01/01/1990'),
('2099537',	'01/01/1990'),
('2099538',	'01/01/1990'),
('2099540',	'01/01/1990'),
('2099543',	'01/01/1990'),
('2099544',	'01/01/1990'),
('2099545',	'01/01/1990'),
('2099546',	'01/01/1990'),
('2099547',	'01/01/1990'),
('2099548',	'01/01/1990'),
('2099549',	'01/01/1990'),
('2099550',	'01/01/1990'),
('2099551',	'01/01/1990'),
('2099552',	'01/01/1990'),
('2099553',	'01/01/1990'),
('2099554',	'01/01/1990'),
('2099555',	'01/01/1990'),
('2099556',	'01/01/1990'),
('2099557',	'01/01/1990'),
('2099558',	'01/01/1990'),
('2099560',	'01/01/1990'),
('2099561',	'01/01/1990'),
('2099562',	'01/01/1990'),
('2099564',	'01/01/1990'),
('2099565',	'01/01/1990'),
('2099566',	'01/01/1990'),
('2099568',	'01/01/1990'),
('2099570',	'01/01/1990'),
('2099571',	'01/01/1990'),
('2099573',	'01/01/1990'),
('2099574',	'01/01/1990'),
('2099575',	'01/01/1990'),
('2099577',	'01/01/1990'),
('2099578',	'01/01/1990'),
('2099579',	'01/01/1990'),
('889601',	'03/30/2018'),
('889608',	'03/30/2018'),
('231401',	'05/02/2020'),
('711301',	'05/01/2019'),
('132501',	'03/12/2020'),
('126211',	'05/11/2017'),
('126217',	'05/19/2018'),
('4127900',	'03/02/2020'),
('132208',	'10/17/2016'),
('132215',	'05/01/2020'),
('132502',	'03/12/2020'),
('132510',	'03/10/2020'),
('132513',	'03/12/2020'),
('132514',	'03/12/2020'),
('132515',	'03/12/2020'),
('132516',	'03/12/2020'),
('132517',	'03/12/2020'),
('132518',	'03/12/2020'),
('135219',	'03/02/2020'),
('132520',	'03/12/2020'),
('132521',	'03/12/2020'),
('132523',	'03/12/2020'),
('132525',	'03/12/2020'),
('132528',	'03/12/2020'),
('170803',	'05/03/2019'),
('3120302',	'09/13/2020')

;
--select * from @SchoolCodes

/*****************  MODIFIED QUERY  ***********************/
SELECT
	*
FROM
	(
		SELECT DISTINCT
			PD10.DF_SPE_ACC_ID,
			PD10.DM_PRS_1,
			PD10.DM_PRS_MID,
			PD10.DM_PRS_LST,
			PD30.DX_STR_ADR_1,
			PD30.DX_STR_ADR_2,
			PD30.DX_STR_ADR_3,
			PD30.DM_CT,
			PD30.DC_DOM_ST,
			PD30.DF_ZIP_CDE,
			PD30.DI_VLD_ADR,
			LN10.LF_DOE_SCL_ORG,
			SD10.LF_DOE_SCL_ENR_CUR,
			SD10.LC_REA_SCL_SPR,
			SD10.LD_NTF_SCL_SPR,
			SD10.LD_SCL_SPR [LastDayOfEnrollment],
			School.SchoolCloseDate
		FROM
			PD10_PRS_NME PD10
			INNER JOIN PD30_PRS_ADR PD30 
				ON PD30.DF_PRS_ID = PD10.DF_PRS_ID
			INNER JOIN 
			(
				SELECT
					LN10.BF_SSN,
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN LN10_LON LN10 
						ON LN10.LF_DOE_SCL_ORG = SC.SchoolCode

				UNION

				SELECT DISTINCT
					SD10.LF_STU_SSN [BF_SSN],
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN SD10_STU_SPR SD10 
						ON SD10.LF_DOE_SCL_ENR_CUR = SC.SchoolCode
				WHERE
					SD10.LC_STA_STU10 = 'A'
			) School 
				ON School.BF_SSN = PD10.DF_PRS_ID
			INNER JOIN LN10_LON LN10 
				ON LN10.BF_SSN = PD10.DF_PRS_ID
			LEFT JOIN SD10_STU_SPR SD10 
				ON SD10.LF_STU_SSN = PD10.DF_PRS_ID 
				AND SD10.LF_DOE_SCL_ENR_CUR = School.SchoolCode 
				AND SD10.LC_STA_STU10 = 'A'
		WHERE
			DATEADD(DAY, 121, SD10.LD_SCL_SPR) > School.SchoolCloseDate
			AND LN10.LA_CUR_PRI > 0.00
			AND LN10.LA_LON_AMT_GTR > 0.00
	) X
WHERE
	DATEADD(DAY, 121, ISNULL(X.LastDayOfEnrollment, GETDATE())) > X.SchoolCloseDate
	AND	(
			X.LF_DOE_SCL_ENR_CUR IN (SELECT SchoolCode FROM @SchoolCodes)
			OR	X.LF_DOE_SCL_ORG IN (SELECT SchoolCode FROM @SchoolCodes)
		)
ORDER BY
	X.DF_SPE_ACC_ID
;
