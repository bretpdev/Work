DECLARE @MONTHS TABLE(MONTH_END DATE, PAST_DUE INT, FORB INT, ND_FORB INT)
INSERT INTO @MONTHS (MONTH_END)
VALUES(EOMONTH('07/01/2019')),
(EOMONTH('08/01/2019')),
(EOMONTH('09/01/2019')),
(EOMONTH('10/01/2019')),
(EOMONTH('11/01/2019')),
(EOMONTH('12/01/2019')),
(EOMONTH('01/01/2020')),
(EOMONTH('01/01/2020')),
(EOMONTH('02/01/2020')),
(EOMONTH('03/01/2020')),
(EOMONTH('04/01/2020')),
(EOMONTH('05/01/2020')),
(EOMONTH('06/01/2020')),
(DATEADD(DAY, -1, CAST(GETDATE() AS DATE)))



SELECT
	POP.MONTH_END,
	COUNT(POP.BF_SSN) AS BWR_COUNT
FROM
(
	SELECT DISTINCT
		LN16.BF_SSN,
		M.MONTH_END,
		MAX(CASE 
			WHEN EOMONTH(LD_DLQ_MAX) = '07/31/2020' THEN DATEDIFF(DAY, LD_DLQ_OCC, GETDATE())
			WHEN LD_DLQ_MAX < M.MONTH_END THEN 0 --THE BORROWER BECAME CURRENT THAT MONTH
			ELSE DATEDIFF(DAY, LD_DLQ_OCC, M.MONTH_END)
		END) AS DDP
	FROM
		UDW..LN16_LON_DLQ_HST LN16
		INNER JOIN UDW..LN10_LON LN10
			ON LN10.BF_SSN = LN16.BF_SSN
			AND LN10.LN_SEQ = LN16.LN_SEQ
		INNER JOIN @MONTHS M
			ON M.MONTH_END BETWEEN LN16.LD_DLQ_OCC AND LN16.LD_DLQ_MAX
	WHERE
		 LN10.LC_STA_LON10 = 'R'
		AND LN10.LA_CUR_PRI > 0.00
	GROUP BY
		LN16.BF_SSN,
		M.MONTH_END
) POP
WHERE 
	POP.DDP BETWEEN 6 AND 360
GROUP BY 
	POP.MONTH_END
ORDER BY 
	MONTH_END


SELECT
	POP.MONTH_END,
	POP.FORBEARANCE_TYPE,
	POP.LC_FOR_TYP,
	COUNT(POP.BF_SSN) AS BWR_COUNT
FROM
(
	SELECT DISTINCT
			LN60.BF_SSN,
			M.MONTH_END,
			LTRIM(RTRIM(LK10.PX_DSC_LNG)) AS FORBEARANCE_TYPE,
			FB10.LC_FOR_TYP
		FROM
			UDW..FB10_BR_FOR_REQ FB10
			INNER JOIN UDW..LN60_BR_FOR_APV LN60
				ON LN60.BF_SSN = FB10.BF_SSN
				AND LN60.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM
			INNER JOIN UDW..LN10_LON LN10
				ON LN10.BF_SSN = LN60.BF_SSN
				AND LN10.LN_SEQ = LN60.LN_SEQ
			INNER JOIN CDW..LK10_LS_CDE_LKP LK10
				ON LK10.PM_ATR = 'LC-FOR-TYP'
				AND LK10.PX_ATR_VAL = FB10.LC_FOR_TYP 
			INNER JOIN @MONTHS M
				ON M.MONTH_END BETWEEN LN60.LD_FOR_BEG AND LN60.LD_FOR_END
		WHERE
			LN60.LC_STA_LON60 = 'A'
			AND FB10.LC_STA_FOR10 = 'A'	
			AND LN10.LC_STA_LON10 = 'R'
			AND LN10.LA_CUR_PRI > 0.00
) POP
GROUP BY 
	POP.MONTH_END,
	POP.FORBEARANCE_TYPE,
	POP.LC_FOR_TYP
ORDER BY 
	MONTH_END


SELECT
	POP.MONTH_END,
	POP.FORBEARANCE_TYPE,
	COUNT(POP.BF_SSN) AS BWR_COUNT
FROM
(
	SELECT DISTINCT
			LN60.BF_SSN,
			M.MONTH_END,
			LTRIM(RTRIM(LK10.PX_DSC_LNG)) AS FORBEARANCE_TYPE
		FROM
			UDW..FB10_BR_FOR_REQ FB10
			INNER JOIN UDW..LN60_BR_FOR_APV LN60
				ON LN60.BF_SSN = FB10.BF_SSN
				AND LN60.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM
			INNER JOIN UDW..LN10_LON LN10
				ON LN10.BF_SSN = LN60.BF_SSN
				AND LN10.LN_SEQ = LN60.LN_SEQ
			INNER JOIN CDW..LK10_LS_CDE_LKP LK10
				ON LK10.PM_ATR = 'LC-FOR-TYP'
				AND LK10.PX_ATR_VAL = FB10.LC_FOR_TYP 
			INNER JOIN @MONTHS M
				ON M.MONTH_END BETWEEN LN60.LD_FOR_BEG AND LN60.LD_FOR_END
		WHERE
			LN60.LC_STA_LON60 = 'A'
			AND FB10.LC_STA_FOR10 = 'A'	
			AND LN10.LC_STA_LON10 = 'R'
			AND LN10.LA_CUR_PRI > 0.00
			AND LK10.PX_DSC_EX_LNG = 'DISASTER ADMIN - FORBEARANCE'
) POP
GROUP BY 
	POP.MONTH_END,
	POP.FORBEARANCE_TYPE
ORDER BY 
	MONTH_END