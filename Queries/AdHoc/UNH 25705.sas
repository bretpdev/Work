/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
LIBNAME  DUSTER  REMOTE  SERVER=DUSTER  SLIBREF=WORK; /*live*/
/*LIBNAME  DUSTER  REMOTE  SERVER=QADBD004 SLIBREF=WORK ;/* /*test*/

RSUBMIT;

%MACRO SQLCHECK ;
  %IF  &SQLXRC NE 0  %THEN  %DO  ;
    DATA _NULL_  ;
            FILE REPORTZ NOTITLES  ;
            PUT @01 " ********************************************************************* "
              / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
              / @01 " ****  THE SAS SHOULD BE REVIEWED.                                **** "       
              / @01 " ********************************************************************* "
              / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
              / @01 " ****  &SQLXMSG   **** "
              / @01 " ********************************************************************* "
            ;
         RUN  ;
  %END  ;
%MEND  ;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH); /*DLGSWQUT TEST*//*DLGSUTWH LIVE*/
CREATE TABLE PH05_Change AS
SELECT 
	*
FROM CONNECTION TO DB2 
	(
		SELECT DISTINCT
			COALESCE(PH05.DF_CNC_SYS_ID, 'UT') AS DF_CNC_SYS_ID,
			COALESCE(LPAD(CAST(PH05.DF_SPE_ID AS VARCHAR(10)),10,'0'),PD10.DF_SPE_ACC_ID) AS DF_SPE_ID,
			COALESCE(PH05.DI_CNC_EBL_OPI,'NULL') AS OLD_DI_CNC_EBL_OPI,
			'Y' AS NEW_DI_CNC_EBL_OPI,
			PH05.DC_EBL_OPI_APL_SRC AS OLD_DC_EBL_OPI_APL_SRC,
			'C' AS NEW_DC_EBL_OPI_APL_SRC,
			PH05.DC_EBL_OPI_SRC AS OLD_DC_EBL_OPI_SRC,
			'NB' AS NEW_DC_EBL_OPI_SRC
		FROM
			OLWHRM1.LN10_LON LN10
			INNER JOIN OLWHRM1.PD10_PRS_NME PD10
				ON PD10.DF_PRS_ID = LN10.BF_SSN
			INNER JOIN OLWHRM1.PD32_PRS_ADR_EML PD32
				ON PD32.DF_PRS_ID = PD10.DF_PRS_ID
				AND PD32.DC_STA_PD32 = 'A'
			INNER JOIN OLWHRM1.PH05_CNC_EML PH05
				ON LPAD(CAST(PH05.DF_SPE_ID AS VARCHAR(10)),10,'0') = PD10.DF_SPE_ACC_ID
		WHERE
			(
				LN10.LF_LON_CUR_OWN like '829769%'
				AND LN10.LA_CUR_PRI > 0
				AND LN10.LC_STA_LON10 = 'P'
				AND PD32.DI_VLD_ADR_EML = 'Y'
				AND PH05.DI_CNC_EBL_OPI <> 'Y'
				AND DAYS(COALESCE(LN10.LD_LON_ACL_ADD,'1/1/2016')) >= DAYS('1/1/2016')
			)
	)
;

CREATE TABLE PH05_Add AS
SELECT 
	*
FROM CONNECTION TO DB2 
	(
		SELECT DISTINCT
			'UT' AS DF_CNC_SYS_ID,
			PD10.DF_SPE_ACC_ID AS DF_SPE_ID,
			PD32.DX_ADR_EML AS DX_CNC_EML_ADR,
			'W' AS DC_EML_APL_SYS_SRC, 
			'AA' AS DC_CNC_EML_DAT_SRC,
			'DIG Timestamp' AS DF_DTS_EML_ADR_EFF,
			'DCR' AS DF_LST_USR_EML_ADR,
			'Y' AS DI_VLD_CNC_EML_ADR,
			'W' AS DC_VLD_EML_APL_SRC, 
			'AA' AS DC_VLD_CNC_EML_SRC,
			'DIG Timestamp' AS DF_DTS_VLD_EML_EFF,
			'DCR' AS DF_LST_USR_VLD_EML,
			'SPACE' AS DI_CNC_ELT_OPI,
			'SPACE' AS DC_ELT_OPI_APL_SRC,
			'SPACE' AS DC_ELT_OPI_SRC, 
			'NULL' AS DF_DTS_ELT_OPI_EFF,
			'SPACE' AS DF_LST_USR_ELT_OPI,
			'Y' AS DI_CNC_EBL_OPI,
			'C' AS DC_EBL_OPI_APL_SRC,
			'NB' AS DC_EBL_OPI_SRC, 
			'DIG Timestamp' AS DF_DTS_EBL_OPI_EFF,
			'DCR' AS DF_LST_USR_EBL_OPI,
			'DIG Timestamp' AS DF_LST_DTS_PH05,
			'DCR' AS DF_LST_USR_PH05,
			'02/02/2016' AS DD_CNC_EML_ADR_VER, 
			'02/02/2016' AS DF_LST_DTS_EML_VER,  
			'W' AS DC_LST_EML_VER_SYS,
			'AA' AS DC_LST_EML_VER_SRC,
			UPPER(PD32.DX_ADR_EML) AS DX_CNC_EML_ADR_UC,
			'DCR' AS DF_LST_USR_EML_VER,
			'SPACE' AS DI_CNC_TAX_OPI, 
			'SPACE' AS DC_TAX_OPI_APL_SRC,
			'SPACE' AS DC_TAX_OPI_SRC, 
			'NULL' AS DF_DTS_TAX_OPI_EFF,
			'SPACE' AS DF_LST_USR_TAX_OPI,
			'SPACE' AS DF_ACP_TRM_VRS_ID,
			'NULL' AS DF_DTS_ACP_TRM_EFF,
			'SPACE' AS DF_LST_USR_ACP_TRM
		FROM
			OLWHRM1.LN10_LON LN10
			INNER JOIN OLWHRM1.PD10_PRS_NME PD10
				ON PD10.DF_PRS_ID = LN10.BF_SSN
			INNER JOIN OLWHRM1.PD32_PRS_ADR_EML PD32
				ON PD32.DF_PRS_ID = PD10.DF_PRS_ID
				AND PD32.DC_STA_PD32 = 'A'
			LEFT OUTER JOIN OLWHRM1.PH05_CNC_EML PH05
				ON LPAD(CAST(PH05.DF_SPE_ID AS VARCHAR(10)),10,'0') = PD10.DF_SPE_ACC_ID
		WHERE
			(
				LN10.LF_LON_CUR_OWN like '829769%'
				AND LN10.LA_CUR_PRI > 0
				AND LN10.LC_STA_LON10 = 'P'
				AND PD32.DI_VLD_ADR_EML = 'Y'
				AND DAYS(COALESCE(LN10.LD_LON_ACL_ADD,'1/1/2016')) >= DAYS('1/1/2016')
				AND PH05.DF_SPE_ID IS NULL
			)
	)
;

DISCONNECT FROM DB2;

QUIT;

ENDRSUBMIT;

DATA PH05_Change;
	SET DUSTER.PH05_Change;
RUN;
DATA PH05_Add;
	SET DUSTER.PH05_Add;
RUN;

PROC EXPORT DATA= WORK.PH05_Change 
            OUTFILE= "T:\SAS\NH 25705.xls" 
            DBMS=EXCEL REPLACE;
     SHEET="PH05-Change"; 
RUN;

PROC EXPORT DATA= WORK.PH05_Add
            OUTFILE= "T:\SAS\NH 25705.xls" 
            DBMS=EXCEL REPLACE;
     SHEET="PH05-Add"; 
RUN;
