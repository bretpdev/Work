SELECT DISTINCT
	COUNT(DISTINCT BF_SSN)
FROM 	
	CDW..LNXX_LON_RPS LNXX
WHERE
	LNXX.LC_TYP_SCH_DIS IN ('CP', 'CQ', 'IL', 'IP')
	AND LD_CRT_LONXX BETWEEN 'XX/XX/XXXX' AND 'XX/XX/XXXX'

IF OBJECT_ID('tempdb..#POP') IS NOT NULL 
	DROP TABLE #POP

SELECT
	LNXX.BF_SSN,
	LNXX.LC_TYP_SCH_DIS,
	LNXX.LD_CRT_LONXX,
	DATEDIFF(MONTH, POP.LD_CRT_LONXX, LNXX.LD_CRT_LONXX) AS MON,
	ROW_NUMBER() OVER (PARTITION BY LNXX.BF_SSN, LNXX.LC_TYP_SCH_DIS, LNXX.LD_CRT_LONXX ORDER BY LNXX.LD_CRT_LONXX) AS ROW_NUM
INTO #POP
FROM
	CDW..LNXX_LON_RPS LNXX
	INNER JOIN
	(
		SELECT DISTINCT
			LNXX.BF_SSN,
			MAX(LNXX.LD_CRT_LONXX) AS LD_CRT_LONXX
		FROM 	
			CDW..LNXX_LON_RPS LNXX
		WHERE
			LNXX.LC_TYP_SCH_DIS IN ('CP', 'CQ', 'IL', 'IP')
			AND LD_CRT_LONXX BETWEEN 'XX/XX/XXXX' AND 'XX/XX/XXXX'
		GROUP BY
			LNXX.BF_SSN
	) POP
	 ON POP.BF_SSN = LNXX.BF_SSN
	 AND LNXX.LD_CRT_LONXX >= POP.LD_CRT_LONXX




SELECT 
	COUNT(DISTINCT BF_SSN)
FROM 
	#POP 
WHERE 
	ROW_NUM = X
	AND LC_TYP_SCH_DIS IN  ('CA', 'CX', 'CX', 'CX', 'IB', 'IS', 'IX', 'IX')
	AND MON <= X
