SELECT DISTINCT
	LTRIM(RTRIM(PDXX.DM_PRS_LST)) + ' ' +	LTRIM(RTRIM(PDXX.DM_PRS_X)) AS NAME,
	pdXX.DF_SPE_ACC_ID,
	LNXX.LN_SEQ
FROM
	CDW..LNXX_LON LNXX
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = LNXX.BF_SSN
	INNER JOIN CDW..DWXX_DW_CLC_CLU DWXX
		ON DWXX.BF_SSN = LNXX.BF_SSN
		AND DWXX.LN_SEQ = LNXX.LN_SEQ
	LEFT JOIN
	(
		SELECT
			RSXX.BF_SSN,
			LNXX.LN_SEQ,
			MAX(RSXX.LD_RPS_X_PAY_DU) AS MD
		FROM
			CDW..RSXX_BR_RPD RSXX
			INNER JOIN CDW..LNXX_LON_RPS LNXX
				ON LNXX.BF_SSN = RSXX.BF_SSN
				AND LNXX.LN_RPS_SEQ = RSXX.LN_RPS_SEQ
		GROUP BY
			RSXX.BF_SSN,
			LNXX.LN_SEQ
	)MAX_SCH
		ON MAX_SCH.BF_SSN = LNXX.BF_SSN
		AND MAX_SCH.LN_SEQ = LNXX.LN_SEQ
	LEFT JOIN
	(
		SELECT DISTINCT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			SUM(CASE WHEN ISNULL(RSXX.LC_STA_RPSTXX, ' ') = 'A' THEN X ELSE X END) AS ACTIVE_COUNT
		FROM
			CDW..LNXX_LON LNXX
			LEFT JOIN CDW..RSXX_BR_RPD RSXX
				ON RSXX.BF_SSN = LNXX.BF_SSN
		group by
			LNXX.BF_SSN,
			LNXX.LN_SEQ

	)ACT_COUNT
		ON ACT_COUNT.BF_SSN = LNXX.BF_SSN
		AND ACT_COUNT.LN_SEQ = LNXX.LN_SEQ
	LEFT JOIN CDW..RSXX_BR_RPD RSXX
		ON RSXX.BF_SSN = LNXX.BF_SSN
	LEFT JOIN CDW..LNXX_LON_RPS LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
		AND LNXX.LN_RPS_SEQ = RSXX.LN_RPS_SEQ
WHERE
	LNXX.LA_CUR_PRI > X
	AND LNXX.LC_STA_LONXX = 'R'
	AND DWXX.WC_DW_LON_STA = 'XX'
	AND (
			MAX_SCH.LN_SEQ IS NULL 
			OR
			ACT_COUNT.ACTIVE_COUNT = X
		)
order by 
	pdXX.DF_SPE_ACC_ID,
	LNXX.LN_SEQ
