SELECT DISTINCT
	 LNXX.BF_SSN
	,CASE
		WHEN DATEPART(YEAR,LNXX.LD_FAT_EFF) = XXXX
		THEN 'XXXX'
		WHEN DATEPART(YEAR,LNXX.LD_FAT_EFF) = XXXX
		THEN 'XXXX'
		ELSE 'ERROR'
	END AS [YEAR]
	,SUM(
		COALESCE(LNXX.LA_FAT_PCL_FEE,X) + 
		COALESCE(LNXX.LA_FAT_NSI,X) + 
		COALESCE(LNXX.LA_FAT_LTE_FEE,X) + 
		COALESCE(LNXX.LA_FAT_ILG_PRI,X) + 
		COALESCE(LNXX.LA_FAT_CUR_PRI,X)
	) AS PAYMENT
	,LNXX.PC_FAT_TYP
	,LNXX.PC_FAT_SUB_TYP
	,LNXX.LC_STA_LONXX
	,PDXX.DI_VLD_ADR
	,PDXX.DC_DOM_ST
INTO
	#COMPASS
FROM
	CDW..LNXX_FIN_ATY LNXX
	INNER JOIN CDW..PDXX_PRS_ADR PDXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
WHERE
	DATEPART(YEAR,LNXX.LD_FAT_EFF) IN (XXXX,XXXX)
	AND LNXX.LC_STA_LONXX = 'A'
	AND LNXX.PC_FAT_TYP = 'XX'
	AND PDXX.DI_VLD_ADR = 'Y'
	AND PDXX.DC_DOM_ST = 'WA'
GROUP BY
	 LNXX.BF_SSN
	,DATEPART(YEAR,LNXX.LD_FAT_EFF)
	,LNXX.PC_FAT_TYP
	,LNXX.PC_FAT_SUB_TYP
	,LNXX.LC_STA_LONXX
	,PDXX.DI_VLD_ADR
	,PDXX.DC_DOM_ST
;

--details tab
SELECT DISTINCT
	*
FROM 
	#COMPASS 
ORDER BY
	 BF_SSN
	,[YEAR]
;

--payment type by year tab
SELECT DISTINCT
	'COMPASS' AS [SYSTEM]
	,[YEAR]
	,PC_FAT_TYP
	,PC_FAT_SUB_TYP
	,SUM(PAYMENT) AS PAYMENT
FROM
	#COMPASS
GROUP BY
	[YEAR]
	,PC_FAT_TYP
	,PC_FAT_SUB_TYP
ORDER BY
	[YEAR]
	,PC_FAT_TYP
	,PC_FAT_SUB_TYP
;
