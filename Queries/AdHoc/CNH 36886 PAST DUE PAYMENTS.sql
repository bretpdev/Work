USE CDW
GO

SELECT
	*
FROM
(
	SELECT
		PD.DF_SPE_ACC_ID,
		PD.BF_SSN,
		PD.LN_SEQ,
		CASE WHEN LNXX.LN_SEQ IS NOT NULL THEN 'Y' ELSE 'N' END AS PAST_DUE,
		ISNULL(LNXX.LN_DLQ_MAX,X) AS LN_DLQ_MAX,
		CASE WHEN PMT.LN_SEQ IS NOT NULL THEN 'Y' ELSE 'N' END AS MADE_PMT
	FROM
		CDW..[CNH_XXXXX_Past Due] PD
		LEFT JOIN CDW..LNXX_LON_DLQ_HST LNXX
			ON LNXX.BF_SSN = PD.BF_SSN
			AND LNXX.LN_SEQ = PD.LN_SEQ
			AND LNXX.LC_STA_LONXX = 'X'
		LEFT JOIN
		(
			SELECT	
				p.bf_ssn,
				p.LN_SEQ,
				max(LD_FAT_EFF) as LD_FAT_EFF,
				SUM(PMT_AMT) AS PMT_AMT
			FROM
			(
			SELECT DISTINCT
				lnXX.bf_ssn,
				LNXX.LN_SEQ,
				lnXX.LD_FAT_EFF,
				ABS(ISNULL(LA_FAT_NSI,X)) + ABS(ISNULL(LA_FAT_CUR_PRI,X)) AS PMT_AMT
				--XX.*
			FROM
				CDW..CNH_XXXXX_PAYMENT_runX C
				INNER JOIN CDW..LNXX_FIN_ATY LNXX
					ON LNXX.BF_SSN = C.BF_SSN
					AND LNXX.LN_SEQ = C.LN_SEQ
				INNER JOIN CDW..LNXX_LON_PAY_FAT LNXX
					ON LNXX.BF_SSN = LNXX.BF_SSN
					AND LNXX.LN_SEQ = LNXX.LN_SEQ
					AND LNXX.LN_FAT_SEQ  = LNXX.LN_FAT_SEQ 
				INNER JOIN CDW..RMXX_RMT_BCH RMXX
					ON RMXX.LD_RMT_BCH_INI = LNXX.LD_RMT_BCH_INI
					AND RMXX.LC_RMT_BCH_SRC_IPT = LNXX.LC_RMT_BCH_SRC_IPT
					AND RMXX.LN_RMT_BCH_SEQ = LNXX.LN_RMT_BCH_SEQ
			WHERE
				LNXX.LC_STA_LONXX = 'A'
				AND COALESCE(LNXX.LC_FAT_REV_REA, '') = ''
				AND LNXX.PC_FAT_TYP = 'XX'
				AND RMXX.LC_RMT_BCH_SRC_IPT != 'E'
				and lnXX.LD_FAT_EFF >= 'XX/XX/XXXX'

			) P
			group by
				p.bf_ssn,
				p.LN_SEQ
		) PMT
			ON PMT.BF_SSN = PD.BF_SSN
			AND PMT.LN_SEQ = PD.LN_SEQ
) P
 WHERE P.MADE_PMT = 'N' AND P.PAST_DUE = 'Y'