DROP TABLE IF EXISTS #UNH_63034;

SELECT DISTINCT
	PD10.DF_SPE_ACC_ID,
	LN16.LN_DLQ_MAX,
	CASE
		WHEN LN16.LN_DLQ_MAX BETWEEN 0 AND 30 THEN '0-30'
		WHEN LN16.LN_DLQ_MAX BETWEEN 31 AND 60 THEN '31-60'
		WHEN LN16.LN_DLQ_MAX BETWEEN 61 AND 90 THEN '61-90'
		WHEN LN16.LN_DLQ_MAX BETWEEN 91 AND 120 THEN '91-120'
		WHEN LN16.LN_DLQ_MAX > 120 THEN '120+'
		ELSE 'ERROR'
	END AS DELINQUENCY,
	CASE
		WHEN LN16.LN_DLQ_MAX BETWEEN 0 AND 30 THEN 1
		WHEN LN16.LN_DLQ_MAX BETWEEN 31 AND 60 THEN 2
		WHEN LN16.LN_DLQ_MAX BETWEEN 61 AND 90 THEN 3
		WHEN LN16.LN_DLQ_MAX BETWEEN 91 AND 120 THEN 4
		WHEN LN16.LN_DLQ_MAX > 120 THEN 5
		ELSE 0
	END AS DQ_ORDER,
	SUM(LN10.LA_CUR_PRI) AS sum_LA_CUR_PRI
INTO
	#UNH_63034
FROM
	UDW.calc.RepaymentSchedules RS
	INNER JOIN UDW..LN16_LON_DLQ_HST LN16
		ON RS.BF_SSN = LN16.BF_SSN
		AND RS.LN_SEQ = LN16.LN_SEQ
	INNER JOIN UDW..PD10_PRS_NME PD10
		ON PD10.DF_PRS_ID = RS.BF_SSN
	INNER JOIN UDW..LN10_LON LN10
		ON LN10.BF_SSN = RS.BF_SSN
		AND LN10.LN_SEQ = RS.LN_SEQ
WHERE
	RS.CurrentGradation = 1
	AND LN16.LC_STA_LON16 = '1'
	AND LN10.LC_STA_LON10 = 'R'
	AND LN10.LA_CUR_PRI > 0.00
GROUP BY
	PD10.DM_PRS_LST,
	PD10.DM_PRS_1,
	PD10.DF_SPE_ACC_ID,
	LN16.LN_DLQ_MAX
HAVING
	SUM(LN10.LA_CUR_PRI) > 50000
ORDER BY
	LN16.LN_DLQ_MAX,
	PD10.DF_SPE_ACC_ID
;

SELECT * FROM #UNH_63034;

SELECT
	DQ_ORDER,
	DELINQUENCY,
	COUNT(*) AS COUNT_OF_BORROWERS
FROM
	#UNH_63034
GROUP BY
	DQ_ORDER,
	DELINQUENCY
ORDER BY
	DQ_ORDER
;