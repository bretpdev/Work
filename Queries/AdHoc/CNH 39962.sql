USE CDW
GO
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
--QUESTION X
SELECT
	COUNT(DISTINCT BF_SSN) AS BWR_COUNT
FROM
	CDW..AYXX_BR_LON_ATY
WHERE
	PF_REQ_ACT = 'DICTD'

SELECT DISTINCT
	BF_SSN
FROM
	CDW..AYXX_BR_LON_ATY AYXX
WHERE
	PF_REQ_ACT = 'DICTD'

--QUESTION X
SELECT
	COUNT(DISTINCT DFXX.BF_SSN)
FROM
	CDW..DFXX_BR_DFR_REQ DFXX
	INNER JOIN CDW..LNXX_BR_DFR_APV LNXX
		ON LNXX.BF_SSN = DFXX.BF_SSN
		AND LNXX.LF_DFR_CTL_NUM = DFXX.LF_DFR_CTL_NUM
WHERE
	LC_DFR_TYP = 'XX'
	AND LC_DFR_STA = 'A'
	AND LC_STA_DFRXX = 'A'
	AND LC_STA_LONXX = 'A'

SELECT DISTINCT 
	LNXX.BF_SSN,
	LNXX.LD_DFR_BEG
FROM
	CDW..DFXX_BR_DFR_REQ DFXX
	INNER JOIN CDW..LNXX_BR_DFR_APV LNXX
		ON LNXX.BF_SSN = DFXX.BF_SSN
		AND LNXX.LF_DFR_CTL_NUM = DFXX.LF_DFR_CTL_NUM
WHERE
	LC_DFR_TYP = 'XX'
	AND LC_DFR_STA = 'A'
	AND LC_STA_DFRXX = 'A'
	AND LC_STA_LONXX = 'A'



--QUESTION X
SELECT DISTINCT
	AYXX.BF_SSN,
	AYXX.LD_ATY_REQ_RCV AS DFDNY_DATE,
	FORB.*
FROM
	CDW..AYXX_BR_LON_ATY AYXX
	INNER JOIN
	(
		SELECT
			BF_SSN,
			MAX(LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
		FROM
			CDW..AYXX_BR_LON_ATY
		WHERE
			PF_REQ_ACT = 'DICTD'
		GROUP BY
			BF_SSN
	) IN_A
		ON IN_A.BF_SSN = AYXX.BF_SSN
	LEFT JOIN
	(
		SELECT	
			FBXX.BF_SSN,
			MAX(LNXX.LD_FOR_BEG) AS LD_FOR_BEG

		FROM
			CDW..FBXX_BR_FOR_REQ FBXX
			INNER JOIN CDW..LNXX_BR_FOR_APV LNXX
				ON LNXX.BF_SSN = FBXX.BF_SSN
				AND LNXX.LF_FOR_CTL_NUM = FBXX.LF_FOR_CTL_NUM
		WHERE
			FBXX.LC_FOR_TYP = 'XX'
			AND FBXX.LC_FOR_STA = 'A'
		group by 
			fbXX.bf_ssn
	) FORB
		ON FORB.BF_SSN = AYXX.BF_SSN
WHERE
	AYXX.PF_REQ_ACT = 'DFDNY'
	AND AYXX.LD_ATY_REQ_RCV > IN_A.LD_ATY_REQ_RCV
	AND (forb.BF_SSN is null or forb.LD_FOR_BEG > AYXX.LD_ATY_REQ_RCV)

--QUESTION X
SELECT DISTINCT
	AYXX.BF_SSN,
	AYXX.LD_ATY_REQ_RCV AS DFDNY_DATE,
	FORB.LD_FOR_BEG 
FROM
	CDW..AYXX_BR_LON_ATY AYXX
	INNER JOIN
	(
		SELECT
			BF_SSN,
			MAX(LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
		FROM
			CDW..AYXX_BR_LON_ATY
		WHERE
			PF_REQ_ACT = 'DICTD'
		GROUP BY
			BF_SSN
	) IN_A
		ON IN_A.BF_SSN = AYXX.BF_SSN
	INNER JOIN
	(
		SELECT	
			FBXX.BF_SSN,
			MAX(LNXX.LD_FOR_BEG) AS LD_FOR_BEG

		FROM
			CDW..FBXX_BR_FOR_REQ FBXX
			INNER JOIN CDW..LNXX_BR_FOR_APV LNXX
				ON LNXX.BF_SSN = FBXX.BF_SSN
				AND LNXX.LF_FOR_CTL_NUM = FBXX.LF_FOR_CTL_NUM
		WHERE
			FBXX.LC_FOR_TYP = 'XX'
			AND FBXX.LC_FOR_STA = 'A'
		group by 
			fbXX.bf_ssn
	) FORB
		ON FORB.BF_SSN = AYXX.BF_SSN
		and forb.LD_FOR_BEG = AYXX.LD_ATY_REQ_RCV
WHERE
	AYXX.PF_REQ_ACT = 'DFDNY'
	AND AYXX.LD_ATY_REQ_RCV > IN_A.LD_ATY_REQ_RCV
	--AND (forb.BF_SSN is null or forb.LD_FOR_BEG > AYXX.LD_ATY_REQ_RCV)

--QUESTION X
SELECT
	FORB.BF_SSN,
	CASE WHEN AYXX.LD_ATY_REQ_RCV IS NULL THEN 'NO' ELSE 'YES' END AS HAS_DICTD_ARC,
	FORB.LD_FOR_BEG 
FROM
	
	(
		SELECT	
			FBXX.BF_SSN,
			MAX(LNXX.LD_FOR_BEG) AS LD_FOR_BEG
		FROM
			CDW..FBXX_BR_FOR_REQ FBXX
			INNER JOIN CDW..LNXX_BR_FOR_APV LNXX
				ON LNXX.BF_SSN = FBXX.BF_SSN
				AND LNXX.LF_FOR_CTL_NUM = FBXX.LF_FOR_CTL_NUM
		WHERE
			FBXX.LC_FOR_TYP = 'XX'
			AND FBXX.LC_FOR_STA = 'A'
			AND FBXX.LC_FOR_STA = 'A'
			AND LNXX.LC_STA_LONXX = 'A'
		GROUP BY 
			FBXX.BF_SSN
	) FORB
	LEFT JOIN CDW..AYXX_BR_LON_ATY AYXX
		ON FORB.BF_SSN = AYXX.BF_SSN
		AND AYXX.PF_REQ_ACT = 'DICTD'
	LEFT JOIN
	(
		SELECT DISTINCT 
			LNXX.BF_SSN
		FROM
			CDW..DFXX_BR_DFR_REQ DFXX
			INNER JOIN CDW..LNXX_BR_DFR_APV LNXX
				ON LNXX.BF_SSN = DFXX.BF_SSN
				AND LNXX.LF_DFR_CTL_NUM = DFXX.LF_DFR_CTL_NUM
		WHERE
			LC_DFR_TYP = 'XX'
			AND LC_DFR_STA = 'A'
			AND LC_STA_DFRXX = 'A'
			AND LC_STA_LONXX = 'A'
	) DEF
		ON DEF.BF_SSN = AYXX.BF_SSN
WHERE
	DEF.BF_SSN IS NULL