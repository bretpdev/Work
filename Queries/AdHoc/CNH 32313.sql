USE CDW;
GO
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
GO

;WITH CTE AS
(
	SELECT
		PDXX.DF_SPE_ACC_ID
		,PDXX.DM_PRS_LST
		,PDXX.DM_PRS_X
		,PDXX.DM_PRS_MID
		--,LNXX.LA_BIL_PAS_DU
		,CAST(LNXX.LD_BIL_DU_LON AS DATE)        [LD_BIL_DU_LON]
		,DATEPART(DAY,LNXX.LD_BIL_DU_LON)        [BILL DAY]
		,CAST(LNXX.LD_DLQ_OCC AS DATE)           [LD_DLQ_OCC]
		,DATEDIFF(DAY,LNXX.LD_DLQ_OCC,GETDATE()) [CURRENT_DAYS_DQ]
		,LNXX.LN_DLQ_MAX  
	FROM
		..PDXX_PRS_NME PDXX
		INNER JOIN ..LNXX_LON LNXX
		ON PDXX.DF_PRS_ID = LNXX.BF_SSN
		INNER JOIN 
		(--bill data
			SELECT
				LNXX.BF_SSN
				,LNXX.LN_SEQ
				,MAX(LNXX.LD_BIL_DU_LON) [LD_BIL_DU_LON]
			FROM
				..LNXX_LON_BIL_CRF LNXX
			WHERE
				LNXX.LA_BIL_PAS_DU > X.XX --(amount past due) is greater than X.XX
				AND DATEPART(DAY,LNXX.LD_BIL_DU_LON) BETWEEN X AND XX --(Date bill due) is between the Xst and XXth of each month
				AND LNXX.LD_BIL_DU_LON >= DATEADD(DAY, -XX, CAST(GETDATE() AS DATE))
				AND LNXX.LC_STA_LONXX = 'A'
				AND LNXX.LC_BIL_TYP_LON = 'P'--installment
			GROUP BY
				LNXX.BF_SSN
				,LNXX.LN_SEQ
		) LNXX
			ON LNXX.BF_SSN = LNXX.BF_SSN
			AND LNXX.LN_SEQ = LNXX.LN_SEQ
		INNER JOIN 
		(--delinquency data
			SELECT 
				LNXX.BF_SSN
				,LNXX.LN_SEQ
				,LNXX.LN_DLQ_MAX
				,MAX(LNXX.LD_DLQ_OCC) [LD_DLQ_OCC]
			FROM
				..LNXX_LON_DLQ_HST LNXX
			WHERE
				LNXX.LD_DLQ_OCC >= DATEADD(DAY, -XX, CAST(GETDATE() AS DATE)) --(Day of first missed payment) is in the last XX days 
				AND LNXX.LN_DLQ_MAX < XX -- (Max number of days delinquent) is less than XX days
				AND LNXX.LC_STA_LONXX = X
			GROUP BY
				LNXX.BF_SSN
				,LNXX.LN_SEQ
				,LNXX.LN_DLQ_MAX
		) LNXX
			ON LNXX.BF_SSN = LNXX.BF_SSN
			AND LNXX.LN_SEQ = LNXX.LN_SEQ
		INNER JOIN 
		(--financial activity data
			SELECT 
				LNXX.BF_SSN
				,LNXX.LN_SEQ
			FROM
				..LNXX_FIN_ATY LNXX
			WHERE
				LNXX.LD_FAT_EFF >= DATEADD(DAY, -XX, CAST(GETDATE() AS DATE)) --activity is in the last XX days 
				AND LNXX.LC_STA_LONXX = 'A'
				AND LNXX.LC_FAT_REV_REA = ''
				AND LNXX.PC_FAT_TYP = 'XX'
				AND LNXX.PC_FAT_SUB_TYP = 'XX'
			GROUP BY
				LNXX.BF_SSN
				,LNXX.LN_SEQ   
		) LNXX
			ON LNXX.BF_SSN = LNXX.BF_SSN
			AND LNXX.LN_SEQ = LNXX.LN_SEQ
	WHERE
		LNXX.LA_CUR_PRI > X.XX
		AND LNXX.LC_STA_LONXX = 'R'
)
SELECT DISTINCT
	*
FROM
	CTE
ORDER BY
	DF_SPE_ACC_ID
	,DM_PRS_LST
	,DM_PRS_X
	,DM_PRS_MID
	,[LD_BIL_DU_LON]
	,[BILL DAY]
	,[LD_DLQ_OCC] 
	,[CURRENT_DAYS_DQ]
	,LN_DLQ_MAX DESC
