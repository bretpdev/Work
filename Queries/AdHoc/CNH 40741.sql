SELECT DISTINCT
	LTRIM(RTRIM(PDXX.DM_PRS_X)) AS [First Name],
	LTRIM(RTRIM(PDXX.DM_PRS_LST)) AS [Last Name],
	PDXX.DF_SPE_ACC_ID [Account NUmber],
	ISNULL(MAX(LNXX.LN_DLQ_MAX) OVER (PARTITION BY LNXX.BF_SSN),X) AS Delinquency,
	BL.PerformanceCategory,
	BL.SEGMENT AS Segement,
	MAX(CASE WHEN RANKED.OverallRank = X THEN RANKED.ARA + RANKED.PHN ELSE NULL END) OVER (PARTITION BY PDXX.DF_SPE_ACC_ID) AS PhoneX,
	ISNULL(MAX(CASE WHEN RANKED.OverallRank = X THEN RANKED.ARA + RANKED.PHN ELSE NULL END) OVER (PARTITION BY PDXX.DF_SPE_ACC_ID), 'N/A') AS PhoneX,
	ISNULL(MAX(CASE WHEN RANKED.OverallRank = X THEN RANKED.ARA + RANKED.PHN ELSE NULL END) OVER (PARTITION BY PDXX.DF_SPE_ACC_ID), 'N/A') AS PhoneX,
	CONVERT(VARCHAR(XX), AYXX.LD_ATY_REQ_RCV, XXX) AS [ARC Date]
FROM
	CDW..AYXX_BR_LON_ATY AYXX
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = AYXX.BF_SSN
	INNER JOIN CDW.FsaInvMet.Daily_BorrowerLevel BL
		ON BL.BF_SSN = AYXX.BF_SSN
	INNER JOIN
	(
			SELECT DISTINCT
				PDXX.DF_PRS_ID,
				COALESCE(PDXX.DN_DOM_PHN_ARA,'') AS ARA,
				COALESCE(PDXX.DN_DOM_PHN_XCH,'') + COALESCE(PDXX.DN_DOM_PHN_LCL,'') AS PHN,
				PDXX.DC_PHN,
				DENSE_RANK() OVER (PARTITION BY PDXX.DF_PRS_ID ORDER BY Ranks.TypeRank) AS OverallRank /*Rank phones by type*/
			FROM
				CDW..PDXX_PRS_PHN PDXX
				INNER JOIN
				(
					SELECT
						*,
						CASE WHEN DC_PHN = 'H' THEN X
							 WHEN DC_PHN = 'A' THEN X
							 WHEN DC_PHN = 'W' THEN X
						END AS TypeRank
					FROM
						CDW..PDXX_PRS_PHN PDXX
						WHERE
						PDXX.DI_PHN_VLD = 'Y'
						AND PDXX.DC_NO_HME_PHN != 'J'
						AND PDXX.DC_ALW_ADL_PHN = 'P'
						AND PDXX.DC_PHN IN ('H','A','W')
						AND COALESCE(PDXX.DN_DOM_PHN_ARA,'') + COALESCE(PDXX.DN_DOM_PHN_XCH,'') + COALESCE(PDXX.DN_DOM_PHN_LCL,'') != ''
				) Ranks
					ON Ranks.DF_PRS_ID = PDXX.DF_PRS_ID
					AND Ranks.DC_PHN = PDXX.DC_PHN
			WHERE
				PDXX.DI_PHN_VLD = 'Y'
				AND PDXX.DC_NO_HME_PHN != 'J'
				AND PDXX.DC_ALW_ADL_PHN = 'P'
				AND PDXX.DC_PHN IN ('H','A','W')
				AND COALESCE(PDXX.DN_DOM_PHN_ARA,'') + COALESCE(PDXX.DN_DOM_PHN_XCH,'') + COALESCE(PDXX.DN_DOM_PHN_LCL,'') != ''
	) Ranked
			ON Ranked.DF_PRS_ID = AYXX.BF_SSN
	LEFT JOIN CDW..LNXX_LON_DLQ_HST LNXX
		ON LNXX.BF_SSN = AYXX.BF_SSN
		AND LNXX.LC_STA_LONXX = 'X'
WHERE
	PF_REQ_ACT = 'BRTXT'
	AND LD_ATY_REQ_RCV BETWEEN 'XX/XX/XXXX' AND 'XX/XX/XXXX'
ORDER BY 
	PDXX.DF_SPE_ACC_ID