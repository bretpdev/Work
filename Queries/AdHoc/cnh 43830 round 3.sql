DECLARE @DATA TABLE(BF_SSN CHAR(9))
INSERT INTO @DATA VALUES

('180629438'),
('180629438'),
('487159344'),
('271048582'),
('288064056'),
('416375253'),
('416375253')


--1132
--1033
--1013
DROP TABLE IF EXISTS #POP

SELECT DISTINCT  
	D.* 
into #pop
FROM 
	@DATA D
	LEFT JOIN CDW..CS_TRANSFERPIF PIF
		ON PIF.BF_SSN = D.BF_SSN
	LEFT JOIN
	(
		SELECT DISTINCT
				LN90.BF_SSN,
				LN90.LN_SEQ,
				LN90.LD_FAT_EFF
			FROM
				CDW..LN90_FIN_ATY LN90
			WHERE
				LN90.LC_STA_LON90 = 'A'
				AND COALESCE(rtrim(LN90.LC_FAT_REV_REA),'') = ''
				AND LN90.PC_FAT_TYP = '04'
				AND LN90.PC_FAT_SUB_TYP = '96'
				AND LN90.LD_FAT_EFF >= '11/09/2020'
	) LN90
		ON LN90.BF_SSN = pif.BF_SSN
where	pif.bf_ssn is not null
--select * from #pop
INSERT INTO CDW..CS_TRANSFERPIF
SELECT DISTINCT 
  pop.bf_ssn,	
  'PIF' AS[POPULATION],
  MAX(CASE WHEN LN10.LC_FED_PGM_YR = 'LNC' THEN 1 ELSE 0 END) AS LNC_Count,
	MAX(CASE WHEN LN10.LC_FED_PGM_YR = 'DLO' THEN 1 ELSE 0 END) AS DLO_Count,
	NULL AS LNC_SaleId,
	NULL AS DLO_SaleId,
	NULL,
	NULL 
FROM 
	#POP pop
	INNER JOIN CDW..LN10_LON LN10
		ON LN10.BF_SSN = POP.BF_SSN
GROUP BY
	POP.BF_SSN
