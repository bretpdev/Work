USE UDW
GO

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @SchoolCodes TABLE
(
	SchoolCode CHAR(8),
	SchoolCloseDate DATE
);

INSERT INTO
	@SchoolCodes
VALUES
--OPE ID	Closure Date
('0022102','5/12/2021'),
('03751302','6/12/2021'),
('00372752','3/9/2014'),
('03052000','6/4/2021'),
('00340403','5/4/2021'),
('00869422','12/19/2020'),
('32098825','3/11/2021'),
('82098876','5/11/2021'),
('00914509','5/8/2016'),
('10914510','5/10/2015'),
('10914518','5/10/2015'),
('10914521','5/10/2015'),
('10914528','5/10/2015'),
('10914530','5/10/2015'),
('00914557','5/8/2016'),
('32098850','6/13/2019'),
('00238000','4/23/2017'),
('00238002','8/19/2018'),
('10238023','4/23/2017'),
('10238031','8/20/2017'),
('00238016','8/20/2017'),
('10238099','12/20/2015'),
('20238012','4/27/2014'),
('00238024','4/23/2021'),
('20238044','5/2/2015'),
('20238067','4/30/2018'),
('20238080','4/24/2016'),
('30238003','8/23/2015'),
('30238012','4/23/2017'),
('30238033','12/18/2016'),
('30238041','8/21/2016'),
('30238043','4/22/2018'),
('30238049','5/2/2015'),
('30238050','8/21/2016'),
('30238095','12/14/2014'),
('40238010','8/24/2014'),
('40238011','8/24/2014'),
('40238013','8/20/2015'),
('40238015','12/14/2014'),
('40238031','5/2/2015'),
('40238032','5/2/2015'),
('40238033','12/14/2014'),
('40238039','12/14/2014'),
('40238040','12/20/2015'),
('40238041','8/23/2015'),
('40238042','12/14/2014'),
('40238044','4/30/2016'),
('40238050','4/30/2016'),
('40238051','8/21/2016'),
('40238052','8/21/2016'),
('40238054','12/18/2016'),
('40238057','8/20/2017'),
('40238060','12/18/2016'),
('40238061','8/20/2017'),
('40238074','4/23/2017'),
('40238077','8/25/2013'),
('40238079','4/22/2018'),
('40238086','6/30/2013'),
('40238091','4/22/2018'),
('40238038','8/23/2015'),
('40238048','8/21/2016'),
('40238067','4/23/2017'),
('40238084','8/20/2017'),
('40238089','4/22/2018'),
('50238016','4/23/2021'),
('00694201','4/21/2014'),
('10315106','5/16/2019'),
('10315120','12/15/2020'),
('10315133','11/28/2017'),
('10315129','3/2/2021'),
('00351040','5/9/2020'),
('00351041','5/9/2020'),
('00340409','5/8/2021'),
('02237800','5/29/2021'),
('42098884','1/21/2021'),
('12098806','3/16/2021'),
('00115321','4/20/2021'),
('00115344','4/20/2021'),
('00115353','4/20/2021'),
('00115355','4/20/2021'),
('02553601','3/25/2020'),
('01164913','12/3/2014'),
('22098863','11/17/2020'),
('04211805','7/31/2016'),
('01221502','8/31/2017'),
('01221505','8/31/2017'),
('00238000','4/23/2017'),
('04222600','1/31/2021'),
('01221506','8/31/2017'),
('02235301','6/9/2019')

--select * from @SchoolCodes

/*****************  MODIFIED QUERY  ***********************/
SELECT
	*
FROM
	(
		SELECT DISTINCT
			PD10.DF_SPE_ACC_ID,
			PD10.DM_PRS_1,
			PD10.DM_PRS_MID,
			PD10.DM_PRS_LST,
			PD30.DX_STR_ADR_1,
			PD30.DX_STR_ADR_2,
			PD30.DX_STR_ADR_3,
			PD30.DM_CT,
			PD30.DC_DOM_ST,
			PD30.DF_ZIP_CDE,
			PD30.DI_VLD_ADR,
			LN10.LF_DOE_SCL_ORG,
			SD10.LF_DOE_SCL_ENR_CUR,
			SD10.LD_NTF_SCL_SPR,
			SD10.LC_REA_SCL_SPR,
			SD10.LD_SCL_SPR [LastDayOfEnrollment],
			School.SchoolCloseDate
		FROM
			PD10_PRS_NME PD10
			INNER JOIN PD30_PRS_ADR PD30 
				ON PD30.DF_PRS_ID = PD10.DF_PRS_ID
			INNER JOIN 
			(
				SELECT
					LN10.BF_SSN,
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN LN10_LON LN10 
						ON LN10.LF_DOE_SCL_ORG = SC.SchoolCode

				UNION

				SELECT DISTINCT
					SD10.LF_STU_SSN [BF_SSN],
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN SD10_STU_SPR SD10 
						ON SD10.LF_DOE_SCL_ENR_CUR = SC.SchoolCode
				WHERE
					SD10.LC_STA_STU10 = 'A'
			) School 
				ON School.BF_SSN = PD10.DF_PRS_ID
			INNER JOIN LN10_LON LN10 
				ON LN10.BF_SSN = PD10.DF_PRS_ID
			LEFT JOIN SD10_STU_SPR SD10 
				ON SD10.LF_STU_SSN = PD10.DF_PRS_ID 
				AND SD10.LF_DOE_SCL_ENR_CUR = School.SchoolCode 
				AND SD10.LC_STA_STU10 = 'A'
		WHERE
		--	DATEADD(DAY, 121, SD10.LD_SCL_SPR) > School.SchoolCloseDate
			 LN10.LA_CUR_PRI > 0.00
			AND LN10.LA_LON_AMT_GTR > 0.00
	) X
WHERE
	DATEADD(DAY, 121, ISNULL(X.LastDayOfEnrollment, GETDATE())) > X.SchoolCloseDate
	AND	(
			X.LF_DOE_SCL_ENR_CUR IN (SELECT SchoolCode FROM @SchoolCodes)
			OR	X.LF_DOE_SCL_ORG IN (SELECT SchoolCode FROM @SchoolCodes)
		)
ORDER BY
	X.DF_SPE_ACC_ID

 