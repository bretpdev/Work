SELECT DISTINCT
	AAP.AccountNumber,
	AAP.Comment,
	SUBSTRING(
		SUBSTRING(
			AAP.Comment, 
			CHARINDEX('Format:', AAP.Comment, X) + X, 
			LEN(AAP.Comment)
		), 
		X,
		CHARINDEX(';',SUBSTRING(AAP.Comment, CHARINDEX('Format:', AAP.Comment, X) + X, LEN(AAP.Comment)),X)
	) AS DocType,
	CAST(AAP.ProcessedAt AS DATE) DocProcessedDate,
	COALESCE(LNXX.LN_DLQ_MAX,X) AS LN_DLQ_MAX
FROM
	CLS..ArcAddProcessing AAP
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_SPE_ACC_ID = AAP.AccountNumber
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
	LEFT JOIN CDW..LNXX_LON_DLQ_HST LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
		AND LNXX.LC_STA_LONXX = 'X'
WHERE
	AAP.ARC = 'ALTST'
ORDER BY
	DocType