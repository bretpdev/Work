USE CDW
GO

SELECT DISTINCT
	LNXX.BF_SSN AS SSN,
	RTRIM(PDXX.DM_PRS_LST) AS LAST_NAME,
	RTRIM(PDXX.DM_PRS_X) AS FIRST_NAME,
	(FSXX.LF_FED_AWD + RIGHT('XXX' + CAST(FSXX.LN_FED_AWD_SEQ AS VARCHAR(XX)), X)) as LOAN_ID,
	CASE 
		WHEN LNXX.LC_FED_PGM_YR = 'DLO' THEN 'PSAOO'
		WHEN LNXX.LC_FED_PGM_YR = 'LNC' THEN 'PSAOP'
		ELSE NULL
	END AS LOAN_PROGRAM_TYPE,
	GRXX.WD_LON_GTR AS GUARANTY_DATE
FROM
	CDW..LNXX_LON LNXX
	INNER JOIN
	(	
		SELECT
			GRXX.BF_SSN,
			MAX(GRXX.LN_SEQ) AS LN_SEQ,
			MAX(GRXX.WD_LON_GTR) AS WD_LON_GTR
		FROM
			CDW..GRXX_RPT_LON_APL GRXX
			INNER JOIN
			(
				SELECT
					GRXX.BF_SSN,
					MAX(WD_LON_GTR) AS WD_LON_GTR
				FROM
					CDW..GRXX_RPT_LON_APL GRXX
					INNER JOIN CDW..LNXX_LON LNXX
						ON LNXX.BF_SSN = GRXX.BF_SSN
						AND LNXX.LN_SEQ = GRXX.LN_SEQ
						AND LNXX.LC_STA_LONXX = 'R'
						AND LNXX.LA_CUR_PRI = X
				GROUP BY
					GRXX.BF_SSN
			) M
				ON M.BF_SSN = GRXX.BF_SSN
				AND M.WD_LON_GTR = GRXX.WD_LON_GTR
			INNER JOIN CDW..LNXX_LON LNXX
				ON LNXX.BF_SSN = GRXX.BF_SSN
				AND LNXX.LN_SEQ = GRXX.LN_SEQ
				AND LNXX.LC_STA_LONXX = 'R'
				AND LNXX.LA_CUR_PRI = X
		GROUP BY
			GRXX.BF_SSN
	) GRXX
		ON GRXX.BF_SSN = LNXX.BF_SSN
		AND GRXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN CDW..FSXX_DL_LON FSXX
		ON FSXX.BF_SSN = LNXX.BF_SSN
		AND FSXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = LNXX.BF_SSN
	LEFT JOIN
	(
		SELECT
			BF_SSN
		FROM
			CDW..LNXX_FIN_ATY LNXX
		WHERE
			LNXX.PC_FAT_TYP = 'XX'
			AND LNXX.PC_FAT_SUB_TYP IN ('XX','XX','XX')
			AND	LNXX.LC_STA_LONXX = 'A'
			AND ISNULL(LNXX.LC_FAT_REV_REA,'') = ''
	) LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
WHERE
	LNXX.BF_SSN IS NULL
	AND LNXX.LA_CUR_PRI = X
	AND LNXX.LC_STA_LONXX = 'R'
ORDER BY 
	LNXX.BF_SSN


SELECT DISTINCT
	LNXX.BF_SSN AS SSN,
	RTRIM(PDXX.DM_PRS_LST) AS LAST_NAME,
	RTRIM(PDXX.DM_PRS_X) AS FIRST_NAME,
	(FSXX.LF_FED_AWD + RIGHT('XXX' + CAST(FSXX.LN_FED_AWD_SEQ AS VARCHAR(XX)), X)) as LOAN_ID,
	CASE 
		WHEN LNXX.LC_FED_PGM_YR = 'DLO' THEN 'PSAOO'
		WHEN LNXX.LC_FED_PGM_YR = 'LNC' THEN 'PSAOP'
		ELSE NULL
	END AS LOAN_PROGRAM_TYPE,
	GRXX.WD_LON_GTR AS GUARANTY_DATE
FROM
	CDW..LNXX_LON LNXX
	INNER JOIN
	(	
		SELECT
			GRXX.BF_SSN,
			MAX(GRXX.LN_SEQ) AS LN_SEQ,
			MAX(GRXX.WD_LON_GTR) AS WD_LON_GTR
		FROM
			CDW..GRXX_RPT_LON_APL GRXX
			INNER JOIN
			(
				SELECT
					GRXX.BF_SSN,
					MAX(WD_LON_GTR) AS WD_LON_GTR
				FROM
					CDW..GRXX_RPT_LON_APL GRXX
					INNER JOIN CDW..LNXX_LON LNXX
						ON LNXX.BF_SSN = GRXX.BF_SSN
						AND LNXX.LN_SEQ = GRXX.LN_SEQ
						AND LNXX.LC_STA_LONXX = 'R'
						AND LNXX.LA_CUR_PRI < X
				GROUP BY
					GRXX.BF_SSN
			) M
				ON M.BF_SSN = GRXX.BF_SSN
				AND M.WD_LON_GTR = GRXX.WD_LON_GTR
			INNER JOIN CDW..LNXX_LON LNXX
				ON LNXX.BF_SSN = GRXX.BF_SSN
				AND LNXX.LN_SEQ = GRXX.LN_SEQ
				AND LNXX.LC_STA_LONXX = 'R'
				AND LNXX.LA_CUR_PRI < X
		GROUP BY
			GRXX.BF_SSN
	) GRXX
		ON GRXX.BF_SSN = LNXX.BF_SSN
		AND GRXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN CDW..FSXX_DL_LON FSXX
		ON FSXX.BF_SSN = LNXX.BF_SSN
		AND FSXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = LNXX.BF_SSN
	--LEFT JOIN
	--(
	--	SELECT
	--		BF_SSN
	--	FROM
	--		CDW..LNXX_FIN_ATY LNXX
	--	WHERE
	--		LNXX.PC_FAT_TYP = 'XX'
	--		AND LNXX.PC_FAT_SUB_TYP IN ('XX','XX','XX')
	--		AND	LNXX.LC_STA_LONXX = 'A'
	--		AND ISNULL(LNXX.LC_FAT_REV_REA,'') = ''
	--) LNXX
	--	ON LNXX.BF_SSN = LNXX.BF_SSN
WHERE
	--LNXX.BF_SSN IS NULL
	LNXX.LA_CUR_PRI < X
	AND LNXX.LC_STA_LONXX = 'R'
ORDER BY 
	LNXX.BF_SSN