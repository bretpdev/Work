USE UDW
GO

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @SchoolCodes TABLE (SchoolCode CHAR(8),	SchoolCloseDate DATE);
INSERT INTO	@SchoolCodes (SchoolCode, SchoolCloseDate) VALUES
--OPE ID	Closure Date
('00221812','8/31/2018'),
('00262802','6/24/2014'),
('00262803','5/12/2014'),
('00262804','6/24/2014'),
('00262805','8/28/2017'),
('00262807','8/28/2017'),
('00263801','6/30/2018'),
('42098802','4/29/2019'),
('02176000','7/1/2019'),
('03115308','6/30/2014'),
('03115309','6/30/2014'),
('03115310','6/30/2019'),
('00918600','5/14/2019'),
('00757307','5/31/2019'),
('00383105','7/3/2019'),
('02283801','6/30/2019'),
('02283804','4/26/2019'),
('03071601','3/5/2018'),
('00245635','6/22/2019'),
('04243600','6/12/2019'),
('00252159','7/27/2018'),
('00252169','7/27/2018'),
('00303013','3/16/2014'),
('02158800','6/30/2019'),
('00991709','5/11/2019'),
('00991717','5/13/2019'),
('00991754','5/23/2013'),
('00233402','5/3/2019'),
('00372609','6/1/2019'),
('04151401','7/31/2018'),
('04254800','7/26/2019'),
('00303002','7/11/2013'),
('00303004','1/28/2019'),
('00384801','5/31/2019'),
('00252138','5/31/2018'),
('03030608','6/28/2019'),
('03030609','6/12/2019'),
('52098875','5/2/2019'),
('01006002','5/10/2012'),
('00186903','7/8/2019'),
('00248022','7/25/2018'),
('00248057','7/28/2018'),
('00248058','7/25/2018'),
('00248061','7/25/2018'),
('00248069','7/25/2018'),
('00248072','7/25/2018'),
('00248073','7/25/2018'),
('00248080','7/25/2018'),
('00248094','7/25/2018'),
('00248099','7/25/2018'),
('10252124','12/31/2018'),
('00458608','5/7/2019'),
('00450700','6/30/2019'),
('03030606','6/16/2019'),
('04230400','6/30/2019'),
('03030600','6/9/2019'),
('02623800','6/21/2019'),
('02582700','6/25/2019'),
('03030603','6/13/2019'),
('02225302','12/31/2012'),
('10252116','9/18/2018'),
('03030601','6/9/2019'),
('03030605','6/9/2019')
;

--select * from @SchoolCodes



/**** UNH 23008 query **/

--SELECT DISTINCT
--	LN10.BF_SSN,
--	LN10.LN_SEQ,
--	LN10.LF_DOE_SCL_ORG
--FROM
--	LN10_LON LN10
--WHERE
--	LN10.LF_DOE_SCL_ORG IN (SELECT SchoolCode FROM @SchoolCodes)
--;


/*****************  MODIFIED QUERY  ***********************/
SELECT
	*
FROM
	(
		SELECT DISTINCT
			PD10.DF_SPE_ACC_ID,
			PD10.DM_PRS_1,
			PD10.DM_PRS_MID,
			PD10.DM_PRS_LST,
			PD30.DX_STR_ADR_1,
			PD30.DX_STR_ADR_2,
			PD30.DX_STR_ADR_3,
			PD30.DM_CT,
			PD30.DC_DOM_ST,
			PD30.DF_ZIP_CDE,
			PD30.DI_VLD_ADR,
			LN10.LF_DOE_SCL_ORG,
			SD10.LF_DOE_SCL_ENR_CUR,
			SD10.LC_REA_SCL_SPR,
			SD10.LD_NTF_SCL_SPR,
			SD10.LD_SCL_SPR [LastDayOfEnrollment],
			School.SchoolCloseDate
			--,SUM(LN10.LA_CUR_PRI) OVER(PARTITION BY LN10.BF_SSN) AS sum_LA_CUR_PRI
			--,SUM(LN10.LA_LON_AMT_GTR) OVER(PARTITION BY LN10.BF_SSN) AS sum_LA_LON_AMT_GTR
		FROM
			PD10_PRS_NME PD10
			INNER JOIN PD30_PRS_ADR PD30 
				ON PD30.DF_PRS_ID = PD10.DF_PRS_ID
			INNER JOIN 
			(
				SELECT
					LN10.BF_SSN,
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN LN10_LON LN10 
						ON LN10.LF_DOE_SCL_ORG = SC.SchoolCode

				UNION ALL

				SELECT DISTINCT
					SD10.LF_STU_SSN [BF_SSN],
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN SD10_STU_SPR SD10 
						ON SD10.LF_DOE_SCL_ENR_CUR = SC.SchoolCode
				WHERE
					SD10.LC_STA_STU10 = 'A'
			) School 
				ON School.BF_SSN = PD10.DF_PRS_ID
			INNER JOIN LN10_LON LN10 
				ON LN10.BF_SSN = PD10.DF_PRS_ID
			LEFT JOIN SD10_STU_SPR SD10 
				ON SD10.LF_STU_SSN = PD10.DF_PRS_ID 
				AND SD10.LF_DOE_SCL_ENR_CUR = School.SchoolCode 
				AND SD10.LC_STA_STU10 = 'A'
		WHERE
			DATEADD(DAY, 121, SD10.LD_SCL_SPR) > School.SchoolCloseDate
			--AND LN10.LA_CUR_PRI > 0.00
			--AND LN10.LA_LON_AMT_GTR > 0.00
	) X
WHERE
	DATEADD(DAY, 121, ISNULL(X.LastDayOfEnrollment, GETDATE())) > X.SchoolCloseDate
	AND	(
			X.LF_DOE_SCL_ENR_CUR IN (SELECT SchoolCode FROM @SchoolCodes)
			OR	X.LF_DOE_SCL_ORG IN (SELECT SchoolCode FROM @SchoolCodes)
		)
ORDER BY
	X.DF_SPE_ACC_ID
;

