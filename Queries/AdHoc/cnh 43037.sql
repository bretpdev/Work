USE CDW
GO
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SELECT
	*
FROM OPENQUERY(LEGEND,
'
SELECT 
	LN15.BF_SSN,
	LN15.LN_SEQ,
	LN15.LD_DSB AS LAST_DSB_DATE,
	LN15.LA_DSB,
	LN15.LA_DSB_CAN,
	LN15.TOTAL_DSB,
	LN10.LA_CUR_PRI AS CURRENT_PRINCIPAL,
	GR10.WD_NDS_LN_DSB_RPT,
	LN90.LD_FAT_PST
FROM
	PKUB.LN10_LON LN10
	INNER JOIN PKUB.GR10_RPT_LON_APL GR10
		ON GR10.BF_SSN = LN10.BF_SSN
		AND GR10.LN_SEQ = LN10.LN_SEQ
	INNER JOIN 
	(
		SELECT	
			LN15.BF_SSN,
			LN15.LN_SEQ,
			SUM(LA_DSB) AS LA_DSB,
			SUM(COALESCE(LA_DSB_CAN, 0)) AS LA_DSB_CAN,
			MAX(LD_DSB) AS LD_DSB,
			SUM(LA_DSB - COALESCE(LA_DSB_CAN, 0)) AS TOTAL_DSB
		FROM
			PKUB.LN15_DSB LN15
		GROUP BY
			LN15.BF_SSN,
			LN15.LN_SEQ
		
	) LN15
		ON LN15.BF_SSN = LN10.BF_SSN
		AND LN15.LN_SEQ = LN10.LN_SEQ
	LEFT JOIN
	(
		SELECT
			BF_SSN,
			LN_SEQ,
			MAX(LD_FAT_PST) AS LD_FAT_PST
		FROM
			PKUB.LN90_FIN_ATY LN90
		WHERE
			LN90.PC_FAT_TYP = ''07''
			AND LN90.PC_FAT_SUB_TYP = ''85''
			AND LN90.LC_STA_LON90 = ''A''
			AND COALESCE(LN90.LC_FAT_REV_REA,'''') = ''''
		GROUP BY
			BF_SSN,
			LN_SEQ
		
	) LN90
		ON LN90.BF_SSN = LN10.BF_SSN
		AND LN90.LN_SEQ = LN10.LN_SEQ

WHERE
	LN10.LA_CUR_PRI > 0.00
	AND (LN10.LA_CUR_PRI > ((LN15.TOTAL_DSB * .5) + LN15.TOTAL_DSB))
	AND YEAR(LN15.LD_DSB) BETWEEN 2013 AND 2019
ORDER BY
	LN15.BF_SSN,
	LN15.LN_SEQ
')