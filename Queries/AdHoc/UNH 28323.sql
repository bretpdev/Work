/*R2*/
SELECT 
	ACHBorrowers.SSN,
	ACHBorrowers.ACCT,
	ACHBorrowers.FIRST_NAME,
	ACHBorrowers.LAST_NAME,
	ACHBorrowers.LN_SEQ AS ON_ACH_SEQ,
	NonACHBorrowers.LN_SEQ AS NON_ACH_SEQ
 FROM OPENQUERY (DUSTER,'
	SELECT DISTINCT
		LN10_ON.BF_SSN				AS SSN
		,PD10.DF_SPE_ACC_ID		AS ACCT
		,PD10.DM_PRS_1			AS FIRST_NAME
		,PD10.DM_PRS_LST		AS LAST_NAME
		,LN83_ON.LN_SEQ			AS LN_SEQ 
	FROM
		OLWHRM1.LN10_LON LN10_ON
		INNER JOIN OLWHRM1.PD10_PRS_NME PD10
			ON LN10_ON.BF_SSN = PD10.DF_PRS_ID
		LEFT JOIN 
			(
				SELECT DISTINCT
					LN83.BF_SSN
					,LN83.LN_SEQ
					,BR30.BN_EFT_SEQ
				FROM
					OLWHRM1.LN83_EFT_TO_LON LN83
					INNER JOIN OLWHRM1.BR30_BR_EFT BR30
						ON LN83.BF_SSN = BR30.BF_SSN
						AND LN83.BN_EFT_SEQ = BR30.BN_EFT_SEQ
				WHERE
					LN83.LC_STA_LN83 = ''A''
					AND LN83.LD_EFT_EFF_END IS NULL  --OR LN83.LD_EFT_EFF_END = ''''
					AND BR30.BC_EFT_STA = ''A''
			)LN83_ON
				ON LN83_ON.BF_SSN = LN10_ON.BF_SSN
				AND LN83_ON.LN_SEQ = LN10_ON.LN_SEQ			
	WHERE
		LN10_ON.LC_STA_LON10 = ''R''  
		AND LN10_ON.LA_CUR_PRI > ''0''  
		AND LN10_ON.LF_LON_CUR_OWN LIKE ''829769%''
		AND LN83_ON.LN_SEQ IS NOT NULL 
') ACHBorrowers INNER JOIN OPENQUERY
(DUSTER,
'
	SELECT DISTINCT
		LN10_OFF.BF_SSN				AS SSN
		,PD10.DF_SPE_ACC_ID		AS ACCT
		,PD10.DM_PRS_1			AS FIRST_NAME
		,PD10.DM_PRS_LST		AS LAST_NAME
		,LN10_OFF.LN_SEQ			AS LN_SEQ 
	FROM
		OLWHRM1.LN10_LON LN10_OFF
		INNER JOIN OLWHRM1.PD10_PRS_NME PD10
			ON LN10_OFF.BF_SSN = PD10.DF_PRS_ID
		LEFT JOIN 
			(
				SELECT DISTINCT
					LN83.BF_SSN
					,LN83.LN_SEQ
					,BR30.BN_EFT_SEQ
				FROM
					OLWHRM1.LN83_EFT_TO_LON LN83
					INNER JOIN OLWHRM1.BR30_BR_EFT BR30
						ON LN83.BF_SSN = BR30.BF_SSN
						AND LN83.BN_EFT_SEQ = BR30.BN_EFT_SEQ 
				WHERE
					LN83.LC_STA_LN83 = ''A''
					AND LN83.LD_EFT_EFF_END IS NULL  --OR LN83.LD_EFT_EFF_END = ''''
					AND BR30.BC_EFT_STA = ''A''
			)LN83_OFF
				ON LN83_OFF.BF_SSN = LN10_OFF.BF_SSN
				AND LN83_OFF.LN_SEQ = LN10_OFF.LN_SEQ			
	WHERE
		LN10_OFF.LC_STA_LON10 = ''R''  
		AND LN10_OFF.LA_CUR_PRI > ''0''  
		AND LN10_OFF.LF_LON_CUR_OWN LIKE ''829769%''
		AND LN83_OFF.LN_SEQ IS NULL 
') NonACHBorrowers ON NonACHBorrowers.SSN = ACHBorrowers.SSN;

/*R3*/
SELECT * FROM OPENQUERY (DUSTER,'
	SELECT DISTINCT
		LN10.BF_SSN				AS SSN
		,PD10.DF_SPE_ACC_ID		AS ACCT
		,PD10.DM_PRS_1			AS FIRST_NAME
		,PD10.DM_PRS_LST		AS LAST_NAME
		,AY10.LD_ATY_REQ_RCV	AS ARC_DATE
		,CASE 
			WHEN LN83_ON.STATUS = ''1'' 
			THEN ''Y'' 
			ELSE ''N'' 
		END AS ON_ACH
		,AY10.PF_REQ_ACT
		,AY20.LX_ATY
	FROM
		OLWHRM1.LN10_LON LN10
		INNER JOIN OLWHRM1.PD10_PRS_NME PD10
			ON LN10.BF_SSN = PD10.DF_PRS_ID
		INNER JOIN OLWHRM1.AY10_BR_LON_ATY AY10
			ON LN10.BF_SSN = AY10.BF_SSN
		INNER JOIN OLWHRM1.AY20_ATY_TXT AY20
			ON AY10.BF_SSN = AY20.BF_SSN
			AND AY10.LN_ATY_SEQ = AY20.LN_ATY_SEQ
		LEFT JOIN 
			(
				SELECT DISTINCT
					LN83.BF_SSN
					,LN83.LN_SEQ
					,BR30.BN_EFT_SEQ
					,''1'' AS STATUS
				FROM
					OLWHRM1.LN83_EFT_TO_LON LN83
					INNER JOIN OLWHRM1.BR30_BR_EFT BR30
						ON LN83.BF_SSN = BR30.BF_SSN
						AND LN83.BN_EFT_SEQ = BR30.BN_EFT_SEQ
				WHERE
					LN83.LC_STA_LN83 = ''A''
					AND LN83.LD_EFT_EFF_END IS NULL  --OR LN83.LD_EFT_EFF_END = ''''
					AND BR30.BC_EFT_STA = ''A''
			)LN83_ON
				ON LN83_ON.BF_SSN = LN10.BF_SSN
				AND LN83_ON.LN_SEQ = LN10.LN_SEQ
	WHERE
	   LN10.LC_STA_LON10 = ''R''  
	   AND LN10.LA_CUR_PRI > ''0.00''  
	   AND LN10.LF_LON_CUR_OWN LIKE ''829769%''
	   AND AY10.PF_REQ_ACT = ''PAUTO''
	   AND AY20.LX_ATY LIKE ''BORROWER NOT ELIGIBLE FOR AUTOPAY DUE TO UHEAA NOT OWNING THE LOANS.%DENIAL LETTER SENT TO BORROWER.%''
');


/**************************************************
TESTING
TESTING
TESTING
TESTING
TESTING
***************************************************/
/*R3*/
--SELECT * FROM OPENQUERY (DUSTER,'
--SELECT 
--	AY20.BF_SSN
--	,AY10.LN_ATY_SEQ
--	,LN10.LN_SEQ
--	,AY10.LD_ATY_REQ_RCV
--	,AY20.LX_ATY
--	,AY10.PF_REQ_ACT
--	,AY10.LC_STA_ACTY10
--	,AY15.LC_STA_AY15
--FROM 
--	OLWHRM1.AY10_BR_LON_ATY AY10
--	INNER JOIN OLWHRM1.AY15_ATY_CMT AY15
--		ON AY10.BF_SSN = AY15.BF_SSN
--		AND AY10.LN_ATY_SEQ = AY15.LN_ATY_SEQ

--	INNER JOIN OLWHRM1.AY20_ATY_TXT AY20
--		ON AY10.BF_SSN = AY20.BF_SSN
--		AND AY10.LN_ATY_SEQ = AY20.LN_ATY_SEQ
--	INNER JOIN OLWHRM1.LN10_LON LN10
--		ON AY10.BF_SSN = LN10.BF_SSN
--WHERE 
--	AY10.BF_SSN IN (''124766271'',''630079285'')
--	AND AY20.LX_ATY LIKE ''BORROWER NOT ELIGIBLE FOR AUTOPAY DUE TO UHEAA NOT OWNING THE LOANS.%DENIAL LETTER SENT TO BORROWER.%''
--	AND LN10.LC_STA_LON10 = ''R''  
--	AND LN10.LA_CUR_PRI >= ''0.00''  
--	AND LN10.LF_LON_CUR_OWN LIKE ''829769%''
--	AND AY10.PF_REQ_ACT = ''PAUTO''
--');

--SELECT * FROM OPENQUERY (DUSTER,'
--	SELECT DISTINCT
--		LN83.BF_SSN
--		,LN83.LN_SEQ			AS LN83_LN_SEQ
--		,MAX(BR30.BN_EFT_SEQ)	AS BR30_ON
--	FROM
--		OLWHRM1.LN83_EFT_TO_LON LN83
--		INNER JOIN OLWHRM1.BR30_BR_EFT BR30
--			ON LN83.BF_SSN = BR30.BF_SSN
--			AND LN83.BN_EFT_SEQ = BR30.BN_EFT_SEQ
--	WHERE
--		BR30.BN_EFT_SEQ = ''1''
--		AND LN83.BF_SSN IN (''124766271'',''630079285'')
--	GROUP BY
--		LN83.BF_SSN
--		,LN83.LN_SEQ
--');