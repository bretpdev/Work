USE UDW
GO

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @SchoolCodes TABLE (SchoolCode CHAR(8),	SchoolCloseDate DATE);
INSERT INTO	@SchoolCodes (SchoolCode, SchoolCloseDate) VALUES
--OPE ID	Closure Date
('02079417','8/2/2019'),
('00259118','6/30/2018'),
('00368500','5/17/2019'),
('00904301','4/12/2019'),
('04139700','9/10/2019'),
('00325942','5/31/2019'),
('00327207','12/20/2016'),
('00327223','12/13/2018'),
('00327229','4/25/2019'),
('00327506','12/15/2018'),
('01326303','9/10/2019'),
('02283800','9/28/2019'),
('02283805','9/28/2019'),
('40182240','6/23/2017'),
('03116100','9/6/2019'),
('03116102','9/6/2019'),
('00202907','8/8/2019'),
('00167101','8/19/2018'),
('00167104','8/18/2017'),
('10914538','5/8/2017'),
('00914534','5/8/2017'),
('00170713','8/30/2016'),
('00170761','12/31/2016'),
('10174100','12/6/2017'),
('10174101','8/19/2013'),
('10174102','12/6/2017'),
('10174103','12/6/2017'),
('10174104','12/6/2017'),
('10174105','12/6/2017'),
('10174106','7/1/2007'),
('10174107','12/6/2017'),
('10174108','12/8/2017'),
('10174109','2/1/2013'),
('10174110','12/6/2017'),
('10174111','7/1/2017'),
('10174112','7/1/2007'),
('10174113','7/1/2007'),
('10174114','12/8/2017'),
('10174115','8/19/2013'),
('10174116','10/1/2014'),
('10174117','8/19/2013'),
('10174118','12/8/2017'),
('10174119','12/6/2017'),
('10174120','10/1/2014'),
('10174121','10/1/2014'),
('10174122','12/6/2017'),
('10174123','11/1/2017'),
('10174124','12/6/2017'),
('10174125','10/1/2014'),
('10174126','12/6/2017'),
('10174127','12/6/2017'),
('10174128','12/8/2017'),
('10174129','12/6/2017'),
('10174130','12/8/2017'),
('10174131','12/6/2017'),
('10174132','10/1/2014'),
('10174133','12/8/2001'),
('10174134','5/10/2016'),
('10174135','12/6/2017'),
('10174136','9/27/2011'),
('10174137','12/28/2018'),
('10174138','12/6/2017'),
('10174139','12/8/2017'),
('10174140','12/6/2017'),
('10174141','12/6/2017'),
('10174142','12/8/2017'),
('10174143','12/6/2017'),
('10174144','12/6/2017'),
('10174146','12/8/2017'),
('10174147','12/6/2017'),
('10174148','1/1/2009'),
('10174149','10/1/2014'),
('10174150','12/8/2017'),
('10174151','3/16/2017'),
('10174152','12/6/2017'),
('10174153','12/6/2017'),
('10174154','10/1/2014'),
('10174155','12/8/2017'),
('10174156','12/6/2017'),
('10174157','2/1/2014'),
('10174158','12/6/2017'),
('10174159','12/8/2017'),
('00174116','12/6/2017'),
('10174160','12/6/2017'),
('10174161','12/6/2017'),
('10174162','12/6/2017'),
('10174163','12/28/2018'),
('10174164','12/6/2017'),
('10174165','12/8/2017'),
('10174166','12/6/2017'),
('10174167','12/6/2017'),
('10174168','12/6/2017'),
('10174169','12/6/2017'),
('10174170','12/28/2018'),
('10174171','12/6/2017'),
('10174172','12/6/2017'),
('10174173','12/6/2017'),
('10174174','10/1/2014'),
('10174175','10/1/2014'),
('10174176','6/1/2010'),
('10174177','6/1/2010'),
('10174178','12/6/2017'),
('10174179','12/8/2017'),
('10174180','3/16/2017'),
('10174181','12/8/2017'),
('10174182','12/6/2017'),
('10174183','3/1/2017'),
('10174184','3/1/2011'),
('10174185','3/16/2017'),
('10174187','12/8/2017'),
('10174188','12/6/2017'),
('10174189','2/1/2011'),
('10174190','2/1/2011'),
('10174191','12/6/2017'),
('10174192','12/6/2017'),
('10174193','12/6/2017'),
('10174194','6/1/2011'),
('10174195','12/6/2017'),
('10174196','12/6/2017'),
('10174197','3/1/2017'),
('10174198','12/8/2017'),
('10174199','12/8/2017'),
('20174100','12/8/2017'),
('20174101','12/8/2017'),
('20174102','12/6/2017'),
('20174103','3/16/2017'),
('20174104','12/8/2017'),
('20174105','9/1/2011'),
('20174106','12/8/2017'),
('20174107','12/6/2017'),
('20174108','12/6/2017'),
('20174109','10/1/2011'),
('00174121','7/1/2007'),
('20174110','10/1/2011'),
('20174111','12/6/2017'),
('20174112','10/1/2011'),
('20174113','10/1/2011'),
('20174114','12/6/2017'),
('20174115','3/1/2012'),
('20174117','3/1/2013'),
('20174118','12/8/2017'),
('20174119','12/6/2017'),
('20174120','12/6/2017'),
('20174121','3/1/2012'),
('20174122','3/1/2012'),
('20174123','3/1/2012'),
('20174124','3/1/2012'),
('20174125','12/6/2017'),
('20174126','12/6/2017'),
('20174127','12/8/2017'),
('20174128','12/8/2017'),
('20174129','12/6/2017'),
('00174123','7/1/2007'),
('20174130','12/6/2017'),
('20174131','12/6/2017'),
('20174132','12/6/2017'),
('20174133','12/6/2017'),
('20174134','12/6/2017'),
('20174135','12/8/2017'),
('20174136','3/1/2017'),
('20174137','12/8/2017'),
('20174138','9/1/2012'),
('20174139','12/28/2018'),
('00174124','10/1/2014'),
('20174140','12/6/2017'),
('20174141','12/8/2017'),
('20174142','12/6/2017'),
('20174143','12/6/2017'),
('20174144','12/6/2017'),
('20174145','12/6/2017'),
('20174146','12/6/2017'),
('20174148','12/6/2017'),
('20174149','12/6/2017'),
('00174125','7/1/2007'),
('20174150','12/8/2017'),
('20174151','12/6/2017'),
('20174152','12/8/2017'),
('20174153','12/6/2017'),
('20174154','12/8/2017'),
('20174155','3/1/2017'),
('20174156','12/6/2017'),
('20174157','12/6/2017'),
('20174158','12/6/2017'),
('20174159','12/6/2017'),
('00174126','7/1/2007'),
('20174160','7/1/2013'),
('20174161','12/6/2017'),
('20174162','12/8/2017'),
('20174163','12/8/2017'),
('20174165','12/6/2017'),
('20174166','12/8/2017'),
('20174167','11/1/2013'),
('20174168','12/6/2017'),
('20174169','3/1/2017'),
('00174127','7/1/2007'),
('20174170','12/6/2017'),
('20174171','12/6/2017'),
('20174172','4/1/2014'),
('20174173','6/1/2014'),
('20174174','6/1/2014'),
('20174175','12/28/2018'),
('20174176','12/6/2017'),
('20174177','12/6/2017'),
('20174178','12/6/2017'),
('20174179','8/1/2014'),
('00174128','7/1/2007'),
('20174180','12/6/2017'),
('20174185','3/1/2015'),
('20174186','10/1/2014'),
('20174187','12/8/2017'),
('20174188','12/28/2018'),
('20174189','3/1/2015'),
('00174129','7/1/2007'),
('20174190','12/6/2017'),
('20174192','12/28/2018'),
('20174193','5/1/2015'),
('20174194','5/1/2015'),
('20174195','12/8/2017'),
('20174196','12/6/2017'),
('20174197','3/16/2017'),
('20174198','12/6/2017'),
('20174199','12/6/2017'),
('00174130','7/1/2007'),
('30174100','11/1/2015'),
('30174101','12/6/2017'),
('30174104','12/6/2017'),
('30174105','11/1/2017'),
('30174106','12/6/2017'),
('30174107','5/1/2016'),
('30174108','12/28/2018'),
('30174109','12/6/2017'),
('00174131','7/1/2007'),
('30174111','12/6/2017'),
('30174112','2/1/2017'),
('30174113','12/6/2017'),
('30174114','12/6/2017'),
('30174115','8/31/2016'),
('30174118','3/16/2017'),
('00174132','12/6/2017'),
('30174120','12/28/2018'),
('30174122','12/28/2018'),
('00174133','12/6/2017'),
('00174134','7/1/2007'),
('00174135','7/1/2007'),
('00174136','7/1/2007'),
('00174137','7/1/2007'),
('00174138','7/1/2007'),
('00174139','7/1/2007'),
('00174140','7/1/2007'),
('00174141','7/1/2007'),
('00174142','7/1/2007'),
('00174143','12/6/2017'),
('00174144','12/8/2017'),
('00174145','7/1/2007'),
('00174146','7/1/2007'),
('00174147','12/6/2017'),
('00174148','12/6/2017'),
('00174149','12/6/2017'),
('00174150','7/1/2007'),
('00174151','7/1/2007'),
('00174152','7/1/2007'),
('00174153','7/1/2007'),
('00174154','7/1/2007'),
('00174155','7/1/2007'),
('00174156','12/6/2017'),
('00174157','7/1/2007'),
('00174158','7/1/2007'),
('00174159','7/1/2007'),
('00174160','7/1/2007'),
('00174161','7/1/2007'),
('00174162','7/1/2007'),
('00174163','10/1/2014'),
('00174164','10/1/2014'),
('00174165','7/1/2007'),
('00174166','7/1/2007'),
('00174167','7/1/2007'),
('00174168','7/1/2007'),
('00174169','7/1/2007'),
('00174170','7/1/2007'),
('00174171','7/1/2007'),
('00174172','12/6/2017'),
('00174173','12/6/2017'),
('00174174','8/17/2013'),
('00174175','7/1/2007'),
('00174176','8/19/2013'),
('00174178','7/1/2007'),
('00174179','3/16/2017'),
('00174180','12/6/2017'),
('00174181','7/1/2007'),
('00174182','12/8/2017'),
('00174184','7/1/2007'),
('00174185','12/6/2007'),
('00174186','7/1/2007'),
('00174187','10/1/2014'),
('00174189','12/6/2017'),
('00174190','3/1/2017'),
('00174191','7/1/2007'),
('00174192','10/1/2014'),
('00174193','12/6/2017'),
('00174194','7/1/2007'),
('00174195','12/6/2017'),
('00174196','12/6/2017'),
('00174197','10/1/2014'),
('00174198','12/28/2018'),
('00174199','7/1/2007'),
('00174602','7/6/2019'),
('00180007','5/9/2018'),
('00182206','7/29/2015'),
('00182210','7/20/2016'),
('10182209','6/20/2009'),
('10182220','7/18/2014'),
('10182226','3/19/2007'),
('10182243','9/29/2015'),
('10182244','2/2/2009'),
('10182256','6/9/2006'),
('10182258','3/4/2015'),
('10182299','1/15/2015'),
('20182214','12/4/2010'),
('20182265','3/6/2008'),
('20182270','8/12/2008'),
('20182288','12/8/2009'),
('20182290','11/4/2009'),
('30182203','11/22/2015'),
('30182205','2/12/2013'),
('30182209','6/10/2011'),
('30182211','1/14/2014'),
('30182218','11/28/2011'),
('30182220','6/12/2007'),
('30182224','5/27/2010'),
('30182233','12/16/2013'),
('30182234','5/2/2016'),
('30182238','3/6/2010'),
('30182250','11/4/2013'),
('30182266','8/26/2009'),
('30182277','1/12/2010'),
('30182278','7/11/2014'),
('30182280','9/14/2009'),
('30182282','2/10/2011'),
('30182283','11/14/2017'),
('40182201','5/22/2012'),
('40182207','6/11/2007'),
('00182242','9/15/2009'),
('40182222','1/17/2011'),
('40182225','7/23/2014'),
('40182231','5/19/2014'),
('40182236','6/14/2016'),
('40182241','3/28/2017'),
('40182244','9/27/2017'),
('40182245','5/8/2017'),
('00182259','2/24/2015'),
('00182260','2/3/2014'),
('00182263','6/8/2010'),
('00182288','6/2/2012'),
('00182295','1/15/2015'),
('20174183','3/1/2015'),
('30174125','1/1/2018'),
('02128600','8/16/2019'),
('01034502','12/14/2013'),
('30182201','4/20/2011'),
('30182243','11/14/2017'),
('40182210','3/11/2013'),
('00306818','5/12/2017'),
('00231830','6/30/2014'),
('20383734','5/15/2016'),
('02168601','6/22/2018'),
('00110805','5/3/2018'),
('00266403','5/11/2017'),
('00318104','8/1/2016'),
('00318126','5/10/2016'),
('00318135','8/1/2016'),
('00318142','12/22/2016'),
('00318143','8/31/2012'),
('00318145','8/31/2012'),
('00318146','5/11/2013'),
('00318147','8/31/2012'),
('00318149','8/31/2012'),
('00318151','8/31/2012'),
('00318156','5/10/2016'),
('00318157','8/31/2012'),
('00318158','8/31/2012'),
('00318160','8/31/2012'),
('00318161','8/31/2012'),
('00318162','8/1/2016'),
('00318163','8/31/2012'),
('00318164','8/31/2012'),
('00318165','5/10/2016'),
('00318166','8/1/2016'),
('00318169','8/31/2012'),
('00318170','8/31/2012'),
('00318171','8/31/2012'),
('00318172','8/31/2012'),
('00318173','8/31/2012'),
('00318175','8/31/2012'),
('00318178','5/15/2015'),
('00318179','5/10/2014'),
('00318181','8/31/2019'),
('00318182','8/31/2012'),
('00318183','5/10/2016'),
('00318184','5/10/2016'),
('00318185','5/10/2016'),
('00318186','12/22/2015'),
('00318187','8/31/2012'),
('00318188','8/31/2012'),
('00318189','8/1/2016'),
('00318190','8/31/2012'),
('00318191','5/10/2016'),
('00354915','7/31/2019'),
('00361405','4/5/2007'),
('00361406','8/13/2004'),
('00361408','5/18/2018'),
('82098825','7/24/2019'),
('00255504','12/17/2016'),
('20174182','6/1/2018'),
('40182235','2/13/2014'),
('03034505','7/1/2019'),
('04236300','9/1/2019'),
('00299213','8/31/2013'),
('00299218','8/31/2014'),
('01151907','7/31/2019'),
('42098867','6/10/2019'),
('00467322','5/30/2018'),
('00225102','8/15/2019'),
('20174181','3/1/2015'),
('30174103','3/1/2016'),
('00231812','6/6/2019'),
('32098879','7/16/2019'),
('00299207','5/31/2016'),
('00299214','8/31/2013'),
('00299215','12/31/2012'),
('00299206','5/17/2013'),
('00299211','5/31/2007'),
('00266405','6/28/2016'),
('72098839','6/18/2019'),
('00318144','8/31/2012'),
('00361405','4/5/2007')
;

--select * from @SchoolCodes



/**** UNH 23008 query **/

--SELECT DISTINCT
--	LN10.BF_SSN,
--	LN10.LN_SEQ,
--	LN10.LF_DOE_SCL_ORG
--FROM
--	LN10_LON LN10
--WHERE
--	LN10.LF_DOE_SCL_ORG IN (SELECT SchoolCode FROM @SchoolCodes)
--;


/*****************  MODIFIED QUERY  ***********************/
SELECT
	*
FROM
	(
		SELECT DISTINCT
			PD10.DF_SPE_ACC_ID,
			PD10.DM_PRS_1,
			PD10.DM_PRS_MID,
			PD10.DM_PRS_LST,
			PD30.DX_STR_ADR_1,
			PD30.DX_STR_ADR_2,
			PD30.DX_STR_ADR_3,
			PD30.DM_CT,
			PD30.DC_DOM_ST,
			PD30.DF_ZIP_CDE,
			PD30.DI_VLD_ADR,
			LN10.LF_DOE_SCL_ORG,
			SD10.LF_DOE_SCL_ENR_CUR,
			SD10.LC_REA_SCL_SPR,
			SD10.LD_NTF_SCL_SPR,
			SD10.LD_SCL_SPR [LastDayOfEnrollment],
			School.SchoolCloseDate
			--,SUM(LN10.LA_CUR_PRI) OVER(PARTITION BY LN10.BF_SSN) AS sum_LA_CUR_PRI
			--,SUM(LN10.LA_LON_AMT_GTR) OVER(PARTITION BY LN10.BF_SSN) AS sum_LA_LON_AMT_GTR
		FROM
			PD10_PRS_NME PD10
			INNER JOIN PD30_PRS_ADR PD30 
				ON PD30.DF_PRS_ID = PD10.DF_PRS_ID
			INNER JOIN 
			(
				SELECT
					LN10.BF_SSN,
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN LN10_LON LN10 
						ON LN10.LF_DOE_SCL_ORG = SC.SchoolCode

				UNION ALL

				SELECT DISTINCT
					SD10.LF_STU_SSN [BF_SSN],
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN SD10_STU_SPR SD10 
						ON SD10.LF_DOE_SCL_ENR_CUR = SC.SchoolCode
				WHERE
					SD10.LC_STA_STU10 = 'A'
			) School 
				ON School.BF_SSN = PD10.DF_PRS_ID
			INNER JOIN LN10_LON LN10 
				ON LN10.BF_SSN = PD10.DF_PRS_ID
			LEFT JOIN SD10_STU_SPR SD10 
				ON SD10.LF_STU_SSN = PD10.DF_PRS_ID 
				AND SD10.LF_DOE_SCL_ENR_CUR = School.SchoolCode 
				AND SD10.LC_STA_STU10 = 'A'
		WHERE
			DATEADD(DAY, 121, SD10.LD_SCL_SPR) > School.SchoolCloseDate
			--AND LN10.LA_CUR_PRI > 0.00
			--AND LN10.LA_LON_AMT_GTR > 0.00
	) X
WHERE
	DATEADD(DAY, 121, ISNULL(X.LastDayOfEnrollment, GETDATE())) > X.SchoolCloseDate
	AND	(
			X.LF_DOE_SCL_ENR_CUR IN (SELECT SchoolCode FROM @SchoolCodes)
			OR	X.LF_DOE_SCL_ORG IN (SELECT SchoolCode FROM @SchoolCodes)
		)
ORDER BY
	X.DF_SPE_ACC_ID
;

