--SELECT * INTO #HAS FROM OPENQUERY
--	(LEGEND,
--	'
--		SELECT DISTINCT
--			LNXX.BF_SSN
--		FROM
--			PKUB.LNXX_LON_CRB_RPT LNXX
--		WHERE
--			LC_RPT_STA_CRB IN (''XX'')
--			AND LD_RPT_CRB BETWEEN ''XX/XX/XXXX'' AND ''XX/XX/XXXX''
--			AND LC_SPC_CMT = ''AW''
--	'
--	) 

--SELECT * INTO #HASNOT FROM OPENQUERY
--	(LEGEND,
--	'
--		SELECT DISTINCT
--			LNXX.BF_SSN
--		FROM
--			PKUB.LNXX_LON_CRB_RPT LNXX
--		WHERE
--		LC_RPT_STA_CRB  not IN (''XX'')
--			 and LD_RPT_CRB BETWEEN ''XX/XX/XXXX'' AND ''XX/XX/XXXX''
--			AND LC_SPC_CMT = ''AW''
--	'
--	) 

SELECT 
	COUNT(DISTINCT H.BF_SSN) 
FROM 
	#HAS H
	INNER JOIN 
	(
	SELECT 
			LNXX.BF_SSN
		FROM
			CDW..FBXX_BR_FOR_REQ FBXX
			INNER JOIN CDW..LNXX_BR_FOR_APV LNXX
				ON LNXX.BF_SSN = FBXX.BF_SSN
				AND LNXX.LF_FOR_CTL_NUM = FBXX.LF_FOR_CTL_NUM
			INNER JOIN CDW..LNXX_LON LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
				AND LNXX.LA_CUR_PRI > X
				AND LNXX.LC_STA_LONXX = 'R'
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND FBXX.LC_STA_FORXX = 'A'
			AND FBXX.LC_FOR_STA = 'A' --denied records cant have this active
			AND LNXX.LC_FOR_RSP != 'XXX'
			AND FBXX.LC_FOR_TYP = 'XX'
			AND LNXX.LD_FOR_BEG < 'XX/XX/XXXX'
			AND LNXX.LD_FOR_END > 'XX/XX/XXXX'
	) F
		ON F.BF_SSN = H.BF_SSN

SELECT 
	COUNT(DISTINCT H.BF_SSN)
FROM 
	#HASNOT H
	INNER JOIN 
	(
	SELECT 
			LNXX.BF_SSN
		FROM
			CDW..FBXX_BR_FOR_REQ FBXX
			INNER JOIN CDW..LNXX_BR_FOR_APV LNXX
				ON LNXX.BF_SSN = FBXX.BF_SSN
				AND LNXX.LF_FOR_CTL_NUM = FBXX.LF_FOR_CTL_NUM
			INNER JOIN CDW..LNXX_LON LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
				AND LNXX.LA_CUR_PRI > X
				AND LNXX.LC_STA_LONXX = 'R'
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND FBXX.LC_STA_FORXX = 'A'
			AND FBXX.LC_FOR_STA = 'A' --denied records cant have this active
			AND LNXX.LC_FOR_RSP != 'XXX'
			AND FBXX.LC_FOR_TYP = 'XX'
			AND LNXX.LD_FOR_BEG < 'XX/XX/XXXX'
			AND LNXX.LD_FOR_END > 'XX/XX/XXXX'
	) F
		ON F.BF_SSN = H.BF_SSN