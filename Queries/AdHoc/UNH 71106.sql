USE UDW
GO

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @SchoolCodes TABLE
(
	SchoolCode CHAR(8),
	SchoolCloseDate DATE
);

INSERT INTO
	@SchoolCodes
VALUES
--OPE ID	Closure Date
('00822105','7/17/2020'),
('00273413','5/5/2020'),
('04166000','6/20/2020'),
('00394104','5/30/2020'),
('02587510','12/31/2019'),
('00394114','12/31/2020'),
('00394113','12/31/2020'),
('02587512','12/31/2020'),
('01171917','12/31/2020'),
('00327723','3/13/2020'),
('00152602','5/3/2020'),
('00152607','5/3/2020'),
('00152610','5/3/2020'),
('00152612','5/3/2020'),
('00152621','5/3/2020'),
('00152622','5/3/2020'),
('00152629','5/3/2020'),
('00152656','8/23/2020'),
('00152687','8/23/2020'),
('03026510','1/29/2021'),
('00152620','5/3/2020'),
('00152626','5/3/2020'),
('00152635','5/3/2020'),
('00152673','8/23/2020'),
('00158008','6/30/2015'),
('00158023','6/15/2016'),
('00152625','5/3/2020'),
('00152642','8/23/2020'),
('10184300','11/14/2020'),
('00239715','12/5/2020'),
('00295701','5/31/2016'),
('00152638','8/23/2020'),
('00152654','8/23/2020'),
('02317303','2/26/2021'),
('00189223','1/1/2015'),
('00184202','7/1/2017'),
('00180575','3/13/2021'),
('02514100','3/26/2021'),
('00314405','8/31/2020'),
('02581205','12/22/2016'),
('02581200','12/22/2016'),
('02581201','12/22/2016'),
('02581202','12/22/2016'),
('02581203','12/22/2016'),
('02581206','12/22/2016'),
('01201537','5/17/2020'),
('01201549','5/17/2020'),
('02581204','12/22/2016'),
('00189220','12/21/2020'),
('00189225','12/31/2015'),
('00189226','1/1/2019'),
('00248220','5/6/2018'),
('00239713','12/5/2020'),
('00535108','12/31/2020'),
('00469207','12/23/2020'),
('00346602','12/13/2017'),
('00346603','5/6/2016'),
('00346605','5/6/2016'),
('02491500','11/30/2020'),
('00753102','8/15/2018'),
('03980301','3/17/2018'),
('03980304','3/17/2018'),
('02091200','2/20/2020'),
('03422309','2/25/2021'),
('01014930','8/8/2018'),
('10184303','12/31/2019'),
('00189215','6/30/2010'),
('03067207','11/30/2019'),
('00152639','8/23/2020'),
('02581205','12/22/2016'),
('02581206','12/22/2016'),
('02581202','12/22/2016'),
('02581201','12/22/2016'),
('02581200','12/22/2016'),
('02581203','12/22/2016'),
('02581204','12/22/2016'),
('02491500','11/30/2020')

--select * from @SchoolCodes

/*****************  MODIFIED QUERY  ***********************/
SELECT
	*
FROM
	(
		SELECT DISTINCT
			PD10.DF_SPE_ACC_ID,
			PD10.DM_PRS_1,
			PD10.DM_PRS_MID,
			PD10.DM_PRS_LST,
			PD30.DX_STR_ADR_1,
			PD30.DX_STR_ADR_2,
			PD30.DX_STR_ADR_3,
			PD30.DM_CT,
			PD30.DC_DOM_ST,
			PD30.DF_ZIP_CDE,
			PD30.DI_VLD_ADR,
			LN10.LF_DOE_SCL_ORG,
			SD10.LF_DOE_SCL_ENR_CUR,
			SD10.LD_NTF_SCL_SPR,
			SD10.LC_REA_SCL_SPR,
			SD10.LD_SCL_SPR [LastDayOfEnrollment],
			School.SchoolCloseDate
		FROM
			PD10_PRS_NME PD10
			INNER JOIN PD30_PRS_ADR PD30 
				ON PD30.DF_PRS_ID = PD10.DF_PRS_ID
			INNER JOIN 
			(
				SELECT
					LN10.BF_SSN,
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN LN10_LON LN10 
						ON LN10.LF_DOE_SCL_ORG = SC.SchoolCode

				UNION

				SELECT DISTINCT
					SD10.LF_STU_SSN [BF_SSN],
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN SD10_STU_SPR SD10 
						ON SD10.LF_DOE_SCL_ENR_CUR = SC.SchoolCode
				WHERE
					SD10.LC_STA_STU10 = 'A'
			) School 
				ON School.BF_SSN = PD10.DF_PRS_ID
			INNER JOIN LN10_LON LN10 
				ON LN10.BF_SSN = PD10.DF_PRS_ID
			LEFT JOIN SD10_STU_SPR SD10 
				ON SD10.LF_STU_SSN = PD10.DF_PRS_ID 
				AND SD10.LF_DOE_SCL_ENR_CUR = School.SchoolCode 
				AND SD10.LC_STA_STU10 = 'A'
		WHERE
		--	DATEADD(DAY, 121, SD10.LD_SCL_SPR) > School.SchoolCloseDate
			 LN10.LA_CUR_PRI > 0.00
			AND LN10.LA_LON_AMT_GTR > 0.00
	) X
WHERE
	DATEADD(DAY, 121, ISNULL(X.LastDayOfEnrollment, GETDATE())) > X.SchoolCloseDate
	AND	(
			X.LF_DOE_SCL_ENR_CUR IN (SELECT SchoolCode FROM @SchoolCodes)
			OR	X.LF_DOE_SCL_ORG IN (SELECT SchoolCode FROM @SchoolCodes)
		)
ORDER BY
	X.DF_SPE_ACC_ID

 