/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;

PROC IMPORT DATAFILE="T:\HP 28783 Loan Sale - FIXED.CSV"
	OUT=XLSOURCE
	DBMS=CSV
	REPLACE;
	GETNAMES=YES;
RUN;

DATA XLSOURCE (DROP=BF_SSN);
	SET XLSOURCE;
	SSN=PUT(BF_SSN,Z9.);
RUN;
	
LIBNAME  DUSTER  REMOTE  SERVER=DUSTER  SLIBREF=WORK; 

DATA DUSTER.XLSOURCE; *Send data to Duster;
	SET XLSOURCE;
RUN;

RSUBMIT;

%LET DB = DLGSUTWH; 
LIBNAME OLWHRM1 DB2 DATABASE=&DB OWNER=OLWHRM1;

PROC SQL;
CREATE TABLE R2_FIXED AS
	SELECT DISTINCT 
		LN10.BF_SSN				AS SSN
		,PD10.DF_SPE_ACC_ID		AS ACCT
		,LN10.LN_SEQ			AS LOAN
		,LN10.LD_LON_EFF_ADD	AS PCV_DECON
		,LN10.LD_LON_ACL_ADD	AS CONVERTED	
		,LN72.LR_ITR
		,LN72.LD_ITR_EFF_BEG
		,LN72.LC_ITR_TYP
		,LN10.LD_FAT_PRI_BAL_ZRO 
		,LN90.LD_FAT_EFF
		,LN83.LC_STA_LN83
		,LN83.BC_EFT_STA
		,LN83.BC_EFT_DNL_REA
	FROM
		OLWHRM1.LN10_LON LN10
		INNER JOIN XLSOURCE XL
			ON LN10.BF_SSN = XL.SSN
			AND LN10.LN_SEQ = XL.LN_SEQ
		INNER JOIN OLWHRM1.PD10_PRS_NME PD10
			ON LN10.BF_SSN = PD10.DF_PRS_ID
		INNER JOIN 
			(
				SELECT DISTINCT 
					A.BF_SSN
					,A.LN_SEQ
					,A.LR_ITR
					,A.LC_ITR_TYP
					,B.LD_ITR_EFF_BEG
				FROM
					OLWHRM1.LN72_INT_RTE_HST A
				INNER JOIN
					(
						SELECT DISTINCT
							BF_SSN
							,LN_SEQ
							,MAX(LD_ITR_EFF_BEG) AS LD_ITR_EFF_BEG
						FROM
							OLWHRM1.LN72_INT_RTE_HST
						WHERE 
							LC_STA_LON72 = 'A'
							AND LC_ITR_TYP NOT IN ('C1', 'C2', 'F2', 'SV')
							AND LD_ITR_EFF_BEG < MDY(09,06,2016)
						GROUP BY
							BF_SSN
							,LN_SEQ
					) B
					ON A.BF_SSN = B.BF_SSN
					AND A.LN_SEQ = B.LN_SEQ
					AND A.LD_ITR_EFF_BEG = B.LD_ITR_EFF_BEG
				WHERE 
					LC_STA_LON72 = 'A'
			) LN72
			ON LN10.BF_SSN = LN72.BF_SSN
			AND LN10.LN_SEQ = LN72.LN_SEQ
		LEFT JOIN
			(
				SELECT DISTINCT
					 LN90A.BF_SSN
					,LN90A.LN_SEQ
					,MAX(LN90A.LD_FAT_EFF) AS LD_FAT_EFF
				FROM 
					OLWHRM1.LN90_FIN_ATY LN90A
				WHERE
					LN90A.LC_STA_LON90 = 'A'
					AND LN90A.LC_FAT_REV_REA = ''
					AND LN90A.PC_FAT_TYP = '03'
					AND LN90A.LD_FAT_APL BETWEEN MDY(09,05,2016) AND MDY(09,14,2016)
				GROUP BY
					 LN90A.BF_SSN
					,LN90A.LN_SEQ
			)LN90
			ON LN10.BF_SSN = LN90.BF_SSN
			AND LN10.LN_SEQ = LN90.LN_SEQ
		INNER JOIN
			(
				SELECT DISTINCT
					LN83.BF_SSN
					,LN83.LN_SEQ
					,LN83.LC_STA_LN83
					,BR30.BC_EFT_STA
					,BR30.BC_EFT_DNL_REA
				FROM
					OLWHRM1.LN83_EFT_TO_LON LN83
					INNER JOIN OLWHRM1.BR30_BR_EFT BR30
						ON LN83.BF_SSN = BR30.BF_SSN
						AND LN83.BN_EFT_SEQ = BR30.BN_EFT_SEQ
				WHERE
					LN83.LC_STA_LN83 = 'A'
					AND BR30.BC_EFT_STA = 'A'
					AND BR30.BC_EFT_DNL_REA = ''
/*					AND BR30.BC_EFT_DNL_REA IS NULL*/
			)LN83
			ON LN10.BF_SSN = LN83.BF_SSN
			AND LN10.LN_SEQ = LN83.LN_SEQ
	;

CREATE TABLE R3_VARIABLE AS
	SELECT DISTINCT 
		LN10.BF_SSN				AS SSN
		,PD10.DF_SPE_ACC_ID		AS ACCT
		,LN10.LN_SEQ			AS LOAN
		,LN10.LD_LON_EFF_ADD	AS PCV_DECON
		,LN10.LD_LON_ACL_ADD	AS CONVERTED	
		,LN72.LR_ITR
		,LN72.LD_ITR_EFF_BEG
		,LN72.LC_ITR_TYP
		,LN10.LD_FAT_PRI_BAL_ZRO 
		,LN90.LD_FAT_EFF
		,LN83.LC_STA_LN83
		,LN83.BC_EFT_STA
		,LN83.BC_EFT_DNL_REA
	FROM
		OLWHRM1.LN10_LON LN10
		INNER JOIN XLSOURCE XL
			ON LN10.BF_SSN = XL.SSN
			AND LN10.LN_SEQ = XL.LN_SEQ
		INNER JOIN OLWHRM1.PD10_PRS_NME PD10
			ON LN10.BF_SSN = PD10.DF_PRS_ID
		INNER JOIN 
			(
				SELECT DISTINCT 
					A.BF_SSN
					,A.LN_SEQ
					,A.LR_ITR
					,A.LC_ITR_TYP
					,B.LD_ITR_EFF_BEG
				FROM
					OLWHRM1.LN72_INT_RTE_HST A
				INNER JOIN
					(
						SELECT DISTINCT
							BF_SSN
							,LN_SEQ
							,MAX(LD_ITR_EFF_BEG) AS LD_ITR_EFF_BEG
						FROM
							OLWHRM1.LN72_INT_RTE_HST
						WHERE 
							LC_STA_LON72 = 'A'
							AND LC_ITR_TYP IN ('C1', 'C2', 'F2', 'SV')
							AND LD_ITR_EFF_BEG < MDY(07,01,2016)
						GROUP BY
							BF_SSN
							,LN_SEQ
					) B
					ON A.BF_SSN = B.BF_SSN
					AND A.LN_SEQ = B.LN_SEQ
					AND A.LD_ITR_EFF_BEG = B.LD_ITR_EFF_BEG
				WHERE 
					LC_STA_LON72 = 'A'  
			) LN72
			ON LN10.BF_SSN = LN72.BF_SSN
			AND LN10.LN_SEQ = LN72.LN_SEQ
		LEFT JOIN
			(
				SELECT DISTINCT
					 LN90A.BF_SSN
					,LN90A.LN_SEQ
					,MAX(LN90A.LD_FAT_EFF) AS LD_FAT_EFF
				FROM 
					OLWHRM1.LN90_FIN_ATY LN90A
				WHERE
					LN90A.LC_STA_LON90 = 'A'
					AND LN90A.LC_FAT_REV_REA = ''
					AND LN90A.PC_FAT_TYP = '03'
					AND LN90A.LD_FAT_APL BETWEEN MDY(09,05,2016) AND MDY(09,14,2016)
				GROUP BY
					 LN90A.BF_SSN
					,LN90A.LN_SEQ
			)LN90
			ON LN10.BF_SSN = LN90.BF_SSN
			AND LN10.LN_SEQ = LN90.LN_SEQ
		INNER JOIN
			(
				SELECT DISTINCT
					LN83.BF_SSN
					,LN83.LN_SEQ
					,LN83.LC_STA_LN83
					,BR30.BC_EFT_STA
					,BR30.BC_EFT_DNL_REA
				FROM
					OLWHRM1.LN83_EFT_TO_LON LN83
					INNER JOIN OLWHRM1.BR30_BR_EFT BR30
						ON LN83.BF_SSN = BR30.BF_SSN
						AND LN83.BN_EFT_SEQ = BR30.BN_EFT_SEQ
				WHERE
					LN83.LC_STA_LN83 = 'A'
					AND BR30.BC_EFT_STA = 'A'
					AND BR30.BC_EFT_DNL_REA = ''
/*					AND BR30.BC_EFT_DNL_REA IS NULL*/
			)LN83
			ON LN10.BF_SSN = LN83.BF_SSN
			AND LN10.LN_SEQ = LN83.LN_SEQ
	;

CREATE TABLE R4_VARIABLE AS
	SELECT DISTINCT 
		LN10.BF_SSN				AS SSN
		,PD10.DF_SPE_ACC_ID		AS ACCT
		,LN10.LN_SEQ			AS LOAN
		,LN10.LD_LON_EFF_ADD	AS PCV_DECON
		,LN10.LD_LON_ACL_ADD	AS CONVERTED	
		,LN72.LR_ITR
		,LN72.LD_ITR_EFF_BEG
		,LN72.LC_ITR_TYP
		,LN10.LD_FAT_PRI_BAL_ZRO 
		,LN90.LD_FAT_EFF
		,LN83.LC_STA_LN83
		,LN83.BC_EFT_STA
		,LN83.BC_EFT_DNL_REA
	FROM
		OLWHRM1.LN10_LON LN10
		INNER JOIN XLSOURCE XL
			ON LN10.BF_SSN = XL.SSN
			AND LN10.LN_SEQ = XL.LN_SEQ
		INNER JOIN OLWHRM1.PD10_PRS_NME PD10
			ON LN10.BF_SSN = PD10.DF_PRS_ID
		INNER JOIN 
			(
				SELECT DISTINCT 
					A.BF_SSN
					,A.LN_SEQ
					,A.LR_ITR
					,A.LC_ITR_TYP
					,B.LD_ITR_EFF_BEG
				FROM
					OLWHRM1.LN72_INT_RTE_HST A
				INNER JOIN
					(
						SELECT DISTINCT
							BF_SSN
							,LN_SEQ
							,MAX(LD_ITR_EFF_BEG) AS LD_ITR_EFF_BEG
						FROM
							OLWHRM1.LN72_INT_RTE_HST
						WHERE 
							LC_STA_LON72 = 'A'
							AND LC_ITR_TYP IN ('C1', 'C2', 'F2', 'SV')
							AND LD_ITR_EFF_BEG < MDY(09,06,2016)
						GROUP BY
							BF_SSN
							,LN_SEQ
					) B
					ON A.BF_SSN = B.BF_SSN
					AND A.LN_SEQ = B.LN_SEQ
					AND A.LD_ITR_EFF_BEG = B.LD_ITR_EFF_BEG
				WHERE 
					LC_STA_LON72 = 'A'  
			) LN72
			ON LN10.BF_SSN = LN72.BF_SSN
			AND LN10.LN_SEQ = LN72.LN_SEQ
		LEFT JOIN
			(
				SELECT DISTINCT
					 LN90A.BF_SSN
					,LN90A.LN_SEQ
					,MAX(LN90A.LD_FAT_EFF) AS LD_FAT_EFF
				FROM 
					OLWHRM1.LN90_FIN_ATY LN90A
				WHERE
					LN90A.LC_STA_LON90 = 'A'
					AND LN90A.LC_FAT_REV_REA = ''
					AND LN90A.PC_FAT_TYP = '03'
   					AND LN90A.LD_FAT_APL BETWEEN MDY(09,05,2016) AND MDY(09,14,2016)
				GROUP BY
					BF_SSN
					,LN_SEQ
			)LN90
			ON LN10.BF_SSN = LN90.BF_SSN
			AND LN10.LN_SEQ = LN90.LN_SEQ
		INNER JOIN
			(
				SELECT DISTINCT
					LN83.BF_SSN
					,LN83.LN_SEQ
					,LN83.LC_STA_LN83
					,BR30.BC_EFT_STA
					,BR30.BC_EFT_DNL_REA
				FROM
					OLWHRM1.LN83_EFT_TO_LON LN83
					INNER JOIN OLWHRM1.BR30_BR_EFT BR30
						ON LN83.BF_SSN = BR30.BF_SSN
						AND LN83.BN_EFT_SEQ = BR30.BN_EFT_SEQ
				WHERE
					LN83.LC_STA_LN83 = 'A'
					AND BR30.BC_EFT_STA = 'A'
					AND BR30.BC_EFT_DNL_REA = ''
/*					AND BR30.BC_EFT_DNL_REA IS NULL*/
			)LN83
			ON LN10.BF_SSN = LN83.BF_SSN
			AND LN10.LN_SEQ = LN83.LN_SEQ
	;
QUIT;

ENDRSUBMIT;

DATA R2_FIXED;
	SET DUSTER.R2_FIXED;
	OWNER = 82976901;
	ACH_RIR = 0.25;
	NEW_RATE = LR_ITR - ACH_RIR;
	IF LD_FAT_PRI_BAL_ZRO = . 
		THEN LD_FAT_PRI_BAL_ZRO = MDY(01,01,1582);
	IF LD_FAT_PRI_BAL_ZRO < LD_FAT_EFF
		THEN ACH_ADD = LD_FAT_PRI_BAL_ZRO;
	IF ACH_ADD = MDY(01,01,1582)
		THEN ACH_ADD = LD_FAT_EFF;
	IF LD_FAT_PRI_BAL_ZRO = MDY(01,01,1582)
		THEN LD_FAT_PRI_BAL_ZRO = .;
	FORMAT ACH_ADD DATE9.;
RUN;
DATA R3_VARIABLE;
	SET DUSTER.R3_VARIABLE;
	OWNER = 82976901;
	ACH_RIR = 0.25;
	NEW_RATE = LR_ITR - ACH_RIR;
	IF LD_FAT_PRI_BAL_ZRO = . 
		THEN LD_FAT_PRI_BAL_ZRO = MDY(01,01,1582);
	IF LD_FAT_PRI_BAL_ZRO < LD_FAT_EFF
		THEN ACH_ADD = LD_FAT_PRI_BAL_ZRO;
	IF ACH_ADD = MDY(01,01,1582)
		THEN ACH_ADD = LD_FAT_EFF;
	IF LD_FAT_PRI_BAL_ZRO = MDY(01,01,1582)
		THEN LD_FAT_PRI_BAL_ZRO = .;
	FORMAT ACH_ADD DATE9.;
RUN;
DATA R4_VARIABLE;
	SET DUSTER.R4_VARIABLE;
	OWNER = 82976901;
	ACH_RIR = 0.25;
	NEW_RATE = LR_ITR - ACH_RIR;
	IF LD_FAT_PRI_BAL_ZRO = . 
		THEN LD_FAT_PRI_BAL_ZRO = MDY(01,01,1582);
	IF LD_FAT_PRI_BAL_ZRO < LD_FAT_EFF
		THEN ACH_ADD = LD_FAT_PRI_BAL_ZRO;
	IF ACH_ADD = MDY(01,01,1582)
		THEN ACH_ADD = LD_FAT_EFF;
	IF LD_FAT_PRI_BAL_ZRO = MDY(01,01,1582)
		THEN LD_FAT_PRI_BAL_ZRO = .;
	FORMAT ACH_ADD DATE9.;
RUN;

PROC EXPORT
		DATA=R2_FIXED
		OUTFILE="&RPTLIB\UNH 28467.xlsx"
		REPLACE;
RUN;
PROC EXPORT
		DATA=R3_VARIABLE
		OUTFILE="&RPTLIB\UNH 28467.xlsx"
		REPLACE;
RUN;
PROC EXPORT
		DATA=R4_VARIABLE
		OUTFILE="&RPTLIB\UNH 28467.xlsx"
		REPLACE;
RUN;
