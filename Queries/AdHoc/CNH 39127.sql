DECLARE @Table TABLE(CaseDate DATETIME, [Name] VARCHAR(XXX), SSN CHAR(XX), AwardId VARCHAR(XX), DisbursementDate DATE, DisbursedAmount VARCHAR(XX), ForbStatus VARCHAR(XX), DischargeStatus VARCHAR(XX), InterestCreditStatus VARCHAR(XX), RefundStatus VARCHAR(XX), CaseNumber VARCHAR(XX))
INSERT INTO @Table

VALUES('X/XX/XXXX X:XX','Giovanni Mendez','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/XX/XXXX','XXXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','Giovanni Mendez','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/XX/XXXX','XXXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','SHAUNTAY WASHINGTON','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/X/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','SHAUNTAY WASHINGTON','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','XX/X/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','SHAUNTAY WASHINGTON','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','XX/X/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','SHAUNTAY WASHINGTON','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/XX/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','SHAUNTAY WASHINGTON','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','XX/X/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','SHAUNTAY WASHINGTON','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','XX/X/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','SHAUNTAY WASHINGTON','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','XX/X/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','SHAUNTAY WASHINGTON','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','XX/X/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','SHAUNTAY WASHINGTON','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/X/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','SHAUNTAY WASHINGTON','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/XX/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/X/XXXX X:XX','KANDACE HOLSTEIN','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/X/XXXX','XXXX','Issue','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/X/XXXX X:XX','KANDACE HOLSTEIN','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/X/XXXX','XXXX','Issue','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','Melissa Anderson','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/X/XXXX','XXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','Melissa Anderson','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/X/XXXX','XXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('XX/X/XXXX X:XX','Phatima Lee','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/XX/XXXX','XXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('XX/X/XXXX X:XX','Phatima Lee','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/XX/XXXX','XXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('XX/X/XXXX X:XX','Erica Unzueta','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/XX/XXXX','XXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('XX/X/XXXX X:XX','Erica Unzueta','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/XX/XXXX','XXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('XX/X/XXXX X:XX','Erica Unzueta','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/XX/XXXX','XXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('XX/X/XXXX X:XX','Erica Unzueta','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/XX/XXXX','XXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('XX/XX/XXXX XX:XX','Jonathan Rogers','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/XX/XXXX','XXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('XX/XX/XXXX XX:XX','Jonathan Rogers','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/XX/XXXX','XXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','MAAYA ROBINSON','XXX-XX-XXXX','XXXXXXXXXSXXEXXXXXXXX','X/XX/XXXX','XXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','MAAYA ROBINSON','XXX-XX-XXXX','XXXXXXXXXUXXEXXXXXXXX','X/XX/XXXX','XXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','Angela Lozano','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/XX/XXXX','XXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','Angela Lozano','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/XX/XXXX','XXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/X/XXXX X:XX','Amanda Coffer','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','XX/XX/XXXX','XXXX','Issue','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/X/XXXX X:XX','Amanda Coffer','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','XX/XX/XXXX','XXXX','Issue','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','DESSERY MOLINA','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/X/XXXX','XXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','DESSERY MOLINA','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/X/XXXX','XXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','Jennifer Wootten','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/XX/XXXX','XXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','Jennifer Wootten','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/XX/XXXX','XXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','Leticia Ramirez','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/X/XXXX','XXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/X/XXXX X:XX','Rayda Anthony','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/X/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/X/XXXX X:XX','Rayda Anthony','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/X/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/X/XXXX X:XX','Rayda Anthony','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/X/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/X/XXXX X:XX','Rayda Anthony','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/X/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/X/XXXX X:XX','Rayda Anthony','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/XX/XXXX','XXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/X/XXXX X:XX','Rayda Anthony','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/XX/XXXX','XXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/X/XXXX X:XX','Stephanie Lascola (Coker)','XXX-XX-XXXX','XXXXXXXXXPXXGXXXXXXXX','X/XX/XXXX','XXXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/X/XXXX X:XX','Stephanie Lascola (Coker)','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/XX/XXXX','XXXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','Carlene Walker','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/XX/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','Carlene Walker','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/XX/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','Carlene Walker','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/X/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','Carlene Walker','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/X/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','Carlene Walker','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/X/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','Carlene Walker','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/X/XXXX','XXXX','Not Requested','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/X/XXXX X:XX','Violeta Nieves','XXX-XX-XXXX','XXXXXXXXXSXXGXXXXXXXX','X/XX/XXXX','XXXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/X/XXXX X:XX','Violeta Nieves','XXX-XX-XXXX','XXXXXXXXXUXXGXXXXXXXX','X/XX/XXXX','XXXXX','Start Forb. Complete','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','Alma Molina','XXX-XX-XXXX','XXXXXXXXXUXXEXXXXXXXX','X/XX/XXXX','XXXX','Issue','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','Alma Molina','XXX-XX-XXXX','XXXXXXXXXSXXEXXXXXXXX','X/XX/XXXX','XXXX','Issue','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','Alma Molina','XXX-XX-XXXX','XXXXXXXXXSXXEXXXXXXXX','X/XX/XXXX','XXXX','Issue','Not Requested','Not Requested','Not Requested','XXXXXXXX'),
('X/XX/XXXX X:XX','Alma Molina','XXX-XX-XXXX','XXXXXXXXXUXXEXXXXXXXX','X/XX/XXXX','XXX','Issue','Not Requested','Not Requested','Not Requested','XXXXXXXX')


SELECT DISTINCT
	T.*,
	RTRIM(PDXX.DM_PRS_X) AS [Borrower First Name], 
	RTRIM(PDXX.DM_PRS_LST) AS [Borrower Last Name],
	PDXX.DF_PRS_ID AS [Borrower SSN],
	CAST(PDXX.DD_BRT AS DATE) AS [Borrower DOB],
	'XXXXXX' AS [Servicer/GA Code],
	'Cornerstone' AS [Servicer/GA Name],
	T.AwardId AS [Award ID],
	LNXX.LF_DOE_SCL_ORG AS [OPE ID],
	CASE WHEN LNXX.IC_LON_PGM IN ('DLPLUS') THEN 'Yes' ELSE 'No' END AS [Parent PLUS Loan (Yes/No)],
	FT.Label + 
		CASE WHEN PFT.Label IS NOT NULL AND FT.Label = 'PAID IN FULL' AND ISNULL(LNXX.LC_WOF_WUP_REA,'') = '' THEN ' - ' + PFT.Label 
			 WHEN PFT.Label IS NOT NULL AND FT.Label = 'PAID IN FULL' AND ISNULL(LNXX.LC_WOF_WUP_REA,'') != '' THEN ' - ' + WOF.PX_DSC_EX_LNG
		ELSE '' END AS [Current Loan Status],
	CASE WHEN CAST(Forb.LD_FOR_END AS DATE) >= 'XXXX-XX-XX' THEN CAST(CAST(DATEADD(DAY, X,Forb.LD_FOR_END) AS DATE) AS VARCHAR) ELSE '' END AS [Did the borrower received a forbearance end notice since May XX, XXXX],
	CASE WHEN CAST(Forb.LD_FOR_END AS DATE) >= 'XXXX-XX-XX' THEN CAST(CAST(Forb.LD_FOR_BEG AS DATE) AS VARCHAR) ELSE '' END AS [Forbearance (Stopped Collection Activity) Start Date],
	CASE WHEN CAST(Forb.LD_FOR_END AS DATE) >= 'XXXX-XX-XX' THEN CAST(CAST(Forb.LD_FOR_END AS DATE) AS VARCHAR) ELSE '' END AS [Forbearance (Stopped Collection Activity) End Date],
	CASE WHEN Bill.BF_SSN IS NOT NULL THEN 'Yes' ELSE 'No' END AS [Did the borrower receive a payment due notice since May XX, XXXX],
	CASE WHEN Payment.BF_SSN IS NOT NULL THEN 'Yes' ELSE 'No' END AS [Did the borrower make a payment(s)],
	CASE WHEN LNXX.BF_SSN IS NOT NULL THEN 'Yes' ELSE 'No' END AS [Did the borrower go into a delinquent or default status since May XX, XXXX],
	CASE WHEN LNXX.BF_SSN IS NOT NULL AND (CAST(Forb.LD_FOR_END AS DATE) >= 'XXXX-XX-XX' OR Bill.BF_SSN IS NOT NULL) THEN 'Yes' ELSE 'No' END AS [Did the borrower go into a delinquent or default status since May XX, XXXX if received a forbearance end or payment due notice],
	CASE WHEN LNXX.LN_DLQ_MAX >= XX THEN 'Yes' ELSE 'No' END AS [Did the borrower deliquency or default reported to one or many credit agencies? (Date Reported to Credit Agency)], --TODO: date
	CASE WHEN ForbAfter.BF_SSN IS NOT NULL THEN 'Yes' ELSE 'No' END AS [Forbearance or stopped collection activity status after receipt of a forbearance end notice and/or payment due notice?], --TODO: reentered forb
	CASE WHEN OptOut.BF_SSN IS NOT NULL AND RCBDF.BF_SSN IS NOT NULL THEN 'Yes' ELSE 'No' END AS [Borrower Voluntarily Opted Out of Forbearance or Stopped Collection Activity]
FROM 
	@Table T 
	INNER JOIN CDW..FSXX_DL_LON FSXX 
		ON FSXX.BF_SSN = REPLACE(T.SSN,'-','') 
		AND (FSXX.LF_FED_AWD + RIGHT('XXX' + CAST(FSXX.LN_FED_AWD_SEQ AS VARCHAR), X)) = T.AwardId
	INNER JOIN CDW..DWXX_DW_CLC_CLU DWXX
		ON DWXX.BF_SSN = FSXX.BF_SSN
		AND DWXX.LN_SEQ = FSXX.LN_SEQ
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = DWXX.BF_SSN
		AND LNXX.LN_SEQ = DWXX.LN_SEQ
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = DWXX.BF_SSN
	INNER JOIN CDW..FormatTranslation FT
		ON FT.FmtName = '$LONSTA'
		AND FT.[Start] = DWXX.WC_DW_LON_STA
	LEFT JOIN CDW.calc.RepaymentSchedules RS
		ON RS.BF_SSN = FSXX.BF_SSN
		AND RS.LN_SEQ = FSXX.LN_SEQ
		AND RS.CurrentGradation = X
		--AND RS.LA_RPS_ISL = X
	LEFT JOIN OPENQUERY
	(
		legend,
		'SELECT 
			*
		FROM 
			pkub.LKXX_LS_CDE_LKP
		WHERE
			PM_ATR like ''LC_WOF_WUP_REA%''
		'
	) WOF
		ON WOF.PX_ATR_VAL = LNXX.LC_WOF_WUP_REA
	LEFT JOIN CDW..LNXX_LON_DLQ_HST LNXX
		ON LNXX.BF_SSN = FSXX.BF_SSN
		AND LNXX.LN_SEQ = FSXX.LN_SEQ
		AND LNXX.LD_DLQ_OCC >= 'XXXX-XX-XX'
	LEFT JOIN 
	(
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			FBXX.LC_FOR_TYP,
			FT.Label,
			LNXX.LD_FOR_BEG,
			LNXX.LD_FOR_END
		FROM
			@Table T 
			INNER JOIN CDW..FSXX_DL_LON FSXX 
				ON FSXX.BF_SSN = REPLACE(T.SSN,'-','') 
				AND (FSXX.LF_FED_AWD + RIGHT('XXX' + CAST(FSXX.LN_FED_AWD_SEQ AS VARCHAR), X)) = T.AwardId
			INNER JOIN CDW..LNXX_BR_FOR_APV LNXX
				ON LNXX.BF_SSN = FSXX.BF_SSN
				AND LNXX.LN_SEQ = FSXX.LN_SEQ
				AND LNXX.LC_FOR_RSP != 'XXX'
				AND LNXX.LC_STA_LONXX = 'A'
				AND CAST(LNXX.LD_FOR_BEG AS DATE) >= 'XXXX-XX-XX'
			INNER JOIN CDW..FBXX_BR_FOR_REQ FBXX
				ON FBXX.BF_SSN = LNXX.BF_SSN
				AND FBXX.LF_FOR_CTL_NUM = LNXX.LF_FOR_CTL_NUM
				AND FBXX.LC_FOR_STA = 'A'
				AND FBXX.LC_STA_FORXX = 'A'
				AND FBXX.LC_FOR_TYP = 'XX'
			INNER JOIN CDW..FormatTranslation FT
				ON FT.FmtName = '$FORSTA'
				AND FT.[Start] = FBXX.LC_FOR_TYP		
	) Forb
		ON Forb.BF_SSN = FSXX.BF_SSN
		AND Forb.LN_SEQ = FSXX.LN_SEQ
	LEFT JOIN
	(
		SELECT DISTINCT
			Arcs.BF_SSN,
			Arcs.LN_SEQ,
			MAX(Arcs.LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
		FROM
			@Table T 
			INNER JOIN CDW..FSXX_DL_LON FSXX 
				ON FSXX.BF_SSN = REPLACE(T.SSN,'-','') 
				AND (FSXX.LF_FED_AWD + RIGHT('XXX' + CAST(FSXX.LN_FED_AWD_SEQ AS VARCHAR), X)) = T.AwardId
			INNER JOIN 
			(
				SELECT DISTINCT
					LNXX.BF_SSN,
					LNXX.LN_SEQ,
					AYXX.LD_ATY_REQ_RCV
				FROM
					CDW..AYXX_BR_LON_ATY AYXX
					INNER JOIN CDW..LNXX_LON_ATY LNXX
						ON LNXX.BF_SSN = AYXX.BF_SSN
						AND LNXX.LN_ATY_SEQ = AYXX.LN_ATY_SEQ
				WHERE
					AYXX.PF_REQ_ACT = 'BILLS'
					AND AYXX.LC_STA_ACTYXX = 'A'
					AND CAST(AYXX.LD_ATY_REQ_RCV AS DATE) >= 'XXXX-XX-XX'
			) Arcs
				ON Arcs.BF_SSN = FSXX.BF_SSN
				AND Arcs.LN_SEQ = FSXX.LN_SEQ 	
		GROUP BY
			Arcs.BF_SSN,
			Arcs.LN_SEQ			
	) Bill
		ON Bill.BF_SSN = FSXX.BF_SSN
		AND Bill.LN_SEQ = FSXX.LN_SEQ
	LEFT JOIN 
	(
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			FBXX.LC_FOR_TYP,
			FT.Label,
			LNXX.LD_FOR_BEG,
			LNXX.LD_FOR_END
		FROM
			@Table T 
			INNER JOIN CDW..FSXX_DL_LON FSXX 
				ON FSXX.BF_SSN = REPLACE(T.SSN,'-','') 
				AND (FSXX.LF_FED_AWD + RIGHT('XXX' + CAST(FSXX.LN_FED_AWD_SEQ AS VARCHAR), X)) = T.AwardId
			INNER JOIN CDW..LNXX_BR_FOR_APV LNXX
				ON LNXX.BF_SSN = FSXX.BF_SSN
				AND LNXX.LN_SEQ = FSXX.LN_SEQ
				AND LNXX.LC_FOR_RSP != 'XXX'
				AND LNXX.LC_STA_LONXX = 'A'
				AND CAST(LNXX.LD_FOR_BEG AS DATE) >= 'XXXX-XX-XX'
			INNER JOIN CDW..FBXX_BR_FOR_REQ FBXX
				ON FBXX.BF_SSN = LNXX.BF_SSN
				AND FBXX.LF_FOR_CTL_NUM = LNXX.LF_FOR_CTL_NUM
				AND FBXX.LC_FOR_STA = 'A'
				AND FBXX.LC_STA_FORXX = 'A'
				AND FBXX.LC_FOR_TYP = 'XX'
			INNER JOIN CDW..FormatTranslation FT
				ON FT.FmtName = '$FORSTA'
				AND FT.[Start] = FBXX.LC_FOR_TYP		
	) ForbAfter
		ON ForbAfter.BF_SSN = FSXX.BF_SSN
		AND ForbAfter.LN_SEQ = FSXX.LN_SEQ
		AND 
		(
			ForbAfter.LD_FOR_BEG > Forb.LD_FOR_BEG
			OR ForbAfter.LD_FOR_BEG > Bill.LD_ATY_REQ_RCV
		)
	LEFT JOIN
	(
		SELECT DISTINCT
			LNXX.BF_SSN,
			LNXX.LN_SEQ
		FROM
			@Table T 
			INNER JOIN CDW..FSXX_DL_LON FSXX 
				ON FSXX.BF_SSN = REPLACE(T.SSN,'-','') 
				AND (FSXX.LF_FED_AWD + RIGHT('XXX' + CAST(FSXX.LN_FED_AWD_SEQ AS VARCHAR), X)) = T.AwardId 
			INNER JOIN 
			(
				SELECT DISTINCT
					LNXX.BF_SSN,
					LNXX.LN_SEQ
				FROM
					CDW..AYXX_BR_LON_ATY AYXX
					INNER JOIN CDW..LNXX_LON_ATY LNXX
						ON LNXX.BF_SSN = AYXX.BF_SSN
						AND LNXX.LN_ATY_SEQ = AYXX.LN_ATY_SEQ
				WHERE
					AYXX.PF_REQ_ACT = 'BDDNY'
					AND AYXX.LC_STA_ACTYXX = 'A'
			) LNXX
				ON LNXX.BF_SSN = FSXX.BF_SSN
				AND LNXX.LN_SEQ = FSXX.LN_SEQ
	) OptOut
		ON OptOut.BF_SSN = FSXX.BF_SSN
		AND OptOut.LN_SEQ = FSXX.LN_SEQ
	LEFT JOIN
	(
		SELECT DISTINCT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			LNXX.PC_FAT_TYP,
			LNXX.PC_FAT_SUB_TYP
		FROM
			@Table T 
			INNER JOIN CDW..FSXX_DL_LON FSXX 
				ON FSXX.BF_SSN = REPLACE(T.SSN,'-','') 
				AND (FSXX.LF_FED_AWD + RIGHT('XXX' + CAST(FSXX.LN_FED_AWD_SEQ AS VARCHAR), X)) = T.AwardId
			INNER JOIN CDW..LNXX_FIN_ATY LNXX
				ON LNXX.BF_SSN = FSXX.BF_SSN
				AND LNXX.LN_SEQ = FSXX.LN_SEQ
				AND LNXX.LC_STA_LONXX = 'A'
				AND ISNULL(LNXX.LC_FAT_REV_REA,'') = ''
				AND LNXX.PC_FAT_TYP = 'XX'
		WHERE
			LNXX.LD_FAT_EFF >= 'XXXX-XX-XX'
	) Payment
		ON Payment.BF_SSN = FSXX.BF_SSN
		AND Payment.LN_SEQ = FSXX.LN_SEQ
	LEFT JOIN CDW..FormatTranslation PFT
		ON PFT.FmtName = '$FATRAN'
		AND PFT.[Start] = Payment.PC_FAT_TYP + Payment.PC_FAT_SUB_TYP
	LEFT JOIN
	(
		SELECT DISTINCT
			LNXX.BF_SSN,
			LNXX.LN_SEQ
		FROM
			CDW..AYXX_BR_LON_ATY AYXX
			INNER JOIN CDW..LNXX_LON_ATY LNXX
				ON LNXX.BF_SSN = AYXX.BF_SSN
				AND LNXX.LN_ATY_SEQ = AYXX.LN_ATY_SEQ
		WHERE
			AYXX.PF_REQ_ACT = 'RCBDF'
			AND AYXX.LC_STA_ACTYXX = 'A'
	) RCBDF
		ON RCBDF.BF_SSN = FSXX.BF_SSN
		AND RCBDF.LN_SEQ = FSXX.LN_SEQ
--WHERE
--	CAST(T.CaseDate AS DATE) >= 'XXXX-XX-XX'