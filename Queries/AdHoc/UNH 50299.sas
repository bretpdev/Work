PROC IMPORT OUT= WORK.ERRORS
            DATAFILE= "T:\borrowers_with_error_02789_01-09-17_02.42.57.xlsx" 
            DBMS=EXCEL REPLACE;
     RANGE="borrowers_with_error_02789_01-0$"; 
     GETNAMES=YES;
     MIXED=NO;
     SCANTEXT=YES;
     USEDATE=YES;
     SCANTIME=YES;
RUN;

PROC IMPORT OUT= WORK.RPS
            DATAFILE= "T:\Wave 4 - NPD & Terms 01.17.17 v5.xlsx" 
            DBMS=EXCEL REPLACE;
     RANGE="RS10_Change$"; 
     GETNAMES=YES;
     MIXED=NO;
     SCANTEXT=YES;
     USEDATE=YES;
     SCANTIME=YES;
RUN;



/*TEST*/
/*LIBNAME  DUSTER  REMOTE  SERVER=QADBD004 SLIBREF=WORK  ;*/

/*LIVE*/
LIBNAME  DUSTER  REMOTE  SERVER=DUSTER  SLIBREF=WORK;

DATA DUSTER.ERRORS; *Send data to Duster;
SET ERRORS;
RUN;

DATA DUSTER.RPS; *Send data to Duster;
SET RPS;
RUN;

RSUBMIT;  

/*%let DB = DLGSWQUT;  *This is test;*/
%let DB = DLGSUTWH;  *This is live;

LIBNAME OLWHRM1 DB2 DATABASE=&DB OWNER=OLWHRM1;
PROC SQL;
	CREATE TABLE RESULT AS
		SELECT DISTINCT
			E.SSN AS BF_SSN,
			RS10.LN_RPS_SEQ AS LN_RPS_SEQ,
			RS10.LD_SNT_RPD_DIS AS OLD_LD_SNT_RPD_DIS  format=MMDDYY10.,
			CASE
				WHEN R.BF_SSN IS NOT NULL THEN R.NEW_LD_RPS_1_PAY_DU - 45
				ELSE RS10.LD_RPS_1_PAY_DU - 45
			END AS NEW_LD_SNT_RPD_DIS format=MMDDYY10.
		FROM
			ERRORS E
			LEFT JOIN RPS R
				ON R.BF_SSN = E.SSN
			LEFT JOIN OLWHRM1.RS10_BR_RPD RS10
				ON RS10.BF_SSN = E.SSN
				AND RS10.LC_STA_RPST10 = 'A'
		
;

	CREATE TABLE RS10_DUMP AS 
		SELECT DISTINCT
			RS10.*
		FROM
			OLWHRM1.RS10_BR_RPD RS10
			INNER JOIN ERRORS E
				ON E.SSN = RS10.BF_SSN

;
			
QUIT;
ENDRSUBMIT;


DATA RS10_DUMP;
SET DUSTER.RS10_DUMP;
RUN;

DATA RESULT;
SET DUSTER.RESULT;
RUN;

PROC EXPORT DATA = WORK.RESULT 
            OUTFILE = "T:\UNH 50299.xlsx" 
            DBMS = EXCEL
			REPLACE;
     SHEET="Sheet1"; 
RUN;

PROC EXPORT DATA = WORK.RS10_DUMP 
            OUTFILE = "T:\RS10_DUMP.xlsx" 
            DBMS = EXCEL
			REPLACE;
     SHEET="RS10_DUMP"; 
RUN;
