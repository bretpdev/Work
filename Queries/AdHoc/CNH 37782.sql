SELECT
	D.WF_QUE,
	D.WF_SUB_QUE,
	D.WN_CTL_TSK,
	D.PF_REQ_ACT
FROM
(
	SELECT DISTINCT
		WQXX.BF_SSN,
		WQXX.WF_QUE,
		WQXX.WF_SUB_QUE,
		WQXX.WN_CTL_TSK,
		WQXX.PF_REQ_ACT,
		WQXX.WF_CRT_DTS_WQXX,
		SUM(COALESCE(LNXX.LA_CUR_PRI,X.XX) + COALESCE(DWXX.WA_TOT_BRI_OTS,X.XX)) OVER(PARTITION BY LNXX.BF_SSN) AS Balance
	FROM
		CDW..WQXX_TSK_QUE WQXX
		INNER JOIN CDW..LNXX_LON LNXX
			ON LNXX.BF_SSN = WQXX.BF_SSN
		INNER JOIN CDW..DWXX_DW_CLC_CLU DWXX
			ON DWXX.BF_SSN = LNXX.BF_SSN
			AND DWXX.LN_SEQ = LNXX.LN_SEQ
	WHERE
		WQXX.WF_QUE = 'DP'
) D
LEFT JOIN CDW..PDXX_PRS_ADR PDXX
	ON PDXX.DF_PRS_ID = D.BF_SSN
	AND CAST(PDXX.DF_LST_DTS_PDXX AS DATE) >= CAST(D.WF_CRT_DTS_WQXX AS DATE)
WHERE
	D.Balance = X.XX
	OR
	(
		D.Balance > X.XX
		AND PDXX.DF_PRS_ID IS NOT NULL
	)
