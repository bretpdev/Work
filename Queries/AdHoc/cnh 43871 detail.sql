select
	--MONTH(BILL_SENT_DATE) AS [MONTH],
	--YEAR(BILL_SENT_DATE) AS [YEAR],
	--[reason],
	--COUNT(DISTINCT AccountNumber) AS BWR_COUNT 
	*
from
(
SELECT distinct
	PP.AccountNumber,
	pd10.df_prs_id,
	OPT_OUTB.LD_ATY_REQ_RCV,
	PP.AddedAt AS BILL_SENT_DATE,
	pp.scriptfileid,
	MAX(CASE 
		WHEN OPT_OUTB.BF_SSN IS NOT NULL AND OPT_OUTB.LD_ATY_REQ_RCV < PP.AddedAt THEN 'OPT OUT' 
		WHEN OPT_OUTE.BF_SSN IS NOT NULL AND OPT_OUTE.LD_ATY_REQ_RCV < PP.AddedAt THEN 'OPT OUT' 
		WHEN SAME_DAY.BF_SSN IS NOT NULL AND SAME_DAY.LD_ATY_REQ_RCV = CAST(PP.AddedAt AS DATE) THEN 'BILL SENT SAME DAY FORB APPLIED'
		WHEN HAD_REMOVED.BF_SSN IS NOT NULL AND HAD_REMOVED.LD_ATY_REQ_RCV < PP.AddedAt THEN 'OPT OUT'
		WHEN HAD_REMOVEDE.BF_SSN IS NOT NULL AND HAD_REMOVEDE.LD_ATY_REQ_RCV < PP.AddedAt THEN 'OPT OUT'
		WHEN PP.AccountNumber = '5209699179' AND pp.AddedAt = '2020-09-28 04:47:38.797' then 'New Repayment'
	END) OVER(PARTITION BY PP.AccountNumber, pp.AddedAt) as reason
FROM 
	CLS.[billing].PrintProcessing PP
	INNER JOIN CDW..PD10_PRS_NME PD10
		ON PD10.DF_SPE_ACC_ID = PP.AccountNumber
	LEFT JOIN
	(
		SELECT DISTINCT 
			AY10.BF_SSN,
			MIN(AY10.LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
		FROM 
			CDW..AY10_BR_LON_ATY AY10
		WHERE
			PF_REQ_ACT = 'CVDOO'
			AND LC_STA_ACTY10 = 'A'
		GROUP BY
			AY10.BF_SSN
	) OPT_OUTB
		ON OPT_OUTB.BF_SSN = PD10.DF_PRS_ID
	LEFT JOIN
	(
		SELECT DISTINCT 
			LN20.LF_EDS AS BF_SSN,
			AY10.LD_ATY_REQ_RCV
		FROM 
			CDW..AY10_BR_LON_ATY AY10
			INNER JOIN CDW..LN20_EDS LN20
				ON LN20.BF_SSN = AY10.BF_SSN
		WHERE
			PF_REQ_ACT = 'CVDOO'
			AND LC_STA_ACTY10 = 'A'
	) OPT_OUTE
		ON OPT_OUTE.BF_SSN = PD10.DF_PRS_ID
	LEFT JOIN
	(
		SELECT DISTINCT 
			AY10.BF_SSN,
			AY10.LD_ATY_REQ_RCV
		FROM 
			CDW..AY10_BR_LON_ATY AY10
		WHERE
			PF_REQ_ACT = 'COVNT'
			AND LC_STA_ACTY10 = 'A'
	) SAME_DAY
		ON SAME_DAY.BF_SSN = PD10.DF_PRS_ID
	LEFT JOIN
	(
		SELECT DISTINCT 
			AY10.BF_SSN,
			AY10.LD_ATY_REQ_RCV
		FROM 
			CDW..AY10_BR_LON_ATY AY10
		WHERE
			PF_REQ_ACT = 'P438A'
			AND LC_STA_ACTY10 = 'A'
			AND AY10.LD_ATY_REQ_RCV > '03/15/2020'
	) HAD_REMOVED
		ON HAD_REMOVED.BF_SSN = PD10.DF_PRS_ID
	LEFT JOIN
	(
		SELECT DISTINCT 
			LN20.LF_EDS AS BF_SSN,
			AY10.LD_ATY_REQ_RCV
		FROM 
			CDW..AY10_BR_LON_ATY AY10
			INNER JOIN CDW..LN20_EDS LN20
				ON LN20.BF_SSN = AY10.BF_SSN
		WHERE
			PF_REQ_ACT = 'P438A'
			AND LC_STA_ACTY10 = 'A'
			AND AY10.LD_ATY_REQ_RCV > '03/15/2020'
	) HAD_REMOVEDE
		ON HAD_REMOVEDE.BF_SSN = PD10.DF_PRS_ID
WHERE 
	PP.AddedAt >= '04/01/2020'
	AND PP.DeletedAt IS NULL
	and pp.scriptfileid not in (4,13) 
)p
WHERE P.REASON IS NULL
--group by
--	MONTH(BILL_SENT_DATE) ,
--	YEAR(BILL_SENT_DATE) ,
--	[reason] 