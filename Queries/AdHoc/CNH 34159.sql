USE CDW
GO

SELECT DISTINCT
	 DFXX.BF_SSN
	,PDXX.DF_SPE_ACC_ID  
	,(LTRIM(RTRIM(PDXX.DM_PRS_LST)) + ', ' + LTRIM(RTRIM(PDXX.DM_PRS_X))) [NAME]
	,LNXX.LD_DFR_APL
	,LNXX.LD_DFR_BEG
	,LNXX.LD_DFR_END
	,CAST(DFXX.LD_CRT_REQ_DFR AS DATE) AS DateDefermentCreated
	,CAST(AYXX.LD_ATY_REQ_RCV AS DATE) AS DIDFRdate
FROM
	LNXX_LON LNXX
	INNER JOIN LNXX_BR_DFR_APV LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN DFXX_BR_DFR_REQ DFXX
		ON DFXX.BF_SSN = LNXX.BF_SSN
		AND DFXX.LF_DFR_CTL_NUM = LNXX.LF_DFR_CTL_NUM
	INNER JOIN PDXX_PRS_NME PDXX
		ON DFXX.BF_SSN = PDXX.DF_PRS_ID
	LEFT JOIN
	(
		SELECT
			BF_SSN,
			MAX(LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
		FROM
			CDW..AYXX_BR_LON_ATY
		WHERE
			PF_REQ_ACT IN ('DIDFR')
			AND
			LD_ATY_REQ_RCV <= 'XXXX-XX-XX'
		GROUP BY
			BF_SSN

	) AYXX
		ON AYXX.BF_SSN = PDXX.DF_PRS_ID
WHERE
	LNXX.LC_STA_LONXX = 'A'
	AND DFXX.LC_DFR_TYP = 'XX'
	AND	DFXX.LC_DFR_STA = 'A'
	AND DFXX.LC_STA_DFRXX = 'A'
	AND CAST(LNXX.LD_DFR_APL AS DATE) BETWEEN 'XXXX-XX-XX' AND 'XXXX-XX-XX'
ORDER BY
	LNXX.LD_DFR_APL
