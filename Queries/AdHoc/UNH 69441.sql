USE UDW
GO

SELECT DISTINCT
	PD10.DF_SPE_ACC_ID AS [ACCOUNT_NUMBER],
	LTRIM(RTRIM(PD10.DM_PRS_1)) + ' ' + LTRIM(RTRIM(PD10.DM_PRS_LST)) AS [NAME],
	LN50.LD_DFR_BEG AS DEFERMENT_BEGIN,
	LN50.LD_DFR_END AS DEFERMENT_END,
	ISNULL(CONVERT(VARCHAR(10), MAX(AY10.LD_ATY_REQ_RCV) OVER (PARTITION BY AY10.BF_SSN), 101),'') AS APP_RECEIVE_DATE,
	LN50.LD_DFR_APL AS DEFERMENT_APPLIED_DATE,
	SUM(LN10.LA_CUR_PRI) OVER (PARTITION BY LN10.BF_SSN) AS BALANCE,
	df10.lf_usr_crt_req_dfr as [Processing Agent]
FROM
	UDW..DF10_BR_DFR_REQ DF10
	INNER JOIN UDW..LN50_BR_DFR_APV LN50
		ON LN50.BF_SSN = DF10.BF_SSN
		AND LN50.LF_DFR_CTL_NUM = DF10.LF_DFR_CTL_NUM
	INNER JOIN UDW..LN10_LON LN10
		ON LN10.BF_SSN = LN50.BF_SSN
		AND LN10.LN_SEQ = LN50.LN_SEQ
	INNER JOIN PD10_PRS_NME PD10
		ON PD10.DF_PRS_ID = LN10.BF_SSN
	LEFT JOIN UDW..AY10_BR_LON_ATY AY10
		ON AY10.BF_SSN = DF10.BF_SSN
		AND AY10.PF_REQ_ACT = 'LS700'
		AND DATEDIFF(MONTH, AY10.LD_ATY_REQ_RCV, 	LN50.LD_DFR_APL) BETWEEN -1 AND 2

WHERE
	DF10.LC_DFR_TYP = '29'
	AND LN50.LD_DFR_APL BETWEEN '01/01/2020' AND CAST(GETDATE() AS DATE)

	and ln10.ic_lon_pgm != 'TILP'
