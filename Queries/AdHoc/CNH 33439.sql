--RUN ON UHEAASQLDB
USE CDW
GO

BEGIN TRANSACTION
	DECLARE @ERROR INT = X
	DECLARE @ROWCOUNT INT = X
	DECLARE @ExpectedRowCount INT = XX

UPDATE 
	LTXX
SET
	LTXX.PrintedAt = NULL
--select *
FROM
(
	SELECT DISTINCT 
		LTXX.*,
		DAY(RSXX.LD_RPS_X_PAY_DU) AS dueDay,
		MAX(LNXX.LD_FAT_EFF) OVER(PARTITION BY LTXX.RF_SBJ_PRC) AS MaxPayment
	FROM 
		CDW..LTXX_LetterRequests LTXX
		LEFT JOIN CDW..RSXX_BR_RPD RSXX
			ON LTXX.RF_SBJ_PRC = RSXX.BF_SSN
			AND RSXX.LC_STA_RPSTXX = 'A'
		LEFT JOIN CDW..LNXX_FIN_ATY LNXX
			ON LNXX.BF_SSN = LTXX.RF_SBJ_PRC
			AND LNXX.PC_FAT_TYP = 'XX'
			AND LNXX.PC_FAT_SUB_TYP = 'XX'
			AND LNXX.LC_STA_LONXX = 'A'
			AND LNXX.LC_FAT_REV_REA = ''
	WHERE 
		LTXX.RM_DSC_LTR_PRC = 'TSXXBFNBIL' 
		AND LTXX.PrintedAt <= 'XXXX-XX-XX XX:XX:XX.XXX' 
		AND LTXX.RT_RUN_SRT_DTS_PRC > 'XXXX-XX-XX' 
) Letters
	INNER JOIN CDW..LTXX_LetterRequests LTXX
		ON LTXX.DF_SPE_ACC_ID = Letters.DF_SPE_ACC_ID
		AND LTXX.PrintedAt IS NOT NULL
		AND LTXX.RT_RUN_SRT_DTS_PRC > 'XXXX-XX-XX' 
		AND LTXX.RM_DSC_LTR_PRC = 'TSXXBFNBIL'
	
	-- Save/Set the row count and error number (if any) from the previously executed statement
	SELECT @ROWCOUNT = @@ROWCOUNT, @ERROR = @@ERROR

IF @ROWCOUNT = @ExpectedRowCount AND @ERROR = X
	BEGIN
		PRINT 'Transaction committed'
		COMMIT TRANSACTION
		--ROLLBACK TRANSACTION
	END
ELSE
	BEGIN
		PRINT 'ROWCOUNT:  ' + CAST(@ROWCOUNT as VARCHAR(XX))
		PRINT 'ERROR:  ' + CAST(@ERROR as VARCHAR(XX))
		PRINT 'Transaction NOT committed'
		ROLLBACK TRANSACTION
	END
