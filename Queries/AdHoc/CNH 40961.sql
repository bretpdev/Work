--Find loans that have an active XX-Post Enrollment Deferment on a DLPLUS or DLPLGB loan disbursed prior to X/X/XXXX.
--Output: 
--Account Number PDXX.DF_SPE_ACC_ID
--Loan Sequence LNXX.LN_SEQ
USE CDW;
GO

SELECT DISTINCT
	PDXX.DF_SPE_ACC_ID
	,LNXX.LN_SEQ
	--VALIDATION FIELDS:
	,LNXX.IC_LON_PGM
	,LNXX.LC_STA_LONXX
	,LNXX.LC_DFR_RSP
	,IIF(LNXX.LA_CUR_PRI > X.XX, '>X',NULL) AS 'CUR_BAL'
	,LNXX.LC_STA_LONXX
	,LNXX.LD_LON_X_DSB
	,DFXX.LC_DFR_TYP
	,DFXX.LC_DFR_STA
	,DFXX.LC_STA_DFRXX
FROM
	LNXX_LON LNXX
	INNER JOIN PDXX_PRS_NME PDXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
	INNER JOIN LNXX_BR_DFR_APV LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN DFXX_BR_DFR_REQ DFXX
		ON LNXX.BF_SSN = DFXX.BF_SSN
		AND LNXX.LF_DFR_CTL_NUM = DFXX.LF_DFR_CTL_NUM
WHERE
	LNXX.IC_LON_PGM IN ('DLPLUS','DLPLGB')
	AND LNXX.LC_STA_LONXX = 'A'
	--AND LNXX.LC_DFR_RSP != 'XXX' --DENIED
	AND LNXX.LA_CUR_PRI > X.XX
	--AND LNXX.LC_STA_LONXX = 'R'
	AND LNXX.LD_LON_X_DSB < CONVERT(DATE,'XXXXXXXX')--before X/X/XXXX
	AND DFXX.LC_DFR_TYP = 'XX'
	AND DFXX.LC_DFR_STA = 'A'
	--AND DFXX.LC_STA_DFRXX = 'A'
ORDER BY 
	LNXX.LD_LON_X_DSB

