USE UDW;
GO

DECLARE @LDATE DATE = CONVERT(DATE, '20190305');

;WITH L AS
(--get most recent active L schedule
	SELECT
		BF_SSN
		,LN_SEQ
		,MAX(LN_RPS_SEQ) AS max_l_LN_RPS_SEQ
	FROM
		LN65_LON_RPS
	WHERE
		LC_TYP_SCH_DIS = 'L'
		AND LC_STA_LON65 = 'A'
	GROUP BY 
		BF_SSN
		,LN_SEQ
)
,IB AS
(--get IB history
	SELECT
		BF_SSN
		,LN_SEQ
		,LN_RPS_SEQ AS ib_LN_RPS_SEQ
	FROM
		LN65_LON_RPS
	WHERE
		LC_TYP_SCH_DIS = 'IB'
		AND LC_STA_LON65 = 'I'	
)
SELECT
	L.*,
	IB.ib_LN_RPS_SEQ
FROM
	L
	INNER JOIN IB
		ON IB.BF_SSN = L.BF_SSN
		AND IB.LN_SEQ = L.LN_SEQ
	LEFT JOIN 
	(--not in defer after L date
		SELECT
			LN50.BF_SSN
			,LN50.LN_SEQ
		FROM
			LN50_BR_DFR_APV LN50
			INNER JOIN DF10_BR_DFR_REQ DF10
				ON LN50.BF_SSN = DF10.BF_SSN
				AND LN50.LF_DFR_CTL_NUM = DF10.LF_DFR_CTL_NUM
		WHERE
			DF10.LC_DFR_STA = 'A'
			AND DF10.LC_STA_DFR10 = 'A'
			AND LN50.LC_STA_LON50 = 'A'
			AND LN50.LD_DFR_BEG >= @LDATE
	) DEFER
		ON L.BF_SSN = DEFER.BF_SSN
		AND L.LN_SEQ = DEFER.LN_SEQ
	LEFT JOIN 
	(--not in forb after L date
		SELECT
			LN60.BF_SSN
			,LN60.LN_SEQ
		FROM
			LN60_BR_FOR_APV LN60
			INNER JOIN FB10_BR_FOR_REQ FB10
				ON LN60.BF_SSN = FB10.BF_SSN
				AND LN60.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM
		WHERE
			FB10.LC_FOR_STA = 'A'
			AND FB10.LC_STA_FOR10 = 'A'
			AND LN60.LC_STA_LON60 = 'A'
			AND LN60.LD_FOR_BEG >= @LDATE
	) FORB
		ON L.BF_SSN = FORB.BF_SSN
		AND L.LN_SEQ = FORB.LN_SEQ
WHERE
	DEFER.BF_SSN IS NULL
	AND FORB.BF_SSN IS NULL
	AND	L.max_l_LN_RPS_SEQ = IB.ib_LN_RPS_SEQ + 1 --compare highest L schedule to see if brwr had IB immediately before
ORDER BY
	 L.BF_SSN
	,L.LN_SEQ
;