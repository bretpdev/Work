USE CDW
GO
-- 
-- CNH XXXXX
-- 

	SELECT DISTINCT
--		PDXX.DF_SPE_ACC_ID [ACCT], 'XX/XX/XXXX' [BEGIN DATE], 'XX/XX/XXXX' [END DATE]	--	Script File.
		PDXX.DF_SPE_ACC_ID											[ACCOUNT NUMBER],
		PDXX.DM_PRS_X												[FIRST NAME], 
		PDXX.DM_PRS_LST												[LAST NAME],
		COALESCE(PHXX.DX_CNC_EML_ADR, PDXX.ALT_EM )					[EMAIL ADDRESS]				
	FROM
				   LNXX_LON	           LNXX
		INNER JOIN DWXX_DW_CLC_CLU	   DWXX ON DWXX.BF_SSN = LNXX.BF_SSN AND DWXX.LN_SEQ = LNXX.LN_SEQ
		INNER JOIN FBXX_BR_FOR_REQ     FBXX ON FBXX.BF_SSN = LNXX.BF_SSN
--		INNER JOIN LNXX_LON_DLQ_HST    LNXX ON LNXX.BF_SSN = LNXX.BF_SSN AND LNXX.LN_SEQ = LNXX.LN_SEQ
		INNER JOIN PDXX_PRS_NME        PDXX ON PDXX.DF_PRS_ID = LNXX.BF_SSN
		INNER JOIN PDXX_PRS_ADR        PDXX ON PDXX.DF_PRS_ID = LNXX.BF_SSN
		INNER JOIN calc.RepaymentSchedules Calc ON Calc.BF_SSN = PDXX.DF_PRS_ID
		LEFT JOIN  PHXX_CNC_EML        PHXX ON PHXX.DF_SPE_ID = PDXX.DF_SPE_ACC_ID
		LEFT JOIN
		( -- email address 
			SELECT 
				DF_PRS_ID, EMail.EM [ALT_EM],
 				ROW_NUMBER() OVER (PARTITION BY Email.DF_PRS_ID ORDER BY Email.PriorityNumber) [EmailPriority] -- number in order of Email.PriorityNumber 
 			FROM 
 			( 
 				SELECT 
 					PDXX.DF_PRS_ID, PDXX.DI_VLD_ADR_EML,
 					PDXX.DX_ADR_EML [EM], 
 					CASE	  
 						WHEN DC_ADR_EML = 'H' THEN X -- home 
 						WHEN DC_ADR_EML = 'A' THEN X -- alternate 
 						WHEN DC_ADR_EML = 'W' THEN X -- work 
 					END AS PriorityNumber
 				FROM 
 					UDW..PDXX_PRS_ADR_EML PDXX 
 				WHERE 
 					PDXX.DI_VLD_ADR_EML = 'Y' -- valid email address 
 					AND PDXX.DC_STA_PDXX = 'A' -- active email address record 

 			) EMail 
		) PDXX ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
				AND PDXX.EmailPriority = X
	WHERE 
			LNXX.LC_STA_LONXX = 'R'				-- Released
--		AND	(
--			LNXX.LN_DLQ_MAX > X AND LNXX.LC_STA_LONXX = 'X'		-- Active, delinquent
--			)
		AND 
			DWXX.WC_DW_LON_STA NOT IN ('XX','XX','XX','XX')			-- In repayment
		AND NOT 
		(
			FBXX.LC_FOR_TYP = XX AND FBXX.LD_FOR_REQ_BEG = CONVERT(datetime, 'XX/XX/XXXX', XXX)
		)
		AND 
			(PHXX. DI_VLD_CNC_EML_ADR = 'Y' OR PDXX.DF_PRS_ID IS NOT NULL )
		AND 
			(Calc.LA_RPS_ISL > X.X AND Calc.CurrentGradation = 'X')		-- 	NaturalDisasterEmailPop*
		AND PDXX.DI_VLD_ADR = 'Y'
		AND	
			SUBSTRING(PDXX.DF_ZIP_CDE, X, X) IN 
		 (
		'XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX',
		'XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX',
		'XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX',
		'XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX',
		'XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX',
		'XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX',
		'XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX',
		'XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX',
		'XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX',
		'XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX',
		'XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX',
		'XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX',
		'XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX',
		'XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX','XXXXX'
		)
		ORDER BY PDXX.DF_SPE_ACC_ID
