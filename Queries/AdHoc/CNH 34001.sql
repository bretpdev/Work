USE CDW
GO

IF OBJECT_ID('tempdb..#PLUS_POP') IS NOT NULL 
	DROP TABLE #PLUS_POP

IF OBJECT_ID('tempdb..#NON_PLUS_POP') IS NOT NULL 
	DROP TABLE #NON_PLUS_POP

SELECT
	LNXX.BF_SSN,
	LNXX.LN_SEQ
INTO #PLUS_POP
FROM
	CDW..LNXX_LON LNXX
	INNER JOIN
	(
		SELECT 
			LNXX.BF_SSN,
			LNXX.LN_SEQ
		FROM
			CDW..LNXX_BR_DFR_APV LNXX
			INNER JOIN CDW..DFXX_BR_DFR_REQ DFXX
				ON DFXX.BF_SSN = LNXX.BF_SSN
				AND DFXX.LF_DFR_CTL_NUM = LNXX.LF_DFR_CTL_NUM
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND DFXX.LC_STA_DFRXX = 'A'
			AND DFXX.LC_DFR_STA = 'A'
			AND DFXX.LC_DFR_TYP IN ('XX','XX','XX','XX')
	) DEFERMENT
		ON DEFERMENT.BF_SSN = LNXX.BF_SSN
		AND DEFERMENT.LN_SEQ = LNXX.LN_SEQ
WHERE
	LNXX.LA_CUR_PRI > X 
	AND LNXX.LC_STA_LONXX = 'R'
	AND LNXX.IC_LON_PGM = 'DLPLUS'

SELECT DISTINCT
	LNXX.BF_SSN,
	LNXX.LN_SEQ
INTO #NON_PLUS_POP
FROM 
	CDW..LNXX_LON LNXX
	INNER JOIN
	(
		SELECT 
			LNXX.BF_SSN,
			LNXX.LN_SEQ
		FROM
			CDW..LNXX_BR_DFR_APV LNXX
			INNER JOIN CDW..DFXX_BR_DFR_REQ DFXX
				ON DFXX.BF_SSN = LNXX.BF_SSN
				AND DFXX.LF_DFR_CTL_NUM = LNXX.LF_DFR_CTL_NUM
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND DFXX.LC_STA_DFRXX = 'A'
			AND DFXX.LC_DFR_STA = 'A'
			AND DFXX.LC_DFR_TYP IN ('XX','XX','XX','XX')
	) DEFERMENT
		ON DEFERMENT.BF_SSN = LNXX.BF_SSN
		AND DEFERMENT.LN_SEQ = LNXX.LN_SEQ
WHERE
	LNXX.IC_LON_PGM != 'DLPLUS'
	AND LNXX.LC_STA_LONXX = 'R'
	AND LNXX.LA_CUR_PRI > X.XX


SELECT DISTINCT
	PDXX.DF_SPE_ACC_ID
FROM
	#PLUS_POP PP
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = PP.BF_SSN
	INNER JOIN #NON_PLUS_POP NPL
		ON NPL.BF_SSN = PP.BF_SSN



