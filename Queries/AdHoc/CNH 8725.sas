%LET RPTLIB = T:\SAS;

LIBNAME  LEGEND  REMOTE  SERVER=LEGEND SLIBREF=work  ;
RSUBMIT LEGEND;
/*%let DB = DNFPRQUT;  *This is test;*/
%let DB = DNFPUTDL;  *This is live;

LIBNAME PKUB DBX DATABASE=&DB OWNER=PKUB;

PROC SQL;
CONNECT TO DBX (DATABASE=&DB);
CREATE TABLE DEMO AS
	SELECT	*
	FROM	CONNECTION TO DBX (
				SELECT 
						COUNT(DISTINCT LNXX.BF_SSN) AS CODBorrowersInRepayment
				FROM	PKUB.LNXX_LON LNXX
						INNER JOIN PKUB.LNXX_FIN_ATY LNXX
							ON LNXX.BF_SSN = LNXX.BF_SSN
							AND LNXX.LN_SEQ = LNXX.LN_SEQ
						INNER JOIN PKUB.LNXX_LON_RPS LNXX
							ON LNXX.BF_SSN = LNXX.BF_SSN
							AND LNXX.LN_SEQ = LNXX.LN_SEQ
						/*LEFT OUTER JOIN (
								SELECT  
									COUNT(DISTINCT LNXXI.BF_SSN) AS CodinRepay,
									LNXXI.BF_SSN
								FROM
									PKUB.LNXX_LON_DLQ_HST LNXXI
								WHERE
									LNXXI.LC_STA_LONXX = 'X'
								GROUP BY
									LNXXI.BF_SSN
							) LNXX ON LNXX.BF_SSN = LNXX.BF_SSN*/
				WHERE	LNXX.PC_FAT_TYP = 'XX'
						AND LNXX.PC_FAT_SUB_TYP = 'XX'
						AND LNXX.LC_STA_LONXX = 'A' 
						AND LNXX.LD_END_GRC_PRD < CURRENT DATE

				FOR READ ONLY WITH UR
			);

CREATE TABLE DEMOX AS
	SELECT	*
	FROM	CONNECTION TO DBX (
				SELECT 
						COUNT(DISTINCT LNXX.BF_SSN) AS CODBorrowersInRepaymentAndDelinquent
				FROM	PKUB.LNXX_LON LNXX
						INNER JOIN PKUB.LNXX_FIN_ATY LNXX
							ON LNXX.BF_SSN = LNXX.BF_SSN
							AND LNXX.LN_SEQ = LNXX.LN_SEQ
						INNER JOIN PKUB.LNXX_LON_RPS LNXX
							ON LNXX.BF_SSN = LNXX.BF_SSN
							AND LNXX.LN_SEQ = LNXX.LN_SEQ
						INNER JOIN PKUB.LNXX_LON_DLQ_HST LNXX
							 ON LNXX.BF_SSN = LNXX.BF_SSN
							 AND LNXX.LN_SEQ = LNXX.LN_SEQ
							 AND LNXX.LC_STA_LONXX = 'X'
				WHERE	LNXX.PC_FAT_TYP = 'XX'
						AND LNXX.PC_FAT_SUB_TYP = 'XX'
						AND LNXX.LC_STA_LONXX = 'A' 
						AND LNXX.LD_END_GRC_PRD < CURRENT DATE

				FOR READ ONLY WITH UR
			);

CREATE TABLE DETAIL AS
	SELECT *
	FROM	CONNECTION TO DBX (
				SELECT DISTINCT
					PDXX.DF_SPE_ACC_ID AS AccountNumber,
					PDXX.DM_PRS_X AS First,
					PDXX.DM_PRS_LST AS Last,
					CONCAT(CONCAT(PDXX.DN_DOM_PHN_ARA, PDXX.DN_DOM_PHN_XCH), PDXX.DN_DOM_PHN_LCL) AS HomePhone,
					CONCAT(CONCAT(PDXXW.DN_DOM_PHN_ARA, PDXXW.DN_DOM_PHN_XCH), PDXXW.DN_DOM_PHN_LCL) AS WorkPhone,
					CONCAT(CONCAT(PDXXA.DN_DOM_PHN_ARA, PDXXA.DN_DOM_PHN_XCH), PDXXA.DN_DOM_PHN_LCL) AS AlternatePhone,
					LNXX.LD_END_GRC_PRD AS GracePeriodEnd,
					LNXX.LN_DLQ_MAX AS MaxDelinquency,
					AYXX.Count AS PhoneAttempts,
					CASE WHEN PDXX.DC_STA_SKP = 'X' THEN 'Not In Skip'
						 WHEN PDXX.DC_STA_SKP = 'X' THEN 'Skip'
						 WHEN PDXX.DC_STA_SKP = 'X' THEN 'Located'
						 WHEN PDXX.DC_STA_SKP = 'X' THEN 'Non Locatable'
						 WHEN PDXX.DC_STA_SKP = 'X' THEN 'End Skip'
						 WHEN PDXX.DC_STA_SKP = 'X' THEN 'Hold'
						 WHEN PDXX.DC_STA_SKP = 'X' THEN 'Bypass Skip'
						 ELSE '' END AS SkipStatus
				FROM 
					PKUB.PDXX_PRS_NME PDXX
					INNER JOIN PKUB.LNXX_LON LNXX
						ON PDXX.DF_PRS_ID = LNXX.BF_SSN
					INNER JOIN PKUB.LNXX_FIN_ATY LNXX
						ON LNXX.BF_SSN = LNXX.BF_SSN
					INNER JOIN PKUB.LNXX_LON_RPS LNXX
						ON LNXX.BF_SSN = LNXX.BF_SSN
					INNER JOIN PKUB.LNXX_LON_DLQ_HST LNXX
						ON LNXX.BF_SSN = LNXX.BF_SSN
						AND LNXX.LC_STA_LONXX = 'X'
					LEFT OUTER JOIN PKUB.PDXX_PRS_PHN PDXX
						ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
						AND PDXX.DC_PHN = 'H'
					LEFT OUTER JOIN PKUB.PDXX_PRS_PHN PDXXW
						ON PDXXW.DF_PRS_ID = PDXX.DF_PRS_ID
						AND PDXXW.DC_PHN = 'W'
					LEFT OUTER JOIN PKUB.PDXX_PRS_PHN PDXXA
						ON PDXXA.DF_PRS_ID = PDXX.DF_PRS_ID
						AND PDXXA.DC_PHN = 'A'
					LEFT OUTER JOIN (
						SELECT
							DF_PRS_ID,
							LN_SEQ,
							MAX(DC_STA_SKP) AS DC_STA_SKP,
							MAX(DN_SKP_PRS_SEQ) AS DN_SKP_PRS_SEQ
						FROM
							PKUB.PDXX_PRS_SKP_PRC 
						GROUP BY
							DF_PRS_ID,
							LN_SEQ
						) PDXX
						ON PDXX.DF_PRS_ID = LNXX.BF_SSN
						AND PDXX.LN_SEQ = LNXX.LN_SEQ
					LEFT OUTER JOIN (
						SELECT
							COUNT(BF_SSN) AS Count,
							BF_SSN
						FROM
							PKUB.AYXX_BR_LON_ATY
						WHERE
							PF_REQ_ACT = 'PXXXA'
							AND LD_ATY_REQ_RCV >= 'XXXX-XX-XX'
						GROUP BY
							BF_SSN
						) AYXX
						ON AYXX.BF_SSN = LNXX.BF_SSN
				WHERE 
					LNXX.PC_FAT_TYP = 'XX'
					AND LNXX.PC_FAT_SUB_TYP = 'XX'
					AND LNXX.LC_STA_LONXX = 'A' 
					AND LNXX.LD_END_GRC_PRD < CURRENT DATE

				FOR READ ONLY WITH UR
			);
DISCONNECT FROM DBX;

QUIT;

ENDRSUBMIT;
DATA DEMO; SET LEGEND.DEMO; RUN;
DATA DEMOX; SET LEGEND.DEMOX; RUN;
DATA DETAIL; SET LEGEND.DETAIL; RUN;

PROC EXPORT DATA= WORK.DEMO 
            OUTFILE= "T:\SAS\NH XXXX.xlsx" 
            DBMS=EXCEL REPLACE;
RUN;

PROC EXPORT DATA= WORK.DEMOX 
            OUTFILE= "T:\SAS\NH XXXX.xlsx" 
            DBMS=EXCEL REPLACE;
RUN;

PROC EXPORT DATA= WORK.DETAIL 
            OUTFILE= "T:\SAS\NH XXXX.xlsx" 
            DBMS=EXCEL REPLACE;
RUN;
