USE UDW
GO

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @SchoolCodes TABLE
(
	SchoolCode CHAR(8),
	SchoolCloseDate DATE
);

INSERT INTO
	@SchoolCodes
VALUES
--OPE ID	Closure Date
('04246000','6/18/2021'),
('02178901','7/30/2021'),
('02289701','7/30/2021'),
('02178902','7/30/2021'),
('00224332','10/5/2019'),
('03800400','7/1/2020'),
('03800402','7/1/2020'),
('04131600','5/31/2021'),
('00327003','8/7/2017'),
('00327709','3/31/2019'),
('00327722','1/10/2021'),
('02178900','7/30/2021'),
('02289700','7/30/2021'),
('00339611','9/1/2014'),
('00339614','9/1/2014'),
('10224310','12/12/2013'),
('00224396','6/15/2019'),
('00224398','11/17/2018'),
('00102300','7/31/2021'),
('04255600','8/26/2021'),
('02510300','7/8/2021'),
('00391150','5/14/2021'),
('01050305','6/24/2021'),
('00248007','5/5/2017'),
('10248005','12/13/2019'),
('10248007','12/9/2016'),
('10248008','12/14/2018'),
('10248009','12/13/2019'),
('00248011','12/15/2017'),
('10248010','5/4/2018'),
('10248011','12/9/2016'),
('10248012','5/4/2018'),
('10248013','12/14/2018'),
('10248016','12/14/2018'),
('00248024','12/13/2019'),
('00248050','12/13/2019'),
('00248070','5/4/2018'),
('00248074','5/5/2017'),
('00248078','5/4/2018'),
('00248084','12/14/2018'),
('00248093','12/15/2017'),
('00248096','12/13/2019'),
('00136306','4/30/2021'),
('10224304','10/10/2017'),
('00224312','1/10/2020'),
('00367400','8/1/2021'),
('00367403','8/1/2021'),
('00367407','8/1/2021'),
('00367409','8/1/2021'),
('02110803','8/1/2021'),
('04137201','5/15/2021'),
('02110800','8/1/2021'),
('02110802','8/1/2021'),
('02110804','8/1/2021'),
('00121612','5/28/2017'),
('00132807','6/30/2021'),
('00367406','8/1/2021'),
('02275801','7/30/2021')



--select * from @SchoolCodes

/*****************  MODIFIED QUERY  ***********************/
SELECT
	*
FROM
	(
		SELECT DISTINCT
			PD10.DF_SPE_ACC_ID,
			PD10.DM_PRS_1,
			PD10.DM_PRS_MID,
			PD10.DM_PRS_LST,
			PD30.DX_STR_ADR_1,
			PD30.DX_STR_ADR_2,
			PD30.DX_STR_ADR_3,
			PD30.DM_CT,
			PD30.DC_DOM_ST,
			PD30.DF_ZIP_CDE,
			PD30.DI_VLD_ADR,
			LN10.LF_DOE_SCL_ORG,
			SD10.LF_DOE_SCL_ENR_CUR,
			SD10.LD_NTF_SCL_SPR,
			SD10.LC_REA_SCL_SPR,
			SD10.LD_SCL_SPR [LastDayOfEnrollment],
			School.SchoolCloseDate
		FROM
			PD10_PRS_NME PD10
			INNER JOIN PD30_PRS_ADR PD30 
				ON PD30.DF_PRS_ID = PD10.DF_PRS_ID
			INNER JOIN 
			(
				SELECT
					LN10.BF_SSN,
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN LN10_LON LN10 
						ON LN10.LF_DOE_SCL_ORG = SC.SchoolCode

				UNION

				SELECT DISTINCT
					SD10.LF_STU_SSN [BF_SSN],
					SC.SchoolCode,
					SC.SchoolCloseDate
				FROM
					@SchoolCodes SC
					INNER JOIN SD10_STU_SPR SD10 
						ON SD10.LF_DOE_SCL_ENR_CUR = SC.SchoolCode
				WHERE
					SD10.LC_STA_STU10 = 'A'
			) School 
				ON School.BF_SSN = PD10.DF_PRS_ID
			INNER JOIN LN10_LON LN10 
				ON LN10.BF_SSN = PD10.DF_PRS_ID
			LEFT JOIN SD10_STU_SPR SD10 
				ON SD10.LF_STU_SSN = PD10.DF_PRS_ID 
				AND SD10.LF_DOE_SCL_ENR_CUR = School.SchoolCode 
				AND SD10.LC_STA_STU10 = 'A'
		WHERE
			DATEADD(DAY, 121, SD10.LD_SCL_SPR) > School.SchoolCloseDate
			and LN10.LA_CUR_PRI > 0.00
			AND LN10.LA_LON_AMT_GTR > 0.00
	) X
WHERE
	DATEADD(DAY, 121, ISNULL(X.LastDayOfEnrollment, GETDATE())) > X.SchoolCloseDate
	AND	(
			X.LF_DOE_SCL_ENR_CUR IN (SELECT SchoolCode FROM @SchoolCodes)
			OR	X.LF_DOE_SCL_ORG IN (SELECT SchoolCode FROM @SchoolCodes)
		)
ORDER BY
	X.DF_SPE_ACC_ID

 