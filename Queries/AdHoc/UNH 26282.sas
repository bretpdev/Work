/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;

LIBNAME  DUSTER  REMOTE  SERVER=DUSTER  SLIBREF=WORK; /*live*/
RSUBMIT;

%LET DB = DLGSUTWH; /*live*/
%Let WAVE = '2016-03-16';

/*LD_DLQ_OCC = Set to blank if LC-STA_LON16 <> '1' (active) OR if (LC_STA_LON16 = '1' and LD_DLQ_MAX <> previous day).*/
/*LN_DLQ_MAX = Set to 0 if LC-STA_LON16 <> '1' (active) OR if (LC_STA_LON16 = '1' and LD_DLQ_MAX <> previous day).*/

PROC SQL;
CONNECT TO DB2 (DATABASE=&DB); 
	CREATE TABLE Demos AS
		SELECT 
			*
		FROM CONNECTION TO DB2 
			(
			SELECT DISTINCT
				LN10.BF_SSN,
				LN10.LN_SEQ,
				LN10.LD_LON_ACL_ADD,
				LN10.LC_STA_LON10,
				LN10.LD_STA_LON10,
				LN10.LF_LON_CUR_OWN,
				LN10.IF_GTR,
				LN10.IC_LON_PGM,
				LN10.LD_END_GRC_PRD,
				LN10.LA_CUR_PRI,
				LN10.LA_NSI_OTS,
				LN10.LD_GTE_LOS,
				DW01.WC_DW_LON_STA,
				DW01.WD_LON_RPD_SR,
				DW01.WA_TOT_BRI_OTS,
				CASE WHEN DAYS(LD_DLQ_MAX) <> DAYS(Current Date - 1 day) THEN NULL ELSE COALESCE(LN16.LD_DLQ_OCC,NULL) END AS LD_DLQ_OCC,
				CASE WHEN DAYS(LD_DLQ_MAX) <> DAYS(Current Date - 1 day) THEN 0 ELSE COALESCE(LN16.LN_DLQ_MAX,0) END AS LN_DLQ_MAX,
				LN16.LD_DLQ_MAX,
				LN72.LR_ITR,
				LN72.LR_INT_RDC_PGM_ORG
			FROM	
				OLWHRM1.PD10_PRS_NME PD10
				INNER JOIN OLWHRM1.LN10_LON LN10 
					ON LN10.BF_SSN = PD10.DF_PRS_ID
				INNER JOIN OLWHRM1.DW01_DW_CLC_CLU DW01 
					ON DW01.BF_SSN = LN10.BF_SSN
					AND DW01.LN_SEQ = LN10.LN_SEQ
				LEFT JOIN 
					(
						SELECT DISTINCT
							BF_SSN,
							LN_SEQ,
							LD_DLQ_OCC,
							LN_DLQ_MAX,
							LD_DLQ_MAX
						FROM 
							OLWHRM1.LN16_LON_DLQ_HST
						WHERE
							LC_STA_LON16 = '1'
						
					) LN16 ON LN16.BF_SSN = LN10.BF_SSN
					AND LN16.LN_SEQ = LN10.LN_SEQ
				INNER JOIN OLWHRM1.LN72_INT_RTE_HST LN72 
					ON LN72.BF_SSN = LN10.BF_SSN
					AND LN72.LN_SEQ = LN10.LN_SEQ
					AND CURRENT DATE BETWEEN LN72.LD_ITR_EFF_BEG AND LN72.LD_ITR_EFF_END
					AND LN72.LC_STA_LON72 = 'A'
			WHERE	
				LN10.LD_LON_ACL_ADD = &WAVE
				AND LN10.LF_LON_CUR_OWN LIKE '829769%'
				/*AND LN10.LA_CUR_PRI > 0*/
			)
	;
DISCONNECT FROM DB2;
QUIT;

ENDRSUBMIT;

DATA Demos;
	SET DUSTER.Demos;
RUN;

PROC EXPORT
		DATA=Demos
		OUTFILE="&RPTLIB\UNH 26282.xlsx"
		DBMS = EXCEL
		REPLACE;
		SHEET="Wave_3";
RUN;
