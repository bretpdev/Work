SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
DECLARE @BasePop TABLE(BF_SSN VARCHAR(9), SubLoanSeq INT, SubAward VARCHAR(17), SubAwardSeq SMALLINT, SubOwner VARCHAR(10), SubGuarantor VARCHAR(15), SubGtrDate DATE, UnsubLoanSeq INT, UnsubAward VARCHAR(17), UnsubAwardSeq SMALLINT, UnsubOwner VARCHAR(10), UnsubGuarantor VARCHAR(15), UnsubGtrDate DATE, AD_PRC DATE, LoanCount INT)
INSERT INTO @BasePop
SELECT
	*
FROM OPENQUERY(DUSTER,
'
SELECT
	Sub.BF_SSN,
	Sub.LN_SEQ AS SubLoan,
	Sub.LF_LON_ALT AS SubAward,
	Sub.LN_LON_ALT_SEQ SubAwardSeq,
	Sub.LF_LON_CUR_OWN AS SubOwner,
	Sub.LF_GTR_RFR AS SubGuarantor,
	Sub.LD_LON_GTR AS SubGtrDate,
	Unsub.LN_SEQ AS UnsubLoan,
	Unsub.LF_LON_ALT AS UnsubAward,
	Unsub.LN_LON_ALT_SEQ UnsubAwardSeq,
	Unsub.LF_LON_CUR_OWN AS UnsubOwner,
	Unsub.LF_GTR_RFR AS UnsubGuarantor,
	Unsub.LD_LON_GTR AS UnsubGtrDate,
	GA10.AD_PRC,
	COUNT(GA10.AF_APL_ID_SFX) OVER(PARTITION BY GA10.AF_APL_ID) AS LoanCount
FROM
	OLWHRM1.LN10_LON Sub
	INNER JOIN OLWHRM1.LN10_LON Unsub
		ON Unsub.BF_SSN = Sub.BF_SSN
		AND Unsub.LN_SEQ != Sub.LN_SEQ
		AND Unsub.LD_LON_1_DSB = Sub.LD_LON_1_DSB
	INNER JOIN OLWHRM1.GR10_RPT_LON_APL SubGR10
		ON SubGR10.BF_SSN = Sub.BF_SSN
		AND SubGR10.LN_SEQ = Sub.LN_SEQ
	INNER JOIN OLWHRM1.GR10_RPT_LON_APL UnsubGR10
		ON UnsubGR10.BF_SSN = Unsub.BF_SSN
		AND UnsubGR10.LN_SEQ = Unsub.LN_SEQ
	INNER JOIN OLWHRM1.GA10_LON_APP GA10
		ON GA10.AF_APL_ID = Sub.LF_LON_ALT
		AND GA10.AF_APL_ID_SFX = Sub.LN_LON_ALT_SEQ
		AND GA10.AD_PRC = Sub.LD_LON_GTR
		AND GA10.AC_LON_TYP = ''CL''
WHERE
	Sub.IC_LON_PGM IN(''SUBCNS'',''SUBSPC'')
	AND Unsub.IC_LON_PGM IN(''UNCNS'',''UNSPC'')
	AND SubGR10.LF_LON_GRP_WI_BR = UnsubGR10.LF_LON_GRP_WI_BR
	AND 
	(
		SubGR10.LI_BR_GRP_RLP = ''Y''
		OR UnsubGR10.LI_BR_GRP_RLP = ''Y''
	)
')

SELECT * FROM @BasePop WHERE LoanCount > 1