USE CDW
GO
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
	 SELECT * FROM (
	SELECT DISTINCT
		pdXX.DF_SPE_ACC_ID,
		lnXX.LN_SEQ,
		DWXX.WC_DW_LON_STA,
		blXX.LC_IND_BIL_SNT,
		BLXX.LD_BIL_CRT,
		
		ISNULL(LNXX.LN_DLQ_MAX,X) AS LN_DLQ_MAX,
		S.*
	into cdw..CNH_XXXXX_runX
	FROM
		CDW..PDXX_PRS_NME PDXX
		INNER JOIN CDW..LNXX_LON LNXX
			ON PDXX.DF_PRS_ID = LNXX.BF_SSN
		INNER JOIN  [CDW].[dbo].[brXXxxx$] S 
			ON S.BF_SSN = PDXX.DF_PRS_ID
		INNER JOIN CDW..BRXX_BR_EFT BRXX
			ON BRXX.BF_SSN = S.BF_SSN
			AND BRXX.BN_EFT_SEQ = S.BN_EFT_SEQ
		INNER JOIN CDW..LNXX_EFT_TO_LON LNXX
			ON S.BF_SSN = LNXX.BF_SSN	
			AND S.BN_EFT_SEQ = LNXX.BN_EFT_SEQ
			and LNXX.LN_SEQ = LNXX.LN_SEQ
		INNER JOIN CDW..DWXX_DW_CLC_CLU DWXX
			ON DWXX.BF_SSN = LNXX.BF_SSN
			AND DWXX.LN_SEQ = LNXX.LN_SEQ
		INNER JOIN
		(
			SELECT distinct
				BLXX.BF_SSN,
				LNXX.LN_SEQ,
				MAX(BLXX.LD_BIL_CRT) AS LD_BIL_CRT,
				MAX(BLXX.LN_SEQ_BIL_WI_DTE) AS LN_SEQ_BIL_WI_DTE
			FROM
				CDW..BLXX_BR_BIL BLXX
				INNER JOIN CDW..LNXX_LON_BIL_CRF LNXX
					ON LNXX.BF_SSN = BLXX.BF_SSN
					AND LNXX.LD_BIL_CRT = BLXX.LD_BIL_CRT
			WHERE
				BLXX.LC_STA_BILXX = 'A'
				AND LNXX.LC_STA_LONXX = 'A'
				AND MONTH(BLXX.LD_BIL_DU) = X
			GROUP BY
				BLXX.BF_SSN,
				LNXX.LN_SEQ
		) MBILL
			ON MBILL.BF_SSN = LNXX.BF_SSN
			AND MBILL.LN_SEQ = LNXX.LN_SEQ
		INNER JOIN CDW..BLXX_BR_BIL BLXX
			ON BLXX.BF_SSN = MBILL.BF_SSN
			AND BLXX.LD_BIL_CRT = MBILL.LD_BIL_CRT
			AND BLXX.LN_SEQ_BIL_WI_DTE = MBILL.LN_SEQ_BIL_WI_DTE
			AND BLXX.LC_STA_BILXX = 'A'
		LEFT JOIN CDW..LNXX_LON_DLQ_HST LNXX
			ON LNXX.BF_SSN = LNXX.BF_SSN
			AND LNXX.LN_SEQ = LNXX.LN_SEQ
			AND LNXX.LC_STA_LONXX = 'X'
		WHERE
			LC_IND_BIL_SNT = 'G'
			AND month(BLXX.LD_BIL_DU) = X
			AND S.BC_EFT_STA = 'A'
			and BLXX.LD_BIL_CRT > s.BD_EFT_STA
	
		) P

