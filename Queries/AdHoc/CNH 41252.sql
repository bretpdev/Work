USE [CDW]
GO
/****** Object:  StoredProcedure [dbo].[LT_TSXXBTRTX_Loans]    Script Date: X/XX/XXXX XX:XX:XX AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[LT_TSXXBTRTX_Loans]
	@AccountNumber CHAR(XX),
	@IsCoborrower BIT = X
AS
BEGIN

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE	@LetterId VARCHAR(XX) = 'TSXXBTRTX'
DECLARE @PF_REQ_ACT VARCHAR(X) = (SELECT ACXX.PF_REQ_ACT FROM ACXX_ACT_REQ_LTR ACXX WHERE PF_LTR = @LetterId)

IF @IsCoborrower = X
	BEGIN
		SELECT
			COALESCE(FMT.Label, RS.IC_LON_PGM) AS [Loan Program],
			CONVERT(VARCHAR, RS.LD_LON_X_DSB, XXX) AS [First Disbursement Date],
			'$' + CAST(RS.LA_LON_AMT_GTR AS VARCHAR) AS [Original Balance],
			'$' + CAST(RS.LA_CUR_PRI AS VARCHAR) AS [Current Principal],
			LNXX.LR_INT_RDC_PGM_ORG AS [Interest Rate],
			RS.LC_TYP_SCH_DIS AS [Schedule Type],
			'$' + CAST(RS.LA_TOT_RPD_DIS AS VARCHAR) AS [Total Repay Amount],
			'$' + CAST(COALESCE(RS.LA_ANT_CAP, X) AS VARCHAR) AS [Anticipated Cap],
			CONVERT(VARCHAR, RS.TermStartDate, XXX) AS [Due Date],
			RS.LN_RPS_TRM AS [Repay Term in Months],
			'$' + CAST(RS.LA_RPS_ISL AS VARCHAR) AS [Installment Amount]
		FROM
			PDXX_PRS_NME PDXX
			INNER JOIN calc.RepaymentSchedules RS
				ON RS.BF_SSN = PDXX.DF_PRS_ID
				AND RS.CurrentGradation = X
			INNER JOIN
			(
				SELECT
					LNXX.BF_SSN,
					LNXX.LN_SEQ
				FROM
					LNXX_LON_ATY LNXX
					INNER JOIN --GETS THE MOST RECENT ARC LEFT ON THE BORROWERS ACCOUNT TO GET THE LOAN SEQ'S THE LETTER APPLIES TO
					(
						SELECT
							AYXX.BF_SSN,
							MAX(AYXX.LN_ATY_SEQ) AS LN_ATY_SEQ,
							MAX(AYXX.LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
						FROM 
							AYXX_BR_LON_ATY AYXX
							INNER JOIN PDXX_PRS_NME PDXX
								ON PDXX.DF_PRS_ID = AYXX.BF_SSN
						WHERE
							AYXX.PF_REQ_ACT = @PF_REQ_ACT
							AND PDXX.DF_SPE_ACC_ID = @AccountNumber
						GROUP BY
							AYXX.BF_SSN
					)AYXX
						ON AYXX.BF_SSN = LNXX.BF_SSN
						AND AYXX.LN_ATY_SEQ = LNXX.LN_ATY_SEQ
			)LNXX
				ON LNXX.BF_SSN = RS.BF_SSN
				AND LNXX.LN_SEQ = RS.LN_SEQ
			INNER JOIN
			(
				SELECT
					LNXX.BF_SSN,
					LNXX.LN_SEQ,
					LNXX.LR_INT_RDC_PGM_ORG,
					ROW_NUMBER() OVER (PARTITION BY LNXX.BF_SSN, LNXX.LN_SEQ ORDER BY LD_STA_LONXX DESC) AS SEQ
				FROM	
					CDW..LNXX_INT_RTE_HST LNXX
				WHERE
					LNXX.LC_STA_LONXX = 'A'
					AND CAST(GETDATE() AS DATE) BETWEEN LNXX.LD_ITR_EFF_BEG AND LNXX.LD_ITR_EFF_END
			) LNXX 
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ 
				AND LNXX.SEQ = X
			LEFT JOIN FormatTranslation FMT
				ON FMT.Start = RS.IC_LON_PGM
				AND FMT.FmtName = '$LNPROG'
			LEFT JOIN FormatTranslation FMTRepay
				ON FMTRepay.Start = RS.LC_TYP_SCH_DIS
				AND FMTRepay.FmtName = '$SCHTYP'
		WHERE
			PDXX.DF_SPE_ACC_ID = @AccountNumber
		ORDER BY
			RS.LN_SEQ,
			RS.TermStartDate
	END
ELSE
	BEGIN
		SELECT 
			COALESCE(FMT.Label, RS.IC_LON_PGM) AS [Loan Program],
			CONVERT(VARCHAR, RS.LD_LON_X_DSB, XXX) AS [First Disbursement Date],
			'$' + CAST(RS.LA_LON_AMT_GTR AS VARCHAR) AS [Original Balance],
			'$' + CAST(RS.LA_CUR_PRI AS VARCHAR) AS [Current Principal],
			LNXX.LR_INT_RDC_PGM_ORG AS [Interest Rate],
			RS.LC_TYP_SCH_DIS AS [Schedule Type],
			'$' + CAST(RS.LA_TOT_RPD_DIS AS VARCHAR) AS [Total Repay Amount],
			'$' + CAST(COALESCE(RS.LA_ANT_CAP, X) AS VARCHAR) AS [Anticipated Cap],
			CONVERT(VARCHAR, RS.TermStartDate, XXX) AS [Due Date],
			RS.LN_RPS_TRM AS [Repay Term in Months],
			'$' + CAST(RS.LA_RPS_ISL AS VARCHAR) AS [Installment Amount]
		FROM
			PDXX_PRS_NME PDXX
			INNER JOIN LNXX_EDS LNXX
				ON LNXX.LF_EDS = PDXX.DF_PRS_ID
				AND LNXX.LC_EDS_TYP = 'M'
				AND LNXX.LC_STA_LONXX = 'A'
			INNER JOIN calc.RepaymentSchedules RS
				ON RS.BF_SSN = LNXX.BF_SSN
				AND RS.LN_SEQ = LNXX.LN_SEQ
				AND RS.CurrentGradation = X
			INNER JOIN
			(
				SELECT
					LNXX.BF_SSN,
					LNXX.LN_SEQ
				FROM
					LNXX_LON_ATY LNXX
					INNER JOIN --GETS THE MOST RECENT ARC LEFT ON THE BORROWERS ACCOUNT TO GET THE LOAN SEQ'S THE LETTER APPLIES TO
					(
						SELECT
							AYXX.BF_SSN,
							MAX(AYXX.LN_ATY_SEQ) AS LN_ATY_SEQ,
							MAX(AYXX.LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
						FROM 
							AYXX_BR_LON_ATY AYXX
							INNER JOIN LNXX_EDS LNXX
								ON LNXX.BF_SSN = AYXX.BF_SSN
								AND LNXX.LC_EDS_TYP = 'M'
								AND LNXX.LC_STA_LONXX = 'A'
							INNER JOIN PDXX_PRS_NME PDXX
								ON PDXX.DF_PRS_ID = LNXX.LF_EDS
						WHERE
							AYXX.PF_REQ_ACT = @PF_REQ_ACT
							AND PDXX.DF_SPE_ACC_ID = @AccountNumber
						GROUP BY
							AYXX.BF_SSN
					)AYXX
						ON AYXX.BF_SSN = LNXX.BF_SSN
						AND AYXX.LN_ATY_SEQ = LNXX.LN_ATY_SEQ
			)LNXX
				ON LNXX.BF_SSN = RS.BF_SSN
				AND LNXX.LN_SEQ = RS.LN_SEQ
			INNER JOIN
			(
				SELECT
					LNXX.BF_SSN,
					LNXX.LN_SEQ,
					LNXX.LR_INT_RDC_PGM_ORG,
					ROW_NUMBER() OVER (PARTITION BY LNXX.BF_SSN, LNXX.LN_SEQ ORDER BY LD_STA_LONXX DESC) AS SEQ
				FROM	
					CDW..LNXX_INT_RTE_HST LNXX
				WHERE
					LNXX.LC_STA_LONXX = 'A'
					AND CAST(GETDATE() AS DATE) BETWEEN LNXX.LD_ITR_EFF_BEG AND LNXX.LD_ITR_EFF_END
			) LNXX 
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ 
				AND LNXX.SEQ = X
			LEFT JOIN FormatTranslation FMT
				ON FMT.Start = RS.IC_LON_PGM
				AND FMT.FmtName = '$LNPROG'
			LEFT JOIN FormatTranslation FMTRepay
				ON FMTRepay.Start = RS.LC_TYP_SCH_DIS
				AND FMTRepay.FmtName = '$SCHTYP'
		WHERE
			PDXX.DF_SPE_ACC_ID = @AccountNumber
		ORDER BY
			RS.LN_SEQ,
			RS.TermStartDate
	END
END
