USE CDW
GO
--QUERY BASED ON OPT OUT ARC
SELECT
	DATENAME(MONTH, DATEADD(MONTH, POP.OPT_OUT_MONTH , -X)) OPT_OUT_MONTH,
	POP.OPT_OUT_YEAR,
	COUNT(DISTINCT POP.BF_SSN) AS OPT_OUT_COUNT,
	SUM(MAN) AS MANUALLY_OPTED_BACK_IN,
	SUM([AUTO]) AS AUTO_OPTED_BACK_IN
FROM
(
SELECT DISTINCT
	AYXX.BF_SSN,
	MONTH(AYXX.LD_ATY_REQ_RCV) AS OPT_OUT_MONTH,
	YEAR(AYXX.LD_ATY_REQ_RCV) AS OPT_OUT_YEAR,
	MAX(CASE WHEN FORB.LD_FOR_BEG > AYXX.LD_ATY_REQ_RCV AND FORB.BF_SSN IS NOT NULL THEN X ELSE X END) AS MAN,
	MAX(CASE WHEN LNXX.LD_DLQ_OCC > AYXX.LD_ATY_REQ_RCV AND LNXX.BF_SSN IS NOT NULL AND LNXX.LN_DLQ_MAX >= XX THEN X ELSE X END) AS [AUTO]
FROM
	CDW..AYXX_BR_LON_ATY AYXX
	LEFT JOIN
	(
		SELECT DISTINCT
			FBXX.BF_SSN,
			LNXX.LD_FOR_BEG,
			LNXX.LD_FOR_END,
			FBXX.LD_CRT_REQ_FOR
		FROM
			CDW..FBXX_BR_FOR_REQ FBXX
			INNER JOIN CDW..LNXX_BR_FOR_APV LNXX
				ON LNXX.BF_SSN = FBXX.BF_SSN
				AND LNXX.LF_FOR_CTL_NUM = FBXX.LF_FOR_CTL_NUM
			INNER JOIN CDW..LNXX_LON LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
				AND LNXX.LA_CUR_PRI > X
				AND LNXX.LC_STA_LONXX = 'R'
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND FBXX.LC_STA_FORXX = 'A'
			AND FBXX.LC_FOR_STA = 'A' --denied records cant have this active
			AND LNXX.LC_FOR_RSP != 'XXX'
			AND FBXX.LC_FOR_TYP = 'XX'
			AND CAST(GETDATE() AS DATE) BETWEEN CAST(LNXX.LD_FOR_BEG AS DATE) AND CAST(LNXX.LD_FOR_END AS DATE)
	) FORB
		ON FORB.BF_SSN = AYXX.BF_SSN
	LEFT JOIN
	(
		SELECT DISTINCT
			LNXX.BF_SSN, 
			LNXX.LD_DLQ_OCC,
			LNXX.LN_DLQ_MAX
		FROM
			(
				SELECT
					LNXX.BF_SSN,
					LNXX.LN_SEQ,
					LNXX.LD_DLQ_OCC,
					LNXX.LN_DLQ_MAX
				FROM
					CDW..LNXX_LON_DLQ_HST LNXX
					INNER JOIN
					(
						SELECT DISTINCT
							BF_SSN,
							LN_SEQ,
							MAX(LD_DLQ_OCC) OVER(PARTITION BY bf_ssn) AS LD_DLQ_OCC
						FROM
							CDW..LNXX_LON_DLQ_HST LNXX
					) M
						ON M.BF_SSN = LNXX.BF_SSN
						AND M.LN_SEQ = LNXX.LN_SEQ
						AND M.LD_DLQ_OCC = LNXX.LD_DLQ_OCC
			) LNXX

			INNER JOIN CDW..LNXX_LON LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
				AND LNXX.LA_CUR_PRI > X
				AND LNXX.LC_STA_LONXX = 'R'
	) LNXX
		ON LNXX.BF_SSN = AYXX.BF_SSN
		AND LNXX.LD_DLQ_OCC > AYXX.LD_ATY_REQ_RCV
WHERE
	PF_REQ_ACT = 'CVDOO'
	AND LC_STA_ACTYXX = 'A'
GROUP BY
	AYXX.BF_SSN,
	MONTH(AYXX.LD_ATY_REQ_RCV),
	YEAR(AYXX.LD_ATY_REQ_RCV) 
) POP
GROUP BY
	POP.OPT_OUT_MONTH,
	POP.OPT_OUT_YEAR
ORDER BY
	POP.OPT_OUT_MONTH

--QUERY BASED ON FORB END DATE FOR MANUAL FORBS ONLY
SELECT
	DATENAME(MONTH, DATEADD(MONTH, POP.OPT_OUT_MONTH , -X)) OPT_OUT_MONTH,
	POP.OPT_OUT_YEAR,
	SUM(MAN) AS MANUALLY_OPTED_BACK_IN
FROM
(
SELECT DISTINCT
	AYXX.BF_SSN,
	MONTH(FORB.LD_CRT_REQ_FOR) AS OPT_OUT_MONTH,
	YEAR(FORB.LD_CRT_REQ_FOR) AS OPT_OUT_YEAR,
	MAX(CASE WHEN FORB.LD_FOR_BEG > AYXX.LD_ATY_REQ_RCV AND FORB.BF_SSN IS NOT NULL THEN X ELSE X END) AS MAN
FROM
	CDW..AYXX_BR_LON_ATY AYXX
	INNER JOIN
	(
		SELECT DISTINCT
			FBXX.BF_SSN,
			LNXX.LD_FOR_BEG,
			LNXX.LD_FOR_END,
			FBXX.LD_CRT_REQ_FOR
		FROM
			CDW..FBXX_BR_FOR_REQ FBXX
			INNER JOIN CDW..LNXX_BR_FOR_APV LNXX
				ON LNXX.BF_SSN = FBXX.BF_SSN
				AND LNXX.LF_FOR_CTL_NUM = FBXX.LF_FOR_CTL_NUM
			INNER JOIN CDW..LNXX_LON LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
				AND LNXX.LA_CUR_PRI > X
				AND LNXX.LC_STA_LONXX = 'R'
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND FBXX.LC_STA_FORXX = 'A'
			AND FBXX.LC_FOR_STA = 'A' --denied records cant have this active
			AND LNXX.LC_FOR_RSP != 'XXX'
			AND FBXX.LC_FOR_TYP = 'XX'
			AND CAST(GETDATE() AS DATE) BETWEEN CAST(LNXX.LD_FOR_BEG AS DATE) AND CAST(LNXX.LD_FOR_END AS DATE)
	) FORB
		ON FORB.BF_SSN = AYXX.BF_SSN
WHERE
	PF_REQ_ACT = 'CVDOO'
	AND LC_STA_ACTYXX = 'A'
GROUP BY
	AYXX.BF_SSN,
	MONTH(FORB.LD_CRT_REQ_FOR),
	YEAR(FORB.LD_CRT_REQ_FOR) 
) POP
GROUP BY
	POP.OPT_OUT_MONTH,
	POP.OPT_OUT_YEAR
ORDER BY
	POP.OPT_OUT_MONTH

--QUERY BASED ON DELQ END DATE AUTO POP ONLY
SELECT
	DATENAME(MONTH, DATEADD(MONTH, POP.OPT_OUT_MONTH , -X)) OPT_OUT_MONTH,
	POP.OPT_OUT_YEAR,
	SUM([AUTO]) AS AUTO_OPTED_BACK_IN
FROM
(
SELECT DISTINCT
	AYXX.BF_SSN,
	MONTH(LNXX.LD_STA_LONXX) AS OPT_OUT_MONTH,
	YEAR(LNXX.LD_STA_LONXX) AS OPT_OUT_YEAR,
	MAX(CASE WHEN LNXX.LD_DLQ_OCC > AYXX.LD_ATY_REQ_RCV AND LNXX.BF_SSN IS NOT NULL AND LNXX.LN_DLQ_MAX >= XX THEN X ELSE X END) AS [AUTO]
FROM
	CDW..AYXX_BR_LON_ATY AYXX
	INNER JOIN
	(
		SELECT DISTINCT
			LNXX.BF_SSN, 
			LNXX.LD_DLQ_OCC,
			LNXX.LN_DLQ_MAX,
			LNXX.LD_STA_LONXX
		FROM
			(
				SELECT
					LNXX.BF_SSN,
					LNXX.LN_SEQ,
					LNXX.LD_DLQ_OCC,
					LNXX.LN_DLQ_MAX,
					LNXX.LD_STA_LONXX
				FROM
					CDW..LNXX_LON_DLQ_HST LNXX
					INNER JOIN
					(
						SELECT DISTINCT
							BF_SSN,
							LN_SEQ,
							MAX(LD_DLQ_OCC) OVER(PARTITION BY bf_ssn) AS LD_DLQ_OCC
						FROM
							CDW..LNXX_LON_DLQ_HST LNXX
					) M
						ON M.BF_SSN = LNXX.BF_SSN
						AND M.LN_SEQ = LNXX.LN_SEQ
						AND M.LD_DLQ_OCC = LNXX.LD_DLQ_OCC
			) LNXX

			INNER JOIN CDW..LNXX_LON LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
				AND LNXX.LA_CUR_PRI > X
				AND LNXX.LC_STA_LONXX = 'R'
	) LNXX
		ON LNXX.BF_SSN = AYXX.BF_SSN
		AND LNXX.LD_DLQ_OCC > AYXX.LD_ATY_REQ_RCV
WHERE
	PF_REQ_ACT = 'CVDOO'
	AND LC_STA_ACTYXX = 'A'
GROUP BY
	AYXX.BF_SSN,
	MONTH(LNXX.LD_STA_LONXX),
	YEAR(LNXX.LD_STA_LONXX)  
) POP
GROUP BY
	POP.OPT_OUT_MONTH,
	POP.OPT_OUT_YEAR
ORDER BY
	POP.OPT_OUT_MONTH

select
	COUNT(DISTINCT BF_SSN)
from 
	cdw..AYXX_BR_LON_ATY
WHERE
	PF_REQ_ACT = 'CVDOO'
	AND LC_STA_ACTYXX = 'A'