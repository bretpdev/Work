DECLARE @BEGINPREV DATE = CAST(DATEADD(DAY, X, EOMONTH(GETDATE(),-X)) AS DATE) --beginning of last month
DECLARE @EOMPREV DATE = CAST(EOMONTH(GETDATE(),-X) AS DATE) --End of last month

--RX Detail file for RX data set
SELECT DISTINCT
	@EOMPREV AS MonthEndDate,
	LNXX.BF_SSN,
	LNXX.LN_SEQ,
	COALESCE(LKXXF.PX_DSC_MDM, FBXX.LC_FOR_TYP,'') AS ForbType,
	COALESCE(LKXXD.PX_DSC_MDM, DFXX.LC_DFR_TYP,'') AS DeferType,
	COALESCE(LNXX.LC_TYP_SCH_DIS,'') AS ScheduleType,
	COALESCE(LKXXDW.PX_DSC_MDM, DWXX.WC_DW_LON_STA) AS LoanStatus
FROM
	(
		SELECT DISTINCT
			AYXX.BF_SSN,
			AYXX.PF_REQ_ACT,
			STUFF
			(
				(
					SELECT 
							' ' + SUB.LX_ATY AS [text()]
					FROM 
						CDW..AYXX_ATY_TXT SUB
					WHERE
						SUB.BF_SSN = AYXX.BF_SSN
						AND SUB.LN_ATY_SEQ = AYXX.LN_ATY_SEQ
					FOR XML PATH('')
				),X,X, ''
			) AS LX_ATY	
		FROM	
			CDW..AYXX_BR_LON_ATY AYXX
			INNER JOIN CDW..AYXX_ATY_TXT AYXX
				ON AYXX.BF_SSN = AYXX.BF_SSN
				AND AYXX.LN_ATY_SEQ = AYXX.LN_ATY_SEQ
		WHERE
			CAST(AYXX.LD_ATY_REQ_RCV AS DATE) BETWEEN @BEGINPREV AND @EOMPREV
			AND AYXX.PF_REQ_ACT IN('IBDNX', 'IBDNX', 'IBDNX', 'IBDNX', 'IBDNX', 'IBDNX', 'IBDNX', 'IBDNY', 'IDRID', 'IDRDN', 'ICDNY', 'PEDNY', 'REDNY')
	) COMBINED_COMMENT
INNER JOIN CDW..LNXX_LON LNXX
	ON LNXX.BF_SSN = COMBINED_COMMENT.BF_SSN
	AND LNXX.LA_CUR_PRI > X.XX
	AND LNXX.LC_STA_LONXX = 'R'
LEFT JOIN CDW..LNXX_BR_FOR_APV LNXX
	ON LNXX.BF_SSN = LNXX.BF_SSN
	AND LNXX.LN_SEQ = LNXX.LN_SEQ
	AND LNXX.LC_FOR_RSP != 'XXX'
	AND LNXX.LC_STA_LONXX = 'A'
	AND CAST(GETDATE() AS DATE) BETWEEN CAST(LNXX.LD_FOR_BEG AS DATE) AND CAST(LNXX.LD_FOR_END AS DATE)
LEFT JOIN CDW..FBXX_BR_FOR_REQ FBXX
	ON FBXX.BF_SSN = LNXX.BF_SSN
	AND FBXX.LF_FOR_CTL_NUM = LNXX.LF_FOR_CTL_NUM
	AND FBXX.LC_STA_FORXX = 'A'
	AND FBXX.LC_FOR_STA = 'A'
LEFT JOIN CDW..LNXX_BR_DFR_APV LNXX
	ON LNXX.BF_SSN = LNXX.BF_SSN
	AND LNXX.LN_SEQ = LNXX.LN_SEQ
	AND LNXX.LC_DFR_RSP != 'XXX'
	AND LNXX.LC_STA_LONXX = 'A'
	AND CAST(GETDATE() AS DATE) BETWEEN CAST(LNXX.LD_DFR_BEG AS DATE) AND CAST(LNXX.LD_DFR_END AS DATE)
LEFT JOIN CDW..DFXX_BR_DFR_REQ DFXX
	ON DFXX.BF_SSN = LNXX.BF_SSN
	AND DFXX.LF_DFR_CTL_NUM = LNXX.LF_DFR_CTL_NUM
	AND DFXX.LC_STA_DFRXX = 'A'
	AND DFXX.LC_DFR_STA = 'A'
LEFT JOIN
(
	SELECT DISTINCT
		LNXX.BF_SSN,
		LNXX.LN_SEQ,
		LNXX.LC_TYP_SCH_DIS
	FROM
		CDW..LNXX_LON_RPS LNXX
		INNER JOIN
		(
			SELECT
				LNXX.BF_SSN,
				LNXX.LN_SEQ,
				MAX(LNXX.LN_RPS_SEQ) AS LN_RPS_SEQ
			FROM
				CDW..LNXX_LON_RPS LNXX
				INNER JOIN 
				(
					SELECT
						LNXX.BF_SSN,
						LNXX.LN_SEQ,
						MAX(LNXX.LF_LST_DTS_LNXX) AS LF_LST_DTS_LNXX
					FROM
						CDW..LNXX_LON_RPS LNXX
						INNER JOIN CDW..LNXX_LON LNXX
							ON LNXX.BF_SSN = LNXX.BF_SSN
							AND LNXX.LN_SEQ = LNXX.LN_SEQ
							AND LNXX.LA_CUR_PRI > X.XX
							AND LNXX.LC_STA_LONXX = 'R'
					GROUP BY
						LNXX.BF_SSN,
						LNXX.LN_SEQ
				) MaxRPS
					ON MaxRPS.BF_SSN = LNXX.BF_SSN
					AND MaxRPS.LN_SEQ = LNXX.LN_SEQ
					AND MaxRPS.LF_LST_DTS_LNXX = LNXX.LF_LST_DTS_LNXX
				GROUP BY
					LNXX.BF_SSN,
					LNXX.LN_SEQ
		) MaxSeq
			ON MaxSeq.BF_SSN = LNXX.BF_SSN
			AND MaxSeq.LN_SEQ = LNXX.LN_SEQ
			AND MaxSeq.LN_RPS_SEQ = LNXX.LN_RPS_SEQ
) LNXX
	ON LNXX.BF_SSN = LNXX.BF_SSN
	AND LNXX.LN_SEQ = LNXX.LN_SEQ
LEFT JOIN CDW..DWXX_DW_CLC_CLU DWXX
	ON DWXX.BF_SSN = LNXX.BF_SSN
	AND DWXX.LN_SEQ = LNXX.LN_SEQ
LEFT JOIN CDW..LKXX_LS_CDE_LKP LKXXDW
    ON LKXXDW.PM_ATR = 'WC-DW-LON-STA'
    AND LKXXDW.PX_ATR_VAL = DWXX.WC_DW_LON_STA
LEFT JOIN CDW..LKXX_LS_CDE_LKP LKXXF
    ON LKXXF.PM_ATR = 'LC-FOR-TYP'
    AND LKXXF.PX_ATR_VAL = FBXX.LC_FOR_TYP
LEFT JOIN CDW..LKXX_LS_CDE_LKP LKXXD
    ON LKXXD.PM_ATR = 'LC-DFR-TYP'
    AND LKXXD.PX_ATR_VAL = DFXX.LC_DFR_TYP
WHERE
	COMBINED_COMMENT.LX_ATY LIKE '%loans are not in repayment%' 
	OR COMBINED_COMMENT.LX_ATY LIKE '%paid ahead%' 
	OR COMBINED_COMMENT.PF_REQ_ACT = 'IBDNX'
ORDER BY
	LNXX.BF_SSN,
	LNXX.LN_SEQ
