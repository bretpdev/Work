USE CDW
GO



SELECT
	POP.BF_SSN,
	POP.LN_ATY_SEQ,
	POP.LC_STA_ACTYXX AS OLD_LC_STA_ACTYXX,
	'E' AS OLD_LC_STA_ACTYXX,
	POP.LF_LST_DTS_AYXX AS OLD_LF_LST_DTS_AYXX,
	'CURRENT DATE/TIME' AS NEW_LF_LST_DTS_AYXX
FROM
(
	SELECT DISTINCT
		AYXX.BF_SSN,
		AYXX.LN_ATY_SEQ,
		AYXX.LC_STA_ACTYXX,
		AYXX.LF_LST_DTS_AYXX,
		RIGHT(REPLACE(AYXX.LX_ATY, ' ',''), XX) AS LX_ATY, --we need to get rid of the noble call history id and extra spaces because of how sometime it adds a space
		ROW_NUMBER() OVER(PARTITION BY AYXX.BF_SSN,	RIGHT(REPLACE(AYXX.LX_ATY, ' ',''), XX) ORDER BY AYXX.LN_ATY_SEQ) AS CallRank
	FROM
		PDXX_PRS_NME PDXX
		INNER JOIN AYXX_BR_LON_ATY AYXX
			ON AYXX.BF_SSN = PDXX.DF_PRS_ID
		INNER JOIN
		(
			SELECT 
				BF_SSN,
				LN_ATY_SEQ,
				STUFF(
				(
					SELECT 
						 ' ' + SUB.LX_ATY AS [text()]
					FROM 
						AYXX_ATY_TXT SUB
					WHERE
						SUB.BF_SSN = AYXX.BF_SSN
						AND SUB.LN_ATY_SEQ = AYXX.LN_ATY_SEQ
				FOR XML PATH('')
				)
				,X,X, '')
				AS LX_ATY
			FROM	
				AYXX_ATY_TXT AYXX
		)AYXX
			ON AYXX.BF_SSN = AYXX.BF_SSN
			AND AYXX.LN_ATY_SEQ = AYXX.LN_ATY_SEQ
	WHERE
		AYXX.PF_REQ_ACT ='DDPHN'
		AND AYXX.LC_STA_ACTYXX = 'A'
		AND AYXX.LD_ATY_REQ_RCV BETWEEN 'XX/XX/XXXX' AND  'XX/XX/XXXX'
) POP
WHERE
	POP.CallRank != X
