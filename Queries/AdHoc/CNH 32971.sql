USE CDW
GO

SELECT DISTINCT
	RTRIM(PDXX.DM_PRS_X) + ' ' + RTRIM(PDXX.DM_PRS_LST) [NAME],
	PDXX.DF_PRS_ID SSN,
	MAX(LNXX.LN_DLQ_MAX) [LN_DLQ_MAX]
FROM
	..PDXX_PRS_NME PDXX
	INNER JOIN ..LNXX_LON LNXX 
		ON PDXX.DF_PRS_ID = LNXX.BF_SSN
	INNER JOIN ..DWXX_DW_CLC_CLU DWXX 
		ON LNXX.BF_SSN = DWXX.BF_SSN 
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN ..LNXX_LON_DLQ_HST LNXX
		ON LNXX.BF_SSN = DWXX.BF_SSN 
		AND LNXX.LN_SEQ = DWXX.LN_SEQ
WHERE 
	LNXX.IC_LON_PGM = 'DLPLUS'
	AND
	(
		SELECT 
			COUNT(DISTINCT DWXX.WC_DW_LON_STA)
		FROM
			..DWXX_DW_CLC_CLU DWXX
		WHERE
			DWXX.BF_SSN = PDXX.DF_PRS_ID
	) > X
	AND
	(
		SELECT 
			COUNT(DWXX.WC_DW_LON_STA)
		FROM
			..DWXX_DW_CLC_CLU DWXX
		WHERE
			DWXX.BF_SSN = PDXX.DF_PRS_ID
			AND	DWXX.WC_DW_LON_STA IN ('XX', 'XX')
	) > X
GROUP BY
	PDXX.DF_PRS_ID,
	PDXX.DM_PRS_X,
	PDXX.DM_PRS_LST
		