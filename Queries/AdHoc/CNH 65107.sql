DROP TABLE IF EXISTS #DATA


SELECT DISTINCT
	 DF_PRS_ID,
	 DF_SPE_ACC_ID
INTO #DATA
FROM
(
SELECT DISTINCT
	PDXX.DF_PRS_ID,
	PDXX.DF_SPE_ACC_ID
FROM
	UDW..PDXX_PRS_ADR PDXX
	INNER JOIN UDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
	INNER JOIN UDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
WHERE
	DC_DOM_ST = 'WA'
	AND DC_ADR = 'L'
	AND DD_VER_ADR <= 'XX/XX/XXXX'
	AND DI_VLD_ADR = 'Y'

UNION ALL

SELECT DISTINCT
	PDXX.DF_PRS_ID,
	PDXX.DF_SPE_ACC_ID
FROM
	UDW..PDXX_PRS_INA PDXX
	INNER JOIN UDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
	INNER JOIN UDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
	INNER JOIN
	(
		SELECT
			DF_PRS_ID,
			MAX(DN_ADR_SEQ) AS DN_ADR_SEQ
		FROM
			UDW..PDXX_PRS_INA
		WHERE
			DD_VER_ADR_HST <= 'XX/XX/XXXX'
			AND DC_ADR_HST = 'L'
		GROUP BY
			DF_PRS_ID
	) MPDXX
		ON MPDXX.DF_PRS_ID = PDXX.DF_PRS_ID
		AND MPDXX.DN_ADR_SEQ = PDXX.DN_ADR_SEQ
WHERE
	DC_DOM_ST_HST = 'WA'
) POP

--SELECT * FROM #DATA

SELECT
	D.DF_SPE_ACC_ID AS ACCOUNT_NUMBER,
	SUM(LA_CUR_PRI) AS [BALANCE AS OF XX-XXXX]
FROM
	#DATA D
	INNER JOIN AuditUDW..LNXX_LON_DECXXXX LNXX
		ON LNXX.BF_SSN = D.DF_PRS_ID
		AND LNXX.LC_STA_LONXX = 'R'
		AND LNXX.LA_CUR_PRI > X
GROUP BY
	D.DF_SPE_ACC_ID
	

SELECT
	COUNT(DISTINCT LNXX.BF_SSN) AS [BORROWER COUNT],
	COUNT(*) AS [LOAN COUNT],
	SUM(LA_CUR_PRI) AS [TOTAL UNPAID PRINCIPAL]
FROM
	#DATA D
	INNER JOIN AuditUDW..LNXX_LON_DecXXXX LNXX
	ON LNXX.BF_SSN = D.DF_PRS_ID
	AND LNXX.LC_STA_LONXX = 'R'
	AND LNXX.LA_CUR_PRI > X