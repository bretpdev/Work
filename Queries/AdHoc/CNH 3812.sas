LIBNAME LEGEND REMOTE SERVER=LEGEND SLIBREF=WORK;
RSUBMIT;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;

/*issue X*/
DATA LC_RPD_INA_REA_HASH;
	SET PKUB.LNXX_LON_RPS;
	WHERE LC_RPD_INA_REA IN ('#','&');
RUN;

/*issue X*/
DATA LC_RPD_DIS_HASH;
	SET PKUB.LNXX_LON_RPS;
	WHERE LC_RPD_DIS = '#';
RUN;

/*issue X*/
DATA LC_RPD_DIS_BLANK;
	SET PKUB.RSXX_BR_RPD;
	WHERE LC_RPD_DIS = '';
RUN;

/*issue X*/
PROC SQL;
	CREATE TABLE PAY_NE AS
		SELECT
			RSXX.BF_SSN,
			RSXX.LN_PMN_STD_PAY,
			RSXX.BA_PMN_STD_TOT_PAY
		FROM
			(
				SELECT
					BF_SSN,
					SUM(LA_PMN_STD_PAY) AS LN_PMN_STD_PAY
				FROM
					PKUB.RSXX_IBR_IRL_LON
				GROUP BY
					BF_SSN
			) RSXX
			JOIN 
			(
				SELECT
					BF_SSN,
					SUM(BA_PMN_STD_TOT_PAY) AS BA_PMN_STD_TOT_PAY
				FROM
					PKUB.RSXX_IBR_RPS
				GROUP BY
					BF_SSN
			) RSXX
				ON RSXX.BF_SSN = RSXX.BF_SSN
		WHERE
			RSXX.LN_PMN_STD_PAY <> RSXX.BA_PMN_STD_TOT_PAY
	;

	CREATE TABLE RSXX_X AS
		SELECT
			RSXX.*
		FROM
			PAY_NE PAY
			JOIN PKUB.RSXX_IBR_IRL_LON RSXX
				ON PAY.BF_SSN = RSXX.BF_SSN
	;

	CREATE TABLE RSXX_X AS
		SELECT
			RSXX.*
		FROM
			PAY_NE PAY
			JOIN PKUB.RSXX_IBR_RPS RSXX
				ON PAY.BF_SSN = RSXX.BF_SSN
	;
QUIT;	

/*issue X & X*/
PROC SQL;
	CREATE TABLE LNXX AS
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			LNXX.LN_RPS_SEQ
		FROM
			PKUB.LNXX_LON_RPS LNXX
			JOIN PKUB.RSXX_BR_RPD RSXX
				ON LNXX.BF_SSN = RSXX.BF_SSN
				AND LNXX.LN_RPS_SEQ = RSXX.LN_RPS_SEQ
		WHERE 
			LNXX.LC_TYP_SCH_DIS IN ('IB', 'IL', 'CX', 'CX', 'CX', 'CQ', 'CA', 'CP')
			AND 
				(
					RSXX.BN_IBR_SEQ IS NULL
					OR
					RSXX.BD_CRT_RSXX IS NULL
				)
	;

	CREATE TABLE RSXX_X_X AS
		SELECT
			RSXX.*
		FROM
			LNXX
			JOIN PKUB.RSXX_IBR_IRL_LON RSXX
				ON LNXX.BF_SSN = RSXX.BF_SSN
				AND LNXX.LN_SEQ - RSXX.LN_SEQ
	;

	CREATE TABLE RSXX_X_X AS
		SELECT
			RSXX.*
		FROM
			LNXX
			JOIN PKUB.RSXX_BR_RPD RSXX
				ON LNXX.BF_SSN = RSXX.BF_SSN
				AND LNXX.LN_RPS_SEQ = RSXX.LN_RPS_SEQ
	;
QUIT;

ENDRSUBMIT;

PROC EXPORT
		DATA=LEGEND.LC_RPD_INA_REA_HASH
		OUTFILE='T:\SAS\ISSUE_X.XLSX'
		REPLACE;
	SHEET = 'X-LC_RPD_INA_REA_HASH';
RUN;

PROC EXPORT
		DATA=LEGEND.LC_RPD_DIS_HASH
		OUTFILE='T:\SAS\ISSUES.XLSX'
		REPLACE;
	SHEET = 'X-LC_RPD_DIS_HASH';
RUN;

PROC EXPORT
		DATA=LEGEND.LC_RPD_DIS_BLANK
		OUTFILE='T:\SAS\ISSUES.XLSX'
		REPLACE;
	SHEET = 'X-LC_RPD_DIS_BLANK';
RUN;

/*PROC EXPORT*/
/*		DATA=LEGEND.PAY_NE*/
/*		OUTFILE='T:\SAS\ISSUES.XLSX'*/
/*		REPLACE;*/
/*	SHEET = 'X-BD_CRT_RSXX_BLANK';*/
/*RUN;*/

PROC EXPORT
		DATA=LEGEND.RSXX_X
		OUTFILE='T:\SAS\ISSUES.XLSX'
		REPLACE;
	SHEET = 'X-RSXX';
RUN;

PROC EXPORT
		DATA=LEGEND.RSXX_X
		OUTFILE='T:\SAS\ISSUES.XLSX'
		REPLACE;
	SHEET = 'X-RSXX';
RUN;

PROC EXPORT
		DATA=LEGEND.RSXX_X_X
		OUTFILE='T:\SAS\ISSUES.XLSX'
		REPLACE;
	SHEET = 'X&X_RSXX';
RUN;


PROC EXPORT
		DATA=LEGEND.RSXX_X_X
		OUTFILE='T:\SAS\ISSUES.XLSX'
		REPLACE;
	SHEET = 'X&X_RSXX';
RUN;
