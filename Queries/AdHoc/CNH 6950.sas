LIBNAME LEGEND REMOTE SERVER=LEGEND SLIBREF=WORK;
RSUBMIT;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;


PROC SQL;
	
	CREATE TABLE ICR AS
		SELECT PDXX.DF_SPE_ACC_ID As AccountNumber, 
		LNXX.LN_SEQ as LoanSequence,
		LNXX.LC_TYP_SCH_DIS as RepaymentScheduleType,
		Case when LNXX.IC_LON_PGM in ('DLPCNS','DLSCNS','DLSSPL','DLUCNS','DLUSPL')
			 	then intnx('day',LNXX.LD_LON_X_DSB,X) 
			 	else intnx('day',LNXX.LD_END_GRC_PRD,X) 
		end format dateX. as OrigRepaymentStart,
		Case when LNXX.IC_LON_PGM in ('DLPCNS','DLSCNS','DLSSPL','DLUCNS','DLUSPL')
			    then (Date() - intnx('day',LNXX.LD_LON_X_DSB,X))/XX 
				else (Date() - intnx('day',LNXX.LD_END_GRC_PRD,X))/XX
        end as MonthsSinceRepayBegin
		FROM PKUB.PDXX_PRS_NME PDXX
			INNER JOIN PKUB.LNXX_LON LNXX
				ON PDXX.DF_PRS_ID = LNXX.BF_SSN
			INNER JOIN PKUB.DWXX_A DWXX
				ON DWXX.BF_SSN = LNXX.BF_SSN AND DWXX.LN_SEQ = LNXX.LN_SEQ
			INNER JOIN PKUB.LNXX_LON_RPS LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN AND LNXX.LN_SEQ = LNXX.LN_SEQ
		WHERE LNXX.LA_CUR_PRI > X AND LNXX.LC_TYP_SCH_DIS IN('CX','CX','CX') 
		AND DWXX.WC_DW_LON_STA NOT IN('XX','XX','XX','XX','XX','XX')
		AND LNXX.LC_STA_LONXX ='R'
	;
QUIT;

ENDRSUBMIT;

DATA ICR; SET LEGEND.ICR; RUN;

PROC EXPORT	
		DATA=LEGEND.ICR
		OUTFILE='T:\SAS\NH XXXX data dump.xlsx'
		REPLACE;
RUN;
