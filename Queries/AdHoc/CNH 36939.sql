--CNH XXXXX

SELECT DISTINCT
	PDXX.DF_SPE_ACC_ID,
	LNXX.LN_SEQ
	--,COALESCE(TRY_CONVERT(DATE,SUBSTRING(AYXX.LX_ATY,CHARINDEX('NEW SEP DT', AYXX.LX_ATY) + XX, XX)),'XXXX-XX-XX') AS SEPDT
	--,LNXX.LD_DLQ_OCC
	--,LNXX.LF_STU_SSN
	--,CONCAT(SUBSTRING(AYXX.LX_ATY,CHARINDEX('SSN VERIFIED', AYXX.LX_ATY) + XX, X), SUBSTRING(AYXX.LX_ATY,CHARINDEX('SSN VERIFIED', AYXX.LX_ATY) + XX, X), SUBSTRING(AYXX.LX_ATY,CHARINDEX('SSN VERIFIED', AYXX.LX_ATY) + XX, X)) AS LX_SSN
	--,AYXX.LX_ATY
	

FROM
	CDW..PDXX_PRS_NME PDXX
	INNER JOIN CDW..LNXX_LON LNXX
		ON PDXX.DF_PRS_ID = LNXX.BF_SSN
	INNER JOIN CDW..LNXX_LON_DLQ_HST LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN CDW..AYXX_BR_LON_ATY AYXX
		ON LNXX.BF_SSN = AYXX.BF_SSN
	INNER JOIN CDW..AYXX_ATY_TXT AYXX
		ON AYXX.BF_SSN = AYXX.BF_SSN
		AND AYXX.LN_ATY_SEQ = AYXX.LN_ATY_SEQ
WHERE
	LNXX.IC_LON_PGM = 'DLPLUS'
	AND LNXX.LA_CUR_PRI > X.XX
	AND LNXX.LC_STA_LONXX = 'R'
	AND LNXX.LC_STA_LONXX = X
	AND LNXX.LN_DLQ_MAX > X
	AND LNXX.LI_DFR_REQ_ON_APL = 'Y'
	AND AYXX.PF_REQ_ACT = 'PSXXX'
	AND AYXX.LD_ATY_RSP > LNXX.LD_DLQ_OCC
	AND AYXX.LX_ATY LIKE ('%SSN VERIFIED%')
	AND (AYXX.LX_ATY LIKE ('%ENROLL STA - XX - FT%') OR AYXX.LX_ATY LIKE ('%ENROLL STA - XX - HT%'))
	AND AYXX.LX_ATY LIKE ('%NEW SEP DT%')
	AND COALESCE(TRY_CONVERT(DATE,SUBSTRING(AYXX.LX_ATY,CHARINDEX('NEW SEP DT', AYXX.LX_ATY) + XX, XX)),'XXXX-XX-XX') > CAST(LNXX.LD_DLQ_OCC AS DATE) --substitute invalid dates with one that fails the condition to avoid errors
	AND CONCAT(SUBSTRING(AYXX.LX_ATY,CHARINDEX('SSN VERIFIED', AYXX.LX_ATY) + XX, X), SUBSTRING(AYXX.LX_ATY,CHARINDEX('SSN VERIFIED', AYXX.LX_ATY) + XX, X), SUBSTRING(AYXX.LX_ATY,CHARINDEX('SSN VERIFIED', AYXX.LX_ATY) + XX, X)) = LNXX.LF_STU_SSN
	--AND PDXX.DF_SPE_ACC_ID = ''
ORDER BY
	PDXX.DF_SPE_ACC_ID,
	LNXX.LN_SEQ