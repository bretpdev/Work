USE CDW
GO


SELECT DISTINCT
	AYXX.BF_SSN,
	PDXX.DF_SPE_ACC_ID,
	AYXX.LD_ATY_REQ_RCV,
	AYXX.PF_REQ_ACT,
	AYXX.LX_ATY
FROM
	PDXX_PRS_NME PDXX
	INNER JOIN AYXX_BR_LON_ATY AYXX
		ON AYXX.BF_SSN = PDXX.DF_PRS_ID
	INNER JOIN
	(
		SELECT 
			BF_SSN,
			LN_ATY_SEQ,
			STUFF(
			(
				SELECT 
					 ' ' + SUB.LX_ATY AS [text()]
				FROM 
					AYXX_ATY_TXT SUB
				WHERE
					SUB.BF_SSN = AYXX.BF_SSN
					AND SUB.LN_ATY_SEQ = AYXX.LN_ATY_SEQ
			FOR XML PATH('')
			)
			,X,X, '')
			AS LX_ATY
		FROM	
			AYXX_ATY_TXT AYXX
	)AYXX
		ON AYXX.BF_SSN = AYXX.BF_SSN
		AND AYXX.LN_ATY_SEQ = AYXX.LN_ATY_SEQ
WHERE
	AYXX.PF_REQ_ACT IN ('SCRAD','DFDNY')
	AND AYXX.LC_STA_ACTYXX = 'A'
	AND AYXX.LD_ATY_REQ_RCV BETWEEN 'XX/XX/XXXX' AND  'XX/XX/XXXX'
	and AYXX.LX_ATY LIKE '%MIL%'
ORDER BY
	DF_SPE_ACC_ID,
	LD_ATY_REQ_RCV

