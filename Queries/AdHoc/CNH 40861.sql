USE CDW
GO
--T:\Consol precon\NAtoCSTLCXXXXXXXX_X.xlsx                                                           
SELECT DISTINCT
	PDXX.DF_PRS_ID,
	LTRIM(RTRIM(PDXX.DM_PRS_X)) + ' ' + LTRIM(RTRIM(PDXX.DM_PRS_LST)) AS [NAME],
	cnh.CONFRIMATION_DATE,
	CNH.[CONSOLIDATION LOAN ID_(AWARD ID)] AS AWARD_ID,
	LNXX.IC_LON_PGM,
	LD_DSB,
	LNXX.LR_ITR as system_rate,
	cast((cnh.Interst_rate_from_file * XXX) as numeric(XX,X)) as file_rate,
	CASE WHEN LNXX.LR_INT_RDC_PGM_ORG != cast((cnh.Interst_rate_from_file * XXX) as numeric(XX,X)) THEN X ELSE X END,
	cnh.FileName
FROM
	CDW..[CNH XXXXX_VX] CNH
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = RIGHT('XXXXXXXX' + LTRIM(RTRIM(STR(SSSN))),  X)
	INNER JOIN  CDW..FSXX_DL_LON FSXX
		ON FSXX.BF_SSN = PDXX.DF_PRS_ID
		AND FSXX.LF_FED_AWD = SUBSTRING(LTRIM(RTRIM(CNH.[CONSOLIDATION LOAN ID_(AWARD ID)])),X,XX)
		AND FSXX.LN_FED_AWD_SEQ = CAST(SUBSTRING(LTRIM(RTRIM(CNH.[CONSOLIDATION LOAN ID_(AWARD ID)])), XX,X) AS INT)
	INNER JOIN CDW..LNXX_LON LNXX
		ON LNXX.BF_SSN = FSXX.BF_SSN
		AND LNXX.LN_SEQ = FSXX.LN_SEQ
	INNER JOIN CDW..LNXX_DSB LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN
	(
		SELECT
			LNXX.BF_SSN,
			LNXX.LN_SEQ,
			LNXX.LR_ITR,
			LR_INT_RDC_PGM_ORG,
			ROW_NUMBER() OVER (PARTITION BY LNXX.BF_SSN, LNXX.LN_SEQ ORDER BY LD_STA_LONXX DESC) AS SEQ
		FROM
			LNXX_INT_RTE_HST LNXX
		WHERE
			LNXX.LC_STA_LONXX = 'A'
			AND CAST(GETDATE() AS DATE) BETWEEN LNXX.LD_ITR_EFF_BEG AND LNXX.LD_ITR_EFF_END
	) LNXX 
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
		AND LNXX.SEQ = X
                                                          