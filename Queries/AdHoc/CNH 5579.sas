/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;

LIBNAME  LEGEND  REMOTE  SERVER=LEGEND SLIBREF=work  ;
FILENAME REPORTZ "&RPTLIB/Weekly BalancesRZ";
FILENAME REPORTX "&RPTLIB/UNWSXX.NWSXXRX";

DATA _NULL_;
	RUN_DAY = TODAY();
	CALL SYMPUT('MON_AGO_X_BEG',"'"||PUT(INTNX('MONTH',RUN_DAY,-X,'B'), MMDDYYDXX.)||"'");
	CALL SYMPUT('MON_AGO_X_END',"'"||PUT(INTNX('MONTH',RUN_DAY,-X,'E'), MMDDYYDXX.)||"'");
	CALL SYMPUT('RUN_DATE',RUN_DAY);
	CALL SYMPUTX('TITLE_DATE',PUT(INTNX('DAY',RUN_DAY,-X,'E'), worddateXX.));
RUN;
%SYSLPUT MON_AGO_X_BEG = &MON_AGO_X_BEG;
%SYSLPUT MON_AGO_X_END = &MON_AGO_X_END;
RSUBMIT LEGEND;
LIBNAME LGND '/sas/whse/progrevw';
PROC SQL;
CONNECT TO DBX (DATABASE=DNFPUTDL);
CREATE TABLE MSBTFF AS 
SELECT *
FROM CONNECTION TO DBX (
	SELECT E.DF_SPE_ACC_ID
		,B.BF_SSN
		,B.LN_SEQ
		,B.IC_LON_PGM
		,B.LC_FED_PGM_YR
		,B.LF_FED_CLC_RSK
		,B.LA_CUR_PRI AS LA_FAT_CUR_PRI
		,D.LA_FMS_MTH_INT_ADJ
		,D.LA_FMS_MTH_INT_ACR
		,G.WA_TOT_BRI_OTS AS INT_FINAL
		,B.LA_LTE_FEE_OTS AS LA_FAT_LTE_FEE
		,COALESCE(DAYS(CURRENT DATE) - DAYS(F.LD_DLQ_OCC),X) AS DAYS_DELQ
		,B.LA_CUR_PRI AS LA_OTS_PRI_ELG
		,G.WC_DW_LON_STA
	FROM PKUB.LNXX_LON B
		LEFT OUTER JOIN (
			SELECT BF_SSN
				,LN_SEQ
				,SUM(LA_FMS_MTH_INT_ADJ) AS LA_FMS_MTH_INT_ADJ
				,SUM(LA_FMS_MTH_INT_ACR) AS LA_FMS_MTH_INT_ACR
			FROM PKUR.FRXX_MTH_INT_RPT
			GROUP BY BF_SSN
				,LN_SEQ
			) D
			ON B.BF_SSN = D.BF_SSN
			AND B.LN_SEQ = D.LN_SEQ
		LEFT OUTER JOIN PKUB.PDXX_PRS_NME E
			ON B.BF_SSN = E.DF_PRS_ID
		LEFT OUTER JOIN PKUB.LNXX_LON_DLQ_HST F
			ON B.BF_SSN = F.BF_SSN
			AND B.LN_SEQ = F.LN_SEQ
			AND F.LC_STA_LONXX = 'X'
			AND F.LC_DLQ_TYP = 'P'
		LEFT OUTER JOIN  PKUB.DWXX_A G
			ON B.BF_SSN = G.BF_SSN
			AND B.LN_SEQ = G.LN_SEQ
	WHERE 
		(B.LA_CUR_PRI != X AND B.LC_STA_LONXX IN ('R','L'))
		OR 
		DAYS(B.LD_PIF_RPT) > DAYS(CURRENT DATE) - X
	)  
	;
DISCONNECT FROM DBX;
QUIT;
ENDRSUBMIT;
DATA MSBTFF;
	SET LEGEND.MSBTFF;
RUN;

DATA MSBTFF;
	SET MSBTFF;
	IF WC_DW_LON_STA IN ('XX','XX','XX','XX') AND DAYS_DELQ <= XX AND LA_FAT_CUR_PRI >= X THEN LS = 'XA';
	ELSE IF WC_DW_LON_STA IN ('XX','XX','XX','XX') AND DAYS_DELQ > XX AND LA_FAT_CUR_PRI >= X THEN LS = 'XB';
	ELSE IF WC_DW_LON_STA IN (
		'XX','XX','XX','XX','XX','XX','XX','XX','XX','XX','XX','XX','XX','XX','XX'
		) AND LA_FAT_CUR_PRI >= X THEN LS = 'IS';
	ELSE IF LA_FAT_CUR_PRI < X THEN LS = 'CB';
	ELSE LS = WC_DW_LON_STA;
	if LA_FAT_LTE_FEE = . then LA_FAT_LTE_FEE = X;
RUN;

PROC SORT DATA=MSBTFF;
	BY BF_SSN LS;
RUN;

DATA MSBTFF;
	SET MSBTFF;
	BY BF_SSN LS;
	IF FIRST.BF_SSN and first.ls THEN BSC = X;
	ELSE BSC = X;
	LOAN_IND = X;
	HAS_AMT = (LA_FAT_CUR_PRI>X|INT_FINAL>X);
RUN;

PROC FORMAT;
	VALUE $LNSTA
	'XA' = 'In Repayment(X-XX days delinquent)'
	'XB' = 'In Repayment(>XX days delinquent)'
	'XX' = 'Grace'
	'XX' = 'In School'
	'XX' = 'In Deferment'
	'XX' = 'In Forbearance'
	'XX' = 'PIF'
	'IS' = 'In Suspense/Specialty'
	'CB' = 'PIF w/ Credit Balance'
	'XX' = 'Other';
RUN;

ODS _ALL_ CLOSE;
ODS LISTING;
PROC PRINTTO PRINT=REPORTX NEW; RUN;
OPTIONS ORIENTATION = LANDSCAPE NODATE PAGENO=X ;
OPTIONS PS=XX LS=XXX;
TITLE 'Weekly Portfolio Balance Report';
TITLEX "&TITLE_DATE";
FOOTNOTE 'JOB = Weekly Balancing 	 REPORT = WeeklyBalancingRX';
PROC REPORT DATA=MSBTFF NOWD HEADSKIP SPLIT='~' SPACING=X;
	COLUMN LS BSC LOAN_IND LA_FAT_CUR_PRI INT_FINAL LA_FAT_LTE_FEE;
	DEFINE LS / GROUP FORMAT=$LNSTA. 'LOAN STATUS'; 
	DEFINE BSC / SUM FORMAT=COMMAX. 'TOTAL BORROWER COUNT';
	DEFINE LOAN_IND / SUM  FORMAT=COMMAX. 'TOTAL LOAN COUNT';
	DEFINE LA_FAT_CUR_PRI / SUM FORMAT=COMMAXX.X 'PRINCIPAL~BALANCE';
	DEFINE INT_FINAL / SUM FORMAT=COMMAXX.X 'INTEREST~BALANCE';
	DEFINE LA_FAT_LTE_FEE / SUM FORMAT=COMMAXX.X 'LATE FEE~BALANCE';
	RBREAK AFTER / SUMMARIZE ;
RUN;
PROC PRINTTO;
RUN;

/*export to Excel spreadsheet*/
PROC EXPORT DATA = WORK.MSBTFF
            OUTFILE = "T:\SAS\NH XXXX.xlsx" 
            DBMS = EXCEL
			REPLACE;
     SHEET="A"; 
RUN;

