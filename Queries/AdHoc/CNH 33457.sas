LIBNAME XL 'T:\DirLetter.EmailJanXXXX.xlsx';
DATA _XLSOURCE;
	SET XL.'SheetX$'N;
	KEEP SSN;
RUN;
LIBNAME XL CLEAR;

PROC SQL;
	CREATE TABLE INVALID_SSN AS
	SELECT
		*
	FROM
		_XLSOURCE
	WHERE
		LENGTH(SSN) > X;
QUIT;

DATA XLSOURCE;
	LENGTH SSNX $X.;
	SET _XLSOURCE;
	SSNX = SSN;
	IF LENGTH(SSN) > X
	THEN SSNX = SUBSTR(SSN,X,X);
RUN;

LIBNAME LEGEND REMOTE SERVER=LEGEND SLIBREF=WORK;
DATA LEGEND.XLSOURCE;
	SET XLSOURCE;
RUN;

RSUBMIT LEGEND;
LIBNAME PKUB DBX DATABASE=DNFPUTDL OWNER=PKUB;
LIBNAME AES DBX DATABASE=DNFPUTDL OWNER=AES;
PROC SQL;
	CREATE TABLE EMAILS AS
		SELECT 
			XL.SSNX AS SSN
			,PHXX.DX_CNC_EML_ADR
		FROM 
			XLSOURCE XL
			LEFT JOIN PKUB.PDXX_PRS_NME PDXX
				ON XL.SSNX = PDXX.DF_PRS_ID
			LEFT JOIN AES.PHXX_CNC_EML PHXX
				ON PDXX.DF_SPE_ACC_ID = PUT(PHXX.DF_SPE_ID,XX.)
		;
QUIT;
ENDRSUBMIT;

DATA EMAILS; 
	SET LEGEND.EMAILS; 
RUN;

PROC EXPORT
	DATA=EMAILS
	OUTFILE='T:\SAS\CNH XXXXX.xlsx'
	REPLACE;
RUN;

PROC EXPORT
	DATA=INVALID_SSN
	OUTFILE='T:\SAS\CNH XXXXX.xlsx'
	REPLACE;
RUN;
