USE ODW
GO

SELECT
	PD01.DF_PRS_ID,
	PD01.DF_SPE_ACC_ID,
	PD01.Loans,
	PD01.Balance
FROM
	(
		SELECT
			DF_PRS_ID,
			DF_SPE_ACC_ID,
			GA01.AF_APL_ID,
			COUNT(AF_APL_ID_SFX) AS Loans,
			SUM(AA_CUR_PRI) AS Balance
		FROM
			PD01_PDM_INF PD01
			INNER JOIN GA01_APP GA01
				ON GA01.DF_PRS_ID_BR = PD01.DF_PRS_ID
			INNER JOIN GA10_LON_APP GA10
				ON GA10.AF_APL_ID = GA10.AF_APL_ID
		GROUP BY
			DF_PRS_ID,
			DF_SPE_ACC_ID,
			GA01.AF_APL_ID
	) PD01
	INNER JOIN 
	(
		SELECT DISTINCT
			DC01.BF_SSN,
			DC01.AF_APL_ID,
			MAX(DC01.LF_CRT_DTS_DC10) AS MaxDate
		FROM
			ODW..DC01_LON_CLM_INF DC01
	
		WHERE
			DC01.LC_PCL_REA = 'DF'
			AND LF_CRT_DTS_DC10 >= CAST('2020-03-13' AS DATE)
			--AND DC01.LC_STA_DC10 = '03'
			--AND DC01.LD_CLM_ASN_DOE IS NULL
			--AND LTRIM(ISNULL(DC01.LC_AUX_STA,'')) = ''
			--AND ISNULL(DC01.LC_REA_CLM_ASN_DOE,'') = ''
		
		GROUP BY
			DC01.BF_SSN,
			DC01.AF_APL_ID
	) DC01
		ON DC01.BF_SSN = PD01.DF_PRS_ID