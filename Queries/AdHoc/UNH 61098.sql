USE ODW;
GO

--list of distinct SSN's from SAS compiling list of 7 files provided by Peter Busche
DECLARE @SCRA TABLE (SSN VARCHAR(9));
INSERT INTO @SCRA (SSN) VALUES
('273463068'),
('291880594'),
('401887157'),
('525176382'),
('527998633'),
('528334056'),
('528998841'),
('529877328'),
('529878946'),
('529946875'),
('536063289'),
('575631010'),
('600027704'),
('607057249');
--SELECT * FROM @SCRA;

DROP TABLE IF EXISTS #DC02;
SELECT * INTO #DC02 FROM OPENQUERY (DUSTER,'
SELECT
	*
FROM
	OLWHRM1.DC02_BAL_INT 
WHERE 
	BF_SSN IN
	(
		''273463068'',
		 ''291880594'',
		 ''401887157'',
		 ''525176382'',
		 ''527998633'',
		 ''528334056'',
		 ''528998841'',
		 ''529877328'',
		 ''529878946'',
		 ''529946875'',
		 ''536063289'',
		 ''575631010'',
		 ''600027704'',
		 ''607057249''
	)
 ');
 --SELECT * FROM #DC02 WHERE LR_CUR_INT >= 6.00
	--						AND LF_CRT_DTS_DC10 >= 10/01/2017
;

SELECT DISTINCT
	 PD01.DF_PRS_ID
	,PD01.DM_PRS_1
	,PD01.DM_PRS_MID
	,PD01.DM_PRS_LST
	,GA10.AC_LON_TYP
	,CONCAT(GA10.AF_APL_ID, GA10.AF_APL_ID_SFX) AS 'AF_APL_ID concat AF_APL_ID_SFX'
	,CONVERT(VARCHAR, (MIN(GA11.AD_DSB_ADJ) OVER(PARTITION BY GA11.AF_APL_ID, GA11.AF_APL_ID_SFX)), 101) AS DisbursementDate
	,PD01.DD_BRT
	,DC15.LD_ITR_BEG
	,DC15.LD_ITR_END
	,DC15.LR_ITR

	--VALIDATION:
	--,DC01.LC_STA_DC10
	--,DC01.LD_STA_UPD_DC10
	--,GA11.AC_DSB_ADJ
	--,GA11.AC_DSB_ADJ_STA
	--,GA11.AN_DSB_SEQ
	,DC02.LR_CUR_INT
	,DC02.LF_CRT_DTS_DC10
FROM
	GA01_APP GA01
	INNER JOIN GA10_LON_APP GA10
		ON GA01.AF_APL_ID = GA10.AF_APL_ID
	INNER JOIN GA11_LON_DSB_ATY GA11
		ON GA10.AF_APL_ID = GA11.AF_APL_ID
		AND GA10.AF_APL_ID_SFX = GA11.AF_APL_ID_SFX
	INNER JOIN ODW..PD01_PDM_INF PD01
		ON GA01.DF_PRS_ID_BR = PD01.DF_PRS_ID
	INNER JOIN @SCRA SCRA
		ON PD01.DF_PRS_ID = SCRA.SSN
	INNER JOIN DC01_LON_CLM_INF DC01
		ON GA10.AF_APL_ID = DC01.AF_APL_ID
		AND GA10.AF_APL_ID_SFX = DC01.AF_APL_ID_SFX 
	INNER JOIN #DC02 DC02
		ON GA10.AF_APL_ID = DC02.AF_APL_ID
		AND GA10.AF_APL_ID_SFX = DC02.AF_APL_ID_SFX 
	LEFT JOIN DC15_LON_ITR DC15
		ON GA10.AF_APL_ID = DC15.AF_APL_ID
		AND GA10.AF_APL_ID_SFX = DC15.AF_APL_ID_SFX
WHERE
	DC01.LC_STA_DC10 = '03'
	AND DC01.LD_STA_UPD_DC10 <= CONVERT(DATE,'20180930')--09/30/2018-- Current status date (LC05)
	AND GA11.AC_DSB_ADJ IN ('A','C','P','S','U')
	AND GA11.AC_DSB_ADJ_STA = 'A'
	AND GA11.AN_DSB_SEQ < 5
	AND DC02.LR_CUR_INT >= 6
	--AND DC02.LF_CRT_DTS_DC10 >= CONVERT(DATE, '20171001')
	
;