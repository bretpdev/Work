DROP TABLE IF EXISTS #DATA
DROP TABLE IF EXISTS #final

SELECT DISTINCT
	MAYXX.LD_ATY_REQ_RCV,
	MAYXX.LN_ATY_SEQ,
	LNXX.BF_SSN,
	LNXX.LN_SEQ,
	LNXX.LA_CUR_PRI,
	DWXX.WA_TOT_BRI_OTS
INTO #DATA
FROM
	CDW..LNXX_LON LNXX
	INNER JOIN CDW..DWXX_DW_CLC_CLU DWXX
		ON DWXX.BF_SSN = LNXX.BF_SSN
		AND DWXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN 
	(
		SELECT
			AYXX.BF_SSN,
			MAX(AYXX.LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV,
			MAX(AYXX.LN_ATY_SEQ) AS LN_ATY_SEQ
		FROM
			CDW..AYXX_BR_LON_ATY AYXX
		WHERE
			AYXX.PF_REQ_ACT = 'CSDNY'
			AND AYXX.LC_STA_ACTYXX = 'A'
		GROUP BY
			AYXX.BF_SSN
	) MAYXX
		ON MAYXX.BF_SSN = LNXX.BF_SSN
	INNER JOIN CDW..LNXX_LON_ATY LNXX
		ON LNXX.BF_SSN = MAYXX.BF_SSN
		AND LNXX.LN_ATY_SEQ = MAYXX.LN_ATY_SEQ
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	LEFT JOIN CDW..AYXX_BR_LON_ATY AYXX
		ON AYXX.BF_SSN = LNXX.BF_SSN
		AND AYXX.PF_REQ_ACT = 'ADCSH'

	
WHERE
	AYXX.BF_SSN IS NULL
	AND LNXX.LF_DOE_SCL_ORG IN 
	(
	'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX',
'XXXXXXXX'

	)


SELECT
	D.BF_SSN,
	D.LN_SEQ,
	CMT.LX_ATY,
	LA_CUR_PRI AS CURRENT_BALANCE,
	WA_TOT_BRI_OTS AS CURRENT_INTEREST_BALANCE,
	SUM(ISNULL(LA_FAT_CUR_PRI,X.XX)) AS BALANCE_AT_TIME_OF_DENIAL
into #final
FROM
	CDW..LNXX_FIN_ATY LNXX
	INNER JOIN #DATA D
		ON D.BF_SSN = LNXX.BF_SSN
		AND D.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN
	(
		SELECT DISTINCT
		AYXX.BF_SSN,
		AYXX.LN_ATY_SEQ,
		STUFF(
		(
			SELECT 
					' ' + SUB.LX_ATY AS [text()]
			FROM 
				AYXX_ATY_TXT SUB
			WHERE
				SUB.BF_SSN = AYXX.BF_SSN
				AND SUB.LN_ATY_SEQ = AYXX.LN_ATY_SEQ
		FOR XML PATH('')
		)
		,X,X, '') AS LX_ATY
			
	FROM	
		AYXX_BR_LON_ATY AYXX
		INNER JOIN AYXX_ATY_TXT AYXX
			ON AYXX.BF_SSN = AYXX.BF_SSN
			AND AYXX.LN_ATY_SEQ = AYXX.LN_ATY_SEQ
	WHERE
		AYXX.PF_REQ_ACT = 'CSDNY'
		AND AYXX.LC_STA_ACTYXX = 'A'
	) CMT
		ON CMT.BF_SSN = D.BF_SSN
		AND CMT.LN_ATY_SEQ = D.LN_ATY_SEQ
	LEFT JOIN CDW..AYXX_BR_LON_ATY AYXX
		ON AYXX.BF_SSN = D.BF_SSN
		AND AYXX.PF_REQ_ACT = 'ADCSH'
WHERE
	LNXX.LD_FAT_EFF <= D.LD_ATY_REQ_RCV
	AND AYXX.BF_SSN IS NULL
GROUP BY
	D.LD_ATY_REQ_RCV,
	D.LN_ATY_SEQ,
	D.BF_SSN,
	D.LN_SEQ,
	CMT.LX_ATY,
	LA_CUR_PRI,
	WA_TOT_BRI_OTS


SELECT
	COUNT(DISTINCT BF_SSN) AS BORROWER_COUNT,
	COUNT(*) AS LOAN_COUNT,
	SUM(BALANCE_AT_TIME_OF_DENIAL) AS TOTAL_BALANCE
FROM
	#FINAL

SELECT * FROM #FINAL