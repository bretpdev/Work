USE ODW
GO

DECLARE @POP TABLE
(
	SSN VARCHAR(9)
)

INSERT INTO @POP(SSN)
VALUES
('001767145'),
('003683707'),
('008641193'),
('016705610'),
('019528398'),
('021621247'),
('028702014'),
('036585798'),
('039541008'),
('048601065'),
('058828106'),
('081589643'),
('098388695'),
('099749805'),
('105481692'),
('125529566'),
('135607859'),
('157646456'),
('190609882'),
('219609041'),
('227376478'),
('229049510'),
('231476286'),
('234193460'),
('253259456'),
('254613727'),
('259396344'),
('259619422'),
('262533600'),
('267557877'),
('272887414'),
('288887504'),
('313860948'),
('314987915'),
('323625120'),
('332781200'),
('338686434'),
('338782732'),
('342700318'),
('348648445'),
('354744309'),
('357583136'),
('385900741'),
('392664265'),
('396929339'),
('406319040'),
('408049031'),
('411554097'),
('414412220'),
('417114825'),
('425417856'),
('427511498'),
('431596003'),
('431695110'),
('431751438'),
('437459080'),
('444681683'),
('446884204'),
('454671083'),
('457670846'),
('460114121'),
('464895974'),
('465798260'),
('466412321'),
('466870583'),
('468020379'),
('469239603'),
('471040924'),
('471136049'),
('474047281'),
('474706676'),
('476687651'),
('479024413'),
('481043518'),
('483139560'),
('490768299'),
('497764122'),
('497905680'),
('498589748'),
('500863754'),
('500981210'),
('502988032'),
('504025058'),
('505885223'),
('506114709'),
('509942329'),
('510942939'),
('513684057'),
('513988792'),
('515925617'),
('516193841'),
('516989267'),
('518028227'),
('518062493'),
('518115095'),
('518137986'),
('518156612'),
('518159622'),
('518179919'),
('518194127'),
('518194459'),
('518257168'),
('518258643'),
('518358165'),
('518434167'),
('518707586'),
('518764904'),
('518806804'),
('518905736'),
('518942197'),
('518948682'),
('519020824'),
('519027173'),
('519042197'),
('519044082'),
('519060460'),
('519060920'),
('519116490'),
('519132426'),
('519154391'),
('519156720'),
('519174451'),
('519239618'),
('519259010'),
('519273647'),
('519291357'),
('519330767'),
('519357030'),
('519700166'),
('519969138'),
('519969477'),
('520068659'),
('520117071'),
('520191958'),
('520197838'),
('520215628'),
('520238975'),
('520681135'),
('520747774'),
('520942441'),
('520967046'),
('521197637'),
('521571432'),
('522210977'),
('522296651'),
('522395591'),
('522653087'),
('523257779'),
('523412326'),
('523598063'),
('523940367'),
('524066939'),
('524452960'),
('525137995'),
('525176382'),
('525290279'),
('525672842'),
('525755758'),
('525873180'),
('526193878'),
('526632329'),
('526814246'),
('526878152'),
('527218356'),
('527615241'),
('527677574'),
('527891281'),
('528043049'),
('528062149'),
('528064814'),
('528080648'),
('528086894'),
('528087015'),
('528134539'),
('528191701'),
('528216599'),
('528217688'),
('528231752'),
('528237779'),
('528252656'),
('528253893'),
('528256118'),
('528270996'),
('528275916'),
('528290872'),
('528291494'),
('528293858'),
('528316290'),
('528319147'),
('528319282'),
('528330625'),
('528332211'),
('528332273'),
('528332364'),
('528336205'),
('528337521'),
('528352259'),
('528357414'),
('528358056'),
('528371374'),
('528372280'),
('528376780'),
('528379865'),
('528391273'),
('528391883'),
('528393116'),
('528394415'),
('528395464'),
('528397109'),
('528398624'),
('528416506'),
('528430691'),
('528433964'),
('528434527'),
('528435518'),
('528437952'),
('528438040'),
('528459821'),
('528473275'),
('528473609'),
('528473708'),
('528473761'),
('528474776'),
('528475201'),
('528475476'),
('528476106'),
('528499206'),
('528514359'),
('528514506'),
('528531613'),
('528536147'),
('528536164'),
('528538165'),
('528552566'),
('528554804'),
('528555544'),
('528556277'),
('528570814'),
('528572232'),
('528575564'),
('528576637'),
('528594263'),
('528594961'),
('528595544'),
('528599438'),
('528610022'),
('528610986'),
('528611140'),
('528612546'),
('528630911'),
('528634498'),
('528636948'),
('528637936'),
('528637949'),
('528638302'),
('528639109'),
('528651787'),
('528652095'),
('528654781'),
('528654816'),
('528654873'),
('528670726'),
('528673659'),
('528674998'),
('528675103'),
('528675695'),
('528675859'),
('528678452'),
('528678931'),
('528679003'),
('528691254'),
('528691298'),
('528693548'),
('528694465'),
('528695178'),
('528697545'),
('528697576'),
('528710276'),
('528711793'),
('528714434'),
('528716919'),
('528718043'),
('528719753'),
('528731314'),
('528732855'),
('528733811'),
('528735886'),
('528736278'),
('528736695'),
('528739063'),
('528751345'),
('528752274'),
('528752745'),
('528752893'),
('528754906'),
('528773358'),
('528776978'),
('528778298'),
('528779765'),
('528779954'),
('528792588'),
('528797169'),
('528797416'),
('528804674'),
('528814333'),
('528817463'),
('528817465'),
('528818299'),
('528818479'),
('528830309'),
('528851777'),
('528853441'),
('528870506'),
('528870724'),
('528875587'),
('528892937'),
('528893435'),
('528896490'),
('528897099'),
('528899634'),
('528899661'),
('528900058'),
('528913589'),
('528913933'),
('528913973'),
('528914595'),
('528918493'),
('528934311'),
('528940888'),
('528945802'),
('528951352'),
('528955936'),
('528957376'),
('528968990'),
('528973070'),
('528976921'),
('528977856'),
('528980097'),
('528981293'),
('528981308'),
('528983944'),
('528986485'),
('528986793'),
('528994701'),
('528996979'),
('529023384'),
('529047362'),
('529047996'),
('529048272'),
('529060165'),
('529064527'),
('529066761'),
('529069034'),
('529083532'),
('529084292'),
('529085039'),
('529087050'),
('529089692'),
('529089964'),
('529118109'),
('529130568'),
('529135581'),
('529137316'),
('529138670'),
('529154474'),
('529154524'),
('529156371'),
('529158188'),
('529170639'),
('529179633'),
('529193272'),
('529193592'),
('529194954'),
('529197306'),
('529230389'),
('529231825'),
('529234649'),
('529237497'),
('529239580'),
('529254553'),
('529255296'),
('529257226'),
('529274350'),
('529278878'),
('529293980'),
('529296712'),
('529310587'),
('529314147'),
('529330612'),
('529330928'),
('529338165'),
('529339591'),
('529356273'),
('529359546'),
('529370070'),
('529370707'),
('529374558'),
('529375101'),
('529376783'),
('529390075'),
('529390081'),
('529390592'),
('529396928'),
('529397017'),
('529397613'),
('529411589'),
('529412109'),
('529416993'),
('529417502'),
('529418608'),
('529419520'),
('529435054'),
('529435957'),
('529437820'),
('529451065'),
('529451316'),
('529451971'),
('529456560'),
('529458318'),
('529459317'),
('529459512'),
('529470666'),
('529472155'),
('529474511'),
('529474738'),
('529475328'),
('529476476'),
('529478164'),
('529479455'),
('529479917'),
('529490667'),
('529491036'),
('529491293'),
('529511274'),
('529511619'),
('529512017'),
('529514441'),
('529517420'),
('529518280'),
('529531978'),
('529535975'),
('529550392'),
('529555284'),
('529557152'),
('529572746'),
('529578447'),
('529593016'),
('529593309'),
('529610767'),
('529612668'),
('529617568'),
('529618244'),
('529630576'),
('529633516'),
('529637835'),
('529654892'),
('529659484'),
('529671783'),
('529675015'),
('529690748'),
('529708161'),
('529710307'),
('529710391'),
('529710651'),
('529711753'),
('529715256'),
('529716083'),
('529730189'),
('529734867'),
('529750463'),
('529752020'),
('529756969'),
('529757923'),
('529769144'),
('529770730'),
('529770801'),
('529772693'),
('529772884'),
('529793271'),
('529797494'),
('529797614'),
('529812968'),
('529818499'),
('529819183'),
('529822622'),
('529831188'),
('529831837'),
('529837976'),
('529838720'),
('529855476'),
('529857765'),
('529862603'),
('529871380'),
('529875265'),
('529876569'),
('529878589'),
('529879490'),
('529890073'),
('529891689'),
('529891833'),
('529893066'),
('529896820'),
('529905949'),
('529911069'),
('529913619'),
('529935149'),
('529938162'),
('529945217'),
('529952427'),
('529952654'),
('529953032'),
('529958902'),
('529959473'),
('529963672'),
('529972800'),
('529973704'),
('529978674'),
('529981805'),
('529983398'),
('529984360'),
('529989498'),
('529999819'),
('530043700'),
('530110815'),
('530118753'),
('530130365'),
('530215242'),
('530261139'),
('530275034'),
('530314542'),
('530376246'),
('530438694'),
('530582504'),
('530584984'),
('530869349'),
('530883269'),
('530926318'),
('531083404'),
('531940414'),
('532728114'),
('534114467'),
('534173494'),
('534211785'),
('536080319'),
('536866203'),
('538068180'),
('538173376'),
('539862385'),
('540251229'),
('540864446'),
('541177752'),
('544118351'),
('544255070'),
('545475442'),
('545910986'),
('546081371'),
('546211108'),
('546337430'),
('546746719'),
('546810636'),
('546991717'),
('547751870'),
('547954934'),
('548871718'),
('549171315'),
('550518545'),
('550791905'),
('550997814'),
('551431257'),
('551691519'),
('552273418'),
('552930828'),
('553119974'),
('554924628'),
('555554679'),
('555910745'),
('555991676'),
('557514924'),
('558715589'),
('558815133'),
('559612962'),
('559718641'),
('559892373'),
('559895888'),
('560817884'),
('561797802'),
('562771068'),
('562918898'),
('563396316'),
('563671474'),
('563957603'),
('564496498'),
('565437209'),
('565438927'),
('566737748'),
('568716216'),
('569190290'),
('570370846'),
('570437136'),
('570898096'),
('571175828'),
('571637940'),
('572311950'),
('573410221'),
('573479935'),
('573755951'),
('573851740'),
('573878473'),
('574625486'),
('574681072'),
('574700320'),
('574904847'),
('575021813'),
('575113152'),
('575151219'),
('575172760'),
('575650739'),
('575882509'),
('576239145'),
('576297820'),
('576498717'),
('576536825'),
('576868075'),
('578966824'),
('585156056'),
('585418377'),
('585644447'),
('585749138'),
('585766492'),
('585824989'),
('586366314'),
('589167252'),
('590144104'),
('593440319'),
('593520250'),
('593787754'),
('600033877'),
('600043917'),
('600107213'),
('600607645'),
('600904268'),
('601586942'),
('601645503'),
('601725249'),
('601845056'),
('603074319'),
('603079184'),
('603347607'),
('604441206'),
('605089252'),
('607145534'),
('608415811'),
('610071831'),
('610325256'),
('611078860'),
('611223380'),
('614121155'),
('614222550'),
('615167261'),
('616034686'),
('616364827'),
('619205184'),
('620164843'),
('620304065'),
('621264944'),
('621401766'),
('622209009'),
('622328950'),
('622406245'),
('623036227'),
('624228073'),
('624242547'),
('625106843'),
('626095033'),
('626443017'),
('641034821'),
('641187478'),
('642073042'),
('644181848'),
('646037205'),
('646037956'),
('646051794'),
('646070754'),
('646074667'),
('646101427'),
('646125422'),
('646145550'),
('646149789'),
('646205018'),
('646289543'),
('646704720'),
('646762613'),
('647033029'),
('647033687'),
('647034610'),
('647096082'),
('647098944'),
('647108337'),
('647162924'),
('647242116'),
('647269944'),
('647308726'),
('647323658'),
('647368439'),
('647465420'),
('647568582'),
('647728155')

SELECT
	PD01.DF_PRS_ID,
	PD01.DF_SPE_ACC_ID,
	COUNT(PD01.LOAN) AS Loans,
	SUM(PD01.Principal) AS Principal
FROM
	(
		SELECT DISTINCT
			DF_PRS_ID,
			DF_SPE_ACC_ID,
			ISNULL(GA01.AF_APL_ID,'') + ISNULL(AF_APL_ID_SFX,'') AS LOAN,
			SUM(GA10.AA_CUR_PRI) AS [Principal]
		FROM
			PD01_PDM_INF PD01
			INNER JOIN GA01_APP GA01
				ON GA01.DF_PRS_ID_BR = PD01.DF_PRS_ID
			INNER JOIN GA10_LON_APP GA10
				ON GA10.AF_APL_ID = GA01.AF_APL_ID
		GROUP BY
			DF_PRS_ID,
			DF_SPE_ACC_ID,
			ISNULL(GA01.AF_APL_ID,'') + ISNULL(AF_APL_ID_SFX,'')
	) PD01
	INNER JOIN @POP P 
		ON P.SSN = PD01.DF_PRS_ID
GROUP BY
	DF_PRS_ID,
	DF_SPE_ACC_ID