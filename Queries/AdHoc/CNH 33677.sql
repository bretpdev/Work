SELECT DISTINCT
	DC_DOM_ST,
	BorrowerPopulation,
	PlanType,
	SUM(CASE WHEN PlanType = 'REPAYE' THEN PlanPopulation ELSE X END) AS Repaye,
	SUM(CASE WHEN PlanType = 'PAYE' THEN PlanPopulation ELSE X END) AS Paye,
	SUM(CASE WHEN PlanType = 'IBR' THEN PlanPopulation ELSE X END) AS IBR,
	SUM(CASE WHEN PlanType = 'ICR' THEN PlanPopulation ELSE X END) AS ICR,
	SUM(CASE WHEN PlanType = 'IBR XXXX' THEN PlanPopulation ELSE X END) AS IBRXXXX,
	SUM(CASE WHEN PlanType LIKE '%NON IDR' THEN PlanPopulation ELSE X END) As Other
FROM
(
	SELECT
		DC_DOM_ST,
		PlanType,
		SUM(BorrowerCountByState) OVER(PARTITION BY DC_DOM_ST) AS BorrowerPopulation,
		SUM(BorrowerCountByState) OVER(PARTITION BY DC_DOM_ST, PlanType) AS PlanPopulation
	FROM
	(
		SELECT
			COUNT(DISTINCT PDXX.DF_SPE_ACC_ID) AS BorrowerCountByState,
			PDXX.DC_DOM_ST,
			CASE WHEN LNXX.LC_TYP_SCH_DIS IN('IX','IA') THEN 'REPAYE'
				 WHEN LNXX.LC_TYP_SCH_DIS IN('CA','CP') THEN 'PAYE'
				 WHEN LNXX.LC_TYP_SCH_DIS IN('IB','IL') THEN 'IBR'
				 WHEN LNXX.LC_TYP_SCH_DIS IN('CX','CX','CX','CQ') THEN 'ICR'
				 WHEN LNXX.LC_TYP_SCH_DIS IN('IX','IP') THEN 'IBR XXXX'
				 ELSE CAST(DWXX.WC_DW_LON_STA AS VARCHAR) + ' - NON IDR'
			END AS PlanType
		FROM
			CDW..LNXX_LON LNXX
			INNER JOIN CDW..DWXX_DW_CLC_CLU DWXX
				ON DWXX.BF_SSN = LNXX.BF_SSN
				AND DWXX.LN_SEQ = LNXX.LN_SEQ
			INNER JOIN CDW..PDXX_PRS_NME PDXX
				ON PDXX.DF_PRS_ID = LNXX.BF_SSN
			INNER JOIN CDW..PDXX_PRS_ADR PDXX
				ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
				AND PDXX.DC_DOM_ST IN 
				(
					'AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE',	'FL', 'GA',
					'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD',
					'MA', 'MI', 'MN', 'MS',	'MO', 'MT', 'NE', 'NV', 'NH', 'NJ',
					'NM', 'NY',	'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC',
					'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY',
					'AS', 'GU', 'MP', 'PR', 'VI'
				)
				AND PDXX.DC_ADR = 'L'
				AND PDXX.DI_VLD_ADR = 'Y'
			LEFT JOIN CDW..LNXX_LON_RPS LNXX
				ON LNXX.BF_SSN = LNXX.BF_SSN
				AND LNXX.LN_SEQ = LNXX.LN_SEQ
				AND LNXX.LC_STA_LONXX = 'A'
		WHERE
			LNXX.LC_STA_LONXX = 'R'
			AND LNXX.LA_CUR_PRI > X.XX
		GROUP BY
			PDXX.DC_DOM_ST,
			CASE WHEN LNXX.LC_TYP_SCH_DIS IN('IX','IA') THEN 'REPAYE'
				 WHEN LNXX.LC_TYP_SCH_DIS IN('CA','CP') THEN 'PAYE'
				 WHEN LNXX.LC_TYP_SCH_DIS IN('IB','IL') THEN 'IBR'
				 WHEN LNXX.LC_TYP_SCH_DIS IN('CX','CX','CX','CQ') THEN 'ICR'
				 WHEN LNXX.LC_TYP_SCH_DIS IN('IX','IP') THEN 'IBR XXXX'
				 ELSE CAST(DWXX.WC_DW_LON_STA AS VARCHAR) + ' - NON IDR'
			END
	) DataTable
)PlansTable
GROUP BY
	DC_DOM_ST,
	BorrowerPopulation,
	PlanType
ORDER BY
	DC_DOM_ST,
	PlanType




SELECT DISTINCT
	PDXX.DF_SPE_ACC_ID AS AccountNumber,
	LTRIM(RTRIM(PDXX.DM_PRS_X)) + ' ' + LTRIM(RTRIM(PDXX.DM_PRS_LST)) AS Name,
	DBL.SEGMENT AS Segment,
	DBL.PerformanceCategory AS Metric,
	--LNXX.LF_FED_CLC_RSK AS CRC,
	LTRIM(RTRIM(PDXX.DX_STR_ADR_X)) AS AddrX,
	LTRIM(RTRIM(PDXX.DX_STR_ADR_X)) AS AddrX,
	LTRIM(RTRIM(PDXX.DM_CT)) AS City,
	LTRIM(RTRIM(PDXX.DC_DOM_ST)) AS State,
	LTRIM(RTRIM(PDXX.DF_ZIP_CDE)) AS Zip,
	CASE WHEN LNXX.LC_TYP_SCH_DIS IN('IX','IA') THEN 'REPAYE'
		 WHEN LNXX.LC_TYP_SCH_DIS IN('CA','CP') THEN 'PAYE'
		 WHEN LNXX.LC_TYP_SCH_DIS IN('IB','IL') THEN 'IBR'
		 WHEN LNXX.LC_TYP_SCH_DIS IN('CX','CX','CX','CQ') THEN 'ICR'
		 WHEN LNXX.LC_TYP_SCH_DIS IN('IX','IP') THEN 'IBR XXXX'
		 ELSE CAST(DWXX.WC_DW_LON_STA AS VARCHAR) + ' - NON IDR'
	END AS PlanType
FROM
	CDW..LNXX_LON LNXX
	INNER JOIN CDW..DWXX_DW_CLC_CLU DWXX
		ON DWXX.BF_SSN = LNXX.BF_SSN
		AND DWXX.LN_SEQ = LNXX.LN_SEQ
	INNER JOIN CDW..PDXX_PRS_NME PDXX
		ON PDXX.DF_PRS_ID = LNXX.BF_SSN
	INNER JOIN CDW..PDXX_PRS_ADR PDXX
		ON PDXX.DF_PRS_ID = PDXX.DF_PRS_ID
		AND PDXX.DC_DOM_ST IN 
		(
			'AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE',	'FL', 'GA',
			'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD',
			'MA', 'MI', 'MN', 'MS',	'MO', 'MT', 'NE', 'NV', 'NH', 'NJ',
			'NM', 'NY',	'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC',
			'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY',
			'AS', 'GU', 'MP', 'PR', 'VI'
		)
		AND PDXX.DC_ADR = 'L'
		AND PDXX.DI_VLD_ADR = 'Y'
	INNER JOIN CDW.FsaInvMet.Daily_BorrowerLevel DBL
		ON DBL.BF_SSN = LNXX.BF_SSN
	LEFT JOIN CDW..LNXX_LON_RPS LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
		AND LNXX.LC_STA_LONXX = 'A'
WHERE
	LNXX.LC_STA_LONXX = 'R'
	AND LNXX.LA_CUR_PRI > X.XX
ORDER BY
	LTRIM(RTRIM(PDXX.DC_DOM_ST)),
	DBL.PerformanceCategory,
	DBL.SEGMENT
