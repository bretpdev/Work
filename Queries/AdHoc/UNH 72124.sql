USE UDW
GO

DROP TABLE IF EXISTS #POP

SELECT DISTINCT
	PD01.DF_SPE_ACC_ID,
	PD01.DF_PRS_ID
INTO #POP
FROM
	ODW.[dbo].[PD01_PDM_INF] PD01
	INNER JOIN ODW.[dbo].[AY01_BR_ATY] AY01
		ON AY01.DF_PRS_ID = PD01.DF_PRS_ID
WHERE
	AY01.PF_ACT = 'DRWTN'
	AND AY01.BF_CRT_DTS_AY01 > '03-20-2020'
	AND PD01.DF_SPE_ACC_ID IN 
	(
		'0084373085',
		'0219966525',
		'0285005949',
		'0326053425',
		'0347659946',
		'0368634121',
		'0373621698',
		'0382520129',
		'0456447327',
		'0516551384',
		'0581611590',
		'0698703528',
		'0703711465',
		'0762976005',
		'0776642081',
		'0778710057',
		'0902935962',
		'0935729640',
		'1113630053',
		'1163258950',
		'1294259765',
		'1375759865',
		'1415066395',
		'1614083551',
		'1630960378',
		'1713348179',
		'1805955328',
		'1872308590',
		'1902981704',
		'1918525142',
		'1951612183',
		'2013690211',
		'2048101648',
		'2053342816',
		'2171664193',
		'2267610327',
		'2281262640',
		'2377547313',
		'2522427097',
		'2553322454',
		'2613596810',
		'2656379705',
		'2829835911',
		'3021391420',
		'3112933823',
		'3192287569',
		'3256108845',
		'3289569376',
		'3313171720',
		'3347829500',
		'3410095638',
		'3426278553',
		'3504843116',
		'3521084797',
		'3537971548',
		'3538362721',
		'3548120260',
		'3550267278',
		'3635707006',
		'3712676144',
		'3726627705',
		'3727935639',
		'3783387350',
		'3840467413',
		'3867261717',
		'3940980428',
		'3951356715',
		'4006831491',
		'4078798892',
		'4089653009',
		'4135780499',
		'4202075277',
		'4210173636',
		'4276603263',
		'4318862820',
		'4335997733',
		'4370069724',
		'4378730227',
		'4441104472',
		'4482601401',
		'4547922172',
		'4641204546',
		'4648803760',
		'4650874939',
		'4692061033',
		'4832361719',
		'4847152854',
		'4859460204',
		'5048432459',
		'5049502130',
		'5078434748',
		'5108460768',
		'5119283485',
		'5135207545',
		'5194046538',
		'5296068801',
		'5306934025',
		'5308403274',
		'5377494448',
		'5433851455',
		'5457422392',
		'5544987599',
		'5579246431',
		'5663381214',
		'5676900290',
		'5708828110',
		'5724931674',
		'5773835730',
		'5905271258',
		'5923365070',
		'5937617655',
		'5980221920',
		'5990065161',
		'6203552596',
		'6215347199',
		'6386602170',
		'6412320022',
		'6416374377',
		'6488070382',
		'6495180927',
		'6645896717',
		'6807852920',
		'6939674883',
		'6940959501',
		'6971022714',
		'6988506562',
		'7063305496',
		'7083347074',
		'7186246932',
		'7263393636',
		'7275891735',
		'7276951302',
		'7317395380',
		'7508933597',
		'7519133164',
		'7546816884',
		'7607408218',
		'7659343547',
		'7683783483',
		'7763553640',
		'7813069597',
		'7839265166',
		'7937832625',
		'7965698120',
		'8035511019',
		'8117422594',
		'8135535956',
		'8140498452',
		'8168303163',
		'8197405230',
		'8337817788',
		'8379405966',
		'8414175308',
		'8642089498',
		'8661823685',
		'8679834416',
		'8721052714',
		'8857225950',
		'8919875283',
		'8924611530',
		'8999902139',
		'9047868263',
		'9159193609',
		'9236035475',
		'9261176454',
		'9296948616',
		'9315472413',
		'9347166471',
		'9389275863',
		'9404584713',
		'9414229465',
		'9418655968',
		'9475442573',
		'9481971641',
		'9498026338',
		'9683178322',
		'9757222712',
		'9779136034',
		'9815222861',
		'9859945142',
		'9864268365',
		'9869254798',
		'9876154071',
		'9925822684',
		'9946161162'
	)

SELECT DISTINCT
	DF_SPE_ACC_ID
FROM
	#POP

SELECT
	COUNT(DISTINCT P.DF_SPE_ACC_ID) AS BORROWER_COUNT,
	COUNT(*) AS LOAN_COUNT,
	SUM(DC02.LA_CLM_BAL + ISNULL(DC02.LA_CLM_INT_ACR,0)) AS PRINCIPAL_INTEREST_OUTSTANDING
FROM
	#POP P 
	INNER JOIN 
	(
		SELECT
			DC01.*
		FROM
			ODW..DC01_LON_CLM_INF DC01
			INNER JOIN 
			(
				SELECT DISTINCT
					DC01.BF_SSN,
					DC01.AF_APL_ID,
					DC01.AF_APL_ID_SFX,
					MAX(DC01.LF_CRT_DTS_DC10) AS MaxDate
				FROM
					ODW..DC01_LON_CLM_INF DC01
	
				WHERE
					DC01.LC_PCL_REA = 'DF'
					AND DC01.LC_STA_DC10 = '03'
					AND DC01.LD_CLM_ASN_DOE IS NULL
					AND LTRIM(ISNULL(DC01.LC_AUX_STA,'')) = ''
					AND ISNULL(DC01.LC_REA_CLM_ASN_DOE,'') = ''
		
				GROUP BY
					DC01.BF_SSN,
					DC01.AF_APL_ID,
					DC01.AF_APL_ID_SFX
				) DC01M
					ON DC01.AF_APL_ID = DC01M.AF_APL_ID
					AND DC01.AF_APL_ID_SFX = DC01M.AF_APL_ID_SFX
					AND DC01.LF_CRT_DTS_DC10 = DC01M.MaxDate
	) DC01
		ON DC01.BF_SSN = p.DF_PRS_ID
	INNER JOIN ODW..DC02_BAL_INT DC02
		ON DC02.AF_APL_ID = DC01.AF_APL_ID
		AND DC02.AF_APL_ID_SFX = DC01.AF_APL_ID_SFX
		AND DC02.LF_CRT_DTS_DC10 = DC01.LF_CRT_DTS_DC10
		AND DC02.LA_CLM_BAL > 0.00