USE CDW
GO
DECLARE @BEGIN VARCHAR(XX) = 'XX/XX/XXXX', @END VARCHAR(XX) = 'XX/XX/XXXX'
DECLARE @QUERY VARCHAR(MAX) = 'SELECT * FROM OPENQUERY(LEGEND,
''
SELECT DISTINCT
	PDXX.DF_SPE_ACC_ID,
	LNXX.LN_SEQ,
	AYXX.DateAdded,
	LNXX.LD_RPT_CRB,
	LNXX.LC_RPT_STA_CRB,
	LNXX.LN_DLQ_MAX
FROM
	PKUB.PDXX_PRS_NME PDXX
	INNER JOIN PKUB.LNXX_LON LNXX
		ON LNXX.BF_SSN = PDXX.DF_PRS_ID
	INNER JOIN
	(
		SELECT DISTINCT
			AYXX.BF_SSN,
			AYXX.PF_REQ_ACT,
			MIN(AYXX.LD_ATY_REQ_RCV) AS DateAdded
		FROM
			PKUB.AYXX_BR_LON_ATY AYXX
		WHERE
			AYXX.PF_REQ_ACT = ''''OLACH''''
			AND AYXX.LD_ATY_REQ_RCV >= '''''+ @BEGIN + '''''
			AND AYXX.LD_ATY_REQ_RCV <=  '''''+ @END + '''''
		GROUP BY
			AYXX.BF_SSN,
			AYXX.PF_REQ_ACT
	) AYXX
		ON AYXX.BF_SSN = PDXX.DF_PRS_ID
	INNER JOIN PKUB.BRXX_BR_EFT BRXX
		ON BRXX.BF_SSN = LNXX.BF_SSN
		AND BRXX.BC_EFT_STA = ''''A''''
	INNER JOIN 
	(
		SELECT
			*
		FROM
			PKUB.LNXX_LON_CRB_RPT
		WHERE
			LC_RPT_STA_CRB IN (''''XX'''',''''XX'''',''''XX'''',''''XX'''',''''XX'''')
			AND LD_RPT_CRB >= '''''+ @BEGIN + '''''
			AND LD_RPT_CRB <=  '''''+ @END + '''''
	) LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
	LEFT JOIN PKUB.LNXX_LON_DLQ_HST LNXX
		ON LNXX.BF_SSN = LNXX.BF_SSN
		AND LNXX.LN_SEQ = LNXX.LN_SEQ
		AND LNXX.LC_STA_LONXX = ''''X''''
		AND LNXX.LN_DLQ_MAX >= XX
		AND LNXX.LD_DLQ_MAX = CURRENT DATE - X DAY
''
)
'

EXEC (@QUERY)
