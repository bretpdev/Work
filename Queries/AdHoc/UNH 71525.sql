USE UDW
GO

SELECT DISTINCT
	FB10.BF_SSN,
	FB10.LF_FOR_CTL_NUM,
	FB10.LC_FOR_TYP,
	CONVERT(VARCHAR, LN60.LD_FOR_BEG, 101) AS BEGIN_DATE,
	CONVERT(VARCHAR, LN60.LD_FOR_END, 101) AS END_DATE
FROM
	FB10_BR_FOR_REQ FB10
	INNER JOIN LN60_BR_FOR_APV LN60
		ON LN60.BF_SSN = FB10.BF_SSN
		AND LN60.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM
	LEFT JOIN
	(
		SELECT DISTINCT
			AY20.BF_SSN,
			STUFF(
			(
				SELECT 
					' ' + SUB.LX_ATY AS [text()]
				FROM 
					AY20_ATY_TXT SUB
				WHERE
					SUB.BF_SSN = AY20.BF_SSN
					AND SUB.LN_ATY_SEQ = AY20.LN_ATY_SEQ
			FOR XML PATH('')
			)
			,1,1, '') AS LX_ATY
		FROM	
			AY10_BR_LON_ATY AY10
			INNER JOIN AY15_ATY_CMT AY15
				ON AY10.BF_SSN = AY15.BF_SSN
				AND AY10.LN_ATY_SEQ = AY15.LN_ATY_SEQ
			INNER JOIN AY20_ATY_TXT AY20
				ON AY15.BF_SSN = AY20.BF_SSN
				AND AY15.LN_ATY_SEQ = AY20.LN_ATY_SEQ
				AND AY15.LN_ATY_CMT_SEQ = AY20.LN_ATY_CMT_SEQ
			INNER JOIN PD10_PRS_NME PD10
				ON PD10.DF_PRS_ID = AY20.BF_SSN
		WHERE
			AY10.PF_REQ_ACT = 'FBAPV'
			AND AY10.LC_STA_ACTY10 = 'A'
			AND AY15.LC_STA_AY15 = 'A'
			AND AY10.LD_ATY_REQ_RCV > '04/01/2021'
	) AY10
		ON AY10.BF_SSN = FB10.BF_SSN
		AND replace(AY10.LX_ATY,' ','') like '%{COVIDFORB}%'

WHERE
	LN60.LC_STA_LON60 = 'A'
	AND FB10.LC_STA_FOR10 = 'A'
	AND FB10.LC_FOR_STA = 'A' 
	AND LN60.LD_FOR_END > CAST(GETDATE() AS DATE)
	AND FB10.LC_FOR_TYP = '40'
	AND LN60.LC_FOR_RSP != '003'
ORDER BY 
	FB10.BF_SSN,
	FB10.LF_FOR_CTL_NUM