USE CDW
GO

SELECT * FROM CDW..PDXX_PRS_NME WHERE DF_SPE_ACC_ID = 'XXXXXXXXXX' --Get SSN
SELECT * FROM OPENQUERY(LEGEND,'SELECT * FROM PKUB.AYXX_BR_LON_ATY WHERE BF_SSN = ''XXXXXXXXX'' AND PF_REQ_ACT = ''ISFXX''') --X ISFXX ARC created X/XX/XXXX
SELECT * FROM CDW..LTXX_LetterRequests WHERE DF_SPE_ACC_ID = 'XXXXXXXXXX' AND RM_DSC_LTR_PRC = 'TSXXBISF' --X Letter showing printed on the XXth
SELECT * FROM CDW..LNXX_FIN_ATY WHERE BF_SSN ='XXXXXXXXX' AND COALESCE(LC_FAT_REV_REA,'') != '' 
--(looks like the LC_FAT_REV_REA of X is a system generated one.  Might want to avoid using it?)
--code wouldve chosen LN_FAT_SEQ XX, but the actual reversal we shouldve reported was LN_FAT_SEQ X

--LT_TSXXBISF_Reversed_Transaction (gets max reversal.  Wont pull correct stuff now unless modified to only look at stuff entered prior to X/XX
	SELECT TOP X
		PDXX.DF_SPE_ACC_ID,
		LNXX.LN_FAT_SEQ,
		SUM(ISNULL(LNXX.LA_FAT_CUR_PRI, X) + ISNULL(LNXX.LA_FAT_ILG_PRI, X) + ISNULL(LNXX.LA_FAT_LTE_FEE, X) + ISNULL(LNXX.LA_FAT_NSI, X) + ISNULL(LNXX.LA_FAT_PCL_FEE, X)) [LA_TRAN],
		CONVERT(VARCHAR(XX), LNXX.LD_FAT_EFF, XXX) [LD_MAX_TRAN]
	FROM
		CDW..PDXX_PRS_NME PDXX
		INNER JOIN CDW..LNXX_FIN_ATY LNXX ON LNXX.BF_SSN = PDXX.DF_PRS_ID
	WHERE
		PDXX.DF_SPE_ACC_ID = 'XXXXXXXXXX'
		AND LNXX.LC_FAT_REV_REA != ''
		AND LNXX.PC_FAT_TYP = 'XX'
		AND LNXX.LC_STA_LONXX = 'A'
	GROUP BY
		PDXX.DF_SPE_ACC_ID,
		LNXX.LN_FAT_SEQ,
		LNXX.LD_FAT_EFF
	ORDER BY
		LNXX.LN_FAT_SEQ DESC