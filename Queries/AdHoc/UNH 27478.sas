/*troubleshooting query*/

/*/*%LET RPTLIB = %SYSGET(reportdir);*/*/
/*%LET RPTLIB = T:\SAS;*/
/**/
/*PROC IMPORT */
/*	DATAFILE="X:\ARCHIVE\BANA\PRODUCTION FILES\SUPPLEMENTAL FILES\J00BX_829769_INCENTIVE_SC370R5_2016020301130493_UO.CSV"*/
/*	OUT=CSV1 DBMS=CSV REPLACE;*/
/*	GETNAMES=YES;*/
/*RUN;*/
/*PROC IMPORT */
/*	DATAFILE="X:\Archive\BANA\Production Files\Supplemental Files\J00BX_829769_INCENTIVE_SC370R5_2016020303193552_UU.CSV"*/
/*	OUT=CSV2 DBMS=CSV REPLACE;*/
/*	GETNAMES=YES;*/
/*RUN;*/
/*PROC IMPORT */
/*	DATAFILE="X:\Archive\BANA\Production Files Wave 2\Supplemental Files\J00BX_829769_INCENTIVE_SC370R5_2016021600123053_UO.CSV"*/
/*	OUT=CSV3 DBMS=CSV REPLACE;*/
/*	GETNAMES=YES;*/
/*RUN;*/
/*PROC IMPORT */
/*	DATAFILE="X:\Archive\BANA\Production Files Wave 2\Supplemental Files\J00BX_829769_INCENTIVE_SC370R5_2016021604181866_UU.CSV"*/
/*	OUT=CSV4 DBMS=CSV REPLACE;*/
/*	GETNAMES=YES;*/
/*RUN;*/
/*PROC IMPORT */
/*	DATAFILE="X:\Archive\BANA\Production Files Wave 3\Supplemental Files\J00BX_829769_INCENTIVE_SC370R5_2016030520224383_UO.CSV"*/
/*	OUT=CSV5 DBMS=CSV REPLACE;*/
/*	GETNAMES=YES;*/
/*RUN;*/
/*PROC IMPORT */
/*	DATAFILE="X:\Archive\BANA\Production Files Wave 3\Supplemental Files\J00BX_829769_INCENTIVE_SC370R5_2016030601054788_UU.CSV"*/
/*	OUT=CSV6 DBMS=CSV REPLACE;*/
/*	GETNAMES=YES;*/
/*RUN;*/
/*PROC IMPORT */
/*	DATAFILE="X:\Archive\BANA\Production Files Wave 3\Supplemental Files\J00BX_829769_INCENTIVE_SC370R5_2016030601371382_UO.CSV"*/
/*	OUT=CSV7 DBMS=CSV REPLACE;*/
/*	GETNAMES=YES;*/
/*RUN;*/
/*PROC IMPORT */
/*	DATAFILE="X:\Archive\BANA\Production Files Wave 3\Supplemental Files\J00BX_829769_INCENTIVE_SC370R5_2016030601375610_UU.CSV"*/
/*	OUT=CSV8 DBMS=CSV REPLACE;*/
/*	GETNAMES=YES;*/
/*RUN;*/
/**/
/*DATA CSVSOURCE (KEEP=*/
/*		BORROWER_SSN */
/*		DISQUALIFICATION_DATE */
/*		LN_ID */
/*		BORROWER_BENEFIT_CODE */
/*		UHEAA_CODE */
/*		INTEREST_STATUS */
/*		REBATE_STATUS*/
/*		COMMONLINE_UNIQUE_ID*/
/*		);*/
/*	SET CSV4 CSV7 CSV1 CSV2 CSV3 CSV5 CSV6 CSV8;*/
/*	COMMONLINE_UNIQUE_ID = COALESCEC(SUBSTR(COMMONLINE_UNIQUE_ID,2),'000');*/
/*	LN_ID = SUBSTR(LOAN_IDENT,2);*/
/*		SELECT (BORROWER_BENEFIT_CODE);*/
/*		WHEN (0290,0835) UHEAA_CODE =  "BI1";*/
/*		WHEN (1560,1565,1717) UHEAA_CODE =  "BI2";*/
/*		WHEN (0007,1716) UHEAA_CODE =  "BI3";*/
/*		WHEN (1000,1520,4400,5101,6742,6749) UHEAA_CODE =  "BI4";*/
/*		WHEN (1570,1580,6720) UHEAA_CODE =  "BI5";*/
/*		WHEN (1706) UHEAA_CODE =  "BI6";*/
/*		WHEN (0830,1715) UHEAA_CODE =  "BI7";*/
/*		WHEN (2585,2590) UHEAA_CODE =  "BI8";*/
/*		WHEN (6740,6741) UHEAA_CODE =  "BI9";*/
/*		WHEN (6744,6745) UHEAA_CODE =  "BIA";*/
/*		WHEN (6746,6747) UHEAA_CODE =  "BIB";*/
/*		WHEN (1710) UHEAA_CODE =  "BIC";*/
/*		WHEN (0006,1020) UHEAA_CODE =  "BID";*/
/*		WHEN (0230,0800,1010,1530) UHEAA_CODE =  "BIE";*/
/*		WHEN (2740,6748) UHEAA_CODE =  "BR1";*/
/*		WHEN (2204,2205,2206,2207,2208,2550,2552,2555,2560,2565) UHEAA_CODE =  "BT1";*/
/*		WHEN (2214,2215,2216,2217,2530,2533,2535,2540,2570,2573,2575,2580,7722,7723,7724,7725) UHEAA_CODE =  "BT2";*/
/*		WHEN (3330,3335,3340) UHEAA_CODE =  "BT3";*/
/*	OTHERWISE UHEAA_CODE = "";*/
/*	END;*/
/*RUN;*/
/**/
/*PROC DATASETS NOLIST;*/
/*	DELETE CSV4 CSV7 CSV1 CSV2 CSV3 CSV5 CSV6 CSV8;*/
/*RUN;*/
;
LIBNAME  DUSTER  REMOTE  SERVER=DUSTER  SLIBREF=WORK; 

/*DATA DUSTER.CSVSOURCE; *Send data to Duster;*/
/*SET CSVSOURCE;*/
/*RUN;*/

RSUBMIT;

%LET DB = DLGSUTWH; 
LIBNAME OLWHRM1 DB2 DATABASE=&DB OWNER=OLWHRM1;

PROC SQL;
	CREATE TABLE BORROWERS AS
		SELECT DISTINCT
			 LN10.BF_SSN 			AS SSN 			
			,LN10.LN_SEQ 			AS LoanSeq 		
			,CSV.UHEAA_CODE 		AS BorrowerBenefitType
			,'NULL' 				AS CorrectedStatus  
			,LN55c.LF_LON_BBS_TIR_a	AS Tier
/*			,LN55c.LF_LON_BBS_TIR_a	AS Tier_A	*/
/*			,LN55c.LF_LON_BBS_TIR_b	AS Tier_B                                */
			,'NULL' 				AS PCVPayments 		
			,'NULL' 				AS DisqualDate 		
			,'NULL' 				AS DisqualReason 		
			,'NULL'					AS Comment 	
			,LN55.PM_BBS_PGM
			,CSV.INTEREST_STATUS
			,CSV.REBATE_STATUS
			,LN10A.CLUID
			,CSV.COMMONLINE_UNIQUE_ID
			,LN55.LD_LON_BBT_BEG
/*			,LN55c.LD_LON_BBT_BEG_a AS LD_LON_BBT_BEG_A*/
/*			,LN55c.LD_LON_BBT_BEG_b	AS LD_LON_BBT_BEG_B*/
			,LN10.LD_LON_EFF_ADD
			,CASE
				WHEN LN55.LD_LON_BBT_BEG > LN10.LD_LON_EFF_ADD
					THEN 1
				WHEN LN55.LD_LON_BBT_BEG IS NULL 
					THEN 1
				ELSE 0
			END AS FLAG
		FROM
			OLWHRM1.LN10_LON LN10
			INNER JOIN
				(
					SELECT DISTINCT
						BF_SSN
						,LN_SEQ
						,CATS(COALESCEC(LF_LON_ALT,'0'), PUT(COALESCE(LN_LON_ALT_SEQ,0),Z2.)) AS CLUID
					FROM
						OLWHRM1.LN10_LON 
				)LN10A
				ON LN10.BF_SSN = LN10A.BF_SSN
				AND LN10.LN_SEQ = LN10A.LN_SEQ
			INNER JOIN CSVSOURCE CSV
				ON CSV.BORROWER_SSN = LN10.BF_SSN
				AND CSV.LN_ID = LN10.LF_GTR_RFR_XTN
				AND CSV.COMMONLINE_UNIQUE_ID = LN10A.CLUID
			INNER JOIN OLWHRM1.LN60_BR_FOR_APV LN60
				ON LN10.BF_SSN = LN60.BF_SSN
				AND LN10.LN_SEQ = LN60.LN_SEQ
			INNER JOIN OLWHRM1.FB10_BR_FOR_REQ FB10
				ON LN10.BF_SSN = FB10.BF_SSN
			INNER JOIN OLWHRM1.LN55_LON_BBS_TIR LN55
				ON LN10.BF_SSN = LN55.BF_SSN
				AND LN10.LN_SEQ = LN55.LN_SEQ
			INNER JOIN 
			(
				select 
					ln55b.bf_ssn
					,ln55b.ln_seq
					,max(ln55a.lf_lon_bbs_tir_a) as lf_lon_bbs_tir_a
				from 
					OLWHRM1.LN55_LON_BBS_TIR LN55B
					inner join 
					(
						select 
							ln55a.bf_ssn
							,ln55a.ln_seq
							,max(ln55a.lf_lon_bbs_tir) as lf_lon_bbs_tir_a
						from
							OLWHRM1.LN55_LON_BBS_TIR LN55A
						group by
							ln55a.bf_ssn
							,ln55a.ln_seq
							,ln55a.ld_lon_bbt_beg
					) ln55a
						ON LN55A.BF_SSN = LN55B.BF_SSN
						AND LN55A.LN_SEQ = LN55B.LN_SEQ
				where
					input(ln55a.lf_lon_bbs_tir_a,2.) = input(ln55b.lf_lon_bbs_tir,2.) + 1
/*					and ln55a.bf_ssn = '082368832'*/
				group by
					ln55b.bf_ssn
					,ln55b.ln_seq
			)ln55c
				ON LN55.BF_SSN = LN55c.BF_SSN
				AND LN55.LN_SEQ = LN55c.LN_SEQ
		WHERE
			LN10.LC_STA_LON10 = 'R'
			AND LN10.LA_CUR_PRI >= 0
			AND LN10.LF_LON_CUR_OWN LIKE '829769%'
			AND LN60.LC_STA_LON60 = 'A'
			AND FB10.LC_FOR_STA = 'A'
			AND FB10.LC_STA_FOR10 = 'A'
			AND FB10.LC_FOR_TYP = '17'
			AND LN55.LC_STA_LN55 = 'A'
			AND LN55.PM_BBS_PGM IN ('BT1','BT2','BT3')
			AND LN55.LC_LON_BBT_STA = 'D'
			AND LN55.LD_LON_BBT_STA BETWEEN LN60.LD_FOR_BEG AND LN60.LD_FOR_APL
			AND LN55.LC_LON_BBT_DSQ_REA = '04'
/*			AND LN55A.LD_LON_BBT_BEG > LN10.LD_LON_EFF_ADD*/
	;
QUIT;

ENDRSUBMIT;

DATA BORROWERS;
	SET DUSTER.BORROWERS;
	IF FLAG = 0 
		THEN DELETE;
	IF PM_BBS_PGM = 'BT3' AND INTEREST_STATUS IN
		('00000', '00004', '00005', '00006', '00008', '00010',
		 '00011', '00013', '00015', '00016', '00019', '00099')
		THEN DELETE;
	IF PM_BBS_PGM IN ('BT1','BT2') AND REBATE_STATUS IN
		('00000', '00004', '00006', '00008', '00011', '00013', '00014',
		 '00020', '00022', '00023', '00024', '00025', '00026', '00099')
		THEN DELETE;
RUN;

/*PROC EXPORT*/
/*	DATA=WORK.BORROWERS*/
/*		OUTFILE="&RPTLIB\Approved BB Overrides.csv"*/
/*		DBMS=CSV*/
/*		REPLACE;*/
/*RUN;*/
