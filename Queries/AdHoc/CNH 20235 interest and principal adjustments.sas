LIBNAME  LEGEND  REMOTE  SERVER=LEGEND SLIBREF=WORK ;

%LET START_DATE = 'XX/XX/XXXX';

%SYSLPUT START_DATE = &START_DATE;
RSUBMIT LEGEND;
PROC SQL;
	CONNECT TO DBX (DATABASE=DNFPUTDL);
	CREATE TABLE PAIAQFAFED AS
		SELECT *
		FROM CONNECTION TO DBX
			(
			SELECT DISTINCT
				PDXX.DF_SPE_ACC_ID
				,RTRIM(PDXX.DM_PRS_X)||' '||RTRIM(PDXX.DM_PRS_MID)||' '||PDXX.DM_PRS_LST AS NAME
				,FSXX.LF_FED_AWD
				,FSXX.LN_FED_AWD_SEQ
				,LNXX.LD_FAT_APL 
				,LNXX.LD_FAT_EFF
				,LNXX.PC_FAT_SUB_TYP
				,LNXX.LA_FAT_CUR_PRI
				,LNXX.LA_FAT_NSI
			FROM 
				PKUB.LNXX_FIN_ATY LNXX
				INNER JOIN PKUB.PDXX_PRS_NME PDXX
					ON LNXX.BF_SSN = PDXX.DF_PRS_ID
				INNER JOIN PKUB.FSXX_DL_LON FSXX
					ON LNXX.BF_SSN = FSXX.BF_SSN
					AND LNXX.LN_SEQ = FSXX.LN_SEQ
			WHERE 
				LNXX.PC_FAT_TYP = 'XX'
				AND LNXX.LC_FAT_REV_REA IN ('X','X')
				AND DAYS(LNXX.LD_FAT_APL) BETWEEN DAYS(&START_DATE) AND DAYS(CURRENT DATE)

			FOR READ ONLY WITH UR

			);
	DISCONNECT FROM DBX;
QUIT;
ENDRSUBMIT;
DATA PAIAQFAFED;
	SET LEGEND.PAIAQFAFED; 
RUN;
PROC SORT DATA=PAIAQFAFED;
	BY LD_FAT_APL DF_SPE_ACC_ID LF_FED_AWD LN_FED_AWD_SEQ;
RUN;
DATA _NULL_;
	SET PAIAQFAFED;
	AWD_ID = CATT(LF_FED_AWD,PUT(LN_FED_AWD_SEQ,ZX.));
	FILE 'T:\SAS\PrincipalandInterestAdjustmentQueryForAuditFED_XX-X-XXXX.txt' delimiter=',' DSD DROPOVER lrecl=XXXXX;
	FORMAT DF_SPE_ACC_ID $XX. ;
	FORMAT NAME $XX. ;
	FORMAT AWD_ID $XX. ;
	FORMAT LD_FAT_APL MMDDYYXX. ;
	FORMAT LD_FAT_EFF MMDDYYXX. ;
	FORMAT PC_FAT_SUB_TYP $X. ;
	FORMAT LA_FAT_CUR_PRI XX.X ;
	FORMAT LA_FAT_NSI XX.X ;
	IF _N_ = X THEN DO;
		PUT 'Account Number'
			','
			'Name' 
			','
			'Award ID' 
			','
			'Applied Date' 
			','
			'Effective Date' 
			','
			'Payment Sub-Type' 
			','
			'Principal'
			','
			'Interest';
		END;
	DO;
		PUT DF_SPE_ACC_ID $ @;
		PUT NAME $ @;
		PUT AWD_ID $ @;
		PUT LD_FAT_APL @;
		PUT LD_FAT_EFF @;
		PUT PC_FAT_SUB_TYP $ @;
		PUT LA_FAT_CUR_PRI  @;
		PUT LA_FAT_NSI ;
	END;
RUN;
