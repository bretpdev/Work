/*%LET RPTLIB = T:\SAS;*/
%LET RPTLIB = X:\PADD\FTP;
FILENAME REPORT2 "&RPTLIB/BOND SWAP 2010 SCRIPT FILE.R2";
FILENAME REPORT3 "&RPTLIB/BOND SWAP 2010 SCRIPT FILE.R3";

LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;
%LET MAX_SSN = 539;
%LET BOND = '88';


PROC SQL;
CREATE TABLE DEMO AS
SELECT D.DF_SPE_ACC_ID
	,A.BF_SSN
	,A.LN_SEQ
	,B.IF_BND_ISS
	,A.LA_CUR_PRI

FROM DLGSUTWH.PD10_PRS_NME D
INNER JOIN DLGSUTWH.LN10_LON A
	ON D.DF_PRS_ID = A.BF_SSN
INNER JOIN DLGSUTWH.LN35_LON_OWN B
	ON A.BF_SSN = B.BF_SSN
	AND A.LN_SEQ = B.LN_SEQ
INNER JOIN (SELECT BF_SSN
				,LN_SEQ
				,MAX(LN_LON_OWN_SEQ) AS LN_LON_OWN_SEQ
			FROM DLGSUTWH.LN35_LON_OWN
			GROUP BY BF_SSN, LN_SEQ) C
	ON B.BF_SSN = C.BF_SSN
	AND B.LN_SEQ = C.LN_SEQ
	AND B.LN_LON_OWN_SEQ = C.LN_LON_OWN_SEQ
WHERE A.LC_STA_LON10 = 'R'
	AND A.LA_CUR_PRI > 0
	AND A.LF_LON_CUR_OWN = '828476'
	AND INPUT(SUBSTR(A.BF_SSN,7,3),3.) <= &MAX_SSN
/*	AND B.IF_BND_ISS = &BOND*/
		AND SUBSTR(B.IF_BND_ISS,1,2) = &BOND;
QUIT;
ENDRSUBMIT;
DATA DEMO;
	SET WORKLOCL.DEMO;
RUN;
PROC SORT DATA=DEMO; BY IF_BND_ISS BF_SSN; RUN;

DATA _NULL_;
SET DEMO ;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
SSN_SEQ = BF_SSN || PUT(LN_SEQ,Z4.0) ;
DO;
   PUT SSN_SEQ @;
   PUT IF_BND_ISS $ ;
END;
RUN;
PROC SORT DATA=DEMO; BY DF_SPE_ACC_ID LN_SEQ; RUN;

PROC PRINTTO PRINT=REPORT3 NEW;
RUN;


/*FOR LANDSCAPE REPORTS:*/
/*OPTIONS ORIENTATION = LANDSCAPE;*/
/*OPTIONS PS=39 LS=127;*/
/*FOR PORTRAIT REPORTS;*/
OPTIONS ORIENTATION = PORTRAIT;
OPTIONS PS=52 LS=96;
TITLE 'SSN SPECIFIC BOND TRANSFER 2010';

PROC PRINT NOOBS SPLIT='/' DATA=DEMO WIDTH=UNIFORM WIDTH=MIN LABEL;
FORMAT LA_CUR_PRI DOLLAR10.2;
VAR DF_SPE_ACC_ID LN_SEQ LA_CUR_PRI;
LABEL DF_SPE_ACC_ID = 'ACCOUNT NUMBER'
	LN_SEQ = 'LOAN SEQUENCE'
	LA_CUR_PRI = 'CURRENT PRINCIPAL';
RUN;
PROC SQL;
SELECT COUNT(*) LABEL "TOTAL LOANS" FORMAT=COMMA8.0
	,SUM(LA_CUR_PRI) LABEL "TOTAL CURRENT PRINCIPAL" FORMAT=DOLLAR18.2
FROM DEMO;
QUIT;
PROC PRINTTO;
RUN;
