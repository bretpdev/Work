*-----------------------------------------------*
| Skip Comments from OneLINK to COMPASS Cleanup |
*-----------------------------------------------*;
%LET RPTLIB = T:\SAS;
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE OL AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.DF_PRS_ID
	,A.PF_ACT
	,A.BD_ATY_PRF
	,A.BC_ATY_TYP
	,A.BC_ATY_CNC_TYP
	,A.BX_CMT
FROM OLWHRM1.AY01_BR_ATY A
INNER JOIN OLWHRM1.LN10_LON B
	ON A.DF_PRS_ID = B.BF_SSN
WHERE A.BD_ATY_PRF BETWEEN '07/01/2006' AND '08/02/2008' 
	AND SUBSTR(A.PF_ACT,1,1) = 'K'
	AND DAYOFWEEK(A.BD_ATY_PRF) = 7
	AND B.LA_CUR_PRI > 0
	AND B.LC_STA_LON10 = 'R'
FOR READ ONLY WITH UR
);

CREATE TABLE CO AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT A.BF_SSN
	,A.PF_REQ_ACT
	,A.LD_ATY_REQ_RCV
	,C.LX_ATY
	,B.LC_ATY_CMT
	,A.LD_ATY_RSP
FROM OLWHRM1.AY10_BR_LON_ATY A
INNER JOIN OLWHRM1.AY15_ATY_CMT B
	ON A.BF_SSN = B.BF_SSN
	AND A.LN_ATY_SEQ = B.LN_ATY_SEQ
INNER JOIN OLWHRM1.AY20_ATY_TXT C
	ON B.BF_SSN = C.BF_SSN
	AND B.LN_ATY_SEQ = C.LN_ATY_SEQ
	AND B.LN_ATY_CMT_SEQ = C.LN_ATY_CMT_SEQ
WHERE A.LD_ATY_REQ_RCV BETWEEN '07/01/2006' AND '08/02/2008' 
	AND DAYOFWEEK(A.LD_ATY_REQ_RCV) = 7
	AND SUBSTR(A.PF_REQ_ACT,1,1) = 'K'
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;

ENDRSUBMIT;
DATA CO; SET WORKLOCL.CO; RUN;
DATA OL; SET WORKLOCL.OL; RUN;

/*ASSIGN SCRIPT DATE TO COMPASS ARCS*/
DATA CO;
SET CO;
FORMAT SCR_DT MMDDYY10.;
SCR_DT = LD_ATY_REQ_RCV - 3;
RUN;

PROC SQL;
CREATE TABLE SCFOC AS 
SELECT A.DF_PRS_ID
	,A.PF_ACT
	,A.BD_ATY_PRF
	,A.BC_ATY_TYP
	,A.BC_ATY_CNC_TYP
	,A.BX_CMT
FROM OL A
LEFT OUTER JOIN (
	SELECT BF_SSN
		,PF_REQ_ACT
		,LD_ATY_REQ_RCV
		,LX_ATY
		,LC_ATY_CMT
		,LD_ATY_RSP
		,SCR_DT
		,'X' AS COIND
	FROM CO
	) B
	ON A.DF_PRS_ID = B.BF_SSN
	AND A.PF_ACT = B.PF_REQ_ACT
	AND A.BD_ATY_PRF = B.SCR_DT
WHERE B.COIND IS NULL
AND (
	SUBSTR(B.LX_ATY, 1, 20) <> SUBSTR(A.BX_CMT, 1, 20)
	OR B.LC_ATY_CMT <> A.PF_ACT
	OR B.LD_ATY_RSP - A.BD_ATY_PRF <= 7
)
;
QUIT;

PROC SORT DATA=SCFOC;
	BY DF_PRS_ID BD_ATY_PRF PF_ACT;
RUN;

PROC SQL NOPRINT;
SELECT CEIL(COUNT(*) / 500) 
	INTO: LPUBOUND
FROM SCFOC
;
QUIT;

%MACRO CREATE_BATCHES(UBOUND);
%LET FIRST = 1;
%LET LAST = 500;
%DO I=1 %TO &UBOUND;
	DATA REPDS;
	SET SCFOC;
	IF _N_ >= &FIRST AND _N_ <= &LAST;
	RUN;
	DATA _NULL_;
	SET REPDS ;
	FILE "&RPTLIB/SkipCommOL2COCleanUp.R2.&i..txt" DELIMITER=',' DSD DROPOVER LRECL=32767;
		FORMAT DF_PRS_ID $9. ;
		FORMAT PF_ACT $5. ;
		FORMAT BD_ATY_PRF MMDDYY10. ;
		FORMAT BC_ATY_TYP $2. ;
		FORMAT BC_ATY_CNC_TYP $2. ;
		FORMAT BX_CMT $600. ;
	DO;
		PUT DF_PRS_ID $ @;
		PUT PF_ACT $ @;
		PUT BC_ATY_TYP $ @;
		PUT BC_ATY_CNC_TYP $ @;
		PUT BD_ATY_PRF @;
		PUT BX_CMT $ ;
	END;
	RUN;
	%LET FIRST = %EVAL(&LAST+1);
	%LET LAST = %EVAL(&LAST+500);
%END;
%MEND CREATE_BATCHES;
%CREATE_BATCHES(&LPUBOUND);
