/*=====================================================================================*/
/*UTLWG78 QC - COMPASS LOANS W/ IN-SCHOOL DEFERMENT; NO IN-SCHOOL ENROLLMENT ON ONELINK*/
/*=====================================================================================*/
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWG78.LWG78R2";
FILENAME REPORTZ "&RPTLIB/ULWG78.LWG78RZ";

DATA _NULL_;
     CALL SYMPUT('TODAY',"'"||PUT(INTNX('DAY',TODAY(),0,'BEGINNING'), MMDDYYD10.)||"'");
     CALL SYMPUT('RUNDT',PUT(INTNX('DAY',TODAY(),0,'BEGINNING'), MMDDYYD10.));
RUN;

%SYSLPUT TODAY = &TODAY;

LIBNAME  WORKLOCL  REMOTE  SERVER=DUSTER  SLIBREF=WORK;
RSUBMIT;
LIBNAME OLWHRM1 DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;

%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	FILENAME REPORTZ "&RPTLIB/&SQLRPT";
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE DEF_ALL AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.BF_SSN
	,A.LN_SEQ
	,D.LD_DFR_BEG
	,D.LD_DFR_END
	,SD02.LD_XPC_GRD
	,RTRIM(C.DM_PRS_1)||' '||C.DM_PRS_LST AS NAME
	,C.DF_SPE_ACC_ID

FROM OLWHRM1.LN10_LON A
INNER JOIN OLWHRM1.DF10_BR_DFR_REQ B
	ON A.BF_SSN = B.BF_SSN
INNER JOIN OLWHRM1.LN50_BR_DFR_APV D
	ON B.BF_SSN = D.BF_SSN
	AND B.LF_DFR_CTL_NUM = D.LF_DFR_CTL_NUM
	AND A.LN_SEQ = D.LN_SEQ
INNER JOIN OLWHRM1.PD10_PRS_NME C
	ON A.BF_SSN = C.DF_PRS_ID 
INNER JOIN 
	(SELECT DF_PRS_ID_STU
		,LF_STU_ENR_RPT_SEQ
		,LF_CRT_DTS_SD02
		,LC_STA_SD02
		,LD_XPC_GRD
	 FROM OLWHRM1.SD02_STU_ENR
	 WHERE LC_STA_SD02 = 'A'
	 ) SD02
	ON A.BF_SSN = SD02.DF_PRS_ID_STU
	
WHERE A.IC_LON_PGM IN 
		('SUBCNS','UNCNS','SUBSPC','UNSPC',
		 'STFFRD','UNSTFD','PLUS')
AND A.LC_STA_LON10 = 'R'
AND A.LA_CUR_PRI > 0

AND B.LC_DFR_TYP IN ('15','18')
AND B.LC_DFR_STA = 'A'

AND (D.LD_DFR_BEG <= &TODAY
	 AND D.LD_DFR_END > &TODAY
	 OR 
	 D.LD_DFR_BEG > &TODAY
	 AND D.LD_DFR_END > &TODAY)
AND D.LC_STA_LON50 = 'A'
AND D.LC_DFR_RSP <> '003'

FOR READ ONLY WITH UR
);

DISCONNECT FROM DB2;

/*	get loans to exclude because they aren't on OneLINK or have an RB task*/
	CREATE TABLE TOEXCLUDE AS
		SELECT
			LN10.BF_SSN,
			LN10.LN_SEQ
		FROM
			OLWHRM1.LN10_LON LN10
			LEFT JOIN OLWHRM1.GA10_LON_APP GA10
				ON LN10.LF_LON_ALT = GA10.AF_APL_ID
				AND LN10.LN_LON_ALT_SEQ = INPUT(GA10.AF_APL_ID_SFX,2.)
			LEFT JOIN OLWHRM1.WQ20_TSK_QUE WQ20
				ON LN10.BF_SSN = WQ20.BF_SSN
				AND WQ20.WF_QUE = 'RB'
				AND WQ20.WC_STA_WQUE20 NOT IN ('C','X')
		WHERE
			GA10.AF_APL_ID IS NULL
			AND WQ20.BF_SSN IS NOT NULL
	;

/*	remove loans to be excluded*/
	CREATE TABLE DEF AS
		SELECT
			DEFA.*
		FROM
			DEF_ALL DEFA
			LEFT JOIN TOEXCLUDE EX
				ON DEFA.BF_SSN = EX.BF_SSN
				AND DEFA.LN_SEQ = EX.LN_SEQ
		WHERE
			EX.BF_SSN IS NULL
	;


/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWG78.LWG78RZ);*/
QUIT;

ENDRSUBMIT;

DATA DEF;SET WORKLOCL.DEF;RUN;

PROC SORT DATA=DEF;BY BF_SSN LN_SEQ;RUN;

DATA DEF;
SET DEF;
PKEY=TRIM(BF_SSN)||TRIM(LEFT(PUT(LN_SEQ,6.)));
RUN;

DATA SD02 (KEEP=PKEY LD_XPC_GRD) ;
SET DEF;
RUN;

DATA DEF (DROP=LD_XPC_GRD) ;
SET DEF;
RUN;

PROC SORT DATA=DEF NODUPKEY;BY BF_SSN LN_SEQ LD_DFR_BEG LD_DFR_END NAME PKEY;RUN;

/*DATA SET INITIALIZATION*/
PROC SQL;
CREATE TABLE PKEY_LIST AS 
SELECT DISTINCT PKEY
FROM DEF
GROUP BY PKEY
HAVING COUNT(*) > 1;
QUIT;
RUN;
DATA REAL_DEF;
RUN;
DATA MASTER;
RUN;
DATA DEF_BREAK;
RUN; 

DATA _NULL_;
SET PKEY_LIST;
	CALL SYMPUT('COUNT',TRIM(_N_));
RUN;

%PUT &COUNT;

%MACRO STPONE(I_NUM);
DATA _NULL_;
SET PKEY_LIST;
IF _N_ = &I_NUM THEN DO;
	CALL SYMPUT ('PKEY',TRIM(PKEY));
	END;
RUN;

/*%PUT &PKEY;*/

DATA STP1;
SET DEF(WHERE = (PKEY EQ "&PKEY"));
RUN;

PROC SORT DATA=STP1;BY LD_DFR_BEG;RUN;

DATA _NULL_;
SET STP1;
	CALL SYMPUT('RW_COUNT',TRIM(_N_));
	CALL SYMPUT('I_COUNT',TRIM(_N_ - 1));
RUN;

/*%PUT &I_COUNT;*/
/*%PUT &RW_COUNT;*/

PROC TRANSPOSE DATA=STP1 OUT=DEF_BEG (DROP=_NAME_ _LABEL_) PREFIX=BEG_DT;
VAR LD_DFR_BEG;
BY PKEY;
RUN;

PROC TRANSPOSE DATA=STP1 OUT=DEF_END (DROP=_NAME_ _LABEL_) PREFIX=END_DT;
VAR LD_DFR_END;
BY PKEY;
RUN;

DATA DEFA;
MERGE DEF_BEG DEF_END;
BY PKEY;
RUN;

/*%MACRO GREAT2;*/
%LET C = 1;
%LET C2 = 2;
	%DO I=1 %TO &I_COUNT;
			DATA STPB;
				SET DEFA;
	/*			%PUT &I*/
	/*			%PUT &I_COUNT;*/
	/*			%PUT BEG_DT&C2 - END_DT&C;*/
				VAL/*&C*/ = BEG_DT&C2 - END_DT&C;
			RUN;
			DATA MASTER;
				SET MASTER STPB;
			RUN;
		%LET C = %EVAL(&C+1);
		%LET C2 = %EVAL(&C2+1);
	%END;
/*%MEND GREAT2;*/
/*%GREAT2;*/

DATA MASTER (WHERE=(PKEY NE ' ') /*KEEP=DF_PRS_ID_STU VAL*/);
SET MASTER;
RUN;

DATA TEST;
SET MASTER;
RUN;

DATA MASTER;
SET MASTER;
BY PKEY;
DIF+VAL;
IF LAST.PKEY THEN OUTPUT;
RUN;

DATA _NULL_;
SET MASTER;
	CALL SYMPUT('DIF',DIF);
RUN;

/*%PUT DIF=&DIF;*/
/*%PUT RW_COUNT=&RW_COUNT;*/

/*%MACRO X;*/
%IF &DIF = &I_COUNT %THEN %DO;
	PROC SQL;
		CREATE TABLE REAL_DEF_STEP AS 
		SELECT DISTINCT PKEY
		,MIN(LD_DFR_BEG) AS DEF_START FORMAT=MMDDYY10.
		,MAX(LD_DFR_END) AS DEF_END FORMAT=MMDDYY10.
		FROM STP1;
		QUIT;
	RUN;
	DATA REAL_DEF;
		SET REAL_DEF_STEP REAL_DEF;
	RUN;
	%END;
%ELSE %DO;
	DATA DTL;
		SET TEST;
		X=_N_;
	RUN;
	DATA DEF_BRK;
		SET DTL;
		WHERE VAL > 1;
		BY PKEY X;
		IF FIRST.PKEY THEN OUTPUT;
	RUN;
	DATA _NULL_;
		SET DEF_BRK;
		CALL SYMPUT('NCRT1',"BEG_DT"||TRIM(LEFT(X)));
		CALL SYMPUT('NCRT2',"END_DT"||TRIM(LEFT(X)));
	RUN;
	/*%MACRO SUBMAC;*/
	DATA DEF_BRK (KEEP=PKEY DEF_START DEF_END);
		SET DEF_BRK;
		FORMAT DEF_START MMDDYY10. DEF_END MMDDYY10.;
		DEF_START = &NCRT1;
		DEF_END = &NCRT2;
	RUN;
	/*%MEND SUBMAC;*/
	/*%SUBMAC;*/
	DATA DEF_BREAK;
		SET DEF_BRK DEF_BREAK;
	RUN;
%END;
RUN;

DATA MASTER;
RUN;
DATA DEF_BRK;
RUN;
/*%MEND X;*/
/*%X;*/
%MEND STPONE;
/*%STPONE(103);*/
%MACRO STPTWO;
%DO X=1 %TO &COUNT;
	%PUT *************;
	%PUT X = &X;
	%PUT *************;
	%STPONE(&X);
%END;
%MEND STPTWO;
%STPTWO;

DATA REAL_DEF (WHERE=(PKEY NE ' '));
SET REAL_DEF DEF_BREAK;
RUN;

PROC SORT DATA=DEF;BY PKEY;RUN;
PROC SORT DATA=REAL_DEF;BY PKEY;RUN;

DATA USE (WHERE=(PKEY NE ' '));
MERGE DEF (IN=A) REAL_DEF (IN=B);
BY PKEY;
IF B THEN MIND = 'Y';
RUN;

DATA USE (DROP=LD_DFR_BEG LD_DFR_END MIND);
SET USE;
IF MIND = '' THEN DO;
	DEF_START = LD_DFR_BEG;
	DEF_END = LD_DFR_END;
	END;
ELSE DO;
	DEF_START = DEF_START;
	DEF_END = DEF_END;
	END;
RUN;

PROC SORT DATA=USE NODUPKEY;BY PKEY;RUN;
PROC SORT DATA=SD02 NODUPKEY;BY PKEY LD_XPC_GRD;RUN;

DATA USE;
MERGE USE SD02;
BY PKEY;
RUN;

DATA USE2 (KEEP=BF_SSN);
SET USE;
IF DEF_END = LD_XPC_GRD THEN OUTPUT;
RUN;

PROC SORT DATA=USE;BY BF_SSN;RUN;
PROC SORT DATA=USE2;BY BF_SSN;RUN;

DATA USE;
MERGE USE (IN=A) USE2 (IN=B);
BY BF_SSN;
IF A AND NOT B;
RUN;

PROC SORT DATA=USE NODUPKEY;BY BF_SSN;RUN;

PROC SORT DATA=USE; BY DF_SPE_ACC_ID; RUN;

DATA _NULL_;
	SET USE ;
	FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
	PUT DF_SPE_ACC_ID 'ERBEQ,,,,,,,ALL,In-school Def end date review' ;
RUN;
