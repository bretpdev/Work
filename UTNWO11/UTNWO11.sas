/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORTZ "&RPTLIB/UNWO11.NWO11RZ";
FILENAME REPORT2 "&RPTLIB/UNWO11.NWO11R2";

LIBNAME  LEGEND  REMOTE  SERVER=LEGEND SLIBREF=work  ;
RSUBMIT LEGEND;
%let DB = DNFPUTDL;  *This is live;

LIBNAME PKUB DB2 DATABASE=&DB OWNER=PKUB;

%MACRO SQLCHECK ;
  %IF  &SQLXRC NE 0  %THEN  %DO  ;
    DATA _NULL_  ;
            FILE REPORTZ NOTITLES  ;
            PUT @01 " ********************************************************************* "
              / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
              / @01 " ****  THE SAS SHOULD BE REVIEWED.                                **** "       
              / @01 " ********************************************************************* "
              / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
              / @01 " ****  &SQLXMSG   **** "
              / @01 " ********************************************************************* "
            ;
         RUN  ;
  %END  ;
%MEND  ;

PROC SQL;
CONNECT TO DB2 (DATABASE=&DB);
CREATE TABLE SCHEDULES AS
	SELECT	*
	FROM	CONNECTION TO DB2 (
				SELECT	
						DISTINCT
						A.DF_SPE_ACC_ID
						,B.LN_SEQ
						,B.IC_LON_PGM
						,CASE
							WHEN B.IC_LON_PGM IN ('STFFRD', 'UNSTFD', 'SLS', 'PLUSGB', 'DLSTFD', 'DLUNST', 'DLPLGB', 'TEACH') THEN 'S'
							WHEN B.IC_LON_PGM IN ('PLUS', 'DLPLUS') THEN 'P'
							WHEN B.IC_LON_PGM IN ('DLSSPL', 'DLUSPL', 'SUBCNS', 'SUBSPC', 'DLUCNS', 'DLSCNS', 'DLPCNS', 'UNCNS') THEN 'C'
							ELSE 'O'
						END AS LN_CAT
						,D.LC_TYP_SCH_DIS
						,C.LN_RPS_SEQ
				FROM	PKUB.PD10_PRS_NME A
						INNER JOIN PKUB.LN10_LON B
							ON A.DF_PRS_ID = B.BF_SSN
						INNER JOIN PKUB.RS10_BR_RPD C 
							ON A.DF_PRS_ID = C.BF_SSN
						INNER JOIN PKUB.LN65_LON_RPS D
							ON A.DF_PRS_ID = D.BF_SSN
							AND B.LN_SEQ = D.LN_SEQ
							AND C.LN_RPS_SEQ = D.LN_RPS_SEQ
				WHERE	B.LA_CUR_PRI > 0
						AND B.LC_STA_LON10 = 'R'
						AND C.LC_STA_RPST10 = 'A'
				ORDER BY A.DF_SPE_ACC_ID
				FOR READ ONLY WITH UR
			);
DISCONNECT FROM DB2;

/*THE JOB RUNS A LOT FASTER IF THE 'EXISTS' SUBQUERY IN 'CREATE TABLE ERRORS AS' HAS FEWER RECORDS TO REVIEW*/
CREATE TABLE DUPS_TYP AS
	SELECT	* 
	FROM 	(SELECT DF_SPE_ACC_ID, COUNT(DISTINCT LC_TYP_SCH_DIS) AS CNT FROM SCHEDULES GROUP BY DF_SPE_ACC_ID) A
	WHERE 	A.CNT > 1;

CREATE TABLE DUPS AS
	SELECT 	B.*
	FROM 	DUPS_TYP A
			INNER JOIN SCHEDULES B ON
				A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID;

CREATE TABLE ERRORS AS
	SELECT 	DISTINCT 
			A.DF_SPE_ACC_ID
	FROM	DUPS A
	WHERE	EXISTS (SELECT 	B.DF_SPE_ACC_ID
					FROM	DUPS B
					WHERE	A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID
							AND A.LN_CAT = B.LN_CAT
							AND A.LC_TYP_SCH_DIS <> B.LC_TYP_SCH_DIS);

/*CREATE TABLE TEST_DETAIL AS*/
/*	SELECT	B.**/
/*	FROM	ERRORS A*/
/*			INNER JOIN SCHEDULES B ON*/
/*				A.DF_SPE_ACC_ID = B.DF_SPE_ACC_ID;*/

/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>> ;  ** INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK;*/
QUIT;

ENDRSUBMIT;
DATA ERRORS; SET LEGEND.ERRORS; RUN;
DATA TEST_DETAIL; SET LEGEND.TEST_DETAIL; RUN;

DATA _NULL_;
SET ERRORS ;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
PUT DF_SPE_ACC_ID 'AMFDD,,,,,,,ALL,borrower has different repayment schedule types please review' ;
RUN;

/*COMMENT OUT FOR PRODUCTION*/
/*PROC EXPORT*/
/*		DATA=TEST_DETAIL*/
/*		OUTFILE='T:\SAS\UTNWO11 TEST DETAIL.XLSX'*/
/*		REPLACE;*/
/*RUN;*/
