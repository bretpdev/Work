CREATE PROCEDURE [idruserpro].[GetBorrowerLoanDebtStatus]
	@SSN VARCHAR(10)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @BorrowerExists BIT = CASE WHEN (SELECT COUNT(1) FROM PD10_PRS_NME WHERE DF_PRS_ID = @SSN) > 0 THEN 1 ELSE 0 END

IF (@BorrowerExists = 1) 
	BEGIN
		SELECT 
			CASE WHEN SUM(CASE WHEN ISNULL(LN10.LA_CUR_PRI, 0) > 0 AND ISNULL(LN10.LC_STA_LON10, '') = 'R' THEN 1 ELSE 0 END) > 0 THEN 1 ELSE 0 END [HasReleasedLoans],
			CASE WHEN SUM(CASE WHEN ISNULL(LN10.LC_STA_LON10, '') != 'D' THEN 1 ELSE 0 END) > 0 THEN 0 ELSE 1 END [HasAllLoansDeconverted]
		FROM 
			PD10_PRS_NME PD10
			LEFT JOIN LN10_LON LN10 
				ON LN10.BF_SSN = PD10.DF_PRS_ID
		WHERE
			PD10.DF_PRS_ID = @SSN
	END
ELSE
	BEGIN
		SELECT NULL, NULL
	END

RETURN 0
