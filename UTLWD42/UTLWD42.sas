%LET numdate = %SYSFUNC(today(), yymmddn8.);
%LET RPTLIB = X:\PADD\FTP; *for JAMS runs;
%LET RPTLIB2 = X:\Archive\SAS; *for JAMS runs;
/*%LET RPTLIB = T:\SAS\; *for local runs; */
FILENAME REPORT2 "&RPTLIB/UTLWD42.LWD42R2.&numdate";
FILENAME REPORT3 "&RPTLIB/UTLWD42.LWD42R3.&numdate";
FILENAME REPORT4 "&RPTLIB/UTLWD42.LWD42R4.&numdate";
FILENAME REPORT5 "&RPTLIB/UTLWD42.LWD42R5.&numdate";
FILENAME REPORT6 "&RPTLIB/UTLWD42.LWD42R6.&numdate";
FILENAME REPORT7 "&RPTLIB/UTLWD42.LWD42R7.&numdate";

/*Archive files*/
FILENAME REPORT8 "&RPTLIB2/UTLWD42.LWD42R2.&numdate";
FILENAME REPORT9 "&RPTLIB2/UTLWD42.LWD42R3.&numdate";
FILENAME REPORT10 "&RPTLIB2/UTLWD42.LWD42R4.&numdate";
FILENAME REPORT11 "&RPTLIB2/UTLWD42.LWD42R5.&numdate";
FILENAME REPORT12 "&RPTLIB2/UTLWD42.LWD42R6.&numdate";
FILENAME REPORT13 "&RPTLIB2/UTLWD42.LWD42R7.&numdate";

LIBNAME  DUSTER  REMOTE  SERVER=DUSTER  SLIBREF=WORK;
RSUBMIT;

PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE BORROWERS AS
	SELECT 
		*
	FROM CONNECTION TO DB2 
	(
		SELECT DISTINCT
			SSN
			,Date_of_Birth
			,Last_Name
			,First_Name
			,Customer_Record_ID
			,Active_Duty_Status_Date
			,Middle_Name
			/*,SUM(SUM1+SUM2+LA_CLM_PRJ_COL_CST) AS LOAN*/
		FROM 
		(
			SELECT DISTINCT
				PD01.DF_PRS_ID		AS SSN
				,PD01.DD_BRT		AS Date_of_Birth
				,PD01.DM_PRS_LST	AS Last_Name
				,PD01.DM_PRS_1		AS First_Name
				,PD01.DF_SPE_ACC_ID	AS Customer_Record_ID
				,DATE(CURRENT DATE)	AS Active_Duty_Status_Date
				,PD01.DM_PRS_MID	AS Middle_Name
				,SUM(
						DC01.LA_CLM_PRI
						+ DC01.LA_CLM_INT
						- DC01.LA_PRI_COL
						+ DC01.LA_INT_ACR
						+ DC02.LA_CLM_INT_ACR
						- DC01.LA_INT_COL
					) AS SUM1	
				,SUM(
						DC01.LA_LEG_CST_ACR
						- DC01.LA_LEG_CST_COL
						+ DC01.LA_OTH_CHR_ACR
						- DC01.LA_OTH_CHR_COL
						+ DC01.LA_COL_CST_ACR
						- DC01.LA_COL_CST_COL
					) AS SUM2
				,DC02.LA_CLM_PRJ_COL_CST
			FROM
				OLWHRM1.PD01_PDM_INF PD01
				INNER JOIN OLWHRM1.DC01_LON_CLM_INF DC01
					ON PD01.DF_PRS_ID = DC01.BF_SSN
				INNER JOIN OLWHRM1.DC02_BAL_INT DC02
					ON DC01.AF_APL_ID = DC02.AF_APL_ID
					AND DC01.AF_APL_ID_SFX = DC02.AF_APL_ID_SFX
					AND DC01.LF_CRT_DTS_DC10 = DC02.LF_CRT_DTS_DC10		
			WHERE
				DC01.LC_STA_DC10  = '03'
				AND DC01.LC_AUX_STA NOT IN ('02', '03', '07') 
				AND DC01.LC_PCL_REA IN ('DF', 'DQ', 'DB') 
				AND DC01.LC_REA_CLM_ASN_DOE NOT IN ('01', '03', '23')
			GROUP BY
				PD01.DF_PRS_ID
				,PD01.DD_BRT
				,PD01.DM_PRS_LST
				,PD01.DM_PRS_1
				,PD01.DF_SPE_ACC_ID
				,DATE(CURRENT DATE)
				,PD01.DM_PRS_MID
				,DC02.LA_CLM_PRJ_COL_CST
		)
		WHERE 
		 	SUM1 + SUM2 + LA_CLM_PRJ_COL_CST > 0
		/*GROUP BY*/
			/*SSN*/
			/*,Date_of_Birth*/
			/*,Last_Name*/
			/*,First_Name*/
			/*,Customer_Record_ID*/
			/*,Active_Duty_Status_Date*/
			/*,Middle_Name*/

		FOR READ ONLY WITH UR
	)
;
CREATE TABLE ENDORSERS AS
	SELECT 
		*
	FROM CONNECTION TO DB2 
	(
		SELECT DISTINCT
			SSN
			,Date_of_Birth
			,Last_Name
			,First_Name
			,Customer_Record_ID
			,Active_Duty_Status_Date
			,Middle_Name
			/*,SUM(SUM1+SUM2+LA_CLM_PRJ_COL_CST) AS LOAN*/
		FROM 
		(
			SELECT DISTINCT
				PD01.DF_PRS_ID		AS SSN
				,PD01.DD_BRT		AS Date_of_Birth
				,PD01.DM_PRS_LST	AS Last_Name
				,PD01.DM_PRS_1		AS First_Name
				,PD01.DF_SPE_ACC_ID	AS Customer_Record_ID
				,DATE(CURRENT DATE)	AS Active_Duty_Status_Date
				,PD01.DM_PRS_MID	AS Middle_Name
				,SUM(
						DC01.LA_CLM_PRI
						+ DC01.LA_CLM_INT
						- DC01.LA_PRI_COL
						+ DC01.LA_INT_ACR
						+ DC02.LA_CLM_INT_ACR
						- DC01.LA_INT_COL
					) AS SUM1	
				,SUM(
						DC01.LA_LEG_CST_ACR
						- DC01.LA_LEG_CST_COL
						+ DC01.LA_OTH_CHR_ACR
						- DC01.LA_OTH_CHR_COL
						+ DC01.LA_COL_CST_ACR
						- DC01.LA_COL_CST_COL
					) AS SUM2
				,DC02.LA_CLM_PRJ_COL_CST
			FROM
				OLWHRM1.PD01_PDM_INF PD01
				INNER JOIN OLWHRM1.GA01_APP GA01
					ON PD01.DF_PRS_ID = GA01.DF_PRS_ID_EDS
				INNER JOIN OLWHRM1.GA10_LON_APP GA10
					ON GA01.AF_APL_ID = GA10.AF_APL_ID
				INNER JOIN OLWHRM1.DC01_LON_CLM_INF DC01
					ON GA10.AF_APL_ID = DC01.AF_APL_ID
					AND GA10.AF_APL_ID_SFX = DC01.AF_APL_ID_SFX		
				INNER JOIN OLWHRM1.DC02_BAL_INT DC02
					ON DC01.AF_APL_ID = DC02.AF_APL_ID
					AND DC01.AF_APL_ID_SFX = DC02.AF_APL_ID_SFX
					AND DC01.LF_CRT_DTS_DC10 = DC02.LF_CRT_DTS_DC10				
			WHERE
				DC01.LC_STA_DC10  = '03'
				AND DC01.LC_AUX_STA NOT IN ('02', '03', '07') 
				AND DC01.LC_PCL_REA IN ('DF', 'DQ', 'DB') 
				AND DC01.LC_REA_CLM_ASN_DOE NOT IN ('01', '03', '23') 
			GROUP BY
				PD01.DF_PRS_ID
				,PD01.DD_BRT
				,PD01.DM_PRS_LST
				,PD01.DM_PRS_1
				,PD01.DF_SPE_ACC_ID
				,DATE(CURRENT DATE)
				,PD01.DM_PRS_MID
				,DC02.LA_CLM_PRJ_COL_CST
		)
		WHERE 
			SUM1 + SUM2 + LA_CLM_PRJ_COL_CST > 0
		/*GROUP BY*/
			/*SSN*/
			/*,Date_of_Birth*/
			/*,Last_Name*/
			/*,First_Name*/
			/*,Customer_Record_ID*/
			/*,Active_Duty_Status_Date*/
			/*,Middle_Name*/

		FOR READ ONLY WITH UR
	)
;
DISCONNECT FROM DB2;
QUIT;

ENDRSUBMIT;

DATA BORROWERS; SET DUSTER.BORROWERS; RUN;
DATA ENDORSERS; SET DUSTER.ENDORSERS; RUN;

/*concatenates both data sets into one*/
DATA JOINT;
	SET 
		BORROWERS 
		ENDORSERS 
	;
	FORMAT 
		DATE_OF_BIRTH
		ACTIVE_DUTY_STATUS_DATE
		YYMMDDn8.
	;
RUN;

/*sets up file to run macro that generates new file every 250k records*/
PROC SQL NOPRINT;
  SELECT COUNT(*) INTO: NOBS
  FROM JOINT
  ;
QUIT;

DATA REP;
  PUT "&NOBS";
  NREP = INT(&NOBS/249999) + 1;
RUN;

%MACRO ORG (REP);
DATA OUTPT&REP;
	ATTRIB SSN LENGTH=$9.;
RUN;
%MEND ORG;
%ORG (1);
%ORG (2);
%ORG (3);
%ORG (4);
%ORG (5);
%ORG (6);


%ORG (7);
%ORG (8);
%ORG (9);
%ORG (10);
%ORG (11);
%ORG (12);

DATA _NULL_;
    IF 0 THEN SET JOINT NOBS=N;
    DO I=1 TO CEIL(N/249999);
        CALL EXECUTE (CATS("DATA OUTPT",I)||";");
        CALL EXECUTE ("SET JOINT(FIRSTOBS="||(I-1)*249999+1||" OBS="||I*249999||");");
        CALL EXECUTE ("RUN;");
    END;
RUN;

%MACRO CRE8 (RNUM,INUM);
    DATA _NULL_;
		SET OUTPT&INUM END=EOF;
		FILE REPORT&RNUM DROPOVER LRECL=32767;
		DO;
			PUT @1 SSN   			
				@10 DATE_OF_BIRTH
				@18 LAST_NAME
				@44 FIRST_NAME
				@64 CUSTOMER_RECORD_ID
				@92 ACTIVE_DUTY_STATUS_DATE
				@100 MIDDLE_NAME;
			END;

		IF EOF THEN DO;
			PUT @1 'EOF';
			END;
		RUN;
%MEND;
%CRE8 (2,1);
%CRE8 (3,2);
%CRE8 (4,3);
%CRE8 (5,4);
%CRE8 (6,5);
%CRE8 (7,6);
/*Archive files*/
%CRE8 (8,1);
%CRE8 (9,2);
%CRE8 (10,3);
%CRE8 (11,4);
%CRE8 (12,5);
%CRE8 (13,6);
