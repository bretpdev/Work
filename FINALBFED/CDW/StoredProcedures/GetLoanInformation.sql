CREATE PROCEDURE [finalbfed].[GetLoanInformation]
	@AccountNumber VARCHAR(10),
	@IsCoborrower BIT = 0
AS
BEGIN
	
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE	@LetterId VARCHAR(10) = 'TS06BFNBIL'
DECLARE @PF_REQ_ACT VARCHAR(5) = (SELECT AC11.PF_REQ_ACT FROM AC11_ACT_REQ_LTR AC11 WHERE PF_LTR = @LetterId)

IF @IsCoborrower = 0
	BEGIN
		SELECT
			COALESCE(FMT.label,LN10.IC_LON_PGM) AS LoanProgram,
			CONVERT(VARCHAR, LN10.LD_LON_1_DSB, 101) AS DisbDate,
			LN10.LA_LON_AMT_GTR AS OrigPrincipalBalance,
			DW01.WA_TOT_BRI_OTS AS OutstandingInterestDue,
			SUM(COALESCE(PAYMENTS_SINCE_LAST_STATEMENT.PRINCIPAL_PAID, 0.00)) AS PrincipalPaidSinceLastStatement,
			SUM(COALESCE(PAYMENTS_SINCE_LAST_STATEMENT.INTEREST_PAID, 0.00)) AS InterestPaidSinceLastStatement,
			SUM(COALESCE(PAYMENTS_SINCE_LAST_STATEMENT.FEES_PAID, 0.00)) AS FeesPaidSinceLastPayment,
			SUM((COALESCE(PAYMENTS_SINCE_LAST_STATEMENT.PRINCIPAL_PAID,0.00) + COALESCE(PAYMENTS_SINCE_LAST_STATEMENT.INTEREST_PAID,0.00) + COALESCE(PAYMENTS_SINCE_LAST_STATEMENT.FEES_PAID,0.00))) AS TotalPaidSinceLastStatement,
			LN10.LA_CUR_PRI AS CurrentPrincipalBalance,
			LN72.LR_ITR AS InterestRate,
			MAX_BILL.LA_BIL_PAS_DU AS AmountPastDue,
			MAX_BILL.LA_LTE_FEE_OTS_PRT AS OutStandingLastFees,
			COALESCE(TOTAL_PAID.TOTAL_PRINCIPAL_PAID, 0.00) AS TotalPrincipalPaid,
			COALESCE(TOTAL_PAID.TOTAL_INTEREST_PAID,0.00) AS TotalInterestPaid,
			COALESCE(TOTAL_PAID.TOTAL_FEES_PAID,0.00) AS TotalFeesPaid,
			CONVERT(VARCHAR,COALESCE(TOTAL_PAID.DateLastPaymentReceived,'01/01/1900'),101) AS DateLastPaymentReceived,
			(COALESCE(LN10.LA_CUR_PRI,0.00) + COALESCE(MAX_BILL.LA_LTE_FEE_OTS_PRT,0.00) + COALESCE(DW01.WA_TOT_BRI_OTS,0.00)) AS LoanPayoff
		FROM	
			PD10_PRS_NME PD10
			INNER JOIN LN10_LON LN10
				ON LN10.BF_SSN = PD10.DF_PRS_ID
			INNER JOIN DW01_DW_CLC_CLU DW01
				ON DW01.BF_SSN = LN10.BF_SSN
				AND DW01.LN_SEQ = LN10.LN_SEQ
			INNER JOIN
			(	
				SELECT 
					LN80.BF_SSN,
					LN80.LN_SEQ,
					MaxLN80.MAX_CREATE_DATE AS MAX_CREATE_DATE,
					COALESCE(LN80.LA_BIL_PAS_DU,0.00) AS LA_BIL_PAS_DU,
					CAST(LN80.LD_BIL_DU_LON AS DATE) AS LD_BIL_DU_LON,
					COALESCE(LN80.LA_LTE_FEE_OTS_PRT,0.00) AS LA_LTE_FEE_OTS_PRT
				FROM 
					LN80_LON_BIL_CRF LN80
					INNER JOIN PD10_PRS_NME PD10
						ON PD10.DF_PRS_ID = LN80.BF_SSN
					INNER JOIN 
					(
						SELECT
							LN80MaxBill.BF_SSN,
							LN80MaxBill.LN_SEQ,
							CAST(MAX(LN80MaxBill.LD_BIL_CRT) AS DATE) AS MAX_CREATE_DATE
						FROM
							LN80_LON_BIL_CRF LN80MaxBill
						GROUP BY
							LN80MaxBill.BF_SSN,
							LN80MaxBill.LN_SEQ
					) MaxLN80
						ON MaxLN80.BF_SSN = LN80.BF_SSN
						AND MaxLN80.LN_SEQ = LN80.LN_SEQ
						AND MaxLN80.MAX_CREATE_DATE = LN80.LD_BIL_CRT
				WHERE
					PD10.DF_SPE_ACC_ID = @AccountNumber
			) MAX_BILL
				ON MAX_BILL.BF_SSN = LN10.BF_SSN
				AND MAX_BILL.LN_SEQ = LN10.LN_SEQ
			INNER JOIN
			(	--Getting Active SCRA Dates
				SELECT
					LN72.BF_SSN, 
					LN72.LN_SEQ,
					LN72.LR_ITR,
					ROW_NUMBER() OVER (PARTITION BY LN72.BF_SSN, LN72.LN_SEQ ORDER BY LD_ITR_EFF_BEG DESC) AS SEQ
				FROM
					LN72_INT_RTE_HST LN72
					INNER JOIN PD10_PRS_NME PD10 
						ON PD10.DF_PRS_ID = LN72.BF_SSN
					WHERE
						LN72.LC_STA_LON72 = 'A'
						AND	CAST(GETDATE() AS DATE) BETWEEN LN72.LD_ITR_EFF_BEG AND LN72.LD_ITR_EFF_END
						AND PD10.DF_SPE_ACC_ID = @AccountNumber
			) LN72 
				ON LN10.BF_SSN = LN72.BF_SSN
				AND LN10.LN_SEQ = LN72.LN_SEQ
				AND LN72.SEQ = 1
			INNER JOIN
			(
				SELECT
					LN85.BF_SSN,
					LN85.LN_SEQ
				FROM
					LN85_LON_ATY LN85
					INNER JOIN --GETS THE MOST RECENT ARC LEFT ON THE BORROWERS ACCOUNT TO GET THE LOAN SEQ'S THE LETTER APPLIES TO
					(
						SELECT
							AY10.BF_SSN,
							MAX(AY10.LN_ATY_SEQ) AS LN_ATY_SEQ,
							MAX(AY10.LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
						FROM 
							AY10_BR_LON_ATY AY10
							INNER JOIN PD10_PRS_NME PD10
								ON PD10.DF_PRS_ID = AY10.BF_SSN
						WHERE
							AY10.PF_REQ_ACT = @PF_REQ_ACT
							AND PD10.DF_SPE_ACC_ID = @AccountNumber
						GROUP BY
							AY10.BF_SSN
					)AY10
						ON AY10.BF_SSN = LN85.BF_SSN
						AND AY10.LN_ATY_SEQ = LN85.LN_ATY_SEQ
			)LN85
				ON LN85.BF_SSN = LN10.BF_SSN
				AND LN85.LN_SEQ = LN10.LN_SEQ
			LEFT JOIN
			(
				SELECT
					LN90.BF_SSN,
					LN90.LN_SEQ,
					CAST(LN90.LD_FAT_EFF AS DATE) AS LD_FAT_EFF,
					ABS(SUM(COALESCE(LN90.LA_FAT_NSI,0.00))) AS INTEREST_PAID,
					ABS(SUM(COALESCE(LN90.LA_FAT_LTE_FEE,0.00))) AS FEES_PAID,
					ABS(SUM(COALESCE(LN90.LA_FAT_CUR_PRI,0.00))) AS PRINCIPAL_PAID
				FROM
					LN90_FIN_ATY LN90
					INNER JOIN PD10_PRS_NME PD10
						ON PD10.DF_PRS_ID = LN90.BF_SSN 
				WHERE
					LN90.PC_FAT_TYP = '10'
					AND LN90.PC_FAT_SUB_TYP = '10'
					AND LN90.LC_STA_LON90 = 'A'
					AND COALESCE(LN90.LC_FAT_REV_REA,'') = '' --not reversed
					AND PD10.DF_SPE_ACC_ID = @AccountNumber
				GROUP BY
					LN90.BF_SSN,
					LN90.LN_SEQ,
					LN90.LD_FAT_EFF
			) PAYMENTS_SINCE_LAST_STATEMENT
				ON PAYMENTS_SINCE_LAST_STATEMENT.BF_SSN = LN10.BF_SSN
				AND PAYMENTS_SINCE_LAST_STATEMENT.LN_SEQ = LN10.LN_SEQ
				AND PAYMENTS_SINCE_LAST_STATEMENT.LD_FAT_EFF > MAX_BILL.MAX_CREATE_DATE
			LEFT JOIN
			(
				SELECT  
					LN90.BF_SSN,
					LN90.LN_SEQ,
					ABS(SUM(COALESCE(LN90.LA_FAT_CUR_PRI,0.00) + COALESCE(LN90.LA_FAT_ILG_PRI,0.00))) AS TOTAL_PRINCIPAL_PAID, --PAYMENTS ARE NEGATIVE AMOUNTS SO WE GET THE abs OF THE SUM
					ABS(SUM(COALESCE(LN90.LA_FAT_NSI,0.00))) AS TOTAL_INTEREST_PAID,
					ABS(SUM(COALESCE(LN90.LA_FAT_LTE_FEE,0.00) + COALESCE(LN90.LA_FAT_ILG_PRI,0.00))) AS TOTAL_FEES_PAID,
					CONVERT(VARCHAR,MAX(LN90.LD_FAT_EFF),101) AS DateLastPaymentReceived
				FROM 
					LN90_FIN_ATY LN90
					INNER JOIN PD10_PRS_NME PD10
						ON PD10.DF_PRS_ID = LN90.BF_SSN
				WHERE 
					LN90.PC_FAT_TYP = '10'
					AND LN90.LC_STA_LON90 = 'A'
					AND COALESCE(LN90.LC_FAT_REV_REA,'') = ''  --not reversed
					AND PD10.DF_SPE_ACC_ID = @AccountNumber
				GROUP BY 
					LN90.BF_SSN,
					LN90.LN_SEQ
			) TOTAL_PAID
				ON TOTAL_PAID.BF_SSN = LN10.BF_SSN
				AND TOTAL_PAID.LN_SEQ = LN10.LN_SEQ
			LEFT JOIN FormatTranslation FMT
				ON FMT.Start = LN10.IC_LON_PGM
				AND FMT.FmtName = '$LNPROG'
		WHERE
			PD10.DF_SPE_ACC_ID = @AccountNumber
		GROUP BY
			COALESCE(FMT.label,LN10.IC_LON_PGM),
			LN10.LD_LON_1_DSB,
			LN10.LA_LON_AMT_GTR,
			DW01.WA_TOT_BRI_OTS,
			LN10.LA_CUR_PRI,
			LN72.LR_ITR,
			MAX_BILL.LA_LTE_FEE_OTS_PRT,
			COALESCE(TOTAL_PAID.TOTAL_PRINCIPAL_PAID, 0.00),
			COALESCE(TOTAL_PAID.TOTAL_INTEREST_PAID,0.00),
			COALESCE(TOTAL_PAID.TOTAL_FEES_PAID,0.00),
			CONVERT(VARCHAR,COALESCE(TOTAL_PAID.DateLastPaymentReceived,'01/01/1900'),101) ,
			(COALESCE(LN10.LA_CUR_PRI,0.00) + COALESCE(MAX_BILL.LA_LTE_FEE_OTS_PRT,0.00) + COALESCE(DW01.WA_TOT_BRI_OTS,0.00)),
			MAX_BILL.LA_BIL_PAS_DU
	END
ELSE --Begin coborrower portion
	BEGIN
		SELECT DISTINCT
			COALESCE(FMT.label,LN10.IC_LON_PGM) AS LoanProgram,
			CONVERT(VARCHAR, LN10.LD_LON_1_DSB, 101) AS DisbDate,
			LN10.LA_LON_AMT_GTR AS OrigPrincipalBalance,
			DW01.WA_TOT_BRI_OTS AS OutstandingInterestDue,
			SUM(COALESCE(PAYMENTS_SINCE_LAST_STATEMENT.PRINCIPAL_PAID, 0.00)) AS PrincipalPaidSinceLastStatement,
			SUM(COALESCE(PAYMENTS_SINCE_LAST_STATEMENT.INTEREST_PAID, 0.00)) AS InterestPaidSinceLastStatement,
			SUM(COALESCE(PAYMENTS_SINCE_LAST_STATEMENT.FEES_PAID, 0.00)) AS FeesPaidSinceLastPayment,
			SUM((COALESCE(PAYMENTS_SINCE_LAST_STATEMENT.PRINCIPAL_PAID,0.00) + COALESCE(PAYMENTS_SINCE_LAST_STATEMENT.INTEREST_PAID,0.00) + COALESCE(PAYMENTS_SINCE_LAST_STATEMENT.FEES_PAID,0.00))) AS TotalPaidSinceLastStatement,
			LN10.LA_CUR_PRI AS CurrentPrincipalBalance,
			LN72.LR_ITR AS InterestRate,
			MAX_BILL.LA_BIL_PAS_DU AS AmountPastDue,
			MAX_BILL.LA_LTE_FEE_OTS_PRT AS OutStandingLastFees,
			COALESCE(TOTAL_PAID.TOTAL_PRINCIPAL_PAID, 0.00) AS TotalPrincipalPaid,
			COALESCE(TOTAL_PAID.TOTAL_INTEREST_PAID,0.00) AS TotalInterestPaid,
			COALESCE(TOTAL_PAID.TOTAL_FEES_PAID,0.00) AS TotalFeesPaid,
			CONVERT(VARCHAR,COALESCE(TOTAL_PAID.DateLastPaymentReceived,'01/01/1900'),101) AS DateLastPaymentReceived,
			(COALESCE(LN10.LA_CUR_PRI,0.00) + COALESCE(MAX_BILL.LA_LTE_FEE_OTS_PRT,0.00) + COALESCE(DW01.WA_TOT_BRI_OTS,0.00)) AS LoanPayoff
		FROM	
			PD10_PRS_NME PD10
			INNER JOIN LN20_EDS LN20
				ON LN20.LF_EDS = PD10.DF_PRS_ID
				AND LN20.LC_EDS_TYP = 'M'
				AND LN20.LC_STA_LON20 = 'A'
			INNER JOIN LN10_LON LN10
				ON LN10.BF_SSN = LN20.BF_SSN
				AND LN10.LN_SEQ = LN20.LN_SEQ
			INNER JOIN DW01_DW_CLC_CLU DW01
				ON DW01.BF_SSN = LN10.BF_SSN
				AND DW01.LN_SEQ = LN10.LN_SEQ
			INNER JOIN
			(	
				SELECT 
					LN80.BF_SSN,
					LN80.LN_SEQ,
					MaxLN80.MAX_CREATE_DATE AS MAX_CREATE_DATE,
					COALESCE(LN80.LA_BIL_PAS_DU,0.00) AS LA_BIL_PAS_DU,
					CAST(LN80.LD_BIL_DU_LON AS DATE) AS LD_BIL_DU_LON,
					COALESCE(LN80.LA_LTE_FEE_OTS_PRT,0.00) AS LA_LTE_FEE_OTS_PRT
				FROM 
					LN80_LON_BIL_CRF LN80
					INNER JOIN 
					(
						SELECT
							LN80MaxBill.BF_SSN,
							LN80MaxBill.LN_SEQ,
							CAST(MAX(LN80MaxBill.LD_BIL_CRT) AS DATE) AS MAX_CREATE_DATE
						FROM
							LN80_LON_BIL_CRF LN80MaxBill
							INNER JOIN LN20_EDS LN20
								ON LN20.BF_SSN = LN80MaxBill.BF_SSN
								AND LN20.LN_SEQ = LN80MaxBill.LN_SEQ
								AND LN20.LC_EDS_TYP = 'M'
								AND LN20.LC_STA_LON20 = 'A'
							INNER JOIN PD10_PRS_NME PD10
								ON PD10.DF_PRS_ID = LN20.LF_EDS
						WHERE
							PD10.DF_SPE_ACC_ID = @AccountNumber
						GROUP BY
							LN80MaxBill.BF_SSN,
							LN80MaxBill.LN_SEQ
					) MaxLN80
						ON MaxLN80.BF_SSN = LN80.BF_SSN
						AND MaxLN80.LN_SEQ = LN80.LN_SEQ
						AND MaxLN80.MAX_CREATE_DATE = LN80.LD_BIL_CRT
			) MAX_BILL
				ON MAX_BILL.BF_SSN = LN10.BF_SSN
				AND MAX_BILL.LN_SEQ = LN10.LN_SEQ
			INNER JOIN
			(	--Getting Active SCRA Dates
				SELECT
					LN72.BF_SSN, 
					LN72.LN_SEQ,
					LN72.LR_ITR,
					ROW_NUMBER() OVER (PARTITION BY LN72.BF_SSN, LN72.LN_SEQ ORDER BY LD_ITR_EFF_BEG DESC) AS SEQ
				FROM
					LN72_INT_RTE_HST LN72
					INNER JOIN LN20_EDS LN20
						ON LN20.BF_SSN = LN72.BF_SSN
						AND LN20.LN_SEQ = LN72.LN_SEQ
						AND LN20.LC_EDS_TYP = 'M'
						AND LN20.LC_STA_LON20 = 'A'
					INNER JOIN PD10_PRS_NME PD10 
						ON PD10.DF_PRS_ID = LN20.LF_EDS
					WHERE
						LN72.LC_STA_LON72 = 'A'
						AND	CAST(GETDATE() AS DATE) BETWEEN LN72.LD_ITR_EFF_BEG AND LN72.LD_ITR_EFF_END
						AND PD10.DF_SPE_ACC_ID = @AccountNumber
			) LN72 
				ON LN10.BF_SSN = LN72.BF_SSN
				AND LN10.LN_SEQ = LN72.LN_SEQ
				AND LN72.SEQ = 1
			INNER JOIN
			(
				SELECT
					LN85.BF_SSN,
					LN85.LN_SEQ
				FROM
					LN85_LON_ATY LN85
					INNER JOIN --GETS THE MOST RECENT ARC LEFT ON THE BORROWERS ACCOUNT TO GET THE LOAN SEQ'S THE LETTER APPLIES TO
					(
						SELECT
							AY10.BF_SSN,
							MAX(AY10.LN_ATY_SEQ) AS LN_ATY_SEQ,
							MAX(AY10.LD_ATY_REQ_RCV) AS LD_ATY_REQ_RCV
						FROM 
							AY10_BR_LON_ATY AY10
							INNER JOIN LN20_EDS LN20
								ON LN20.BF_SSN = AY10.BF_SSN
								AND LN20.LC_EDS_TYP = 'M'
								AND LN20.LC_STA_LON20 = 'A'
							INNER JOIN PD10_PRS_NME PD10
								ON PD10.DF_PRS_ID = LN20.LF_EDS
						WHERE
							AY10.PF_REQ_ACT = @PF_REQ_ACT
							AND PD10.DF_SPE_ACC_ID = @AccountNumber
						GROUP BY
							AY10.BF_SSN
					)AY10
						ON AY10.BF_SSN = LN85.BF_SSN
						AND AY10.LN_ATY_SEQ = LN85.LN_ATY_SEQ
			)LN85
				ON LN85.BF_SSN = LN10.BF_SSN
				AND LN85.LN_SEQ = LN10.LN_SEQ
			LEFT JOIN
			(
				SELECT
					LN90.BF_SSN,
					LN90.LN_SEQ,
					CAST(LN90.LD_FAT_EFF AS DATE) AS LD_FAT_EFF,
					ABS(SUM(COALESCE(LN90.LA_FAT_NSI,0.00))) AS INTEREST_PAID,
					ABS(SUM(COALESCE(LN90.LA_FAT_LTE_FEE,0.00))) AS FEES_PAID,
					ABS(SUM(COALESCE(LN90.LA_FAT_CUR_PRI,0.00))) AS PRINCIPAL_PAID
				FROM
					LN90_FIN_ATY LN90
					INNER JOIN LN20_EDS LN20
						ON LN20.BF_SSN = LN90.BF_SSN
						AND LN20.LN_SEQ = LN90.LN_SEQ
						AND LN20.LC_EDS_TYP = 'M'
						AND LN20.LC_STA_LON20 = 'A'
					INNER JOIN PD10_PRS_NME PD10 
						ON PD10.DF_PRS_ID = LN20.LF_EDS
				WHERE
					LN90.PC_FAT_TYP = '10'
					AND LN90.PC_FAT_SUB_TYP = '10'
					AND LN90.LC_STA_LON90 = 'A'
					AND COALESCE(LN90.LC_FAT_REV_REA,'') = '' --not reversed
					AND PD10.DF_SPE_ACC_ID = @AccountNumber
				GROUP BY
					LN90.BF_SSN,
					LN90.LN_SEQ,
					LN90.LD_FAT_EFF
			) PAYMENTS_SINCE_LAST_STATEMENT
				ON PAYMENTS_SINCE_LAST_STATEMENT.BF_SSN = LN10.BF_SSN
				AND PAYMENTS_SINCE_LAST_STATEMENT.LN_SEQ = LN10.LN_SEQ
				AND PAYMENTS_SINCE_LAST_STATEMENT.LD_FAT_EFF > MAX_BILL.MAX_CREATE_DATE
			LEFT JOIN
			(
				SELECT  
					LN90.BF_SSN,
					LN90.LN_SEQ,
					ABS(SUM(COALESCE(LN90.LA_FAT_CUR_PRI,0.00) + COALESCE(LN90.LA_FAT_ILG_PRI,0.00))) AS TOTAL_PRINCIPAL_PAID, --PAYMENTS ARE NEGATIVE AMOUNTS SO WE GET THE abs OF THE SUM
					ABS(SUM(COALESCE(LN90.LA_FAT_NSI,0.00))) AS TOTAL_INTEREST_PAID,
					ABS(SUM(COALESCE(LN90.LA_FAT_LTE_FEE,0.00) + COALESCE(LN90.LA_FAT_ILG_PRI,0.00))) AS TOTAL_FEES_PAID,
					CONVERT(VARCHAR,MAX(LN90.LD_FAT_EFF),101) AS DateLastPaymentReceived
				FROM 
					LN90_FIN_ATY LN90
					INNER JOIN LN20_EDS LN20
						ON LN20.BF_SSN = LN90.BF_SSN
						AND LN20.LN_SEQ = LN90.LN_SEQ
						AND LN20.LC_EDS_TYP = 'M'
						AND LN20.LC_STA_LON20 = 'A'
					INNER JOIN PD10_PRS_NME PD10 
						ON PD10.DF_PRS_ID = LN20.LF_EDS
				WHERE 
					LN90.PC_FAT_TYP = '10'
					AND LN90.LC_STA_LON90 = 'A'
					AND COALESCE(LN90.LC_FAT_REV_REA,'') = ''  --not reversed
					AND PD10.DF_SPE_ACC_ID = @AccountNumber
				GROUP BY 
					LN90.BF_SSN,
					LN90.LN_SEQ
			) TOTAL_PAID
				ON TOTAL_PAID.BF_SSN = LN10.BF_SSN
				AND TOTAL_PAID.LN_SEQ = LN10.LN_SEQ
			LEFT JOIN FormatTranslation FMT
				ON FMT.Start = LN10.IC_LON_PGM
				AND FMT.FmtName = '$LNPROG'
		WHERE
			PD10.DF_SPE_ACC_ID = @AccountNumber
		GROUP BY
			COALESCE(FMT.label,LN10.IC_LON_PGM),
			LN10.LD_LON_1_DSB,
			LN10.LA_LON_AMT_GTR,
			DW01.WA_TOT_BRI_OTS,
			LN10.LA_CUR_PRI,
			LN72.LR_ITR,
			MAX_BILL.LA_LTE_FEE_OTS_PRT,
			COALESCE(TOTAL_PAID.TOTAL_PRINCIPAL_PAID, 0.00),
			COALESCE(TOTAL_PAID.TOTAL_INTEREST_PAID,0.00),
			COALESCE(TOTAL_PAID.TOTAL_FEES_PAID,0.00),
			CONVERT(VARCHAR,COALESCE(TOTAL_PAID.DateLastPaymentReceived,'01/01/1900'),101) ,
			(COALESCE(LN10.LA_CUR_PRI,0.00) + COALESCE(MAX_BILL.LA_LTE_FEE_OTS_PRT,0.00) + COALESCE(DW01.WA_TOT_BRI_OTS,0.00)),
			MAX_BILL.LA_BIL_PAS_DU
	END
END