USE CentralData
GO

ALTER PROCEDURE oltotalvp.GetVoluntaryPayments
AS

DROP TABLE IF EXISTS #VP

SELECT DISTINCT
	AF_APL_ID,
	AF_APL_ID_SFX,
	BF_SSN,
	SUM(LA_TRX) AS PAYMENT_AMOUNT
INTO #VP
FROM
	ODW..DC11_LON_FAT
WHERE
	LC_TRX_TYP IN ('BR','OV')
	AND LD_TRX_EFF >= '03/13/2020'
	AND LC_REV_IND_TYP = ''
	AND (LD_TRX_ADJ IS NULL OR LD_TRX_ADJ = '')
GROUP BY
	AF_APL_ID,
	AF_APL_ID_SFX,
	BF_SSN

SELECT
	COUNT(DISTINCT P.BF_SSN) AS BORROWER_COUNT,
	COUNT(*) AS LOAN_COUNT,
	CONCAT('$', CONVERT(VARCHAR(50), CAST(SUM(PAYMENT_AMOUNT) AS MONEY), -1)) AS TOTAL_PAYMENT_AMOUNT,
	CONCAT('$', CONVERT(VARCHAR(50), CAST(SUM(ISNULL(DC02.LA_CLM_BAL,0.00)) AS MONEY), -1)) AS OUTSTANDING_PRINCIPAL_INTEREST
FROM
	#VP P
	LEFT JOIN ODW..DC02_BAL_INT DC02
		ON DC02.AF_APL_ID = P.AF_APL_ID
		AND DC02.AF_APL_ID_SFX = P.AF_APL_ID_SFX

DROP TABLE IF EXISTS #VP
GO

ALTER PROCEDURE [oltotalvp].[GetVoluntaryPaymentsDetail]
AS

SELECT DISTINCT
	DC11.AF_APL_ID,
	DC11.AF_APL_ID_SFX,
	PD01.DF_SPE_ACC_ID,
	DC11.LC_TRX_TYP,
	DC11.LD_TRX_EFF,
	SUM(DC11.LA_TRX) OVER(PARTITION BY DC11.AF_APL_ID, DC11.AF_APL_ID_SFX, PD01.DF_SPE_ACC_ID, DC11.LC_TRX_TYP, DC11.LD_TRX_EFF) AS PAYMENT_AMOUNT
FROM
	ODW..DC11_LON_FAT DC11
	INNER JOIN ODW..PD01_PDM_INF PD01
		ON PD01.DF_PRS_ID = DC11.BF_SSN
WHERE
	DC11.LC_TRX_TYP IN ('BR','OV')
	AND DC11.LD_TRX_EFF >= '03/13/2020'
	AND DC11.LC_REV_IND_TYP = ''
	AND (DC11.LD_TRX_ADJ IS NULL OR DC11.LD_TRX_ADJ = '')