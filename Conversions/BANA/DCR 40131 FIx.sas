%LET BANA = %STR(REQUIRED="FILEDSN=X:\PADR\ODBC\EA27_BANA.dsn; update_lock_typ=nolock; bl_keepnulls=no");
LIBNAME BANA ODBC &BANA ;


PROC SQL;
	CREATE TABLE E_40131 AS 
		SELECT DISTINCT
			MAP.*,
			POP.NEW_LD_SNT_RPD_DIS
		FROM
			BANA.Borrower_Errors E
			INNER JOIN BANA.COMPASSLOANMAPPING MAP
				ON MAP.BORROWERSSN = E.BR_SSN
				AND MAP.LN_SEQ = INPUT(E.LN_SEQ,BEST12.)
			INNER JOIN
			( 
				SELECT DISTINCT
					S.BORROWERSSN,
					MAX(INTNX('month' ,DATEPART(COALESCE(S.PFHBeginDate, P.NextPaymentDueDate)), -1, 'same')) AS NEW_LD_SNT_RPD_DIS
				FROM
					BANA._05SupplementalBorrowerRecord S
				INNER JOIN BANA._03PaymentDataRecord P
					ON P.BORROWERSSN = S.BORROWERSSN
					AND P.LOAN_NUMBER = S.LOAN_NUMBER
				GROUP BY
					S.BORROWERSSN
			)POP
				ON POP.BORROWERSSN = MAP.BORROWERSSN
		WHERE
			E.ERROR_CODE = '40131'
		
;
QUIT;

DATA DUSTER.E_40131;
SET E_40131;
RUN;

/*TEST*/
/*LIBNAME  DUSTER  REMOTE  SERVER=QADBD004 SLIBREF=WORK  ;*/

/*LIVE*/
LIBNAME  DUSTER  REMOTE  SERVER=DUSTER  SLIBREF=WORK;

RSUBMIT;  

/*%let DB = DLGSWQUT;  *This is test;*/
%let DB = DLGSUTWH;  *This is live;

LIBNAME OLWHRM1 DB2 DATABASE=&DB OWNER=OLWHRM1;
PROC SQL;
	CREATE TABLE E_40131_FINAL AS
		SELECT DISTINCT
			RS10.BF_SSN,
			RS10.LN_RPS_SEQ,
			'NULL' AS OLD_LD_SNT_RPD_DIS,
			P.NEW_LD_SNT_RPD_DIS
			FROM
				E_40131 P
			INNER JOIN
			(
				SELECT
					BF_SSN,
					MAX(LN_RPS_SEQ) AS LN_RPS_SEQ
				FROM
					OLWHRM1.RS10_BR_RPD
				WHERE
					LC_STA_RPST10 = 'A'
					AND LD_SNT_RPD_DIS IS NULL	
				GROUP BY 
					BF_SSN
			)RS10
				ON P.BORROWERSSN = RS10.BF_SSN
			order by 
				NEW_LD_SNT_RPD_DIS
;

	CREATE TABLE LOAN_LEVEL AS 
		SELECT DISTINCT 
			LN65.*
		FROM
			E_40131_FINAL F
			INNER JOIN OLWHRM1.LN65_LON_RPS LN65
				ON F.BF_SSN = LN65.BF_SSN
				AND F.LN_RPS_SEQ = LN65.LN_RPS_SEQ
;		
QUIT;
ENDRSUBMIT;	

DATA E_40131_FINAL;
SET DUSTER.E_40131_FINAL;
FORMAT NEW_LD_SNT_RPD_DIS mmddyy10.;
RUN;

PROC SQL;
	CREATE TABLE E_40131_FINAL_1 AS 
		SELECT
			BF_SSN,
			LN_RPS_SEQ,
			OLD_LD_SNT_RPD_DIS,
			MAX(NEW_LD_SNT_RPD_DIS) AS NEW_LD_SNT_RPD_DIS
		FROM
			E_40131_FINAL
		GROUP BY
			BF_SSN,
			LN_RPS_SEQ,
			OLD_LD_SNT_RPD_DIS
;
QUIT;

PROC EXPORT DATA = WORK.E_40131_FINAL 
            OUTFILE = "T:\DCR 40131.xlsx" 
            DBMS = EXCEL
			REPLACE;
     SHEET="RS10"; 
RUN;

