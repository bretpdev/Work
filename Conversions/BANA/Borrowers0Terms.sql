USE EA27_BANA
GO

IF OBJECT_ID('tempdb..#RepaymentSummary') is not null
	BEGIN
		DROP TABLE tempdb..#RepaymentSummary
	END

SELECT DISTINCT
	RS10.BF_SSN,
	LN65.LN_SEQ,
	RS10.LD_RPS_1_PAY_DU,
	RS10.LN_RPS_SEQ,
	LN66.[sum_LN_RPS_TRM]
INTO 
	#RepaymentSummary
FROM
	RS10
	INNER JOIN
	(
		SELECT
			LN65.BF_SSN,
			LN65.LN_SEQ,
			MAX(LN65.LN_RPS_SEQ) [max_LN_RPS_TRM]
		FROM
			LN65
		GROUP BY
			LN65.BF_SSN,
			LN65.LN_SEQ

	) LN65 ON LN65.BF_SSN = RS10.BF_SSN AND LN65.[max_LN_RPS_TRM] = RS10.LN_RPS_SEQ
	INNER JOIN 
	(
		SELECT
			LN66.BF_SSN,
			LN66.LN_SEQ,
			LN66.LN_RPS_SEQ,
			SUM(LN66.LN_RPS_TRM) [sum_LN_RPS_TRM]
		FROM
			LN66
		GROUP BY
			LN66.BF_SSN,
			LN66.LN_SEQ,
			LN66.LN_RPS_SEQ
	) LN66 ON LN66.BF_SSN = LN65.BF_SSN AND LN66.LN_RPS_SEQ = LN65.[max_LN_RPS_TRM] AND LN66.LN_SEQ = LN65.LN_SEQ


SELECT DISTINCT
	*
FROM
	(
		SELECT
			RS.BF_SSN,
			RS.LN_SEQ,
			CAST(DATEADD(MONTH,RS.sum_LN_RPS_TRM, RS.LD_RPS_1_PAY_DU) as DATE) [AnticipatedPayoffDate]
		FROM
			#RepaymentSummary RS
	) X
WHERE
	X.AnticipatedPayoffDate < GETDATE()
