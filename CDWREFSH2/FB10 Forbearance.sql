USE CDW
GO

MERGE 
	CDW.dbo.FB10_Forbearance FB10
USING
	(
		SELECT
			PD10.DF_SPE_ACC_ID,
			LN60.LN_SEQ,
			LN60.LF_FOR_CTL_NUM,
			LN60.LN_FOR_OCC_SEQ,
			ISNULL(FB10.LC_FOR_TYP,'') AS LC_FOR_TYP,
			LEFT(ISNULL(FMT.[Label], ISNULL(FB10.LC_FOR_TYP,'')),36) AS FOR_TYP,
			ISNULL(CONVERT(VARCHAR(10),FB10.LD_FOR_INF_CER,101),'') AS LD_FOR_INF_CER,
			ISNULL(CONVERT(VARCHAR(10),LN60.LD_FOR_BEG,101),'') AS LD_FOR_BEG,
			ISNULL(CONVERT(VARCHAR(10),LN60.LD_FOR_END,101),'') AS LD_FOR_END,
			ISNULL(LN60.LC_LON_LEV_FOR_CAP,'') AS LI_CAP_FOR_INT_REQ, 
			ISNULL(CONVERT(VARCHAR(10),LN60.LC_STA_LON60,101),'') AS LC_STA_LON60,
			ISNULL(FB10.LC_FOR_STA,'') AS LC_FOR_STA,
			ISNULL(FB10.LC_STA_FOR10,'') AS LC_STA_FOR10,
			ISNULL((DATEDIFF(DAY, LN60.LD_FOR_BEG, LN60.LD_FOR_END) + 1) / 365 * 12, 0) AS MONTHS_USED,
			ISNULL(FB10.LA_REQ_RDC_PAY,0.00) AS LA_REQ_RDC_PAY,
			LN60.LI_FOR_VRB_DFL_RUL
		FROM
			CDW..PD10_PRS_NME PD10
			INNER JOIN CDW..LN60_BR_FOR_APV LN60
				ON LN60.BF_SSN = PD10.DF_PRS_ID
			INNER JOIN CDW..FB10_BR_FOR_REQ FB10
				ON FB10.BF_SSN = LN60.BF_SSN
				AND FB10.LF_FOR_CTL_NUM = LN60.LF_FOR_CTL_NUM
			INNER JOIN 
			(
				SELECT
					LN60.BF_SSN,
					LN60.LN_SEQ,
					LN60.LF_FOR_CTL_NUM,
					MAX(LN60.LN_FOR_OCC_SEQ) AS LN_FOR_OCC_SEQ
				FROM
					CDW..LN60_BR_FOR_APV LN60
					INNER JOIN CDW..FB10_BR_FOR_REQ FB10
						ON FB10.BF_SSN = LN60.BF_SSN
						AND FB10.LF_FOR_CTL_NUM = LN60.LF_FOR_CTL_NUM
				WHERE
					LN60.LC_STA_LON60 = 'A'
					AND FB10.LC_FOR_STA = 'A'
					AND FB10.LC_STA_FOR10 = 'A'
				GROUP BY
					LN60.BF_SSN,
					LN60.LN_SEQ,
					LN60.LF_FOR_CTL_NUM
			) LN60Max
				ON LN60Max.BF_SSN = LN60.BF_SSN
				AND LN60Max.LN_SEQ = LN60.LN_SEQ
				AND LN60Max.LF_FOR_CTL_NUM = LN60.LF_FOR_CTL_NUM
				AND LN60Max.LN_FOR_OCC_SEQ = LN60.LN_FOR_OCC_SEQ
			LEFT JOIN CDW..FormatTranslation FMT
				ON FMT.[Start] = FB10.LC_FOR_TYP
				AND FMT.FmtName = '$FORSTA'
		WHERE
			LN60.LC_STA_LON60 = 'A'
			AND FB10.LC_FOR_STA = 'A'
			AND FB10.LC_STA_FOR10 = 'A'
			AND CentralData.dbo.TRIM(PD10.DF_SPE_ACC_ID) != ''
	) NewData 
		ON NewData.DF_SPE_ACC_ID = FB10.DF_SPE_ACC_ID
		AND NewData.LN_SEQ = FB10.LN_SEQ
		AND NewData.LF_FOR_CTL_NUM = FB10.LF_FOR_CTL_NUM
		AND NewData.LN_FOR_OCC_SEQ = FB10.LN_FOR_OCC_SEQ
WHEN MATCHED THEN 
	UPDATE SET 
		FB10.LC_FOR_TYP = NewData.LC_FOR_TYP,
		FB10.LD_FOR_INF_CER = NewData.LD_FOR_INF_CER,
		FB10.LD_FOR_BEG = NewData.LD_FOR_BEG,
		FB10.LD_FOR_END = NewData.LD_FOR_END,
		FB10.LI_CAP_FOR_INT_REQ = NewData.LI_CAP_FOR_INT_REQ,
		FB10.LC_STA_LON60 = NewData.LC_STA_LON60,
		FB10.LC_FOR_STA = NewData.LC_FOR_STA,
		FB10.LC_STA_FOR10 = NewData.LC_STA_FOR10,
		FB10.MONTHS_USED = NewData.MONTHS_USED,
		FB10.LA_REQ_RDC_PAY = NewData.LA_REQ_RDC_PAY,
		FB10.LI_FOR_VRB_DFL_RUL = NewData.LI_FOR_VRB_DFL_RUL
WHEN NOT MATCHED THEN
	INSERT 
	(
		DF_SPE_ACC_ID,
		LN_SEQ,
		LF_FOR_CTL_NUM,
		LN_FOR_OCC_SEQ,
		LC_FOR_TYP,
		LD_FOR_INF_CER,
		LD_FOR_BEG,
		LD_FOR_END,
		LI_CAP_FOR_INT_REQ,
		LC_STA_LON60,
		LC_FOR_STA,
		LC_STA_FOR10,
		MONTHS_USED,
		LA_REQ_RDC_PAY,
		LI_FOR_VRB_DFL_RUL
	)
	VALUES 
	(
		NewData.DF_SPE_ACC_ID,
		NewData.LN_SEQ,
		NewData.LF_FOR_CTL_NUM,
		NewData.LN_FOR_OCC_SEQ,
		NewData.LC_FOR_TYP,
		NewData.LD_FOR_INF_CER,
		NewData.LD_FOR_BEG,
		NewData.LD_FOR_END,
		NewData.LI_CAP_FOR_INT_REQ,
		NewData.LC_STA_LON60,
		NewData.LC_FOR_STA,
		NewData.LC_STA_FOR10,
		NewData.MONTHS_USED,
		NewData.LA_REQ_RDC_PAY,
		NewData.LI_FOR_VRB_DFL_RUL
	)
WHEN NOT MATCHED BY SOURCE THEN
	DELETE
;
