-- the nature of how AES refreshes LT20 prevents the typical valiation and recovery.

USE CDW
GO

DECLARE @LastRefresh VARCHAR(30) = (SELECT CONVERT(VARCHAR(30), ISNULL(DATEADD(HOUR,-3,MAX(LT20.RT_RUN_SRT_DTS_PRC)), '1-1-1900 00:00:00'), 21) FROM LT20_LTR_REQ_PRC LT20)
PRINT 'Last Refreshed at: ' + @LastRefresh

DECLARE @SQLStatement VARCHAR(MAX) = 
'
	MERGE 
		dbo.LT20_LTR_REQ_PRC LT20
	USING
		(
			SELECT
				OQ.*,
				CASE 
					WHEN PH05.DF_SPE_ID IS NOT NULL AND PH05.DI_VLD_CNC_EML_ADR = ''Y'' AND PH05.DI_CNC_ELT_OPI = ''Y'' THEN 1
					ELSE 0
				END AS OnEcorr
			FROM
				OPENQUERY
				(
					LEGEND,
					''
						SELECT
							PD10.DF_SPE_ACC_ID,
							LT20.*
						FROM
							PKUB.PD10_PRS_NME PD10
							INNER JOIN PKUB.LT20_LTR_REQ_PRC LT20 
								ON LT20.RF_SBJ_PRC = PD10.DF_PRS_ID 
						-- comment WHERE clause for full table refresh
						WHERE
							LT20.RT_RUN_SRT_DTS_PRC > ''''' + @LastRefresh + '''''
					''
				) OQ
					LEFT JOIN CDW.dbo.PH05_CNC_EML PH05
						ON PH05.DF_SPE_ID = OQ.DF_SPE_ACC_ID  
		) D 
			ON D.DF_SPE_ACC_ID = LT20.DF_SPE_ACC_ID 
			AND D.RM_APL_PGM_PRC = LT20.RM_APL_PGM_PRC 
			AND CAST(D.RT_RUN_SRT_DTS_PRC AS DATETIME) = LT20.RT_RUN_SRT_DTS_PRC 
			AND D.RN_SEQ_LTR_CRT_PRC = LT20.RN_SEQ_LTR_CRT_PRC 
			AND D.RN_SEQ_REC_PRC = LT20.RN_SEQ_REC_PRC
	WHEN MATCHED THEN 
		UPDATE SET 
			LT20.RM_DSC_LTR_PRC = D.RM_DSC_LTR_PRC,
			LT20.RC_TYP_SBJ_PRC = D.RC_TYP_SBJ_PRC,
			LT20.RF_SBJ_PRC = D.RF_SBJ_PRC,
			LT20.RN_ENT_REQ_PRC = D.RN_ENT_REQ_PRC,
			LT20.RN_ATY_SEQ_PRC = D.RN_ATY_SEQ_PRC,
			LT20.RI_REC_PRC = D.RI_REC_PRC,
			LT20.RX_REQ_ARA_1_PRC = D.RX_REQ_ARA_1_PRC,
			LT20.RX_REQ_ARA_2_PRC = D.RX_REQ_ARA_2_PRC,
			LT20.RX_REQ_ARA_3_PRC = D.RX_REQ_ARA_3_PRC,
			LT20.RX_REQ_ARA_4_PRC = D.RX_REQ_ARA_4_PRC,
			LT20.RX_REQ_ARA_5_PRC = D.RX_REQ_ARA_5_PRC,
			LT20.RX_REQ_ARA_6_PRC = D.RX_REQ_ARA_6_PRC,
			LT20.RI_LTR_REQ_DEL_PRC = D.RI_LTR_REQ_DEL_PRC,
			LT20.RC_LTR_REQ_SRC_PRC = D.RC_LTR_REQ_SRC_PRC,
			LT20.RI_PRV_RUN_ERR_PRC = D.RI_PRV_RUN_ERR_PRC,
			LT20.RF_LST_DTS_LT20 = D.RF_LST_DTS_LT20,
			LT20.RF_COR_DOC_PRC = D.RF_COR_DOC_PRC,
			LT20.RX_REQ_ARA_16_PRC = D.RX_REQ_ARA_16_PRC,
			LT20.RX_REQ_ARA_15_PRC = D.RX_REQ_ARA_15_PRC,
			LT20.RX_REQ_ARA_14_PRC = D.RX_REQ_ARA_14_PRC,
			LT20.RX_REQ_ARA_13_PRC = D.RX_REQ_ARA_13_PRC,
			LT20.RX_REQ_ARA_12_PRC = D.RX_REQ_ARA_12_PRC,
			LT20.RX_REQ_ARA_11_PRC = D.RX_REQ_ARA_11_PRC,
			LT20.RX_REQ_ARA_10_PRC = D.RX_REQ_ARA_10_PRC,
			LT20.RX_REQ_ARA_9_PRC = D.RX_REQ_ARA_9_PRC,
			LT20.RX_REQ_ARA_8_PRC = D.RX_REQ_ARA_8_PRC,
			LT20.RX_REQ_ARA_7_PRC = D.RX_REQ_ARA_7_PRC,
			LT20.RI_LTR_OPT_ENC_PRC = D.RI_LTR_OPT_ENC_PRC,
			LT20.RN_ARR_PAR_PRC = D.RN_ARR_PAR_PRC
	WHEN NOT MATCHED THEN
		INSERT 
		(
			DF_SPE_ACC_ID,
			RM_APL_PGM_PRC,
			RT_RUN_SRT_DTS_PRC,
			RN_SEQ_LTR_CRT_PRC,
			RN_SEQ_REC_PRC,
			RM_DSC_LTR_PRC,
			RC_TYP_SBJ_PRC,
			RF_SBJ_PRC,
			RN_ENT_REQ_PRC,
			RN_ATY_SEQ_PRC,
			RI_REC_PRC,
			RX_REQ_ARA_1_PRC,
			RX_REQ_ARA_2_PRC,
			RX_REQ_ARA_3_PRC,
			RX_REQ_ARA_4_PRC,
			RX_REQ_ARA_5_PRC,
			RX_REQ_ARA_6_PRC,
			RI_LTR_REQ_DEL_PRC,
			RC_LTR_REQ_SRC_PRC,
			RI_PRV_RUN_ERR_PRC,
			RF_LST_DTS_LT20,
			RF_COR_DOC_PRC,
			RX_REQ_ARA_16_PRC,
			RX_REQ_ARA_15_PRC,
			RX_REQ_ARA_14_PRC,
			RX_REQ_ARA_13_PRC,
			RX_REQ_ARA_12_PRC,
			RX_REQ_ARA_11_PRC,
			RX_REQ_ARA_10_PRC,
			RX_REQ_ARA_9_PRC,
			RX_REQ_ARA_8_PRC,
			RX_REQ_ARA_7_PRC,
			RI_LTR_OPT_ENC_PRC,
			RN_ARR_PAR_PRC,
			OnEcorr
		)
		VALUES 
		(
			D.DF_SPE_ACC_ID,
			D.RM_APL_PGM_PRC,
			D.RT_RUN_SRT_DTS_PRC,
			D.RN_SEQ_LTR_CRT_PRC,
			D.RN_SEQ_REC_PRC,
			D.RM_DSC_LTR_PRC,
			D.RC_TYP_SBJ_PRC,
			D.RF_SBJ_PRC,
			D.RN_ENT_REQ_PRC,
			D.RN_ATY_SEQ_PRC,
			D.RI_REC_PRC,
			D.RX_REQ_ARA_1_PRC,
			D.RX_REQ_ARA_2_PRC,
			D.RX_REQ_ARA_3_PRC,
			D.RX_REQ_ARA_4_PRC,
			D.RX_REQ_ARA_5_PRC,
			D.RX_REQ_ARA_6_PRC,
			D.RI_LTR_REQ_DEL_PRC,
			D.RC_LTR_REQ_SRC_PRC,
			D.RI_PRV_RUN_ERR_PRC,
			D.RF_LST_DTS_LT20,
			D.RF_COR_DOC_PRC,
			D.RX_REQ_ARA_16_PRC,
			D.RX_REQ_ARA_15_PRC,
			D.RX_REQ_ARA_14_PRC,
			D.RX_REQ_ARA_13_PRC,
			D.RX_REQ_ARA_12_PRC,
			D.RX_REQ_ARA_11_PRC,
			D.RX_REQ_ARA_10_PRC,
			D.RX_REQ_ARA_9_PRC,
			D.RX_REQ_ARA_8_PRC,
			D.RX_REQ_ARA_7_PRC,
			D.RI_LTR_OPT_ENC_PRC,
			D.RN_ARR_PAR_PRC,
			D.OnEcorr
		)
	-- !!! uncomment lines below ONLY when doing a full table refresh 
	--WHEN NOT MATCHED BY SOURCE THEN
	--    DELETE
	;
'

PRINT @SQLStatement
EXEC (@SQLStatement)

