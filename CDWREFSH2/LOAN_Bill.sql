USE CDW
GO

MERGE
	dbo.LOAN_Bill ExistingData
USING
	(
		SELECT DISTINCT 
			PD10.DF_SPE_ACC_ID, 
			MAX_BILL.LN_SEQ, 
			COALESCE(FTBL.Label, '') AS BIL_MTD,
			IIF(BL10.LC_IND_BIL_SNT IN ('N','5') AND CAST(LN80.LD_BIL_DU_LON AS DATE) > CAST(GETDATE() AS DATE), 'Y','N') AS PAID_AHEAD
		FROM
			BL10_BR_BIL BL10
			INNER JOIN LN80_LON_BIL_CRF LN80	
				ON LN80.BF_SSN = BL10.BF_SSN
				AND LN80.LD_BIL_CRT = BL10.LD_BIL_CRT
				AND LN80.LN_SEQ_BIL_WI_DTE = BL10.LN_SEQ_BIL_WI_DTE
			INNER JOIN PD10_PRS_NME PD10
				ON PD10.DF_PRS_ID = BL10.BF_SSN
			INNER JOIN
			(--GETS THE BORROWERS MOST RECENT BILL
				SELECT
					LN80.BF_SSN, 
					LN80.LN_SEQ, 
					MAX(LN80.LD_BIL_DU_LON) AS LD_BIL_DU_LON
				FROM
					BL10_BR_BIL BL10
					INNER JOIN LN80_LON_BIL_CRF LN80	
						ON LN80.BF_SSN = BL10.BF_SSN
						AND LN80.LD_BIL_CRT = BL10.LD_BIL_CRT
						AND LN80.LN_SEQ_BIL_WI_DTE = BL10.LN_SEQ_BIL_WI_DTE
				WHERE
					BL10.LC_STA_BIL10 = 'A'
					AND LN80.LC_STA_LON80 = 'A'
				GROUP BY 
					LN80.BF_SSN,
					LN80.LN_SEQ
			) AS MAX_BILL
				ON MAX_BILL.BF_SSN = LN80.BF_SSN 
				AND MAX_BILL.LN_SEQ = LN80.LN_SEQ
				AND MAX_BILL.LD_BIL_DU_LON = LN80.LD_BIL_DU_LON
			LEFT JOIN FormatTranslation FTBL
				ON FTBL.FmtName = '$BILMTD'
				AND FTBL.[Start] = BL10.LC_BIL_MTD
			WHERE
				BL10.LC_STA_BIL10 = 'A'
				AND LN80.LC_STA_LON80 = 'A'
	) NewData
		ON NewData.DF_SPE_ACC_ID = ExistingData.DF_SPE_ACC_ID
		AND NewData.LN_SEQ = ExistingData.LN_SEQ
WHEN MATCHED THEN UPDATE SET
	ExistingData.BIL_MTD = NewData.BIL_MTD,
	ExistingData.PAID_AHEAD = NewData.PAID_AHEAD
WHEN NOT MATCHED THEN
	INSERT
	(
		DF_SPE_ACC_ID,
		LN_SEQ,
		BIL_MTD,
		PAID_AHEAD
	)
	VALUES
	(
		NewData.DF_SPE_ACC_ID,
		NewData.LN_SEQ,
		NewData.BIL_MTD,
		NewData.PAID_AHEAD
	)
WHEN NOT MATCHED BY SOURCE THEN
	DELETE;