--Requires custom (non-SP) refresh due to [IdrIneligible] & [IcrIneligible] fields
--EXEC CDW..RefreshTableWithValidation 'GRSP_NDS_LON_RSP','LF_CRT_DTS_GRSP','GRSP_NDS_LON_RSP','DF_PRS_ID'

USE CDW
GO

DECLARE @LastRefresh VARCHAR(30) = (SELECT CONVERT(VARCHAR(30), ISNULL(DATEADD(HOUR,-3,MAX(GPRS.LF_CRT_DTS_GRSP)), '1-1-1900 00:00:00'), 21) FROM GRSP_NDS_LON_RSP GPRS)
PRINT 'Last Refreshed at: ' + @LastRefresh

DECLARE @SQLStatement VARCHAR(MAX) = 
'
	MERGE 
		dbo.GRSP_NDS_LON_RSP GPRS
	USING
		(
			SELECT
				*
			FROM
				OPENQUERY
				(
					LEGEND,
					''
						SELECT
							GPRS.*
						FROM
							PKUB.GRSP_NDS_LON_RSP GPRS
						-- comment WHERE clause for full table refresh
						WHERE
							GPRS.LF_CRT_DTS_GRSP > ''''' + @LastRefresh + '''''
						FOR READ ONLY WITH UR
					''
				) 
		) L 
			ON L.DF_PRS_ID = GPRS.DF_PRS_ID 
			AND L.LF_NDS_LON_RSP_LAB = GPRS.LF_NDS_LON_RSP_LAB 
			AND L.LD_NDS_LIS_REQ = GPRS.LD_NDS_LIS_REQ
	WHEN MATCHED THEN 
		UPDATE SET 
			GPRS.LF_CRT_DTS_GRSP = L.LF_CRT_DTS_GRSP,
			GPRS.LF_CRT_USR_GRSP = L.LF_CRT_USR_GRSP,
			GPRS.LF_CRT_SRC_GRSP = L.LF_CRT_SRC_GRSP,
			GPRS.LF_FED_AWD = L.LF_FED_AWD,
			GPRS.LN_FED_AWD_SEQ = L.LN_FED_AWD_SEQ,
			GPRS.IC_LON_PGM = L.IC_LON_PGM,
			GPRS.LF_FED_CLC_RSK = L.LF_FED_CLC_RSK,
			GPRS.WC_ACA_GDE_LEV = L.WC_ACA_GDE_LEV,
			GPRS.WF_ORG_LDR = L.WF_ORG_LDR,
			GPRS.LF_ORG_SER = L.LF_ORG_SER,
			GPRS.LF_CUR_LDR = L.LF_CUR_LDR,
			GPRS.LF_CUR_SER = L.LF_CUR_SER,
			GPRS.LF_CUR_GTR = L.LF_CUR_GTR,
			GPRS.LD_NDS_LIS_PIF = L.LD_NDS_LIS_PIF,
			GPRS.LF_NDS_LIS_PIF_SRC = L.LF_NDS_LIS_PIF_SRC,
			GPRS.LC_NDS_LIS_LON_STA = L.LC_NDS_LIS_LON_STA,
			GPRS.LD_NDS_LIS_LON_STA = L.LD_NDS_LIS_LON_STA,
			GPRS.LA_ORG_LON_BAL = L.LA_ORG_LON_BAL,
			GPRS.LA_TOT_DSB = L.LA_TOT_DSB,
			GPRS.LA_CUR_PRI = L.LA_CUR_PRI,
			GPRS.WA_TOT_BRI_OTS = L.WA_TOT_BRI_OTS,
			GPRS.LD_RPD_SR = L.LD_RPD_SR,
			GPRS.LA_LON_BAL_RPY = L.LA_LON_BAL_RPY,
			GPRS.LR_ITR = L.LR_ITR,
			GPRS.LR_STT_ITR = L.LR_STT_ITR,
			GPRS.LI_UDL_PLS_LON = L.LI_UDL_PLS_LON,
			GPRS.BI_SUB_USE_LMT_APL = L.BI_SUB_USE_LMT_APL,
			GPRS.BD_SUB_USE_LMT_APL = L.BD_SUB_USE_LMT_APL,
			GPRS.LI_LON_JNT_CON = L.LI_LON_JNT_CON,
			GPRS.LF_LON_CON_APL_AWD = L.LF_LON_CON_APL_AWD,
			GPRS.LC_LON_INT_RTE_TYP = L.LC_LON_INT_RTE_TYP,
			GPRS.LF_DOE_SCL_ORG = L.LF_DOE_SCL_ORG
	WHEN NOT MATCHED THEN
		INSERT 
		(
			DF_PRS_ID,
			LF_NDS_LON_RSP_LAB,
			LD_NDS_LIS_REQ,
			LF_CRT_DTS_GRSP,
			LF_CRT_USR_GRSP,
			LF_CRT_SRC_GRSP,
			LF_FED_AWD,
			LN_FED_AWD_SEQ,
			IC_LON_PGM,
			LF_FED_CLC_RSK,
			WC_ACA_GDE_LEV,
			WF_ORG_LDR,
			LF_ORG_SER,
			LF_CUR_LDR,
			LF_CUR_SER,
			LF_CUR_GTR,
			LD_NDS_LIS_PIF,
			LF_NDS_LIS_PIF_SRC,
			LC_NDS_LIS_LON_STA,
			LD_NDS_LIS_LON_STA,
			LA_ORG_LON_BAL,
			LA_TOT_DSB,
			LA_CUR_PRI,
			WA_TOT_BRI_OTS,
			LD_RPD_SR,
			LA_LON_BAL_RPY,
			LR_ITR,
			LR_STT_ITR,
			LI_UDL_PLS_LON,
			BI_SUB_USE_LMT_APL,
			BD_SUB_USE_LMT_APL,
			LI_LON_JNT_CON,
			LF_LON_CON_APL_AWD,
			LC_LON_INT_RTE_TYP,
			LF_DOE_SCL_ORG
		)
		VALUES 
		(
			L.DF_PRS_ID,
			L.LF_NDS_LON_RSP_LAB,
			L.LD_NDS_LIS_REQ,
			L.LF_CRT_DTS_GRSP,
			L.LF_CRT_USR_GRSP,
			L.LF_CRT_SRC_GRSP,
			L.LF_FED_AWD,
			L.LN_FED_AWD_SEQ,
			L.IC_LON_PGM,
			L.LF_FED_CLC_RSK,
			L.WC_ACA_GDE_LEV,
			L.WF_ORG_LDR,
			L.LF_ORG_SER,
			L.LF_CUR_LDR,
			L.LF_CUR_SER,
			L.LF_CUR_GTR,
			L.LD_NDS_LIS_PIF,
			L.LF_NDS_LIS_PIF_SRC,
			L.LC_NDS_LIS_LON_STA,
			L.LD_NDS_LIS_LON_STA,
			L.LA_ORG_LON_BAL,
			L.LA_TOT_DSB,
			L.LA_CUR_PRI,
			L.WA_TOT_BRI_OTS,
			L.LD_RPD_SR,
			L.LA_LON_BAL_RPY,
			L.LR_ITR,
			L.LR_STT_ITR,
			L.LI_UDL_PLS_LON,
			L.BI_SUB_USE_LMT_APL,
			L.BD_SUB_USE_LMT_APL,
			L.LI_LON_JNT_CON,
			L.LF_LON_CON_APL_AWD,
			L.LC_LON_INT_RTE_TYP,
			L.LF_DOE_SCL_ORG
		)
	-- !!! uncomment lines below ONLY when doing a full table refresh 
	--WHEN NOT MATCHED BY SOURCE THEN
	--    DELETE
	;
'

PRINT @SQLStatement
EXEC (@SQLStatement)


-- ###### VALIDATION
DECLARE 
	@CountDifference INT

SELECT
	@CountDifference = L.LocalCount - R.RemoteCount
FROM
	OPENQUERY
	(
		LEGEND,
		'
			SELECT
				COUNT(*) AS "RemoteCount"
			FROM
				PKUB.GRSP_NDS_LON_RSP GPRS
		'	
	) R
	FULL OUTER JOIN
	(
		SELECT
			COUNT(*) [LocalCount]
		FROM
			GRSP_NDS_LON_RSP GPRS
	) L 
		ON 1 = 1
	
IF @CountDifference != 0
BEGIN
	RAISERROR('GRSP_NDS_LON_RSP - The remote and local record counts do not match.  The local count is off by %i records.  A full refresh of the table is required.', 16, 11, @CountDifference)
END


PRINT 'UPDATING ELIGIBILITY FIELDS'
--THIS TABLE IS A HISTORY TABLE so we need to pull the eligibilty from the previous loans to update to the updated loans.


--SELECT
--	*
--FROM
--	CDW..GRSP_NDS_LON_RSP
UPDATE --UPDATES ALL LOAN PROGRAMS THAT ARE NOT ELIGIBLE FOR IDR (IBR, REPAYE, PAYE)
	CDW..GRSP_NDS_LON_RSP
SET
	IdrIneligible = 1
WHERE
	IC_LON_PGM IN ('D4','D7','PU','FI','NU','PL','DU','EU','IC') 
	AND IdrIneligible IS NULL

--SELECT
--	*
--FROM
--	CDW..GRSP_NDS_LON_RSP
UPDATE --UPDATES ALL LOAN PROGRAMS THAT ARE ELIGIBLE FOR IDR (IBR, REPAYE, PAYE)
	CDW..GRSP_NDS_LON_RSP
SET
	IdrIneligible = 0
WHERE
	IC_LON_PGM IN ('D1', 'SF','SL','D2','D0','D8', 'SU','GB', 'D3' ) 
	AND IdrIneligible IS NULL

UPDATE --BORROWERS HAVE CONSOL LOANS WITH A POISSBLE UNER LYING PLUS LOAN
	GRSP
SET
	GRSP.IdrIneligible = 
						CASE
							WHEN POP.IC_LON_PGM IS NULL THEN 1
							ELSE NULL
						END
FROM
	CDW..GRSP_NDS_LON_RSP GRSP
	LEFT JOIN
	(
		SELECT DISTINCT
			DF_PRS_ID,
			IC_LON_PGM
		FROM
			GRSP_NDS_LON_RSP 
		WHERE
			IC_LON_PGM IN ('D3','D4','D7','PU','FI','NU','PL','DU','EU','IC') 
			AND LA_CUR_PRI = 0
	) POP
		ON POP.DF_PRS_ID = GRSP.DF_PRS_ID
		AND POP.IC_LON_PGM = GRSP.IC_LON_PGM
WHERE
	GRSP.IdrIneligible IS NULL
	AND GRSP.IC_LON_PGM IN ('D5', 'D6', 'D9', 'CL')
