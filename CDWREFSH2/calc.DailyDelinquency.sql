USE CDW
GO

DELETE
	calc.DailyDelinquency
WHERE
	DATEDIFF(Month, AddedAt, GETDATE()) > 16

MERGE
	calc.DailyDelinquency DD
USING
	(
		SELECT
			LN16.BF_SSN,
			LN16.LN_SEQ,
			CAST(LN16.LD_DLQ_OCC AS DATE) AS LD_DLQ_OCC,
			CASE 
				WHEN DATEPART(DW, GETDATE()) = 1 THEN LN16.LN_DLQ_MAX + 2 --ACCOUNT FOR WAREHOUSE NOT UPDATING ON SUNDAY
				ELSE LN16.LN_DLQ_MAX + 1
			END [LN_DLQ_MAX],
			CAST(GETDATE() AS DATE) AS AddedAt
		FROM	
			CDW..LN16_LON_DLQ_HST LN16
			INNER JOIN CDW..LN10_LON LN10
				ON LN10.BF_SSN = LN16.BF_SSN
				AND LN10.LN_SEQ = LN16.LN_SEQ
		WHERE
			LN16.LC_STA_LON16 = '1'
			AND LN16.LC_DLQ_TYP = 'P' -- INSTALLEMNT
			AND 
			(
				DATEADD(DAY,-5,CAST(GETDATE() AS DATE)) <= LN16.LD_DLQ_MAX --Account for AES holidays that we dont honor
				OR LN16.LN_DLQ_MAX >= 360
			)
			AND LN10.LA_CUR_PRI > 0.00
			AND LN10.LC_STA_LON10 = 'R'
	) DATA
		ON DATA.BF_SSN = DD.BF_SSN
		AND DATA.LN_SEQ = DD.LN_SEQ
		AND DATA.LD_DLQ_OCC = DD.LD_DLQ_OCC
		AND DATA.AddedAt = DD.AddedAt
	WHEN MATCHED THEN UPDATE SET
			DD.LN_DLQ_MAX = DATA.LN_DLQ_MAX
	WHEN NOT MATCHED THEN
		INSERT
		(
			 [BF_SSN],
			 [LN_SEQ],
			 [LD_DLQ_OCC],
			 [LN_DLQ_MAX],
			 [AddedAt]
		)
		VALUES
		(
			DATA.[BF_SSN],
			DATA.[LN_SEQ],
			DATA.[LD_DLQ_OCC],
			DATA.[LN_DLQ_MAX],
			DATA.[AddedAt]
		)
;