USE CDW
GO

MERGE
	dbo.BORR_Rehabilitation ExistingData
USING
	(
		SELECT     
			PD10.DF_SPE_ACC_ID, 
			CONVERT(VARCHAR(10), MAX(LD_LON_RHB_PCV), 101) AS LD_LON_RHB_PCV, 
			'Y' AS REHAB_IND
		FROM
			LN09_RPD_PIO_CVN LN09
			INNER JOIN PD10_PRS_NME PD10
				ON PD10.DF_PRS_ID = LN09.BF_SSN
		WHERE
			LN09.LD_LON_RHB_PCV IS NOT NULL
		GROUP BY 
			PD10.DF_SPE_ACC_ID
	) NewData
		ON NewData.DF_SPE_ACC_ID = ExistingData.DF_SPE_ACC_ID
WHEN MATCHED THEN UPDATE SET
	ExistingData.LD_LON_RHB_PCV = NewData.LD_LON_RHB_PCV,
	ExistingData.REHAB_IND = NewData.REHAB_IND
WHEN NOT MATCHED THEN
	INSERT
	(
		DF_SPE_ACC_ID,
		LD_LON_RHB_PCV,
		REHAB_IND
	)
	VALUES
	(
		NewData.DF_SPE_ACC_ID,
		NewData.LD_LON_RHB_PCV,
		NewData.REHAB_IND
	)
WHEN NOT MATCHED BY SOURCE THEN
	DELETE;