--UTLWI04 SPROC FOR ULS
USE ULS
GO

CREATE PROCEDURE [dbo].getBankruptcyCaseNumbers
AS

BEGIN TRANSACTION
DECLARE @ERROR INT = 0
DECLARE @DVAL DATE = DATEADD(YEAR, -10, GETDATE());

SELECT DISTINCT
	 RTRIM(LTRIM(DF_SPE_ACC_ID))			[DF_SPE_ACC_ID]
	,REPLACE(RTRIM(LTRIM(BK_CASE)),'-','')	[BK_CASE]
	,RTRIM(LTRIM(DM_PRS_1))					[DM_PRS_1]
	,RTRIM(LTRIM(DM_PRS_LST))				[DM_PRS_LST]
FROM
(	--OneLink bankruptcy
	SELECT DISTINCT 
		PD01.DF_SPE_ACC_ID
		,PD01.DM_PRS_1
		,PD01.DM_PRS_LST
		,DC18.LF_BKR_DKT AS BK_CASE
	FROM
		ODW..DC01_LON_CLM_INF DC01
		INNER JOIN ODW..DC18_BKR DC18
			ON DC01.AF_APL_ID = DC18.AF_APL_ID
			AND DC01.AF_APL_ID_SFX = DC18.AF_APL_ID_SFX
			AND DC01.LF_CRT_DTS_DC10 = DC18.LF_CRT_DTS_DC10
		INNER JOIN ODW..PD01_PDM_INF PD01
			ON DC01.BF_SSN = PD01.DF_PRS_ID
	WHERE
		DC18.LD_BKR_FIL > @DVAL

	UNION ALL

	--Compass bankruptcy
	SELECT DISTINCT 
		PD10.DF_SPE_ACC_ID
		,PD10.DM_PRS_1
		,PD10.DM_PRS_LST
		,PD24.DF_COU_DKT AS BK_CASE
	FROM
		UDW..PD24_PRS_BKR PD24
		INNER JOIN UDW..PD10_PRS_NME PD10
			ON PD24.DF_PRS_ID = PD10.DF_PRS_ID
	WHERE 
		PD24.DD_BKR_FIL > @DVAL
) UNIONED
WHERE --eliminates those with no case number
	BK_CASE IS NOT NULL
	AND BK_CASE <> ''
	--test for no case #'s
	--(BK_CASE IS NULL OR BK_CASE = '')
ORDER BY
	DF_SPE_ACC_ID
	,BK_CASE

SELECT @ERROR = @@ERROR

IF @ERROR = 0
	BEGIN
		PRINT 'Transaction committed'
		COMMIT TRANSACTION
		--ROLLBACK TRANSACTION
	END
ELSE
	BEGIN
		PRINT 'ERROR:  ' + CAST(@ERROR as VARCHAR(10))
		PRINT 'Transaction NOT committed'
		ROLLBACK TRANSACTION
	END

RETURN 0;
