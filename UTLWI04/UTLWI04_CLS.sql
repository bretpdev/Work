--UTLWI04 SPROC FOR CLS
USE CLS
GO

CREATE PROCEDURE [dbo].getBankruptcyCaseNumbers
AS

BEGIN TRANSACTION
DECLARE @ERROR INT = 0
DECLARE @DVAL DATE = DATEADD(YEAR, -10, GETDATE());

--Compass bankruptcy
SELECT DISTINCT 
	 RTRIM(LTRIM(PD10.DF_SPE_ACC_ID))				[DF_SPE_ACC_ID]
	,REPLACE(RTRIM(LTRIM(PD24.DF_COU_DKT)),'-','')	[BK_CASE]
	,RTRIM(LTRIM(PD10.DM_PRS_1))					[DM_PRS_1]
	,RTRIM(LTRIM(PD10.DM_PRS_LST))					[DM_PRS_LST]
FROM
	CDW..PD24_PRS_BKR PD24
	INNER JOIN CDW..PD10_PRS_NME PD10
		ON PD24.DF_PRS_ID = PD10.DF_PRS_ID
WHERE 
	PD24.DD_BKR_FIL > @DVAL
	AND PD24.DF_COU_DKT IS NOT NULL 
	AND PD24.DF_COU_DKT <> ''
	--test for no case #'s
	--AND (PD24.DF_COU_DKT IS NULL OR PD24.DF_COU_DKT = '')
ORDER BY
	DF_SPE_ACC_ID
	,BK_CASE

SELECT @ERROR = @@ERROR

IF @ERROR = 0
	BEGIN
		PRINT 'Transaction committed'
		COMMIT TRANSACTION
		--ROLLBACK TRANSACTION
	END
ELSE
	BEGIN
		PRINT 'ERROR:  ' + CAST(@ERROR as VARCHAR(10))
		PRINT 'Transaction NOT committed'
		ROLLBACK TRANSACTION
	END

RETURN 0;
