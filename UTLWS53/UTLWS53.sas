/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWS53.LWS53R2";
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;
PROC SQL;
CREATE TABLE DEMO AS
SELECT B.DF_SPE_ACC_ID
	,TRIM(B.DM_PRS_1) || ' ' || TRIM(B.DM_PRS_MID) || '. '|| TRIM(B.DM_PRS_LST) AS B_NAME
	,C.DX_ADR_EML
	,CASE
		WHEN DC_ADR_EML = 'H' THEN '1'
		ELSE '2'
	END AS EML_PRIORITY
FROM DLGSUTWH.AY10_BR_LON_ATY A
INNER JOIN DLGSUTWH.PD10_PRS_NME B
	ON A.BF_SSN = B.DF_PRS_ID
INNER JOIN DLGSUTWH.PD32_PRS_ADR_EML C
	ON B.DF_PRS_ID = C.DF_PRS_ID
WHERE	A.PF_REQ_ACT = 'P201Q'
	AND A.LD_ATY_REQ_RCV >= TODAY() - 30
	AND C.DC_STA_PD32 = 'A'
	AND C.DC_ADR_EML = 'H'
	AND C.DI_VLD_ADR_EML = 'Y'
;
QUIT;
PROC SORT DATA=DEMO;
	BY DF_SPE_ACC_ID EML_PRIORITY;
RUN;
DATA DEMO(DROP=EML_PRIORITY);
SET DEMO;
	BY DF_SPE_ACC_ID EML_PRIORITY;
	IF FIRST.DF_SPE_ACC_ID;
RUN;
ENDRSUBMIT;
DATA DEMO;
	SET WORKLOCL.DEMO;
RUN;

DATA _NULL_;
SET DEMO ;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
IF _N_ = 1 THEN DO;
	PUT "ACCOUNTNUMBER,NAME,RECIPIENT";
END;
DO;
   PUT DF_SPE_ACC_ID @;
   PUT B_NAME @;
   PUT DX_ADR_EML $ ;
END;
RUN;
