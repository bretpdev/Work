/*UTLWD08 COMPASS SKIP REFS*/

/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
/*FILENAME REPORT2 "&RPTLIB/ULWD08.LWD08R2";*/

FILENAME REPORT2 'T:\SAS\ULWD08.LWD08R2';
libname  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=work  ;
RSUBMIT;
OPTIONS NOCENTER NODATE NONUMBER LS=132;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE SKPREF AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.BF_SSN
FROM  OLWHRM1.PD27_PRS_SKP_PRC A
WHERE A.DC_SKP_PRS = '1' /*BORROWER*/
AND A.DC_STA_SKP = '2' /*IN SKIP*/
AND	(SELECT COUNT(*)
	FROM OLWHRM1.RF10_RFR X
	WHERE X.BF_SSN = A.BF_SSN
	AND (X.BC_STA_REFR10 ='A'/*ACTIVE REFERENCE*/
		 OR (X.BC_STA_REFR10 = 'H' /*VALID REFERENCE W/ NO CONTACT REQUEST*/
			AND X.BC_REA_RFR_HST IN ('R','D')))
	AND X.BC_RFR_REL_BR NOT IN ('05','13','15')) < 2 /*NOT EMPLOYER, PHYSICIAN, LAWYER*/
AND NOT EXISTS 
	(SELECT *
	FROM OLWHRM1.WQ20_TSK_QUE Q
	WHERE A.BF_SSN = Q.BF_SSN
	AND Q.WF_QUE = 'BR'
	AND Q.WF_SUB_QUE = '01')
ORDER BY A.BF_SSN
);
DISCONNECT FROM DB2;

ENDRSUBMIT  ;
DATA SKPREF; 
SET WORKLOCL.SKPREF; 
RUN;

DATA _NULL_;
SET SKPREF;
FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
FORMAT BF_SSN $9. ;
PUT BF_SSN $ ;
RUN;
