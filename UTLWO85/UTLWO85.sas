*-------------------------------------------------*
| UTLWO85 Multiple Alignment Forbearance Clean Up |
*-------------------------------------------------*;
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWO85.LWO85R2";
FILENAME REPORTZ "&RPTLIB/ULWO85.LWO85RZ";
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE FRBR AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT DISTINCT A.DF_SPE_ACC_ID
	,B.LN_SEQ
	,B.LD_FOR_BEG
FROM OLWHRM1.PD10_PRS_NME A
INNER JOIN (
	SELECT FR2.BF_SSN
		,FR2.LN_SEQ
		,FR2.LC_STA_LON60 
		,FR1.LC_FOR_STA 
		,FR1.LC_STA_FOR10
		,FR2.LD_FOR_BEG
		,DAYS(FR2.LD_FOR_BEG) AS FRB_END
	FROM OLWHRM1.FB10_BR_FOR_REQ FR1
	INNER JOIN OLWHRM1.LN60_BR_FOR_APV FR2
		ON FR1.BF_SSN = FR2.BF_SSN
		AND FR1.LF_FOR_CTL_NUM = FR2.LF_FOR_CTL_NUM
	WHERE FR1.LC_FOR_TYP = '15'
		AND FR2.LC_STA_LON60 = 'A'
		AND FR1.LC_FOR_STA = 'A'
		AND FR1.LC_STA_FOR10 = 'A'
	) B
	ON A.DF_PRS_ID = B.BF_SSN
INNER JOIN OLWHRM1.LN10_LON D
	ON B.BF_SSN = D.BF_SSN
	AND B.LN_SEQ = D.LN_SEQ
WHERE D.LA_CUR_PRI > 0
AND D.LC_STA_LON10 = 'R'
AND NOT EXISTS (
	SELECT 1
	FROM OLWHRM1.DF10_BR_DFR_REQ DF1
	INNER JOIN OLWHRM1.LN50_BR_DFR_APV DF2
		ON DF1.BF_SSN = DF2.BF_SSN
		AND DF1.LF_DFR_CTL_NUM = DF2.LF_DFR_CTL_NUM
	WHERE DF2.BF_SSN = B.BF_SSN
		AND DF2.LN_SEQ = B.LN_SEQ
		AND DF1.LC_DFR_TYP IN ('15','18','19','22','23')
		AND	DF2.LC_STA_LON50 = 'A'
		AND DF1.LC_DFR_STA = 'A'
		AND DF1.LC_STA_DFR10 = 'A'
		AND DAYS(B.LD_FOR_BEG) = DAYS(DF2.LD_DFR_END) + 1
	)
FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWO85.LWO85RZ);*/
/*QUIT;*/
ENDRSUBMIT;
DATA FRBR ;
	SET WORKLOCL.FRBR;
RUN;
PROC SORT DATA=FRBR NODUPKEY;
	BY DF_SPE_ACC_ID LD_FOR_BEG;
RUN;
DATA _NULL_;
	SET  WORK.FRBR ;
	FILE REPORT2 DELIMITER=',' DSD DROPOVER LRECL=32767;
	   FORMAT DF_SPE_ACC_ID $10. ;
	   FORMAT LD_FOR_BEG MMDDYY10. ;
	IF _N_ = 1 THEN DO;
	   PUT 'DF_SPE_ACC_ID,LD_FOR_BEG';
	END;
	DO;
	   PUT DF_SPE_ACC_ID $ @;
	   PUT LD_FOR_BEG ;
	END;
RUN;
