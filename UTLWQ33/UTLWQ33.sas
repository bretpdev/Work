*------------------------------------------*
| UTLWQ33 MONTHLY BILLING REPORT - ONELINK |
*------------------------------------------*;
/*LIBNAME DLGSUTWH DB2 DATABASE=DLGSUTWH OWNER=OLWHRM1;*/
/*%LET RPTLIB = %SYSGET(reportdir);*/
%LET RPTLIB = T:\SAS;
FILENAME REPORT2 "&RPTLIB/ULWQ33.LWQ33R2";
FILENAME REPORTZ "&RPTLIB/ULWQ33.LWQ33RZ";
DATA _NULL_;
	CALL SYMPUT('BEGIN',INTNX('MONTH',TODAY(),-1,'BEGINNING'));
	CALL SYMPUT('END',INTNX('MONTH',TODAY(),-1,'END'));
	CALL SYMPUT('TITLE_DATE',PUT(TODAY(),MMYYS10.));
RUN;
%SYSLPUT BEGIN = &BEGIN;
%SYSLPUT END = &END;
LIBNAME  WORKLOCL  REMOTE  SERVER=CYPRUS  SLIBREF=WORK;
RSUBMIT;
%MACRO SQLCHECK (SQLRPT= );
%IF &SQLXRC NE 0 %THEN %DO;
	DATA _NULL_;
    FILE REPORTZ NOTITLES;
    PUT @01 " ********************************************************************* "
      / @01 " ****  THE SQL CODE ABOVE HAS EXPERIENCED AN ERROR.               **** "
      / @01 " ****  THE SAS LOG IN &SQLRPT SHOULD BE REVIEWED.          **** "       
      / @01 " ********************************************************************* "
      / @01 " ****  THE SQL ERROR CODE IS  &SQLXRC  AND THE SQL ERROR MESSAGE  **** "
      / @01 " ****  &SQLXMSG   **** "
      / @01 " ********************************************************************* ";
	RUN;
%END;
%MEND;
PROC SQL;
CONNECT TO DB2 (DATABASE=DLGSUTWH);
CREATE TABLE ALL_GAUR AS
SELECT *
FROM CONNECTION TO DB2 (
SELECT A.DF_PRS_ID_BR 
	,B.AF_APL_ID||B.AF_APL_ID_SFX AS CLUID
	,B.AD_PRC 
	,B.AA_GTE_LON_AMT 
	,C.AC_LON_STA_TYP
	,D.LF_CRT_DTS_DC10
	,D.LC_STA_DC10 
FROM OLWHRM1.GA01_APP A
INNER JOIN OLWHRM1.GA10_LON_APP B
	ON A.AF_APL_ID = B.AF_APL_ID
INNER JOIN OLWHRM1.GA14_LON_STA C
	ON B.AF_APL_ID = C.AF_APL_ID
	AND B.AF_APL_ID_SFX = C.AF_APL_ID_SFX
LEFT OUTER JOIN (
	SELECT AF_APL_ID
		,AF_APL_ID_SFX	
		,LF_CRT_DTS_DC10
		,LC_STA_DC10 
	FROM OLWHRM1.DC01_LON_CLM_INF
	) D
	ON B.AF_APL_ID = D.AF_APL_ID
	AND B.AF_APL_ID_SFX = D.AF_APL_ID_SFX

WHERE B.AC_PRC_STA = 'A'
	AND C.AC_STA_GA14 = 'A'
	AND C.AC_LON_STA_TYP NOT IN ('CA','PN','PF','PC','PM','UC','UD','UI','AE')

FOR READ ONLY WITH UR
);
DISCONNECT FROM DB2;
/*%PUT  SQLXRC= >>> &SQLXRC <<< ||| SQLXMSG= >>> &SQLXMSG >>>  ;  * INCLUDES ERROR MESSAGES TO SAS LOG  ;*/
/*%SQLCHECK (SQLRPT=ULWQ33.LWQ33RZ);*/
/*QUIT;*/
PROC SORT DATA=ALL_GAUR;
	BY CLUID LF_CRT_DTS_DC10;
RUN;
DATA ALL_GAUR;
	SET ALL_GAUR;
	BY CLUID LF_CRT_DTS_DC10;
	IF LAST.CLUID THEN DO;
		IF LC_STA_DC10 = '04' AND AC_LON_STA_TYP = 'CP' THEN
			DELETE;
		ELSE DO;
			IF &BEGIN <= AD_PRC <= &END THEN
				NEW = 1;
			ELSE 
				NEW = 0;
			OUTPUT;
		END;
	END;
RUN;
ENDRSUBMIT;
DATA ALL_GAUR ;
	SET WORKLOCL.ALL_GAUR;
RUN;
PROC SQL;
	CREATE TABLE AGS AS
	SELECT MAX(NEW_GUAR) AS NEW_GUAR
		  ,MAX(ORG_PRIN) AS ORG_PRIN
	FROM (
			SELECT 0 AS ORG_PRIN
				,SUM(AA_GTE_LON_AMT) AS NEW_GUAR
			FROM ALL_GAUR
			WHERE NEW = 1
		UNION
			SELECT SUM(AA_GTE_LON_AMT) AS ORG_PRIN
				,0 AS NEW_GUAR
			FROM ALL_GAUR
		) A
;
QUIT;
PROC PRINTTO PRINT=REPORT2 NEW;
RUN;
OPTIONS ORIENTATION = LANDSCAPE;
OPTIONS PS=39 LS=127 PAGENO=1 CENTER DATE;
TITLE 'MONTHLY BILLING REPORT - ONELINK';
TITLE2 "&TITLE_DATE";
FOOTNOTE   'JOB = UTLWQ33  	 REPORT = ULWQ33.LWQ33R2';
PROC PRINT NOOBS SPLIT='/' DATA=AGS WIDTH=UNIFORM WIDTH=MIN LABEL;
	FORMAT  NEW_GUAR DOLLAR20.2 ORG_PRIN DOLLAR20.2;
	VAR NEW_GUAR ORG_PRIN;
	LABEL NEW_GUAR = 'NEW/GUARANTEES'
		ORG_PRIN = 'ORIGINAL/PRINCIPAL';
RUN;
PROC PRINTTO;
RUN;
/*SINCE THIS IS SUCH A LARGE DATA SET CLEAN IT UP*/
/*PROC DATASETS;*/
/*	DELETE ALL_GAUR;	*/
/*QUIT;*/
/******************************************************************************
* DETAIL FILE - FOR DEV ONLY
*******************************************************************************/
DATA _NULL_;
	SET ALL_GAUR;
	FILE 'T:\SAS\UTLWQ33.DETAIL.txt' DELIMITER=',' DSD DROPOVER LRECL=32767;
	FORMAT AD_PRC MMDDYY10.;
	IF _N_ = 1 THEN DO;
		PUT
			"DF_PRS_ID_BR,CLUID,AD_PRC,AA_GTE_LON_AMT,AC_LON_STA_TYP,LC_STA_DC10,NEW";
		END;
	DO;
		PUT DF_PRS_ID_BR $@;
		PUT CLUID $ @;
		PUT AD_PRC @;
		PUT AA_GTE_LON_AMT @;
		PUT AC_LON_STA_TYP $ @;
		PUT LC_STA_DC10 $ @;
		PUT NEW ;
	END;
RUN;
